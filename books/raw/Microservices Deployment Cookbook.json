{
  "metadata": {
    "title": "Microservices Deployment Cookbook",
    "author": "Vikram Murugesan",
    "publisher": "Unknown Publisher",
    "edition": "1st Edition",
    "isbn": "",
    "total_pages": 506,
    "conversion_date": "2025-12-19T17:35:48.235501",
    "conversion_method": "PyMuPDF + OCR fallback",
    "source_pdf": "Microservices Deployment Cookbook.pdf",
    "extraction_method": "Unstructured"
  },
  "chapters": [
    {
      "number": 1,
      "title": "Building\tMicroservices with\tJava",
      "start_page": 36,
      "end_page": 88,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nIn\ta\ttraditional\tmicroservice-based\tdesign,\tmonolithic\tapplications\twill\tbe broken\tdown\tinto\tsmaller\tservices\tthat\tcan\ttalk\tto\tother\tservices\teither\tin\ta synchronous\tor\tasynchronous\tmodel,\tbased\ton\tthe\tneed\tand\tuse\tcase.\tThe\tfirst question\tthat\tanyone\twould\thave\twhen\tbreaking\tdown\tmonolithic\tapplications\tis \"what\tare\tthe\tpotential\tservices\tthat\tmy\tapplication\tcan\tbe\tbroken\tdown\tinto?\" There\tis\tno\trule\tof\tthumb\tor\tstraight-forward\tanswer\tto\tthis.\tBut\tusually,\tone looks\tfor\tindependent\tfunctionalities.\tEach\tand\tevery\tfunctionality\tcan\tbe considered\tto\tbe\tbuilt\tas\tits\town\tservice.\n\nTo\tillustrate\tthis,\tlet's\ttake\ta\tlook\tat\tan\texample\tapplication\tand\tsee\thow\tit\tcould be\tbroken\tdown\tinto\tsmaller,\tmanageable\tand\tdeployable\tmicroservices.\tThe sample\tapplication\twe\twill\tbe\tlooking\tat\tis\ta\tbiker\ttracking\tapplication.\tThis application\twill\thave\tthe\tfollowing\tfunctionalities:\n\nWeb\tinterface\tto\tmonitor\tthe\tuser's\tprogress\ton\ta\tmap REST\tAPI\tto\tconsume\tthe\tuser's\tgeolocation\tdata\tconstantly Analytics\tcode\tto\tperform\tcalculations\tfor\tbiking\troute\tsuggestions, weather\tpredictions,\tbiking\tgear\tsuggestions,\tcalories\tburnt,\twater\tintake, and\tso\ton\n\nLet's\ttake\ta\tlook\tat\thow\tthis\tapplication\tmight\thave\tbeen\tdesigned\tas\ta monolithic\tapplication:\n\nAs\tyou\tcan\tsee,\tthe\twhole\tapplication\tis\tbundled\tas\tone\tartifact\tand\ttherefore promotes\ta\tsingle\tpoint\tof\tfailure\t(SPOF).\tIf\tfor\tsome\treason\tthe\tanalytics\tcode crashes\tyour\tJVM,\twe\twill\tlose\tthe\tweb\tinterface,\tREST\tAPIs,\tand\tanalytics\tas\ta whole.\tNow,\tlet's\ttake\ta\tlook\tat\thow\tthis\tmight\tbe\tbroken\tdown\tinto\tmanageable\n\nmicroservices:\n\nIn\tthis\tarchitecture\tdiagram,\tyou\tcan\tsee\tthat\teach\tand\tevery\tfunctionality\tis deployed\tas\tits\town\tmicroservice.\tThe\tservice\timplementations\thave\tbeen broken\tdown\tinto\ta\tNotification\tService,\twhich\twill\ttake\tcare\tof\tsending notifications\tto\tthe\tusers,\tand\tthe\tGeo\tLocation\tTracker\tService,\twhich\tkeeps track\tof\tthe\tgeolocation\t(latitude\tand\tlongitude)\tinformation\tof\tall\tthe\tusers.\tThe Analytics\tcode\thas\tbeen\tbroken\tdown\tinto\tits\town\tmicroservices.\tSo\tif\tone\ttype of\tanalytics\tmicroservice\tgoes\tdown,\tthe\tother\tmicroservices\twill\tkeep functioning\tproperly.\tYou\tmight\thave\tnoticed\tthat\tthe\tREST\tAPIs\tare\tmissing. They\tare\tactually\tnot\tmissing,\tbut\tintegrated\tinto\ttheir\trespective\tmicroservices.\n\nNow\tlet's\tnot\twaste\tany\tmore\ttime\tand\tjump\tdirectly\tinto\tbuilding\tone\tpart\tof this\tapplication.\tTo\tbe\table\tto\tillustrate\tthe\textensive\tconcepts\tthat\tthis\tbook offers,\tI\thave\tchosen\tthe\tgeolocation\ttracker\tservice\tas\tour\texample microservice.\tThis\tservice\twill\tbe\tresponsible\tfor\tcollecting\tthe\tgeolocation\tof all\tusers\tof\tthis\tapplication\tand\tthen\tstoring\tthem\tin\ta\tdata\tstore.\n\nCreating\ta\tproject\ttemplate\tusing STS\tand\tMaven\n\nCreating\ta\tproject\tfor\tyour\tmicroservice\tis\tno\tdifferent\tthan\tcreating\ta\tsimple Java\tproject.\tWe\twill\tuse\tMaven\tas\tour\tbuild\tframework\tas\tit\tis\tconsidered\tto\tbe one\tof\tthe\tmost\tpopular\tbuild\tframeworks.\tIf\tyou\tare\tcomfortable\tusing\tother frameworks,\tsuch\tas\tGradle,\tSBT,\tor\tIvy,\tfeel\tfree\tto\tuse\tthem.\tBut\tkeep\tin\tmind that\tthe\trecipes\tthroughout\tthis\tbook\twill\tuse\tMaven\textensively.\tUnless\tyou\tare an\texpert\tin\tyour\tpreferred\tframework,\tI\tstrongly\trecommend\tusing\tMaven.\n\nGetting\tready\n\nIn\torder\tto\tcreate\tyour\tmicroservice\tproject,\tyou\twill\tneed\tthe\tfollowing software.\tFollow\tthe\tinstructions\ton\ttheir\trespective\twebsites\tto\tinstall\tthem:\n\nJDK\t1.8+ Maven\t3.3.9+ Spring\tTool\tSuite\t(STS)\t3.8.0+\n\nMake\tsure\tboth\tJava\tand\tMaven\tare\tin\tyour\tPATH\tvariable\tso\tthat\tyou\tcan\tuse the\tjava\tand\tmvn\tcommands\ton\tevery\tterminal\tshell\twithout\thaving\tto\tset\tPATH each\ttime.\tSpring\tTool\tSuite\tis\ta\tsophisticated\tversion\tof\tEclipse\tthat\thas\tlot\tof Spring\tplugins\tand\textensions.\tIf\tyou\tare\tfamiliar\twith\tother\tIDEs,\tfeel\tfree\tto use\tthem.\tBut\tfor\tfamiliarity,\tthis\tbook\twill\tuse\tSTS\tfor\tall\trecipes.\n\nHow\tto\tdo\tit...\n\nAfter\tyou\thave\tinstalled\tthe\tabove-mentioned\tsoftware,\topen\tSpring\tTool\tSuite. The\tfirst\ttime\tyou\topen\tit,\tyou\twill\tbe\trequested\tto\tchoose\ta\tworkspace.\tGo ahead\tand\tenter\tyour\tworkspace\tlocation.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto create\ta\ttemplate\tMaven\tproject\tusing\tSTS\tand\tMaven.\tSTS\tcomes\twith\tMaven Integration\tout\tof\tthe\tbox.\tSo\twe\tdon't\thave\tto\tconfigure\tit\tany\tfurther.\tAfter your\tSTS\tIDE\thas\tcompleted\tstartup,\tfollow\tthe\tbelow\tinstructions\tto\tcreate\ta new\tMaven\tproject:\n\n1.\t In\tyour\tSTS\twindow,\tright-click\tanywhere\ton\tthe\tPackage\tExplorer, select\tNew,\tand\tthen\tselect\tMaven\tProject,\tas\tshown\tin\tthe\tfollowing screenshot:\n\n2.\t This\twill\topen\ta\tpopup\tthat\twill\tlet\tyou\tchose\tthe\ttype\tof\tMaven\tproject you\twould\tlike\tto\tcreate.\tWe\twill\tskip\tthe\tarchetype\tselection\tby\tchecking the\tbox\tthat\tsays\tCreate\ta\tsimple\tproject\t(skip\tarchetype\tselection)\tand then\thit\tNext:\n\n3.\t In\tthe\tnext\twindow,\tenter\tthe\tfollowing\tdetails\tto\tcreate\tyour\tproject: Group\tId:\tcom.packt.microservices Artifact\tId:\tgeolocation Name:\tgeolocation\n\n4.\t After\tyou\thave\tentered\tthe\tdetails,\thit\tFinish:\n\n5.\t This\twill\tcreate\ta\tsimple\tMaven\tJAR\tmodule\twith\tall\tthe\trequired directories\tin\tplace.\tDepending\ton\tyour\tIDE\tsettings,\tSTS\tconfigures\tyour new\tproject\twith\tthe\tdefault\tJava\tversion.\tIf\tyou\thave\tnot\tset\tany\tdefaults, it\twill\tconfigure\tyour\tproject\twith\tJava\t1.5.\tYou\tcan\tverify\tthis\tby\tchecking your\tproject\tstructure\tin\tSTS.\tThe\tfollowing\tscreenshot\tshows\tthat\tSTS uses\tJava\t1.5\tfor\tyour\tproject:\n\n6.\t We\twill\tuse\tJava\t8's\tlambda\texpressions\tin\tother\tchapters.\tSo\tlet's\tchange the\tJava\tversion\tfrom\t1.5\tto\t1.8.\tIn\torder\tto\tchange\tthe\tJava\tversion,\twe will\tconfigure\tthe\tmaven-compiler-plugin\tin\tthe\tpom.xmlfile.\tAdd\tthe following\tsection\tof\tcode\tto\tyour\tpom.xml\tfile's\tproject\tsection:\t<build> <plugins>\t<plugin>\t<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<version>3.5.1</version> <configuration>\t<source>1.8</source>\t<target>1.8</target> </configuration>\t</plugin>\t</plugins>\t</build>\n\n7.\t Save\tyour\tpom.xml\tfile,\tright-click\ton\tyour\tproject,\tchoose\tMaven,\tand then\thit\tUpdate\tProject...\tor\tuse\tthe\tkeyboard\tshortcut\tAlt\t+\tF5.\tThis\twill automatically\tchange\tyour\tproject's\tJava\tversion\tto\t1.8.\n\n8.\t Our\tmicroservice\tproject\tis\tnow\tready\tto\tplay\twith.\n\nThere's\tmore...\n\nIf\tyou\tare\tmore\tcomfortable\tusing\tthe\tcommand\tline\tto\tcreate\tMaven\tprojects, issue\tthe\tfollowing\tcommand\tin\tyour\tterminal\tto\tcreate\tthe\tnew\tproject:\n\nmvn\t-B\tarchetype:generate\t- DarchetypeGroupId=org.apache.maven.archetypes\t\\ -DgroupId=com.packt.microservices\t-DartifactId=geolocation\t\\\t -Dname=geolocation\n\nAfter\tMaven\tcreates\tthe\tproject,\tyou\tshould\tbe\table\tto\timport\tyour\tproject\tinto your\tIDE.\tAs\tthis\tis\tsomething\tout\tof\tthe\tscope\tof\tthis\tbook,\twe\twill\tnot\tbe looking\tat\thow\tto\timport\tan\texisting\tMaven\tproject\tinto\tyour\tIDE.\n\nWriting\tmicroservices\twith\tSpring Boot\n\nNow\tthat\tour\tproject\tis\tready,\tlet's\tlook\tat\thow\tto\twrite\tour\tmicroservice.\tThere are\tseveral\tJava-based\tframeworks\tthat\tlet\tyou\tcreate\tmicroservices.\tOne\tof\tthe most\tpopular\tframeworks\tfrom\tthe\tSpring\tecosystem\tis\tthe\tSpring\tBoot framework.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tcreate\ta\tsimple\tmicroservice application\tusing\tSpring\tBoot.\n\nGetting\tready\n\nAny\tapplication\trequires\tan\tentry\tpoint\tto\tstart\tthe\tapplication.\tFor\tJava-based applications,\tyou\tcan\twrite\ta\tclass\tthat\thas\tthe\tmain\tmethod\tand\trun\tthat\tclass\tas a\tJava\tapplication.\tSimilarly,\tSpring\tBoot\trequires\ta\tsimple\tJava\tclass\twith\tthe main\tmethod\tto\trun\tit\tas\ta\tSpring\tBoot\tapplication\t(microservice).\tBefore\tyou start\twriting\tyour\tSpring\tBoot\tmicroservice,\tyou\twill\talso\trequire\tsome\tMaven dependencies\tin\tyour\tpom.xml\tfile.\n\nHow\tto\tdo\tit... 1.\t Create\ta\tJava\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationApplication.java and\tgive\tit\tan\tempty\tmain\tmethod:\n\npackage\tcom.packt.microservices.geolocation;\t\t \t\t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\t{\t\t \t\t\t\t\t\t\t\t\t\t\t\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{\t \t\t\t\t\t\t\t\t\t\t\t\t//\tleft\tempty\tintentionally\t \t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\n\n2.\t Now\tthat\twe\thave\tour\tbasic\ttemplate\tproject,\tlet's\tmake\tour\tproject\ta\tchild project\tof\tSpring\tBoot's\tspring-boot-starter-parent\tpom\tmodule.\tThis module\thas\ta\tlot\tof\tprerequisite\tconfigurations\tin\tits\tpom.xml\tfile,\tthereby reducing\tthe\tamount\tof\tboilerplate\tcode\tin\tour\tpom.xml\tfile.\tAt\tthe\ttime\tof writing\tthis,\t1.3.6.RELEASE\twas\tthe\tmost\trecent\tversion: <parent>\t \t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId>\t \t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-starter-parent</artifactId>\t \t\t\t\t\t\t\t\t\t\t<version>1.3.6.RELEASE</version>\t \t\t\t\t\t\t\t\t</parent>\n\n3.\t After\tthis\tstep,\tyou\tmight\twant\tto\trun\ta\tMaven\tupdate\ton\tyour\tproject\tas you\thave\tadded\ta\tnew\tparent\tmodule.\tIf\tyou\tsee\tany\twarnings\tabout\tthe version\tof\tthe\tmaven-compiler\t\tplugin,\tyou\tcan\teither\tignore\tit\tor\tjust remove\tthe\t<version>3.5.1</version>\telement.\tIf\tyou\tremove\tthe\tversion element,\tplease\tperform\ta\tMaven\tupdate\tafterward.\n\n4.\t Spring\tBoot\thas\tthe\tability\tto\tenable\tor\tdisable\tSpring\tmodules\tsuch\tas Spring\tMVC,\tSpring\tData,\tand\tSpring\tCaching.\tIn\tour\tuse\tcase,\twe\twill\tbe creating\tsome\tREST\tAPIs\tto\tconsume\tthe\tgeolocation\tinformation\tof\tthe users.\tSo\twe\twill\tneed\tSpring\tMVC.\tAdd\tthe\tfollowing\tdependencies\tto your\tpom.xml\tfile:\n\n<dependencies>\t \t\t\t\t\t\t\t\t\t\t<dependency>\t \t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId>\t \t\t\t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-starter-web</artifactId>\t \t\t\t\t\t\t\t\t\t\t</dependency>\t \t\t\t\t\t\t\t\t</dependencies>\n\n5.\t We\talso\tneed\tto\texpose\tthe\tAPIs\tusing\tweb\tservers\tsuch\tas\tTomcat,\tJetty, or\tUndertow.\tSpring\tBoot\thas\tan\tin-memory\tTomcat\tserver\tthat\tstarts\tup\tas soon\tas\tyou\tstart\tyour\tSpring\tBoot\tapplication.\tSo\twe\talready\thave\tan\tin- memory\tTomcat\tserver\tthat\twe\tcould\tutilize.\n\n6.\t Now\tlet's\tmodify\tthe\tGeoLocationApplication.java\tclass\tto\tmake\tit\ta Spring\tBoot\tapplication:\n\npackage\tcom.packt.microservices.geolocation;\t \t\t\t\t\t\t\t\timport\torg.springframework.boot.SpringApplication;\t \t\t\t\t\t\t\t\timport\torg.springframework.boot.autoconfigure \t\t\t\t\t\t\t\t\t.SpringBootApplication;\t \t\t\t\t\t\t\t\t\t\t@SpringBootApplication\t \t\t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\t{\t \t\t\t\t\t\t\t\t\t\t\t\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\t\t\t\t\tSpringApplication.run(GeoLocationApplication.class,\t args);\t \t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tadded\tan\tannotation,\t@SpringBootApplication,\tto\tour class.\tThe\t@SpringBootApplication\tannotation\treduces\tthe\tnumber\tof\tlines\tof code\twritten\tby\tadding\tthe\tfollowing\tthree\tannotations\timplicitly:\n\n@Configuration\n\n@ComponentScan\n\n@EnableAutoConfiguration\n\nIf\tyou\tare\tfamiliar\twith\tSpring,\tyou\twill\talready\tknow\twhat\tthe\tfirst\ttwo annotations\tdo.\t@EnableAutoConfiguration\tis\tthe\tonly\tannotation\tthat\tis\tpart\tof Spring\tBoot.\tThe\tAutoConfiguration\tpackage\thas\tan\tintelligent\tmechanism\tthat guesses\tthe\tconfiguration\tof\tyour\tapplication\tand\tautomatically\tconfigures\tthe beans\tthat\tyou\twill\tlikely\tneed\tin\tyour\tcode.\n\nYou\tcan\talso\tsee\tthat\twe\thave\tadded\tone\tmore\tline\tto\tthe\tmain\tmethod,\twhich actually\ttells\tSpring\tBoot\tthe\tclass\tthat\twill\tbe\tused\tto\tstart\tthis\tapplication.\tIn our\tcase,\tit\tis\tGeoLocationApplication.class.\tIf\tyou\twould\tlike\tto\tadd\tmore initialization\tlogic\tto\tyour\tapplication,\tsuch\tas\tsetting\tup\tthe\tdatabase\tor\tsetting up\tyour\tcache,\tfeel\tfree\tto\tadd\tit\there.\n\n1.\t Now\tthat\tour\tSpring\tBoot\tapplication\tis\tall\tset\tto\trun,\tlet's\tsee\thow\tto\trun\n\nour\tmicroservice.\tRight-click\ton\tGeoLocationApplication.java\tfrom Package\tExplorer,\tselect\tRun\tAs,\tand\tthen\tselect\tSpring\tBoot\tApp.\tYou can\talso\tchoose\tJava\tApplication\tinstead\tof\tSpring\tBoot\tApp.\tBoth\tthe options\tultimately\tdo\tthe\tsame\tthing.\tYou\tshould\tsee\tsomething\tlike\tthis\ton your\tSTS\tconsole:\n\n2.\t If\tyou\tlook\tclosely\tat\tthe\tconsole\tlogs,\tyou\twill\tnotice\tthat\tTomcat\tis\tbeing started\ton\tport\tnumber\t8080.\tIn\torder\tto\tmake\tsure\tour\tTomcat\tserver\tis listening,\tlet's\trun\ta\tsimple\tcurl\tcommand.\tcURL\tis\ta\tcommand-line\tutility available\ton\tmost\tUnix\tand\tMac\tsystems.\tFor\tWindows,\tuse\ttools\tsuch\tas Cygwin\tor\teven\tPostman.\tPostman\tis\ta\tGoogle\tChrome\textension\tthat\tgives you\tthe\tability\tto\tsend\tand\treceive\tHTTP\trequests.\tFor\tsimplicity,\twe\twill use\tcURL.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal: curl\thttp://localhost:8080\n\n3.\t This\tshould\tgive\tus\tan\toutput\tlike\tthis:\n\n{\"timestamp\":1467420963000,\"status\":404,\"error\":\"Not \t\t\t\t\t\tFound\",\"message\":\"No\tmessage\tavailable\",\"path\":\"/\"}\n\nThis\terror\tmessage\tis\tbeing\tproduced\tby\tSpring.\tThis\tverifies\tthat\tour\tSpring Boot\tmicroservice\tis\tready\tto\tstart\tbuilding\ton\twith\tmore\tfeatures.\tThere\tare more\tconfigurations\tthat\tare\tneeded\tfor\tSpring\tBoot,\twhich\twe\twill\tperform\n\nmore\tconfigurations\tthat\tare\tneeded\tfor\tSpring\tBoot,\twhich\twe\twill\tperform later\tin\tthis\tchapter\talong\twith\tSpring\tMVC.\n\nWriting\tREST\tAPIs\twith\tSpring MVC\n\nThere\tare\ttwo\ttypes\tof\tcommunication\tmodels.\tOne\tof\tthem\tis\tsynchronous, where\tthe\tclient\twaits\tfor\tthe\tserver\tto\trespond\tto\tits\trequest.\tThe\tother\tis asynchronous,\twhere\tthe\tclient\tfires\ta\trequest\tand\tforgets.\tThough\tServlet\t3.0 and\tabove\tlet\tyou\tcreate\tasynchronous\tservlets,\tin\tour\trecipes,\twe\twill\tfocus\ton traditional\tservlet-based\tHTTP\tAPIs\tfor\tsimplicity.\tWe\twill\talso\tbe\tlooking\tat asynchronous\tcommunication\tin\tlater\tchapters.\n\nGetting\tready\n\nWhen\tit\tcomes\tto\tbuilding\tREST\tAPIs,\tthere\tare\tseveral\tframeworks\tto\tchoose from.\tAs\twe\talready\tset\tup\tthe\tSpring\tecosystem\tin\tour\tprevious\trecipe,\tit\twould make\tmore\tsense\tand\tbe\tmuch\teasier\tto\tuse\tSpring\tMVC\tto\texpose\tREST\tAPIs.\n\nHow\tto\tdo\tit...\n\nThe\ttrue\tadvantage\tof\tSpring\tBoot\tis\tthat\tyou\tdo\tnot\thave\tto\tadd\tany\tnew dependencies\tto\tenable\tweb\tsupport\tfor\tyour\tapplication.\tSpring\tBoot's\tparent pom\tfile\t(spring-boot-starter-parent)\ttakes\tcare\tof\tthat\tfor\tyou.\tNow\tlet's take\ta\tlook\tat\thow\tto\twrite\tour\tfirst\tAPI.\tIf\tyou\tare\tfamiliar\twith\tSpring\tMVC, this\tshould\tbe\treally\tstraight-forward\tfor\tyou:\n\n1.\t Create\ta\tController\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationController.java, which\twill\tbe\tresponsible\tfor\tbasic\tCRUD\toperations\tfor\tthe\tgeolocation\tof all\tusers:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport org.springframework.web.bind.annotation.RequestMapping; \t\t\t\t\t\t\t\timport org.springframework.web.bind.annotation.RestController;\n\n@RestController \t\t\t\t\t\t\t\t@RequestMapping(\"/geolocation\") \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationController\t{\n\n}\n\nThere\tare\ttwo\tthings\tto\tnote\there.\tThe\t@RestController\tannotation indicates\tthat\twe\tare\tgoing\tto\tuse\tthis\tcontroller\tto\texpose\tour\tREST\tAPIs. It\timplicitly\tadds\tthe\t@ResponseBody\tannotation\tto\tall\tcontroller\tmethods\tas that\tis\tsomething\tyou\twould\twant\tto\tdo\twhen\texposing\tyour\tREST\tAPIs using\tSpring\tMVC.\tThe\t@RequestMapping\tannotation\tspecifies\twhere\tyour HTTP\tresource\tis\tlocated.\tWe\tare\tsetting\t@RequestMapping\ton\tthe controller\tlevel\tto\tapply\tit\tto\tall\tcontroller\tmethods.\n\nNote\n\nUsing\t@RequestMapping\ton\tthe\tController\tclass\tlevel\tto\tdefine\ta\troot resource\tpath\tis\tconsidered\tto\tbe\tone\tof\tthe\tbest\tpractices.\tInstead\tof\thaving to\tcreate\tAPI\tpaths\tsuch\tas\t/getGeolocation\tor\t/createGeolocation,\tit is\talways\ta\tbetter\tpractice\tto\tuse\tthe\tsame\tpath,\t/geolocation,\twith\tthe\tGET method\tto\tget\tgeolocation\tdata\tand\tthe\tPOST\tmethod\tto\tcreate\tgeolocation\n\ndata.\n\n2.\t Before\twe\tjump\tinto\tcreating\tour\tAPIs,\twe\twill\tneed\tsome\tclasses\tfor\tthe domain\tobject\tand\tservice.\tLet's\tstart\twith\tcreating\tour\tdomain\tobject. Assume\tthat\tour\tGeoLocation\tconsists\tlatitude\tand\tlongitude.\tWe\twill\tbe defining\tboth\tlatitude\tand\tlongitude\tas\tdouble\tto\tprovide\tbetter\tprecision. Now\twe\twill\thave\tto\tsay\twhich\tuser's\tgeolocation\tit\tis.\tSo\twe\tmight\twant\tto add\ta\tuserId.\tWe\talso\tneed\tto\tsay\tat\twhat\ttime\tthe\tuser\twas\tat\tthe geolocation.\tSo\twe\tmight\twant\tto\tadd\ta\ttimestamp\tin\tEPOCH\ttime\tformat. The\ttimestamp\twill\tbe\tof\ttype\tlong.\tThis\tis\thow\tyour\tplain\told\tjava\tobject (POJO)\tclass\twill\tlook: import\tjava.io.Serializable; \t\t\t\t\t\t\t\timport\tjava.util.UUID;\n\npublic\tclass\tGeoLocation\timplements\tSerializable\t{\n\nprivate\tstatic\tfinal\tlong\tserialVersionUID\t=\t1L;\n\nprivate\tdouble\tlatitude; \t\t\t\t\t\t\t\t\t\t\tprivate\tdouble\tlongitude; \t\t\t\t\t\t\t\t\t\t\tprivate\tUUID\tuserId; \t\t\t\t\t\t\t\t\t\t\tprivate\tlong\ttimestamp;\n\npublic\tdouble\tgetLatitude()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\tlatitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetLatitude(double\tlatitude)\t{ \t\t\t\t\t\t\t\t\t\t\t\tthis.latitude\t=\tlatitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tdouble\tgetLongitude()\t{ \t\t\t\t\t\t\t\t\t\t\treturn\tlongitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetLongitude(double\tlongitude)\t{ \t\t\t\t\t\t\t\t\t\t\t\tthis.longitude\t=\tlongitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tUUID\tgetUserId()\t{ \t\t\t\t\t\t\t\t\t\t\treturn\tuserId; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetUserId(UUID\tuserId)\t{ \t\t\t\t\t\t\t\t\t\t\tthis.userId\t=\tuserId; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tlong\tgetTimestamp()\t{ \t\t\t\t\t\t\t\t\t\treturn\ttimestamp; \t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetTimestamp(long\ttimestamp)\t{ \t\t\t\t\t\t\t\t\t\tthis.timestamp\t=\ttimestamp; \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tused\tthe\tjava.util.UUID\tclass\tto\trepresent\tthe userId,\tassuming\tthat\tthis\tUUID\tuniquely\tidentifies\ta\tuser.\tWe\twill\tnot\tbe creating\tthe\tuser\tPOJO\tas\tit\tis\tout\tof\tscope\tfor\tthis\trecipe.\n\nIn\tan\tideal\tscenario,\tone\twould\tbe\tusing\ta\tNoSQL\tor\trelational\tdatabase\tto store\tthe\tgeolocations.\tIn\tthis\tcase,\tNoSQL\tsounds\tmore\tsuitable\tdue\tto several\treasons,\tincluding\tthe\tfact\tthat\tour\tdata\tis\ttime\tseries\tdata,\tin\tJSON format,\tunstructured\tbut\twill\tchange\tover\ttime\tand\twe\twill\thave\ta humongous\tamount\tof\tdata.\n\n3.\t For\tsimplicity\tpurposes,\twe\twill\tbe\tstoring\tour\tgeolocations\tin\tan\tin- memory\tjava.util.List<GeoLocation>\tcollection.\tLet's\tcreate\tour repository\tthat\tholds\tall\tour\tgeolocation\tobjects, com.packt.microservices.geolocation.GeoLocationRepository.java: package\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList; \t\t\t\t\t\t\t\timport\tjava.util.Collections; \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\n@Repository \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew \t\t\t\t\t\t\t\t\t\tArrayList<GeoLocation>();\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation) { \t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation);\n\ngeolocations.add(geolocation); \t\t\t\t\t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\treturn Collections.unmodifiableList(geolocations); \t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t}\n\n4.\t Now\tlet's\ttake\ta\tlook\tat\thow\tyour\tService\tinterface\twill\tlook:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.List;\n\npublic\tinterface\tGeoLocationService\t{\n\npublic\tGeoLocation\tcreate(GeoLocation\tgeolocation); \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll(); \t\t\t\t\t\t\t\t}\n\n5.\t Both\tour\trepository\tand\tservice\thave\ta\tvery\tsimple\tinterface.\tIdeally\tin real-time\tapplications,\tyou\tmight\twant\tto\tadd\tmore\tcomplicated\tmethods that\tnot\tonly\tperform\tCRUD\toperations\tbut\talso\tsort,\tfilter,\tselect\tonly specific\tfields,\tand\tso\ton.\tNow\tlet's\ttake\ta\tlook\tat\tour com.packt.microservices.geolocation.GeoLocationServiceImpl.java class:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.List;\n\nimport org.springframework.beans.factory.annotation.Autowired;\n\nimport\torg.springframework.stereotype.Service;\n\n@Service \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationServiceImpl\timplements \t\t\t\t\t\t\t\tGeoLocationService\t{\n\n@Autowired \t\t\t\t\t\t\t\t\t\tprivate\tGeoLocationRepository\trepository;\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\t\t\trepository.addGeoLocation(geolocation); \t\t\t\t\t\t\t\t\t\t\treturn\tgeolocation;\n\nreturn\tgeolocation; \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\trepository.getGeoLocations(); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nNote\n\nIt\tis\talways\tstrongly\trecommended\tthat\tyou\twrite\tunit\ttest\tcases\tfor\tany new\tcode.\tBut\tas\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tthis\tbook,\twe\twill\tnot\tbe writing\tunit\ttest\tcases\tfor\tany\tof\tthe\tprevious\tcode.\tTo\tlearn\tmore\tabout unit\ttesting\tSpring\tBoot\tapplications,\tplease\ttake\ta\tlook\tat\tSpring\tBoot's documentation\tat\thttps://docs.spring.io/spring- boot/docs/current/reference/html/boot-features-testing.html.\n\n6.\t Now\tthat\tour\tdomain\tand\tservice\tclasses\tare\tall\tset\tto\tgo,\tlet's\tmodify\tour Controller\tclass\tto\tsave\tand\tfind\tgeolocations.\tAdd\tthe\tfollowing\tsnippet into\tyour\tController\tclass\tbody: @Autowired \t\t\t\t\t\t\t\tprivate\tGeoLocationService\tservice;\n\n@RequestMapping(method\t=\tRequestMethod.POST,\tproduces\t=\t \"application/json\",\tconsumes\t=\t\"application/json\") \t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(@RequestBody\tGeoLocation\t geolocation)\t{ \t\t\t\t\t\t\t\t\t\treturn\tservice.create(geolocation); \t\t\t\t\t\t\t\t}\n\n@RequestMapping(method\t=\tRequestMethod.GET,\tproduces\t=\t \"application/json\") \t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t\t\t}\n\nIn\tthis\timplementation,\tthere\tare\ta\tfew\tthings\tto\tnotice.\tThe\t@RequestMapping annotation\tdoes\tnot\thave\ta\tpath\tdefined\tas\tit\tis\talready\tderived\tfrom\tthe\tclass- level\tannotation.\tFor\tboth\tthe\tcreate\tand\tfindAll\tmethods,\twe\tare\tusing\tthe same\tpath\tbut\tdifferent\tHTTP\tmethods\tas\tper\tbest\tpractice.\tSince\twe\tare\tdealing only\twith\tJSON\there,\twe\thave\tset\tthe\tproduces\tand\tconsumes\tvalues\tto\n\napplication/json.\tThe\treturn\ttypes\tof\tthe\tcreate\tand\tfindAll\tmethods\tare GeoLocation\tand\tList<GeoLocation>\trespectively.\tSpring\tMVC\tinternally\tuses Jackson\tto\tconvert\tthem\tto\ttheir\tequivalent\tJSON\tstrings.\n\nThat's\tit!\tWe\tare\tnow\tready\tto\ttest\tour\tapplication:\n\n1.\t Let's\ttry\tto\tcreate\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto retrieve\tthem\tusing\tthe\tGET\tmethod.\tExecute\tthe\tfollowing\tcURL commands\tin\tyour\tterminal\tone\tby\tone: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{\t \t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488,\t \t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404,\t \t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n3.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n4.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation\n\n5.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[\t \t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t},\t \t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t]\n\nYou\tnow\thave\ta\tfully\tworking\tversion\tof\tyour\tmicroservice.\tThe remaining\trecipes\tin\tthis\tchapter\ttry\tto\tachieve\tthe\tsame\tlogic\twith\tdifferent frameworks,\tsuch\tas\tWildFly\tSwarm\tand\tDropwizard.\tLater\tin\tthis\tchapter,\twe will\talso\tlook\tat\tanother\tframework\tthat\thelps\tyou\tbuild\tREST\tAPIs\tquickly called\tSparkJava\t(different\tfrom\tApache\tSpark).\tIf\tyou\twill\tbe\tusing\tSpring Boot\tfor\tyour\tmicroservices,\tyou\tcan\tjump\tto\tthe\tnext\tchapter.\tIf\tyou\tare interested\tin\tany\tof\tthe\tframeworks\tthat\twere\tmentioned,\tjump\tto\tthe\tappropriate recipe\tin\tthis\tchapter.\n\nWriting\tmicroservices\twith\tWildFly Swarm\n\nWildFly\tSwarm\tis\ta\tJ2EE\tapplication\tpackaging\tframework\tfrom\tRedHat\tthat utilizes\tthe\tin-memory\tUndertow\tserver\tto\tdeploy\tmicroservices.\tIn\tthis\trecipe, we\twill\tcreate\tthe\tsame\tGeoLocation\tAPI\tusing\tWildFly\tSwarm\tand\tJAX-RS.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe WildFly\tSwarm\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there to\thelp\tyou\tget\tstarted\ton\tWildFly\tSwarm.\tWhen\tyou\tare\tbuilding\tyour production-level\tapplication,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly Swarm,\tDropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.\n\nGetting\tready\n\nSimilar\tto\thow\twe\tcreated\tthe\tSpring\tBoot\tMaven\tproject,\tcreate\ta\tMaven\tWAR module\twith\tthe\tgroupId\t\tcom.packt.microservices\tand\tname/artifactId\t geolocation-wildfly.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline.\tBe aware\tthat\tsome\tIDEs\tcomplain\tabout\ta\tmissing\tweb.xml\tfile.\tWe\twill\tsee\thow to\tfix\tthat\tin\tthe\tnext\tsection.\n\nHow\tto\tdo\tit... 1.\t Before\twe\tset\tup\tthe\tWildFly\tSwarm\tproject,\twe\thave\tto\tfix\tthe\tmissing\n\nweb.xml\terror.\tThe\terror\tmessage\tsays\tthat\tMaven\texpects\tto\tsee\ta\tweb.xml file\tin\tyour\tproject\tas\tit\tis\ta\tWAR\tmodule,\tbut\tthis\tfile\tis\tmissing\tin\tyour project.\tIn\torder\tto\tfix\tthis,\twe\thave\tto\tadd\tand\tconfigure\tmaven-war- plugin.\tAdd\tthe\tfollowing\tcode\tsnippet\tto\tyour\tpom.xml\tfile's\tproject section:\n\n<build> \t\t\t\t\t\t\t\t\t\t<plugins> \t\t\t\t\t\t\t\t\t\t\t\t<plugin> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>maven-war-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<version>2.6</version> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<configuration>\n\n<failOnMissingWebXml>false</failOnMissingWebXml> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t\t\t\t\t</plugin> \t\t\t\t\t\t\t\t\t\t\t</plugins> \t\t\t\t\t\t\t\t</build>\n\n2.\t After\tadding\tthe\tsnippet,\tsave\tyour\tpom.xml\tfile\tand\tperform\ta\tMaven update.\tAlso,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion\tother\tthan 1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven\trecipe\tto change\tthe\tJava\tversion\tto\t1.8.\tAgain,\tperform\ta\tMaven\tupdate\tfor\tthe changes\tto\ttake\teffect.\n\n3.\t Now,\tlet's\tadd\tthe\tdependencies\trequired\tfor\tthis\tproject.\tAs\twe\tknow\tthat we\twill\tbe\texposing\tour\tAPIs,\twe\thave\tto\tadd\tthe\tJAX-RS\tlibrary.\tJAX-RS is\tthe\tstandard\tJSR-compliant\tAPI\tfor\tcreating\tRESTful\tweb\tservices. JBoss\thas\tits\town\tversion\tof\tJAX-RS.\tSo\tlet's\tadd\tthat\tdependency\tto\tthe pom.xml\tfile:\n\n<dependencies> \t\t\t\t\t\t\t\t\t\t<dependency> \t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.jboss.spec.javax.ws.rs</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>jboss-jaxrs-api_2.0_spec</artifactId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<version>1.0.0.Final</version> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<scope>provided</scope> \t\t\t\t\t\t\t\t\t\t</dependency> \t\t\t\t\t\t\t\t</dependencies>\n\nNote\n\nThe\tone\tthing\tthat\tyou\thave\tto\tnote\there\tis\tthe\tprovided\tscope.\tThe provided\tscope\tin\tgeneral\tmeans\tthat\tthis\tJAR\tneed\tnot\tbe\tbundled\twith\tthe final\tartifact\twhen\tit\tis\tbuilt.\tUsually,\tthe\tdependencies\twith\tprovided\tscope will\tbe\tavailable\tto\tyour\tapplication\teither\tvia\tyour\tweb\tserver\tor application\tserver.\tIn\tthis\tcase,\twhen\tWildfly\tSwarm\tbundles\tyour\tapp\tand runs\tit\ton\tthe\tin-memory\tUndertow\tserver,\tyour\tserver\twill\talready\thave this\tdependency.\n\n4.\t The\tnext\tstep\ttoward\tcreating\tthe\tGeoLocation\tAPI\tusing\tWildfly\tSwarm is\tcreating\tthe\tdomain\tobject.\tUse\tthe com.packt.microservices.geolocation.GeoLocation.java\tfile\tfrom\tthe previous\trecipe.\n\n5.\t Now\tthat\twe\thave\tthe\tdomain\tobject,\tthere\tare\ttwo\tclasses\tthat\tyou\tneed\tto create\tin\torder\tto\twrite\tyour\tfirst\tJAX-RS\tweb\tservice.\tThe\tfirst\tof\tthose\tis the\tApplication\tclass.\tThe\tApplication\tclass\tin\tJAX-RS\tis\tused\tto\tdefine the\tvarious\tcomponents\tthat\tyou\twill\tbe\tusing\tin\tyour\tapplication.\tIt\tcan also\thold\tsome\tmetadata\tabout\tyour\tapplication,\tsuch\tas\tyour\tbasePath\t(or ApplicationPath)\tto\tall\tresources\tlisted\tin\tthis\tApplication\tclass.\tIn\tthis case,\twe\tare\tgoing\tto\tuse\t/geolocation\tas\tour\tbasePath.\tLet's\tsee\thow\tthat looks: package\tcom.packt.microservices.geolocation;\n\nimport\tjavax.ws.rs.ApplicationPath; \t\t\t\t\t\t\timport\tjavax.ws.rs.core.Application;\n\n@ApplicationPath(\"/geolocation\") \t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\textends Application\t{\n\npublic\tGeoLocationApplication()\t{} \t\t\t\t\t\t\t\t\t}\n\nThere\tare\ttwo\tthings\tto\tnote\tin\tthis\tclass;\tone\tis\tthe\tApplication\tclass\tand the\tother\tis\tthe\t@ApplicationPath\tannotation-both\tof\twhich\twe've\talready talked\tabout.\n\n6.\t Now\tlet's\tmove\ton\tto\tthe\tresource\tclass,\twhich\tis\tresponsible\tfor\texposing the\tAPIs.\tIf\tyou\tare\tfamiliar\twith\tSpring\tMVC,\tyou\tcan\tcompare\tResource\n\nclasses\tto\tControllers.\tThey\tare\tresponsible\tfor\tdefining\tthe\tAPI\tfor\tany specific\tresource.\tThe\tannotations\tare\tslightly\tdifferent\tfrom\tthat\tof\tSpring MVC.\tLet's\tcreate\ta\tnew\tresource\tclass\tcalled com.packt.microservices.geolocation.GeoLocationResource.java that\texposes\ta\tsimple\tGET\tAPI:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList;\t \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\tjavax.ws.rs.GET;\t \t\t\t\t\t\t\t\timport\tjavax.ws.rs.Path;\t \t\t\t\t\t\t\t\timport\tjavax.ws.rs.Produces;\n\n@Path(\"\")\t \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationResource\t{\n\n@GET\t \t\t\t\t\t\t\t\t\t@Produces(\"applicationjson\")\t \t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{\t \t\t\t\t\t\t\t\t\t\t\treturn\tnew\tArrayList<>();\t \t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}\n\nAll\tthe\tthree\tannotations,\t@GET,\t@Path,\tand\t@Produces,\tare\tpretty\tself explanatory.\n\nBefore\twe\tstart\twriting\tthe\tAPIs\tand\tthe\tservice\tclass,\tlet's\ttest\tthe\tapplication from\tthe\tcommand\tline\tto\tmake\tsure\tit\tworks\tas\texpected.\tWith\tthe\tcurrent implementation,\tany\tGET\trequest\tsent\tto\tthe\t/geolocation\tURL\tshould\treturn\tan empty\tJSON\tarray.\n\nSo\tfar,\twe\thave\tcreated\tthe\tRESTful\tAPIs\tusing\tJAX-RS.\tIt's\tjust\tanother\tJAX- RS\tproject:\n\n1.\t In\torder\tto\tmake\tit\ta\tmicroservice\tusing\tWildfly\tSwarm,\tall\tyou\thave\tto\tdo is\tadd\tthe\twildfly-swarm-plugin\tto\tthe\tMaven\tpom.xml\tfile.\tThis\tplugin will\tbe\ttied\tto\tthe\tpackage\tphase\tof\tthe\tbuild\tso\tthat\twhenever\tthe\tpackage goal\tis\ttriggered,\tthe\tplugin\twill\tcreate\tan\tuber\tJAR\twith\tall\trequired dependencies.\tAn\tuber\tJAR\tis\tjust\ta\tfat\tJAR\tthat\thas\tall\tdependencies bundled\tinside\titself.\tIt\talso\tdeploys\tour\tapplication\tin\tan\tin-memory\n\nUndertow\tserver.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tplugins\tsection\tof\tthe pom.xml\tfile:\n\n<plugin> \t\t\t\t\t\t\t\t\t\t<groupId>org.wildfly.swarm</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>wildfly-swarm-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t<version>1.0.0.Final</version> \t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<id>package</id> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>package</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t</plugin>\n\n2.\t Now\texecute\tthe\tmvn\tclean\tpackage\tcommand\tfrom\tthe\tproject's\troot directory,\tand\twait\tfor\tthe\tMaven\tbuild\tto\tbe\tsuccessful.\tIf\tyou\tlook\tat\tthe logs,\tyou\tcan\tsee\tthat\twildfly-swarm-plugin\twill\tcreate\tthe\tuber\tJAR, which\thas\tall\tits\tdependencies.\tYou\tshould\tsee\tsomething\tlike\tthis\tin\tyour console\tlogs:\n\n3.\t After\tthe\tbuild\tis\tsuccessful,\tyou\twill\tfind\ttwo\tartifacts\tin\tthe\ttarget directory\tof\tyour\tproject.\tThe\tgeolocation-wildfly-0.0.1-SNAPSHOT.war file\tis\tthe\tfinal\tWAR\tcreated\tby\tthe\tmaven-war-plugin.\tThe\tgeolocation- wildfly-0.0.1-SNAPSHOT-swarm.jar\tfile\tis\tthe\tuber\tJAR\tcreated\tby\tthe wildfly-swarm-plugin.\tExecute\tthe\tfollowing\tcommand\tin\tthe\tsame terminal\tto\tstart\tyour\tmicroservice:\n\njava\t-jar\ttarget/geolocation-wildfly-0.0.1-SNAPSHOT- swarm.jar\n\n4.\t After\texecuting\tthis\tcommand,\tyou\twill\tsee\tthat\tUndertow\thas\tstarted\ton port\tnumber\t8080,\texposing\tthe\tgeolocation\tresource\twe\tcreated.\tYou\twill see\tsomething\tlike\tthis:\n\n5.\t Execute\tthe\tfollowing\tcURL\tcommand\tin\ta\tseparate\tterminal\twindow\tto make\tsure\tour\tAPI\tis\texposed.\tThe\tresponse\tof\tthe\tcommand\tshould\tbe\t[], indicating\tthere\tare\tno\tgeolocations:\n\ncurl\thttp://localhost:8080/geolocation\n\n6.\t Now\tlet's\tbuild\tthe\tservice\tclass\tand\tfinish\tthe\tAPIs\tthat\twe\tstarted.\tFor simplicity\tpurposes,\twe\tare\tgoing\tto\tstore\tthe\tgeolocations\tin\ta\tcollection\tin the\tservice\tclass\titself.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\twriting repository\tclasses\tor\tDAOs\tthat\ttalk\tto\tthe\tdatabase\tthat\tholds\tyour geolocations.\tGet\tthe com.packt.microservices.geolocation.GeoLocationService.java interface\tfrom\tthe\tprevious\trecipe.\tWe'll\tuse\tthe\tsame\tinterface\there.\n\n7.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java that\textends\tthe\tGeoLocationService\tinterface:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList; \t\t\t\t\t\t\t\timport\tjava.util.Collections; \t\t\t\t\t\t\t\timport\tjava.util.List;\n\npublic\tclass\tGeoLocationServiceImpl\timplements \t\t\t\t\t\t\t\tGeoLocationService\t{\n\nprivate\tstatic\tList<GeoLocation>\tgeolocations\t=\tnew \t\t\t\t\t\t\t\t\t\t\tArrayList<> \t\t\t\t\t\t\t\t\t\t();\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{\n\npublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation); \t\t\t\t\t\t\t\t\t\t\t\treturn\tgeolocation; \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\n8.\t Now\tthat\tour\tservice\tclasses\tare\timplemented,\tlet's\tfinish\tbuilding\tthe\tAPIs. We\talready\thave\ta\tvery\tbasic\tstubbed-out\tGET\tAPI.\tLet's\tjust\tintroduce\tthe service\tclass\tto\tthe\tresource\tclass\tand\tcall\tthe\tfindAll\tmethod.\tSimilarly, let's\tuse\tthe\tservice's\tcreate\tmethod\tfor\tPOST\tAPI\tcalls.\tAdd\tthe\tfollowing snippet\tto\tGeoLocationResource.java: private\tGeoLocationService\tservice\t=\tnew \t\t\t\t\t\t\tGeoLocationServiceImpl();\n\n@GET \t\t\t\t\t\t\t@Produces(\"application/json\") \t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t\t}\n\n@POST \t\t\t\t\t\t\t@Produces(\"application/json\") \t\t\t\t\t\t\t@Consumes(\"application/json\") \t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\treturn\tservice.create(geolocation); \t\t\t\t\t\t\t}\n\n9.\t We\tare\tnow\tready\tto\ttest\tour\tapplication.\tGo\tahead\tand\tbuild\tyour application.\tAfter\tthe\tbuild\tis\tsuccessful,\trun\tyour\tmicroservice:\tlet's\ttry\tto create\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem using\tthe\tGET\tmethod.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour terminal\tone\tby\tone:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n10.\t This\tshould\tgive\tyou\tsomething\tlike\tthe\tfollowing\toutput\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n11.\t This\tcommand\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\n\n12.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation\n\n13.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t}, \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t]\n\nWhatever\twe\thave\tseen\tso\tfar\twill\tgive\tyou\ta\thead\tstart\tin\tbuilding microservices\twith\tWildFly\tSwarm.\tOf\tcourse,\tthere\tare\ttons\tof\tfeatures\tthat\n\nmicroservices\twith\tWildFly\tSwarm.\tOf\tcourse,\tthere\tare\ttons\tof\tfeatures\tthat WildFly\tSwarm\toffers.\tFeel\tfree\tto\ttry\tthem\tout\tbased\ton\tyour\tapplication needs.\tI\tstrongly\trecommend\tgoing\tthrough\tthe\tWildFly\tSwarm\tdocumentation for\tany\tadvanced\tusages.\tIf\tyou\talready\tknow\tthat\tyou\tare\tgoing\tto\tbe\tusing WildFly\tSwarm\tfor\tyour\tmicroservices,\tyou\tcan\tskip\tthe\trest\tof\tthe\trecipes\tin this\tchapter\tand\tjump\tto\tnext\tchapter.\tThe\tfinal\ttwo\trecipes\tin\tthis\tchapter\twill show\tyou\thow\tto\tcreate\tmicroservices\tusing\tDropwizard\tand\thow\tto\tcreate RESTful\tAPIs\twith\tSparkJava.\n\nWriting\tmicroservices\twith Dropwizard\n\nDropwizard\tis\ta\tcollection\tof\tlibraries\tthat\thelp\tyou\tbuild\tpowerful\tapplications quickly\tand\teasily.\tThe\tlibraries\tvary\tfrom\tJackson,\tJersey,\tJetty,\tand\tso\ton.\tYou can\ttake\ta\tlook\tat\tthe\tfull\tlist\tof\tlibraries\ton\ttheir\twebsite.\tThis\tecosystem\tof libraries\tthat\thelp\tyou\tbuild\tpowerful\tapplications\tcould\tbe\tutilized\tto\tcreate microservices\tas\twell.\tAs\twe\tsaw\tearlier,\tit\tutilizes\tJetty\tto\texpose\tits\tservices. In\tthis\trecipe,\twe\twill\tcreate\tthe\tsame\tGeoLocation\tAPI\tusing\tDropwizard\tand Jersey.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe Dropwizard\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there\tto help\tyou\tget\tstarted\twith\tDropwizard.\tWhen\tyou\tare\tbuilding\tyour\tproduction- level\tapplication,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly\tSwarm, Dropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.\n\nGetting\tready\n\nSimilar\tto\thow\twe\tcreated\tother\tMaven\tprojects,\tcreate\ta\tMaven\tJAR\tmodule with\tthe\tgroupId\t\tcom.packt.microservices\tand\tname/artifactId\t geolocation-dropwizard.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline. After\tthe\tproject\tis\tcreated,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion other\tthan\t1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven recipe\tto\tchange\tthe\tJava\tversion\tto\t1.8.\tPerform\ta\tMaven\tupdate\tfor\tthe\tchange to\ttake\teffect.\n\nHow\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\tyou\twill\tneed\tis\tthe\tdropwizard-core\tMaven\tdependency. Add\tthe\tfollowing\tsnippet\tto\tyour\tproject's\tpom.xml\tfile:\n\n<dependencies> \t\t\t\t<dependency> \t\t\t\t\t\t<groupId>io.dropwizard</groupId> \t\t\t\t\t\t<artifactId>dropwizard-core</artifactId> \t\t\t\t\t\t<version>0.9.3</version> \t\t\t\t</dependency> \t\t</dependencies>\n\nGuess\twhat?\tThis\tis\tthe\tonly\tdependency\tyou\twill\tneed\tto\tspin\tup\ta\tsimple Jersey-based\tDropwizard\tmicroservice.\n\nBefore\twe\tstart\tconfiguring\tDropwizard,\twe\thave\tto\tcreate\tthe\tdomain\tobject, service\tclass,\tand\tresource\tclass.\tFollow\tthe\tsteps\tfrom\tthe\tprevious\trecipe\tto create\tthe\tfollowing\tfour\tfiles:\n\ncom.packt.microservices.geolocation.GeoLocation.java\n\ncom.packt.microservices.geolocation.GeoLocationService.java\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java\n\ncom.packt.microservices.geolocation.\tGeoLocationResource.java\n\nLet's\tsee\twhat\teach\tof\tthese\tclasses\tdoes.\tThe\tGeoLocation.java\tclass\tis\tour domain\tobject\tthat\tholds\tthe\tgeolocation\tinformation.\tThe GeoLocationService.java\tclass\tdefines\tour\tinterface,\twhich\tis\tthen implemented\tby\tthe\tGeoLocationServiceImpl.java\tclass.\tIf\tyou\ttake\ta\tlook\tat the\tGeoLocationServiceImpl.java\tclass,\twe\tare\tusing\ta\tsimple\tcollection\tto store\tthe\tGeoLocation\tdomain\tobjects.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe persisting\tthese\tobjects\tin\ta\tdatabase.\tBut\tto\tkeep\tit\tsimple,\twe\twill\tnot\tgo\tthat far.\n\nTo\tbe\tconsistent\twith\tthe\tprevious\trecipe,\tlet's\tchange\tthe\tpath\tof GeoLocationResource\tto\t/geolocation.\tTo\tdo\tso,\treplace\t@Path(\"/\")\twith @Path(\"/geolocation\")\ton\tline\tnumber\t11\tof\tthe\tGeoLocationResource.java class.\n\nWe\thave\tnow\tcreated\tthe\tservice\tclasses,\tdomain\tobject,\tand\tresource\tclass.\n\nLet's\tconfigure\tDropwizard.\n\nIn\torder\tto\tmake\tyour\tproject\ta\tmicroservice,\tyou\thave\tto\tdo\ttwo\tthings:\n\n1.\t Create\ta\tDropwizard\tconfiguration\tclass.\tThis\tis\tused\tto\tstore\tany\tmeta- information\tor\tresource\tinformation\tthat\tyour\tapplication\twill\tneed\tduring runtime,\tsuch\tas\tDB\tconnection,\tJetty\tserver,\tlogging,\tand\tmetrics configurations.\tThese\tconfigurations\tare\tideally\tstored\tin\ta\tYAML\tfile, which\twill\tthen\tbe\tmapped\tto\tyour\tConfiguration\tclass\tusing\tJackson.\tIn this\tapplication,\twe\tare\tnot\tgoing\tto\tuse\tthe\tYAML\tconfiguration\tas\tit\tis out\tof\tscope\tfor\tthis\tbook.\n\nNote\n\nIf\tyou\twould\tlike\tto\tknow\tmore\tabout\tconfiguring\tDropwizard,\trefer\tto their\tGetting\tStarted\tdocumentation\tpage\tat http://www.dropwizard.io/0.7.1/docs/getting-started.html\t.\n\n2.\t Let's\tcreate\tan\tempty\tConfiguration\tclass\tcalled GeoLocationConfiguration.java:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tio.dropwizard.Configuration;\n\npublic\tclass\tGeoLocationConfiguration\textends Configuration\t{\n\n}\n\n3.\t The\tYAML\tconfiguration\tfile\thas\ta\tlot\tto\toffer.\tTake\ta\tlook\tat\ta\tsample YAML\tfile\tfrom\tDropwizard's\tGetting\tStarted\tdocumentation\tpage\tto\tlearn more.\tThe\tname\tof\tthe\tYAML\tfile\tis\tusually\tderived\tfrom\tthe\tname\tof\tyour microservice.\tThe\tmicroservice\tname\tis\tusually\tidentified\tby\tthe\treturn value\tof\tthe\toverridden\tmethod\tpublic\tString\tgetName()\tin\tyour Application\tclass.\tNow\tlet's\tcreate\tthe\tGeoLocationApplication.java application\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tio.dropwizard.Application; \t\t\t\t\t\t\t\timport\tio.dropwizard.setup.Environment;\n\npublic\tclass\tGeoLocationApplication\textends\n\npublic\tclass\tGeoLocationApplication\textends \t\t\t\t\t\t\t\tApplication<GeoLocationConfiguration>\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows Exception\t{ \t\t\t\t\t\t\t\t\t\t\t\tnew\tGeoLocationApplication().run(args); \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tvoid\trun(GeoLocationConfiguration\tconfig, Environment \t\t\t\t\t\t\t\t\t\t\t\t\tenv)\tthrows\tException\t{ \t\t\t\t\t\t\t\t\t\t\t\t\tenv.jersey().register(new\tGeoLocationResource()); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nThere\tare\ta\tlot\tof\tthings\tgoing\ton\there.\tLet's\tlook\tat\tthem\tone\tby\tone. Firstly,\tthis\tclass\textends\tApplication\twith\tthe GeoLocationConfiguration\tgeneric.\tThis\tclearly\tmakes\tan\tinstance\tof your\tGeoLocationConfiguraiton.java\tclass\tavailable\tso\tthat\tyou\thave access\tto\tall\tthe\tproperties\tyou\thave\tdefined\tin\tyour\tYAML\tfile\tat\tthe\tsame time\tmapped\tin\tthe\tConfiguration\tclass.\tThe\tnext\tone\tis\tthe\trun\tmethod. The\trun\tmethod\ttakes\ttwo\targuments:\tyour\tconfiguration\tand environment.\tThe\tEnvironment\tinstance\tis\ta\twrapper\tto\tother\tlibrary- specific\tobjects\tsuch\tas\tMetricsRegistry,\tHealthCheckRegistry,\tand JerseyEnvironment.\tFor\texample,\twe\tcould\tregister\tour\tJersey\tresources using\tthe\tJerseyEnvironment\tinstance.\tThe\tenv.jersey().register(new GeoLocationResource())\tline\tdoes\texactly\tthat.\tThe\tmain\tmethod\tis\tpretty straight-forward.\tAll\tit\tdoes\tis\tcall\tthe\trun\tmethod.\n\n4.\t Before\twe\tcan\tstart\tthe\tmicroservice,\twe\thave\tto\tconfigure\tthis\tproject\tto create\ta\trunnable\tuber\tJAR.\tUber\tJARs\tare\tjust\tfat\tJARs\tthat\tbundle\ttheir dependencies\tin\tthemselves.\tFor\tthis\tpurpose,\twe\twill\tbe\tusing\tthe\tmaven- shade-plugin.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tbuild\tsection\tof\tthe pom.xml\tfile.\tIf\tthis\tis\tyour\tfirst\tplugin,\tyou\tmight\twant\tto\twrap\tit\tin\ta <plugins>\telement\tunder\t<build>: <plugin> \t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t<artifactId>maven-shade-plugin</artifactId> \t\t\t\t\t\t<version>2.3</version> \t\t\t\t\t\t<configuration>\n\n<createDependencyReducedPom>true</createDependencyReducedPom>\n\n<filters> \t\t\t\t\t\t\t\t\t\t<filter> \t\t\t\t\t\t\t\t\t\t\t\t<artifact>*:*</artifact> \t\t\t\t\t\t\t\t\t\t\t\t<excludes> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.SF</exclude> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.DSA</exclude> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.RSA</exclude> \t\t\t\t\t\t\t\t\t\t\t\t</excludes> \t\t\t\t\t\t\t\t\t\t</filter> \t\t\t\t\t\t\t\t</filters> \t\t\t\t\t\t</configuration> \t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t<phase>package</phase> \t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t<goal>shade</goal> \t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t<transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\t implementation=\"org.apache.maven.plugins.shade.resource.Service sResourceTransformer\"\t> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\t implementation=\"org.apache.maven.plugins.shade.resource.Manifes tResourceTransformer\">\n\n<mainClass>com.packt.microservices.geolocation.GeoLocationAppli cation<mainClass> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformer> \t\t\t\t\t\t\t\t\t\t\t\t</transformers> \t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t</executions> \t\t\t\t</plugin>\n\n5.\t The\tprevious\tsnippet\tdoes\tthe\tfollowing:\n\nIt\tcreates\ta\trunnable\tuber\tJAR\tthat\thas\ta\treduced\tpom.xml\tfile\tthat\tdoes\tnot include\tthe\tdependencies\tthat\tare\tadded\tto\tthe\tuber\tJAR.\tTo\tlearn\tmore about\tthis\tproperty,\ttake\ta\tlook\tat\tthe\tdocumentation\tof\tmaven-shade- plugin.\n\nIt\tutilizes com.packt.microservices.geolocation.GeoLocationApplication\tas\tthe\n\nclass\twhose\tmain\tmethod\twill\tbe\tinvoked\twhen\tthis\tJAR\tis\texecuted.\tThis is\tdone\tby\tupdating\tthe\tMANIFEST\tfile.\n\nIt\texcludes\tall\tsignatures\tfrom\tsigned\tJARs.\tThis\tis\trequired\tto\tavoid security\terrors.\n\n6.\t Now\tthat\tour\tproject\tis\tproperly\tconfigured,\tlet's\ttry\tto\tbuild\tand\trun\tit\tfrom the\tcommand\tline.\tTo\tbuild\tthe\tproject,\texecute\tmvn\tclean\tpackage\tfrom the\tproject's\troot\tdirectory\tin\tyour\tterminal.\tThis\twill\tcreate\tyour\tfinal\tJAR in\tthe\ttarget\tdirectory.\tExecute\tthe\tfollowing\tcommand\tto\tstart\tyour microservice: java\t-jar\ttarget/geolocation-dropwizard-0.0.1- SNAPSHOT.jar\tserver\n\n7.\t The\tserver\targument\tinstructs\tDropwizard\tto\tstart\tthe\tJetty\tserver.\tAfter you\tissue\tthe\tcommand,\tyou\tshould\tbe\table\tto\tsee\tthat\tDropwizard\thas started\tthe\tin-memory\tJetty\tserver\ton\tport\t8080.\tIf\tyou\tsee\tany\twarnings about\thealth\tchecks,\tignore\tthem.\tYour\tconsole\tlogs\tshould\tlook\tsomething like\tthis:\n\n8.\t We\tare\tnow\tready\tto\ttest\tour\tapplication.\tLet's\ttry\tto\tcreate\ttwo geolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem\tusing\tthe\tGET method.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal\tone\tby one:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n9.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n10.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{\t\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n11.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation\n\n12.\t It\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\n\n\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t}, \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t]\n\nExcellent!\tYou\thave\tcreated\tyour\tfirst\tmicroservice\twith\tDropwizard. Dropwizard\toffers\tmore\tthan\twhat\twe\thave\tseen\tso\tfar.\tSome\tof\tit\tis\tout\tof scope\tfor\tthis\tbook.\tI\tbelieve\tthe\tmetrics\tAPI\tthat\tDropwizard\tuses\tcould\tbe used\tin\tany\ttype\tof\tapplication.\tTherefore,\twe\twill\tlook\tat\thow\tto\tuse\tit\tin\tlater chapters.\n\nWriting\tREST\tAPIs\twith\tSparkJava\n\nIn\tthe\tprevious\trecipes,\twe\tsaw\thow\tto\tcreate\ta\tmicroservice\tusing\tvarious frameworks\tsuch\tas\tSpring\tBoot,\tWildFly\tSwarm,\tand\tDropwizard.\tThis\trecipe is\tgoing\tto\tbe\ta\tlittle\tdifferent\tfor\tthe\tfact\tthat\twe\tare\tgoing\tto\tsee\thow\tto\tcreate a\tself-managed\tRESTful\tAPI\tusing\ta\tframework\tcalled\tSparkJava.\tNot\tto\tbe confused\twith\tApache\tSpark,\tthe\tSparkJava\tframework\tclaims\tto\tbe\ta\tmicro- framework\tfor\tbuilding\tweb\tapplications.\tTheir\tHTTP\tAPI\twas\tinspired\tby Ruby's\tSinatra\tframework.\tIt\tis\tso\tsimple\tthat\tbringing\tup\tan\tHTTP\tGET\tAPI requires\tfewer\tthan\tten\tlines\tof\tcode.\tOwing\tto\tthis,\tSparkJava\tis\tsomething\tthat could\tbe\tconsidered\twhen\tyou\twould\tlike\tto\tquickly\tbuild\tHTTP-based microservices.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe SparkJava\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there\tto\thelp you\tget\tstarted\twith\tSparkJava.\tWhen\tyou\tare\tbuilding\tyour\tproduction-level application,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly\tSwarm, Dropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.\n\nGetting\tready\n\nSimilar\tto\thow\twe\tcreated\tother\tMaven\tprojects,\tcreate\ta\tMaven\tJAR\tmodule with\tthe\tgroupId\tcom.packt.microservices\tand\tname/artifactId geolocation-sparkjava.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline. After\tthe\tproject\tis\tcreated,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion other\tthan\t1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven recipe\tto\tchange\tthe\tJava\tversion\tto\t1.8.\tPerform\ta\tMaven\tupdate\tfor\tthe\tchange to\ttake\teffect.\n\nHow\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\tyou\twill\tneed\tis\tthe\tSparkJava\tdependency.\tAdd\tthe following\tsnippet\tto\tyour\tproject's\tpom.xml\tfile:\n\n<dependencies> \t\t\t\t<dependency> \t\t\t\t\t\t<groupId>com.sparkjava</groupId> \t\t\t\t\t\t<artifactId>spark-core</artifactId> \t\t\t\t\t\t<version>2.5</version> \t\t\t\t</dependency> \t\t</dependencies>\n\nWe\tnow\thave\tto\tcreate\tthe\tdomain\tobject\tand\tservice\tclass.\tFollow\tthe\tWriting microservices\twith\tWildFly\tSwarm\trecipe\tto\tcreate\tthe\tfollowing\tthree\tfiles:\n\ncom.packt.microservices.geolocation.GeoLocation.java\n\ncom.packt.microservices.geolocation.GeoLocationService.java\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java\n\nLet's\tsee\twhat\teach\tof\tthese\tclasses\tdoes.\tThe\tGeoLocation.java\tclass\tis\tour domain\tobject\tthat\tholds\tthe\tgeolocation\tinformation.\tThe GeoLocationService.java\tinterface\tdefines\tour\tinterface,\twhich\tis\tthen implemented\tby\tthe\tGeoLocationServiceImpl.java\tclass.\tIf\tyou\ttake\ta\tlook\tat the\tGeoLocationServiceImpl.java\tclass,\twe\tare\tusing\ta\tsimple\tcollection\tto store\tthe\tGeoLocation\tdomain\tobjects.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe persisting\tthese\tobjects\tin\ta\tdatabase.\tBut\tto\tkeep\tit\tsimple,\twe\twill\tnot\tgo\tthat far.\n\nThe\tnext\tthing\tthat\tSparkJava\tneeds\tis\ta\tcontroller.\tIf\tyou\tare\tfamiliar\twith Spring\tMVC,\tyou\tcan\trelate\tthis\tcontroller\tto\tthat\tof\tSpring\tMVC's.\tThe controller\thas\ta\tcollection\tof\troutes\tdefined\tfor\teach\tURL\tpattern\tin\tyour\tAPI. Follow\tthese\tsteps:\n\n1.\t Let's\tcreate\tour\tcontroller\n\ncom.packt.microservices.geolocation.GeoLocationController.java with\ta\tstubbed-out\tGET\tAPI:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tstatic\tspark.Spark.*;\n\npublic\tclass\tGeoLocationController\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\t\t\tget(\"/geolocation\",\t(req,\tresp)\t->\t\"[]\"); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t}\n\n2.\t The\tquickest\tway\tto\ttest\tthis\tis\tby\trunning\tthis\tclass\tas\ta\tJava\tapplication.\tIf you\tget\tSLF4J\terrors\tin\tyour\tconsole\tafter\tyou\tstart\tthe\tapplication,\tadd\tthe following\tMaven\tdependency\tto\tyour\tpom.xml\tfile\tand\trestart\tyour application: <dependency> \t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t<artifactId>slf4j-simple</artifactId> \t\t\t\t\t\t\t\t<version>1.7.21</version> \t\t\t\t\t\t</dependency>\n\nThe\tslf4j-simple\tdependency\troutes\tall\tthe\tSLF4Jlog\tmessages\tto\tthe System.err\tstream.\n\n3.\t Your\tconsole\tlogs\tshould\tlook\tsomething\tlike\tthis\tafter\tthe\trestart:\n\nFrom\tthe\tlogs,\twe\tcan\tclearly\tsee\tthat\tthe\tservice\tis\trunning\ton\tport\t4567. 4.\t Execute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal\twindow\tto\tmake\tsure\n\nour\tAPI\tis\texposed.\tThe\tresponse\tof\tthe\tfollowing\tcommand\tshould\tbe\t[], indicating\tthere\tare\tno\tgeolocations:\n\ncurl\thttp://localhost:4567/geolocation\n\n5.\t Now\tlet's\tfinish\tbuilding\tthe\tAPIs.\tWe\talready\thave\ta\tvery\tbasic\tstubbed- out\tGET\tAPI.\tLet's\tjust\tintroduce\tthe\tservice\tclass\tto\tthe\tcontroller\tand\tcall the\tfindAll\tmethod.\tSimilarly,\tlet's\tuse\tthe\tservice's\tcreate\tmethod\tfor POST\tAPI\tcalls.\tBefore\twe\tdo\tthat,\twe\tneed\tto\tdo\tone\tmore\tthing.\tBy default,\tSparkJava\tdoes\tnot\tperform\tJSON\tserialization\tand\tdeserialization.\n\nWe\twill\tbe\tusing\ta\tlibrary\tcalled\tgson\tto\tdo\tthat.\tSo\tadd\tthe\tfollowing dependency\tto\tyour\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t\t\t\t\t<groupId>com.google.code.gson</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>gson</artifactId> \t\t\t\t\t\t\t\t\t\t<version>2.7</version> \t\t\t\t\t\t\t\t</dependency>\n\n6.\t Now\tlet's\treplace\tthe\tmain\tmethod\tof\tGeoLocationController.java\twith this:\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\tGeoLocationService\tservice\t=\tnew\t GeoLocationServiceImpl(); \t\t\t\t\t\tGson\tgson\t=\tnew\tGson();\n\nget(\"geolocation\",\t(req,\tresp)\t->\t{ \t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t},\tgson::toJson);\n\npost(\"geolocation\",\t(req,\tresp)\t->\t{ \t\t\t\t\t\t\t\treturn\tservice.create(gson.fromJson(req.body(),\t GeoLocation.class)); \t\t\t\t\t\t},\tgson::toJson); \t\t\t\t}\n\nYes,\tthere\tare\ttoo\tmany\tthings\thappening\there.\tLet's\ttry\tto\tunderstand\tthem\tone by\tone:\n\nThe\tget\tmethod\tnow\tuses\tthe\tservice's\tfindAll\tmethod The\tthird\targument\tto\tthe\tget\tmethod\tis\tthe\tResponseTransformer,\twhich says\thow\tyour\tresponse\tshould\tbe\ttransformed\tbefore\tbeing\tsent\tto\tthe client Since\tthe\tResponseTransformer\tis\ta\tFunctionalInterface\twith\tjust\tone method\trender\tthat\ttakes\tin\tthe\trendering\tlogic\tas\tan\tobject,\twe\tare\tpassing the\tmethod\treference\tto\tGson's\ttoJson\tmethod\tas\tthe\trendering\tlogic\there. The\tpost\tmethod,\twhich\tuses\tthe\tservice's\tcreate\tmethod,\tuses\tGson\tto transform\tthe\trequest\tbody\tto\ta\tGeoLocation\tvalue.\n\nWe\tare\tnow\tready\tto\ttest\tour\tapplication.\tRestart\tthe\tapplication.\tLet's\ttry\tto create\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem\tusing\n\nthe\tGET\tmethod:\n\n1.\t Execute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal\tone\tby\tone:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:4567/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:4567/geolocation\n\n3.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n4.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:4567/geolocation\n\n5.\t It\tshould\tgive\tyou\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t},\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t]\n\nThere\tare\tseveral\tother\tconfigurations\tthat\tyou\tcan\tmake\tto\tSparkJava,\tsuch\tas changing\tthe\tdefault\tport,\tusing\tquery\tparameters,\tand\tusing\tpath\tparameters.\tI'll leave\tthat\tto\tyou\tto\texperiment.\n\nConclusion\n\nAt\tthe\tbeginning\tof\tthis\tchapter,\twe\tquickly\tsaw\tan\toverview\tof\twhat microservices\tare\tand\thow\tthey\tbenefit\torganizations\tby\tmaking\tit\teasier\tto manage\tand\tdeploy\tindependent\tservices.\tWe\tlooked\tat\tan\texample\tof\ta geolocation\ttracker\tapplication\tto\tsee\thow\tit\tcan\tbe\tbroken\tdown\tinto\tsmaller and\tmanageable\tservices.\tNext,\twe\tsaw\thow\tto\tcreate\tthe\tGeoLocationTracker service\tusing\tthe\tSpring\tBoot\tframework.\tWe\talso\tlearned\thow\tto\texpose\tour APIs\tthat\tconsume\tand\tread\tgeolocations\tusing\tSpring\tMVC.\tNext,\twe\tsaw\thow to\tbuild\tthe\tsame\tapplication\tusing\tWildFly\tSwarm,\tand\tJAX-RS.\tLater,\twe built\tthe\tsame\tapplication\tusing\tDropwizard.\tFinally,\twe\tsaw\thow\tto\timplement the\tsame\tservice\tusing\tthe\tSparkJava\tframework.\n\nI\thope\tyou\tnow\thave\ta\tgood\tunderstanding\tof\twhat\tmicroservices\tare\tand\thow\tto create\tthem\tusing\tyour\tfavorite\tframework.\tThe\tchoice\tof\tframework\tcompletely depends\ton\tyour\tneeds\tand\tyour\tcurrent\tecosystem.\tWe\tstrongly\trecommend you\tevaluate\tthem\tbefore\tpicking\tone.\tIn\tthe\tnext\tchapter,\twe\twill\tlearn\thow\tto package\tthis\tmicroservice\tand\tlater\tcontainerize\tit\tusing\tDocker.\n\nChapter\t2.\tContainerizing Microservices\twith\tDocker\n\nIn\tthis\tchapter,\twe\twill\tfocus\tmore\ton\thow\tto\tpackage\tand\tship\tour microservice.\tWe\twill\tlearn\tthe\tfollowing\trecipes:\n\nBuilding\tan\texecutable\tJAR\tusing\tthe\tMaven\tShade\tplugin Building\tan\texecutable\tJAR\tusing\tthe\tSpring\tBoot\tMaven\tplugin Installing\tand\tsetting\tup\tDocker Writing\tyour\tDockerfile Building\tyour\tDocker\timage Running\tyour\tmicroservice\tinside\ta\tDocker\tcontainer Pushing\tyour\timage\tto\tDocker\tHub",
      "page_number": 36
    },
    {
      "number": 2,
      "title": "Containerizing Microservices\twith\tDocker",
      "start_page": 89,
      "end_page": 133,
      "detection_method": "regex_chapter_title",
      "content": "Building\tan\texecutable\tJAR\tusing Maven\tShade\tplugin\n\nBefore\twe\tjump\tinto\tthis\trecipe,\tlet's\ttalk\tabout\twhy\twe\tare\tdoing\tthis.\tOur\tgoal is\tto\tconstruct\ta\tshippable\tartifact\tthat\tcan\tbe\texecuted\tfrom\tany\tplatform\tor machine.\tIn\torder\tto\tdo\tthat,\twe\thave\tto\tmake\tsure\tour\tfinal\tartifact\thas\tall dependencies\tpackaged\tin\tit.\tAll\twe\tare\ttrying\tto\tdo\there\tis\tbuild\ta\tfat\tJAR\twith all\tdependencies,\tcalled\tthe\tuber\tJAR,\twhich\twe\ttalked\tabout\tin\tthe\tprevious chapter.\tAlmost\tall\tframeworks\tthat\thelp\tbuild\tmicroservices,\tsuch\tas\tSpring Boot\tand\tWildFly\tSwarm,\thave\ttheir\town\tMaven\tplugins\tthat\thelp\tyou\tbuild\tan executable\tJAR.\n\nBut\tif\tyou\tuse\tframeworks\tsuch\tas\tSparkJava\tand\tRatPack\tthat\tare\tnot\treally microservice\tframeworks\tbut\thelp\tin\tbuilding\tHTTP\tAPIs,\tyou\twill\thave\tto make\tsure\tyou\tuse\tthe\tright\tMaven\tor\tGradle\tplugin\tto\tcreate\tan\texecutable JAR.\n\nNote\n\nRatpack\tis\ta\tframework\tthat\tlets\tyou\tbuild\thigh-performance\tHTTP\tservices. Internally,\tit\tuses\tNetty\tas\tits\tHTTP\tengine.\tIt\tutilizes\tNetty's\tevent-based\tnon- blocking\tmechanism\tto\texpose\tHTTP\tservices,\tso\tyour\tAPIs\twill\tbe asynchronous.\tAlso,\tthe\tway\tyou\twrite\tAPIs\tin\tRatpack\tis\ta\tlittle\tdifferent\tfrom how\tyou\twrite\tthem\tin\tother\tlibraries.\tFor\tmore\tinformation\tabout\tRatpack,\tlook at\ttheir\tdocumentation\tat\thttps://ratpack.io/manual/current/\t.\n\nGetting\tready\n\nIf\tyou\tare\talready\tusing\tSpring\tBoot\tor\tWildFly\tSwarm,\tyou\tcan\tskip\tthis\trecipe as\tit\talready\ttakes\tcare\tof\tpackaging\tyour\tapplication.\tIn\torder\tto\tenforce\tthe packaging\tof\tyour\texecutable\tJAR,\twe\twill\tbe\tusing\tthe\tmaven-shade-plugin. This\tplugin\tis\tespecially\tbuilt\tfor\tthis\tpurpose.\tLet's\ttake\ta\tlook\tat\thow\tto\tdo\tthis in\tour\tSparkJava\tproject.\tAll\tthis\ttime,\twe\thave\tbeen\trunning\tour\tgeolocation- sparkjava\tproject\tfrom\tthe\tIDE.\tNow\tlet's\tsee\thow\twe\tcan\tcreate\tan\texecutable JAR\tfor\tthis\tproject\tand\trun\tit\tfrom\tthe\tcommand-line.\n\nHow\tto\tdo\tit... 1.\t Add\tthis\tsnippet\tto\tthe\tBuild\t|\tPlugins\tsection\tof\tyour\tproject's\tpom.xml\n\nfile:\n\n<plugin> \t\t\t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>maven-shade-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t\t<version>2.4.3</version> \t\t\t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<phase>package</phase> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>shade</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\n\nimplementation=\"org.apache.maven.plugins.shade. \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tresource.ManifestResourceTransformer\"> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<mainClass>com.packt.microservices.\n\ngeolocation.GeoLocationController</mainClass> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformer> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t</plugin>\n\n2.\t Let's\ttry\tto\tunderstand\tthe\tsnippet.\tThe\tplugin\tmakes\tsure\tthat\twhenever\tthe package\tphase\tof\tyour\tMaven\tbuild\tis\ttriggered,\tit\tuses\tthe ManifestResourceTransformer\tto\tadd\tthe\tgiven\tmainClass\tname\tto\tyour META-INF/MANIFEST.MF\tfile's\tMain-Class\tproperty.\tThis\tproperty\tspecifies the\tentry\tpoint\tto\tyour\tJAR\tfile.\tWith\tthat\tsaid,\tlet's\tgo\tahead\tand\trun\tthe Maven\tpackage\tgoal.\tIssue\tthe\tfollowing\tcommand\tfrom\tthe\tproject's\troot directory\tin\tyour\tterminal:\n\nmvn\tclean\tpackage\n\n3.\t The\tprevious\tMaven\tcommand\tpackages\tyour\tproject\tinto\tan\texecutable JAR\tusing\tthe\tmaven-shade-plugin.\tBefore\tit\tpackages,\tit\talso\truns\tother Maven\tgoals,\tincluding\tclean,\tvalidate,\tcompile,\tand\ttest.\tWe\twill\tnot\n\nbe\tdiscussing\tthese\tMaven\tgoals\tin\tdepth\tas\tthey\tare\tout\tof\tthe\tscope\tof\tthis book.\tThe\tprevious\tcommand\tshould\tgive\tyou\tsomething\tlike\tthis\ton\tyour console:\n\n4.\t If\tyou\twatch\tclosely,\tyou\tcan\tsee\tthat\ttowards\tthe\tend\tof\tthe\tbuild,\tthe maven-shade-plugin\tis\tcreating\ta\tshaded\tartifact\twith\tdependencies\tsuch as\tsparkjava,\tslf4j,\tjetty,\tand\tgson.\tThese\tJARs\tare\trequired\tduring\tthe run\ttime\tof\tthis\tapplication.\tThe\tfinal\tartifact\twill\tbe\tavailable\tin\tthe target\tdirectory\tof\tthe\tproject.\tThe\tmaven-shade-plugin\twill\treplace\tthe original\tgeolocation-sparkjava-0.0.1-SNAPSHOT.jar\tartifact\twith\tthe shaded\tartifact.\n\n5.\t Now\tlet's\tgo\tahead\tand\trun\tthe\tapplication;\tissue\tthe\tfollowing\tJava command:\n\njava\t-jar\ttarget/geolocation-sparkjava-0.0.1-SNAPSHOT.jar\n\n6.\t With\tthis\tcommand,\tyou\tcan\tsee\tthat\tyour\tapplication\thas\tstarted\tand\tis listening\tfor\tnew\trequests\ton\tport\t4567:\n\n7.\t Now\tthat\tour\tservice\tis\tready,\tlet's\tgo\tahead\tand\ttest\tit\tby\tposting\ta geolocation.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:4567/geolocation\n\n8.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t}\n\n9.\t The\tprevious\tMaven\tplugin\tcan\tbe\tused\twith\tany\ttype\tof\tproject.\tIf\tyou\tare planning\tto\tuse\tother\tframeworks\tand\twant\tto\tmake\tan\texecutable\tJAR, you\tcan\tuse\tthe\tmaven-shade-plugin\tto\tdo\tso.\n\nBuilding\tan\texecutable\tJAR\tusing\tthe Spring\tBoot\tMaven\tplugin\n\nThis\trecipe\tis\tintended\tfor\tSpring\tBoot\tusers\tonly.\tIf\tyou\tare\tusing\ta\tdifferent framework\tthat\tdoes\tnot\tsupport\tbuilding\texecutable\tJARS,\tplease\trefer\tto previous\trecipe.\n\nGetting\tready\n\nThe\tspring-boot-maven-plugin\tis\ta\tMaven\tplugin\tbuilt\tby\tthe\tSpring\tBoot team\tto\tmake\tpackaging\tyour\tSpring\tBoot\tapplications\teasier.\tIt\tnot\tonly\tallows you\tto\tpackage\tyour\tproject,\tbut\talso\thelps\twith\trunning\tand\tdebugging\tyour application.\tIt\tintroduces\ta\tnew\tgoal\tcalled\trepackage,\twhich\tpretty\tmuch repackages\tyour\toriginal\tartifact\t(JAR\tor\tWAR)\twith\tan\texecutable\tuber\tJAR that\thas\tall\tdependencies\tin\tit.\tIf\tyou\tare\tfamiliar\twith\tthe\tmaven-shade-plugin, the\trepackage\tgoal\tin\tSpring\tBoot\tdoes\tshading.\n\nHow\tto\tdo\tit...\n\nIn\torder\tto\tillustrate\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tgeolocation\tproject\tthat\twe built\tin\tChapter\t1\t,\tBuilding\tMicroservices\twith\tJava\tusing\tSpring\tBoot:\n\n1.\t Open\tthe\tpom.xml\tfile\tof\tthe\tgeolocation\tproject\tand\tlook\tat\tthe\tparent section.\tYou\twill\tsee\tthat\twe\thave\tspecified\tspring-boot-starter-parent\tas the\tparent\tMaven\tmodule.\tThis\tmodule\tdoes\ta\tfew\tthings:\tit\tis\tresponsible for\tdeclaring\tthe\tbasic\tspring-core\tdependency\tin\tthe dependencyManagement\tsection\tof\tits\tpom.xml\tfile.\tIt\talso\tdefines\tthe pluginManagement\tsection\tof\tthe\tpom.xml\tfile\twith\tall\tthe\tMaven\tplugins that\tyou\twill\tneed.\tOne\tof\tthose\tplugins\tis\tspring-boot-maven-plugin.\tIf you\tare\tusing\tSTS\tIDE,\tplease\tgo\tahead\tand\tclick\ton\tits\tparent\tsection\tin the\tpom.xml\tfile\tby\tholding\tthe\tCtrl\tbutton\t(Command\tin\tMac).\n\n2.\t This\twill\ttake\tyou\tto\tthe\tpom.xml\tfile\tof\tthe\tspring-boot-starter-parent project.\tYou\twill\tsee\tsomething\tlike\tthis\tin\tthe\tpluginManagement\tsection:\n\n<plugin> \t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-maven-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>repackage</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t<mainClass>${start-class}</mainClass> \t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t</plugin>\n\n3.\t Go\tahead\tand\tadd\tthe\tabove\tplugin\tto\tthe\tpom\tfile\tof\tgeolocation\tproject. As\tyou\tcan\tsee,\tthe\tplugin\tuses\tthe\trepackage\tgoal\tto\tcreate\tthe\texecutable JAR\tfile.\tThe\tother\tthing\tthat\tyou\thave\tto\tnotice\tis\tthe\tmainClass configuration.\tIt\tholds\tthe\t${start-class}\tvalue.\tThis\tindicates\tthat\twe have\tto\tdefine\ta\tproperty\tin\tour\tpom.xml\tfile\twith\tthe\tname\tstart-class. 4.\t Let's\tgo\tahead\tand\tdefine\tthe\tstart-class\tproperty\tin\tthe\tpom.xml\tfile\tof our\tgeolocation\tproject.\tUse\tthe\tfollowing\tsnippet\tto\tadd\tthe\tstart-class property\tto\tyour\tPOM\tfile's\tproject\tsection:\n\n<properties> \t\t\t\t\t\t\t\t<start-class>com.packt.microservices.geolocation.\n\n<start-class>com.packt.microservices.geolocation. \t\t\t\t\t\t\t\t\t\tGeoLocationApplication</start-class> \t\t\t\t\t\t\t\t</properties>\n\n5.\t After\tadding\tthe\tproperty,\tif\tyou\tsee\tany\terrors\tin\tyour\tproject,\tperform\ta Maven\tupdate.\tNow,\twe\tare\tready\tto\ttest\tour\tapplication\tfrom\tthe command\tline.\n\n6.\t Open\ta\tterminal\tand\tissue\tthe\tfollowing\tcommand\tfrom\tthe\tproject's\troot directory:\n\nmvn\tclean\tpackage\tspring-boot:run\n\n7.\t As\tyou\tcan\tsee,\twe\tare\tusing\tthe\trun\tgoal\tof\tspring-boot-maven\tplugin. This\twill\tfirst\tbuild\tyour\tproject\tand\tthen\tgive\tyou\tsomething\tlike\tthis\ton the\tconsole:\n\n8.\t The\tpackage\tgoal\tin\tthe\tprevious\tcommand\tshould\thave\tcreated\tthe\tuber JAR\tin\tthe\ttarget\tdirectory\tfor\tus.\tIf\tyou\twish,\tyou\tcould\ttry\trunning\tthe JAR\tusing\tthe\tjava\t-jar\tcommand\tas\twell.\tNow\tthat\tour\tservice\tis\tready, let's\tgo\tahead\tand\ttest\tit\tby\tposting\ta\tgeolocation.\tExecute\tthe\tfollowing curl\tcommands\tin\tyour\tterminal: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\"longitude\":\t-88.144040}'\n\nhttp://localhost:8080/geolocation\n\n9.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\nThe\tprevious\tmethod\tshowed\tyou\thow\tto\tpackage\tyour\tapplication\tusing\tthe spring-boot-maven-plugin.\tBut\tif\tyou\twould\tlike\tto\tuse\tthe\tmaven-shade- plugin,\tyou\tcan\tdo\tthat\ttoo.\tThe\tsupport\tfor\tusing\tmaven-shade-plugin\tis available\tin\tthe\tspring-boot-starter-parent\tproject.\tIf\tyou\tlook\tat\tthe\tPOM\tfile of\tthe\tparent\tproject,\tyou\tcan\tsee\tthe\tmaven-shade-plugin\tdefined.\tThe\tchoice of\tusing\teither\tspring-boot-maven-plugin\tor\tmaven-shade-plugin\tis\tleft\tto you\tand\tpurely\tdepends\ton\tyour\tneed.\n\nThere\tare\tother\tgoals\tthat\tspring-boot-maven-plugin\tprovides.\tSome\tof\tthem are\tthe\tstart\tand\tstop\tgoals.\tThe\tstart\tgoal\tis\tvery\tsimilar\tto\trun,\texcept\tit\tdoes not\tblock\tthe\toperation.\tIt\tis\tusually\tused\twhen\tyou\twould\tlike\tto\trun\tintegration tests\ton\tyour\tmicroservice.\tThe\tstop\tgoal\tis\tused\tto\tstop\tthe\tapplication\tthat\twas started\tusing\tthe\tstart\tgoal.\tTo\tlearn\tmore\tabout\tthis\tplugin,\tvisit\tthe documentation\tpage\tat\thttp://docs.spring.io/spring- boot/docs/1.3.6.RELEASE/maven-plugin/index.html\t.\n\nInstalling\tand\tsetting\tup\tDocker\n\nBefore\twe\tlook\tat\tthe\trecipe,\tlet's\tquickly\ttalk\tabout\twhy\twe\twill\tneed\tDocker installed.\tDocker\thas\tbeen\tone\tof\tthe\tmost\tpopular\tcontainer\tframeworks\tand has\tpicked\tup\ttraction\tin\tthe\tpast\tfew\tyears.\tIn\tfact,\tthere\tare\ta\tlot\tmany organizations\tthat\tcompletely\tdepend\ton\tDocker\tfor\tshipping\tand\tdeploying their\tapplications.\tGone\tare\tthe\tdays\twhen\tDevelopers,\tBuild\tMeisters, Infrastructure\tEngineers,\tand\tDeployment\tCoordinators\twould\tdeploy\tany\tnew code\tand\tinfrastructure\tevery\trelease\tin\tthe\tmiddle\tof\tthe\tnight,\tmaking\tsure\tthe deployment\tof\tthe\tnew\tcode\tor\tinfrastructure\tdoes\tnot\taffect\texisting\tusers.\tWith frameworks\tsuch\tas\tDocker,\tMesos,\tand\tKubernetes,\tdeployments\thave\tbecome so\tmuch\teasier\tthan\thow\tthey\twere\ta\tfew\tyears\tback.\n\nLet's\tsay\tyou\twould\tlike\tto\tdeploy\ta\tweb\tapplication\tto\tTomcat.\tThere\tare definitely\tsome\tprerequisites;\tfor\tinstance,\tyou\twill\tneed\tat\tleast\ta\tfour-core machine\twith\t16\tGB\tmemory\tand\t100\tGB\tdisk\tspace.\tAnd\tafter\tthat,\tyou\thave to\tinstall\tan\toperating\tsystem\ton\tit.\tAfter\tyou\thave\tyour\tOS\tinstalled,\tyou\tneed many\tother\ttools,\tsuch\tas\tJava,\tTomcat,\tNginx,\tand\tperhaps\tother\tmonitoring and\tlog\tmanagement\ttools.\tNow\tyou\tneed\tsomeone\tto\tmaintain\tthis\tmachine- upgrades,\tinstallations,\tdeployments,\tand\tso\ton.\tIt\tbecomes\teven\tharder\tif\tyou want\ta\thorizontal\tand\tvertical\tcluster.\n\nNow\tyou\tneed\tmore\tresources,\tplus\tyou\twill\tneed\tmore\tadministrators\tto manage\tyour\tmachines.\tWhat\tif\tyou\tcould\trun\tyour\tapplication\tinside\ta container\tthat\thas\tall\tthese\tprerequisites\talready\tset\tup?\tWhat\tif\tyou\tcould\tcreate images\tthat\talready\thave\tyour\tprerequisites\tand\tyour\tapplication?\tThat's\texactly what\tDocker\thelps\tyou\twith.\tDocker\thelps\tyou\tbuild\timages\twith\twhatever\tyou need\tand\talso\thelps\tyou\trun\tcontainers\tfor\tyour\timages\ton\tmachines\tthat\thave Docker\tinstalled.\tMachines\tthat\thave\tDocker\tinstalled\tare\tcalled\tDocker\thosts. You\twill\tsee\tthis\tterm\tbeing\tused\ta\tlot\tthroughout\tthe\tbook.\n\nGetting\tready\n\nAt\tthe\ttime\tof\twriting\tthis,\tnative\tDocker\tinstallations\tfor\tboth\tMac\tand Windows\tare\tstill\tin\tbeta.\tSo\twe\twill\tbe\tusing\tDocker\tMachine\tin\tthis\trecipe\tand the\trest\tof\tthe\tbook.\tMoreover,\twe\twill\tbe\tusing\tthe\tMac\tversion\tof\tDocker Machine.\tIf\tyou\tare\ta\tWindows\tuser,\tmost\tof\tthe\tinstructions\tare\tstill\tgoing\tto\tbe the\tsame.\n\nIf\tyou\tare\ta\tLinux\tuser,\tyou\tcan\tskip\tthe\tsteps\twhere\twe\twork\twith\tDocker Machine.\tInstalling\tDocker\ton\tLinux\tis\tso\tmuch\teasier\tcompared\tto\tMac\tand Windows.\tPlease\tfollow\tthe\tinstallation\tinstructions\ton\tDocker's\twebsite\tto install\tit\ton\tyour\tLinux\tmachine.\tYou\tcan\tfind\tthe\tdocumentation\there:\t https://docs.docker.com/engine/installation/#/on-linux\t.\n\nDocker\tMachine\tfor\tMac\tor\tWindows\tutilizes\tOracle\tVirtualBox\tto\tspin\toff virtual\tmachines\tthat\tact\tas\tDocker\thosts.\tDocker\tMachine\twill\tcommunicate with\tthe\tVirtualBox\tVM\tinstances\tfor\tany\tcommands\tyou\tissue\tin\tyour command\tline.\tFor\tmore\tinformation\ton\thow\tDocker\tMachine\tworks,\ttake\ta look\tat\tthis\tlink:\thttps://docs.docker.com/machine/concepts\t.\tAs\tthis\tis\ta\tlittle out\tof\tscope\tfor\tthis\tbook,\tit\tis\tstrongly\trecommended\tthat\tyou\tread\tand understand\thow\tDocker\tand\tDocker\tMachine\twork\tbefore\tmoving\tto\tthe\tnext section.\n\nHow\tto\tdo\tit... 1.\t Let's\tgo\tto\tthe\thomepage\tof\tDocker\tToolbox\tat\n\nhttps://www.docker.com/products/docker-toolbox\t.\tDocker\tToolbox\tis currently\tsupported\tfor\tWindows\tand\tMac.\tIt\tis\tjust\ta\tpackage\tof\tfour different\tproducts\tfrom\tDocker:\tDocker\tEngine,\tDocker\tMachine,\tDocker Compose,\tand\tDocker\tKitematic.\n\nNote\n\nDocker\tKitematic\tis\tDocker's\tattempt\tat\ta\tUI-driven\tmanagement\tconsole for\tDocker\ton\tyour\tmachine.\tWe\twill\tbe\tlooking\tat\tDocker\tCompose\tin\tthe next\tchapter.\n\n2.\t From\tthe\thome\tpage,\tchoose\tyour\toperating\tsystem\ttype\tand\tdownload\tthe DMG\t(for\tMac)\tor\tEXE\t(for\tWindows)\tfile.\tAt\tthe\ttime\tof\twriting\tthis,\tthe following\tis\thow\tthe\tDocker\tToolbox\thomepage\tlooked\tlike.\tOver\ttime, there\tcould\tbe\tchanges\tbut\tthe\tidea\tis\tto\tdownload\tthe\tDMG\tor\tEXE\tfile from\tthe\thome\tpage.\n\n3.\t Once\tthe\tdownload\tis\tcomplete,\tgo\tahead\tand\topen\tthe\tdownloaded installer\tfile.\tYou\tshould\tsee\tsomething\tlike\tthis.\tGo\tahead\tand\tclick\ton\n\nContinue.\n\n4.\t In\tthe\tOverview\tsection,\tyou\twill\thave\tthe\toption\tto\tlet\tDocker\tcollect anonymous\tdata\tfor\ttheir\tpurposes.\tEither\tcheck\tor\tuncheck\tthat\toption\tand hit\tContinue:\n\n5.\t The\tnext\ttwo\tsections,\tDestination\tSelect\tand\tInstallation\tType,\tare\tpretty straight-forward.\tYou\twill\tbe\tprompted\tto\tchoose\twhere\tyou\twould\tlike\tto install\tDocker\tToolbox.\tChoose\tthe\tdirectory\tof\tyour\tchoice\tand\thit\tInstall:\n\n6.\t You\twill\tbe\tshown\tthe\tprogress\tof\tyour\tinstallation,\tand\twhen\tit\tis complete,\tyou\twill\tsee\tsomething\tlike\tthis:\n\n7.\t You\twill\tbe\tprompted\tto\teither\topen\tDocker\tQuickstart\tTerminal\tor Kitematic.\tSkip\tthem\tboth\tand\thit\tContinue\tto\tcomplete\tthe\tinstallation. 8.\t Now\tlet's\ttest\tour\tinstallation.\tAs\twe\tare\tusing\tMac\tin\tour\trecipes,\tyou\twill see\tUnix\tcommands\tused\tthroughout\tthe\tbook.\tFor\tWindows\tusers,\tit\tmight be\ta\tgood\tidea\tto\tinstall\tCygwin\tif\tyou\tare\tfamiliar\twith\tit.\tEither\tway,\tthe commands\tshould\tbe\tthe\tsame\ton\tboth\toperating\tsystems.\tIssue\tthe following\tcommand\ton\tyour\tterminal:\n\ndocker-machine\tls\n\n9.\t This\tcommand\tis\tused\tto\tlist\tthe\tVirtualBox\tVMs\tcreated\tin\tyour\tmachine. By\tdefault,\tyou\twill\tsee\tone\tVM\tcreated,\twith\tthe\tname\tdefault.\tYou\twill see\tsomething\tlike\tthis:\n\n10.\t By\tdefault,\tthis\tVM\tmight\tnot\thave\tsufficient\tresources\tto\trun\tthe\n\nframeworks\twe\twould\twant\tto\tuse.\tSo\tlet's\trecreate\tthis\tVM\twith\t4\tCPUs and\t4096\tMB\tmemory.\tExecute\tthe\tfollowing\tcommand\tto\trecreate\tyour VM\t(if\tit\tasks\tfor\tdelete\tconfirmation,\tchoose\tYes):\n\ndocker-machine\trm\tdefault\t&&\tdocker-machine\tcreate\t-d\t virtualbox\t--virtualbox-memory=4096\t--virtualbox-cpu-count=4\t default\n\n11.\t We\tare\tdoing\ttwo\tthings\tin\tthe\tpreceding\tcommand:\tremoving\tthe\texisting VM\tand\trecreating\tthe\tVM\twith\tmore\tresources.\tAs\tyou\tcan\tsee,\twe\tare passing\tVirtualBox\tspecific\targuments\t--virtualbox-memory\tand\t-- virtualbox-cpu-count\t\t\tto\tincrease\tthe\tmemory\tand\tCPU\tcount respectively.\tIn\tour\tcase,\twe\thave\tprovided\t4\tCPUs\tand\t4096\tMB\tmemory to\tour\tVM.\tThis\tshould\tbe\tsufficient\tto\trun\tthe\tframeworks\tthat\twe\twill\tbe using\tin\tthis\tbook. After\tyou\trun\tthe\tcommand\tyou\tshould\thave\tseen\tsomething\tlike\tthis:\n\n12.\t If\tyou\tsee\tthat\tyour\tVM\tis\tstopped,\tissue\tthe\tfollowing\tcommand\tto\tstart\tit:\n\ndocker-machine\tstart\tdefault\n\n13.\t After\tyou\tissue\tthe\tprevious\tcommand,\tyou\twill\tsee\tthis:\n\n14.\t As\tyou\tcan\tsee,\tyou\twill\thave\tto\trun\tthe\tenv\tcommand\tto\tmake\tyour\tshell ready\tto\tuse\tthis\tdocker-machine\tinstance.\tIn\torder\tto\tdo\tthat,\tissue\tthe following\tcommand\ton\tyour\tconsole: eval\t$(docker-machine\tenv\tdefault)\n\n15.\t This\tmakes\tyour\tshell\tready\tto\tuse\tyour\tnewly\tcreated\tDocker\tMachine instance\tcalled\tdefault.\tIf\tyou\twould\tlike\tto\tsee\tyour\tVirtualBox\tVM, open\tVirtualBox,\tand\tyou\twill\tsee\tthat\tyour\tDocker\thost\thas\tbeen\tcreated and\tis\trunning.\tNow\tlet's\ttry\tto\tspin\toff\tour\tfirst\tDocker\tcontainer: docker\trun\thello-world\n\n16.\t You\tshould\tsee\tsomething\tlike\tthis:\n\n17.\t There\tare\tlots\tof\tthings\tgoing\ton\there.\tLet's\ttry\tto\tunderstand\tthem\tone\tby one:\n\nFirst,\tlet's\tunderstand\tthe\tline\tthat\tsays\tUnable\tto\tfind\timage 'hello-world:latest'\tlocally.\tThis\tline\tsays\tthat\tyou\tare\ttrying\tto run\ta\tcontainer\tfor\tan\timage\tthat\tdoes\tnot\texist\tin\tyour\tDocker\thost. Docker\tthen\tdownloads\tthe\timage\tfrom\tDocker\tHub\t(over\tthe Internet)\tand\tlater\tuses\tthat\timage\tto\trun\ta\tcontainer. You\tcan\tfind\tthis\timage\ton\tDocker\tHub\there: https://hub.docker.com/_/hello-world/\t.\tWhile\thello-world\tis\tthe name\tof\tthe\timage,\tlatest\tis\tits\ttag. Tags\tare\tpretty\tmuch\tthe\tsame\tas\tversions.\tAs\tyou\tcan\tsee,\teven\twhen we\tdid\tnot\tprovide\tthe\tdocker\ttag\tin\tour\tdocker\trun\tcommand, Docker\tautomatically\tused\tthe\tlatest\ttag. After\tthe\tdownload,\tyou\tcan\tsee\tthe\thello\tworld\tmessage.\tThis\tsays that\twe\thave\tsuccessfully\trun\tthis\tcontainer\tand\thence\tsuccessfully\n\ninstalled\tDocker.\n\n18.\t If\tyou\twould\tlike\tto\tsee\tthe\timages\tavailable\ton\tyour\tDocker\thost,\tissue\tthe following\tcommand:\n\ndocker\timages\n\n19.\t You\tshould\tsee\tsomething\tlike\tthis:\n\n20.\t If\tyou\twould\tlike\tto\tsee\tthe\tcontainers\tthat\tare\trunning\ton\tyour\tDocker machine,\tuse\tthe\tfollowing\tcommand:\n\ndocker\tps\t-a\n\n21.\t The\t-a\tflag\trequests\tDocker\tto\tshow\tall\tcontainers,\tincluding\tthe\tones\tthat were\tstopped.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto Dockerize\tour\tmicroservice.\n\nWriting\tyour\tDockerfile\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tseen\thow\tto\tpackage\tour\tapplication\tand\thow\tto install\tDocker.\tNow\tthat\twe\thave\tour\tJAR\tartifact\tand\tDocker\tset\tup,\tlet's\tsee how\tto\tDockerize\tour\tmicroservice\tapplication\tusing\tDocker.\n\nGetting\tready\n\nIn\torder\tto\tDockerize\tour\tapplication,\twe\twill\thave\tto\ttell\tDocker\thow\tour\timage is\tgoing\tto\tlook\tlike.\tThis\tis\texactly\tthe\tpurpose\tof\ta\tDockerfile.\tA\tDockerfile has\tits\town\tsyntax\t(or\tDockerfile\tinstructions)\tand\twill\tbe\tused\tby\tDocker\tto create\timages.\tThroughout\tthis\trecipe,\twe\twill\ttry\tto\tunderstand\tsome\tof\tthe most\tcommonly\tused\tDockerfile\tinstructions\tas\twe\twrite\tour\tDockerfile\tfor\tthe geolocation\ttracker\tmicroservice.\n\nHow\tto\tdo\tit... 1.\t First,\topen\tyour\tSTS\tIDE\tand\tcreate\ta\tnew\tfile\tcalled\tDockerfile\tin\tthe geolocation\tproject.\tThe\tfirst\tline\tof\tthe\tDockerfile\tis\talways\tthe\tFROM instruction\tfollowed\tby\tthe\tbase\timage\tthat\tyou\twould\tlike\tto\tcreate\tyour image\tfrom.\tThere\tare\tthousands\tof\timages\ton\tDocker\tHub\tto\tchoose\tfrom. In\tour\tcase,\twe\twould\tneed\tsomething\tthat\talready\thas\tJava\tinstalled\ton\tit. There\tare\tsome\timages\tthat\tare\tofficial,\tmeaning\tthey\tare\twell\tdocumented and\tmaintained.\n\nNote\n\nDocker\tOfficial\tRepositories\tare\tvery\twell\tdocumented,\tand\tthey\tfollow best\tpractices\tand\tstandards.\tDocker\thas\tits\town\tteam\tto\tmaintain\tthese repositories.\tThis\tis\tessential\tin\torder\tto\tkeep\tthe\trepository\tclear,\tthus helping\tthe\tuser\tmake\tthe\tright\tchoice\tof\trepository.\tTo\tread\tmore\tabout Docker\tOfficial\tRepositories,\ttake\ta\tlook\tat https://docs.docker.com/docker-hub/official_repos/\t.\n\n2.\t We\twill\tbe\tusing\tthe\tJava\tofficial\trepository.\tTo\tfind\tthe\tofficial\trepository, go\tto\thub.docker.com\tand\tsearch\tfor\tjava.\tYou\thave\tto\tchoose\tthe\tone\tthat says\tofficial.\tAt\tthe\ttime\tof\twriting\tthis,\tthe\tJava\timage\tdocumentation\tsays it\twill\tsoon\tbe\tdeprecated\tin\tfavor\tof\tthe\topenjdk\timage.\tSo\tthe\tfirst\tline\tof our\tDockerfile\twill\tlook\tlike\tthis: FROM\topenjdk:8\n\n3.\t As\tyou\tcan\tsee,\twe\thave\tused\tversion\t(or\ttag)\t8\tfor\tour\timage.\tIf\tyou\tare wondering\twhat\ttype\tof\toperating\tsystem\tthis\timage\tuses,\ttake\ta\tlook\tat\tthe Dockerfile\tof\tthis\timage,\twhich\tyou\tcan\tget\tfrom\tthe\tDocker\tHub\tpage. Docker\timages\tare\tusually\ttagged\twith\tthe\tversion\tof\tthe\tsoftware\tthey\tare written\tfor.\tThat\tway,\tit\tis\teasy\tfor\tusers\tto\tpick\tfrom.\tThe\tnext\tstep\tis creating\ta\tdirectory\tfor\tour\tproject\twhere\twe\twill\tstore\tour\tJAR\tartifact. Add\tthis\tas\tyour\tnext\tline:\n\nRUN\tmkdir\t-p\toptpackt/geolocation\n\nThis\tis\ta\tsimple\tUnix\tcommand\tthat\tcreates\tthe\toptpackt/geolocation directory.\tThe\t-p\tflag\tinstructs\tit\tto\tcreate\tthe\tintermediate\tdirectories\tif they\tdon't\texist.\tNow\tlet's\tcreate\tan\tinstruction\tthat\twill\tadd\tthe\tJAR\tfile\n\nthat\twas\tcreated\tin\tyour\tlocal\tmachine\tinto\tthe\tcontainer\tat optpackt/geolocation.\n\nADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar\toptpackt/geolocation/\n\n4.\t As\tyou\tcan\tsee,\twe\tare\tpicking\tup\tthe\tuber\tJAR\tfrom\ttarget\tdirectory\tand dropping\tit\tinto\tthe\toptpackt/geolocation/\tdirectory\tof\tthe\tcontainer. Take\ta\tlook\tat\tthe\t/\tat\tthe\tend\tof\tthe\ttarget\tpath.\tThat\tsays\tthat\tthe\tJAR\thas to\tbe\tcopied\tinto\tthe\tdirectory.\n\n5.\t Before\twe\tcan\tstart\tthe\tapplication,\tthere\tis\tone\tthing\twe\thave\tto\tdo,\tthat\tis, expose\tthe\tports\tthat\twe\twould\tlike\tto\tbe\tmapped\tto\tthe\tDocker\thost\tports. In\tour\tcase,\tthe\tin-memory\tTomcat\tinstance\tis\trunning\ton\tport\t8080.\tIn order\tto\tbe\table\tto\tmap\tport\t8080\tof\tour\tcontainer\tto\tany\tport\ton\tour Docker\thost,\twe\thave\tto\texpose\tit\tfirst.\tFor\tthat,\twe\twill\tuse\tthe\tEXPOSE instruction.\tAdd\tthe\tfollowing\tline\tto\tyour\tDockerfile: EXPOSE\t8080\n\n6.\t Now\tthat\twe\tare\tready\tto\tstart\tthe\tapp,\tlet's\tgo\tahead\tand\ttell\tDocker\thow to\tstart\ta\tcontainer\tfor\tthis\timage.\tFor\tthat,\twe\twill\tuse\tthe\tCMD\tinstruction:\n\nCMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\nThere\tare\ttwo\tthings\twe\thave\tto\tnote\there.\tOne\tis\tthe\tway\twe\tare\tstarting\tthe application\tand\tthe\tother\tis\thow\tthe\tcommand\tis\tbroken\tdown\tinto\tcomma- separated\tStrings.\n\nFirst,\tlet's\ttalk\tabout\thow\twe\tstart\tthe\tapplication.\tYou\tmight\tbe\twondering\twhy we\thaven't\tused\tthe\tmvn\tspring-boot:run\tcommand\tto\tstart\tthe\tapplication. Keep\tin\tmind\tthat\tthis\tcommand\twill\tbe\texecuted\tinside\tthe\tcontainer,\tand\tour container\tdoes\tnot\thave\tMaven\tinstalled,\tonly\tOpenJDK\t8.\tIf\tyou\twould\tlike\tto use\tthe\tmvn\tcommand,\ttake\tthat\tas\tan\texercise,\tand\ttry\tto\tinstall\tMaven\ton\tyour container\tand\tuse\tthe\tmvn\tcommand\tto\tstart\tthe\tapplication.\tNow\tthat\twe\tknow we\thave\tJava\tinstalled,\twe\tare\tissuing\ta\tvery\tsimple\tjava\t-jar\tcommand\tto\trun the\tJAR.\tIn\tfact,\tthe\tSpring\tBoot\tMaven\tplugin\tinternally\tissues\tthe\tsame command.\n\nThe\tnext\tthing\tis\thow\tthe\tcommand\thas\tbeen\tbroken\tdown\tinto\tcomma- separated\tStrings.\tThis\tis\ta\tstandard\tthat\tthe\tCMD\tinstruction\tfollows.\tTo\tkeep\tit\n\nsimple,\tkeep\tin\tmind\tthat\tfor\twhatever\tcommand\tyou\twould\tlike\tto\trun\tupon running\tthe\tcontainer,\tjust\tbreak\tit\tdown\tinto\tcomma-separated\tStrings\t(in whitespaces).\n\nYour\tfinal\tDockerfile\tshould\tlook\tsomething\tlike\tthis:\n\nFROM\topenjdk:8 RUN\tmkdir\t-p\toptpackt/geolocation ADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar \t\t\t\t\t\t\t\t\t\t\t\toptpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\nThis\tDockerfile\tis\tone\tof\tthe\tsimplest\timplementations.\tDockerfiles\tcan sometimes\tget\tbigger\tdue\tto\tthe\tfact\tthat\tyou\tneed\ta\tlot\tof\tcustomizations\tto your\timage.\tIn\tsuch\tcases,\tit\tis\ta\tgood\tidea\tto\tbreak\tit\tdown\tinto\tmultiple\timages that\tcan\tbe\treused\tand\tmaintained\tseparately.\n\nWith\tthat\tsaid,\twe've\tcome\tto\tthe\tcompletion\tof\tthis\trecipe.\tThere\tare\tsome\tbest practices\tto\tfollow\twhenever\tyou\tcreate\tyour\town\tDockerfile\tand\timage. Though\twe\thaven't\tcovered\tthat\there\tas\tit\tis\tout\tof\tthe\tscope\tof\tthis\tbook,\tyou still\tshould\ttake\ta\tlook\tat\tthem\tand\tfollow\tthem.\tTo\tlearn\tmore\tabout\tthe\tvarious Dockerfile\tinstructions,\tgo\tto\thttps://docs.docker.com/engine/reference/builder/\t.\n\nBuilding\tyour\tDocker\timage\n\nIn\tthe\tprevious\trecipe,\twe\tcreated\tthe\tDockerfile,\twhich\twill\tbe\tused\tin\tthis recipe\tto\tcreate\tan\timage\tfor\tour\tmicroservice.\tIf\tyou\tare\twondering\twhy\twe would\tneed\tan\timage,\tit\tis\tthe\tonly\tway\twe\tcan\tship\tour\tsoftware\tto\tany\tsystem. Once\tyou\thave\tyour\timage\tcreated\tand\tuploaded\tto\ta\tcommon\trepository,\tit\twill be\teasier\tto\tpull\tyour\timage\tfrom\tany\tlocation.\n\nGetting\tready\n\nBefore\tyou\tjump\tinto\tthe\tactual\trecipe,\tit\tmight\tbe\ta\tgood\tidea\tto\tget\tyourself familiar\twith\tsome\tof\tthe\tmost\tcommonly\tused\tDocker\tcommands.\tIn\tthis recipe,\twe\twill\tuse\tthe\tbuild\tcommand.\tTake\ta\tlook\tat\tthis\tURL\tto\tunderstand the\tother\tcommands: https://docs.docker.com/engine/reference/commandline/#/image-commands\t. After\tfamiliarizing\tyourself\twith\tthe\tcommands,\topen\tup\ta\tnew\tterminal,\tand change\tyour\tdirectory\tto\tthe\troot\tof\tthe\tgeolocation\tproject.\tMake\tsure\tyour docker-machine\tinstance\tis\trunning.\tIf\tit\tis\tnot\trunning,\tuse\tthe\tdocker- machine\tstart\tcommand\tto\trun\tyour\tdocker-machine\tinstance:\n\ndocker-machine\tstart\tdefault\n\nIf\tyou\thave\tto\tconfigure\tyour\tshell\tfor\tthe\tdefault\tDocker\tmachine,\tgo\tahead\tand execute\tthe\tfollowing\tcommand:\n\neval\t$(docker-machine\tenv\tdefault)\n\nHow\tto\tdo\tit... 1.\t From\tthe\tterminal,\tissue\tthe\tfollowing\tdocker\tbuild\tcommand:\n\ndocker\tbuild\t-t\tpackt/geolocation\t.\n\n2.\t We'll\ttry\tto\tunderstand\tthe\tcommand\tlater.\tFor\tnow,\tlet's\tsee\twhat\thappens after\tyou\tissue\tthe\tpreceding\tcommand.\tYou\tshould\tsee\tDocker downloading\tthe\topenjdk\timage\tfrom\tDocker\tHub.\n\n3.\t Once\tthe\timage\thas\tbeen\tdownloaded,\tyou\twill\tsee\tthat\tDocker\ttries\tto validate\teach\tand\tevery\tinstruction\tprovided\tin\tthe\tDockerfile.\tWhen\tthe last\tinstruction\thas\tbeen\tprocessed,\tyou\twill\tsee\ta\tmessage\tsaying Successfully\tbuilt.\tThis\tsays\tthat\tyour\timage\thas\tbeen\tsuccessfully built.\n\n4.\t Now\tlet's\ttry\tto\tunderstand\tthe\tcommand.\tThere\tare\tthree\tthings\tto\tnote here:\n\nThe\tfirst\tthing\tis\tthe\tdocker\tbuild\tcommand\titself.\tThe\tdocker build\tcommand\tis\tused\tto\tbuild\ta\tDocker\timage\tfrom\ta\tDockerfile.\tIt needs\tat\tleast\tone\tinput,\twhich\tis\tusually\tthe\tlocation\tof\tthe Dockerfile.\n\nNote\n\nDockerfiles\tcan\tbe\trenamed\tto\tsomething\tother\tthan\tDockerfile\tand can\tbe\treferred\tto\tusing\tthe\t-f\toption\tof\tthe\tdocker\tbuild\tcommand.\tAn instance\tof\tthis\tbeing\tused\tis\twhen\tteams\thave\tdifferent\tDockerfiles for\tdifferent\tbuild\tenvironments,\tfor\texample,\tusing\tDockerfileDev\tfor the\tdevelopment\tenvironment,\tDockerfileStaging\tfor\tthe\tstaging\n\nenvironment,\tand\tDockerfileProd\tfor\tthe\tproduction\tenvironment.\tIt\tis still\tencouraged\tas\ta\tbest\tpractice\tto\tuse\tother\tDocker\toptions\t(like passing\targuments)\tin\torder\tto\tkeep\tthe\tsame\tDockerfile\tfor\tall environments.\tFor\tmore\tinformation\ton\thow\tto\tpass\targuments\tto Dockerfile,\tplease\ttake\ta\tlook\tat\tthis\tdocumentation: https://docs.docker.com/engine/reference/builder/#arg\n\nThe\tsecond\tthing\tis\tthe\t-t\toption.\tThe\t-t\toption\ttakes\tthe\tname\tof\tthe repo\tand\ta\ttag.\tIn\tour\tcase,\twe\thave\tnot\tmentioned\tthe\ttag,\tso\tby default,\tit\twill\tpick\tup\tlatest\tas\tthe\ttag.\tIf\tyou\tlook\tat\tthe\trepo\tname, it\tis\tdifferent\tfrom\tthe\tofficial\topenjdk\timage\tname.\tIt\thas\ttwo\tparts: packt\tand\tgeolocation.\tIt\tis\talways\ta\tgood\tpractice\tto\tput\tthe\tDocker Hub\taccount\tname\tfollowed\tby\tthe\tactual\timage\tname\tas\tthe\tname\tof your\trepo.\tFor\tnow,\twe\twill\tuse\tpackt\tas\tour\ttemporary\taccount\tname, but\tin\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto\tcreate\tour\town\tDocker\tHub account\tand\tuse\tthat\taccount\tname\there. The\tthird\tthing\tis\tthe\tdot\tat\tthe\tend.\tThe\tdot\toperator\tsays\tthat\tthe Dockerfile\tis\tlocated\tin\tthe\tcurrent\tdirectory,\tor\tthe\tpresent\tworking directory\tto\tbe\tmore\tprecise.\n\n5.\t Let's\tgo\tahead\tand\tverify\twhether\tour\timage\twas\tcreated.\tIn\torder\tto\tdo that,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\timages\n\n6.\t The\tdocker\timages\tcommand\tis\tused\tto\tlist\tdown\tall\timages\tavailable\tin your\tDocker\thost.\tAfter\tissuing\tthe\tcommand,\tyou\tshould\tsee\tsomething like\tthis:\n\nAs\tyou\tcan\tsee,\tthe\tnewly\tbuilt\timage\tis\tlisted\tas\tpackt/geolocation\tin\tyour Docker\thost.\tThe\ttag\tfor\tthis\timage\tis\tlatest\tas\twe\tdid\tnot\tspecify\tany.\tThe image\tID\tuniquely\tidentifies\tyour\timage.\tNote\tthe\tsize\tof\tthe\timage.\tIt\tis\ta\tfew megabytes\tbigger\tthan\tthe\topenjdk:8\timage.\tThat\tis\tmost\tprobably\tbecause\tof the\tsize\tof\tour\texecutable\tuber\tJAR\tinside\tthe\tcontainer.\n\nNow\tthat\twe\tknow\thow\tto\tbuild\tan\timage\tusing\tan\texisting\tDockerfile,\twe\tare\tat the\tend\tof\tthis\trecipe.\tThis\tis\tjust\ta\tvery\tquick\tintro\tto\tthe\tdocker\tbuild command.\tThere\tare\tmore\toptions\tthat\tyou\tcan\tprovide\tto\tthe\tcommand,\tsuch\tas CPUs\tand\tmemory.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tdocker\tbuild\tcommand,\ttake\ta\tlook\tat\tthis\tpage:\t https://docs.docker.com/engine/reference/commandline/build/\n\nRunning\tyour\tmicroservice\tinside\ta Docker\tcontainer\n\nIn\tthe\tprevious\trecipe,\twe\tsuccessfully\tcreated\tour\tDocker\timage\tin\tthe\tDocker host.\tKeep\tin\tmind\tthat\tif\tyou\tare\tusing\tWindows\tor\tMac,\tyour\tDocker\thost\tis the\tVirtualBox\tVM\tand\tnot\tyour\tlocal\tcomputer.\tIn\tthis\trecipe,\twe\twill\tlook\tat how\tto\tspin\toff\ta\tcontainer\tfor\tthe\tnewly\tcreated\timage.\n\nGetting\tready\n\nTo\tspin\toff\ta\tnew\tcontainer\tfor\tour\tpackt/geolocation\timage,\twe\twill\tuse\tthe docker\trun\tcommand.\tThis\tcommand\tis\tused\tto\trun\tany\tcommand\tinside\tyour container,\tgiven\tthe\timage.\tOpen\tyour\tterminal\tand\tgo\tto\tthe\troot\tof\tthe geolocation\tproject.\tIf\tyou\thave\tto\tstart\tyour\tDocker\tmachine\tinstance,\tthen\tdo so\tby\tusing\tthe\tdocker-machine\tstart\tcommand,\tand\tset\tthe\tenvironment using\tthe\tdocker-machine\tenv\tcommand.\n\nHow\tto\tdo\tit... 1.\t Go\tahead\tand\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\trun\tpackt/geolocation\n\n2.\t Right\tafter\tyou\trun\tthe\tcommand,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nYay!\tWe\tcan\tsee\tthat\tour\tmicroservice\tis\trunning\tas\ta\tDocker\tcontainer. But\twait-there\tis\tmore\tto\tit.\tLet's\tsee\thow\twe\tcan\taccess\tour\tmicroservice's in-memory\tTomcat\tinstance.\tTry\tto\trun\ta\tcurl\tcommand\tto\tsee\tif\tour\tapp\tis up\tand\trunning:\n\n3.\t Open\ta\tnew\tterminal\tinstance\tand\texecute\tthe\tfollowing\tcURL\tcommand\tin that\tshell:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":-88.144040}'\t http://localhost:8080/geolocation\n\n4.\t Did\tyou\tget\tan\terror\tmessage\tlike\tthis?\n\ncurl:\t(7)\tFailed\tto\tconnect\tto\tlocalhost\tport\t8080: \t\t\t\t\t\t\t\t\t\t\t\tConnection\trefused\n\nLet's\ttry\tto\tunderstand\twhat\thappened\there.\tWhy\twould\twe\tget\ta\tconnection refused\terror\twhen\tour\tmicroservice\tlogs\tclearly\tsay\tthat\tit\tis\trunning\ton\tport 8080?\tYes,\tyou\tguessed\tit\tright:\tthe\tmicroservice\tis\tnot\trunning\ton\tyour\tlocal\n\ncomputer;\tit\tis\tactually\trunning\tinside\tthe\tcontainer,\twhich\tin\tturn\tis\trunning inside\tyour\tDocker\thost.\tHere,\tyour\tDocker\thost\tis\tthe\tVirtualBox\tVM\tcalled default.\n\nSo\twe\thave\tto\treplace\tlocalhost\tin\tyour\tcURL\tcommand\twith\tthe\tIP\tof\tthe container.\tBut\tgetting\tthe\tIP\tof\tthe\tcontainer\tis\tnot\tstraight-forward.\tThat\tis\tthe reason\twe\tare\tgoing\tto\tmap\tport\t8080\tof\tthe\tcontainer\tto\tthe\tsame\tport\ton\tthe VM.\tThis\tmapping\twill\tmake\tsure\tthat\tany\trequest\tmade\tto\tport\t8080\ton\tthe\tVM will\tbe\tforwarded\tto\tport\t8080\tof\tthe\tcontainer.\n\n1.\t Now\tgo\tto\tthe\tshell\tthat\tis\tcurrently\trunning\tyour\tcontainer,\tand\tstop\tyour container.\tUsually,\tCtrl\t+\tC\twill\tdo\tthe\tjob.\tAfter\tyour\tcontainer\tis\tstopped, issue\tthe\tfollowing\tcommand:\n\ndocker\trun\t-p\t8080:8080\tpackt/geolocation\n\n2.\t The\t-p\toption\tdoes\tthe\tport\tmapping\tfrom\tDocker\thost\tto\tcontainer.\tThe port\tnumber\tto\tthe\tleft\tof\tthe\tcolon\tindicates\tthe\tport\tnumber\tof\tthe\tDocker host,\tand\tthe\tport\tnumber\tto\tthe\tright\tof\tthe\tcolon\tindicates\tthat\tof\tthe container.\tIn\tour\tcase,\tboth\tof\tthem\tare\tsame.\tAfter\tyou\texecute\tthe previous\tcommand,\tyou\tshould\tsee\tthe\tsame\tlogs\tthat\tyou\tsaw\tbefore. 3.\t We\tare\tnot\tdone\tyet.\tWe\tstill\thave\tto\tfind\tthe\tIP\tthat\twe\thave\tto\tuse\tto\thit our\tRESTful\tendpoint.\tThe\tIP\tthat\twe\thave\tto\tuse\tis\tthe\tIP\tof\tour\tDocker Machine\tVM.\tTo\tfind\tthe\tIP\tof\tthe\tdocker-machine\tinstance,\texecute\tthe following\tcommand\tin\ta\tnew\tterminal\tinstance:\n\ndocker-machine\tip\tdefault\n\n4.\t This\tshould\tgive\tyou\tthe\tIP\tof\tthe\tVM.\tLet's\tsay\tthe\tIP\tthat\tyou\treceived was\t192.168.99.100.\tNow,\treplace\tlocalhost\tin\tyour\tcURL\tcommand with\tthis\tIP,\tand\texecute\tthe\tcURL\tcommand\tagain: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":-88.144040}'\t http://192.168.99.100:8080/geolocation\n\n5.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\n\n\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n6.\t This\tconfirms\tthat\tyou\tare\table\tto\taccess\tyour\tmicroservice\tfrom\tthe outside.\tBefore\tyou\tmove\ton\tto\tthe\tnext\trecipe,\ttake\ta\tmoment\tto understand\thow\tthe\tport\tmapping\tis\tdone.\tThe\tfollowing\tfigure\tshows\thow your\tmachine,\tVM,\tand\tcontainer\tare\torchestrated:\n\nAs\tyou\tcan\tsee,\tthe\tDocker\tcontainer\tis\trunning\tinside\tthe\tDocker\thost (VirtualBox\tVM),\twhich\tin\tturn\tis\trunning\ton\tour\tlocal\tcomputer.\tThis\tis\tthe hierarchy\tin\twhich\tthe\tmachines\tare\torchestrated.\tOur\tport\tmapping\tmaps\tport 8080\ton\tthe\tDocker\thost\tto\tport\t8080\tof\tthe\tDocker\tcontainer.\n\nPushing\tyour\timage\tto\tDocker\tHub\n\nIn\tthe\tprevious\trecipe,\twe\tsaw\thow\tto\trun\tyour\tmicroservice\tas\ta\tDocker container.\tYour\timage\tis\tnot\treally\tuseful\tunless\tyou\tmake\tit\teasier\tfor\tshipping. In\torder\tfor\tyour\timage\tto\tbe\taccessible\tfrom\tother\tplaces,\tyou\tshould\tfirst\thost it\tsomewhere.\n\nThere\tare\ttwo\tways\tof\tdoing\tthis:\teither\tpush\tyour\timage\tto\tthe\tDocker\tHub central\trepository,\tor\tcreate\tyour\town\tprivate\tDocker\tregistry\tand\tpush\tit\tthere. Repositories\tcreated\ton\tDocker\tHub\tare\tby\tdefault\tpublic.\tYou\tcan\tstill\tpurchase various\tplans\tto\tmake\tyour\trepositories\tprivate.\tThat\tis\tcompletely\tup\tto\tyou\tand depends\ton\tyour\tuse\tcase.\n\nGetting\tready 1.\t Before\tyou\tcan\tpush\tthe\timage\tto\tDocker\tHub,\tyou\twill\tfirst\tneed\ta\tDocker Hub\taccount.\tIf\tyou\talready\thave\tone,\tskip\tthis\tstep.\tIf\tyou\tdon't\thave\tone, go\tto\thttps://hub.docker.com/\tand\tstart\tcreating\tan\taccount\tfor\tyourself. You\twill\tneed\tthree\tthings:\n\nUser\tID Email\tassociated Password\n\n2.\t After\tyou\thave\tcreated\ta\tnew\taccount,\tlog\tin\twith\tyour\tcredentials.\tTake some\ttime\tto\tget\tfamiliar\twith\tthe\tDocker\tHub\tuser\tinterface.\tIt\tis\tpretty simple\tand\tstraight-forward.\n\n3.\t The\tnext\tthing\twe\thave\tto\tdo\tis\tcreate\ta\trepository\tfor\tour\tnew microservice.\tThis\tis\trequired\tbefore\twe\tstart\ttrying\tto\tpush\tthe\timage\tto Docker\tHub.\tTo\tcreate\ta\tnew\trepository,\tclick\ton\tthe\tCreate\tRepository button:\n\n4.\t In\tthe\tCreate\tRepository\tform,\tenter\tthe\trepository\tname\tas\tgeolocation. Give\tthe\tshort\tdescription\tas\tGeo\tLocation\tTracking\tService\tand\tthe\tfull description\tas\tGeo\tlocation\ttracking\tmicroservice\tthat\twill\tbe responsible\tfor\tcollecting\tand\tstoring\tgeolocations\tof\tusers. Mark\tthe\tvisibility\tof\tyour\timage\tas\tpublic.\tIf\tyou\thave\tsome\tsensitive information\tin\tyour\timage,\tit\tis\trecommended\tyou\tuse\tprivate.\tBut\tsince our\timage\tis\tnot\tthat\tsensitive,\twe\twill\tuse\tpublic\tvisibility.\tMoreover, using\tthe\tprivate\tvisibility\trequires\tadditional\tconfiguration\twhen\tyou\ttry to\tpull\tyour\timage\tfrom\tMarathon\tand\tKubernetes.\n\n5.\t After\tentering\tall\tthese\tfields,\thit\tthe\tCreate\tbutton.\tAfter\tthe\trepository\tis created,\tyou\tshould\tsee\ta\tscreen\tsimilar\tto\tthis:\n\nAs\tyou\tcan\tsee,\tfor\tconsistency,\twe\twill\tuse\tmy\tDocker\tHub\taccount\tthroughout the\tbook.\tNow\tthat\twe\thave\tour\trepository\tready,\twe\tjust\thave\tto\tpush\tour image\tto\tthis\trepository.\n\nHow\tto\tdo\tit... 1.\t Before\tyou\tcan\tpush\tthe\timage\tto\tyour\tnewly\tcreated\tDocker\tHub\trepo,\n\nyou\thave\tto\tfirst\ttag\tthe\timage\tbecause\tyou\twill\tbe\tpushing\tit\tto\tyour\town repo\tand\tnot\tpackt.\tIn\tthis\tcase,\twe\twill\tbe\tpushing\tit\tto\tmy\taccount, vikrammurugesan.\tBut\tplease\tchange\tit\tto\tyour\taccount\tname\twherever\tyou see\tvikrammurugesan\tgoing\tforward.\tOpen\ta\tterminal\twindow\tand\tmake sure\tyou\thave\tdocker-machine\tstarted.\tIf\tnot,\tgo\tahead\tand\tstart\tit,\tand\tset the\tenvironment\tas\twell.\tExecute\tthe\tfollowing\tcommand\tin\tyour\tshell:\n\ndocker\ttag\tpackt/geolocation\tvikrammurugesan/geolocation\n\n2.\t To\tcheck\twhether\tyour\timage\twas\ttagged\twith\tthe\tnew\trepo\tname,\tissue\tthe docker\timages\tcommand\tand\tsee\twhether\tyou\tget\tsomething\tlike\tthis:\n\n3.\t As\tyou\tcan\tsee,\tthere\tis\ta\tnew\timage\tnow\twith\tthe\tnew\trepo\tname\twe\tjust created.\tIf\tyou\tlook\tat\tthe\timage\tIDs\tof\tthese\ttwo\timages,\tthey're\tthe\tsame. That\tis\tbecause\twe\tjust\ttagged\tthe\tpackt\timage\twith\tthe\tnew\trepository's account\tname\twithout\tany\tmodifications. Note\n\nTo\tlearn\tmore\tabout\tthe\tdocker\ttag\tcommand,\ttake\ta\tlook\tat\tits documentation:\thttps://docs.docker.com/engine/reference/commandline/tag/\n\n4.\t The\tnext\tstep\twill\tbe\tpushing\tthe\timage\tover\tto\tDocker\tHub.\tTo\tdo\tthat, execute\tthe\tfollowing\tcommand:\n\ndocker\tpush\tvikrammurugesan/geolocation\n\n5.\t You\twill\tsee\tthat\tin\torder\tto\tpush\tthe\timage\tto\tthe\trepo\tin\tmy\taccount, authentication\tis\trequired.\tThis\tis\tto\tmake\tsure\tanother\tuser\tis\tnot\tusing\tthe same\trepo.\n\n6.\t To\tauthenticate\tyourself,\tyou\tneed\tto\tuse\tthe\tdocker\tlogin\tcommand.\tUse the\tfollowing\tcommand\tto\tauthenticate\tyourself:\n\ndocker\tlogin\n\n7.\t After\tyou\texecute\tthe\tprevious\tcommand,\tDocker\twill\task\tyou\tto\tenter\tyour credentials.\tAfter\tsuccessful\tauthentication,\texecute\tthe\tsame\tdocker\tpush command\tagain.\tThis\ttime\tyou\twill\tsee\tthat\tyour\timage\tis\tbeing\tuploaded to\tDocker\tHub:\n\n8.\t This\tprocess\tusually\ttakes\tsome\ttime\tbecause\tit\tis\tuploading\ta\t656.6\tMB file\tto\tthe\tInternet.\tThe\ttime\ttaken\tdepends\ton\tthe\tspeed\tof\tyour connection.\tNow\tthat\tyour\timage\thas\tbeen\tsuccessfully\tuploaded\tto\tDocker Hub,\tlet's\tgo\tahead\tand\tverify\tthat\tyour\timage\tis\tavailable\ton\tit.\tGo\tto\tyour Docker\tHub\tpage\tfrom\tyour\tbrowser\tand\tnavigate\tto\tthe\tgeolocation\trepo. From\tthere,\tclick\ton\tthe\tTags\ttab\tand\tmake\tsure\tyou\tsee\ta\tnew\tentry\tfor\tthe latest\ttag:\n\nThis\tconfirms\tthat\tyour\timage\thas\tbeen\tsuccessfully\tpushed\tto\tDocker\tHub. Note\tthe\tsize\tof\tthe\timage:\tit\tis\tmuch\tsmaller\tthan\tthe\tactual\tsize\tof\tthe\timage. That\tis\tbecause\tDocker\tcompresses\tthe\timage\tbefore\tit\tuploads\tit\tto\tDocker Hub.\n\nThat's\tit!\tYou\thave\tsuccessfully\tcreated\tand\tuploaded\tyour\tmicroservice\timage to\tDocker\tHub.\tYour\timage\tcan\tnow\tbe\tpulled\tfrom\tany\tlocation.\n\nWhat\twe\thave\tseen\tso\tfar\tis\tjust\ta\tsimple\tapproach\tto\tdockerizing\tyour microservice\tand\tpushing\tit\tto\tDocker\tHub.\tIn\ta\treal-life\tscenario,\tyou\twill\tbe required\tto\tuse\tdifferent\tdocker\tcommands\tand\tdifferent\ttechniques.\tIt\tis strongly\trecommended\tthat\tyou\tgo\tthrough\tDocker's\tdocumentation\tto understand\teach\tand\tevery\tcommand\tand\ttheir\tadditional\toptions.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\tchapter.\n\nChapter\t3.\tDeploying\tMicroservices on\tMesos\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tdeploy\tmicroservices\ton\tMesos,\twhich\tis\tan open\tsource\tcluster\tmanagement\tframework\tfrom\tApache.\tWe\twill\tcover\tthe following\trecipes:\n\nSetting\tup\ta\tMesos\tcluster\tusing\tDocker Understanding\tthe\tMesos\tand\tMarathon\tinterface Deploying\tyour\tmicroservice\tto\tMesos\tusing\tMarathon Configuring\tports\tin\tMarathon Configuring\tvolumes\tin\tMarathon Configuring\tenvironment\tvariables\tin\tMarathon Scaling\tyour\tmicroservice\tin\tMarathon Destroying\tyour\tmicroservice\tin\tMarathon Monitoring\tyour\tmicroservice\tlogs\tin\tMarathon Monitoring\tyour\tmicroservice\tlogs\tin\tMesos Managing\tyour\tmicroservice\tusing\tMarathon's\tREST\tAPI",
      "page_number": 89
    },
    {
      "number": 3,
      "title": "Deploying\tMicroservices on\tMesos",
      "start_page": 134,
      "end_page": 230,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nBefore\twe\tjump\tinto\tthe\trecipes\tand\ttry\tcreating\ta\tMesos\tcluster,\tit\tis\tvery important\tthat\tyou\tknow\twhat\tMesos\tis\tand\twhy\twe\tuse\tit\tto\tdeploy microservices.\n\nLet's\tanswer\tthe\tfirst\tquestion:\tWhat\tis\tMesos?\n\nMesos\tis\ta\tcluster\tmanagement\tframework\tthat\tmakes\tresource\tallocation\teasier in\torder\tto\trun\tdistributed\tapplications.\tIf\tyou\tbreak\tthis\tsentence\tdown,\tit\twill start\tmaking\tmore\tsense.\tMesos\tis\tcalled\ta\tcluster\tmanagement\tframework because\tit\tgroups\tmultiple\tmachines\tinto\tone\tsingle\tvirtual\tresource\tpool.\tLet's say\tyou\thave\t10\tmachines\twith\t4\tGB\tmemory,\t4\tcores\teach,\tand\t10\tGB\tdisk space.\tNow\tyou\twould\tlike\tto\tuse\tthese\tmachines\tto\tdo\tdifferent\tthings,\tsuch\tas the\tfollowing:\n\nRun\tSpark\tjobs Run\tlong\trunning\tservices Run\tCron\tjobs Run\tHadoop Run\tCassandra\n\nIn\tthis\tcase,\tyou\twould\tideally\thave\tto\tgo\tto\ta\twhiteboard\tand\tdraw\tout\tan architecture\tdiagram\tthat\tidentifies\twhat\tis\tgoing\tto\trun\ton\twhat\tmachine.\tYou will\thave\tmachines\tdedicated\tfor\ta\tsingle\tpurpose.\tA\tmachine\tdedicated\tto\trun Spark\tjobs\tmight\tnot\tbe\tused\tto\trun\tDocker\tcontainers\tunless\tyou\tgo\tand\tinstall Docker\ton\tthat\tmachine.\tSo\tas\tyou\tcan\tsee,\tthere\tis\tquite\ta\tbit\tof\twork\tinvolved in\torder\tto\tmaintain\tthis\tcluster.\tAt\tthe\tsame\ttime,\tthis\tsetup\tis\tnot\tfault\ttolerant. This\tis\texactly\twhat\tMesos\tsolves.\tIf\tyou\tinstall\tMesos\ton\tthose\t10\tmachines, you\twill\tget\ta\tcluster\twith\ttotal\tresources\tof\t40\tGB\tmemory,\t40\tcores,\tand\t100 GB\tdisk\tspace\t(keeping\tin\tmind\tthat\tone\tother\tmachine\tis\tused\tas\tthe\tmaster). With\tthat\tsaid,\tMesos\tmakes\tit\teasier\tto\trun\tany\ttype\tof\ttask\ton\tany\tof\tthese\t10 machines.\n\nNow\tlet's\tmove\ton\tto\tresource\tallocation.\tAs\tMesos\tgroups\tall\tthe\tresources from\tall\tthe\tmachines\t(slaves\tor\tagents\tin\tMesos\tterms)\tinto\tone\tsingle\tvirtual resource\tpool,\tallocation\tof\tresources\tis\tautomatically\ttaken\tcare\tof\tby\tMesos.\n\nFor\texample,\tif\tyou\twould\tlike\tto\tspin\toff\ta\tSpark\tjob\tthat\tneeds\t2\tcores,\t2\tGB memory\tand\t1\tGB\tdisk\tspace,\tMesos\tautomatically\tmakes\ta\tdecision\ton\twhere this\tSpark\tjob\tis\tgoing\tto\tbe\tsubmitted\tbased\ton\tthe\tavailability\tof\tresources. This\tis\tone\tof\tthe\ttrue\twins\tof\tMesos\tcompared\tto\tother\tcluster\tmanagement frameworks.\n\nFinally,\tlet's\ttalk\tabout\trunning\tdistributed\tapplications.\tPart\tof\tthis\twas\tactually explained\tin\tthe\tprevious\tsection\tthat\ttalked\tabout\tSpark\tjob\tsubmissions.\tOne example\tof\thow\tMesos\thelps\trun\tdistributed\tapplications\tis\tthe\texecution\tmode of\tSpark\tjobs.\tIf\tyou\tare\trunning\tSpark\tjobs\ton\ta\tMesos\tcluster,\tyou\tcan\tchoose between\ttwo\tmodes:\tcoarse\tgrained\tand\tfine\tgrained.\tBoth\tof\tthese\tmodes\tdefine how\tthe\tcores\tare\tshared\tbetween\tmultiple\tSpark\ttasks.\tAs\tthe\tname\tsuggests, fine-grained\tmode\tis\tresponsible\tfor\tsharing\tthe\tcores\tat\ta\tmore\tgranular\tlevel. At\tthe\ttime\tof\twriting\tthis,\tfine-grained\tmode\thas\tbeen\tdeprecated\tby\tSpark\tand will\tsoon\tbe\tremoved.\n\nThe\tother\texample\tis\tbeing\table\tto\trun\tmultiple\tinstances\tof\tthe\tsame\tDocker image\tfrom\tMarathon.\tBy\tdoing\tso,\tyou\tare\tactually\tscaling\tyour\tapplication without\thaving\tto\tworry\tabout\twhere\tyour\tcontainer\tis\trunning.\tThis\twill\tbe covered\tin\tlater\trecipes\tin\tthis\tchapter.\tThese\tfeatures\tclearly\tdepict\thow\tMesos helps\tus\trun\tdistributed\tapplications.\n\nNow\tlet's\tanswer\tour\tsecond\tquestion:\tWhy\tMesos\tto\tdeploy\tmicroservices?\n\nWe\talready\tanswered\tthis\tquestion\tin\tthe\tprevious\tsection\ta\tlittle\tbit.\tLet's\tget into\tthe\tdetails\tnow.\tMesos\tbasically\tfollows\ta\tmaster-slave\tarchitecture,\twhere there\tcan\tbe\tone\tor\tmore\tmasters\tand\tmultiple\tslaves.\tAt\tany\tpoint\tof\ttime,\tonly one\tmaster\twill\tbe\tin\tcharge\t(also\tcalled\tthe\tleader).\tThe\tmaster's\tresponsibility is\tto\tcoordinate\tand\tdelegate\toffers\t(resource\trequests\tto\trun\ttasks)\tbetween\tthe framework\tschedulers\tand\tframework\texecutors.\tFrameworks\tin\tMesos\tare\tused to\trun\tany\tparticular\ttask\ton\ta\tMesos\tcluster.\tThese\ttasks\tcould\tbe\tSpark\tjobs, Cassandra\ttasks,\tDocker\tcontainers,\tand\tso\ton.\tThe\tframework\tthat\tis\tused\tto run\tlong-running\tjobs\tor\tDocker\tcontainers\tis\tcalled\tMarathon.\n\nIn\tthis\tchapter,\twe\twill\tbe\tlearning\textensively\tabout\tMarathon.\tAs\twe\talready have\tour\tapplication\tDockerized\tas\ta\tDocker\timage,\twe\twill\tuse\tMarathon\tand its\tabilities\tto\texpose\tour\tmicroservice.\n\nSetting\tup\ta\tMesos\tcluster\tusing Docker\n\nIn\tthis\trecipe,\twe\twill\tbe\tlearning\thow\tto\torchestrate\tour\tfirst\tMesos\tCluster with\tMarathon\tframework\tconfigured.\tWe\twill\tbe\torchestrating\tthis\tcluster\tin our\tlocal\tmachine\tusing\tDocker\tand\tDocker\tCompose.\n\nGetting\tready\n\nNow\tthat\twe\tknow\twhat\tMesos\tis\tand\twhy\twe\tuse\tit\tto\tdeploy\tour\tmicroservice, let's\torchestrate\tour\tfirst\tMesos\tcluster.\tIn\torder\tto\tdo\tso,\twe\tfirst\tneed\tto understand\tthe\tbuilding\tblocks\tof\tMesos.\tMesos\tis\tmade\tof\tthe\tfollowing\tfour components:\n\nZookeeper Mesos\tmaster Mesos\tslaves\t(also\tcalled\tas\tagents) Mesos\tframeworks\n\nZookeeper\n\nZookeeper\tis\tan\topen\tsource\ttool\tfrom\tApache\tused\tfor\tcentralizing\tcluster information\tor\tother\tconfigurations.\tMesos\tuses\tZookeeper\tto\tstore\tits\tcluster information.\tOne\tuse\tof\tZookeeper\tin\tMesos\tis\tto\tstore\tinformation\tabout various\tmasters\tin\tthe\tMesos\tcluster.\tMesos\tclusters\tideally\thave\tmore\tthan\tone master\tto\tprovide\tfault\ttolerance;\tthis\tway,\tif\tone\tmaster\tgoes\tdown,\tanother master\ttakes\tcharge.\tAnother\tuse\tof\tZookeeper\tin\tMesos\tis\tto\tstore\tslave information\tto\tkeep\ttrack\tof\tthe\tslaves\tthat\tare\tpart\tof\tthe\tcluster.\tIn\tproduction scenarios,\tit\tis\talways\tideal\tto\thave\ta\tzookeeper\tcluster\tinstead\tof\tstandalone zookeeper\tinstances.\tThis\tmakes\tyour\tcluster\tmore\tfault\ttolerant\tand\tstable.\n\nMesos\tmasters\tand\tMesos\tslaves\n\nThe\tMesos\tmaster\tis\tusually\tresponsible\tfor\tcoordinating\tand\tdelegating\toffers to\tdeploy\ttasks\tto\tMesos\tslaves.\tMesos\tslaves\tideally\thave\tframework-specific executors,\twhich\ttell\tMesos\thow\tto\trun\ta\tspecific\ttask\ton\ta\tslave.\tSchedulers\tfor each\tframework\tare\tresponsible\tfor\tmaking\ta\tdecision\ton\twhether\tor\tnot\tto accept\tan\toffer.\tAn\toffer\tcould\tbe\tas\tsimple\tas\t\"run\tDocker\timage jenkins:latest\ton\tMarathon\twith\t1\tCore,\t2\tGB\tmemory,\tand\t10\tGB\tdisk space.\"\tAt\tthe\tsame\ttime,\tthe\tmaster\tis\talways\taware\tof\tthe\tresource\tavailability on\teach\tslave,\twhich\tis\talso\tsent\tto\tthe\tscheduler.\tAs\tsoon\tas\tthe\tmaster\tsends\tan offer\tover\tto\tthe\tscheduler,\tthe\tscheduler\ttakes\ta\tdecision\ton\twhether\tto\taccept the\toffer\tor\tdecline\tit\tbased\ton\tthe\tresource\tavailability\tand\toffer\trequest.\n\nMesos\tframeworks\n\nMesos\tframeworks\tare\tcomposed\tof\tthe\tScheduler\tand\tExecutor.\tWhile\tthe\n\nMesos\tframeworks\tare\tcomposed\tof\tthe\tScheduler\tand\tExecutor.\tWhile\tthe Scheduler\tis\tresponsible\tfor\tmaking\toffer\tdecisions,\tthe\tExecutor\tis\tresponsible for\trunning\tthe\tactual\tframework\ttask.\tSome\tof\tthe\tmost\tcommonly\tused frameworks\tare:\n\nSpark Cassandra Aurora Marathon Chronos\n\nNote\n\nTo\tget\ta\tfull\tlist\tof\tframeworks,\tvisit http://mesos.apache.org/documentation/latest/frameworks/\t.\n\nThe\tfollowing\tdiagram\tdepicts\tthe\tworking\tof\ta\tMesos\tcluster\twith\tmultiple frameworks:\n\nIn\tthis\tcluster,\tthere\tare\ttwo\tor\tmore\tmasters,\tthree\tor\tmore\tslaves,\tand\tthree frameworks.\tThere\tis\talso\ta\tZookeeper\tquorum\twith\tthree\treplicated\tservers.\tA Zookeeper\tquorum\tis\ta\tset\tof\treplicated\tZookeeper\tservers\tthat\thave\tthe\tsame configuration.\tAs\tyou\tcan\tsee,\tthe\tZookeeper\tquorum\ttalks\tto\tthe\tmasters\tand slaves\tto\telect\tleaders\tfrom\tmasters\tand\tkeep\ttrack\tof\tslaves\tjoining\tthe\tcluster. Also,\tyou\tcan\tsee\thow\tone\tof\tthe\tmasters\tis\tmarked\tas\tLeader\tand\tis\tcurrently active,\tand\tthe\tother\tis\tgrayed\tout\tto\tindicate\tthat\tit\tis\tcurrently\tnot\telected\tas\tthe leader.\tThough\tthe\tframework\tscheduler\tis\tshown\tas\ta\tseparate\tcomponent,\tit\tis still\tpart\tof\ta\tframework.\tAs\twe've\tdiscussed\talready,\ta\tframework\tcontains\ta Scheduler\tand\tExecutor.\tFor\tsimplicity\tand\tunderstandability,\tthe\tscheduler\tand executor\tare\tshown\tas\tseparate\tcomponents.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tMesos\tarchitecture,\ttake\ta\tlook\tat\tthis\tpage: http://mesos.apache.org/documentation/latest/architecture/\n\nNow\twe\tknow\tthat\twe\tneed\tZookeeper,\ta\tMesos\tmaster,\tMesos\tslaves,\tand framework\tto\torchestrate\ta\tminimal\tMesos\tcluster.\tIn\tthis\trecipe,\twe\twill\tbe using\tDocker\tto\trun\tour\tMesos\tcluster.\tThis\tmeans\tthat\tZookeeper,\tthe\tMesos master,\tMesos\tslave,\tand\tframework\twill\tbe\trunning\tas\tDocker\tcontainers\tin your\tlocal\tmachine.\tIn\torder\tto\tdo\tthis,\twe\twill\tuse\tDocker\tCompose.\tDocker Compose\tis\ta\tutility\tfrom\tDocker\tthat\thelps\tyou\trun\tmultiple\tcontainers\tusing\tits powerful\tdocker-compose\tcommand.\tTo\tkeep\tour\tcluster\tsimple\tand\treduce\tthe resource\tutilization\tof\tyour\tlocal\tmachine,\tthe\tcluster\twe\tare\tbuilding\twill consist\tof\tone\tZookeeper\tinstance,\tone\tMesos\tmaster,\tand\tone\tMesos\tslave.\n\nHow\tto\tdo\tit... 1.\t To\tcreate\tyour\tfirst\tdocker-compose\tfile,\topen\tyour\tSTS\tIDE\tand\tcreate\ta new\tfile\tcalled\tdocker-compose-mesos.yml\tin\tyour\tgeolocation\tproject. The\tfirst\tline\tof\tyour\tDocker\tCompose\tfile\tis\tusually\tthe\tversion\tof\tDocker Compose.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tversion2.\tSo\tadd\tthe\tfollowing line\tto\tyour\tDocker\tCompose\tfile:\tversion:\t\"2\"\n\nAt\tone\tpoint,\tDocker\tmade\ta\tchange\tto\thow\tthe\tservices\tare\tdescribed\tin the\tDocker\tCompose\tYAML\tfile.\tTo\tindicate\tthe\tdifference,\tthe\tversion property\twas\tadded\tas\tthe\tfirst\tline\tof\tthe\tYAML\tfiles.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tdifferences,\tread https://docs.docker.com/compose/compose-file/#/versioning\t.\n\n2.\t Now\tlet's\tstart\tdefining\tour\tservices.\tGo\tahead\tand\tadd\tthe\tfollowing services\tsection\tto\tyour\tYAML\tfile:\tservices:\n\nNote\n\nKeep\tin\tmind\tthat\tthis\tis\ta\tYAML\tfile,\tso\tmake\tsure\tyou\tuse\tblank\tspaces instead\tof\tusing\ttabs.\tThe\tindentation\tlevel\tused\tis\ttwo\tblank\tspaces.\n\n3.\t The\tnext\tsection\tin\tyour\tDocker\tCompose\tfile\tis\tto\tspin\tup\tZookeeper.\tAt the\ttime\tof\twriting\tthis,\tthere\tare\tno\tofficial\tZookeeper\timages\tavailable\ton Docker\tHub.\tSo\twe\twill\tbe\tusing\tmy\tZookeeper\timage\tin\tthis\trecipe.\tGo ahead\tand\tadd\tthe\tfollowing\tsnippet\tto\tdefine\tyour\tZookeeper\tinstance: zookeeper:\t\t\t\timage:\tvikrammurugesan/zookeeper\t\t\t\t\tnetwork_mode: host\n\nThere\tare\tthree\tthings\tto\tnote\there:\tThe\tfirst\tone\tis\tthe\tname\tof\tthe service\titself.\tIn\tthis\tcase,\twe\thave\tused\tZookeeper\tas\tour\tservice name.\n\nThe\tnext\timportant\tsection\tis\tthe\timage.\tThis\tsays\twhich\tDocker image\tshould\tbe\tused\tto\tspin\toff\tthis\tcontainer\t(or\tservice).\n\nThe\tlast\tone\tis\tvery\tinteresting.\tThe\tnetwork_mode\tcommand\tspecifies how\tto\tconfigure\tthe\tDocker\tnetwork\tfor\tthis\tcontainer.\n\nThere\tare\tseveral\tmodes,\tsuch\tas\tcontainer,\thost,\tbridged,\tand\tnone. In\tthis\texample,\tfor\tsimplicity,\twe\twill\tuse\thost.\tThe\tnetwork\tmode host\tsays\tthat\twe\twill\tbe\tusing\tthe\thost\tnetwork\tstack\tinside\tthe container,\twhich\twill\texpose\tthe\tservice\tvia\t127.0.0.1.\n\nTo\tlearn\tmore\tabout\tDocker\tnetwork\tmodes,\ttake\ta\tlook\tat https://docs.docker.com/engine/userguide/networking/\t.\n\n4.\t Before\twe\tmove\ton\tto\tthe\tnext\tstep,\tlet's\ttry\tto\tvalidate\twhat\twe\thave\tdone so\tfar\tby\tstarting\tZookeeper\tusing\tdocker-compose.\tYour\tdocker- compose-mesos.yml\tfile\tshould\tlook\tsomething\tlike\tthis:\tversion:\t\"2\" services:\tzookeeper:\timage:\tvikrammurugesan/zookeeper network_mode:\thost\n\n5.\t Now\tgo\tto\tthe\tterminal\tand\tchange\tthe\tdirectory\tto\tthe\troot\tof\tthe geolocation\tproject,\twhere\tyou\thave\tcreated\tthe\tdocker-compose- mesos.yml\tfile.\tExecute\tthe\tfollowing\tcommand:\tdocker-compose\t-f docker-compose-mesos.yml\tup This\tcommand\tis\tused\tto\tbring\tup\tany\tservices\tin\tyour\tdocker-compose file.\tBy\tdefault,\tDocker\tCompose\tassumes\tthat\tthe\tname\tof\tthe\tDocker Compose\tfile\tis\tdocker-compose.yml.\tAs\twe\thave\tused\ta\tdifferent\tname, we\tare\tusing\tthe\t-f\toption\tto\tmention\tthe\tname\tof\tour\tCompose\tfile\tas docker-compose-mesos.yml.\n\n6.\t If\tyou\tget\terrors\tabout\tthe\tDocker\tmachine\tbeing\tdown,\tstart\tyour\tDocker machine\tinstance,\tset\tup\tthe\tenvironment,\tand\treissue\tthe\tsame\tcommand. You\twill\tnotice\tthat\tDocker\tdownloads\tthe\tZookeeper\timage\tfrom\tDocker Hub\tas\tit\tis\tnot\tavailable\tin\tyour\tDocker\thost.\tAfter\tthe\tdownload\tis complete,\tDocker\tCompose\twill\tstart\tyour\tZookeeper\tserver\tand\twill\tshow you\tthe\tlogs\tfrom\tthe\tcontainer:\n\nThe\tpreceding\ttwo\tlog\tmessages\tconfirm\tthat\tyour\tZookeeper\tinstance\tis\tup\tand running.\n\nBefore\tyou\tmove\ton\tto\tthe\tnext\tstep,\tstop\tand\tremove\tthe\tZookeeper\n\ncontainer.\tYou\tcan\tstop\tthe\tcontainer\teither\tby\thitting\tCtrl\t\t+\t\tC\tin\tthe\tconsole or\tusing\tthe\tdocker\tstop\tcommand.\n\nNow\tlet's\tmove\ton\tand\tconfigure\tthe\tCompose\tfile\tto\tstart\tthe\tMesos\tmaster\n\nalong\twith\tZookeeper.\tAgain,\tat\tthe\ttime\tof\twriting\tthis,\tthere\tis\tno\tofficial image\tfor\tthe\tMesos\tmaster.\tSo\twe\twill\tbe\tpicking\tup\tan\timage\tfrom\tDocker Hub.\tIn\tthis\trecipe,\twe\twill\tuse\tthe\tmesos-master\timage\tfrom\tmesosphere. Mesosphere\tis\tthe\tcompany\tbehind\tthe\tpowerful\tcluster\tmanagement\t\"operating system\"\tcalled\tDC/OS.\tWe\twill\tlearn\tmore\tabout\tDC/OS\tin\tlater\tchapters. Go\tahead\tand\tadd\tthe\tfollowing\tsnippet\tto\tyour\tDocker\tCompose\tfile:\n\nmesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper\n\nAs\tyou\tcan\tsee,\twe\thave\tused\tthe\tmesos-master\timage\tfrom\tmesosphere,\tand the\tversion\tthat\twe\thave\tused\tis\t1.0.1-2.0.93.ubuntu1404.\tThis\tversion\tis\tthe latest\tstable\tversion\tat\tthe\ttime\tof\twriting\tthis\tbook.\tWe\talready\tknow\tabout network_mode.\n\nThe\ttwo\tnew\telements\tare\tenvironment\tand\tdepends_on.\tLet's\ttalk\tabout depends_on\tfirst\tas\tit\tis\tsimpler.\tThe\tdepends_on\telement\tsimply\tstates\tthat\tthe service\tthat\tis\tmarked\twith\tthe\tname\tzookeeper\tneeds\tto\tbe\tstarted\tbefore starting\tthis\tservice.\n\nNow\tlet's\ttalk\tabout\tenvironment.\tThe\tenvironment\telement\tis\tused\tto\tadd\n\nany\tenvironment\tvariables\tto\tthe\tcontainer.\n\nFor\texample,\tin\tthe\tprevious\tcase,\twe\tsee\ttwo\tvariables,\tMESOS_ZK\tand\n\nMESOS_HOSTNAME.\tMESOS_ZK\thas\tthe\tvalue\tzk://127.0.0.1:2181/mesos,\twhich specifies\thow\tto\tlook\tup\tMesos\tconfigs\ton\tZookeeper.\tAnd\tthe\tMESOS_HOSTNAME environment\tvariable\tis\tused\tto\tindicate\tthe\tIP\tor\thostname\tto\twhich\tthe\tMesos master\twill\tbe\tbound.\n\nIn\tour\tcase,\twe\thave\tused\tthe\tIP\tof\tour\tDocker\thost,\t192.168.99.100.\tIf\tyou are\tusing\ta\tdocker-machine\tinstance\twith\ta\tdifferent\tIP,\tuse\tthat\tIP\there.\tYour docker-compose-mesos.yml\tfile\twill\tlook\tlike\tthis:\tversion:\t\"2\"\tservices: zookeeper:\timage:\tvikrammurugesan/zookeeper\tnetwork_mode:\thost mesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper\n\nNow\tthat\twe\thave\tour\tZookeeper\tinstance\tand\tMesos\tmaster,\tlet's\tvalidate\tour\n\nwork\tso\tfar.\tTo\tdo\tso,\tstart\tyour\tservices\tusing\tthe\tdocker-compose\tcommand:\n\ndocker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nAfter\tyou\texecute\tthe\tpreceding\tcommand,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nThese\tlogs\tare\tjust\ta\tportion\tof\tthe\tlogs\tthat\tyour\tcontainers\tshow,\tbut\tthey should\tlook\tsimilar.\tAs\tyou\tcan\tsee,\tlogs\tfrom\tdifferent\tcontainers\tare\tmarked with\ttheir\tname\tand\tare\tcolor-coded.\n\nNow\tlet's\tverify\tthat\tour\tMesos\tcluster\tis\tup\tand\trunning\tby\taccessing\tits\tweb interface.\tMesos'\tweb\tUI\tis\tvery\teasy\tto\tuse\tand\thas\tall\tthe\tinformation\tyou\twill need\tto\tknow\tabout\tyour\tcluster.\tThough\tyou\twill\tnot\tbe\tusing\tthis\tvery\toften,\tit is\tstill\ta\tgood\tidea\tto\ttake\ta\tlook\tat\tit.\tYou\tshould\tbe\table\tto\taccess\tthe\tMesos web\tUI\tusing\tthis\tURL:\thttp://192.168.99.100:5050.\t5050\tis\tthe\tdefault\tport used\tby\tMesos\tunless\tyou\tchange\tit\tvia\tconfig.\tYou\tshould\tsee\tsomething\tlike this:\n\nOn\tthe\tleft\thand\tside,\tyou\tcan\tsee\tthat\tthere\tare\tzero\tagent\tnodes\tavailable\t(an\n\nagent\tis\tthe\tsame\tthing\tas\ta\tslave\tor\tworker).\tThis\tis\tbecause\twe\thaven't\tadded any\tMesos\tslaves\tto\tthe\tcluster.\tAt\tthis\ttime,\tour\tcluster\tis\tnot\tuseful,\tas\tit\tdoes not\thave\tany\tslaves.\tBefore\tyou\tmove\ton\tto\tthe\tnext\tstep,\tstop\tand\tremove\tall containers\trunning\tin\tyour\thost.\tYou\talready\tknow\thow\tto\tstop\tthe\tcontainers. You\tcan\tremove\tthe\tcontainers\tby\trunning\tthe\tfollowing\tcommand:\tdocker\trm $(docker\tps\t-a\t-q)\n\nThe\tpreceding\tcommand\tcan\tbe\tbroken\tdown\tinto\ttwo\tparts.\tWe\tfirst\tlist\tdown all\tthe\tcontainers\tusing\tthe\tps\tcommand.\tWe\tpass\t-q\t(quiet\tmode)\targument\tto list\tonly\tthe\tcontainer\tIDs.\tThe\tcontainer\tIDs\tare\tthen\tpassed\tto\tthe\trm\tcommand for\tremoval.\n\nNow\tlet's\tadd\tour\tfirst\tMesos\tslave\tto\tthe\tcluster.\tIn\torder\tto\tdo\tthat,\tadd\tthe\n\nfollowing\tsnippet\tto\tthe\tDocker\tCompose\tfile:\tmesos_slave:\timage: mesosphere/mesos-slave:1.0.1-2.0.93.ubuntu1404\tnetwork_mode:\thost environment:\tMESOS_MASTER:\tzk://127.0.0.1:2181/mesos MESOS_WORK_DIR:\t/tmp\tMESOS_CONTAINERIZERS:\tdocker MESOS_HOSTNAME:\t192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\n\nThere\tare\ta\tfew\tthings\tto\tnote\there:\tfirst,\tthe\tname\tof\tthe\tservice.\tAs\tthe\tname\n\nindicates,\tthis\tservice\twill\tbe\tour\tmesos_slave.\tThe\timage\tis\tdifferent\tfrom\tthat of\tthe\tmaster\tby\tits\tname.\tThe\tversion\tis\texactly\tthe\tsame.\tAgain,\twe\tare\ttaking this\timage\tfrom\tmesosphere.\tThere\tare\tfour\tenvironment\tvariables.\tThe MESOS_MASTER\tenvironment\tvariable\ttells\tthe\tslave\thow\tto\tlook\tup\tthe\tMesos master\tconfig\tfrom\tZookeeper.\n\nIn\tthe\tprevious\tsnippet,\twe\thave\tused\tzk://127.0.0.1:2181/mesos.\tSee\thow 127.0.0.1\tis\tbeing\tused\tas\tthe\thostname\tfor\tZookeeper.\tMESOS_WORK_DIR\tis\tthe directory\ton\tthe\tslave\tthat\twill\tbe\tused\tfor\tstoring\tany\ttemp\tfiles\tor\tany\tother files\tcreated\tby\tthe\texecutor.\tWe\thave\tused\t/tmp\tfor\tthis.\tAs\tfor MESOS_CONTAINERIZERS,\tthough\tthe\tname\tmight\tbe\tpretty\tstraightforward,\tthere are\ta\tfew\tthings\tthat\tyou\tneed\tto\tknow\tabout\tit.\n\nNote\n\nTo\tknow\tmore\tabout\tthis\tproperty,\ttake\ta\tlook\tat\tthis\tpage: http://mesos.apache.org/documentation/latest/containerizer/\n\nIn\tour\texample,\twe\thave\tused\tjust\tdocker.\tThe\tMESOS_HOSTNAME\tenvironment\tis used\tto\tindicate\tthe\tIP\tor\thostname\tto\twhich\tthe\tslave\tshould\tbe\tbound.\tIn\tthe snippet,\twe\thave\tused\tthe\tIP\tof\tour\tdocker-machine\tinstance,\t192.168.99.100. If\tthe\tIP\tof\tyour\tdocker-machine\tinstance\tis\tdifferent,\tuse\tthat\tIP\there.\tThe MESOS_PORT\tenvironment\tvariable\tdefines\tthe\tport\twhere\tyour\tagent\tor\tslave\tis listening.\n\nThe\tvolumes\tsection\tis\tpretty\tinteresting.\tVolumes\tare\tused\tto\tmap\tmount paths\tand\tany\tnamed\tvolumes\tto\tany\tpath\ton\tthe\tDocker\thost.\tIn\tthe\tpreceding example,\twe\thave\tthree\tdifferent\tmappings.\tThese\tmappings\tare\trequired\tto\trun a\tDocker\tcontainer\tinside\tthe\tslave,\twhich\tis\tagain\ta\tDocker\tcontainer.\tThe mappings\tto\tthe\tdocker.sock\tfile\t(varrun/docker.sock)\tand\tthe\tDocker\tbinary (usrbin/docker)\tare\tused\tto\tmake\tthis\thappen.\tThe\tcgroup\tmapping (/sys/fs/cgroup)\tis\trequired\tby\tMesos\titself.\tFinally,\tthe\tdepends_on\tsection\tis something\twe\tsaw\tearlier.\n\nYour\tdocker-compose-mesos.yml\tfile\twill\tlook\tlike\tthis:\tversion:\t\"2\"\tservices: zookeeper:\timage:\tvikrammurugesan/zookeeper\tnetwork_mode:\thost mesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper\n\nmesos_slave_one:\timage:\tmesosphere/mesos-slave:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_MASTER: zk://127.0.0.1:2181/mesos\tMESOS_WORK_DIR:\t/tmp MESOS_CONTAINERIZERS:\tdocker\tMESOS_HOSTNAME: 192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\n\nNow\tlet's\tcheck\twhether\twe\tcan\tsee\tour\tnew\tslave\tdetected\tby\tMesos.\tTo\tdo so,\tissue\tthe\tdocker\tcompose\tup\tcommand\ton\tyour\tconsole:\tdocker-compose\t-f docker-compose-mesos.yml\tup\n\nThis\ttime,\tyou\tshould\tsee\tsome\tadditional\tlog\tmessages\tfrom\tthe\tMesos\tslave container:\n\nNow\tthat\tour\tMesos\tcluster\tis\trunning,\taccess\tthe\tweb\tUI\tfrom\ta\tbrowser\tusing the\tURL\thttp://192.168.99.100:5050:\n\nAs\tyou\tcan\tsee,\tnow\tthere\tis\tone\tnew\tslave\t(or\tagent)\tthat\tis\tactivated.\tYou\n\ncan\talso\tsee\tthat\tthe\tResources\tsection\treflects\tthe\tamount\tof\tresources available\tfor\tthis\tcluster.\tThe\tamount\tof\tresources\tdepends\ton\tthe\tsize\tof\tour Docker\thost.\tIf\tyou\twould\tlike\tto\tincrease\tthe\tresources\tallocated\tto\tyour\tDocker host,\tyou\thave\tto\trecreate\tyour\tVM\twith\tmore\tresources\tusing\tthe\tdocker- machine\tcreate\tcommand.\n\nTip\n\nIf\tyou\twant\tanother\tslave,\tfeel\tfree\tto\tcopy\tthe\tmesos_slave\tsection\tand\tpaste\tit in\tthe\tDocker\tCompose\tfile\tagain\twith\ta\tdifferent\tMESOS_PORT\tnumber.\tAt\tthe same\ttime,\tyou\twill\thave\tto\tchange\tthe\tservice\tname.\n\nWith\tthat\tsaid,\tcan\twe\tsay\tthat\twe\tnow\thave\ta\tfully\tfunctional\tcluster?\tMaybe. That\tis\tbecause\twe\tstill\tdo\tnot\thave\ta\tframework\tinstalled.\tAs\twe\twill\tbe\tusing this\tMesos\tcluster\tto\tdeploy\tour\tDockerized\tmicroservice,\twe\twill\tbe\tinstalling the\tMarathon\tframework\ton\tthis\tcluster.\n\nTo\tregister\tthe\tMarathon\tframework,\tadd\tthe\tfollowing\tsnippet\tto\tyour\tDocker\n\nCompose\tfile:\tmarathon:\timage:\tmesosphere/marathon:v1.1.2 network_mode:\thost\tenvironment:\tMARATHON_MASTER: zk://127.0.0.1:2181/mesos\tdepends_on:\t-\tzookeeper\n\nThe\timage\tthat\twe\thave\tused\tis\tagain\tfrom\tmesosphere,\tand\tthe\tname\tof\tthe\n\nimage\tis\tmarathon.\tSee\tthat\twe\thave\tused\ta\tversion\tdifferent\tthan\tthat\tof\tthe Mesos\tmaster\tand\tslave.\tThis\tis\tbecause\tthe\tframeworks\tare\tnot\ttied\tto\tany\tone version\tof\tmaster\tor\tslave\timages.\tThe\tonly\tenvironment\tvariable\tthat\tis\tused\tis MARATHON_MASTER,\twhich\tis\tset\tto\tzk://127.0.0.1:2181/mesos,\tspecifying\thow to\tlook\tup\tthe\tMesos\tconfigs\ton\tZookeeper.\tFinally,\tthis\tservice\tdepends\ton\tthe Zookeeper\tservice.\n\nYour\tfinal\tdocker-compose-mesos.yml\tfile\twill\tlook\tsomething\tlike\tthis: version:\t\"2\"\tservices:\tzookeeper:\timage:\tvikrammurugesan/zookeeper network_mode:\thost\tmesos_master:\timage:\tmesosphere/mesos-master:1.0.1- 2.0.93.ubuntu1404\tnetwork_mode:\thost\tenvironment:\tMESOS_ZK: zk://127.0.0.1:2181/mesos\tMESOS_HOSTNAME:\t192.168.99.100 depends_on:\t-\tzookeeper\tmesos_slave_one:\timage:\tmesosphere/mesos- slave:1.0.1-2.0.93.ubuntu1404\tnetwork_mode:\thost\tenvironment: MESOS_MASTER:\tzk://127.0.0.1:2181/mesos\tMESOS_WORK_DIR:\t/tmp MESOS_CONTAINERIZERS:\tdocker\tMESOS_HOSTNAME: 192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\tmarathon: image:\tmesosphere/marathon:v1.1.2\tnetwork_mode:\thost\tenvironment: MARATHON_MASTER:\tzk://127.0.0.1:2181/mesos\tdepends_on:\t- zookeeper\n\nWith\tthat\tsaid,\twe\tare\tnow\tready\tto\tvalidate\twhether\twe\thave\tMarathon\n\ninstalled\ton\tour\tcluster.\tStop\tand\tremove\tany\tcontainers\tthat\tare\talready\trunning. Now\texecute\tthe\tfollowing\tcommand\ton\tyour\tconsole\tto\tstart\tthe\tMesos\tcluster: docker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nThis\ttime,\tyou\twill\tsee\tsome\tadditional\tlogs\tfrom\tMarathon:\n\nNow\tlet's\tverify\twhether\tMarathon\tis\tregistered\tas\ta\tMesos\tframework\ton\tour cluster.\tTo\tdo\tthat,\topen\tthe\tMesos\tweb\tUI\tfrom\tyour\tbrowser\tand\tclick\ton\tthe Frameworks\ttab.\tYou\tshould\tnow\tsee\ta\tnew\tentry\tin\tthe\tActive\tFrameworks grid\tfor\tMarathon.\tYou\tcan\tsee\tthe\tname\tof\tthe\tframework\tin\tthe\tName\tcolumn:\n\nThat's\tit!\tYou\thave\tsuccessfully\tcreated\tyour\tfirst\tMesos\tcluster\tusing\tDocker. Now,\tit\tis\ttime\tto\tplay\twith\tthis\tcluster\tby\tspinning\toff\tsome\tMarathon\ttasks.\n\nUnderstanding\tthe\tMesos\tand Marathon\tinterface\n\nNow\tthat\twe\thave\ta\tfully\tfunctional\tMesos\tcluster\twith\tthe\tMarathon framework,\twe\tare\tready\tto\tspin\toff\tnew\ttasks\t(or\tDocker\tcontainers)\tto Marathon.\tBefore\twe\tdo\tthat,\tit\tis\thighly\timportant\tthat\twe\tunderstand\tthe Mesos\tand\tMarathon\tweb\tinterface.\n\nGetting\tready\n\nWe\talready\tknow\tthat\tthe\tMesos\tweb\tUI\tis\tlocated\tat\tport\t5050.\tTo\taccess\tthe web\tUI,\topen\thttp://192.168.99.100:5050\tin\ta\tweb\tbrowser.\tSimilarly, Marathon\thas\ta\tsophisticated\tweb\tinterface\tlocated\tat\tport\t8080.\tTo\taccess\tthe Marathon\tweb\tUI,\topen\thttp://192.168.99.100:8080\tin\tanother\ttab\tof\tyour web\tbrowser.\n\nHow\tto\tdo\tit...\n\nFirst,\tlet's\ttry\tto\tget\tfamiliar\twith\tthe\tMesos\tinterface.\n\nThe\tMesos\tinterface\n\nThere\tare\tfour\ttabs\tin\tthe\tMesos\tweb\tUI.\tLet's\tgo\tone\tby\tone.\tThe\tfirst\tone\tis\tthe Mesos\thome\tpage.\n\nThe\tMesos\thome\tpage\n\nThis\tis\twhere\tyou\tactually\tget\tto\tsee\tmost\tof\tthe\tinformation\tabout\tyour\ttasks. Let's\tstart\twith\tthe\tleft-hand\tside\tmenu\tpane.\tThe\tfirst\tsection\tof\tthe\tpane\tis\tthe cluster\tinformation.\tIt\thas\tinformation\tsuch\tas\tcluster\tname,\tmaster\tURL, version,\twhen\tthis\tversion\twas\tbuilt,\twhen\tthis\tmaster\twas\tstarted,\tand\twhen\tthis master\twas\telected\tas\tleader.\tThese\tare\tthe\toptions\tthat\tare\tavailable\tin\tthis particular\tversion\tof\tMesos.\tThis\tlist\tis\tprone\tto\tchange\tif\tyou\tuse\tany\tother version\tof\tMesos.\tIt\twill\tlook\tsomething\tlike\tthis:\n\nThe\tcluster\tname\tis\t(Unnamed)\tbecause\twe\tdid\tnot\tpass\tthe\tMESOS_CLUSTER environment\tvariable\tto\tthe\tmaster.\tIf\twe\thad\tset\tthat\tenvironment\tvariable\tin the\tDocker\tCompose\tfile\tfor\tthe\tmaster,\tthen\tthat\tcluster\tname\twould\thave\tbeen displayed\there.\tIn\tproduction\tsystems,\tthis\tis\tvery\timportant\twhen\tyou\thave\n\nmultiple\tmasters.\tWe\thave\tnot\tdone\tthat\tin\torder\tto\tmake\tthe\tcluster configuration\tsimple.\n\nRight\tfollowing\tthe\tCluster\tsection,\tyou\twill\tsee\ta\thyperlink\tcalled\tLOG.\tThis\tis used\tto\tlook\tat\tthe\tlogs\tof\tthe\tmaster.\tIf\tyou\tclick\ton\tthis,\tyou\twill\tsee\tthe following\terror:\n\nThis\tis\tbecause\twe\thave\tnot\tset\tthe\tconfig\tproperty\tthat\tspecifies\twhere\twe would\tlike\tthe\tlog\tfiles\tto\tbe\tcreated.\n\nTo\tconfigure\tthat,\twe\thave\tto\tset\tthe\tMESOS_LOG_DIR\tenvironment\tvariable\tin\tthe Docker\tCompose\tfile\tfor\tthe\tMesos\tmaster.\n\nAgents\n\nThe\tnext\tsection\tis\tAgents.\tMesos\tstarted\tadopting\tthe\tterm\t\"agents\"\tfor\tslaves recently.\tWherever\tyou\tsee\tthe\tterm\tagents\thenceforth,\tkeep\tin\tmind\tthat\tthey are\tsynonymous\twith\tslaves.\tThis\tsection\tis\twhere\tyou\twill\tsee\tthe\tnumber\tof slaves\tthat\tare\tactivated\tand\tthe\tnumber\tof\tslaves\tthat\tare\tdeactivated.\tIt\twill look\tsomething\tlike\tthis:\n\nTasks\n\nThis\tnext\tsection,\tTasks,\tshows\tthe\tnumber\tof\ttasks\tgrouped\tby\ttheir\tstatuses\ton all\tslaves.\tMesos\thas\tbeen\tadding\tnew\tstatuses\trecently\tto\tprovide\ta\tmore granular\tunderstanding\tof\twhere\teach\ttask\tis.\tAt\tthe\ttime\tof\twriting\tthis,\tthere are\tnine\tstatuses:\tStaging,\tStarting,\tRunning,\tKilling,\tFinished,\tKilled, Failed,\tLost,\tOrphan.\tIn\tyour\tMesos\tweb\tUI,\tthis\tlooks\tsomething\tlike\tthe following:\n\nResources\n\nThe\tnext\tsection\tis\tthe\tResources\tsection,\twhich\tshows\tthe\tresource\tutilization by\ttask\tand\tresource\tavailability\tin\tthe\tslaves.\tResources\tinclude\tCPUs,\tGPUs, memory,\tand\tdisk\tspace.\tLet's\ttalk\tabout\tgraphics\tprocessing\tunit\t(GPU)\tas\tit is\tnew\tto\tthis\tlist.\tNow\tthat\tMesos\tis\tbeing\tused\tfor\tmore\tadvanced\tuse\tcases such\tas\tgraphics\tand\tvideo\tprocessing,\tMesos\tand\tNvidia\thave\tcome\ttogether\tto include\tGPUs\tin\tMesos.\tThis\tsection\twill\tlook\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee\tin\tthe\tpreceding\tpicture,\tnone\tof\tthe\tresources\tare\tbeing\tused\tor offered\tbecause\twe\thave\tnot\trun\tany\ttasks\ton\tthe\tcluster\tyet.\tMoving\ton\tto\tthe main\tsection\tof\tthe\thome\tpage\tis\tthe\tTasks\tbreakout.\tBy\tdefault,\tyou\thave\tthree grids:\tActive\tTasks,\tCompleted\tTasks,\tand\tOrphan\tTasks.\n\nTask\ttypes\n\nActive\ttasks\tare\ttasks\tthat\tare\tcurrently\texecuting.\tCompleted\ttasks\tare\ttasks\tthat have\tfinished\texecution\t(either\tcompleted\tsuccessfully\tor\tfailed\tor\tkilled). Orphan\ttasks\tare\ttasks\tthat\tare\torphaned\tafter\ta\tmaster\tfailure\twhen\tthe framework\tfails\tto\treregister.\tAs\twe\tdo\tnot\thave\tany\ttasks\tnow,\tthis\tsection\tis empty.\tBut\tideally,\tyou\twill\tsee\tthat\tfor\teach\ttask,\tthere\tis\ta\tnew\tentry\tin\tone\tof these\tgrids:\n\nFrameworks\n\nThe\tsecond\ttab\tis\tthe\tFrameworks\ttab.\tThe\tFrameworks\ttab\tmainly\tshows\tthe list\tof\tactive,\tcompleted,\tand\tinactive\tframeworks\tin\tthe\tcluster.\tThe\tframeworks can\tbe\tanything,\tsuch\tas\tSpark,\tCassandra,\tAurora,\tMarathon,\tand\tChronos:\n\nAgents\n\nThe\tAgents\ttab\tusually\tdisplays\tthe\tlist\tof\tall\tslaves\tregistered\tin\tthe\tcluster.\tIn our\tcluster,\twe\thave\tonly\tone\tslave\tregistered.\tYou\tshould\tsee\tsomething\tlike this:\n\nOffers\n\nThe\tlast\ttab\tis\tthe\tOffers\ttab,\twhich\tlists\tdown\tall\tthe\toffers\tthat\tare\tcurrently open\tfor\ta\tslave\tto\tbe\tpicked\tup:\n\nThat's\tpretty\tmuch\teverything\ton\tthe\tMesos\tweb\tinterface.\tThough\tyou\twill\tnot be\tusing\tthis\tinterface\ta\tlot,\tit\tis\tstill\ta\tgood\tidea\tto\tbecome\tfamiliar\twith\tthis interface\tso\tthat\tyou\tcan\tuse\tit\tfor\tdebugging.\tDebugging\tsituations\tcan\thappen when\tone\tof\tyour\ttasks\tkeeps\trestarting\tor\twhen\tyou\twould\tlike\tto\tknow whether\tyou\thave\tenough\tresources\tto\tspin\toff\tmore\ttasks.\n\nThe\tMarathon\tweb\tUI\n\nNow\tlet's\topen\tup\tthe\tMarathon\tweb\tUI\tand\tunderstand\tthe\tmain\tscreen.\tAs\twe still\thaven't\tlearned\thow\tto\tdeploy\tDocker\tcontainers\tin\tMarathon,\twe\twill\tjust understand\tthe\tbasic\tsections\tof\tthe\tMarathon\tweb\tUI.\tWe\twill\tlearn\tabout\tthe other\tscreens\tas\twe\tdeploy\tour\tapplication.\n\nOpen\tthe\ttab\tthat\tyou\talready\thad\tfor\tMarathon.\tIf\tyou\tclosed\tit\tby\tmistake,\tuse this\tURL\tto\topen\tit:\thttp://192.168.99.100:8080:\n\nAs\tyou\tcan\tsee,\tit\tis\ta\tvery\tsimple\tinterface\twith\tsome\tuseful\tfilters\ton\tthe\tleft- hand\tside\tmenu.\tThe\tfilters\tare\tbased\tmainly\ton\tthe\tstatus,\thealth,\tand\tvolumes. The\tCreate\tApplication\tbutton\tis\tused\tto\tdeploy\tyour\tDocker\tcontainer\ton\tthe Mesos\tcluster\tusing\tMarathon.\tRight\tnow,\twe\tdo\tnot\thave\tany\tnew\tapplications already\tdeployed.\tIf\twe\thad\tone,\tit\twould\tbe\tdisplayed\tin\tthe\tApplications section\tof\tthe\tpage.\tYou\tcan\talso\tcreate\tgroups\tto\tgroup\tyour\tapplications.\n\nWith\tthat\tsaid,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tWe\twill\tget\tto\tplay\twith\tthe Marathon\tinterface\tin\tthe\trest\tof\tthis\tchapter.\n\nDeploying\tyour\tmicroservice\tto Mesos\tusing\tMarathon\n\nNow\tthat\twe\thave\ta\tfully\tfunctional\tMesos\tcluster\twith\tthe\tMarathon framework,\twe\tare\tready\tto\tspin\toff\tnew\ttasks\t(or\tDocker\tcontainers)\ton Marathon.\tIn\tthis\trecipe,\twe\twill\tdeploy\tour\tDockerized\tgeolocation microservice\ton\tMarathon.\n\nGetting\tready\n\nBefore\tyou\tstart,\tmake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tYou\tcan\tdo this\tby\texecuting\tthe\tdocker\tps\t-a\tcommand.\tYou\tshould\tsee\tfour\tcontainers running:\tMesos\tmaster,\tMesos\tslave,\tMarathon,\tand\tZookeeper:\n\nSometimes,\tit\tis\tpossible\tthat\teither\tthe\tMesos\tmaster\tor\tslave,\tor\teven\tthe Marathon\tcontainer,\tmight\tgo\tdown.\tThis\tusually\thappens\twhen\tit\truns\tout\tof resources\tor\tprobably\twhen\tyou\trestart\tyour\tcomputer\tand\tthey\ttry\tto\tcome\tback up,\tbut\tthey\tmight\tnot\tbe\table\tto\torchestrate\tproperly.\tIn\tthose\tcases,\tmake\tsure you\tstop\tthe\twhole\tcluster\tand\tperform\ta\tclean\tstart.\tYou\tcan\tdo\tthat\tby\trunning the\tfollowing\tcommand:\tdocker\tstop\t$(docker\tps\t-a\t-q)\t&&\tdocker\trm $(docker\tps\t-a\t-q)\t&&\tdocker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nThe\tcommand\tuses\t&&\tto\tcombine\tthree\tdifferent\tcommands.\tThe\tfirst\tone\tis used\tto\tstop\tall\trunning\tand\tstopped\tcontainers.\tThe\tsecond\tone\tremoves\tall\tthe containers\tthat\twere\tstopped\tby\tthe\tprevious\tcommand\t(including\tthe\tones\tthat were\tpreviously\tstopped,\tif\tany),\tand\tthe\tthird\tcommand\tstarts\tthe\tcluster\tback up.\n\nNow\tthat\tyour\tcluster\tis\tup\tand\trunning,\topen\ta\tbrowser\tand\tnavigate\tto\tthe Marathon\tweb\tinterface\tat\thttp://192.168.99.100:8080.\n\nHow\tto\tdo\tit... 1.\t Let's\tstart\tby\tunderstanding\tthe\tMarathon\tinterface.\tMarathon's\tuser\n\ninterface\thas\timproved\ta\tlot\tlately\tand\tis\tvery\teasy\tto\tuse.\tClick\ton\tthe Create\tApplication\tbutton.\tYou\tshould\tsee\ta\tmodal\tsimilar\tto\tthis:\n\nAs\tyou\tcan\tsee,\tthere\tare\tseveral\tsections\ton\tthe\tleft-hand\tside,\tsuch\tas\tGeneral, Docker\tContainer,\tPorts,\tEnvironmentVariables,\tLabels,\tHealth\tChecks, and\tVolumes.\n\nLet's\tstart\twith\tthe\tGeneral\tsection.\tThe\tfirst\tfield\tthat\tis\trequired\tin\tthis section\tis\tthe\tID\tfield.\tThe\tvalue\tof\tID\tuniquely\tidentifies\tthe\tapplication\tin Marathon.\tIn\tour\tcase,\tas\twe\tare\tdeploying\tthe\tgeolocation\tapplication,\twe\tcan\n\nprobably\tuse\tgeolocation\tas\tthe\tID\tof\tour\tapplication.\tThe\tother\tfields\tin\tthis modal\tthat\twe\tshould\tcare\tabout\tnow\tare\tCPUs,\tMemory,\tand\tDisk\tSpace. The\tdefault\tCPU\tvalue\tof\t1\tshould\tbe\tmore\tthan\tenough\tfor\tour application.\tMesos'\tCPUs\tparameter\tis\ta\tlittle\ttricky\tto\tunderstand.\tYou\tcan even\tassign\tvalues\tsuch\tas\t0.1\tor\t0.25\tto\tthe\tCPUs\tfield.\tIt\tmainly\thelps you\tidentify\thow\tmany\tresources\tare\tleft\tin\tyour\tcluster\trather\tthan\tlimiting access\tto\tthe\tCPU\titself.\tEven\tthough\tyou\tset\tthe\tvalue\tof\tCPUs\tto\t1,\tyour application\twill\thave\taccess\tto\tall\tthe\tother\tCPUs\tin\tyour\tslave. The\tMemory\tfield\tis\tset\tat\t128\tMB\tby\tdefault.\tFor\tour\tapplication,\twe could\tgo\ta\tlittle\thigher\tand\tassign\tit\t512\tMB.\tIn\tproduction\tscenarios,\t512 MB\tmight\tnot\tbe\tsufficient,\tand\tyou\tmight\thave\tto\tgo\twith\ta\tminimum\tof\t4 GB\tof\tmemory\tbased\ton\tyour\tapplication's\tusage.\tIf,\tfor\tsome\treason,\tyou are\tforced\tto\tallocate\tmore\tthan\t4\tGB\tof\tmemory\tfor\ta\tsimilar\tapplication, it\tis\ta\tsignal\tthat\tthere\tcould\teither\tbe\tan\tarchitectural\trefactor\tthat\tcould reduce\tyour\tmemory\tallocation,\tor\tyour\tapplication\tis\tbecoming\tmore monolithic,\tthereby\tdefeating\tthe\tpurpose\tof\tbuilding\ta\tmicroservice.\tHere, the\t4\tGB\tlimit\twas\tpicked\tas\tan\texample\tthat\tis\tused\tfor\tthe\tgeolocation application,\tbut\tthe\tpoint\tis\tto\tmake\tsure\tyou\tdon't\tbuild\tan\tapplication\tthat is\tmonolithic\tor\tfollows\tbad\tarchitectural\tdesign. The\tDisk\tSpace\tfield\tis\talso\treally\timportant\twhen\tyou\tcreate\ta\tnew application\tin\tMarathon.\tThough\tit\tmight\tnot\tmatter\ta\tlot\tin\tour\tcase,\tit becomes\tsuper\timportant\twhen\tyou\tare\tdeploying\ta\tcontainer\tthat\tstores information\tin\tthe\tfilesystem.\tFor\texample,\tif\tyou\tare\trunning\tKafka\tor\ta database\tas\ta\tcontainer,\tyou\tdefinitely\tdon't\twant\tto\tallocate\tit\t1\tGB\tof\tdisk space.\tIt\tis\tdefinitely\tgoing\tto\trun\tout\tof\tdisk\tspace\tsooner\tor\tlater.\tFor\tthe geolocation\tapplication,\tas\tit\tis\tnot\tgoing\tto\twrite\tanything\tto\tthe filesystem,\tlet's\tallocate\tit\t1\tGB\tof\tdisk\tspace.\n\nTo\tsummarize,\tthese\tare\tthe\tfields\tand\ttheir\trespective\tvalues:\n\nID:\tgeolocation CPUs:\t1 Memory:\t512 Disk\tSpace:\t1024 Instances:\t1 Command:\tLeave\tthis\tfield\tempty\n\nNow,\tlet's\tmove\ton\tto\tthe\timportant\tsection:\tthe\tDocker\tcontainer\tsection.\tThe Docker\tcontainer\tsection\tis\twhere\twe\tget\tto\tprovide\tthe\tcontainer\tinformation\tto Marathon.\tThere\tare\tfive\timportant\tfields\tin\tthis\tsection:\n\nThe\tImage\tfield\ttells\tMarathon,\tthe\tname\tand\ttag\tof\tthe\tDocker\timage\tthat it\thas\tto\tpull\tfrom\tDocker\tHub.\tBy\tdefault,\tMarathon\ttries\tto\tpull\tthe\timage from\tthe\tpublic\tDocker\tHub.\tBut\tif\tyou\thave\tyour\town\tprivate\tDocker Hub,\tyou\thave\tto\tmake\ta\tfew\tchanges\tto\tyour\tdeployment\tto\tinstruct Marathon\tto\tauthenticate\tand\tget\tthe\timage\tfrom\tyour\tprivate\trepository.\tIn our\tcase,\twe\twill\tuse\tthe\tpublic\trepository,\tand\tthe\tname\tof\tour\timage\tis vikrammurugesan/geolocation.\tPlease\tkeep\tin\tmind\tthat\tthis\tis\tmy Docker\tHub\taccount,\tand\tyou\tshould\tbe\tusing\tthe\timage\tin\tyour\taccount. We\tdon't\thave\tto\tprovide\tthe\tlatest\ttag\tas\tMarathon\tuses\tit\tas\tthe\tdefault tag\tif\tyou\tdon't\tprovide\tone. The\tNetwork\tmode\tcan\teither\tbe\tBridged\tor\tHost.\tFor\tnow,\twe\twill\tuse Bridged\tmode.\tWe\twill\tlearn\tmore\tabout\tthe\tbridged\tnetworking\tmode\tin later\trecipes\tin\tthis\tchapter.\tThe\tForce\tpull\timage\ton\tevery\tlaunch\toption is\tpretty\tself-explanatory.\tYou\tdon't\thave\tto\tcheck\tthis\toption.\tThe\tExtend runtime\tprivileges\toption\tlets\tyou\trun\tthe\tcontainer\tin\tprivileged\tmode. You\tcan\tuse\tthis\toption\tif\tyou\tare\tgoing\tto\trun\tDocker\tinside\tthis\tDocker container.\tFor\tnow,\twe\twill\tnot\tneed\tit.\n\nNote\n\nFor\tmore\tinformation\ton\tprivileged\tcontainers,\ttake\ta\tlook\tat\tthis\tpage: https://docs.docker.com/engine/reference/run/#/runtime-privilege-and- linux-capabilities\n\nThe\tParameters\tare\tnothing\tbut\tDocker\tenvironment\tvariables.\tIf your\tapplication\tneeds\tenvironment\tvariables,\tyou\tcan\tlist\tthem\there. For\tnow,\tthe\tconfigurations\twe\thave\tdone\tso\tfar\twill\tlet\tus\tstart\tthe application\ton\tMarathon.\tWe\twill\tlook\tat\tother\tsections\tin\tlater\trecipes in\tthis\tchapter.\tWith\tthat\tsaid,\tthe\tDocker\tContainer\tsection\tshould look\tsomething\tlike\tthis:\n\nNow\tthat\tyou\thave\teverything\tset\tup\tright,\tclick\ton\tthe\tCreate\tApplication button.\tYou\tshould\tsee\tthat\tMarathon\tis\ttrying\tto\tdeploy\tour\tmicroservice.\tYou can\tconfirm\tthis\tby\tlooking\tat\tthe\tstatus\tof\tyour\tapplication.\tIt\tshould\tshow\tup as\tDeploying.\tDuring\tthis\tstep,\tthe\tslave\twill\ttry\tto\tpull\tthe\timage\tfrom\tDocker Hub\tand\tstart\tthe\tcontainer\twith\tthe\tconfigurations\twe\tprovided\tin\tthe\tCreate Application\tmodal:\n\nA\tfew\tseconds\tlater,\tyou\tshould\tsee\tthat\tthe\tapplication's\tstatus\tchanges\tfrom\n\nDeploying\tto\tRunning,\tindicating\tthat\tit\tis\tready\tto\tbe\tconsumed:\n\nWithout\twasting\tany\tmore\ttime,\tlet's\ttest\tour\tservice.\tBefore\tthat,\thow\tdo\tyou know\twhich\thost\tyour\tapplication\tis\trunning\ton?\tTo\tfind\tout,\tyou\twill\tneed\tthe IP\tof\tyour\tMesos\tslave.\tMarathon\tmakes\tit\teasy\tfor\tyou\tto\tfind\tthe\thost\tand\tport your\tapplication\tis\trunning\ton.\tFrom\tMarathon's\thome\tpage,\tclick\ton\tyour application\tname.\tIt\tshould\ttake\tyou\tto\tthe\tapplication\tdetails\tpage\tfor\tthe geolocation\tapplication:\n\nThere\tare\tlots\tof\tthings\ton\tthis\tpage.\tBut\tlet's\tjust\tfocus\ton\tthe\tInstances\tgrid.\n\nRight\tfollowing\tthe\tID\tof\tthe\tapplication\tinstance,\twe\tcan\tsee\ta\t<hostname>: <port>\tcombination.\tThe\thostname\tis\tsomething\tyou\tare\talready\tfamiliar\twith. That\tis\tthe\tIP\tof\tour\tDocker\thost\t(VirtualBox\tVM).\tThe\tport\tis\ta\trandom\tport that\tMarathon\thas\telected\tto\texpose\tour\tapplication\ton.\n\nExecute\ta\tcurl\tcommand\tto\tGET\tall\tgeolocations\tsaved\tin\tthe\tapplication. Since\tthis\tis\ta\tbrand\tnew\tdeployment,\tyou\tshould\tget\tan\tempty\tarray\tback, indicating\tthere\tare\tno\tgeolocations\tsaved\tin\tthe\tsystem:\tcurl http://192.168.99.100:31756/geolocation\n\nThe\toutput\tshould\tbe\tsomething\tlike\tthis:\tcurl:\t(7)\tFailed\tto\tconnect\tto\n\n192.168.99.100\tport\t31756:\tConnection\trefused\n\nWhat\tjust\thappened\there?\tWe\tare\tnot\table\tto\tconnect\tto\tour\tservice\ton\thost 192.168.99.100\tand\tport\t31756.\tWith\tthat\tsaid,\twe\tnow\tclearly\tknow\tthat\tthe\n\nport\tnumber\twe\thave\tis\tnot\tright.\tThere\tis\tdefinitely\ta\tway\tto\tconfigure\tour application\tin\tsuch\ta\tway\tthat\tit\texposes\tthe\tAPI\ton\tthe\tright\tport.\tWe\twill\tlook at\tthat\tin\tour\tnext\trecipe.\n\nConfiguring\tports\tin\tMarathon\n\nIn\tthe\tprevious\trecipe,\twe\tsaw\thow\tto\tdeploy\tour\tmicroservice\tin\tMarathon.\tWe were\table\tto\tdeploy\tthe\tgeolocation\tmicroservice\ton\tMarathon,\tbut\tit\twas\tnot really\tuseful\tbecause\twe\thaven't\tfigured\tout\thow\tto\ttalk\tto\tour\tmicroservice\tvia its\tRESTful\tAPI.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconfigure\tour\tapplication's service\tand\thost\tports\tin\tMarathon\tto\texpose\tthe\tRESTful\tAPIs.\n\nGetting\tready\n\nIf\tyou\tdon't\thave\tyour\tcluster\tup\tand\trunning,\tbring\tit\tback\tup.\tAlso\tmake\tsure you\thave\tthe\tgeolocation\tapplication\tup\tand\trunning\tin\tyour\tcluster.\tYou\tcan verify\tthat\tfrom\tthe\tMarathon\tweb\tinterface.\n\nHow\tto\tdo\tit... 1.\t From\tthe\tInstances\tgrid,\tclick\ton\tthe\tapplication\tinstance\tand\tgo\tto\tthe\n\nConfiguration\ttab.\tThe\tConfiguration\ttab\tis\tused\tto\tshow\tthe\tMarathon configurations\tfor\tyour\tapplication.\tYou\twill\tsee\tseveral\tconfigurations, such\tas\tthe\tmemory,\tCPU,\tdisk\tspace,\tDocker\tcontainer,\tand\thealth\tchecks:\n\n2.\t In\tthe\tContainer\tsection,\tyou\twill\tsee\tJSON\tcode\tsimilar\tto\tthis:\n\n{ \t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\", \t\t\t\t\t\t\t\t\t\t\"volumes\":\t[], \t\t\t\t\t\t\t\t\t\t\"docker\":\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesan/geolocation\", \t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\", \t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[ \t\t\t\t\t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t10000, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",\n\n\"protocol\":\t\"tcp\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{} \t\t\t\t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t\t\t], \t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse, \t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[], \t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nThe\tone\tthat\twe\tare\treally\tconcerned\tabout\tis\tportMappings\tin\tthe Container\tsection.\tIn\tsome\tversions\tof\tMarathon,\tthe\tportMappings\twill\tbe listed\tunder\tPort\tDefinitions\tproperty.\tSo\tdon't\tpanic\tif\tyour\tinterface looks\tdifferent.\tThe\tinstructions\tin\tthis\trecipe\tare\tstill\tgoing\tto\tbe\tthe\tsame. You\tcan\tsee\tthat\tthe\tcontainerPort\tis\tmarked\tas\t0.\tIdeally,\twe\tshould expect\t8080\tthere,\tas\tthat's\twhere\tour\tAPI\tis\tlistening.\n\nThe\thostPort\tis\tthe\tport\ton\tthe\tDocker\thost\tto\twhich\tMarathon\twill\tbind this\tcontainerPort.\tThe\thostPort\tcan\talso\ttake\tthe\tvalue\t0,\tinstructing Marathon\tto\tchoose\ta\trandom\tport\tnumber.\tIn\tmost\tcases,\tthe\thostPort\tis the\tport\tnumber\ton\tthe\tMesos\tslave\tthat\tis\trunning\tthis\tcontainer.\tAgain, identifying\tthe\tslave\tIP\ton\ta\tcluster\twith\thundreds\tof\tslaves\tis\tnot\tideal.\n\nThat's\twhere\tthe\tservicePort\tcomes\tto\tthe\trescue.\tThe\tservicePort\tis currently\tset\tto\t10000\tby\tdefault.\tIn\tproduction\tenvironments,\tthe servicePort\tis\tmanually\tset\tto\ta\twell-known\tvalue,\tsuch\tas\t8899\tor\t8181. Once\tyou\tset\tthe\tservicePort\tto\ta\twell-known\tvalue\tthat\tyou\tcan remember,\tyou\tcan\tthen\tuse\tservice\tdiscovery\ttools\tsuch\tas\tConsul\tor\ttools such\tas\tHAProxy\tto\tperform\ta\tforwarding\tfrom\tthe\thostPort\tto\tthe servicePort.\tMarathon\tpreviously\tprovided\ta\tscript\tcalled\thaproxy- marathon-bridge\tto\tdo\texactly\tthis.\tIt\tcreates\ta\tHAProxy\tconfig\tfile\tthat can\tbe\tused\twith\tHAProxy\tto\tmake\tthis\tbalancing\thappen.\tAt\tthe\ttime\tof writing\tthis,\tthis\tscript\thas\tbeen\tdeprecated\tin\tfavor\tof\tthe\tMarathon\tLoad Balancer\t(LB).\tWe\twill\tlearn\tmore\tabout\tMarathon\tLB\tin\tChapter\t5, Service\tDiscovery\tand\tLoad\tBalancing\tMicroservices.\tAfter\tyou\tenable service\tdiscovery\tand\tconfigure\tMarathon,\tyou\twill\tbe\table\tto\taccess\tyour service\tfrom\tmesosMasterHostName:servicePort.\tIf\tyou\thave\tmultiple masters,\tit\tis\trecommended\tthat\tyou\thave\ta\tcommon\thostname\tthat\talways points\tto\tthe\tactive\tmaster.\n\nThe\tprotocol\tcan\tbe\tUDP\tor\tTCP.\tYou\twon't\thave\tto\tuse\tUDP\tin\tmost\n\nThe\tprotocol\tcan\tbe\tUDP\tor\tTCP.\tYou\twon't\thave\tto\tuse\tUDP\tin\tmost cases.\tWe\twill\tstick\tto\tTCP\tthroughout\tthis\tbook.\n\n3.\t Now\tlet's\tmodify\tthe\tapplication's\tMarathon\tconfiguration\tto\tinclude\tthe hostPort\tand\tservicePort.\tIn\torder\tto\tdo\tthat,\tclick\ton\tthe\tEdit\tbutton\ton the\tConfiguration\tscreen,\tand\tgo\tto\tthe\tPorts\tsection.\tEnter\tthe\tContainer Port\tvalue\tas\t8080.\tLeave\tthe\tprotocol\tvalue\tas\ttcp:\n\n4.\t Now,\tif\tyou\tare\twondering\twhere\thostPort\tand\tservicePort\tare, Marathon\tleaves\tthose\tas\tadvanced\tconfigurations,\tand\tthe\tonly\tway\tto configure\tthe\tadvanced\tconfigurations\tis\tusing\tJSON\tmode.\tIn\torder\tto\tuse JSON\tmode,\tclick\ton\tthe\ttoggle\tbutton\tin\tthe\ttop\tright\tof\tthe\tmodal\tthat says\tJSON\tMode.\tYou\tshould\tsee\tthe\tJSON\tthat\tMarathon\tuses\tto\tpost\tto its\tREST\tservice,\twhich\tin\tturn\tconverts\tit\tinto\ta\tMesos\ttask\trequest.\tIn\tthe\n\nportMappings\tsection,\tyou\tshould\tnow\tsee\tthat\tcontainerPort\tis populated\twith\tthe\tvalue\t8080.\tGo\tahead\tand\tadd\tthese\ttwo\tfields\tto\tthis port\tmapping\tobject:\n\n\"hostPort\":\t0, \t\t\t\t\t\t\t\t\"servicePort\":\t8899\n\nThis\twill\ttell\tMarathon\tto\tuse\tany\trandom\tport\tas\tthe\thost\tport\tand\tuse\t8899 as\tthe\tservice.\tLike\twe\tsaw\tearlier,\tit\tis\tour\tresponsibility\tto\tperform\ta\tport forwarding\tfrom\tthe\thost\tport\tto\tthe\tservice\tport\tusing\ttools\tsuch\tas HAProxy\tor\tMarathon\tLB,\twhich\twe\twill\tbe\tlooking\tat\tin\tlater\tchapters. For\tnow,\twhat\tthis\twill\tdo\tis\texpose\tthe\tRESTful\tservices\tin\tthe geolocation\tapplication\ton\tany\trandom\tport\ton\tthe\thost\tmachine.\tIn\tour case,\tthe\thost\tmachine\tis\tthe\tVirtual\tBox\tVM\tat\t192.168.99.100.\n\nWith\tthat\tsaid,\tclick\ton\tChange\tand\tdeploy\tconfiguration.\tUsually,\tit takes\ta\tfew\tseconds\tto\tfinish\tthe\tdeployment.\tYou\tcan\tlook\tat\tthe\tpending deployments\tfrom\tthe\tDeployments\ttab\tof\tMarathon.\tYou\tcan\tmake\tsure that\tyour\tconfigurations\tare\tupdated\tby\tlooking\tat\tthe\tDocker\tcontainer\n\nsetting\tin\tthe\tConfiguration\ttab.\tIt\tshould\tinclude\tthe\tservicePort\tand hostPort:\n\n{ \t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\", \t\t\t\t\t\t\t\t\t\t\"volumes\":\t[], \t\t\t\t\t\t\t\t\t\t\"docker\":\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesan/geolocation\", \t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\", \t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[ \t\t\t\t\t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{} \t\t\t\t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t\t\t\t], \t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse, \t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[], \t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\n5.\t Now,\tlet's\ttest\tour\tservice\tusing\tthe\tcurl\tcommand.\tBefore\tthat,\tyou\thave to\tknow\twhat\thost\tport\tyour\tservice\tis\trunning\ton.\tYou\tcan\tget\tthat\tfrom the\tInstances\tsection:\n\nAs\tyou\tcan\tsee,\tit\tis\trunning\ton\tport\t31434.\tYours\tmight\tbe\tdifferent\tas\tit gets\trandomly\tgenerated.\tSo\tplease\tmake\tsure\tyou\tuse\tyour\tport\tnumber\tin the\tnext\tcURL\tcommand.\n\n6.\t Now,\topen\ta\tnew\tterminal\tsession\tand\tissue\tthe\tfollowing\tcurl\tcommand:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31434/geolocation\n\n7.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t}\n\nNote\n\nConfiguring\tports\tin\tMarathon\tis\ttrickier\tthan\tyou\tthink.\tYou\thave\tto\n\nunderstand\tthe\tusage\tof\tservicePorts,\thostPorts,\tand\trequirePorts\tas well\tas\tthe\tvarious\tnetworking\tmodes,\tsuch\tas\tHOST\tand\tBRIDGE.\tIt\tis strongly\trecommended\tyou\ttake\ta\tlook\tat https://mesosphere.github.io/marathon/docs/ports.html\tbefore\tyou\tstart playing\twith\tthem\ton\tyour\tproduction\tcluster.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tYou\tnow\tknow\thow\tto\tdeploy\tyour\town microservice\ton\ta\tMesos\tcluster\tusing\tMarathon.\n\nConfiguring\tvolumes\tin\tMarathon\n\nSo\tfar,\twe\thave\tlearned\thow\tto\tdeploy\tour\tmicroservice\ton\ta\tMesos\tcluster using\tMarathon\tand\tconfigure\tports\tusing\tMarathon's\tweb\tUI.\tOne\tof\tthe\tmost common\tthings\tyou\twould\twant\tto\tdo\tis\tbe\table\tto\tmap\tvolumes\tin\tyour container\tto\tthe\thost\tmachine.\tThough\tthis\tis\tnot\tsomething\tthat\tis\tsuper important\tto\tour\tgeolocation\tapplication,\twhen\tyou\tdeal\twith\tapplications\tthat save\tfiles\ton\tthe\tfilesystem,\tthis\tis\tcritical.\tYou\twouldn't\twant\tto\tlose\tyour\tdata, would\tyou?\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tmap\tvolumes\tusing\tMarathon.\n\nGetting\tready\n\nIn\torder\tto\tlearn\thow\tto\tconfigure\tvolume\tmapping\tin\tMarathon,\tlet's\tmake\tour application\tsave\tsomething\tto\tthe\tfilesystem.\tLet's\tsay\tthe\tgeolocation application\twould\tlike\tto\tstore\tthe\tgeolocation\tJSON\tto\tthe\tfilesystem\tas\tit receives\tthem.\tIt\tmight\tnot\tbe\ta\tgreat\tdesign,\tbut\tfor\tour\tunderstanding,\tlet's make\tour\tgeolocation\tapplication\tstore\tthe\tgeolocation\tJSON\tfiles\tin\ta\tdedicated data\tdirectory\tas\tand\twhen\tthey\tarrive.\tIn\torder\tto\tdo\tso,\tlet's\topen\tup\tour\tSTS IDE.\n\nHow\tto\tdo\tit...\n\nIn\torder\tto\tcreate\tthis\tdata\tdirectory,\twe\thave\tto\tdo\ttwo\tthings:\n\nCreate\tthe\tdirectory\ton\tthe\thost\tmachine\tand\tmake\tit\taccessible Make\tthe\tGeoLocationRepository.java\tfile\twrite\tany\tnew\tgeolocation JSON\tto\tthe\tdata\tdirectory\n\nBefore\twe\tcan\timplement\tthis\tin\tthe\tcontainer,\tlet's\ttry\tto\tdo\tit\tlocally:\n\n1.\t Issue\tthe\tfollowing\ttwo\tcommands\ton\tyour\tterminal:\n\nmkdir\t-p\toptpackt/geolocation/data chmod\t-R\t777\t/opt\n\nUse\tsudo\tif\tneeded.\tThe\tmkdir\tcommand\tcreates\tthe\tgiven\tdirectory structure\tin\tyour\tlocal\tfilesystem,\tand\tthe\tchmod\tcommand\tgives\teveryone read,\twrite,\tand\texecute\tpermissions\ton\tthe\t/opt\tdirectory\tand\tits subdirectories.\tYou\tcan\tverify\tthis\tby\trunning\tthe\tls\t-l\tcommand.\tSetting 777\tprivileges\tis\tnot\ta\tsafe\tapproach\tas\tit\topens\tup\tsecurity\trisks.\tWhen\tyou are\tdoing\tsomething\tsimilar\tin\tyour\tapplication,\tmake\tsure\tthat\tyou\tgive just\tthe\trequired\tprivileges.\n\n2.\t Now\tthat\tour\tdirectory\tis\tready,\tlet's\tmake\tchanges\tin\tour\trepository\tclass to\tstart\twriting\tgeolocations\tto\tthis\tdirectory.\tAs\twe\twould\tneed\tone\tfile\tper geolocation,\twe\thave\tto\tcome\tup\twith\ta\tnaming\tconvention\tso\tthat\tthe\tfiles don't\tget\toverwritten.\tThe\ttimestamp\twill\tmore\tor\tless\tbe\tunique\tfor\tall geolocations.\tBut\twhat\thappens\twhen\tyou\tare\twriting\tgeolocations\tfor multiple\tusers\tat\tthe\tsame\ttime?\tSo,\tmaybe\ta\tcombination\tof\ttimestamp\tand user\tID?\tYes,\tthat\tshould\twork\tfor\tnow.\tTo\tdifferentiate\tthe\tuser\tID\tfrom the\ttimestamp,\twe\tcould\tuse\tthe\tfollowing\tconvention:\n\nuser<userId>_t<timestamp>\n\n3.\t Let's\tmake\tchanges\tto\tthe\tGeoLocationRepository.java\tfile\tto\tfollow\tthis naming\tconvention.\tThe\tfirst\tthing\tthat\twe\twill\tneed\tis\tan\tobject-to-JSON string\tserializer.\tWe\twill\tuse com.fasterxml.jackson.databind.ObjectMapper\tas\tit\tis\talready\tused\tby Spring\tMVC.\tThe\tObjectMapper.writeValue(File,\tString)\tmethod\tis used\tto\twrite\ta\tfile\twith\tthe\tgiven\tstring\tcontent,\twhich\tsuits\tour\tneeds perfectly.\n\n4.\t Go\tahead\tand\tuse\tthis\tmethod\tin\tthe\tGeoLocationRepository\tclass' addGeoLocation\tmethod.\tAfter\tyou\tare\tdone,\tyour GeoLocationRepository.java\tclass\twill\tlook\tsomething\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation; import\tjava.io.File; import\tjava.util.ArrayList; import\tjava.util.Collections; import\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\nimport\tcom.fasterxml.jackson.databind.ObjectMapper;\n\n@Repository public\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew\t ArrayList<GeoLocation>();\n\nprivate\tstatic\tfinal\tObjectMapper\tMAPPER\t=\tnew\t ObjectMapper();\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\tgeolocations.add(geolocation);\n\ntry\t{ \t\t\t\t\t\t\t\t\t\t\t\tMAPPER.writeValue(new\t File(\"optpackt/geolocation/data/user\"\t+\tgeolocation.getUserId()\t +\t\"_t\"\t+\tgeolocation.getTimestamp()),\tgeolocation); \t\t\t\t\t\t\t\t}\tcatch\t(Exception\te)\t{ \t\t\t\t\t\t\t\t\t\t\t\te.printStackTrace(); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{ \t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations); \t\t\t\t} }\n\n5.\t Now\tthat\tboth\tour\tdirectory\tand\tcode\tare\tready,\tlet's\ttest\tthe\tapplication. Start\tyour\tGeoLocationApplication.java\tapplication\tas\ta\tSpring\tBoot application\tfrom\tyour\tSTS\tIDE.\tNow\tissue\tthe\tfollowing\tcurl\tcommand\tto create\ta\tgeolocation: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-\n\nd'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nAlso,\tthis\tshould\thave\tcreated\tthe\tdata\tfile\tat\tthe optpackt/geolocation/data\tdirectory.\tLet's\tverify\tthat.\tIssue\tthe following\tcommand\tto\tlook\tat\tthe\tcontents\tof\tthe\tdata\tfile:\n\ncat\toptpackt/geolocation/data/userf1196aac-470e-11e6-beb8- 9e71128cae77_t1468203975\n\n6.\t This\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n7.\t Now\tthat\tour\tcode\tworks\tgreat,\tthe\tnext\tsteps\tare\tas\tfollows:\n\n1.\tBuild\tthe\tproject\tto\tgenerate\ta\tnew\tJAR\tartifact\n\n2.\tCreate\ta\tnew\tDocker\timage\tbecause\tour\tcode\thas\tchanged\n\n3.\tUpload\tthe\tnew\timage\tto\tDocker\tHub\n\n4.\tRedeploy\tthe\tnew\timage\twith\tvolume\tconfigurations\n\n5.\tVerify\twhether\tthe\tvolume\tis\tmapped\n\n8.\t Go\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand. This\tshould\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe\n\ntarget\tdirectory.\n\n9.\t In\torder\tto\tcreate\tthe\tnew\timage,\twe\thave\tto\tadd\ttwo\tnew\tlines\tto\tthe Dockerfile\tto\tcreate\tthe\tdata\tdirectory\tand\tgive\tit\twrite\tprivileges.\tAdd\tthe following\ttwo\tlines\tto\tyour\tDocker\tfile:\n\nRUN\tmkdir\t-p\toptpackt/geolocation/data RUN\tchmod\t-R\t777\t/opt\n\n10.\t After\tyou\tadd\tthis,\tyour\tDocker\tfile\twill\tlook\tsomething\tlike\tthis:\n\nFROM\topenjdk:8 RUN\tmkdir\t-p\toptpackt/geolocation/data RUN\tchmod\t777\t/opt ADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar \t\t\t\t\t\t\t\t\t\t\toptpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\n11.\t Now\tlet's\tbuild\tthe\timage\twith\tnew\tcode.\tKeep\tin\tmind\tthat\tin\taddition\tto creating\tthe\tdata\tdirectory,\tthe\tother\tchange\tin\tthe\timage\tis\tgeolocation- 0.0.1-SNAPSHOT.jar.\tThis\tfile\twould\thave\tbeen\tautomatically\tcreated\tby your\tIDE\twhen\tyou\tmade\tthe\tchange\tto\tyour GeoLocationRepository.java\tfile.\tThough\tI\tdidn't\texplicitly\tmention earlier,\tbe\taware\tthat\tit\tis\talso\tgetting\tchanged\tin\tyour\timage.\n\n12.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\timage\twe\talready\thave.\tTo do\tthat,\trun\tthe\tfollowing\ttwo\tcommands\tone\tby\tone:\n\ndocker\trmi\tpackt/geolocation docker\trmi\tvikrammurugesan/geolocation\n\nWe\tare\tremoving\tthe\tpackt/geolocation\timage\tas\tit\treferences\tthe vikrammurugesan/geolocation\timage.\tIf\tyou\ttry\tto\tremove\tthe vikrammurugesan/geolocation\timage\twithout\tremoving\tthe packt/geolocation\timage,\tDocker\twill\tcomplain\tabout\treferences\tand\twill not\tremove\tthe\timage.\tTo\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton your\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\nRemember\tto\tuse\tyour\taccount\tname\tinstead\tof\tmine\tin\tthis\tcommand. After\tyour\timage\thas\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto\tDocker\tHub using\tthe\tfollowing\tcommand.\tYou\tmay\tbe\tasked\tto\tlog\tin\tto\tyour\tDocker Hub\taccount\tif\tyou\thaven't\talready\tdone\tso.\n\nHub\taccount\tif\tyou\thaven't\talready\tdone\tso.\n\ndocker\tpush\tvikrammurugesan/geolocation\n\nAgain,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe last\tupdated\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent.\n\n13.\t Now\tthat\tour\timage\tis\tready\tto\tbe\tused,\tlet's\tspin\toff\tour\tmicroservice\ton Mesos\tusing\tMarathon.\tMake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tIf it\tis\tdown,\tkill\tyour\tcluster\tand\tstart\tit\tagain.\tOnce\tyour\tcluster\tis\tback\tup, open\tthe\tMarathon\tweb\tUI\ton\tyour\tbrowser.\tClick\ton\tthe\tCreate Application\tbutton\tand\tgo\tinto\tJSON\tmode.\tWe\twill\tbe\tusing\tJSON\tmode to\tquickly\tpopulate\tthe\tmodal.\n\nIn\tJSON\tmode,\tdelete\tthe\texisting\tJSON\tand\tpaste\tthe\tfollowing:\n\n{\t \t\t\t\t\t\t\t\t\t\t\"id\":\t\"geolocation\",\t \t\t\t\t\t\t\t\t\t\t\"cmd\":\tnull,\t \t\t\t\t\t\t\t\t\t\t\"cpus\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"mem\":\t512,\t \t\t\t\t\t\t\t\t\t\t\"disk\":\t1024,\t \t\t\t\t\t\t\t\t\t\t\"instances\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"container\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\",\t \t\t\t\t\t\t\t\t\t\t\t\t\"docker\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesangeolocation\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}\n\n14.\t Now\tgo\tback\tto\tUI\tmode\tby\ttoggling\tthe\tJSON\tMode\tbutton.\tNavigate\tto the\tVolumes\tsection.\tIn\tthe\tVolumes\tsection,\tyou\twill\tsee\ttwo\tthings.\tOne is\tPersistent\tVolumes,\twhich\tis\tmostly\tused\tin\tapplications\tthat\tneed stateful\tbehavior.\tThe\tnext\tone\tis\tthe\tDocker\tContainer\tVolumes,\twhich is\tused\tto\tmap\tvolumes\tbetween\tthe\tcontainer\tand\thost.\tIn\tour\tcase,\twe have\tto\tadd\ta\tDocker\tcontainer\tvolume.\tAdd\tthe\tfollowing\tentries\tto\tthe Docker\tContainer\tVolumes\tsection\tand\thit\tCreate\tApplication: Container\tPath:\toptpackt/geolocation/data Host\tPath:\toptpackt/geolocation/data Mode:\tRead\tand\tWrite\n\nAs\tyou\tcan\tsee,\twe\tare\tusing\tthe\tsame\tpath\tin\tthe\tcontainer\tand\tthe\thost. Marathon\twill\tdeploy\tthe\tapplication\twith\tthe\tnewer\tversion\tof\tyour\timage. 15.\t Now\tthat\tour\tapplication\tis\tready\tto\ttest,\tlet's\tcreate\ttwo\tgeolocations\tusing curl.\tMake\tsure\tthe\tport\tnumber\tthat\tyou\tuse\tis\tthe\tsame\tport\tnumber\tthat is\tadvertised\tin\tMarathon.\tIn\tmy\tcase,\tthe\tport\tnumber\twas\tchanged\tfrom 31434\tto\t31758.\tThat's\tbecause\twe\tredeployed\tthe\tapplication.\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1474843159,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31758/geolocation curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1474843900,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t42.803488,\t\"longitude\":-87.144040}'\t http://192.168.99.100:31758/geolocation\n\nThese\ttwo\tcommands\tshould\thave\tcreated\ttwo\tfiles\tin\tthe optpackt/geolocation/data\tdirectory\tof\tthe\tcontainer\tas\twell\tas\tthe\thost.\n\n16.\t First,\tlet's\tverify\tthat\tthe\tfile\tis\tcreated\tin\tthe\tcontainer.\tTo\tlist\tthe\tfiles\tin the\toptpackt/geolocation/data\tdirectory,\twe\thave\tto\tfind\tout\tthe\tID\tof the\tcontainer.\tIdeally,\twhen\tyou\thave\ta\treal\tnon-dockerized\tMesos\tcluster, your\tcontainer\twill\tbe\trunning\ton\ta\tremote\tMesos\tslave.\tBut\tas\tour installation\tis\ta\tDockerized\tversion,\tthe\tgeolocation\tapplication\twill\tbe running\tas\ta\tcontainer\ton\tour\tDocker\thost.\tYou\tcan\tverify\tthat\tusing\tthe docker\tps\t-a\tcommand:\n\nIn\tthis\tscreenshot,\tsome\tportion\tof\tthe\tconsole\thas\tbeen\tcropped\tout\tto highlight\tonly\tthe\trelevant\tinformation.\tBut\tas\tyou\tcan\tsee,\tthe\tgeolocation application\tis\trunning\tas\ta\tDocker\tcontainer,\tand\tits\tID\tis\t924b3f748273. Now\tthat\twe\tknow\tthe\tcontainer\tID,\tissue\tthe\tfollowing\tDocker\tcommand to\tlist\tthe\tcontents\tof\tthe\tdata\tdirectory\tand\tthe\tdata\tfiles\tthemselves:\n\ndocker\texec\t924b3f748273\tls\toptpackt/geolocation/data\n\nThis\tshould\tshow\tsomething\tlike\tthe\tfollowing:\n\nuserf1196aac-470e-11e6-beb8-9e71128cae77_t1474843159 userf1196aac-470e-11e6-beb8-9e71128cae77_t1474843900\n\n17.\t To\tverify\tthe\tcontents\tof\tthe\tfiles,\tissue\tthe\tfollowing\tcommands\tone\tby one:\n\ndocker\texec\t924b3f748273\t catoptpackt/geolocation/data/userf1196aac-470e-11e6-beb8- 9e71128cae77_t1474843159\n\n18.\t You\tshould\tsee\tthis\toutput\t(pretty-printed\tfor\treadability):\n\n{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":41.803488,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":-88.14404,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":1474843159\t \t\t\t\t\t\t\t\t}\n\ndocker\texec\t924b3f748273\tcat\t \t\t\t\t\t\t\t\t\t\toptpackt/geolocation/data/userf1196aac-470e-11e6- beb8- \t\t\t\t\t\t\t\t\t\t9e71128cae77_t1474843900\n\n19.\t You\tshould\tsee\tthis\toutput\t(pretty-printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":42.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":-87.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":1474843900 \t\t\t\t\t\t\t\t}\n\nWith\tthat,\twe\thave\tverified\tthat\tour\tapplication\tcreates\tthe\tdata\tfiles\tin\tthe data\tdirectory\tof\tthe\tcontainer.\n\n20.\t In\torder\tto\tverify\tthat\tour\tvolume\tmappings\twork,\twe\thave\tto\tcheck whether\tthose\tfiles\tare\tavailable\tin\tthe\tDocker\thost.\tKeep\tin\tmind\tthat\tas we\tare\tusing\tDocker\tMachine,\tthe\tDocker\thost\tin\tthis\tcase\tis\tthe\tOracle VirtualBox\tVM\tand\tnot\tour\tlocal\tcomputer.\tIn\torder\tto\tlook\tat\tthe\tcontents of\tthe\tVM,\twe\thave\tto\tfirst\tSSH\tinto\tthe\tVM.\tDocker\tMachine\thas\tan\tssh command\tthat\tlets\tyou\tSSH\tinto\tthe\tVM.\tGo\tahead\tand\tissue\tthe\tfollowing command\tto\tSSH\tinto\tthe\tVM:\n\ndocker-machine\tssh\tdefault\n\nYou\tshould\tsee\tsomething\tlike\tthis:\n\n21.\t List\tthe\tfiles\tin\tthe\toptpackt/geolocation/data\tdirectory\tusing\tthe\tls command:\n\nls\t-l\toptpackt/geolocation/data\n\nYou\tshould\tsee\tthat\ttwo\tfiles\thave\tbeen\tcreated\twith\tthe\tsame\tnames\tas\tin the\tcontainer:\n\nIf\tyou\twould\tlike\tto\tlook\tat\tthe\tcontents,\texecute\tthe\tcat\tcommand\tto\tlook at\tthe\tcontents\tof\tthe\tdata\tfiles.\tThat's\tit!\tWe\thave\tlearned\thow\tto\tmap volumes\tusing\tMarathon.\tIn\ta\treal-time\tscenario,\tit\tis\tworth\tusing\tvolume mapping\tto\ttake\tbackups\tof\tany\tcritical\tdata\tsuch\tas\tDB\tdata\tfiles,\tsensitive log\tfiles,\tand\traw\tmachine\tdata.\tSome\torganizations\tutilize\tMesos frameworks\tsuch\tas\tChronos\tto\tperform\tdata\tbackups\tof\tthese\tdata.\n\nNote\n\nTo\tlearn\tmore\tabout\tChronos,\ttake\ta\tlook\tat\tthis\tpage: https://mesos.github.io/chronos/\n\nConfiguring\tenvironment\tvariables\tin Marathon\n\nEnvironment\tvariables\tplay\ta\tvital\trole\tin\tany\tcontainer.\tBe\tit\tyour\tdatabase\tor messaging\tserver\tor\tyour\town\tRESTful\tAPI,\tenvironment\tvariables\tcan\tbe\tused to\tstore\tconfigurations\tof\tyour\tcontainer.\tSo\tfar\tin\tour\tgeolocation\tmicroservice, we\thaven't\tcome\tacross\ta\tscenario\tto\tuse\tenvironment\tvariables\tas\tit\tis\ta standalone\tapplication\tand\tdoes\tnot\thave\tto\ttalk\tto\tany\tother\tserver\tor middleware.\tBut\tin\tproduction\tscenario\twhere\tyou\tmicroservice\thas\tto\ttalk\tto\ta database\tor\tKafka\tbroker,\tyou\thave\tto\tstore\tthe\tconfigurations\tof\tyour\tdatabase or\tbroker\tsomewhere.\tThat's\twhere\tdevelopers\tprefer\tusing\tenvironment variables.\tIn\tthis\trecipe\twe\twill\ttake\ta\tlook\tat\thow\tto\tconfigure\tour\tgeolocation application\tto\tuse\tan\tenvironment\tvariable\tand\talso\tsee\thow\tto\tpass\tthat\tvariable using\tMarathon.\n\nGetting\tready\n\nBefore\twe\tmove\ton,\twe\tfirst\tneed\tto\tknow\tthe\tenvironment\tvariable\tthat\twe\tare going\tto\tparameterize\tand\thow\tthe\tgeolocation\tapplication\tis\tgoing\tto\tuse\tit.\tOne use\tcase\tcould\tbe\tgetting\tthe\tlocation\tof\tthe\tdata\tfiles\tas\tan\tenvironment variable.\tLet's\tgo\tahead\tand\tdo\tthat!\tAs\twe\twill\thave\tto\tmake\tsome\tcode changes,\tgo\tahead\tand\topen\tup\tSTS\tIDE.\n\nHow\tto\tdo\tit...\n\nOpen\tthe\tGeolocationRepository.java\tfile\tthat\tis\tresponsible\tfor\tcreating\tthe geolocations\tand\tpersisting\tthe\tgeolocation\tJSONs\tto\tthe\tlocal\tfile\tsystem.\tIn this\trecipe\twe\twill\tbe\tparameterizing\tthe\tpath\tto\tthe\tdata\tdirectory optpackt/geolocation/data.\tCreate\ta\tnew\tconstant\tcalled\tDATA_FILES_DIR and\tassign\tit\twith\tthe\tvalue\tof\tthe\tenvironment\tvariable GEOLOCATION_DATA_FILES_DIR.\n\nprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t= \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\");\n\nBut\twait,\twhat\tif\tthe\tperson\tthat\tdeploys\tthe\tapplication\tforgets\tto\tpass\tthis environment\tvariable?\tSo\tit\tis\talways\tsafer\tto\tgive\ta\tdefault\tvalue\tto environment\tvalues\tif\tthey\tare\tnull\t(while\tthey\tare\tnon-nullable).\tWith\tthat\tsaid, lets\tgo\tahead\tand\trewrite\tthe\tpreceding\tline\twith\tthis:\n\nprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t=\t \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t!=\tnull\t\t\t\t\t\t\t ?\t \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t:\t \t\t\t\t\t\t\t\t\t\t\"optpackt/geolocation/data\";\n\nAs\tyou\tcan\tsee\twe\thave\tdefaulted\tthe\tvalue\tto\toptpackt/geolocation/data. Now\tmodify\tthe\taddGeoLocation\tmethod\tto\tuse\tthis\tvariable.\tAfter modification,\tthis\tclass\twill\tlook\tsomething\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.io.File;\t \t\t\t\t\t\t\t\timport\tjava.util.ArrayList;\t \t\t\t\t\t\t\t\timport\tjava.util.Collections;\t \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\nimport\tcom.fasterxml.jackson.databind.ObjectMapper;\n\n@Repository\t \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew\t \t\t\t\t\t\t\t\t\t\t\t\tArrayList<GeoLocation>();\n\nprivate\tstatic\tfinal\tObjectMapper\tMAPPER\t=\tnew \t\t\t\t\t\t\t\t\t\t\t\tObjectMapper();\t \t\t\t\t\t\t\t\t\t\tprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t=\t \t\t\t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t!=\tnull\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t?\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"optpackt/geolocation/data\";\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation)\t{\t \t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation);\n\ntry\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\tMAPPER.writeValue(new\tFile(DATA_FILES_DIR\t+\t\"/user\"\t+ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.getUserId()\t+\t\"_t\"\t+ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.getTimestamp()),\tgeolocation);\t \t\t\t\t\t\t\t\t\t\t\t\t}\tcatch\t(Exception\te)\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\te.printStackTrace();\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{\t \t\t\t\t\t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations);\t \t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}\n\nNow\tthat\tour\tcode\tis\tready,\tlet's\tgo\tahead\tand\ttest\tthe\tapplication.\tStart\tyour application\tGeoLocationApplication.java\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tNow\tissue\tthe\tfollowing\tcURL\tcommand\tto\tcreate\ta\tgeolocation:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t\t\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\t\t\t \"latitude\":\t41.803488,\"longitude\":-88.144040}'\t http://localhost:8080/geolocation\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\t(output\thas\tbeen\tpretty\tprinted for\treadability\tpurposes):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nAlso,\tthis\tshould\thave\tcreated\tthe\tdata\tfile\tat\toptpackt/geolocation/data\n\ndirectory.\tLet's\tgo\tahead\tand\tverify\tthat.\tIssue\tthe\tfollowing\tcommand\tto\tlook\tat the\tcontents\tof\tthe\tdata\tfile:\n\ncat\toptpackt/geolocation/data/userf1196aac-470e-11e6-beb8\t -9e71128cae77_t1468203975\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\t(output\thas\tbeen\tpretty\tprinted for\treadability\tpurposes):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nNow\tthat\tour\tcode\tworks\tgreat,\tthe\tnext\tsteps\tare:\n\n1.\t Build\tthe\tproject\tto\tgenerate\ta\tnew\tJAR\tartifact. 2.\t Creating\ta\tnew\tDocker\tImage\tas\tour\tcode\thas\tchanged. 3.\t Upload\tthe\tnew\timage\tto\tDocker\tHub. 4.\t Redeploy\tthe\tnew\timage\twith\tenvironment\tvariable. 5.\t Verify\tif\tthe\tenvironment\tvariable\tis\tbeing\tused.\n\nGo\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand.\tThis should\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe\ttarget directory.\n\nBefore\twe\tbuild\tthe\tnew\timage,\tlet's\tgo\tahead\tand\tremove\tthe\texisting\timage that\twe\talready\thave.\tTo\tdo\tthat\tgo\tahead\tand\trun\tthe\tfollowing\tcommand:\n\ndocker\trmi\tvikrammurugesan/geolocation\n\nTo\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\nPlease\tuse\tyour\taccount\tname\tinstead\tof\tthe\tauthor's\tin\tthe\tpreceding commands.\tAfter\tyour\timage\thas\tbeen\tbuilt,\tgo\tahead\tand\tpush\tyour\tDocker image\tto\tthe\tDocker\tHub\tusing\tthe\tfollowing\tcommand.\tYou\tmight\tbe\tasked\tto log\tin\tto\tyour\tDocker\tHub\taccount\tif\tyou\thaven't\talready\tdone\tso.\n\ndocker\tpush\tvikrammurugesan/geolocation\n\nAgain\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe\timage has\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe\t\"Last Updated\"\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent.\tNow\tthat\tour\timage is\tready\tto\tbe\tused,\tlet's\tgo\tahead\tand\tspin\toff\tour\tmicroservice\ton\tMesos\tusing Marathon.\tMake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tIf\tit\tis\tdown,\tplease kill\tyour\tcluster\tand\tstart\tit\tagain.\tOnce\tyour\tcluster\tis\tback\tup,\tgo\tahead\tand open\tup\tMarathon\tweb\tUI\ton\tyour\tbrowser.\tClick\ton\tthe\tCreate\tApplication button\tand\tgo\tto\tthe\tJSON\tmode.\tWe\twill\tbe\tusing\tthe\tJSON\tmode\tto\tquickly populate\tthe\tmodal.\tIn\tthe\tJSON\tmode,\tdelete\tthe\texisting\tJSON\tand\tpaste\tthe following\tJSON.\n\n{\t \t\t\t\t\t\t\t\t\t\t\"id\":\t\"geolocation\",\t \t\t\t\t\t\t\t\t\t\t\"cmd\":\tnull,\t \t\t\t\t\t\t\t\t\t\t\"cpus\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"mem\":\t512,\t \t\t\t\t\t\t\t\t\t\t\"disk\":\t1024,\t \t\t\t\t\t\t\t\t\t\t\"instances\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"container\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\",\t \t\t\t\t\t\t\t\t\t\t\t\t\"docker\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesangeolocation\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\t \t}\n\nNow\tflip\tback\tto\tthe\tfriendly\tform\tview\tand\tgo\tto\tthe\tEnvironment\tVariables section.\tIn\tthe\tenvironment\tvariables\tsection,\tadd\tthe\tfollowing\tentry\tand\thit Create\tApplication.\n\nKey:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nTo\tverify\tif\tthe\tenvironment\tvariable\thas\tcreated\tcorrectly,\tgo\tahead\tand\ttake\ta look\tat\tthe\tConfiguration\tsection\tof\tthe\tapplication\ton\tMarathon.\tYou\tshould see\tsomething\tlike\tthis:\n\nAs\ta\tnext\tstep,\tlet's\tgo\tahead\tand\tcreate\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\n\nand\tverify\tif\tthe\tfiles\twere\tcreated\ton\tthe\tright\tdirectory\tof\tthe\tcontainer.\tGo ahead\tand\tissue\tthe\tfollowing\ttwo\tcURL\tcommands\tone\tby\tone\ton\tyour\tterminal window:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t\t\t\t 1474843159,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31758/geolocation curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1474843900,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t42.803488,\t\"longitude\":\t-87.144040}'\t http://192.168.99.100:31758/geolocation\n\nPlease\tnote\tthat\tthe\tport\tnumber\tof\tthe\tcontainer\tmight\tbe\tdifferent\ton\tyour installation.\tIn\tthe\tpreceding\tcommand\twe\thave\tused\t31758\tas\tthat's\twhat Marathon\tuses\tfor\tthis\tinstance.\tNow\tissue\tthe\tfollowing\tdocker\texec command\tto\tverify\tthe\tcontents\tof\tthe\tdata\tdirectory\tinside\tthe\tcontainer:\n\ndocker\texec\t1d52a2617a8e\tls\toptpackt/geolocation/data\n\nThis\tshould\tshow\tsomething\tlike\tthis:\n\nuserf1196aac-470e-11e6-beb8-9e71128cae77_t1474843159 userf1196aac-470e-11e6-beb8-9e71128cae77_t1474843900\n\nAgain\tnote\tthe\tcontainer\tID\tin\tthe\tpreceding\tcommand.\tPlease\tfind\tyour container's\tID\tusing\tthe\tdocker\tps\tcommand\tand\tuse\tthat\tcontainer\tID\tin\tthe preceding\tcommand.\n\nWith\tthat\tsaid\twe\tnow\tknow\thow\tto\tconfigure\tenvironment\tvariables\tin Marathon.\tThough\twe\tdon't\thave\ta\tsolid\tuse\tcase\tof\tthe\tenvironment\tvariable\tin this\texample,\twe\twill\tbe\tusing\tenvironment\tvariables\theavily\tin\tour\tfuture chapters.\n\nScaling\tyour\tmicroservice\tin Marathon\n\nOne\tof\tthe\tmost\timportant\tdesign\tdecisions\tin\tbuilding\ta\tmicroservice\tis scalability.\tIf\tyour\tmicroservice\tis\tnot\tscalable,\tthere\tis\tno\tpoint\tin\tdeploying\tit as\ta\tmicroservice;\tit\tcould\tin\tfact\tbe\ta\thuge\tmonolithic\tapplication.\tThere\tare several\tways\tto\tscale\ta\tmicroservice.\tIt\talso\tdepends\ton\tthe\ttransport\ttype\tyour microservice\tuses.\tIf\tyour\tmicroservice\tuses\tHTTP,\tyou\tshould\tconsider\tload- balancing\tyour\tHTTP\tendpoints\tin\tvarious\tinstances\tof\tyour\tmicroservice. Another\tapproach\tis\tusing\tan\tasynchronous\tmessaging\tsystem,\tsuch\tas ActiveMQ,\tKafka,\tRabbitMQ,\tand\tZeroMQ.\n\nGetting\tready\n\nThe\tgeolocation\tmicroservice\tuses\tRESTful\tAPIs\tto\texpose\tits\tendpoints.\tWe should\tbe\tconsidering\tload-balancing\ttools\tto\tload-balance\tthe\tendpoints\tacross instances\tof\tthe\tgeolocation\tapplication.\tIn\torder\tto\tscale\tour\tapplication,\tlet's first\tbring\tup\tthe\tMarathon\tweb\tinterface.\n\nHow\tto\tdo\tit... 1.\t Once\tthe\tMarathon\tweb\tUI\tis\tup\tand\trunning,\tdeploy\tthe\tapplication\tif\tit\tis not\talready\trunning.\tInstead\tof\trunning\tthe\tapplication\tfrom\tthe\tCreate Application\tmodal,\tusing\tJSON\tmode\tis\talways\tquicker\tand\tsimpler.\tUse the\tfollowing\tJSON\tto\tcreate\tyour\tapplication:\t{\t\"id\":\t\"geolocation\", \"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t1024,\t\"instances\":\t1, \"container\":\t{\t\"type\":\t\"DOCKER\",\t\"volumes\":\t[\t{\t\"containerPath\": \"opt/packt/geolocation/data\",\t\"hostPath\":\t\"optpackt/geolocation/data\", \"mode\":\t\"RW\"\t}\t],\t\"docker\":\t{\t\"image\":\t\"vikrammurugesan/geolocation\", \"network\":\t\"BRIDGE\",\t\"portMappings\":\t[\t{\t\"containerPort\":\t8080, \"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t], \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\t}\t}\n\n2.\t After\tthe\tgeolocation\tapplication\tstarts,\tclick\ton\tthe\tapplication\tfrom\tthe applications\tgrid,\tand\tgo\tto\tthe\tgeolocation-specific\tpage.\tThere,\tyou should\tsee\tthe\tScale\tApplication\tbutton.\tClick\ton\tit.\tIt\tshould\topen\ta modal\tlike\tthis:\n\nChoose\t4\tfrom\tthe\tdropdown\tand\thit\tScale\tApplication.\tYou\tshould\tnow\tsee\n\nthat\tMarathon\thas\tdeployed\tthe\tapplication\tas\tfour\tdifferent\tinstances,\teach exposing\tdifferent\tports:\n\nIf\tyou\twould\tlike\tto\tverify\tthat\tthe\tapp\tis\trunning\ton\tthese\tports,\ttest\tthem\tone by\tone\tusing\tthe\tcurl\tcommand.\tIf\tyou\tdo\tnot\thave\tenough\tresources\tin\tyour cluster,\tscaling\tmight\tnot\twork.\tPlease\ttry\tincreasing\tthe\tresources\tby\trecreating your\tDocker\tMachine\tVM.\n\nAll\tthis\ttime,\twe\thave\tbeen\tinterfacing\twith\tthe\tMarathon\tweb\tUI.\tFor\ta change,\tlet's\tlook\tat\tthe\tMesos\tweb\tUI\tat\thttp://192.168.99.100:5050.\tYou should\tsee\tthat\tthere\tare\tfour\tdifferent\ttasks\trunning,\teach\tof\tthem\tindicating\tthe various\tgeolocation\tinstances:\n\nWe\tjust\tlearned\thow\tto\tscale\tup\tapplications\tusing\tMarathon.\tLet's\tsay\tyou would\tlike\tto\tscale\tthe\tgeolocation\tapplication\tback\tto\tjust\tone\tinstance;\tin\tother words,\tscale\tit\tdown.\tYou\tcan\tuse\tthe\tsame\tScale\tApplication\tmodal\tto\tscale\tit down\tto\t1\tinstance.\tAfter\tyou\tscale\tit\tdown,\tyou\tshould\tnow\tsee\tthat\tthere\tis only\tone\tinstance\tof\tthe\tapplication\trunning.\tYou\thave\tno\tcontrol\tover\twhich\n\nthree\tout\tof\tthe\tprevious\tfour\twill\tget\tdestroyed.\tThis\tdecision\tis\tmade\tby\tMesos based\ton\tthe\tresource\tavailability\ton\tthe\tMesos\tslaves:\n\nNow\tgo\tback\tto\tthe\tMesos\tweb\tinterface,\tand\tyou\twill\tnotice\tthat\tthree\ttasks\n\nare\tin\tKILLED\tstatus:\n\nDestroying\tyour\tmicroservice\tin Marathon\n\nThere\tmight\tbe\ttimes\tyou\twant\tto\tdestroy\ta\tmicroservice\tor\tapplication\tthat\tis already\trunning\ton\tMarathon\teither\tbecause\tyou\twant\tto\tfree\tup\tsome\tresources or\tbecause\tyou\twould\tlike\tto\tredeploy\tthe\tapplication\twith\ta\tdifferent\tset\tof Marathon\tconfigurations.\tThis\tcan\tbe\teasily\tachieved\tfrom\tthe\tapplication- specific\tpage\tin\tMarathon.\n\nGetting\tready\n\nOpen\tthe\tMarathon\tweb\tinterface\tin\tyour\tbrowser,\tand\tnavigate\tto\tthe geolocation\tapplication\tpage.\tIf\tyou\tdon't\thave\tthe\tapplication\tup\tand\trunning, use\tJSON\tmode\tand\tdeploy\tthe\tapplication\tusing\tthe\tJSON\tthat\twas\tused\tin previous\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon.\n\nHow\tto\tdo\tit... 1.\t Marathon\tapplications\tcan\teither\tbe\tsuspended\tor\tdestroyed.\tSuspended\n\napplications\tcan\tbe\tredeployed,\twhile\tdestroyed\tapplications\tcannot.\tClick on\tthe\tbutton\tthat\tlooks\tlike\ta\tgear.\tThis\tbutton\thas\ttwo\toptions:\tSuspend and\tDestroy.\tLet's\ttry\tto\tsuspend\tthe\tapplication:\n\nAs\tyou\tcan\tsee,\tthe\tstatus\tof\tthe\tapplication\tis\tmarked\tas\tSuspended,\tand\tthere are\tno\tactive\tinstances\tof\tthe\tapplication\trunning.\tIn\torder\tto\tredeploy\tthe application,\twe\twill\thave\tto\tscale\tit.\n\nScale\tthe\tapplication\tusing\tthe\tScale\tApplication\tmodal\twith\ta\tscaling\tfactor\n\nof\t1.\tWithin\ta\tfew\tseconds,\tyou\tshould\tsee\ta\tbrand\tnew\tinstance\tof\tthe geolocation\tapplication\tup\tand\trunning.\tThe\tSuspend\toption\tis\toften\tused\tto temporarily\tbring\tdown\ta\tservice.\tWhen\tyou\tsuspend\tyour\tapplication, Marathon\tsaves\tthe\tconfigurations\tof\tyour\tapplication\tso\tthat\tyou\tcan\tbring\tit back\tup\twith\tthe\tsame\tset\tof\tconfigurations\twithout\thaving\tto\tre-enter\tthem.\n\nThe\tnext\toption\twe\tare\tinterested\tin\tis\tDestroy.\tUnlike\tSuspend,\tthe\tDestroy\n\noption\tremoves\tthe\tapplication\tand\tits\tconfigurations\tcompletely\tfrom Marathon.\tLike\twe\tsaw\tearlier,\tyou\tmay\twant\tto\tdestroy\tyour\tapplication\teither to\tfree\tup\tsome\tresources\tor\tredeploy\tthe\tapplication\twith\ta\tnew\tset\tof configurations.\n\nGo\tahead\tand\tclick\ton\tthe\tgear\tbutton,\tand\tthen\thit\tthe\tDestroy\tbutton. Marathon\twill\task\tyou\tfor\tconfirmation\tas\tyou\tcannot\trecover\tfrom\tthis\tstep:\n\nIf\tyou\tconfirm\tthat\tyou\twould\tlike\tto\tdestroy\tthe\tapplication,\tyou\twill\tbe\ttaken to\tthe\tMarathon\tmain\tscreen,\tand\tyou\twill\tnot\tsee\tany\tapplications\trunning:\n\nMonitoring\tyour\tmicroservice\tlogs\tin Marathon\n\nSo\tfar,\twe\thave\tlearned\thow\tto\tdeploy,\tscale,\tsuspend,\tand\tdestroy\tour microservice\tin\ta\tMesos\tcluster\tusing\tMarathon.\tAll\tthese\tsteps\tare\tpart\tof\tyour deployment\tprocess,\tbut\tthere\tis\tone\tthing\tyou\twould\twant\tto\tdo\tpost deployment:\tmonitor\tthe\tlogs.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tmonitor\tour application\tlogs\tusing\tMarathon.\n\nGetting\tready\n\nFortunately,\tthere\tis\tan\teasy\tway\tto\tlook\tat\tyour\tapplication's\tlog\tfiles\tusing Marathon's\tweb\tinterface.\tThough\tit\tis\tnot\tvery\tuser\tfriendly,\tit\tis\tstill\tpossible. To\tillustrate\tthis,\tlet's\tdeploy\tthe\tgeolocation\tmicroservice\tusing\tMarathon.\tIf you\thave\tto\trestart\tyour\tMesos\tcluster,\tdo\tso.\tIn\tMarathon,\tuse\tJSON\tmode\tand the\tJSON\tthat\twas\tused\tin\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon\tto deploy\tthe\tapplication.\n\nHow\tto\tdo\tit... 1.\t Once\tyour\tapplication\thas\tstarted,\tgo\tto\tthe\tgeolocation\tapplication's\tpage in\tMarathon.\tYou\twill\tsee\tthat\tone\tinstance\tof\tyour\tapplication\tis\trunning. Click\ton\tthe\trunning\tinstance\tof\tthe\tgeolocation\tapplication.\tYou\twill\tsee something\tlike\tthis:\n\nThe\tfirst\tsection,\tat\tthe\ttop,\tprovides\tinformation\tsuch\tas\tthe\thost\ton\twhich\tyour application\tis\tdeployed,\tthe\tIP\taddress\tof\tyour\tDocker\tcontainer,\tports\texposed, and\tendpoints\texposed.\tThe\tsection\tthat\treally\tmatters\tto\tus\tnow\tis\tWorking Directory.\tIt\tshows\ttwo\tfiles\there:\tstdout\tand\tstderr.\tBoth\tof\tthem\thave\tthe same\tpermissions,\trw/r/r.\n\nMarathon\tuses\tDocker's\tlogging\tbehavior\tto\tconsume\tand\tdisplay\tthe\tlogs. Any\tstandard\toutput\tlogged\tby\tthe\tDocker\tcontainer\tgoes\tinto\tstdout,\tand\tany standard\terror\tlogged\tby\tDocker\tcontainer\tgoes\tinto\tstderr.\tThe\tversion\tof Marathon\twe\tare\tusing\tdoes\tnot\tlet\tyou\tview\tthe\tlogs\ton\tthe\tscreen.\tThe\tonly way\tto\tlook\tat\tthem\tis\tto\tdownload\tthem\tfirst\tand\topen\tthem\twith\tyour\tpreferred editor.\n\nHit\tthe\tDownload\tbutton\ton\tstdout.\tThis\tshould\tdownload\tthe\t7\tKB\tfile.\n\nOpen\tthe\tdownloaded\tfile\twith\tyour\tpreferred\teditor.\tIn\tthe\tfollowing screenshot,\tI\thave\tused\tOS\tX's\tTextEdit\tapplication:\n\nAs\tyou\tcan\tsee,\tthere\tare\tsome\tSpring\tBoot\tlogs\tin\tstdout.\tTowards\tthe\tend\tof the\tlogs,\tyou\tcan\tsee\tthe\tin-memory\tTomcat\tservice\tstarted\ton\tport\t8080 exposing\tour\tREST\tAPIs.\n\nSimilarly,\tdownload\tstderr\tand\ttake\ta\tlook\tat\tits\tcontents:\n\nThere\tare\tsome\tlog\tmessages\tfrom\tsome\tC++\tfiles,\tshowing\tthat\tthe\tDocker container\twas\tstarted.\n\nThough\tusing\tthe\tMarathon\tweb\tinterface\tto\tview\tlogs\tis\tnot\tvery\tconvenient,\tit\n\nis\tone\tstep\ttoward\tviewing\tyour\tlogs.\tIn\tthe\tfuture,\twe\tcan\texpect\ta\tmore sophisticated\tinterface\tfrom\tMarathon.\tThe\tintended\tuse\tof\tWorking\tDirectory is\twhen\tyou\twould\tlike\tto\texpose\tsome\tresource\tfiles\tused\tby\tyour\tapplication. In\tour\tgeolocation\tapplication,\twe\tdo\tnot\thave\tany\tfiles\tin\tthe\tworking\tdirectory.\n\nMonitoring\tyour\tmicroservice\tlogs\tin Mesos\n\nWe've\talready\tseen\tthat\tviewing\tlogs\tin\tMarathon\tis\tnot\tvery\teasy.\tOftentimes, you\twill\twant\tto\tperform\tmore\tadvanced\toperations,\tsuch\tas\ttailing\tlogs, viewing\tlogs\ton\tscreen,\tor\tviewing\tmultiple\tlogs\tat\tthe\tsame\ttime.\tFortunately, you\tcan\tdo\tthis\tusing\tMesos.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tmonitor application\tlogs-in\tother\twords,\ttask\tlogs-using\tthe\tMesos\tweb\tUI.\n\nGetting\tready\n\nTo\tcheck\tthis\tout,\tdeploy\tthe\tgeolocation\tmicroservice\tusing\tMarathon.\tIf\tyou have\tto\trestart\tyour\tMesos\tcluster,\tdo\tso.\tIn\tMarathon,\tuse\tJSON\tmode\tand\tthe JSON\tthat\twas\tused\tin\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon\tto\tdeploy the\tapplication.\n\nHow\tto\tdo\tit... 1.\t Once\tyour\tapplication\thas\tstarted,\tgo\tto\tthe\tMesos\tweb\tinterface\tusing\tthe URL\thttp://192.168.99.100:5050,\tand\tverify\tthat\tyour\tapplication's\ttask is\trunning:\n\nFrom\tthe\tpreceding\tscreenshot,\tyou\tcan\tsee\tthat\tthere\tis\tone\tactive\ttask\tand several\tcompleted\ttasks\tfor\tthe\tgeolocation\tmicroservice.\tThe\tcompleted\ttasks were\tfrom\tprevious\texecutions,\tand\tthe\trunning\ttask\tis\tthe\tone\tthat\twe\tare concerned\tabout.\tIn\tfact,\tyou\tcan\tstill\tlook\tat\tthe\tlogs\tof\tthe\tcompleted\ttasks,\tbut in\tthis\trecipe,\twe\twill\tbe\tlooking\tat\tthe\tactive\ttask's\tlogs,\tas\tthe\tsteps\tare\texactly the\tsame.\tIn\tActive\tTasks,\tthere\tis\ta\thyperlink\tcalled\tSandbox.\tClick\ton\tit.\tYou should\tsee\ta\tscreen\tthat\tdisplays\ttwo\titems:\tstdout\tand\tstderr.\n\nThis\tis\tpretty\tmuch\tthe\tsame\tthing\twe\tsaw\tin\tMarathon.\tYou\tcan\tdo\ttwo\tthings: either\tdownload\tthe\tlogs\tusing\tthe\tDownload\tbutton\tand\ttake\ta\tlook\tat\tthem using\tyour\tfavorite\ttext\teditor,\tor\ttail\tthe\tlogs\tby\tclicking\ton\tthe\tfile\tnames.\n\nGo\tahead\tand\tclick\ton\tstdout.\tYou\twill\tsee\tthat\ta\tpopup\twindow\topens\tup\n\nwith\tthe\tcontents\tof\tstdout:\n\nA\tgreat\tadvantage\tof\tthis\tview\tis\tthat\tit\tconstantly\ttails\tany\tnew\tstdout\tcalls. You\tcan\tkeep\tthis\twindow\topen\tto\tlook\tat\tthe\tlive\tlogs\tas\tthey\tcome.\n\nSimilarly,\tclick\ton\tstderr\tto\tlook\tat\tthe\tcontents\tof\tstderr:\n\nThe\ttailing\tfeature\tis\tespecially\thelpful\twhen\tyou\tare\tmonitoring\tlogs\tof multiple\tapplications.\tKeep\tin\tmind\tthat\tthis\tis\ta\tfeature\tof\tMesos,\tand\tMesos lets\tyou\tlook\tat\tlogs\ton\ttasks\tdeployed\tusing\tany\tframework:\tSpark,\tChronos, Marathon,\tAurora,\tCassandra,\tand\tso\ton.\n\nIn\tthis\trecipe,\twe\tlearned\ttwo\tways\tof\tmonitoring\tthe\tlogs\tof\tapplications\tthat are\tdeployed\tin\tMarathon.\tWith\tthis\trecipe,\tyou\thave\tfinished\tlearning\tthe\tbasics\n\nare\tdeployed\tin\tMarathon.\tWith\tthis\trecipe,\tyou\thave\tfinished\tlearning\tthe\tbasics of\tMesos\tand\tMarathon.\tYou\tcan\tnow\tstart\tplaying\taround\twith\tMesos\tand Marathon\tto\tfit\tyour\tneeds.\n\nManaging\tyour\tmicroservice\tusing Marathon's\tREST\tAPI\n\nMarathon's\tweb\tinterface\tis\tdefinitely\tone\tof\tthe\tbest\tuser\tinterfaces.\tIt\tis\tvery intuitive\tand\tsophisticated.\tSo\tfar,\twe\thave\tbeen\tusing\tthe\tweb\tinterface\tbecause it\twas\tthe\teasiest\tway\tto\tget\tyou\tup\tto\tspeed.\tUsing\tthe\tweb\tinterface\tmight\tnot be\tscalable\twhen\tyou\tare\tdealing\twith\thundreds\tof\tmicroservices,\tthough.\tMesos and\tMarathon\tare\tnow\tproduction\tready.\tIn\tfact,\ta\tlot\tof\torganizations\thave\tbeen using\tMesos\tand\tMarathon\tto\tdeploy\thundreds\tof\tmicroservices.\tIn\tthis\trecipe, we\twill\tlook\tat\thow\tto\tdeploy\tmicroservices\tin\tMarathon\tusing\tits\tREST\tAPI. This\tenables\tyou\tto\timplement\tcontinuous\tdeployments.\n\nContinuous\tdeployments\thave\tbeen\tpicking\tup\ttraction\tlately.\tContinuous deployment\tis\ta\tprocess\tin\twhich\tyou\tdeploy\tyour\tapplication\tto\tproduction\tas soon\tas\tit\thas\tbeen\tchecked\tin,\tpackaged,\ttested,\tand\tvalidated.\tOrganizations use\tcontinuous\tintegration\t(CI)\ttools\tsuch\tas\tJenkins,\tHudson,\tBamboo,\tand Travis\tCI\tto\tautomate\ttheir\tdeployments.\tIf\tyou\thave\tthe\tright\tset\tof\ttest\tcases and\tthe\tright\ttools\tto\tvalidate\tand\tautomate\tyour\ttests,\tyou\tcan\tconfidently deploy\tyour\tapplication\tafter\tit\thas\tbeen\ttested\tand\tvalidated.\tWith\tthe\trecent improvements\tin\tthe\taforementioned\ttools,\tit\tis\tnow\tpossible\tto\tautomate deployments\teasily.\tBefore\tMesos\tor\tKubernetes,\tdeployments\twere\tdone\tusing build\tframeworks\tsuch\tas\tMaven,\tGradle,\tand\tAnt.\tOne\tsuch\texample\tis\tthe Cargo\tplugin.\tThe\tCargo\tplugin\tfor\tMaven,\tAnt,\tand\tGradle\tcan\tdeploy\tyour artifacts\tto\tseveral\tweb\tand\tapplication\tservers,\tincluding\tbut\tnot\tlimited\tto Tomcat,\tWildFly,\tGlassfish,\tWeblogic,\tand\tWebsphere.\tIf\tyou\thave\tused\tthe Cargo\tplugin,\tyou\twill\tknow\tthat\tit\tis\tnot\tvery\teasy\tto\tconfigure.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tuse\tthe\tvarious\tRESTful\tAPIs\tof\tMarathon. This\twill\tbe\tparticularly\tuseful\twhen\tyou\tare\tautomating\tyour\tdeployments\tto Mesos\tand\tMarathon.\tBefore\twe\tstart\tthis\trecipe,\tlet's\trebuild\tthe\tMesos\tcluster. As\tour\tMesos\tcluster\tis\tDockerized,\tI\tsuggest\tyou\trestart\tthe\tcluster\tevery\tonce in\ta\twhile.\tThis\tis\tbecause,\tsometimes\tthe\tcontainers\ttend\tto\trun\tout\tof resources.\tHowever\tyou\tdon't\thave\tto\tworry\tabout\tthis\tin\tproduction\tif\tyou\thave sufficient\tresources.\tOnce\tyour\tcluster\tis\tup\tand\trunning,\topen\tthe\tMarathon web\tinterface\tin\ta\tbrowser.\tWe\twill\tbe\tusing\tthe\tterminal\tto\thit\tMarathon's\tAPI using\tcurl\tcommands.\tSo\tkeep\ta\tterminal\twindow\topen\tall\tthe\ttime.\n\nHow\tto\tdo\tit...\n\nIn\tthis\trecipe,\twe\twill\tbe\tlooking\tat\tseveral\tMarathon\tREST\tAPIs\tthat\tlet\tyou:\n\nDeploy\tan\tapplication Scale\tan\tapplication List\tall\tinstances\tof\ta\tgiven\tapplication Destroy\tan\tapplication\n\n1.\t First,\tlet's\ttake\ta\tlook\tat\thow\twe\tcan\tdeploy\tthe\tgeolocation\tapplication using\tMarathon's\tREST\tendpoint.\tAll\tthe\tapplication-related\tAPIs\tare\tlisted under\tthe\t/apps\tdomain.\tThe\tmost\trecent\tversion\tof\tthe\tMarathon\tREST endpoints\tis\tv2.\tHence,\tthe\t/apps\tdomain\tAPIs\tare\tlisted\tunder\tthe\tpath v2apps.\tTo\tcreate\ta\tnew\tapplication\ton\tMarathon,\tall\tyou\thave\tto\tdo\tis POST\tthe\tJSON\trepresentation\tof\tyour\tapplication\tto\tthe\tURL http://192.168.99.100:8080v2apps.\n\nThe\tschema\tfor\tthis\tJSON\tis\texactly\tthe\tsame\tone\twe\tused\tin\tJSON\tmode from\tprevious\trecipes:\t{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"instances\":\t1,\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n}\n\n}\n\n2.\t As\twe\twill\tbe\tusing\tcurl\tas\tour\tclient,\tlet's\tmake\tthe\twhole\tJSON\twrap into\tone\tsingle\tline.\tYou\tcan\tuse\tyour\tfavorite\ttext\teditor\tto\tdo\tthis.\tThe final\tcurl\tcommand\twill\tlook\tsomething\tlike\tthis: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"id\":\t \"/geolocation\",\t\"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t 1024,\t\"instances\":\t1,\t\"container\":\t{\"type\":\t\"DOCKER\",\t \"volumes\":\t[{\"containerPath\":\t\"optpackt/geolocation/data\",\t \"hostPath\":\t\"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"}\t],\t \"docker\":\t{\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t \"BRIDGE\",\t\"portMappings\":\t[{\"containerPort\":\t8080,\t\"hostPort\":\t 0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t],\t \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t }\t}\t}'\thttp://192.168.99.100:8080v2apps\n\n3.\t You\tshould\tget\ta\tresponse\tsaying\tyour\tapplication\thas\tbeen\tqueued\tfor deployment\t(pretty-printed\tfor\treadability):\n\n{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"args\":\tnull,\n\n\"user\":\tnull,\n\n\"env\":\t{},\n\n\"instances\":\t1,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"executor\":\t\"\",\n\n\"constraints\":\t[],\t\"uris\":\t[],\n\n\"fetch\":\t[],\n\n\"storeUrls\":\t[],\n\n\"ports\":\t[\n\n8899\n\n\"portDefinitions\":\t[\n\n\"port\":\t8899,\n\n\"protocol\":\t\"tcp\",\t\"labels\":\t{}\n\n],\n\n{\n\n}\n\n],\n\n\"requirePorts\":\tfalse,\t\"backoffSeconds\":\t1,\t\"backoffFactor\":\t1.15, \"maxLaunchDelaySeconds\":\t3600,\t\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n},\n\n\"healthChecks\":\t[],\t\"readinessChecks\":\t[],\t\"dependencies\":\t[], \"upgradeStrategy\":\t{\n\n\"minimumHealthCapacity\":\t1,\t\"maximumOverCapacity\":\t1\n\n},\n\n\"labels\":\t{},\n\n\"acceptedResourceRoles\":\tnull,\t\"ipAddress\":\tnull,\t\"version\":\t\"2016-09- 26T02:03:43.284Z\",\t\"residency\":\tnull,\t\"tasksStaged\":\t0,\n\n\"tasksRunning\":\t0,\t\"tasksHealthy\":\t0,\t\"tasksUnhealthy\":\t0,\t\"deployments\": [\n\n{\n\n\"id\":\t\"6f569b52-181f-4909-974a-23666d7a2c6f\"\n\n}\n\n],\n\n\"tasks\":\t[]\n\n}\n\n4.\t Go\tto\tMarathon\tand\tmake\tsure\tthat\tyour\tapplication\tis\tup\tand\trunning. 5.\t Now\tlet's\tscale\tour\tapplication\tto\ta\tfactor\tof\t2.\tTo\tdo\tthis,\twe\twill\tuse\tthe PUT\tmethod\tand\tthe\tpath\tv2apps/geolocation,\twhere\t/geolocation\tis\tthe unique\tID\tof\tour\tapplication\tin\tMarathon.\tIf\tyou\tlook\tat\tthe\tfollowing request\tbody,\tit\tis\texactly\tthe\tsame\tas\tthe\tprevious\trequest,\texcept\tfor\tthe number\tof\tinstances.\tHere,\twe've\tset\tthe\tvalue\tof\tinstances\tto\t2:\n\n{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"instances\":\t2,\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n}\n\n}\n\n6.\t Go\tahead\tand\texecute\tthe\tfollowing\tcurl\tcommand:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPUT\t-d\t'{\"id\":\t \"/geolocation\",\t\"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t 1024,\t\"instances\":\t2,\t\"container\":\t{\"type\":\t\"DOCKER\",\t \"volumes\":\t[{\"containerPath\":\t\"optpackt/geolocation/data\",\t \"hostPath\":\t\"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"}\t],\t \"docker\":\t{\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t \"BRIDGE\",\t\"portMappings\":\t[{\"containerPort\":\t8080,\t\"hostPort\":\t 0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t],\t \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t }\t}\t}'\thttp://192.168.99.100:8080v2apps/geolocation\n\nYou\tshould\thave\treceived\ta\tresponse\tsimilar\tto\tthis,\tindicating\tthe\n\nYou\tshould\thave\treceived\ta\tresponse\tsimilar\tto\tthis,\tindicating\tthe deployment\tID\tfor\tthe\trequest\t(pretty-printed\tfor\treadability):\t{\n\n\"version\":\t\"2016-09-26T02:09:51.476Z\",\t\"deploymentId\":\t\"1eb0ae12-8ce9- 497a-b0df-0e07261e993a\"\n\n}\n\n7.\t Now\tif\tyou\tgo\tto\tMarathon,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tinstances\tof geolocation\tshowing\tup\tas\trunning:\n\n8.\t You\tcan\tscale\tdown\tthe\tapplication\tby\tposting\tthe\tsame\tPUT\trequest\twith\ta scaling\tfactor\tof\t1.\tYou\tmight\twant\tto\tlist\tdown\tthe\tinstances\tthat\tare running\tfor\tthe\tgiven\tapplication.\tYou\tcan\tdo\tthat\tby\tusing\tthe\tGET\tmethod and\tURL\tpath\tv2apps/geolocation.\tExecute\tthe\tfollowing\tcurl\tcommand on\tyour\tconsole: curl\thttp://192.168.99.100:8080v2apps/geolocation\n\n9.\t You\tshould\tget\tthe\tfollowing\tresponse,\tindicating\tthat\ttwo\tinstances\tof\tthe same\tapplication\tare\trunning\tin\tMarathon\t(parts\tof\tthe\tresponse\thave\tbeen\n\ntruncated\tfor\treadability):\n\n{\n\n\"app\":\t{\n\n\"id\":\t\"/geolocation\",\t.\n\n.\n\n.\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n},\n\n.\n\n.\n\n.\n\n\"tasksStaged\":\t0,\t\"tasksRunning\":\t2,\t\"tasksHealthy\":\t0,\t\"tasksUnhealthy\": 0,\t\"deployments\":\t[],\t\"tasks\":\t[\n\n{\n\n\"id\":\t\"geolocation.73ad18be-838d-11e6-9e4b-02423267746a\",\t\"slaveId\": \"be077ff3-9864-4517-8b49-e0f8fd66d977-S0\",\t\"host\":\t\"192.168.99.100\", \"state\":\t\"TASK_RUNNING\",\t\"startedAt\":\t\"2016-09-26T02:03:44.505Z\", \"stagedAt\":\t\"2016-09-26T02:03:43.601Z\",\t\"ports\":\t[\n\n31981\n\n],\n\n\"version\":\t\"2016-09-26T02:03:43.284Z\",\t\"ipAddresses\":\t[\n\n{\n\n\"ipAddress\":\t\"172.17.0.2\",\t\"protocol\":\t\"IPv4\"\n\n}\n\n],\n\n\"appId\":\t\"/geolocation\"\n\n},\n\n{\n\n\"id\":\t\"geolocation.4efe1dbf-838e-11e6-9e4b-02423267746a\",\t\"slaveId\": \"be077ff3-9864-4517-8b49-e0f8fd66d977-S0\",\t.\n\n.\n\n.\n\n}\n\n]\n\n}\n\n}\n\n10.\t If\tyou\twould\tlike\tto\tdestroy\tthe\tgeolocation\tapplication\tcompletely,\tuse\tthe DELETE\tmethod\ton\tthe\tURL\tv2apps/geolocation.\tThe\tresponse\tof\tthe DELETE\trequest\tis\tusually\tsimilar\tto\tthat\tof\tthe\tGET\trequest,\tlisting\tthe application\tdetails\tand\tthe\ttasks\tthat\twere\tstopped\tby\tthis\tDELETE\trequest. Here's\tthe\tcommand: curl\t-X\tDELETE\thttp://192.168.99.100:8080v2apps/geolocation\n\nNote\n\nThere\tare\tseveral\tways\tof\timplementing\tcontinuous\tdeployment\tto Marathon\tfrom\ttools\tsuch\tas\tJenkins,\tHudson,\tand\tother\tCI\ttools.\tOne\tsuch option\tis\tdoing\tthe\tsame\tthing\twe\tdid\there:\tuse\tCURL.\tYou\tcan\twrite\tshell scripts\tthat\tdeploy\tthe\tapplication\tto\tMarathon\tusing\tthe\tcurl\tcommand after\tyour\tbuilds\tpass.\tThe\tother\tapproach\tis\twriting\tcustom\tbuild framework\tplugins,\tsuch\tas\tthe\tMaven\tMarathon\tor\tGradle\tMarathon plugins.\tI'll\tleave\tthat\tup\tto\tyou\tto\ttry\tout.\n\nTo\tlearn\thow\tto\twrite\ta\tMaven\tplugin,\ttake\ta\tlook\tat\tthis\tpage: https://maven.apache.org/guides/plugin/guide-java-plugin- development.html\t.\n\nTo\tlearn\thow\tto\twrite\ta\tGradle\tplugin,\ttake\ta\tlook\tat\tthis\tpage: https://docs.gradle.org/current/userguide/custom_plugins.html\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe\tand\tthe\tchapter.\tYou\tare\tnow\tready\tto manage\tyour\town\tMesos\tcluster\tand\tmanage\tyour\tapplications\ton\ta\tMesos cluster\tusing\tMarathon.\tGood\tluck\tusing\tMesos\tand\tMarathon!\n\ncluster\tusing\tMarathon.\tGood\tluck\tusing\tMesos\tand\tMarathon!\n\nChapter\t4.\tDeploying\tMicroservices on\tKubernetes\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tdeploy\tmicroservices\ton\tKubernetes,\twhich is\tan\topen\tsource\tframework\tfrom\tGoogle\tfor\torchestrating\tand\tmanaging containers.\tWe\twill\tcover\tthe\tfollowing\trecipes:\n\nSetting\tup\ta\tKubernetes\tcluster\tusing\tDocker Understanding\tthe\tKubernetes\tdashboard Deploying\tyour\tmicroservice\ton\tKubernetes Configuring\tports\tin\tKubernetes Configuring\tvolumes\tin\tKubernetes Configuring\tenvironment\tvariables\tin\tKubernetes Scaling\tyour\tmicroservice\tin\tKubernetes Destroying\tyour\tmicroservice\tin\tKubernetes Monitoring\tyour\tmicroservice\tlogs\tin\tKubernetes",
      "page_number": 134
    },
    {
      "number": 4,
      "title": "Deploying\tMicroservices on\tKubernetes",
      "start_page": 231,
      "end_page": 296,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nBefore\twe\tjump\tinto\tthe\trecipes,\tit\tis\tvery\timportant\tthat\tyou\tknow\twhat Kubernetes\tis\tand\twhy\twe\tuse\tit\tto\tdeploy\tmicroservices.\n\nIf\tyou've\tread\tthe\tprevious\tchapter,\tyou\twill\tunderstand\twhy\twe\tneed\ta clustering\tframework\tlike\tMesos.\tJust\tas\tMesos\tis\ta\tclustering\tframework\tfrom the\tApache\tfoundation,\tKubernetes\tis\ta\tcontainerization\tplatform\tfrom\tGoogle that\tlets\tyou\torchestrate\tand\tmanage\tcontainers.\tIt\tis\tsimilar\tto\tthe\tMesos\tand Marathon\tcombo.\tIt\tcomes\twith\tall\tthe\tfeatures\tyou\twill\tneed\tto\tdeploy containers,\tsuch\tas\tscaling,\tload\tbalancing,\tdeploying,\tand\tmonitoring.\tOne more\tthing\tKubernetes\tdoes\tcompared\tto\tMesos\tis\tthat\tit\tlets\tyou\tdeploy\trkt containers.\tBut\twith\tMesos'\trecent\trelease,\tthey\thave\tadded\tunified\tcontainerizer support,\twhich\twill\tlet\tMesos\tdeploy\tnot\tjust\tDocker\tcontainers,\tbut\talso\trkt containers.\tRkt\t(pronounced\t\"rock\tit\")\twas\tinitially\tdeveloped\twith\tthe\tintent\tof providing\ta\tmuch\tmore\tsecured\tcontainerizing\tframework.\tOne\tthing\tto\tnote here\tis\tthat\trkt\tis\tan\timplementation\tof\tappc.\tIt\tis\tstrongly\trecommended\tthat you\tread\tabout\tappc\tbefore\tyou\tmove\ton\tto\tthe\tnext\tsection.\tWe\twill\tnot\tbe discussing\tappc\tas\tit\tis\tout\tof\tthe\tscope\tof\tthis\tbook\n\nNote\n\nTo\tlearn\tmore\tabout\tApp\tContainer\t(appc),\tvisit\ttheir\tGitHub\tspecifications page,\twhich\thas\tlot\tof\tuseful\tinformation,\tat\t\thttps://GitHub.com/appc/spec\t.\n\nWith\tthat\tsaid,\tyou\tshould\tnow\thave\tunderstood\tthat\tKubernetes,\tor\tK8s\t(the\t8 stands\tfor\tubernete)\twill\thelp\tus\tdeploy\tand\tmanage\tour\tmicroservices.\tThat's right;\tin\tthis\tchapter,\twe\twill\tlearn\thow\tto\twork\twith\ta\tKubernetes\tcluster.\n\nNow\tlet's\ttake\ta\tmoment\tto\tunderstand\tthe\tvarious\tcomponents\tthat\tmake\tup\tthe Kubernetes\tcluster.\tWe\twill\tnot\tbe\tgoing\tdeep\tinto\teach\tand\tevery\tcomponent\tof Kubernetes\tas\tit\tis\tout\tof\tscope\tfor\tthis\tbook.\tInstead,\twe\twill\tjust\ttry\tto understand\tthe\tvarious\tcomponents\tand\ttheir\tusage.\tSimilar\tto\tMesos, Kubernetes\talso\tfollows\ta\tmaster-slave\tarchitecture.\tSo,\tobviously,\tthere\tis\ta master\tthat\tis\tresponsible\tfor\tscheduling\tthe\tcontainers\ton\tto\tone\tor\tmore\tslaves. But\tunlike\tMesos,\tin\tKubernetes,\tcontainers\tare\torganized\tin\tsmaller\tmortal units\tcalled\tpods.\tPods\t(or\tcontainers\tin\tdifferent\tpods,\tto\tbe\tprecise)\tcan\n\ncommunicate\tusing\tservices.\tTake\ta\tlook\tat\tthe\tfollowing\tdiagram:\n\nAs\tyou\tcan\tsee,\ta\tsimple\tKubernetes\tcluster\tis\tcomposed\tof\tseveral\tcomponents. Let's\tbreak\tit\tdown\tinto\tmultiple\tcomponents\tand\tsee\twhat\tthey\tare\tused\tfor\tone by\tone.\n\nKubernetes\tmaster\n\nThe\tKubernetes\tmaster\tconsists\tof\tfour\tmajor\tsubcomponents\tthat\tenable\tthe functions\tof\ta\tKubernetes\tcluster.\tIn\tthe\tprevious\tdiagram,\twe\tonly\thave\tone master.\tBut\tin\tan\tideal\tproduction\tinfrastructure,\tit\tis\tnormal\tto\thave\tmultiple masters\tin\torder\tto\tprovide\thigh\tavailability.\tNow\tlet's\ttake\ta\tlook\tat\tthe\tfour different\tcomponents\tof\tthe\tmaster.\n\nAPI\tserver\n\nThe\tmaster\tAPI\tserver\tis\tresponsible\tfor\thandling\tand\tconfiguring\tthe\tdata\tfor pods,\tservices,\tand\treplication\tcontrollers.\tThe\tAPI\tserver\tholds\tthe\tREST endpoints\tthat\tcan\tbe\tused\tto\ttalk\tto\tthe\tcluster.\n\netcd\n\nThe\tetcd\tservice\tis\tused\tas\ta\tpersistent\tstorage\tto\thold\tthe\tstate\tof\tthe\tmaster.\tIn general,\tetcd\tis\ta\tdistributed\tkey-value\tstore\tthat\tuses\tthe\tRaft\tprotocol.\tIt\tis most\tcommonly\tused\tin\tcases\twhere\tthere\tare\tmultiple\tnodes\tin\ta\tcluster\ttrying to\tshare\tconfigurations.\tKubernetes\trelies\theavily\ton\tetcd\tfor\tstoring\tthe\tmaster's state\tas\twell\tas\tfor\tHA\tconfigurations.\n\nNote\n\nIf\tyou\twould\tlike\tto\tknow\tmore\tabout\tetcd,\tthen\tplease\ttake\ta\tlook\tat\ttheir website\t\t\thttps://coreos.com/etcd\t.\n\nScheduler\n\nSimply\tput,\tthe\tscheduler\tis\tused\tto\tbind\tany\tunbound\tpods\tto\tthe\tnodes.\tThere is\ta\tlot\tgoing\ton\tbehind\tthe\tbinding\tprocess,\tsuch\tas\tpriorities\tand\tpredicates.\tAs it\tis\tout\tof\tscope\tfor\tthis\tbook,\twe\twill\tnot\tbe\tdiscussing\tthem\tnow.\n\nNote\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tthe\tbinding\tprocess,\ttake\ta\tlook\tat\tthis GitHub\treadme\tat\t https://github.com/kubernetes/community/blob/master/contributors/devel/scheduler.md .\n\nController\tmanager\n\nThe\tcontroller\tmanager\titself\tis\tcomposed\tof\tseveral\tcontrollers,\tsuch\tas\ta replication\tcontroller,\tendpoint\tcontroller,\tand\tnamespace\tcontroller,\twhich\thelp in\tmaintaining\tthe\tstate\tof\tthe\tcluster\tby\twatching\tfor\tany\tchanges\tto\tthe\tstates in\tetcd.\tFor\texample,\tthe\treplication\tcontroller\tis\tresponsible\tfor\treplicating\tpods across\tnodes,\talso\tknown\tas\tpod\treplicas.\n\nKubernetes\tnode\n\nKubernetes\tnodes\tare\tsimilar\tto\tMesos\tslaves\t(or\tagents),\twhich\tare\tresponsible for\tholding\tpods\tand\ttheir\tcontainers.\tNodes\tcan\tbe\teither\tphysical\tservers\tor virtual\tmachines.\tEarlier,\twe\twere\tintroduced\tto\ta\tnew\tterm\tcalled\tPod.\tIn\tvery simple\tterms,\ta\tpod\tis\tjust\ta\tgroup\tof\tcontainers\tin\tthe\tsame\tlogical\thost.\tWith that\tsaid,\tcontainers\tin\tthe\tsame\tpod\tshare\tthe\tsame\tIP\tand\tpool\tof\tports.\tIn order\tto\trun\ta\tDocker\tcontainer\ton\ta\tKubernetes\tnode,\tthe\tnode\tfirst\tneeds Docker\tinstalled\ton\tit.\tThat's\twhat\tyou\tsee\tin\tthe\tdiagram.\n\nIn\taddition\tto\tDocker,\ta\tnode\thas\ttwo\tother\tcomponents:\tkubeproxy\tand kubelet.\tLet's\ttalk\tabout\tthem\tone\tby\tone.\tBefore\twe\ttry\tto\tunderstand\twhat\ta kubeproxy\tis,\twe\thave\tto\tknow\tabout\tKubernetes'\tservices.\tNow\tthat\twe\tknow containers\treside\tin\tpods,\tand\tpods\tcan\tbe\treplicated\tacross\tnodes.\tWhat\tif\tyou have\tan\tapplication\tthat\tis\tscaled\tto\ta\tfactor\tgreater\tthan\tone\tand\tyou\twould\tlike to\tload-balance\tbetween\tthe\tcontainers?\tThat's\twhere\tKubernetes'\tservices\tcome in.\n\nKubernetes\tservices\tare\tjust\tabstractions\tof\tpods\tthat\tdefine\tpolicies\tto\taccess them.\tServices\tare\tusually\tidentified\tby\tlabels\ton\tthe\tpods.\tThe\tservice\tand\tthe kubeproxy\ttogether\twork\twith\tthe\tDNS\tserver\tto\tperform\tload\tbalancing\ton requests\tto\tservices\t(containers).\n\nA\tkubelet\tis\tan\tagent\tthat\truns\ton\teach\tnode.\tThe\tkubelet\tis\tresponsible\tfor maintaining\ta\tYAML\tmanifest\tfile\tthat\tdescribes\tthe\tpods.\tIt\tis\talso\tresponsible for\trunning\tthe\tcontainers\tand\tmake\tsure\tthey\tare\tup\tand\trunning\tall\tthe\ttime.\n\nThat\twas\ta\tvery\tquick\tand\tsimple\tillustration\tof\ta\tKubernetes\tcluster.\tOf\tcourse, the\tfunctioning\tand\tinternals\tof\ta\tKubernetes\tcluster\tare\tmuch\tmore\tcomplicated and\tsophisticated\tthan\twhat\twe've\ttalked\tabout\there.\tBut\tour\tgoal\tfor\tnow\tis\tto understand\tthe\tcomponents\tand\tconstruction\tof\ta\tKubernetes\tcluster.\tWith\tthat\n\nunderstand\tthe\tcomponents\tand\tconstruction\tof\ta\tKubernetes\tcluster.\tWith\tthat said,\tlet's\tmove\ton\tto\tour\tfirst\trecipe,\twhere\twe\twill\tlook\tat\tdifferent\tways\tto orchestrate\ta\tKubernetes\tcluster.\n\nSetting\tup\tKubernetes\tcluster\tusing Docker\n\nWe\tnow\thave\ta\tbasic\tunderstanding\tof\tKubernetes\tand\tits\tcomponents.\tThough this\tis\tsufficient\tto\tget\tstarted\twith\tour\trecipes,\tit\tis\tstrongly\trecommended\tthat you\tlearn\tmore\tabout\tKubernetes\tfrom\tGoogle's\tdocumentation\tat http://kubernetes.io/docs/\tbefore\tyou\tstart\tusing\tKubernetes\tat\tscale.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\torchestrate\ta\tlocal\tDockerized\tKubernetes\tcluster.\n\n1.\t The\teasiest\tway\tto\tcreate\ta\tKubernetes\tcluster\tat\tscale\tis\tusing\tGoogle Cloud\tPlatform\tat\thttps://cloud.google.com/container-engine\t.\tIf\tyou\thave\ta Google\taccount,\tyou\tshould\tbe\table\tto\tuse\tGoogle\tCloud\tPlatform\tright away.\tBut\tfor\tsimplicity,\tin\tthis\trecipe,\twe\twill\tbe\tbuilding\tour\tKubernetes cluster\ton\tour\tlocal\tmachines\tusing\tDocker.\n\n2.\t There\tare\tseveral\tways\tto\trun\ta\tDockerized\tKubernetes\tcluster,\tincluding but\tnot\tlimited\tto:\n\nBuilding\tour\town\tDocker\tCompose\tfile Using\tkid Using\tMinikube\n\n3.\t Building\tour\town\tDocker\tCompose\tfile\tmight\ttake\tlonger\tcompared\tto using\tkid\tand\tMinikube.\tKid\tstands\tfor\tKubernetes\tin\tDocker.\tIt\tis\ta\tthird- party\tscript\tthat\twill\tspin\toff\ta\tKubernetes\tcluster\tusing\tDocker.\tMinikube is\tKubernetes'\trecommended\tmethod\tfor\tcreating\ta\tsingle-node\tcluster\ton the\tlocal\tmachine.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tMinikube\tand\tkubectl\tto orchestrate\tand\tmanage\tour\tlocal\tsingle-node\tKubernetes\tcluster.\tkubectl is\ta\tCLI\tfor\tmanaging\tKubernetes\tclusters.\n\nNote\n\nBefore\tyou\tstart\tusing\tkubectl,\tit\tis\tstrongly\trecommended\tthat\tyou\tread its\tmanual\tpages.\tA\tvery\tdescriptive\toverview\tof\tkubectl\tis\tgiven\there\tat\t http://kubernetes.io/docs/user-guide/kubectl-overview\t.\n\n4.\t One\tof\tthe\tprerequisites\tfor\trunning\tMinikube\tis\tOracle\tVirtualBox.\tYou should\talready\thave\tit\ton\tyour\tlocal\tmachine\tif\tyou\tare\tusing\tdocker- machine.\tIf\tyou\tare\tusing\tnative\tDocker,\tyou\tmight\thave\tto\tinstall\tthe\tmost recent\tversion\tof\tVirtualBox. Note\n\nYou\tcan\tdownload\tand\tfind\tinstallation\tinstructions\tfor\tVirtualBox\there at\thttps://www.virtualbox.org/wiki/Downloads.\n\nHow\tto\tdo\tit...\n\nMinikube\tis\tmaintained\tby\tthe\tKubernetes\tcommunity.\tInstalling\tit\tis\tas\tsimple as\trunning\ta\tshell\tscript.\tThe\tinstallation\tinstructions\tfor\tMinikube\tare\tusually included\tin\tthe\trelease\tpage\tof\teach\tversion.\tYou\tcan\tfind\tthe\tinstructions\tfor\tthe most\trecent\tversion\there:\thttps://GitHub.com/kubernetes/minikube/releases\t.\tAt the\ttime\tof\twriting\tthis,\tthe\tmost\trecent\tversion\tof\tMinikube\tis\tv0.12.0.\tYou could\tinstall\tthe\tmost\trecent\tversion.\tThis\tpage\thas\tinstructions\tfor\tOS\tX,\tLinux, and\tWindows.\n\nIn\tthis\trecipe,\tyou\twill\tfind\tinstructions\tfor\tOS\tX.\tYou\tshould\tfollow\tthe\tright instructions\tfor\tyour\toperating\tsystem.\n\n1.\t Open\ta\tterminal\twindow\tand\texecute\tthe\tfollowing\tcommand,\n\ncurl\t-Lo\tminikube\t https://storage.googleapis.com/minikube/releases/v0.12.0/miniku be-darwin-amd64\t&&\tchmod\t+x\tminikube\t&&\tsudo\tmv\tminikube\t usrlocal/bin/\n\n2.\t This\tcommand\tdoes\tthree\tthings:\n\nDownload\tthe\tminikube\tpackage Add\texecute\tpermissions\tto\tthe\tminikube\tbinary\tfile\tfor\tall\tusers Move\tthe\tminikube\tbinary\tfile\tto\tusrlocal/bin\n\n3.\t If\tyou\tare\tfamiliar\twith\tthe\tLinux\tenvironment,\tyou\tshould\talready understand\tthe\tcommand.\tThe\t&&\toperator\texecutes\tthe\tsecond\tcommand only\twhen\tthe\tfirst\tis\tsuccessful.\tThe\tfirst\ttwo\tcommands\tare\tpretty\tself- explanatory.\tThe\tthird\tcommand\tis\trequired\tso\tyou\tdon't\thave\tto\tconfigure your\tPATH\tvariable\teach\ttime\tyou\topen\ta\tnew\tterminal.\tUpon\texecution, you\tshould\tsee\tsomething\tlike\tthis:\n\n4.\t If\tyou\tare\tprompted\tfor\tyour\tpassword,\ttype\tit.\tIt\tmight\tbe\trequired\tto\trun the\tmv\tcommand\tas\tit\tis\texecuted\twith\tsudo\tpermissions.\n\n5.\t Now\tlet's\tverify\tthat\twe\thave\tthe\tminikube\tpackage\tinstalled\tsuccessfully. Go\tahead\tand\tissue\tthe\tfollowing\tcommand\tfrom\tthe\tsame\tterminal\n\nwindow:\n\nminikube\n\n6.\t You\tshould\tsee\tsomething\tlike\tthis:\n\nNote\n\nTake\ta\tfew\tminutes\tto\tget\tfamiliar\twith\tthe\tMinikube\tcommands.\tIf\tyou would\tlike\tto\tknow\tmore\tabout\tMinikube,\tread\ttheir\tdocumentation: https://github.com/kubernetes/minikube/blob/master/README.md.\n\nIf\tyou\tlook\tat\tthe\tpossible\tcommands\tin\tMinikube\tfrom\tthe\tscreenshot,\tyou can\tsee\tthat\tMinikube\tby\titself\tis\tjust\tused\tfor\torchestrating\ta\tcluster.\tWhen it\tcomes\tto\tmanaging\tthe\tcluster\titself,\tyou\twill\tneed\tsomething\tlike kubectl.\tFortunately,\tminikube\tcan\twork\talong\twith\tkubectl\tif\tyou\thave\tit installed.\n\n7.\t So\tlet's\tinstall\tkubectl.\tIn\tthe\tsame\tterminal\twindow,\texecute\tthe\tfollowing command:\n\ncurl\t-LO\thttps://storage.googleapis.com/kubernetes- release/release/$(curl\t-s\t https://storage.googleapis.com/kubernetes- release/release/stable.txt)/bin/darwin/amd64/kubectl\t&&\tchmod\t +x\t./kubectl\t&&\tsudo\tmv\t./kubectl\tusrlocal/bin/kubectl\n\n8.\t The\tpreceding\tcommand\tis\tvery\tsimilar\tto\tthe\tcommand\twe\tused\tto\tinstall minikube.\tIt\thas\tthree\tcommands\texecuted\tone\tafter\tthe\tother:\tthe\tfirst command\tdownloads\tthe\tmost\trecent\tversion\tof\tkubectl\tbinary,\tthe\tsecond command\tadds\texecute\tpermissions\tto\tthe\tbinary\tfile\tfor\tall\tusers,\tand\tthe third\tcommand\tmoves\tthe\tkubectl\tfile\tto\tthe\tusrlocal/bin\tdirectory\tso that\tyou\tdon't\thave\tto\tconfigure\tyour\tPATH\tto\tinclude\tthe\tkubectl\tbinary each\ttime\tyou\topen\ta\tnew\tterminal. Note\n\nAlternatively,\tif\tyou\tare\ta\tMac\tOS\tX\tuser,\tyou\tcould\talso\tuse\tHomebrew\tto install\tkubectl.\tThis\tway,\tyou\tdon't\thave\tto\tworry\tabout\tpermissions\tand configuring\tthe\tPATH\tas\tHomebrew\ttakes\tcare\tof\tthat\tfor\tyou.\tTo\tinstall kubectl\tvia\tHomebrew,\tall\tyou\thave\tto\tdo\tis\trun\tthis\tsimple\tHomebrew command:\tbrew\tinstall\tkubectl\n\n9.\t To\tverify\tthat\tyou\thave\tkubectl\tinstalled\tcorrect,\texecute\tthe\tfollowing command\ton\tthe\tsame\tterminal:\n\nkubectl\n\n10.\t Remember\tto\ttake\ta\tmoment\tto\tread\tthrough\tthe\tmanual\tpages\tof\tkubectl. It\tis\ta\tvery\tpowerful\tCLI\ttool\tthat\tis\tcapable\tof\tmanaging\tyour\tentire Kubernetes\tcluster.\tWith\tthat\tsaid,\tlet's\tcreate\tour\tfirst\tKubernetes\tcluster. Issue\tthe\tfollowing\tcommand: minikube\tstart\n\n11.\t It\tusually\ttakes\ta\tfew\tminutes\tto\tstart\tyour\tcluster\tbecause\tbehind\tthe scenes,\tMinikube\ttries\tto\tcreate\ta\tnew\tVirtualBox\tVM\twith\tall\tnecessary tools\tand\tsoftware\tinstalled\ton\tit.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nStarting\tlocal\tKubernetes\tcluster... \t\t\t\t\t\t\t\tKubectl\tis\tnow\tconfigured\tto\tuse\tthe\tcluster.\n\n12.\t As\tyou\tcan\tsee,\tkubectl\tis\tnow\tconfigured\tto\tuse\tthe\tcluster\tthat\twas\n\ncreated\tby\tMinikube.\tNow\tthat\twe\thave\tour\tcluster\trunning\tlocally,\tlet's make\tsure\tour\tcluster\tis\tup\tand\trunning.\tOne\tway\tto\tdo\tthis\tis\tlisting\tall\tthe Docker\tcontainers\trunning\ton\tthe\tVirtualBox\tVM.\tIn\torder\tto\tdo\tthat,\tyou need\tto\tperform\tan\textra\tstep.\tGo\tahead\tand\trun\tthe\tfollowing\tcommand:\n\neval\t$(minikube\tdocker-env)\n\n13.\t This\teval\tcommand\tsets\tyour\tDocker\tvariables\tto\twork\twith\tthe\tminikube VM.\tIf\tyou\tare\tcurious\tabout\tthe\tminikube\tVM,\topen\tup\tVirtualBox,\tand you\tshould\tsee\ta\tnewly\tcreated\tVM\tcalled\tminikube.\tNow\tthat\tour environment\tis\tset,\tissue\tthe\tfollowing\tcommand\tto\tlist\tall\tthe\tDocker containers\tthat\tare\trunning: docker\tps\t-a\n\n14.\t You\tshould\tbe\table\tto\tsee\tthe\tcontainers\trunning\ton\tthe\tminikube\tVM:\n\n15.\t As\tyou\tcan\tsee,\tthere\tis\tone\tcontainer\tcalled\tkube-addon-manager\tand\ttwo containers\tfor\tthe\timage\tpause-amd64.\tThe\taddon-manager\tcontainer makes\tsure\tall\tthe\tadd-ons\tare\tupdate\tas\tper\tthe\tKubernetes\tmanifest. Note\n\nTo\tlearn\tmore\tabout\tadd-ons,\ttake\ta\tlook\tat\tthis\tGitHub\tpage https://github.com/kubernetes/kubernetes/tree/master/cluster/addons\t.\n\n16.\t The\tpause\tcontainer\tis\tsomething\tspecial.\tIt\tis\tresponsible\tfor\tstoring\tthe network\tinformation\tfor\tany\tnew\tpod.\tIn\tour\tcluster,\tthere\tare\ttwo\tpause containers,\tmeaning\tthere\tcould\tpotentially\tbe\ttwo\tpods\teven\tbefore\twe create\tone.\tWe\twill\ttake\ta\tlook\tat\tthem\tin\tthe\tnext\trecipe.\n\n17.\t The\tother\tcomponents\twill\tbe\talready\tinstalled\ton\tthe\tminikube\tVM.\tIf\tyou want\tto\tbe\tvery\tsure\tabout\twhether\tor\tnot\tyour\tcluster\tis\trunning,\tyou\tcan execute\tthe\tminikube\tstatus\tcommand.\tIt\twill\tspit\tout\tsomething\tlike\tthis:\n\nminikubeVM:\tRunning localkube:\tRunning\n\n18.\t We\tknow\tthat\tminikubeVM\tindicates\tthe\tVirtualBox\tVM.\tlocalkube\tis\n\nnothing\tbut\tthe\tname\tof\tour\tKubernetes\tcluster.\tYou\tcan\tstop\tyour\tcluster by\tissuing\tthe\tfollowing\tcommand:\n\nminikube\tstop\n\n19.\t This\twill\tshut\tdown\tthe\tminikube\tVM\tin\tVirtualBox.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tCongratulations!\tYou\thave\tsuccessfully created\tyour\tfirst\tKubernetes\tcluster.\n\nUnderstanding\tthe\tKubernetes dashboard\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tstart\tand\tstop\tour\tlocal\tsingle-node Kubernetes\tcluster.\tWe\tcall\tit\ta\tsingle-node\tcluster\tbecause\tit\twill\tjust\thave\tone Kubernetes\tnode\tconfigured.\tSo\tall\tthe\tcontainers\tthat\tyou\tdeploy\tare\tgoing\tto be\tdeployed\ton\tthis\tsingle\tKubernetes\tnode.\tKubernetes\tcomes\twith\ta sophisticated\tweb\tUI.\tThe\tweb\tUI\tacts\tas\tan\tadministration\tconsole\tfor\tyour cluster.\tYou\tcan\tperform\talmost\tall\toperations\tthat\tyou\tcan\twith\tkubectl,\ton\tthe web\tUI.\tIn\tfact,\tyou\tcould\talso\tmonitor\tthe\tresource\tutilization\tof\tyour\tcluster from\tthe\tweb\tUI.\tIn\tthis\trecipe,\twe\tare\tgoing\tto\tget\tfamiliar\twith\tthe\tKubernetes dashboard\tso\tthat\twe\tcan\teasily\tmanage\tour\tmicroservice\ton\tany\tKubernetes cluster.\n\nGetting\tready 1.\t The\tfirst\tthing\tyou\tneed\tto\tknow\tis\tthe\tURL\tto\tthe\tKubernetes\tUI\n\ndashboard.\tOne\tway\tto\tdo\tthat\tis\tidentifying\tthe\tIP\tof\tyour\tminikube\tVM and\tuse\tthe\tdefault\tKubernetes\tdashboard\tport,\t30000.\n\n2.\t To\tfind\tthe\tIP\tof\tyour\tminikube\tVM,\trun\tthe\tfollowing\tcommand\ton\tyour terminal:\tminikube\tip\n\n3.\t After\tyou\tget\tthe\tIP,\tuse\tthe\tport\tnumber\t30000\tto\taccess\tthe\tKubernetes dashboard\tfrom\tyour\tweb\tbrowser.\n\nThough\tthis\tapproach\tworks\tmost\tof\tthe\ttime,\twe're\tstill\tmaking\tan\tassumption about\tthe\tport\tnumber.\tWhat\tif\tthe\tdefault\tport\tnumber\tchanges?\tSo\tlet's\tsee\tthe other\tway\tto\topen\tour\tdashboard.\n\nHow\tto\tdo\tit... 1.\t Fortunately,\tMinikube\tcomes\twith\tan\teasy-to-use\tcommand\tthat\twhen\n\nexecuted\tin\tyour\tterminal\twill\tautomatically\topen\tthe\tdashboard\tin\tyour default\tweb\tbrowser.\tLet's\ttry\tthat\tout:\tminikube\tdashboard\n\n2.\t If\tyour\tcluster\tis\talready\trunning,\tyou\tshould\tsee\tthe\tdashboard\tin\tyour\tweb browser.\tSometimes,\tif\tyou\ttry\tto\trun\tthis\tcommand\tright\tafter\tyour minikube\tstart\tcommand,\tit\tmight\ttake\ta\twhile\tto\topen\tup.\tIdeally,\tit pings\tthe\tcluster\tstatus\tAPI\tto\tcheck\tthe\tstatus\tof\tyour\tKubernetes\tcluster. On\tyour\tbrowser,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nTo\tbetter\tunderstand\tthe\tinterface,\tlet's\tspin\toff\ta\tsimple\techoserver\tcontainer\n\non\tKubernetes.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal:\tkubectl\trun hello-minikube\t--image=gcr.io/google_containers/echoserver:1.4\n\nFor\tnow,\tlet's\tnot\tdig\tdeeper\tinto\thow\tthe\tcommand\tworks.\tAll\twe\tdid\twas spin\toff\ta\tsimple\techoserver\tcontainer.\tWe\tare\tdoing\tthis\tonly\tto\tpopulate\tthe UI\twith\tsome\tinformation.\tWe\twill\tdig\tdeeper\tinto\thow\tto\trun\ta\tcontainer\tin\tour next\trecipe.\tYou\tshould\tget\ta\tresponse\tsimilar\tto\tthis:\tdeployment\t\"hello- minikube\"\tcreated\n\nNow\tgo\tto\tthe\tdashboard\tand\trefresh\tthe\tWorkloads\tpage.\tYou\tshould\tnow\n\nsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tthere\tare\tthree\tsections:\n\nDeployments Replica\tsets Pods\n\nDeployments\tshows\tall\tthe\tcontainers\tthat\tare\tdeployed\ton\tyour\tpod.\tA\treplica set\tis\tnothing\tbut\tthe\tnext\tgeneration\tof\treplication\tcontroller.\tReplica\tsets sections\tshows\tthe\tdifferent\treplicas\tof\tyour\tcontainers.\tThe\tPods\tsection,\tas\tits name\tindicates,\tshows\tall\tthe\tpods\tthat\tare\tcurrently\tavailable\tin\tyour\tcluster.\n\nInstead\tof\tgoing\tinto\tthese\tindividual\tsections\ton\tthe\tleft-hand\tside\tpane,\tlet's go\tdirectly\tto\tthe\titems\tlisted\tin\teach\tof\tthese\tsections.\tFirst,\tlet's\tstart\twith\tthe hello-minikube\tdeployment\tby\tclicking\ton\tthe\thello-minikube\tdeployment item\tfrom\tthe\tDeployments\tgrid.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nSome\tsections\thave\tbeen\tignored\tin\tthe\tpreceding\tscreenshot\tto\tfocus\tjust\ton\n\nthe\tmost\timportant\tsections\tand\tthe\tones\tyou\twill\tbe\tusing\tvery\toften.\tThe Details\tsection\tis\twhere\tyou\twill\tfind\tthe\thigh-level\tdetails\tabout\tyour\tDocker container\tdeployment.\tNote\tthe\tword\t\"deployment\"\tin\tthe\tprevious\tstatement.\tIf you\twant\tto\tsee\tdetails\tabout\tthe\tDocker\tcontainer\titself,\tyou\twill\thave\tto\ttake\ta look\tat\tthe\tNew\tReplica\tSet\tsection.\tNote\tthe\tlabels\tassociated\twith\tthe deployment\tas\twell\tas\tthe\treplica\tset.\tThese\tlabels\twere\tauto-generated\tby Kubernetes\twhen\tyou\tdeployed\tthe\tcontainer\tusing\tkubectl.\n\nYou\tcan\tgo\tto\tthe\tReplica\tSets\tsection\tby\tusing\tthe\tReplica\tSets\toption\tin\tthe\n\nleft-hand\tside\tmenu\tor\tby\tclicking\ton\tthe\thello-minikube-2713628163\treplica set\ton\tthe\tDeployments\tpage.\tEither\tway,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nThe\tDetails\tsection\tis\twhere\tyou\twill\tfind\tthe\tcontainer\tinformation,\tsuch\tas image\tname,\tversion,\tstatus,\tand\treplica\tset\tname.\tThe\tPods\tsection\tlists\tall\tthe pods\ton\twhich\tthis\tcontainer\thas\tbeen\tdeployed\tor\treplicated.\tIt\talso\tshows\tthe status\tof\tthe\tpod\tand\tits\town\tIP\taddress.\tIf\tyou\thad\tthe\tapp\tin\tmultiple\tpods,\tyou will\tsee\tall\tthe\tpods\tlisted\there\twith\ttheir\tunique\tIPs\taddresses.\tThe\tEvents section\tshows\tthe\tvarious\tevents\trelated\tto\tthis\tcontainer\ton\tthe\tcluster.\tThis\tis especially\tuseful\twhen\tyou\tare\tdebugging\tyour\tapplication\tor\tdeployment.\n\nThe\tnext\timportant\tsection\tis\tthe\tPods\tsection.\tYou\tcan\tgo\tto\tthe\tPods\tsection\n\nby\tchoosing\tthe\toption\tin\tthe\tleft-hand\tside\tmenu\tor\tclicking\ton\tthe\thello- minikube-2713628163-x6ge3\tpod\tin\tthe\tPods\tgrid\tof\tthe\tReplica\tSets\tpage.\n\nEither\tway,\tyou\tshould\tend\tup\ton\ta\tpage\tlike\tthis:\n\nThe\ttop\tsection\tshows\tthe\thigh-level\tdetails\tof\tthe\tpod,\tsuch\tas\tname,\tstatus,\n\nlabels,\tstart\ttime,\tand\tnamespace.\tOne\timportant\tdetail\tyou\twill\tfind\tin\tthis section\tis\tthe\tNode\tthat\tthis\tpod\tis\trunning\ton\tand\tthe\tIP\taddress\tof\tthe\tpod.\tThe next\timportant\tscreen\tin\tthe\tdashboard\tis\tthe\tNodes\tsection.\tLet's\tget\tthere\tby clicking\ton\tthe\tnode\tnamed\tminikube.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThe\tscreenshot\tonly\tshows\tpart\tof\tthe\tpage.\tThe\trest\tof\tthe\tpage\twill\tbe\n\ndiscussed\tin\tthe\tnext\tsection.\tThe\tDetails\tand\tSystem\tInfo\tsections\tgive\tyou\ta lot\tof\tuseful\tinformation,\tsuch\tas\tOS,\tversion\tinformation,\tarchitecture,\tand name.\tAllocated\tresources\tshows\tthe\tresource\tallocation\tfor\tthis\tparticular node.\n\nFrom\tthe\tscreenshot,\twe\tcan\tsay\tthat\t0.005\tout\tof\t2\tCPUs\thave\tbeen\tused,\t50 MB\tout\tof\t1.955\tGB\tof\tmemory\thas\tbeen\tused,\tand\t3\tout\tof\t110\tpods\thave\tbeen allocated.\tThe\tmaximum\tnumber\tof\tpods\tallocated\tper\tnode\tis\tset\tto\t110\tdue\tto several\tperformance\treasons.\tHowever,\tthis\tcan\tbe\tchanged\twith\tthe\tkubelet configuration\tmax-pods.\tThe\tremainder\tof\tthe\tpage\tshows\tthe\tvarious\tpods\tthat are\tavailable\ton\tthis\tnode.\tFor\tour\tlocal\tcluster,\tyou\tshould\tbe\table\tto\tsee\tthree pods:\n\nAs\tyou\tcan\tsee,\tthere\tare\ttwo\tadditional\tpods:\tkube-addon-manager-minikube and\tkubernetes-dashboard-xk3ih.\tFrom\tthe\tnames\tof\tthese\tpods,\tit\tis\tpretty obvious\tthat\tkube-addon-manager-minikube\thas\tthe\tadd-on\tmanager\tin\tit\tand kubernetes-dashboard-xk3ih\thas\tthe\tKubernetes\tdashboard\titself\tdeployed. The\tother\ttwo\timportant\tsections\tare\tNamespaces\tand\tPersistent\tVolumes. We\twill\tbe\tlooking\tat\tPersistent\tVolumes\tin\tlater\trecipes\tin\tthis\tchapter.\tLet's take\ta\tlook\tat\tthe\tNamespace\tsection.\tGo\tahead\tand\tclick\ton\tNamespaces\tfrom the\tleft-hand\tside\tmenu.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tthere\tare\ttwo\tnamespaces:\tdefault\tand\tkube-system.\n\nNamespaces\tare\tnothing\tbut\tvirtual\tclusters\tthat\tare\tpart\tof\tthe\tsame\tphysical cluster.\tThe\tdefault\tnamespace\tis\twhere\tthe\tall\tour\tnew\tdeployments\tgo,\tand\tthe\n\nkube-system\tnamespace\tis\twhere\tthe\tdashboard\tand\tadd-on\tmanager\tare deployed.\n\nAll\tthis\ttime,\twe\thave\tbeen\tlooking\tat\tthe\tdefault\tnamespace.\tIf\tyou\twould like\tto\tlook\tat\tthe\tdeployments,\treplication\tcontrollers,\tand\tpods\tin\tthe\tkube- system\tnamespace,\tuse\tthe\tNamespace\tdropdown\tfrom\tthe\tleft-hand\tside\tmenu to\tchoose\tyour\tnamespace.\n\nThat's\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tThe\tgoal\tof\tthis\trecipe\tis\tto\tget\tyou familiar\twith\tthe\tKubernetes\tdashboard\tand\tits\tvarious\tsections.\tKubernetes itself\tis\ta\tvast\ttopic,\tand\tit\tis\tstrongly\trecommended\tthat\tyou\tresearch\tit\tmore before\tyou\tstart\tusing\tit.\n\nDeploying\tyour\tmicroservice\ton Kubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tsuccessfully\torchestrated\ta\tsingle\tnode Kubernetes\tcluster\tusing\tDocker,\tand\twe\thave\tfamiliarized\tourselves\twith\tthe Kubernetes\tdashboard.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tdeploy\tour geolocation\tmicroservice\ton\tour\tKubernetes\tcluster.\n\nGetting\tready\n\nDeploying\ta\tmicroservice\tin\tKubernetes\tcan\tbe\tdone\tin\tseveral\tways.\tWe\tcan use\tkubectl\tto\tsubmit\tour\tdeployment\tto\tthe\tKubernetes\tcluster.\tWe\tcan\talso use\tthe\tdashboard\tto\tcreate\ta\tdeployment\tvia\tthe\tUI.\tIn\tthe\tprevious\trecipe,\twe used\tkubectl\tto\tcreate\ta\tdeployment\tfor\tthe\techoserver\tcontainer.\tIn\tthis recipe,\tlet's\tuse\tthe\tdashboard\tto\tdeploy\tthe\tgeolocation\tmicroservice\tin Kubernetes.\n\nGo\tahead\tand\topen\tup\tthe\tKubernetes\tdashboard\tusing\tthe\tminikube\tcommand:\n\nminikube\tdashboard\n\nHow\tto\tdo\tit... 1.\t To\tcreate\ta\tnew\tdeployment,\tclick\ton\tthe\tCreate\tbutton\tat\tthe\ttop\tright\tof\n\nthe\tdashboard.\tYou\tshould\tsee\ta\tscreen\tsimilar\tto\tMarathon's\tNew Application\tmodal.\tMost\tof\tthe\tproperties\ton\tthis\tscreen\tare\tvery\tsimilar\tto that\tof\tMarathon's,\texcept\tmaybe\tfor\tthe\tterminologies.\tSo\tif\tyou\tare familiar\twith\tusing\tMarathon,\tyou\twill\tfind\tthis\treally\teasy.\n\n2.\t You\twill\tfind\tfour\tmajor\tfields: App\tname Container\tname Number\tof\tpods Service\n\n3.\t In\torder\tto\tdeploy\tour\tgeolocation\tmicroservice,\twe\tjust\tneed\tthe\tapp\tname and\tcontainer\tname.\tWe\twill\tlook\tat\tthe\tnumber\tof\tpods\tand\tservice\tin\tlater recipes\tin\tthis\tchapter.\tGo\tahead\tand\tenter\tgeolocation\tas\tthe\tapplication name\tand\tvikrammurugesan/geolocation:latest\tas\tthe\tcontainer\tname. Please\tchange\tthe\tDocker\tHub\taccount\tname\tfrom\tmine\tto\tyour\taccount name.\tThe\tlatest\ttag\tis\toptional\there,\tas\tit\tdefaults\tto\tthat\tif\tyou\tdon't provide\tone.\n\nIn\tthe\tpreceding\tscreenshot,\tyou\tcan\tsee\tanother\toption\tfor\tcreating\tan application:\tUpload\ta\tYAML\tor\tJSON\tfile.\tThis\tlets\tyou\tupload\tyour\tapp configurations\tin\tthe\tform\tof\ta\tYAML\tor\tJSON\tfile.\tWe\twill\tlook\tat\tthis later\tin\tthis\tchapter;\tfor\tnow,\twe\twill\tuse\tthe\tuser\tinterface\tto\tcreate\tthe application.\n\n4.\t Go\tahead\tand\tclick\ton\tthe\tDeploy\tbutton\twhen\tyou\tare\tdone.\tYou\tshould now\tsee\tthat\tthere\tis\tone\tnew\tapplication\tfor\tgeolocation\tand\ta\tpod associated\twith\tit:\n\n5.\t It\tusually\ttakes\ta\tfew\tseconds\tto\ta\tfew\tminutes\tto\tdeploy\tyour\tapplication. Once\tit\tis\tdone,\tthe\tstatus\ticons\tshould\tshow\ta\tgreen\ttick\ticon,\tindicating\tit is\trunning.\tOnce\tyour\tpod\tand\treplication\tcontroller\tare\tup\tand\trunning, you\twill\tsee\tthat\ta\tnew\tIP\thas\tbeen\tassigned\tto\tyour\tpod.\tThat\tis\tthe\tIP\twe will\tbe\tusing\tto\taccess\tour\tapplication.\tIn\tmy\tcase,\tthe\tIP\tassigned\twas 172.17.0.4.\tSo\twe\twill\tbe\tusing\tthis\tIP\tin\tall\tfuture\treferences\tto\tthe\tpod. 6.\t Now\tthat\tour\tgeolocation\tapplication\tis\trunning,\tlet's\tinvoke\tthe\tGET\tAPI\tof application\tto\tmake\tsure\twe\tget\ta\t200\tresponse\tback.\tGo\tahead\tand\tissue the\tfollowing\tcURL\tcommand\tin\tyour\tterminal\twindow: curl\thttp://172.17.0.4:8080/geolocation \t\t\t\t\t\t\t\tcurl:\t(7)\tFailed\tto\tconnect\tto\t172.17.0.4\tport\t8080:\t Operation\ttimed\tout\n\n7.\t After\ta\tfew\tseconds,\tyour\tconnection\tshould\ttime\tout.\tThat\tis\tbecause\tthe IP\tthat\twe\thave\tused\tis\tan\tinternal\tIP\tand\tcannot\tbe\taccessed\toutside\tour host.\tIn\tthis\tcase,\tthe\thost\tis\tthe\tminikube\tVirtualBox\tVM.\tNow\twe\tclearly know\tthat\twe\tstill\thave\tsome\twork\tto\tdo\twith\trespect\tto\tthe\tports.\tAnd that's\twhat\tyou\twill\tbe\tlearning\tin\tthe\tnext\trecipe.\n\nBut\tbefore\tyou\tjump\tinto\tthe\tnext\trecipe,\tif\tyou\tare\tcurious\tto\tknow\thow\tthe same\tprocess\tcan\tbe\tdone\tusing\tthe\tYAML\tor\tJSON\tfile\tapproach,\tkeep reading:\n\n1.\t First,\tdelete\tthe\treplication\tcontroller\tand\tservice\tfor\tgeolocation.\tDeleting the\treplication\tcontroller\twill\tautomatically\tdelete\tthe\tpod\tand\tthe containers\tin\tthe\tpod.\tAfter\tthey\thave\tbeen\tdeleted,\twe\tnow\thave\tto\tcreate\ta YAML\tfile\twith\tour\tdeployment\tconfigurations.\tOpen\tyour\tSTS\tIDE\tand create\ta\tnew\tYAML\tfile\tcalled\tkube-deployment.yml\tdirectly\tunder\tthe geolocation\tproject\tdirectory.\tPaste\tthe\tfollowing\tcontents\tinto\tthe\tfile:\n\napiVersion:\textensions/v1beta1 \t\t\t\t\t\t\t\tkind:\tDeployment \t\t\t\t\t\t\t\tmetadata: \t\t\t\t\t\t\t\t\t\tname:\tgeolocation \t\t\t\t\t\t\t\tspec: \t\t\t\t\t\t\t\t\t\treplicas:\t1 \t\t\t\t\t\t\t\t\t\ttemplate: \t\t\t\t\t\t\t\t\t\t\t\tmetadata: \t\t\t\t\t\t\t\t\t\t\t\t\t\tlabels: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tapp:\tgeolocation \t\t\t\t\t\t\t\t\t\t\t\tspec: \t\t\t\t\t\t\t\t\t\t\t\t\t\tcontainers: \t\t\t\t\t\t\t\t\t\t\t\t\t\t-\tname:\tgeolocation \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-\tcontainerPort:\t8080\n\nThere\tare\ta\tfew\tthings\tto\ttalk\tabout\tin\tthis\tfile.\tThe\tapiVersion property\tidentifies\tthe\tversion\tof\tthe\textensions\tAPI\tthat\twill\tbe used.\tThe\textensions\tAPI\tis\ta\tsophisticated\tAPI\twith\toperations related\tto\tdaemon\tsets,\tdeployments,\tjobs,\tand\tso\ton.\n\nNote\n\nTo\tread\tmore\tabout\tthe\textensions\tAPI,\tvisit http://kubernetes.io/docs/api-reference/extensions/v1beta1/operations\t.\n\nThe\tkind\tproperty\tidentifies\tthe\tkind\tof\tresource\twe\tare\ttrying\tto create\tin\tKubernetes.\tNote\tthat\there\twe\tare\tcreating\ta\tDeployment, rather\tthan\treplication\tcontroller\tlike\tlast\ttime. The\treplicas\tproperty\tis\tset\tto\t1,\tindicating\tthat\twe\tjust\tneed\tone replica\tof\tthis\tdeployment.\tThe\tcontainer\tname\tis\tgeolocation\tand the\timage\tused\tis\tvikrammurugesan/geolocation:latest.\tPlease don't\tforget\tto\tuse\tthe\timage\tin\tyour\tDocker\tHub\taccount\tinstead\tof the\tauthor's.\tNote\tthat\twe\thave\tlisted\tthe\tcontainer\tport\tas\t8080\tin\tthe\n\nports\tsection,\twhich\tcan\tlater\tbe\texposed\tvia\ta\tservice. We\thave\tadded\ta\tlabel\twith\tthe\tkey\tapp\tand\tvalue\tgeolocation.\tThis label\tcan\tbe\tused\twhen\tyou\tcreate\ta\tservice.\tWe\twill\tsee\thow\tto\tdo that\tafter\twe\tdeploy\tthe\tcontainer.\tSave\tthe\tfile\tand\tclose\tyour\tIDE. 2.\t Go\tahead\tand\tclick\ton\tthe\tCreate\tbutton\tto\tcreate\ta\tnew\tapplication.\tThis\n\ntime,\tchoose\tUpload\ta\tYAML\tor\tJSON\tfile.\tChoose\tthe\tkube- deployment.yml\tfile\tthat\twe\tjust\tcreated\tand\thit\tDeploy:\n\n3.\t As\tyou\tcan\tsee,\tthere\tis\ta\tnew\tdeployment\tcalled\tgeolocation.\tIt\talso created\ta\tpod,\treplication\tset,\tand\treplication\tcontroller.\tThe\tsame\tthing\tcan be\tdone\tusing\tthe\tfollowing\tkubectl\tcommand:\n\nkubectl\tcreate\t-f\tkube-deployment.yml\n\nThis\tcommand-line\tbased\tapproach\tis\trecommended\twhen\tyou\tare\tperforming automated\tdeployments\tusing\tcontinuous\tintegration\ttools\tsuch\tas\tJenkins.\tOne thing\tto\tnote\tin\tthis\tapproach\tis\tthat\tit\twill\tnot\tcreate\ta\tservice\tfor\tyou.\tYou\thave to\tcreate\tthe\tservice\tmanually,\teither\tusing\tkubectl\tor\tfrom\tthe\tdashboard.\tWe will\tlook\tat\thow\tto\tcreate\ta\tservice\tusing\tkubectl\tin\tthe\tnext\trecipe.\tThe\tchoice\n\nof\twhether\tto\tuse\tthe\tdashboard\tor\tkubectl\tdepends\tcompletely\ton\tyour\tusage. That\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tI\thope\tyou\tnow\thave\ta\tgood\thold\ton deploying\tyour\tapplications\ton\tKubernetes.\tIn\tthe\tnext\trecipe,\twe\twill\tlook\tat how\tto\tconfigure\tports\tand\tservices.\n\nConfiguring\tports\tin\tKubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tcreated\tour\town\tKubernetes\tcluster\tand\tdeployed our\tgeolocation\tmicroservice\ton\tthe\tcluster.\tBut\tunfortunately,\twe\twere\tnot\table to\taccess\tour\tmicroservice\tbecause\twe\thaven't\texposed\tour\tports\t(in\tthe dashboard\tmethod)\tor\tcreated\tservices\t(in\tthe\tkubectl\tmethod).\tIn\tthis\trecipe, we\twill\tlearn\thow\tto\tmap\tour\tports\tand\tcreate\tservices.\n\nGetting\tready\n\nWhen\twe\tdeploy\tour\tapplication\tfrom\tthe\tfriendly\tform\tin\tthe\tKubernetes dashboard,\twe\thave\tsome\tadvanced\tsettings\tthat\twe\tcould\tutilize\tto\texpose ports.\tOpen\tthe\tdashboard\tusing\tthe\tminikube\tcommand:\tminikube\tdashboard\n\nDelete\tany\tdeployments,\treplication\tcontrollers,\tor\tservices\tyou\talready\thave\tfor geolocation.\tYou\tcan\tleave\tthe\techoserver\tcontainer\tthat\twe\tcreated\tearlier\tor delete\tit-it\tshouldn't\treally\taffect\tus.\n\nHow\tto\tdo\tit... 1.\t Go\tahead\tand\tcreate\ta\tnew\tapplication.\tEnter\tthe\tapplication\tname\n\ngeolocation\tand\tcontainer\timage\tvikrammurugesan/geolocation:latest. This\ttime,\tconfigure\tan\tinternal\tservice\twith\tsource\tport\t8080,\ttarget\tport 8080,\tand\tprotocol\tTCP.\tThe\tsource\tport\tis\tthe\tport\twe\twill\tuse\tto\taccess the\tservice,\tand\tthe\ttarget\tport\tis\tthe\tport\tthat\tneeds\tto\tbe\texposed\ton\tthe container.\n\nAlso\texpand\tthe\tAdvanced\tOptions\tsection\tto\tgo\tthrough\tthe\tother\toptions that\tKubernetes\toffers.\tScroll\tdown\tto\tthe\tCPU\tsection\tand\tenter\t1\tfor CPU\trequirement.\tProvide\tthe\tvalue\t512\tfor\tMemory\trequirement.\tOnce you\tare\tdone,\thit\tDeploy.\n\n2.\t Now,\tlet's\tverify\tthat\ta\tservice\thas\tbeen\tcreated\tfor\tthis\tport\tmapping.\tIf you\tgo\tto\tthe\tServices\tsection,\tyou\tshould\tsee\ta\tnew\tservice\tcalled geolocation.\tClick\ton\tthat\tto\ttake\ta\tlook\tat\tthe\tservice\tdetails.\tYou\tshould see\tsomething\tlike\tthis:\n\nIf\tyou\tlook\tat\tthe\tConnection\tsection,\tthere\tis\tthis\tfield\tcalled\tCluster\tIP.\tIn the\tscreenshot,\tthe\tCluster\tIP\tis\t10.0.0.20.\tThis\tIP\tis\tthe\tone\tthat\twe\tshould\tbe using\tto\taccess\tour\tgeolocation\tservice\ton\tport\t8080.\tWithout\tfurther\tado,\tlet's open\tup\ta\tterminal.\tOn\tthe\tterminal,\texecute\tthe\tfollowing\tcURL\tcommand: curl\thttp://10.0.0.20:8080/geolocation\tcurl:\t(7)\tFailed\tto\tconnect\tto\t10.0.0.20 port\t8080:\tOperation\ttimed\tout\n\nWhat\thappened\tnow?\tThis\ttime,\tthe\trequest\ttimed\tout\tbecause\talthough\tyou\n\nhave\tthe\tservice\tconfigured\tto\tperform\ta\tport\tmapping\tfrom\tport\t8080\tof\tthe node\tto\tthe\tcontainer,\twe\tare\tstill\ttrying\tto\taccess\tthis\thost\tfrom\tour\tlocal computer.\tSince\tthis\tis\ta\tDockerized\tenvironment,\twe\twill\thave\tto\trun\tthe\tsame command\tfrom\tinside\tthe\tminikube\tVM.\n\nIn\torder\tto\trun\tthis\tcommand\tfrom\tinside\tthe\tVM,\twe\tneed\tto\tSSH\tinto\tthe VM.\tFortunately,\tMinikube\thas\tthe\tability\tto\tSSH\tinto\tthe\tminikube\tVM.\tOn\tthe same\tterminal,\texecute\tthe\tfollowing\tcommand:\tminikube\tssh\n\nYou\tshould\tget\tsomething\tlike\tthis:\t##\t.\t##\t##\t##\t==\t##\t##\t##\t##\t##\t===\n\n\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\\___\t===\t~~~\t{~~\t~~~~\t~~~\t~~~~\t~~~\t/\t===-\t~~ \\______\to\t__/\t\\\t\\\t__/\t\\____\\_______/\t____\t|\t|__\t___\t___\t|\t|_|___\t\\\t__|\t|\t___\t___|\t| ____\t__\t|\t'_\t\\\t_\t\\\t\\|\t_|\t__)\t/\t_`\t|\t_\t\\\t__|\t|/\t/\t\\\t'_|\t|\t|_)\t|\t(_)\t|\t(_)\t|\t|_\t/\t__/\t(_|\t|\t(_)\t|\t(__| <\t__/\t|\t|_.__/\t\\___/\t\\___/\t\\__|_____\\__,_|\\___/\t\\___|_|\\_\\___|_|\tBoot2Docker version\t1.11.1,\tbuild\tmaster\t:\t901340f\t-\tFri\tJul\t1\t22:52:19\tUTC\t2016\tDocker version\t1.11.1,\tbuild\t5604cbe\tdocker@minikube:~$\n\nOnce\tyou\tare\tinside\tthe\tVM,\trun\tthe\tsame\tcURL\tcommand\tagain:\tcurl\n\nhttp://10.0.0.20:8080/geolocation\n\nThis\ttime,\tyou\tshould\tget\tan\tempty\tarray\t([])\tfrom\tthe\tserver,\tindicating\tthat\n\nthere\tare\tno\tgeolocations\tavailable.\tWe\tnow\tknow\thow\tto\taccess\tour\tservice. But\twait;\tthis\tis\tnot\ta\tscalable\tsolution\tbecause\twe\tcan't\tlog\tin\tto\tthe\tVM\teach time\twe\tdeploy\tone\tor\tmore\tservices.\tWe\tshould\tbe\table\tto\taccess\tour\tservices from\tour\tlocal\tcomputer.\tTo\tdo\tthat,\twe\tneed\tsome\tkind\tof\tport\tforwarding mechanism.\tkubectl\thas\tport\tforwarding\tcapability\tthat\tforwards\tany\trequest from\tour\tlocal\tmachine\tto\tthe\tpod.\tIf\twe\tcan\tget\tour\trequest\tto\tthe\tpod,\tthe service\twill\tautomatically\ttake\tcare\tof\tsending\tour\trequest\tto\tthe\tright microservice\thost\tand\tport.\tExit\tfrom\tthe\tminikube\tVM.\n\nBefore\twe\tcan\trun\tthe\tkubectl\tport-forward\tcommand,\twe\tneed\tto\tknow\n\nthe\tname\tof\tthe\tpod.\tWe\tcan\teither\tget\tit\tfrom\tthe\tdashboard\tor\tuse\tthe following\tcommand\tin\tyour\tterminal\twindow:\tkubectl\tget\tpods\n\nYou\tshould\tget\tsomething\tlike\tthis:\tNAME\tREADY\tSTATUS\tRESTARTS\n\nAGE\tgeolocation-qr86h\t1/1\tRunning\t0\t27m\thello-minikube-2713628163- x6ge3\t1/1\tRunning\t0\t1d\n\nNow\tthat\twe\tknow\tthe\tpod\tname,\tissue\tthe\tfollowing\tkubectl\tcommand\tfrom the\tsame\tterminal\twindow:\tkubectl\tport-forward\tgeolocation-qr86\t8085:8080 Forwarding\tfrom\t127.0.0.1:8085\t->\t8080\tForwarding\tfrom\t[::1]:8085\t-> 8080\n\nIn\tthis\tcommand,\tthe\t8085\ton\tthe\tleft-hand\tside\tof\tthe\tcolon\tindicates\tthe\tport\n\nnumber\ton\tour\tlocal\tmachine,\tand\t8080\ton\tthe\tright-hand\tside\tof\tthe\tcolon indicates\tthe\tport\tnumber\tto\tforward\tto\ton\tthe\tpod.\tAfter\tyou\texecute\tthe command,\tit\twill\tgo\tto\tinteractive\tmode\tand\tkeep\tlistening\tfor\tany\tnew\trequests on\tport\t8085\tof\tyour\tlocal\tmachine.\tAny\tnew\trequests\twill\tbe\tforwarded\tto\tport 8080\tof\tthe\tpod,\tand\tthe\tresponses\twill\tbe\tsent\tback\tto\tthe\tclient.\n\nNow\tthat\twe\thave\tour\tport\tforwarding\tagent\tand\tKubernetes\tservice\tset\tup,\n\nlet's\tverify\tthat\tour\tAPIs\tare\taccessible\tfrom\tthe\tlocal\tmachine.\tOpen\ta\tnew terminal\twindow\tand\tissue\tthe\tfollowing\tcURL\tcommand\tto\tcreate\ta\tnew geolocation:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nWith\tthat,\twe\tare\table\tto\taccess\tour\tgeolocation\tmicroservice\ton\tthe\n\nKubernetes\tcluster\tfrom\tour\tlocal\tmachine.\tThe\tremainder\tof\tthe\trecipe\twill\thelp\n\nyou\tcreate\ta\tservice\tif\tyou\twould\tlike\tto\tuse\tthe\tYAML-file\tbased\tkubectl create\tcommand\tto\tdeploy\tyour\tmicroservice\ton\tKubernetes.\tIf\tyou\tprefer using\tthe\tdashboard\tUI\tto\tdeploy\tapplications,\tfeel\tfree\tto\tskip\tthe\trest\tof\tthis recipe\tand\tjump\tto\tthe\tnext\trecipe.\tIf\tyou\thave\tused\tthe\tkubectl\tcreate command\tto\tcreate\tyour\tmicroservice,\tit\twill\tnot\tcreate\ta\tservice\tfor\tyou.\tYou have\tto\tmanually\tcreate\tit\tusing\tkubectl\texpose\tcommand.\tThis\tis\tuseful\twhen you\tare\tautomating\tdeployments\tor\tautomating\tintegration\ttests\tin\ta\tcontinuous integration\tenvironment.\n\nCreating\ta\tservice\tusing\tthe\tkubectl\tcommand\tis\tvery\tsimple.\tAll\tyou\tneed\tto\n\nknow\tis\tyour\tdeployment\tname.\tIn\tthe\tkube-deployment.yml\tfile,\twe\thave\tset the\tdeployment\tname\tas\tgeolocation,\tso\twe\twill\tuse\tthe\tsame\there.\tOpen\tup\ta new\tterminal\tand\tissue\tthe\tfollowing\tcommand:\tkubectl\texpose deployment/geolocation\tservice\t\"geolocation\"\texposed\n\nNow\tlet's\tverify\tthat\tour\tservice\thas\tbeen\tcreated.\tExecute\tthe\tfollowing\n\ncommand\tin\tthe\tsame\tterminal\twindow:\tkubectl\tget\tservices\tNAME CLUSTER-IP\tEXTERNAL-IP\tPORT(S)\tAGE\tgeolocation\t10.0.0.254 <none>\t8080/TCP\t1m\tkubernetes\t10.0.0.1\t<none>\t443/TCP\t1d\n\nAs\tyou\tcan\tsee,\tport\t8080\thas\tbeen\texposed\tby\tthe\tgeolocation\tservice.\tIf\tyou would\tlike\tto\tget\tmore\tinformation\tabout\tthe\tservice\twithout\thaving\tto\tgo\tto\tthe dashboard,\tuse\tthe\tfollowing\tcommand:\tkubectl\tdescribe\tservice/geolocation Name:\tgeolocation\tNamespace:\tdefault\tLabels:\tapp=geolocation\tSelector: app=geolocation\tType:\tClusterIP\tIP:\t10.0.0.254\tPort:\t<unset>\t8080/TCP Endpoints:\t172.17.0.4:8080\tSession\tAffinity:\tNone\tNo\tevents.\n\nFrom\tthe\tpreceding\tconsole\toutput,\twe\tcan\tsee\tthat\tthe\tClusterIP\tis\n\n10.0.0.254,\tand\tthere\tis\tone\tendpoint\texposed\tby\tthis\tservice\tat 172.17.0.4:8080.\tIf\tyou\tare\tin\ta\tDockerized\tenvironment,\tas\twe\tdiscussed earlier\tin\tthis\trecipe,\tyou\twill\thave\tto\tperform\ta\tport\tforwarding\tusing\tthe kubectl\tport-forward\tcommand.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\thave\tsuccessfully\tdeployed\tour geolocation\tmicroservice\tand\texposed\tits\tendpoints\tso\tthat\tit\tcan\tbe\taccessed from\toutside.\tIn\tthe\tfollowing\trecipes,\twe\twill\tlook\tat\thow\tto\tconfigure\tvolumes and\tenvironment\tvariables\tusing\tthe\tdashboard\tUI.\n\nConfiguring\tvolumes\tin\tKubernetes\n\nVolumes\tare\thandled\tvery\tdifferently\tin\tKubernetes\tcompared\tto\tApache\tMesos. In\tfact,\tKubernetes\tpersistent\tvolumes\tsupport\tAzure,\tvCloud,\tand\tAWS. Kubernetes\talso\tsupports\tCeph,\tFlocker,\tGluster\tFS,\tand\teven\tGit.\tThis extensive\tsupport\topens\tup\topportunities\tfor\tstoring\tyour\tdata\ton\tthe\tcloud\tand also\tenables\teasy\tbackups.\n\nNote\n\nTo\ttake\ta\tlook\tat\tthe\tcomplete\tset\tof\tsupported\tvolumes,\tgo\tto http://kubernetes.io/docs/user-guide/volumes/#types-of-volumes\t.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tmap\tthe\tvolume\twhere\tour\tdata\tfiles\tare stored\tin\tthe\tgeolocation\tmicroservice.\n\n1.\t First,\tdelete\tany\tdeployments,\treplication\tcontrollers,\tport\tforwards,\tor services\tthat\tyou\talready\thave\tfor\tgeolocation.\tYou\tcan\tleave\tthe echoserver\tcontainer\tthat\twe\tcreated\tearlier\tor\tdelete\tit.\tIt\tshouldn't\treally affect\tus.\tAlso,\talways\tdelete\tthe\tservice\tfirst\tand\tthe\treplication\tcontroller afterward.\tIf\tyou\ttry\tto\tdelete\tthe\tpod\tor\tcontainer,\tit\twill\tbe\trecreated\tby the\treplication\tcontroller\tto\tmake\tsure\tat\tleast\tone\treplica\tof\tyour\tpod\tand container\tis\tavailable\t(as\tour\treplication\tfactor\tis\t1).\n\n2.\t Before\twe\tjump\tinto\tthe\trecipe,\tyou\thave\tto\tlearn\thow\tKubernetes\thandles volumes.\tThere\tare\ttwo\tconcepts:\tpersistent\tvolumes\tand\tpersistent\tvolume claims. A\tpersistent\tvolume\tis\tjust\ta\tstorage\tprovisioned\ton\tthe\tcluster network\tby\tthe\tcluster\tadministrator.\tThe\tcluster\tadministrator\tcan\tbe someone\tin\tyour\torganization\tresponsible\tfor\tthe\tKubernetes\tcluster's infrastructure\tand\tavailability. Unlike\tMesos,\twhere\tyou\tmap\ta\tvolume\tdirectly\tfrom\tthe\tcontainer\tto the\thost\tmachine,\there\tin\tKubernetes,\tyou\thave\tto\tcreate\ta\tpersistent volume\tfirst\tand\tcreate\ta\tpersistent\tvolume\tclaim,\twhich\tis\tnothing\tbut a\trequest\tmade\tby\tthe\tpod\tfor\tstorage\ton\tthe\tcluster.\n\nNote\n\nIt\tis\thighly\trecommended\tthat\tyou\tread\thttp://kubernetes.io/docs/user- guide/persistent-volumes\tbefore\tyou\tstart\tusing\tvolumes\ton\tKubernetes,\tas the\tprocess\tis\tnot\tstraight-forward.\n\n3.\t In\tour\trecipe,\tfor\tsimplicity,\twe\twill\tbe\tcreating\ta\thostPath\tvolume\tand will\tbe\tmapping\tit\tto\tthe\tdata\tdirectory\tof\tthe\tgeolocation\tmicroservice.\tIf you\tremember\tfrom\tChapter\t3\t,\tDeploying\tMicroservices\ton\tMesos,\twe persisted\tour\tgeolocations\tin\tthe\tform\tof\tJSON\tfiles\tin\tthe\tdata\tdirectory\tat optpackt/geolocation/data.\tThe\thostPath\tvolume\tis\tmostly\tused\twhen you\twould\tlike\tto\texpose\tsomething\ton\tthe\thost\tmachine,\tfor\texample, Docker\tinternals,\tshared\tfolders,\tand\tconfig\tdirectories.\n\nHow\tto\tdo\tit...\n\nIn\tthis\trecipe,\twe\twill\tbe\tdeploying\tour\tmicroservice\ta\tlittle\tdifferently\tfrom\tthe previous\tmethods.\tSo\tfar,\twe\thave\tcreated\treplication\tcontrollers\tand deployments\tboth\tfrom\tthe\tUI\tand\tusing\tkubectl.\tIn\tthis\trecipe,\twe\twill\tbe creating\ta\tpod\tusing\tkubectl.\tThe\treason\twe\tare\tcreating\ta\tpod\tis\tthat\twe\twill also\tbe\tcreating\tour\thostPath\tvolume\talong\twith\tthe\tpod.\n\n1.\t Open\tyour\tSTS\tIDE\tand\tgo\tto\tthe\tgeolocation\tproject.\tCreate\ta\tnew YAML\tfile\tcalled\tkube-pod.yml,\tand\tpaste\tthe\tfollowing\tcontents\tin\tit: apiVersion:\tv1\tkind:\tPod\tmetadata:\tname:\tgeolocation\tspec: containers:\t-\timage:\tvikrammurugesan/geolocation:latest\tname: geolocation\tports:\t-\tcontainerPort:\t8080\tvolumeMounts:\t-\tmountPath: optpackt/geolocation/data\tname:\tgeodata\tvolumes:\t-\tname:\tgeodata hostPath:\tpath:\toptpackt/geolocation/data\n\n2.\t There\tare\tfew\tthings\tto\ttake\ta\tlook\tat\there\tin\tthe\tYAML\tfile.\tThe\tAPI version\twe\tare\tusing\tis\tv1.\tThe\tkind\tof\tentity\twe\tare\tcreating\tis\tPod.\tThe name\tof\tthe\tpod\tis\tgeolocation.\tThe\tpod\thas\tone\tcontainer\twith\tthe\tname geolocation.\tIt\tuses\tthe\tvikrammurugesan/geolocation:latest\timage, and\tthe\tcontainer\tport\tfor\tthis\tcontainer\tis\t8080.\tThe\tpod\thas\tone\tvolume called\tgeodata.\tThe\tvolume\tgeodata\tis\tof\ttype\thostPath,\tand\tthe\tpath\tin the\thost\tis\toptpackt/geolocation/data.\tThe\tgeolocation\tcontainer\thas one\tvolume\tmapping\tfor\tthe\toptpackt/geolocation/data\tcontainer\tpath on\tthe\tvolume\tthat\tmatches\tthe\tname\tgeodata\twhich\tis\tthe\thostPath volume.\n\n3.\t Go\tahead\tand\tcreate\ta\tnew\tpod\tusing\tthe\tfollowing\tkubectl\tcreate command:\tkubectl\tcreate\t-f\tkube-pod.yml\tpod\t\"geolocation\"\tcreated 4.\t Now\tlet's\tmake\tsure\tour\tpod\tis\tup\tand\trunning.\tTo\tverify\tits\tstatus,\tissue\n\nthe\tfollowing\tcommand\ton\tthe\tterminal:\tkubectl\tget\tpods\tNAME\tREADY STATUS\tRESTARTS\tAGE\tgeolocation\t0/1\tContainerCreating\t0\t5m hello-minikube-2713628163-x6ge3\t1/1\tRunning\t1\t5d\n\n5.\t As\tyou\tcan\tsee,\tthe\tgeolocation\tpod\tis\tin\tthe\tContainerCreating\tstate, which\tmeans\tit\tis\tin\tthe\tprocess\tof\tpulling\tand\tstarting\tthe\tcontainer.\tIt\tmay take\ta\tfew\tseconds\tfor\tyour\tpod\tto\tgo\tinto\tthe\tRunning\tstate.\n\n6.\t You\tcan\talways\ttake\ta\tlook\tat\tyour\tpod\tin\tthe\tKubernetes\tdashboard\tas well.\tOnce\tthe\tpod\tis\tcreated,\tlook\tat\tthe\tdetails\tof\tthe\tgeolocation\tpod\tin the\tdashboard.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThe\tnext\tstep\tis\tsetting\tup\tport\tforwarding\tusing\tkubectl.\tUse\tthe\tfollowing\n\ncommand\tto\tsetup\tport\tforwarding:\tkubectl\tport-forward\tgeolocation 8085:8080\n\nNow\tthat\tyou\tknow\tyour\tpod\tand\tcontainer\tare\tup\tand\trunning,\tlet's\tsend\ta couple\tof\tgeolocations\tto\tthe\tPOST\tAPI.\tUse\tthe\tfollowing\ttwo\tcurl\tcommands to\tcreate\tgeolocations:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\tcurl -H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203976,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\":\t\"f1196aac-470e-\n\n11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nNow\tlet's\tverify\twhether\tthe\tfiles\twe\tcreated\tare\tavailable\ton\tthe\thost\n\nmachine.\tBut\tthe\tquestion\there\tis\tthis:\twhich\tone\tis\tthe\thost\tmachine?\tSince\twe are\tusing\ta\tDockerized\tenvironment,\tthe\thost\tmachine\twill\tbe\tthe\tminikube VirtualBox\tVM.\tTo\tcheck\twhether\tthe\tfiles\tare\tavailable\tin\tthe\tVM,\twe\thave\tto SSH\tinto\tthe\tVM\tfirst.\tTo\tdo\tthat,\tlet's\tuse\tthe\tminikubessh\tcommand: minikube\tssh\n\nYou\tshould\tget\tsomething\tlike\tthis:\t##\t.\t##\t##\t##\t==\t##\t##\t##\t##\t##\t===\n\n\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\\___\t===\t~~~\t{~~\t~~~~\t~~~\t~~~~\t~~~\t/\t===-\t~~ \\______\to\t__/\t\\\t\\\t__/\t\\____\\_______/\t____\t|\t|__\t___\t___\t|\t|_|___\t\\\t__|\t|\t___\t___|\t| ____\t__\t|\t'_\t\\\t_\t\\\t\\|\t_|\t__)\t/\t_`\t|\t_\t\\\t__|\t|/\t/\t\\\t'_|\t|\t|_)\t|\t(_)\t|\t(_)\t|\t|_\t/\t__/\t(_|\t|\t(_)\t|\t(__| <\t__/\t|\t|_.__/\t\\___/\t\\___/\t\\__|_____\\__,_|\\___/\t\\___|_|\\_\\___|_|\tBoot2Docker version\t1.11.1,\tbuild\tmaster\t:\t901340f\t-\tFri\tJul\t1\t22:52:19\tUTC\t2016\tDocker version\t1.11.1,\tbuild\t5604cbe\tdocker@minikube:~$\n\nOnce\tyou\tare\tinside\tthe\tVM,\texecute\tthe\tfollowing\tls\tcommand\tto\tcheck\n\nwhether\tthe\tfiles\thave\tbeen\tcreated\tsuccessfully:\tls\t-ls optpackt/geolocation/data\n\nYou\tshould\tget\tsomething\tlike\tthis:\n\nWe\thave\tsuccessfully\tconfigured\tvolume\tmappings\ton\tKubernetes\tusing\tthe hostPath\tmethod.\tThough\tthis\tis\tone\tof\tthe\tsimplest\tconfigurations\tyou\tcan achieve\twith\tKubernetes,\tthe\tidea\there\tis\tto\tgive\tyou\tan\tintroduction\tto\tthe abilities\tof\tKubernetes\twhen\tit\tcomes\tto\tMicroservice\tdeployments.\tIn production\tscenarios,\tit\tis\tmore\tideal\tto\tuse\tAzure,\tAWS,\tor\tvCloud,\tbased\ton your\tstack.\n\nBefore\twe\tmove\ton\tto\tthe\tnext\trecipe,\tlet's\tdelete\tour\tpod\tusing\tthe\tfollowing command:\tkubectl\tdelete\tpod/geolocation\tpod\t\"geolocation\"\tdeleted\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tlook\tat\thow\tto configure\tenvironment\tvariables\tin\tKubernetes.\n\nConfiguring\tenvironment\tvariables\tin Kubernetes\n\nIn\tthe\tprevious\tchapter,\twe\tused\tMarathon\tto\tadd\tan\tenvironment\tvariable\tfor the\tgeolocation\tdata\tdirectory\tpath,\twhich\twill\tin\tturn\tbe\tused\tby\tthe application\tto\tlocate\tthe\tdata\tdirectory.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tuse the\tKubernetes\tdashboard\tas\twell\tas\tkubectl\tto\tconfigure\tthe\tsame\tenvironment variable.\n\nGetting\tready\n\nFirst,\tdelete\tany\treplication\tcontrollers,\tservices,\tport\tforwards\tor\tpods\tthat\twere created\tin\tthe\tprevious\trecipe.\tYou\tcan\tleave\tthe\techoserver\tup\tand\trunning;\tit should\tnot\taffect\tanything.\tThere\tare\ttwo\tways\tyou\tmight\twant\tto\tadd environment\tvariables\tto\tyour\tcontainer:\tfrom\tthe\tdashboard\tUI\tor\tfrom\tthe command\tline\tusing\tkubectl.\n\nWe\twill\tlook\tat\tthe\tdashboard\tUI\tfirst.\tIf\tyou\tdon't\thave\tthe\tdashboard\tup\tand running,\tissue\tthe\tfollowing\tcommand\tto\topen\tup\tthe\tKubernetes\tdashboard: minikube\tdashboard\n\nHow\tto\tdo\tit... 1.\t Once\tthe\tdashboard\tis\tup,\tclick\ton\tthe\tCreate\tbutton\tto\tdeploy\tour\n\nmicroservice.\tLet's\tuse\tthe\tfriendly\tform\tto\tdeploy\tthe\tmicroservice.\tUse the\tfollowing\tconfigurations:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t1 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nTake\ta\tlook\tat\tthe\tEnvironment\tVariables\tsection.\tWe\thave\tadded\tthe\n\nGEOLOCATION_DATA_FILES_DIR\tvariable\twith\tthe\tvalue optpackt/geolocation/data:\n\nNote\n\nKeep\tin\tmind\tthat\tthe\tEnvironment\tVariables\tsection\twill\tbe\tburied\tunder\tthe advanced\toptions\tat\tthe\tbottom.\n\nOnce\tyou\thave\tentered\tall\tthe\tvalues,\tclick\ton\tDeploy\tto\tdeploy\tthe\n\nmicroservice.\tIt\ttakes\ta\tfew\tseconds\tfor\tyour\tpod\tand\treplication\tcontroller\tto get\tto\tthe\tRunning\tstate.\n\nThat's\tit!\tThe\tgeolocation\tmicroservice\tshould\tnow\tuse\tthe\tnew\tenvironment\n\nvariable\tto\tlocate\tthe\tdata\tdirectory\tinside\tthe\tcontainer.\tThe\tnext\tstep\tis\tto check\twhether\tthe\tgeolocation\tmicroservice\tis\tusing\tour\tnewly\tcreated environment\tvariable.\n\nIn\torder\tto\tverify\tthe\tworking\tof\tour\tenvironment\tvariable,\twe\thave\tto\texpose\n\nport\t8080\tof\tthe\tpod\tto\tour\tlocal\tmachine.\tGo\tahead\tand\tissue\tthe\tfollowing command\tin\tyour\tterminal\twindow:\tkubectl\tport-forward\tgeolocation-qr86 8080:8080\tForwarding\tfrom\t127.0.0.1:8080\t->\t8080\tForwarding\tfrom [::1]:8080\t->\t8080\n\nIn\tthis\tcommand,\tthe\tname\tof\tthe\tpod\twas\tgeolocation-qr86.\tIf\tthe\tname\tof\n\nyour\tpod\tis\tdifferent,\tuse\tthat.\tOtherwise,\tyou\twill\tget\tan\terror\tmessage\tfrom kubectl\tsaying\tthat\ta\tpod\twith\tthe\tgiven\tname\tis\tnot\tavailable.\tNow\tthat\tyour service\tis\tlistening\ton\tport\t8080\tof\tlocalhost,\topen\ta\tnew\tterminal\twindow. Execute\tthe\tfollowing\ttwo\tcurl\tcommands\tone\tby\tone:\tcurl\t-H\t\"Content- Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\tcurl -H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203976,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8080/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nNow\tlet's\tvalidate\twhether\tthe\tfiles\thave\tbeen\tcreated\tusing\ta\tsimple\tdocker\n\nexec\tcommand.\tYou\tcan\tfind\tthe\tID\tof\tthe\tgeolocation\tcontainer\tusing\tthe docker\tps\tcommand.\tIn\tthe\tsame\tterminal\twindow,\texecute\tthe\tfollowing\n\nDocker\tcommand:\tdocker\texec\t9ae486e3d63a\tls\toptpackt/geolocation/data userf1196aac-470e-11e6-beb8-9e71128cae77_t1468203975\tuserf1196aac- 470e-11e6-beb8-9e71128cae77_t1468203976\n\nYay!\tOur\tdata\tfiles\thave\tbeen\tcreated\tat\tthe\tlocation\tthat\twas\tpassed\tin\tthe GEOLOCATION_DATA_FILES_DIR\tenvironment\tvariable.\n\nNow\tlet's\ttake\ta\tlook\tat\thow\tto\tconfigure\tenvironment\tvariables\tusing\tkubectl\n\nand\ta\tYAML\tfile.\tBefore\twe\tmove\ton,\tdelete\tthe\treplication\tcontroller\tand\tthe services\tthat\twe\tcreated.\n\nNow,\topen\tthe\tkube-pod.yml\tfile\tthat\twe\tcreated\tin\tthe\tprevious\trecipe\tin\n\nSTS.\tAdd\tthe\tfollowing\tsection\tto\tthe\tgeolocation\tcontainer\tsection\tin\tthe YAML\tfile.\tRemember\tto\tbe\tcareful\twhen\tyou\twork\twith\tYAML\tfiles,\tas\tit does\tnot\taccept\ttab\tspaces.\tInstead\tof\ttab\tspaces,\tuse\tblank\tspaces:\tenv:\t\t\t\t\t- name:\tGEOLOCATION_DATA_FILES_DIR\t\t\t\t\t\t\tvalue: \"optpackt/geolocation/data\"\n\nAfter\tyou\thave\tadded\tthe\tenvironment\tvariables,\tyour\tfinal\tYAML\tfile\twill look\tlike\tthis:\tapiVersion:\tv1\tkind:\tpod\tmetadata:\tname:\tgeolocation\tspec: containers:\t-\timage:\tvikrammurugesan/geolocation:latest\tname:\tgeolocation ports:\t-\tcontainerPort:\t8080\tvolumeMounts:\t-\tmountPath: optpackt/geolocation/data\tname:\tgeodata\tenv:\t-\tname: GEOLOCATION_DATA_FILES_DIR\tvalue:\t\"optpackt/geolocation/data\" volumes:\t-\tname:\tgeodata\thostPath:\tpath:\toptpackt/geolocation/data Spin\toff\tthe\tpod\tusing\tkubectl\tfrom\tany\tterminal\twindow,\tusing\tthe following\tcommand:\tkubectl\tcreate\t-f\tkube-pod.yml\tpod\t\"geolocation\" created\n\nNow\tyou\tcan\tverify\twhether\tthe\tenvironment\tvariable\twas\tcreated\tby\tposting\n\nsome\tgeolocations\tto\tthe\tAPI\tand\tchecking\tthe\tcontents\tof\tthe optpackt/geolocation/data\tdirectory\tin\tthe\tminikube\tVirtualBox\tVM.\n\nScaling\tyour\tmicroservice\tin Kubernetes\n\nIf\tyou\tread\tthe\tprevious\tchapter,\tyou\twill\tknow\thow\timportant\tbeing\table\tto scale\tmicroservices\tis.\tScaling\tis\ta\tsignificant\tfeature\tfor\tany\tclustering framework\tbecause\twith\tthe\tincreasing\tusage\tof\tcontainers,\tusers\tprefer\tsimpler methods\tto\tscale\ttheir\tcontainers.\tLike\tMarathon,\tKubernetes'\tdashboard\tcan\tbe used\tto\teasily\tscale\tcontainers\tup\tand\tdown.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe Kubernetes\tdashboard\tto\tscale\tup\tand\tscale\tdown\tthe\tgeolocation\tmicroservice.\n\nGetting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.\n\nHow\tto\tdo\tit... 1.\t Click\ton\tthe\tCreate\tbutton\tand\tfill\tout\tthe\tfriendly\tform\twith\tthe\tfollowing\n\ninformation:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nThere\tis\tone\tsignificant\tchange\tin\tthis\tconfiguration\tfrom\tour\tprevious deployments.\tThis\ttime,\twe\thave\tset\tthe\tCPUs\tto\t0.5.\tThis\tchange\tis\trequired\tto support\tthe\tnumber\tof\tpods\tthat\tcan\trun\tin\tour\tMinikube\tsetup.\tThe\tdefault number\tof\tCPUs\tis\t2,\twhich\thas\talready\tbeen\tused\tby\tour\tfirst\tinstance\tof geolocation,\thello-minikube,\tthe\tdashboard,\tand\tthe\tadd-on\tmanager.\tYou could\talso\tincrease\tthe\tnumber\tof\tCPUs\tused\tby\tMinikube\tby\trecreating\tthe minikube\tVM\twith\tthe\t--cpu\toption.\t\tGo\tahead\tand\thit\tDeploy.\n\nNote\n\nFor\tmore\tinformation,\tread https://GitHub.com/kubernetes/minikube/blob/master/docs/minikube_start.md\t.\n\nNote\tthat\twe\thave\tset\tthe\tnumber\tof\tpods\tto\t1.\tYou\tmust\thave\tguessed\tby\tnow\n\nthat\tthe\tnumber\tof\tpods\tis\twhat\tthat\twill\thelp\tus\tscale\tour\tmicroservice.\tNow let's\tsay\tyou\twould\tlike\tto\tincrease\tthe\tnumber\tof\tinstances\tof\tyour\tapplication to\t2:\tclick\ton\tWorkloads\tin\tthe\tleft-hand\tside\tmenu.\tFrom\tthe\tReplication controllers\tsection,\tclick\ton\tthe\tthree\tdots,\tand\tselect\tScale:\n\nAfter\tyou\tclick\ton\tScale,\tyou\twill\tbe\tprompted\tto\tenter\tthe\tnumber\tof\tpods\n\nyou\twould\tlike\tto\tscale\tto.\tAs\tyou\tcan\tsee,\tyou\twill\tnot\tbe\tscaling\tyour application\tinstance\tin\tthe\tsame\tpod;\trather,\tKubernetes\tlets\tyou\tscale\tthe number\tof\tpods\titself.\tThis\tis\tslightly\tdifferent\tfrom\thow\tApache\tMesos\tand Marathon\twork.\tBut\tit\tmakes\ta\tlot\tof\tsense\twhen\tit\tcomes\tto\tscaling\tyour applications\tin\tthe\tKubernetes\tecosystem.\tIn\tthe\tmodal,\tenter\t2\tand\thit\tOK:\n\nNow\tyou\tshould\tbe\table\tto\tsee\ttwo\tpods\tfor\tgeolocation;\tthey\tstart\twith\n\ngeolocation-.\tIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tyour\tpod\tand\tthe containers\tthat\tare\trunning\tinside\tit,\tclick\ton\tthe\tpod\tname:\n\nWith\tthat,\tyou\thave\tsuccessfully\tscaled\tyour\tapplication\tto\ta\tscaling\tfactor\tof\t2. If\tyour\tcluster\thas\tsufficient\tresources,\tyou\twill\tbe\table\tto\teasily\tscale\tyour application\tto\tany\tnumber\tof\tpods.\n\nScaling\tdown\tan\tapplication\tis\tvery\tstraight-forward\tand\tuses\tthe\tsame\n\nstrategy.\tNow\tlet's\tsay\tyou\twould\tlike\tto\tdown-scale\tthe\tgeolocation\tapplication to\ta\tscaling\tfactor\tof\t1.\tAll\tyou\thave\tto\tdo\tis\tgo\tto\tthe\tWorkloads\tpage,\tclick\ton the\tthree\tdots\tnext\tto\tthe\tgeolocation\treplication\tcontroller,\tand\tclick\ton\tScale. In\tthe\tscaling\tmodal,\tenter\tthe\tscaling\tfactor\t1\tand\thit\tOK:\n\nAs\tyou\tcan\tsee,\tthere\tis\tonly\tone\tinstance\tof\tthe\tgeolocation\tpod,\tand\tthe\tother one\twas\tautomatically\tdestroyed.\tThere\tis\tno\tguarantee\twhich\tpods\twill\tbe destroyed\tand\twhich\tones\twill\tbe\tretained.\tThat\tdecision\tis\tmade\tby\tKubernetes. So\tit\tis\thighly\trecommended\tthat\tyou\tdon't\twrite\tany\tlogic\tthat\tis\tvery deployment\tspecific.\tIn\tfact,\tthat\tis\tthe\twhole\tpoint\tof\tbuilding\tmicroservices. There\tare\tother\tways\tto\tscale\tyour\tmicroservice,\tsuch\tas\tmodifying\tthe\n\nYAML\tfile\tfrom\tinside\tthe\tKubernetes\tdashboard\tand\tusing\tkubectl\tto\tchange the\treplicas\tproperty\tof\tyour\tdeployment.\tWe\twill\ttake\ta\tvery\tquick\tlook\tat how\tyou\tcan\tdo\tit\twith\tkubectl,\tbecause\tthat\tis\tsomething\tyou\tmight\twant\tto\tdo when\tautomating\tyour\tdeployment\tprocess.\tFrom\tyour\tterminal\tshell,\texecute the\tfollowing\tkubectl\tcommand:\tkubectl\tscale\trc\tgeolocation\t--replicas=2\n\nreplicationcontroller\t\"geolocation\"\tscaled\n\nHere,\trc\tstands\tfor\treplication\tcontroller.\tWe\tare\trequesting\tkubectl\tto\tscale\n\nthe\treplica\tof\tthe\tgeolocation\treplication\tcontroller\tto\t2.\tNewer\tversions\tof Kubernetes\tare\treplacing\treplication\tcontrollers\twith\treplica\tsets.\tScaling\tthem\tis slightly\tdifferent\tfrom\tthe\tpreceding\tapproach.\tNow\tto\tverify\tthe\tnumber\tof geolocation\tpods\trunning,\texecute\tthe\tfollowing\tcommand\tin\tthe\tsame\tterminal: kubectl\tget\tpods\tNAME\tREADY\tSTATUS\tRESTARTS\tAGE\tgeolocation- a2xce\t1/1\tRunning\t0\t42m\tgeolocation-l50r2\t1/1\tRunning\t0\t2m\thello- minikube-2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nThere\tare\t2\tgeolocation\tpods.\tScaling\tdown\tis\tas\tsimple\tas\tusing\tthe\tsame\n\ncommand\twith\t--replicas\tset\tto\t1.\n\nkubectl\tscale\trc\tgeolocation\t--replicas=1 replicationcontroller\t\"geolocation\"\tscaled\n\nNow,\tverify\tthat\tyou\thave\tonly\tone\tinstance\tof\tthe\tgeolocation\tpod\trunning,\n\nusing\tthe\tfollowing\tcommand:\tkubectl\tget\tpods\tNAME\tREADY\tSTATUS RESTARTS\tAGE\tgeolocation-a2xce\t1/1\tRunning\t0\t44m\thello-minikube- 2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto\tscale our\tapplication\tusing\tkubectl\tas\twell\tas\tthe\tKubernetes\tdashboard.\n\nDestroying\tyour\tmicroservice\tin Kubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tdeploy\tand\tscale\tour\tmicroservice\tin a\tKubernetes\tcluster.\tThere\twill\tbe\tscenarios\twhere\tyou\twould\twant\tto\tdestroy your\tmicroservice\tcompletely\tfrom\tyour\tcluster,\tprobably\tbecause\tyou\twould like\tto\tperform\ta\tclean\tredeploy.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tdestroy\tour microservice.\n\nGetting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.\n\nHow\tto\tdo\tit... 1.\t To\tillustrate\tthe\tdestroy\tfunctionality,\tlet's\tdeploy\tthe\tgeolocation microservice\tfirst.\tUse\tthe\tfriendly\tform\tand\tenter\tthe\tfollowing configurations\tto\tcreate\tyour\tmicroservice:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nGo\tahead\tand\thit\tDeploy.\tAfter\tyour\tpod\tand\treplication\tcontroller\tare\tup\tand\n\nrunning,\tclick\ton\tthe\tthree\tdots\tnext\tto\tthe\tgeolocation\treplication\tcontroller. Then,\tchoose\tDelete\tfrom\tthe\tpopup\tmenu:\n\nIf\tyou\tare\tasked\tfor\tconfirmation,\tclick\ton\tOK.\tAfter\ta\tfew\tseconds,\tyou\twill notice\tthat\tthe\treplication\tcontroller\tand\tthe\tpod\twill\tbe\tdestroyed\tsuccessfully. At\tthe\ttime\tof\twriting\tthis,\tI\twas\tusing\ta\tversion\tof\tthe\tdashboard\tthat\tneeded\ta manual\trefresh\tto\tview\tthe\tstatus\tof\tthe\tpod\tand\treplication\tcontroller.\n\nAlso,\tif\tyou\tgo\tto\tthe\tServices\tsection,\tyou\twill\tsee\tthat\tthe\tgeolocation service\tis\tstill\trunning.\tGo\tahead\tand\tdelete\tthe\tservice\tfrom\tthe\tdashboard. You\tcan\talso\tdo\tthe\tsame\tthing\tusing\tthe\tkubectl\tcommand\twhen\tyou\tare automating\tdeployments\tusing\ttools\tsuch\tas\tJenkins\tor\tHudson.\tBefore\twe\ttry our\tkubectl\tcommand,\tcreate\tthe\tmicroservice\tagain\tusing\tthe\tKubernetes\n\ndashboard.\tAfter\tyour\tservice\tis\tup\tand\trunning,\tissue\tthe\tfollowing\tcommand\tin a\tterminal\twindow:\tkubectl\tdelete\trc\tgeolocation\treplicationcontroller \"geolocation\"\tdeleted\n\nAfter\ta\tfew\tseconds,\tif\tyou\trefresh\tyour\tdashboard\tpage,\tyou\twill\tsee\tthat\tthe\n\ngeolocation\treplication\tcontroller\tand\tpod\thave\tbeen\tsuccessfully\tdeleted.\tThe geolocation\tservice\twill\tstill\tbe\tup\tand\trunning.\tIn\torder\tto\tdelete\tit,\texecute\tthe following\tcommand\tfrom\tthe\tsame\tterminal\twindow:\tkubectl\tdelete\tservice geolocation\tservice\t\"geolocation\"\tdeleted\n\nNow\tgo\tback\tto\tyour\tdashboard\tand\tmake\tsure\tthe\tgeolocation\tservice\thas\tbeen successfully\tdeleted.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe,\twhere\twe\tlearned\thow\tto\tdelete\tour replication\tcontrollers,\tpods,\tand\tservices\tusing\tthe\tKubernetes\tdashboard\tas well\tas\tkubectl.\n\nNote\n\nIn\tmost\tautomation\tscenarios\twhere\tyou\tare\ttrying\tto\tautomate\tyour deployments\tto\ta\tKubernetes\tcluster,\tyou\twould\twant\tto\tinteract\twith Kubernetes'\tREST\tAPI.\tFortunately,\tKubernetes\tprovides\ta\tsophisticated\tREST API\tto\tperform\tall\tthe\toperations\twe\thave\tseen\tso\tfar\tin\tthis\tchapter.\tThe documentation\tfor\tthe\tREST\tAPI\tis\tavailable\there\tat\t http://kubernetes.io/docs/api\t.\n\nMonitoring\tyour\tmicroservice\tlogs\tin Kubernetes\n\nOne\tof\tthe\tmost\timportant\tfeatures\tthat\twill\tbe\thelpful\tafter\tyour\tmicroservices are\tdeployed\tto\ta\tcluster\tis\tbeing\table\tto\tmonitor\tthe\tlogs\tof\tyour\tapplication.\tIn this\trecipe,\tyou\twill\tlearn\thow\tto\tmonitor\tthe\tlogs\tof\tyour\tapplication\tfrom\tthe Kubernetes\tdashboard\tas\twell\tas\tkubectl.\n\nGetting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.\n\nHow\tto\tdo\tit... 1.\t To\tbe\table\tto\tview\tthe\tlogs,\twe\tneed\tour\tmicroservice\tdeployed\ton\n\nKubernetes\tfirst.\tBefore\tthat,\tlet's\tget\tfamiliar\twith\tviewing\tthe\tlogs\tfrom the\tKubernetes\tdashboard.\tOpen\tit\tup.\tUse\tthe\tfriendly\tform\tand\tenter\tthe following\tconfigurations\tto\tcreate\tyour\tmicroservice:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nGo\tahead\tand\thit\tDeploy.\tOnce\tyour\tapplication\tis\tup\tand\trunning,\tclick\ton the\ticon\twith\tfour\tstripes\tnext\tto\tthe\tgeolocation\tpod\tfrom\tthe\tdashboard.\tThis icon\tindicates\tthe\tlogs\tbutton,\twhich\twill\ttail\tthe\tlogs\tfrom\tany\tcontainer\tin\tthat pod:\n\nAfter\tyou\tclick\ton\tthe\ticon,\tyou\twill\tbe\tshown\ta\tscreen\tthat\tlooks\tvery\tsimilar\n\nto\tyour\tterminal\tshell.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThere\tare\ta\tfew\tuseful\toptions\tin\tthis\tterminal.\tFrom\tthe\tdropdown\tin\tthe\ttop section,\tyou\twill\tbe\table\tto\tchoose\tthe\tpod\tof\tyour\tchoice\tand\tview\tthe\tlogs\tfor that\tpod.\tIn\tour\tcase,\tthere\tis\tonly\tone\tpod\tin\tthe\treplication\tcontroller,\tso\tif\tyou click\ton\tthat\tdropdown,\tyou\twill\tbe\table\tto\tsee\tonly\tone\toption.\tThe\ticon\tthat says\tA\tis\tused\tto\ttoggle\tthe\tfont\tcolor\tand\tbackground\tcolor\tof\tyour\tterminal. The\tTt\ticon\tnext\tto\tthe\tA\ticon\tis\tused\tto\ttoggle\tbetween\ttwo\tfont\tsizes.\tThese two\toptions\tare\tparticularly\tuseful\twhen\tyou\thave\ta\tlot\tof\tuseful\tlogs\tthat\tyou would\tlike\tto\tmonitor\tas\tpart\tof\tyour\tdebugging\tprocess.\n\nThis\tscreenshot\tshows\thow\tthe\tterminal\twill\tlook\tlike\twhen\tyou\ttoggle\tthe\n\nfont\tcolor\tand\tfont\tsize:\n\nYou\twill\talso\tbe\table\tto\tview\tthe\tsame\tlogs\tfrom\tthe\tContainers\tsection under\tthe\tpod\tdetails.\tGo\tahead\tand\tclick\ton\tthe\tpod\tname\tand\tthen\tthe\tView Logs\thyperlink\tin\tthe\tgeolocation\tcontainer.\tThis\tshould\ttake\tyou\tto\ta\tlog\tpage like\tthe\tone\twe\tsaw\tearlier:\n\nThe\tnext\tuseful\ttip\tis\tbeing\table\tto\tview\tthe\tlogs\tusing\tkubectl.\tIt\tis\tvery simple\tto\tview\tthe\tlogs\tusing\tkubectl.\tFirst,\twe\tneed\tthe\tpod\tname.\tOpen\ta terminal\twindow\tand\texecute\tthe\tfollowing\tcommand:\tkubectl\tget\tpods\tNAME READY\tSTATUS\tRESTARTS\tAGE\tgeolocation-f0yk2\t1/1\tRunning\t0\t26m hello-minikube-2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nNow\tthat\twe\thave\tour\tpod\tnamed\tgeolocation-f0yk2,\tissue\tthe\tfollowing\n\ncommand\tin\tthe\tsame\tterminal:\tkubectl\tlogs\t-f\tgeolocation-f0yk2\n\nThe\t-f\toption\tsays\tthat\tyou\twant\tto\tfollow\tthe\tlogs\tor,\tin\tsimpler\tterms,\tit\twill\n\nlet\tyou\ttail\tthe\tlogs.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThis\tis\tvery\tsimilar\tto\tthe\tdocker\tlogs\tcommand,\tright?\tThere\tare\ta\tfew\tmore options\tthat\tyou\tcan\tuse\twith\tthe\tkubectl\tlogs\tcommand,\tfor\texample,\tyou\tcan tail\tlogs\tfor\tthe\tpast\tfew\tminutes\tor\thours,\tand\tyou\tcan\ttail\tjust\ta\tfew\tlines\tof logs.\n\nNote\n\nTo\tlearn\tmore\tabout\tthese\toptions,\tread\tmore\tat\thttp://kubernetes.io/docs/user- guide/kubectl/kubectl_logs\t.\n\nThat's\tit!\tThat\tbrings\tus\tto\tthe\tend\tof\tthis\tchapter.\tIt\tgave\tyou\ta\tquick\toverview of\tthe\tKubernetes\tcluster\tand\thow\tto\tuse\tit\tlocally.\tIn\tproduction\tdeployments, there\tare\ta\tlot\tmany\tconsiderations\tand\tdesign\tdecisions\tthat\tyou\tmight\twant\tto think\tabout.\tAs\tthat\tis\tcompletely\tout\tof\tscope\tfor\tour\tbook,\twe\twill\tnot\tbe talking\tabout\tthose.\tHowever,\tit\tis\tstrongly\trecommended\tthat\tyou\tread\tmore about\tKubernetes\tbefore\tstarting\tto\t\"productionalize\"\tyour\tdeployments\tusing Kubernetes.\n\nChapter\t5.\tService\tDiscovery\tand Load\tBalancing\tMicroservices\n\nIn\tthis\tchapter,\tyou\twill\tlearn\thow\tto\timplement\tservice\tdiscovery\tand\tload balancing\tin\tmicroservices\tusing\tZookeeper\tand\tConsul.\tWe\twill\tcover\tthe following\trecipes:\n\nSetting\tup\tZookeeper\tusing\tDocker Load-balancing\tmicroservices\tusing\tZookeeper Setting\tup\tConsul\tusing\tDocker Implementing\tservice\tdiscovery\tusing\tSpring\tCloud\tConsul Load-balancing\tyour\tmicroservice\tusing\tSpring\tCloud\tConsul Load-balancing\tyour\tmicroservices\tusing\tNginx\tand\tConsul Load-balancing\tyour\tmicroservice\tusing\tMarathon\tLB",
      "page_number": 231
    },
    {
      "number": 5,
      "title": "Service\tDiscovery\tand Load\tBalancing\tMicroservices",
      "start_page": 297,
      "end_page": 368,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nWhen\tyou\tbreak\tdown\tyour\tmonolithic\tapplication\tto\tseveral\tfocused microservices,\tyou\twill\thave\tto\tfind\tan\tefficient\tway\tto\tlocate\tyour\tservices; moreover,\tservices\twill\thave\tto\tcommunicate\twith\teach\tother.\tThat\tis\texactly what\tservice\tdiscovery\tis\tall\tabout.\tNow\tlet's\tsay\tyou\tfigured\tout\ta\tway\tto\tlocate them:\twhat\thappens\tto\tthose\tservices\tthat\tare\tscaled\tto\ta\tfactor\tgreater\tthan\tone? You\thave\tto\tefficiently\tload-balance\tthem.\tThis\tis\tanother\tproblem\tthat\tthis chapter\tintends\tto\tsolve.\n\nSetting\tup\tZookeeper\tusing\tDocker\n\nIn\tChapter\t3\t,\tDeploying\tMicroservices\ton\tMesos,\twe\tlearned\ta\tlittle\tbit\tabout Zookeeper.\tTo\tkeep\tit\tvery\tsimple,\tZookeeper\tis\ta\tcluster-management\ttool\tthat is\tmainly\tused\tfor\tstoring\tyour\tcluster\tconfigurations.\tZookeeper\tis\tused\tby several\tApache\tbig\tdata\tprojects\tsuch\tas\tMesos,\tKafka,\tand\tBookkeeper.\tIn\tthis chapter,\twe\twill\tsee\thow\twe\tcan\tuse\tZookeeper\tto\tstore\tour\tmicroservice configurations\tand\tlater\tuse\tthem\tto\tperform\tload-balancing.\tThis\trecipe\twill show\tyou\thow\tto\tstart\tZookeeper\tand\tExhibitor\tusing\tDocker.\tExhibitor\tis\ta management\tinterface\tfor\tZookeeper.\tIn\taddition\tto\tproviding\ta\tweb\tinterface\tto manage\tZookeeper,\tit\talso\tperforms\tlog\tfile\tcleanups\tand\tbackups.\tWe\twill\tbe using\tthe\tExhibitor\tweb\tinterface\tto\tverify\tthat\tour\tservice\twas\tregistered\ton Zookeeper.\n\nGetting\tready 1.\t We\tnow\tknow\tthat\twe\tneed\ttwo\tcomponents:\n\nZookeeper Exhibitor\n\nThey\tcould\teither\tbe\ttwo\tindividual\tcontainers\tlinked\ttogether\tvia\tdocker- compose\tor\tcould\tcoexist\tin\tthe\tsame\tcontainer.\n\n2.\t We\twill\tbe\tusing\tan\texisting\timage\tthat\thas\tboth\tZookeeper\tand\tExhibitor coexisting\tin\tthe\tsame\timage.\n\n3.\t We\twill\tbe\tcreating\ta\tdocker-compose.yml\tfile\tjust\tfor\tZookeeper\tand Exhibitor.\n\n4.\t The\treason\twe\tuse\tDocker\tCompose\teven\twhen\tthere\tis\tjust\tone\tcontainer is\tfor\tgrouping\tpurposes.\tI\talways\tlike\tkeeping\tmy\tcontainers\tgrouped together\tin\tCompose\tfiles\tso\tthat\tin\tcase\tyou\tneed\tto\tadd\ta\tnew\tdependent container\tin\tthe\tfuture,\tit\twill\tbe\teasy\tto\tadd\tit.\tIt\talso\thelps\tin\tversioning. On\ttop\tof\tthat,\tyou\tget\tto\tuse\tthe\tsophisticated\tDocker\tCompose\tcommand- line\tfeatures.\n\n5.\t Go\tahead\tand\topen\tyour\tSTS\tIDE.\n\nHow\tto\tdo\tit... 1.\t Create\ta\tnew\tfile\tcalled\tdocker-compose-zk.yml\tin\tthe\tgeolocation\n\nproject.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tDocker\tcompose file:\n\nversion:\t\"2\" services: \t\t\t\t\t\t\t\tzookeeper: \t\t\t\t\t\t\t\t\t\timage:\tmbabineau/zookeeper-exhibitor:latest \t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t-\t\"8181:8181\" \t\t\t\t\t\t\t\t\t\t\t\t-\t\"2181:2181\"\n\nAs\tyou\tcan\tsee,\twe\tare\tusing\tthe\timage\tcalled\tmbabineau/zookeeper- exhibitor,\tand\twe\tare\tusing\tthe\tlatest\ttag\tof\tthis\timage.\tThis\timage comes\twith\tZookeeper\tand\tExhibitor\tby\tdefault.\tThere\tare\ttons\tof\tother images\tthat\tyou\tcan\tuse\tif\tyou\tprefer\tto\tuse\tthem.\tYou\tcan\talso\tcreate\tyour own\timage\twith\tZookeeper\tand\tExhibitor\tin\tit\tor\tput\tZookeeper\tand Exhibitor\tin\ttheir\town\timages\tand\tlink\tthem\tusing\tdocker-compose.\tFor simplicity,\twe\tare\tusing\tthis\timage\tas\tit\tcomes\tout\tof\tthe\tbox\twith\tall\tthe components\twe\tneed.\tWe\thave\texposed\ttwo\tports,\t2181\tand\t8181.\t2181\tis the\tport\texposed\tby\tZookeeper\tthat\twe\twill\tbe\tusing\tin\tour\tcode\tto\tconnect to\tit.\tPort\t8181\tis\twhere\tthe\tExhibitor\tweb\tinterface\twill\tbe\tlistening.\tSo\twe need\tthese\ttwo\tports\tto\tbe\texposed\tfrom\tthese\tcontainers.\tAlso,\tas\tyou\tcan see,\tthese\tports\tare\tmapped\tto\tthe\tsame\tport\tnumber\ton\tthe\thost. 2.\t Without\tany\tdelay,\tlet's\tspin\toff\tZookeeper\tand\tExhibitor.\tOpen\tup\ta\n\nterminal\tshell\tand\tissue\tthe\tfollowing\tcommand:\n\ndocker-compose\t-f\tdocker-compose-zk.yml\tup\n\n3.\t As\tyou\tcan\tsee,\twe\tare\tpassing\tthe\tDocker\tCompose\tYML\tfile\tname\tas\tan argument\tas\twe\tare\tnot\tusing\tthe\tdefault\tdocker-compose.yml\tfilename.\tIt usually\ttakes\ta\tfew\tseconds\tto\tfew\tminutes\tto\tstart\tup\tExhibitor\tand Zookeeper\tcompletely.\tExhibitor\tmay\tbe\tup\tin\ta\tfew\tseconds,\tbut Zookeeper\ttakes\ta\tfew\tseconds\tto\ta\tcouple\tof\tminutes.\tSo\twait\tfor\tboth\tof them\tto\tbe\tup\tand\trunning.\tYou\tcan\tverify\tthat\tZookeeper\thas\tstarted\tif\tyou see\tsomething\tlike\tthis\tin\tyour\tconsole:\n\n4.\t After\tyou\tknow\tthat\tboth\tZookeeper\tand\tExhibitor\tare\tup\tand\trunning, open\tup\ta\tnew\tbrowser\ttab.\tEnter\tthis\tURL\tto\topen\tthe\tExhibitor\tweb interface:\thttp://192.168.99.100:8181/exhibitor/v1/ui/index.html. You\tshould\tsee\tthe\tExhibitor\thome\tpage,\twhich\tshows\tthe\tlist\tof\tinstances that\tare\tcurrently\trunning:\n\n5.\t Now\tmove\ton\tto\tthe\tExplorer\ttab.\tYou\tshould\tsee\ta\ttree\tthat\tlists\tall\tthe registered\tservices.\tIf\tyou\tare\table\tto\tsee\tZookeeper\tas\tshown\tin\tthe\tnext screenshot,\tExhibitor\tis\tproperly\tconfigured\tto\twork\twith\tour\tZookeeper instance:\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tnow\thave\ta\tfunctional\tZookeeper and\tExhibitor\tinstance.\tIn\tthe\tnext\trecipe,\twe\twill\tutilize\tthese\tservers\tto\tload- balance\tthe\tgeolocation\tmicroservice.\n\nLoad\tbalancing\tmicroservices\tusing Zookeeper\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\ta\tZookeeper\tinstance\talong\twith\tan Exhibitor\tinstance.\tIn\tthis\trecipe,\twe\twill\tutilize\tthese\tinstances\tto\tload-balance the\tgeolocation\tmicroservice.\tWe\twill\tbe\tspinning\toff\ttwo\tinstances\tof\tthe geolocation\tmicroservice\tand\tsee\thow\twe\tcan\tuse\tZookeeper\tand\tthe\tCurator API\tto\tperform\tround-robin\tstyle\tload\tbalancing\ton\tthe\tHTTP\tendpoints exposed\tby\tthe\tgeolocation\tmicroservice.\n\nLoad-balancing\tHTTP-based\tmicroservices\tis\ta\tsignificant\tstep\ttowards onboarding\tyour\tmicroservice\tto\ta\tcluster\tsuch\tas\tMesos\tor\tKubernetes. Scalability\twill\tnot\thave\tany\tvalue\tunless\tyou\tfigure\tout\ta\tway\tto\tload-balance your\tmicroservices.\tZookeeper\tis\tjust\tone\tway\tto\tdo\tthis;\twith\tthe\ttools\tcurrently available,\tthere\tare\tseveral\tways\tto\tdo\tthis:\tusing\tframeworks\tsuch\tas\tConsul and\tMarathon\tLB\t(Mesos/Marathon\tspecific).\tIn\tfact,\tthere\tare\tlibraries\tthat even\tlet\tyou\tperform\tload-balancing\ton\tthe\tclient\tside.\tWe\twill\tbe\tlooking\tat Consul\tand\tMarathon\tLB\tlater\tin\tthis\tchapter.\n\nGetting\tready\n\nImplementing\ta\tload\tbalancer\tusing\tZookeeper\tand\tthe\tCurator\tAPI\tinvolves two\tsteps.\tLet's\tlook\tat\tthem\tone\tby\tone:\n\n1.\t Register\tthe\tgeolocation\tmicroservice\tin\tZookeeper:\tIn\tthis\tstep,\tthe geolocation\tmicroservice\twill\tbe\tconfigured\tto\tregister\titself\tin\tZookeeper with\tthe\thost\tand\tport\tinformation\tof\tthe\tHTTP\tAPI.\n\n2.\t Implement\tload\tbalancer:\tIn\tthis\tstep,\twe\twill\tbe\tcreating\ta\tnew\tload balancer\tmicroservice\tthat\twill\tlook\tup\tthe\tgeolocation\tconfigs\tfrom Zookeeper\tand\tuse\tthem\tto\tproxy\tthe\tHTTP\trequests.\n\nHow\tto\tdo\tit...\n\nLet's\ttake\ta\tlook\tat\tthe\tfirst\tstep:\tregistering\tthe\tgeolocation\tmicroservice\tin Zookeeper.\tThis\tstep\tsays\tthat\tas\tand\twhen\ta\tnew\tinstance\tof\tthe\tgeolocation service\tstarts,\tit\tshould\tregister\titself\ton\tthe\tZookeeper\tinstance.\tRegistering\tthe service\tis\tnot\tjust\tadding\tthe\tservice\ton\tZookeeper,\tbut\talso\tstoring\tany\tconfig information\tabout\tthe\tgeolocation\tservice.\tIn\tthis\tcase,\tit\twill\tmake\tmore\tsense to\tstore\tthe\thostname\tand\tport\ton\twhich\tthe\tservice\tis\tlistening\ton\tas\tconfig information.\n\nIn\tthis\trecipe,\twe\twill\tbe\trelying\ton\tthe\tCurator\tAPI\tto\timplement\tservice discovery.\tCurator\tis\ta\tsophisticated\tJava\tlibrary\tfor\tZookeeper\tthat\thelps\tyou work\twith\tany\tZookeeper\tcluster.\tIt\thas\tseveral\tlibraries,\tsuch\tas\tclient, framework,\tRPC,\tand\tdiscovery.\tIn\tour\tapplication,\twe\twill\trequire\tthe framework\tand\tdiscovery\tlibraries.\n\n1.\t Without\tfurther\tado,\tlet's\tadd\tthese\ttwo\tdependencies\tto\tthe\tpom.xml\tfile\tof the\tgeolocation\tproject:\n\n<dependency>\t<groupId>org.apache.curator</groupId> <artifactId>curator-framework</artifactId> <version>2.11.0</version>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-x-discovery</artifactId> <version>2.11.0</version>\t</dependency>\n\nThe\tversion\t2.11.0\tworks\twith\tthe\tversion\tof\tZookeeper\tthat\twe\tare\tusing. Usually\tif\tyou\tdon't\tuse\tthe\tright\tversion\tof\tCurator,\tyour\tcode\twill\tnot\tbe able\tto\tconnect\tto\tZookeeper.\n\n2.\t Go\tahead\tand\tperform\ta\tMaven\tupdate\ton\tthe\tgeolocation\tproject\tso\tthat Maven\tdownloads\tthe\trequired\tdependencies.\tNext,\tlet's\tcreate\ta\tnew\tclass that\twill\tregister\tthe\tgeolocation\tservice\tin\tZookeeper.\tCreate\ta\tnew\tJava\n\nclass\twith\tthe\tname com.packt.microservices.geolocation.Zookeeper.java.\tIn\torder\tto connect\tto\tZookeeper,\twe\tneed\tto\tknow\tthe\thost\tand\tport\ton\twhich\tit\tis running.\tSo\tlet's\tdefine\thost\tand\tport\tas\tmembers\tof\tthis\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\npublic\tclass\tZookeeper\t{\n\nprivate\tString\thost;\n\nprivate\tint\tport;\n\npublic\tZookeeper(String\thost,\tint\tport)\t{\n\nthis.host\t=\thost;\n\nthis.port\t=\tport;\n\n}\n\npublic\tvoid\tregister()\t{\n\n}\n\n}\n\n3.\t As\tyou\tcan\tsee,\twe\thave\talso\tcreated\ta\tconstructor\tto\tinstantiate\tthis\tclass. If\tyou\tare\ta\tSpring\tfan,\tyou\tcan\tcreate\tthis\tas\ta\tSpring\tbean\ttoo.\tThere\tis also\tan\tempty\tregister()\tmethod\tthat\twe\twill\tbe\tlater\tusing\tto\tregister\tthis\n\nservice\tin\tZookeeper.\tBefore\twe\tstart\timplementing\tthe\tregister() method,\tlet's\tdecide\twhere\tto\tinvoke\tthis\tmethod.\tSince\tour\tapp\tis\ta\tSpring Boot\tapplication,\tit\twould\tbe\ta\tgood\tidea\tto\tinvoke\tthis\tmethod\tfrom\tthe main\tmethod\tof\tthe\tGeolocationApplication.java\tclass.\tGo\tahead\tand invoke\tthe\tregister()\tmethod\tas\tthe\tlast\tline\tof\tthe\tmain\tmethod\tin GeolocationApplication.java.\tThe\tGeolocationApplication.java\tclass will\tnow\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\torg.springframework.boot.SpringApplication; import\torg.springframework.boot.autoconfigure.\n\nSpringBootApplication;\n\n@SpringBootApplication\n\npublic\tclass\tGeoLocationApplication\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{\n\nSpringApplication.run(GeoLocationApplication.class, args);\n\nnew\tZookeeper(\"192.168.99.100\",\t2181).register();\t}\n\n}\n\n4.\t As\tyou\tcan\tsee,\twe\thave\thardcoded\tthe\tZookeeper\thost\tand\tport\tnumber\tas 192.168.99.100\tand\t2181,\trespectively.\tTo\tmake\tyour\tmicroservice\tmore\n\nconfigurable,\tthese\ttwo\targuments\tcan\tbe\tpassed\tas\t\tenvironment\tvariables to\tthe\tDocker\tcontainer\tand\tI'll\tleave\tthat\tas\tan\texercise\tfor\tyou\tto\ttry. 5.\t Now\tlet's\timplement\tthe\tremaining\tpieces\tin\tthe\tZookeeper.java\tclass.\n\nThere\tis\tone\tmore\tthing\twe\tneed\tto\tdo\tbefore\twe\timplement\tthe register()\tmethod.\tYes,\tyou\tare\tright:\twe\tneed\tthe\thostname\tand\tport number\ton\twhich\tthe\tgeolocation\tmicroservice\tis\trunning,\tbecause\tthey\t(at least\tthe\thost)\twill\tbe\tdifferent\tfor\tdifferent\tcontainers.\tLet's\tfirst\thandle\tthe hostname\tpart\tof\tit.\tGo\tahead\tand\tadd\tthe\tfollowing\tmethod\tto\tthe Zookeeper.java\tclass:\n\nprivate\tString\tgetIp()\t{\n\ntry\t{\n\nreturn\tInetAddress.getLocalHost().getHostAddress(); }\tcatch\t(UnknownHostException\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tlocal\tIP. Using\tlocalhost\tfor\tnow.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\nreturn\t\"localhost\";\n\n}\n\n}\n\nHere,\twe\tare\tusing\tthe\tInetAddress\tclass\tto\tget\tthe\tlocal\tIP\tof\tthe\tmachine on\twhich\tthis\tservice\tis\trunning.\tIf\tit\tthrows\tan\tUnknownHostException,\twe are\tdefaulting\tthe\thostname\tto\tlocalhost.\tThough\tthis\tis\tnot\ta\tgreat implementation,\tthe\tgoal\tof\tthis\trecipe\tis\tto\tgive\tyou\tan\tidea\tof\thow\tyou can\tuse\tZookeeper\tfor\tload-balancing,\tso\tthis\timplementation\twill\twork\tfor now.\n\n6.\t The\tnext\tconfiguration\twe\tneed\tis\tthe\tport\tnumber\ton\twhich\tthe\tapplication\n\nis\trunning.\tThis\tis\ta\tlittle\ttricky\tbecause\tSpring\tBoot\tdefaults\tthe\tport number\tof\tthe\tin-memory\tweb\tserver\tto\t8080.\tBut\tif\twe\tfind\ta\tway\tto\tuse an\tenvironment\tvariable,\tit\twould\thelp\tus\tdrive\tthe\tport\tnumber dynamically,\twhich\tcan\tthen\tbe\tpassed\tas\ta\tDocker\tenvironment\tvariable\tto our\tgeolocation\tcontainer.\tHowever,\tif\tyou\tknow\tthat\tyou\twill\talways\tbe using\t8080,\tthen\tyou\tdon't\thave\tto\tchange\tthis.\tIf\tyou\tdo\thave\tto\tchange ports,\tfortunately,\tSpring\tBoot\tlets\tyou\tchange\tthe\tport\tnumber\ton\twhich the\tweb\tserver\tstarts\tusing\ta\tproperty\tin\tthe\tapplication.properties\tfile. So\tcreate\ta\tnew\tproperties\tfile\tcalled\tapplication.properties\tin src/main/resources.\tIn\tthe\tfile,\tdrop\tthe\tfollowing\tline:\n\nserver.port=${GEOLOCATION_SERVICE_PORT:8080}\n\n7.\t As\tyou\tcan\tsee,\twe\tare\tderiving\tthe\tport\tnumber\tfrom\tan\tenvironment variable\tcalled\tGEOLOCATION_SERVICE_PORT.\tIf\tthe\tenvironment\tvariable\tis not\tdefined,\tit\tis\tdefaulted\tto\t8080.\tNow\tlet's\timplement\ta\tnew\tmethod\tin the\tZookeeper.java\tclass\tto\tget\tthis\tport\tnumber.\tAdd\tthe\tfollowing method\tto\tZookeeper.java:\n\nprivate\tint\tgetPort()\t{\n\ntry\t{\n\nreturn\tInteger.valueOf(System.getenv (\"GEOLOCATION_SERVICE_PORT\"));\t}\tcatch(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tservice port.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\nreturn\t8080;\n\n}\n\n}\n\nIn\tthe\tgetPort()\tmethod,\twe\tare\tparsing\tthe\tport\tnumber\tfrom\tthe GEOLOCATION_SERVICE_PORT\tenvironment\tproperty.\tIf\tthe\tparsing\tfails,\twe default\tthe\tport\tnumber\tto\t8080.\tAgain,\tthis\tis\tnot\ta\tgreat\timplementation, but\tit\tis\ta\tgood\tstart\tto\timplementing\tload-balancing\tusing\tZookeeper. 8.\t With\tthat\tsaid,\tlet's\tadd\timplementation\tto\tthe\tregister()\tmethod.\tAdd\tthe\n\nfollowing\tsnippet\tto\tthe\tregister\tmethod:\n\npublic\tvoid\tregister()\t{\n\nCuratorFramework\tcurator\t=\n\nCuratorFrameworkFactory.newClient(host\t+\t\":\"\t+ port,\tnew\tRetryNTimes(3,\t3000));\n\ncurator.start();\n\ntry\t{\n\nfinal\tServiceInstance<Object>\tserviceInstance\t=\n\nServiceInstance.builder()\t\t\t\t\t\t.uriSpec(new UriSpec(\"\n\n{scheme}://{address}:{port}\")) .address(getIp()).port(getPort())\t.name(\"geolocation\")\n\n.build();\n\nfinal\tServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curator)\n\n.basePath(\"com.packt.microservices\")\t.client(curator)\n\n.thisInstance(serviceInstance)\t.build();\n\nserviceDiscovery.start();\n\nRuntime.getRuntime().addShutdownHook(new\tThread(() ->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService(serviceInstance);\t}\tcatch (Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering service\tin\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\n}\n\n}));\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tregistering\tservice in\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\n}\n\n}\n\n9.\t There\tare\tfour\tmajor\tthings\thappening\there.\tLet's\ttake\ta\tlook\tat\tthem\tone by\tone:\n\nCuratorFramework\tcurator\t=\n\nCuratorFrameworkFactory.newClient(host\t+\t\":\"\t+\tport, new\tRetryNTimes(3,\t3000));\n\ncurator.start();\n\n10.\t In\tthe\tpreceding\tline,\twe\tconnect\tto\tZookeeper\tand\tstart\tthe\n\nCuratorFramework.\tThe\thost\tand\tport\tproperties\tthat\tare\tbeing\tused\tin\tthe preceding\tline\tare\tthe\thostname\tand\tport\tnumber\tof\tZookeeper\t(which\twere hardcoded\tto\t192.168.99.100\tand\t2181,\trespectively).\tRetryNTimes\tcomes with\tthe\tCurator\tAPI,\tand\tit\ttries\tthree\ttimes\tto\tconnect\tto\tZookeeper\twith\ta 3-second\ttimeout\teach\ttime.\n\nfinal\tServiceInstance<Object>\tserviceInstance\t=\n\nServiceInstance.builder().uriSpec(new\tUriSpec(\" {scheme}://{address}:\n\n{port}\")).address(getIp())\n\n.port(getPort())\n\n.name(\"geolocation\").build();\n\n11.\t The\tServiceInstance\tidentifies\tan\tinstance\tof\tour\tgeolocation\tservice\tin Zookeeper.\tAs\tyou\tcan\tsee,\twe\thave\talso\tpassed\tthe\taddress\tand\tport number\tof\tour\tservice\tusing\tthe\tgetIp()\tand\tgetPort()\tmethods.\tThe name\tof\tthe\tservice\tthat\twill\tbe\tused\tfor\tregistering\tand\tlookup\tis\n\ngeolocation:\n\nfinal\tServiceDiscovery<Object> serviceDiscovery=ServiceDiscoveryBuilder\t.builder(Object.class)\n\n.basePath(\"com.packt.microservices\")\t.client(curator)\n\n.thisInstance(serviceInstance)\n\n.build();\n\nserviceDiscovery.start();\n\n12.\t In\tthe\tpreceding\tsnippet,\twe\tare\tregistering\tthe\tgeolocation\tservice\tinstance in\tZookeeper\twith\tthe\tbase\tpath\tcom.packt.microservices.\tIn\tthe\tfuture, if\tyou\twould\tlike\tto\tgroup\tmultiple\tservices,\tyou\tcould\tstill\tuse\tthe\tsame basePath\tbut\tdifferent\tservice\tnames.\n\nRuntime.getRuntime().addShutdownHook(new\tThread(()\t->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService(serviceInstance);\t}\tcatch (Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering service\tin\tZookeeper.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\n}\n\n}));\n\n13.\t In\tthe\tpreceding\tsnippet,\twe\tare\tadding\ta\tshutdown\thook\tto\tunregister\tthe geolocation\tservice\twhen\tthe\tmicroservice\tshuts\tdown.\tThis\tis\tstrongly recommended\tin\torder\tto\tclean\tup\tZookeeper\tso\tthat\tyou\tdon't\thave\tstale services\tregistered\tin\tZookeeper.\n\n14.\t After\tthese\tmodifications,\tthe\tZookeeper.java\tclass\tshould\tlook\tsomething like\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.net.InetAddress;\n\nimport\tjava.net.UnknownHostException;\n\nimport\torg.apache.curator.framework.CuratorFramework; import\torg.apache.curator.framework.CuratorFrameworkFactory; import\torg.apache.curator.retry.RetryNTimes;\timport org.apache.curator.x.discovery.ServiceDiscovery;\timport org.apache.curator.x.discovery.ServiceDiscoveryBuilder;\timport org.apache.curator.x.discovery.ServiceInstance;\timport org.apache.curator.x.discovery.UriSpec;\n\npublic\tclass\tZookeeper\t{\n\nprivate\tString\thost;\n\nprivate\tint\tport;\n\npublic\tZookeeper(String\thost,\tint\tport)\t{\n\nthis.host\t=\thost;\n\nthis.port\t=\tport;\n\n}\n\npublic\tvoid\tregister()\t{\n\nCuratorFramework\tcurator\t= CuratorFrameworkFactory.newClient(host\t+\t\":\"\n\n+\tport,\tnew\tRetryNTimes(3,\t3000)); curator.start();\n\ntry\t{\n\nfinal\tServiceInstance<Object>\tserviceInstance\t= ServiceInstance.builder()\t.uriSpec(new\tUriSpec(\" {scheme}://{address}:{port}\"))\t.address(getIp())\n\n.port(getPort())\n\n.name(\"geolocation\")\n\n.build();\n\nfinal\tServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curator)\n\n.thisInstance(serviceInstance)\t.build();\n\nserviceDiscovery.start();\n\nRuntime.getRuntime().addShutdownHook(new Thread(()\t->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService (serviceInstance);\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering servicein\tZookeeper.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\n}\n\n}));\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tregistering service\tin\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\ne.printStackTrace();\n\n}\n\n}\n\nprivate\tString\tgetIp()\t{\n\ntry\t{\n\nreturn InetAddress.getLocalHost().getHostAddress();\t}\tcatch (UnknownHostException\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tlocal\tIP. Using\tlocalhost\tfor\tnow.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\nreturn\t\"localhost\";\n\n}\n\n}\n\nprivate\tint\tgetPort()\t{\n\ntry\t{\n\nreturn\tInteger.valueOf(System.getenv (\"GEOLOCATION_SERVICE_PORT\"));\t}\tcatch(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding service\tport.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+\n\nservice\tport.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\nreturn\t8080;\n\n}\n\n}\n\n}\n\n15.\t Now\tthat\tour\tmicroservice\tis\tready\tto\twork\twith\tZookeeper,\tlet's\tspin\toff two\tinstances\tof\tthe\tgeolocation\tservice\tand\tverify\tthat\tthey\tregister successfully\ton\tZookeeper.\tBut\tbefore\tthat,\tlet's\tbuild\ta\tnew\timage\tand push\tit\tto\tDocker\tHub.\n\n16.\t Go\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand. This\tshould\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe target\tdirectory.\n\n17.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\texisting\timage.\tTo\tdo\tso, run\tthe\tfollowing\tcommand:\n\ndocker\trmi\tvikrammurugesan/geolocation\n\n18.\t To\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\n19.\t Make\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine\tin\tthe\tpreceding commands.\tAfter\tyour\timage\thas\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto Docker\tHub\tusing\tthe\tfollowing\tcommand.\tYou\tmight\tbe\tasked\tto\tlogin\tto your\tDocker\tHub\taccount\tif\tyou\thaven't\talready\tdone\tso. docker\tpush\tvikrammurugesan/geolocation\n\n20.\t Again,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe Last\tUpdated\ttime\tof\tyour\timage\tis\tsomething\tmore\trecent.\tNow\tthat\tour image\tis\tready\tto\tuse,\topen\tup\ttwo\tterminals\tand\tspin\toff\ttwo\tinstances\tof the\tgeolocation\tmicroservice:\n\ndocker\trun\tvikrammurugesan/geolocation\n\n21.\t While\tyou\tstart\tthe\tmicroservice,\tif\tyou\tsee\ta\tstack\ttrace\tthat\tsays\tthere\tis\ta NullPointerException\tin\tthe\tgetIp()\tmethod,\tit's\tbecause\twe\tdid\tnot\tpass the\tGEOLOCATION_SERVICE_PORT\tport\tnumber\tproperty\tto\teither\tof\tthe containers.\tYou\tcan\tignore\tas\tour\tservice\twill\tuse\t8080\tby\tdefault.\n\n22.\t After\tboth\tyour\tgeolocation\tservices\thave\tstarted,\topen\tup\tthe\tExhibitor\tUI using\tthe\tURL http://192.168.99.100:8181/exhibitor/v1/ui/index.html,\tand navigate\tto\tthe\tExplorer\ttab.\tNow\tyou\tshould\tsee\ta\tnew\titem\tcalled com.packt.microservices,\tand\tyou\tshould\tsee\tgeolocation\tunder\tit.\tIf you\texpand\tgeolocation,\tyou\tshould\tsee\ttwo\tinstances\twith\ttheir\town unique\tidentifiers:\n\n23.\t If\tyou\twant\tto\texplore\tfurther,\tclick\ton\tany\tof\tthe\tinstances\tand\tlook\tat\tits details\tat\tthe\tbottom\tof\tthe\tpage.\tYou\tshould\tbe\table\tto\tsee\tthe\tservice name,\tID,\thost,\tport\tnumber,\tand\tother\tconfigurations\tof\tthis\tservice\tunder the\tData\tas\tString\tsection:\n\nThis\tbrings\tus\tto\tthe\tend\tof\tthe\tfirst\tpart\tof\tour\trecipe:\tregistering\tthe geolocation\tmicroservice\tin\tZookeeper.\n\nNow\tlet's\ttake\ta\tlook\tat\tbuilding\tour\tZookeeper-based\tload\tbalancer.\tThe\tload balancer\twill\tbe\tanother\tSpring\tBoot\tmicroservice\tthat\twill\tproxy\trequests\tover to\tthe\tgeolocation\tmicroservices\tin\ta\tround-robin\tfashion.\tIn\torder\tto\tachieve this\tbehavior,\twe\tneed\tthe\texact\tsame\tAPIs\ton\tthe\tload\tbalancer\tmicroservice.\n\n1.\t Go\tahead\tand\tcreate\ta\tnew\tMaven\tJAR\tproject\tcalled\tgeolocation-zk-lb with\tthe\tgroupId\tset\tto\tcom.packt.microservices\tand\tartifactId\tset to\tgeolocation-zk-lb.\tAs\tthis\tis\ta\tSpring\tBoot\tproject,\tadd\tspring-boot- starter-parent\tas\tthe\tparent\tmodule: <parent>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-parent</artifactId> <version>1.3.6.RELEASE</version>\t</parent>\n\n2.\t We\twill\tneed\ttwo\tMaven\tplugins\tfor\tthis\tmodule:\tmaven-compiler-plugin and\tspring-boot-maven-plugin.\tAdd\tthe\tsnippet\tto\tyour\tpom.xml\tfile:\n\n<properties>\t<start-class>com.packt.microservices.\n\ngeolocation.lb.GeolocationZkLoadBalancer</start- class>\t</properties>\n\nclass>\t</properties>\n\n<build>\n\n<plugins>\n\n<plugin>\n\n<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<configuration>\n\n<source>1.8</source>\t<target>1.8</target> </configuration>\n\n</plugin>\n\n<plugin>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-maven-plugin</artifactId>\t<executions>\n\n<execution>\n\n<goals>\n\n<goal>repackage</goal>\t</goals>\n\n</execution>\n\n</executions>\n\n<configuration>\n\n<configuration>\n\n<mainClass>${start-class}</mainClass> </configuration>\n\n</plugin>\n\n</plugins>\n\n</build>\n\n3.\t You\tshould\talready\tbe\tfamiliar\twith\tthe\tpreceding\tcode\tsnippet\tas\twe already\tcreated\ta\tmicroservice\tusing\tSpring\tBoot\tin\tthe\tfirst\tchapter.\tNow let's\tadd\tthe\tfollowing\tthree\tdependencies,\twhich\tyou\tare\talready\tfamiliar with:\n\n<dependencies>\t<dependency>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-web</artifactId>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-framework</artifactId> <version>2.11.0</version>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-x-discovery</artifactId> <version>2.11.0</version>\t</dependency>\n\n</dependencies>\n\n4.\t Perform\ta\tMaven\tupdate\ton\tthe\tproject\tto\tmake\tsure\tall\trequired\n\ndependencies\tare\tresolved.\tAfter\tthe\tbuild\tis\tcomplete,\tlet's\tcreate\tour Spring\tBoot\tapplication\tclass, com.packt.microservices.geolocation.lb.GeolocationZkLoadBalancer.java\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\torg.springframework.boot.SpringApplication; import\n\norg.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\n\npublic\tclass\tGeolocationZkLoadBalancer\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{\n\nSpringApplication.run (GeolocationZkLoadBalancer.class,\targs);\n\n}\n\n}\n\n5.\t The\tnext\tstep\tin\tour\tload\tbalancer\tmicroservice\tis\twriting\tthe\tZookeeper service-discovery\tlogic\tthat\tlooks\tup\tthe\tgeolocation\tservice\tinstances\tfrom Zookeeper\tin\ta\tround-robin\tfashion.\tTo\tdo\tthis,\tlet's\tcreate\ta\tnew\tclass\n\ncalled com.packt.microservices.geolocation.lb.ZookeeperServiceDiscovery.java\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\tjava.net.URI;\n\nimport\torg.apache.curator.framework.CuratorFramework; import\torg.apache.curator.framework.CuratorFrameworkFactory; import\torg.apache.curator.retry.RetryNTimes;\timport org.apache.curator.x.discovery.ServiceDiscovery;\timport org.apache.curator.x.discovery.ServiceDiscoveryBuilder;\timport org.apache.curator.x.discovery.ServiceProvider;\n\npublic\tclass\tZookeeperServiceDiscovery\t{\n\nprivate\tstatic\tServiceProvider<Object> geolocationServiceProvider;\t\tprivate\tstatic ServiceProvider<Object>\tgetGeolocationServiceProvider()\tthrows Exception\t{\n\nif(geolocationServiceProvider\t==\tnull)\t{\n\nCuratorFramework\tcuratorFramework\t=\n\nCuratorFrameworkFactory.newClient (\"192.168.99.100:2181\",\tnew\tRetryNTimes(5,\t1000)); curatorFramework.start();\n\nServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class)\n\nServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curatorFramework)\n\n.build(); serviceDiscovery.start();\n\ngeolocationServiceProvider\t=\n\nserviceDiscovery.serviceProviderBuilder() .serviceName(\"geolocation\")\t.build();\n\ngeolocationServiceProvider.start();\t}\n\nreturn\tgeolocationServiceProvider;\t}\n\npublic\tstatic\tURI\tgetGeolocationServiceUri()\tthrows Exception\t{\n\nreturn\tnew\n\nURI(getGeolocationServiceProvider() .getInstance().buildUriSpec());\t}\n\n}\n\nThere\tare\ta\tfew\tthings\tgoing\ton\there.\tFirst,\twe\tstart\tthe\tCurator\tframework, and\tthen,\twe\tuse\tthe\tServiceDiscovery\tinstance\tto\tbuild\tthe ServiceProvider\tobject\tfor\tthe\tgeolocation\tmicroservice\tat\tthe\tbasePath com.packt.microservices.\tYou\tcan\talso\tsee\tthat\tthe geolocationServiceProvider\tobject\tis\tkept\tsingleton\tso\tthat\twe\tdon't have\tto\tstart\tthe\tservice-discovery\tinstance\teach\ttime.\n\n6.\t Now\tthat\tour\tdiscovery\tlogic\tis\tready,\tlet's\twrite\tour\tcontroller\tthat\tcalls proxy\trequests\tto\tthe\tgeolocation\tmicroservice.\tGo\tahead\tand\tcreate\ta\tnew controller\tcalled com.packt.microservices.geolocation.lb.GeolocationProxyController.java.\n\n7.\t Let's\tfirst\tcreate\tthe\tfindAll()\tmethod,\twhich\tobtains\tall\tgeolocations saved\tby\tthe\tgeolocation\tmicroservice.\tAdd\tthe\tfollowing\tsnippet\tto\tthe GeolocationProxyController.java\tclass:\n\n@RequestMapping(path\t=\t\"/geolocation\",\tmethod\t=\n\nRequestMethod.GET,\tproduces\t=\t\"application/json\") public\t@ResponseBody\tString\tfindAll()\tthrows\tException\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();\n\nSystem.out.println(\"Proxying\tGET\trequest\tto\tservice\t\" +\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,\n\nserviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(),\n\nrequest.getQueryString(),\n\nnull);\n\nnull);\n\nreturn\trestTemplate.getForEntity(uri, String.class).getBody();\n\n}\n\nIn\tthe\tpreceding\tAPI,\twe\tare\tfirst\tobtaining\tthe\tURI\tfor\tour\tgeolocation microservice\tand\tthen\tusing\tthat\tURI\tto\tconstruct\ta\tnew\tURI\twith\tthe\tright path\tand\theaders.\tThe\tnewly\tcreated\tURI\tis\tthen\tinvoked\tusing\ta RestTemplate.\n\n8.\t We\twill\timplement\ta\tsimilar\tAPI\tfor\tcreating\tgeolocations.\tFinally,\ta\tfully refactored\tGeolocationProxyController.java\tclass\twill\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\tjava.net.URI;\n\nimport\tjavax.servlet.http.HttpServletRequest;\n\nimport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.http.HttpEntity;\timport org.springframework.http.HttpHeaders;\timport org.springframework.http.HttpMethod;\timport org.springframework.http.MediaType;\timport org.springframework.stereotype.Controller;\timport org.springframework.web.bind.annotation.RequestBody;\timport org.springframework.web.bind.annotation.RequestMapping;\timport org.springframework.web.bind.annotation.RequestMethod;\timport org.springframework.web.bind.annotation.ResponseBody;\timport org.springframework.web.client.RestTemplate;\n\n@Controller\n\n@RequestMapping(\"/geolocation\")\n\npublic\tclass\tGeolocationProxyController\t{\n\nprivate\tRestTemplate\trestTemplate\t=\tnew RestTemplate();\n\n@Autowired\n\nprivate\tHttpServletRequest\trequest;\n\n@RequestMapping(path\t=\t\"\",\tmethod\t= RequestMethod.POST,\tproduces\t=\t\"application/json\",\tconsumes\t=\n\n\"application/json\")\n\npublic\t@ResponseBody\tString\tcreate(@RequestBody String\tbody)\tthrows\tException\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();\n\nSystem.out.println(\"Proxying\tPOST\trequest\tto\tservice \"\t+\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,\n\nserviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(),\n\nrequest.getQueryString(),\n\nnull);\n\nHttpHeaders\theaders\t=\tnew\tHttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON);\n\nHttpEntity<String>\tentity\t=\tnew\tHttpEntity<String> (body,\theaders);\n\nreturn\trestTemplate.exchange(uri,\tHttpMethod.POST, entity,\tString.class).getBody();\n\n}\n\n@RequestMapping(path\t=\t\"\",\tmethod\t=\tRequestMethod.GET, produces\t=\t\"application/json\")\n\npublic\t@ResponseBody\tString\tfindAll()\tthrows Exception\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();\n\nSystem.out.println(\"Proxying\tGET\trequest\tto\tservice \"\t+\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,\n\nserviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(), request.getQueryString(),\tnull);\n\nreturn\trestTemplate.getForEntity(uri, String.class).getBody();\n\n}\n\n}\n\n9.\t Without\tfurther\tdelay,\tlet's\ttest\tour\tnewly\tcreated\tZookeeper-based\tHTTP load\tbalancer.\tIn\torder\tto\tdo\tthat,\twe\thave\tto\tfollow\tthese\tsteps:\n\n1.\tStart\tZookeeper\tand\tExhibitor.\n\n2.\tStart\ttwo\tinstances\tof\tgeolocation\t(as\tDocker\tcontainers).\n\n3.\tStart\tgeolocation-zk-lb.\n\n10.\t Use\tthe\tdocker-compose-zk.yml\tfile\tto\tstart\tZookeeper\tand\tExhibitor.\n\nOpen\tup\ttwo\tterminal\tsessions\tand\tissue\tthe\tfollowing\tcommand\ton\tboth\tof them:\n\ndocker\trun\tvikrammurugesan/geolocation\n\n11.\t Once\tyour\tgeolocation\tinstances\tare\tup\tand\trunning\t(which\tincludes registering\tto\tZookeeper\tas\twell),\tverify\tthat\tthese\tservices\tare\tregistered\tin Zookeeper\twith\tthe\tname\tgeolocation\tunder\tthe basePathcom.packt.microservices.\tYou\tshould\tbe\table\tto\tuse\tthe Exhibitor\tUI\tat http://192.168.99.100:8181/exhibitor/v1/ui/index.html\tto\tdo\tthis.\n\n12.\t Before\twe\tcan\tstart\tthe\tgeolocation-zk-lb\tmicroservice,\tit\tneeds\tto\tbe Dockerized\tso\tthat\tit\tcan\trun\tas\ta\tDocker\tcontainer.\tGo\tahead\tand\tcreate\ta Dockerfile\tin\tthe\tgeolocation-zk-lb\tproject,\twith\tthe\tfollowing\tcontents:\n\nFROM\topenjdk:8 ADD\ttarget/geolocation-zk-lb-0.0.1-SNAPSHOT.jar\t optpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-zk-lb- 0.0.1-SNAPSHOT.jar\"]\n\n13.\t Build\tthe\tproject\tusing\tthe\tmaven\tcommand:\tmvn\tclean\tpackage 14.\t Now\tbuild\tand\tstart\tthe\tgeolocation-zk-lb\timage\tusing\tthe\tfollowing command:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation-zk-lb\t.\t&&\tdocker\t run\t-p\t8080:8080\tvikrammurugesan/geolocation-zk-lb\n\n15.\t Once\tthe\tgeolocation-zk-lb\tcontainer\tis\tup\tand\trunning,\tissue\tthe following\tcurl\tcommands\tto\ttest\tthe\tload\tbalancer:\n\ncurl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:8080/geolocation\n\n16.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\n\n} curl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://192.168.99.100:8080/geolocation\n\n17.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthis\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\"timestamp\":\t1468203975 }\n\n18.\t To\tcheck\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\n\ncurl\thttp://192.168.99.100:8080/geolocation\n\n19.\t It\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t} ]\n\n20.\t But\twait!\tWe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's try\tthe\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\toutput\tlike this\t(pretty-printed\tfor\treadability): [ \t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t} ]\n\n21.\t Again,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime,\tit\tis\ta\tdifferent\tone.\tIn\n\norder\tto\tunderstand\twhat\tis\tgoing\ton,\twe\tshould\tfirst\tlook\tat\tthe\tlogs\tof\tthe geolocation-zk-lb\tcontainer.\tYou\tshould\thave\tsomething\tlike\tthis:\n\nProxying\tPOST\trequest\tto\tservice\thttp://172.17.0.2:8080\tat\tpath\t /geolocation Proxying\tPOST\trequest\tto\tservice\thttp://172.17.0.3:8080\tat\tpath\t /geolocation Proxying\tGET\trequest\tto\tservice\thttp://172.17.0.2:8080\tat\tpath\t /geolocation Proxying\tGET\trequest\tto\tservice\thttp://172.17.0.3:8080\tat\tpath\t /geolocation\n\n22.\t If\tyou\tnotice\tthe\tIPs\tin\tthe\tpreceding\tlogs,\tthey\tare\talternating.\tThis indicates\tthat\tour\tservice-discovery\tlogic\tuses\tround\trobin\tand\tworks\tas expected.\tAs\tour\tgeolocations\tare\tstored\tin\tmemory,\teach\tgeolocation instance\twas\tholding\tone\tgeolocation\teach.\tThat\tis\tthe\treason\twe\tgot\tone\tas a\tresult\tof\tthe\tGET\tAPI\teach\ttime.\tFor\tsimplicity,\twe\tstored\tour geolocations\tin\tmemory,\tbut\tin\tproduction\tscenarios,\tyou\twill\tbe\tstoring them\tin\tdatabases\tthat\tare\tshared\tby\tall\tthese\tinstances,\tso\twe\twill\tnot\thave this\tissue.\n\nNote\n\nThe\tZookeeperServiceDiscovery.java\tclass\tcan\tbe\trefactored\tto\thold\tmultiple service\tproviders,\tone\tfor\teach\tof\tyour\tmicroservices.\tIf\tyour\tecosystem\thas several\tmicroservices,\tyou\tcould\tstill\tuse\tthis\tapproach\tto\tload-balance\tthem using\tZookeeper.\tBut\tthis\tcomes\twith\tits\town\tmerits\tand\tdemerits.\tOne\tof\tthe demerits\tis\tthat\tyou\thave\tto\tcreate\tan\tAPI\tthat\tmatches\tthe\tmicroservice's\tAPI. Any\tchange\tto\tthe\tmicroservice's\tAPI\tcontract\twill\trequire\ta\tchange\tin\tthe\tload balancer\tas\twell.\tSo\twhen\tit\tcomes\tto\tseveral\thundred\tmicroservices,\tthis\tmight not\tbe\tscalable.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tCongrats!\tYou\tnow\tknow\thow\tto\tload- balance\tyour\tHTTP-based\tmicroservices\tusing\tZookeeper.\n\nSetting\tup\tConsul\tusing\tDocker\n\nSo\tfar\tin\tthis\tchapter,\twe've\ttalked\tabout\tthe\tneed\tfor\tservice\tdiscovery\tand\tload balancing.\tWe\talso\tlearned\thow\tto\tuse\tZookeeper\tto\tperform\tservice\tdiscovery and\tload\tbalancing.\tIf\tyou've\ttried\tthe\tprevious\trecipes\tin\tthis\tchapter,\tyou\twill have\trealized\tit\trequires\tsome\teffort\tto\tmanage\tyour\tservices\tin\tZookeeper.\tIt also\trequires\tsome\tcode\tto\tbe\twritten.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tlearn\tto\tdo the\tsame\tthing\twith\tConsul.\tConsul\tis\ta\tservice-discovery\tframework\tfrom HashiCorp\tthat\tis\tmulti-datacenter\taware.\tOne\tvery\tuseful\tfeature\tConsul\tcomes with\tis\tdistributed\tkey-value\tstorage.\tThis\tis\treally\tuseful\twhen\tyou\twant\tto store\tconfiguration\tinformation.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\torchestrate Consul\tusing\tDocker.\n\nGetting\tready\n\nHashiCorp\thas\treleased\tofficial\timages\tof\tconsul\tand\ttheir\tother\tproducts.\tSo this\trecipe\tis\tgoing\tto\tbe\tpretty\tstraightforward.\n\n1.\t The\teasiest\tway\tto\tstart\tConsul\tis\tby\texecuting\ta\tdocker\trun\tcommand with\tthe\timage\tname.\n\n2.\t The\tname\tof\tthe\timage\tis\tpretty\tstraightforward\ttoo:\tconsul.\tLike\twe\tsaw in\tthe\tfirst\trecipe\tof\tthis\tchapter,\tit\tis\talways\teasier\tto\tgroup\tyour\timages into\tDocker\tCompose\tfiles.\n\n3.\t So\twe\twill\tbe\tcreating\ta\tdocker-compose\tfile\tthat\thas\tjust\tConsul\tin\tit.\tWe will\tbe\tadding\tmore\tcontainers\tto\tthe\tCompose\tYML\tfile\tin\tlater\trecipes.\n\n4.\t Open\tyour\tSTS\tIDE.\n\nHow\tto\tdo\tit... 1.\t Create\ta\tnew\tdocker-compose\tYML\tfile\tand\tname\tit\tdocker-compose-\n\nconsul.yml.\tIn\tthe\tcompose\tfile,\tdrop\tthe\tfollowing\tsnippet:\n\nversion:\t\"2\" services: \t\t\t\t\t\t\t\tconsul: \t\t\t\t\t\t\t\t\t\timage:\tconsul:latest \t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t-\t\"8500:8500\"\n\n2.\t Now\tthat\tour\tdocker-compose\tfile\tis\tcomplete,\twe\tare\tall\tset\tto\tstart consul.\tBefore\tthat,\tlet's\tget\tfamiliar\twith\tsome\tbasic\tconcepts\tof\tconsul. Only\tthen\twill\twe\tbe\table\tto\tunderstand\twhy\twe\tare\tperforming\tthe\tnext few\tsteps\tin\tthis\tchapter.\n\nUnderstanding\tthe\tconcepts\tof\tConsul\n\nLike\twe\talready\tknow,\tConsul\tis\ta\tservice-discovery\ttool.\tIt\tachieves\tthis\tusing agents.\tTo\tput\tit\tin\ta\tsimpler\tway,\tconsul\tagents\tare\tlong-running\tprocesses\tthat keep\ttrack\tof\tall\tyour\tservices\tand\tany\tkey-value\tpairs.\tThough\tthis\tstatement makes\tconsul\tlook\tas\tif\tit\tis\ta\tsimple\ttool,\tit\tactually\toffers\tmore\tthan\tthat\t(such as\tDNS),\tand\tthe\tworking\tof\tconsul\tis\tmore\tcomplicated\tthan\tit\tlooks.\tNow\tlet's talk\ta\tlittle\tbit\tabout\tagents.\tAgents\tcan\tstart\teither\tas\ta\tclient\tor\tserver.\tIdeally, in\tany\tconsul\tcluster,\tthere\twill\tbe\tthree\tto\tfive\tservers\tand\ta\tfew\tclients.\n\nA\tclient\tis\ta\tlightweight\tprocess\tresponsible\tfor\tregistering\tservices\tand performing\thealth\tchecks.\tIn\tan\tideal\tproduction\tscenario,\tthere\tcould\tbe hundreds\tor\teven\tthousands\tof\tclients.\tOne\tof\tthe\tservers\tis\talways\tthe\tleader, and\tthe\tothers\tare\tfollowers.\tThe\treason\tfor\thaving\tmore\tservers\tis\tto\tensure\tthat if\tthe\tleader\tgoes\tdown,\tthere\tis\talways\tanother\tserver\tto\tbe\telected\tas\tleader.\tIf you\thave\ta\tmulti-datacenter\tinfrastructure,\tit\tis\trecommended\tthat\tyou\thave similar\tclusters\ton\teach\tdatacenter,\tand\tthey\tall\twill\twork\ttogether.\tThis\tis\thow an\tideal\tconsul\tcluster\ton\ta\tsingle\tdatacenter\tlooks\tlike:\n\nNote\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tthe\tarchitecture\tof\tconsul\tand\thow\tall these\tcomponents\twork\ttogether,\tvisit\tconsul's\tdocumentation\tpage\tat https://www.consul.io/docs/internals/architecture.html\t.\n\nWith\tthat,\twe\tnow\tknow\twhat\twe\tneed\tto\tdo\tnext.\tYou\tguessed\tit:\twe\tneed\tto start\ta\tconsul\tagent.\tIn\tthis\trecipe,\twe\twill\tbe\tstarting\tan\tagent\tin\tdevelopment mode.\tDevelopment\tmode\tstarts\tjust\tone\tserver,\tand\tconsul\thighly\tdiscourages the\tuse\tof\tthis\tmode\tin\tproduction\tunless\tused\tfor\tlocal\tdevelopment\tand\ttesting purposes.\n\n1.\t Now,\topen\ta\tterminal\tsession\tand\tissue\tthe\tfollowing\tcommand:\n\ndocker-compose\t-f\tdocker-compose-consul.yml\tup\n\n2.\t You\tshould\tsee\tsomething\tlike\tthis:\n\nIf\tyou\tlook\tat\tthe\tconsole\tlogs\tclosely,\tyou\tcan\tsee\tthat\tconsul\thas\tstarted one\tserver,\tand\tthis\tnode\tis\tpart\tof\tthe\tdata\tcenter\tcalled\tDC1.\tThe\tLAN and\tWAN\tservers\tare\tboth\trunning\ton\tport\t8300.\tWhile\tthe\tformer\tis\tused for\tcommunication\tbetween\tnodes\tin\tthe\tsame\tdata\tcenter,\tthe\tlatter\tis\tused for\tcommunication\twith\tservers\ton\tanother\tdata\tcenter.\n\n3.\t Once\tyou\tknow\tthat\tyour\tconsul\tagent\thas\tstarted\tsuccessfully,\topen\tup\ta new\tbrowser\tand\tnavigate\tto\tthis\tURL:\thttp://192.168.99.100:8500. 4.\t You\twill\tsee\tthe\tconsul\thome\tpage,\tand\tthe\tServices\ttab\twill\tbe\tselected\tby default.\tThis\tis\twhere\tyou\twill\tsee\tall\tyour\tregistered\tservices.\tYou\tshould see\ta\tservice\tcalled\tconsul.\tThat\tis\tbecause\tconsul\twill\thave\tregistered\tthe server\tas\ta\tservice:\n\n5.\t The\tother\ttab\tyou\tmight\tbe\tinterested\tin\tis\tthe\tKey/Value\ttab.\tThis\tis where\tyou\tcan\tcreate,\tview,\tupdate,\tand\tdelete\tyour\tkey-value\tpairs.\tAt\tthe top\tright,\tyou\tshould\tsee\ta\tdropdown\twith\tthe\tname\tof\tthe\tcurrently selected\tdata\tcenter.\tIf\tyou\thave\tmultiple\tdata\tcenters,\tthis\tdropdown\twill have\tmore\tthan\tone\tvalue,\tand\tyou\twill\tbe\table\tto\tsee\tthe\tnodes,\tservices,\n\nand\tkey-value\tpairs\tin\teach\tdata\tcenter.\tThis\tis\tvery\tuseful\twhen\tyou\thave\ta multi-datacenter\tsetup.\n\n6.\t Though\tServices\tis\tthe\tdefault\ttab\tselected\twhen\tyou\topen\tthe\tUI,\tthe Nodes\ttab\tis\tsomething\tthat\tmakes\tmore\tsense\tto\tstart\twith.\tNow\tlet's\tclick on\tit.\tOn\tthe\tleft-hand\tside,\tyou\twill\tsee\tthe\tlist\tof\tnodes\twith\ttheir\tIDs. Click\ton\tthe\tnode.\tNow\tyou\twill\tsee\tsome\tinteresting\tinformation\ton\tthe right-hand\tside:\n\nAs\tyou\tcan\tsee,\tit\tshows\tthe\tservices\tthat\tare\tcurrently\tdiscovered\tand shows\tthe\tSerf\tHealth\tStatus.\tSerf\tis\tanother\tproduct\tfrom\tHashiCorp\tthat is\tused\tby\tconsul\tfor\tcluster\tmemberships,\thealth\tchecks,\tand\tfailure detection.\n\nNote\n\nImportant\tinformation\tto\tnote\ton\tthis\tpage\tis\tthe\tport\tnumber,\t8300,\ton\tthe consul\tserver\twidget.\tIt\ttells\tyou\tthat\tthe\tConsul\tserver\tis\trunning\ton\tport 8300.\tAt\tthe\ttop\tright\tof\tthe\tpage,\tyou\tshould\tbe\table\tto\tsee\tthe\tDeregister button,\twhich\twill\tderegister\tthis\tnode\tfrom\tthe\tcluster.\tIf\tyou\tare interested,\tyou\tcan\tdrill\ta\tlittle\tdeeper\tto\tthe\tservice\tlevel.\n\n7.\t Go\tahead\tand\tclick\ton\tthe\tConsul\tservice,\tand\texplore\tthe\tvarious\toptions that\tconsul\toffers.\tAs\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tour\tbook,\twe\twill\tnot\n\nbe\ttalking\tabout\tit.\tHowever\tyou\twill\tget\ta\tchance\tto\tunderstand\tsome sections\tof\tthe\tservice\tpage\tin\tour\tnext\trecipe.\n\nImplementing\tservice\tdiscovery\tusing Spring\tCloud\tConsul\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\ta\tconsul\tagent\tin\tdevelopment.\tIn\tthis recipe,\twe\twill\tbe\tusing\tthat\tconsul\tagent\tto\timplement\tservice\tdiscovery\tfor\tthe geolocation\tmicroservice.\tWhen\twe\tdid\tsomething\tsimilar\tusing\tZookeeper, there\twas\tlot\tof\tcode\tinvolved\tto\tconnect\tto\tZookeeper,\tidentify\tthe\tIP,\tidentify the\tport,\tand\tfinally\tregister\tthe\tservice.\tWe\tperformed\tthese\tsteps\tusing\tthe curator\tAPI,\twhich\tmade\tour\tlife\teasier.\tBut\tfortunately,\tyou\tdon't\thave\tto\tdo\tall this\tfor\tconsul.\tSpring\tCloud\thas\ta\tlibrary\tfor\tconsul,\twhich\tautomatically registers\tthe\tservice\twith\tthe\thost\tand\tport\tinformation.\tAll\twe\thave\tto\tprovide\tis a\tcouple\tof\tproperties.\tLet's\ttake\ta\tlook\tat\thow\tto\tdo\tthat\tnow.\n\nGetting\tready 1.\t In\torder\tto\tregister\tthe\tgeolocation\tservice\tin\tconsul,\twe\tfirst\thave\tto\tmake sure\tthat\tthe\tconsul\tagent\tis\tup\tand\trunning.\tIf\tyou\tdon't\thave\tan\tagent running,\tstart\tit\tusing\tdocker-compose.\n\n2.\t Go\tahead\tand\tmake\tsure\tconsul\twas\tproperly\tstarted\tby\taccessing\tthe\tweb interface\tat\thttp://192.168.99.100:8500.\n\n3.\t There\tis\tone\tmore\tthing\twe\tneed\tto\tdo\tbefore\twe\tintegrate\tconsul\tinto\tour microservice.\tWe\thave\tto\tcomment\tout\tthe\tline\tof\tcode\tin\tthe GeolocationApplication.java\tclass,\twhere\tit\ttries\tto\tconnect\tto Zookeeper.\tSimply\tcomment\tout\tthat\tline\tso\tthat\tthe\tnext\ttime\tyou\tstart\tthe application,\tit\tdoes\tnot\ttry\tto\tconnect\tto\tZookeeper.\n\n4.\t Also,\tadd\ta\tcomment\tpreceding\tit\tsaying\tit\thas\tbeen\tcommented\tout\tfor\ta reason:\t//\tcommented\tout\tso\tthat\tthe\tservice\tdoes\tnot\ttry\tto\tconnect\tto zk\t//\tnew\tZookeeper(\"192.168.99.100\",\t2181).register();\n\nThat's\tit!\tNow\tlet's\tmove\ton\tto\tthe\tactual\timplementation\tpart,\twhere\twe\twill integrate\tconsul\twith\tthe\tgeolocation\tmicroservice.\n\nHow\tto\tdo\tit... 1.\t The\tfirst\tthing\twe\tneed\tto\tdo\tis\tadd\tthe\trequired\tdependencies\tto\tour pom.xml\tfile.\tThe\tdependency\tthat\tgeolocation\twill\tneed\tis\tspring- cloud-starter-consul-all.\tLet's\tadd\tit\tto\tthe\tdependencies\tsection\tof the\tpom.xml\tfile\tin\tthe\tgeolocation\tproject:\t<dependency> <groupId>org.springframework.cloud</groupId>\t<artifactId>spring-cloud- starter-consul-all</artifactId>\t<version>1.1.2.RELEASE</version> </dependency>\n\nThe\tpreceding\tdependency\tpacks\tpretty\tmuch\tall\tthe\tdependencies\tthat\tare required\tfor\tour\tproject\tto\tconnect\tto\tconsul\tand\tregister\tour\tservice.\tAs\twe have\tadded\ta\tnew\tdependency,\twe\thave\tto\tperform\ta\tMaven\tupdate\tto resolve\tall\tthe\tnew\tdependencies.\n\n2.\t When\tthe\tbuild\tis\tcomplete,\tcreate\ta\tnew\tproperties\tfile\tcalled bootstrap.properties\tin\tthe\tsrc/main/resources\tdirectory.\tAdd\tthe following\tsnippet\tto\tthe\tfile:\tspring.application.name=geolocation spring.cloud.consul.host=192.168.99.100\tspring.cloud.consul.port=8500\n\nThe\tspring.application.name\tproperty\tis\toptional,\tbut\tit\tis\thighly recommended\tbecause\tthat\tis\tthe\tname\twith\twhich\tthis\tservice\twill\tbe registered\ton\tconsul.\n\nThe\tother\ttwo\tproperties\tare\trequired\tto\ttell\tSpring\twhich\tConsul\tserver\tto connect\tto.\tThe\tspring.cloud.consul.host\tproperty\tindicates\tthe\thost\ton which\tconsul\tis\trunning,\tand\tspring.cloud.consul.port\tindicates\tthe\tport on\twhich\tthe\tconsul\tis\tlistening.\n\n3.\t The\tnext\tstep\tis\tadding\tthe\t@EnableDiscoveryClient\tannotation\tto\tthe GeolocationApplication.java\tclass.\tGo\tahead\tand\tadd\tthis\tannotation: @SpringBootApplication\t@EnableDiscoveryClient\tpublic\tclass GeoLocationApplication\t{\n\nThat\tis\tall\tyou\tneed\tto\tregister\tthis\tservice\ton\tconsul.\tSee\thow\teasy\tit\twas compared\tto\tdoing\tthe\tsame\tthing\twith\tZookeeper?\tThanks\tto\tSpring\tfor eliminating\tmost\tof\tour\tboilerplate\tcode.\n\n4.\t Before\twe\ttry\tto\tspin\toff\tan\tinstance\tof\tgeolocation,\tlet's\tbuild\ta\tDocker image\tfor\tthe\tnew\tcode\tchanges\tand\tpush\tit\tto\tDocker\tHub.\tGo\tahead\tand build\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand.\tThis\tshould\n\ncreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe\ttarget directory.\n\n5.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\texisting\timage\tthat\twe already\thave.\tTo\tdo\tthat,\trun\tthe\tfollowing\tcommand:\tdocker\trmi vikrammurugesan/geolocation\n\n6.\t To\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\tdocker build\t-t\tvikrammurugesan/geolocation\t.\n\n7.\t Use\tyour\taccount\tname\tinstead\tof\tmine\tin\tthe\tcommand.\tAfter\tyour\timage has\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto\tDocker\tHub\tusing\tthe\tfollowing command.\tYou\tmight\tbe\tasked\tto\tlog\tin\tto\tyour\tDocker\tHub\taccount\tif\tyou haven't\talready\tdone\tso:\tdocker\tpush\tvikrammurugesan/geolocation 8.\t Again,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe Last\tUpdated\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent. 9.\t Now\tthat\tour\timage\tis\tready\tto\tuse,\tlet's\ttry\tto\tstart\tour\tgeolocation\n\nservices.\tUsually,\twe\tstart\tthem\tusing\ta\tdocker\trun\tcommand,\tbut\tthis time,\tlet's\ttry\tstarting\tthem\tusing\tdocker-compose.\tGo\tahead\tand\tappend the\tfollowing\tsnippet\tto\tthe\tdocker-compose-consul.yml\tfile: geolocation-1:\timage:\tvikrammurugesan/geolocation:latest\tports:\t- \"8080\"\tenvironment:\tGEOLOCATION_SERVICE_PORT:\t\"8080\" geolocation-2:\timage:\tvikrammurugesan/geolocation:latest\tports:\t- \"8081\"\tenvironment:\tGEOLOCATION_SERVICE_PORT:\t\"8081\"\n\nAs\tyou\tcan\tsee,\twe\thave\tadded\ttwo\tinstances\tof\tgeolocation;\tone\trunning on\tport\t8080\tand\tthe\tother\ton\tport\t8081.\n\n10.\t Now\tstop\tany\trunning\tcontainers\ton\tyour\tcomputer.\tMake\tsure\tthere\tare\tno instances\tof\tconsul\tor\tgeolocation\trunning.\tStart\tthe\tconsul\tagent\tand geolocation\tservices\tusing\tthe\tfollowing\tdocker-compose\tcommand: docker-compose\t-f\tdocker-compose-consul.yml\tup\n\n11.\t Usually,\tit\ttakes\ta\tfew\tminutes\tto\tregister\tthe\ttwo\tservices\ton\tconsul.\tIn\tthe meantime,\tyou\tcan\topen\tup\tthe\tconsul\tUI\tconsole\tat http://192.168.99.100:8500.\n\n12.\t Keep\trefreshing\tthe\tServices\tpage\tand\twait\tfor\tboth\tthe\tgeolocation services\tto\tbe\tup\tand\trunning.\tIt\ttakes\tat\tleast\t2-5\tminutes,\tbased\ton\tthe configuration\tof\tyour\tmachine.\tYou\twill\tknow\tthat\tboth\tthe\tservices\tare running\twhen\tyou\tsee\tthat\tall\tfour\tchecks\tpassed\tfor\tthe\tgeolocation service.\n\n13.\t Both\tthe\tinstances\twill\thave\tthe\tsame\tname\tgeolocation\tand\teach\tof\tthem will\thave\ttwo\tchecks:\tSerf\tcheck\tand\thealth\tcheck.\tWe\twill\ttalk\tmore\tabout health\tchecks\tin\tChapter\t6,\tMonitoring\tMicroservices.\tFor\tnow,\tjust\tkeep in\tmind\tthat\tit\tis\tan\tendpoint\texposed\tby\tSpring\tto\tprovide\thigh-level health\tinformation\tabout\tthe\tapplication.\tYou\twill\tknow\tthat\tboth\tthe services\thave\tbeen\tregistered\tonce\tyou\tsee\tsomething\tlike\tthis:\n\nNow\tmove\ton\tto\tthe\tNodes\ttab\tand\tclick\ton\tthe\tnode\tID.\tOn\tthe\tright-hand side,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tinstances\tof\tgeolocation\tservices\tregistered, one\trunning\ton\tport\t8080\tand\tthe\tother\ton\tport\t8081:\n\nIf\tyou\tdo\tnot\thave\taccess\tto\tthe\tconsul\tUI,\tyou\tcan\tstill\tget\tthe\tlist\tof\n\nregistered\tservices\tusing\ta\tsimple\tcURL\tcommand.\tConsul\thas\ta\tgood\tREST API\tthat\tcan\tbe\tused\tto\tperform\tpretty\tmuch\tmost\tof\tthe\toperations\tthat\tyou\tcan perform\tfrom\tthe\tUI.\tExecute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal session:\tcurl\thttp://192.168.99.100:8500/v1/agent/services\n\nYou\tshould\thave\ta\tresponse\tsimilar\tto\tthis\t(pretty-printed\tfor\treadability):\t{ \"consul\":\t{\t\"ID\":\t\"consul\",\t\"Service\":\t\"consul\",\t\"Tags\":\t[],\t\"Address\":\t\"\",\t\"Port\": 8300,\t\"EnableTagOverride\":\tfalse,\t\"CreateIndex\":\t0,\t\"ModifyIndex\":\t0\t},\n\n\"geolocation-8080\":\t{\t\"ID\":\t\"geolocation-8080\",\t\"Service\":\t\"geolocation\", \"Tags\":\t[],\t\"Address\":\t\"e5da6bf7309d\",\t\"Port\":\t8080,\t\"EnableTagOverride\": false,\t\"CreateIndex\":\t0,\t\"ModifyIndex\":\t0\t},\t\"geolocation-8081\":\t{\t\"ID\": \"geolocation-8081\",\t\"Service\":\t\"geolocation\",\t\"Tags\":\t[],\t\"Address\": \"23039f240cd5\",\t\"Port\":\t8081,\t\"EnableTagOverride\":\tfalse,\t\"CreateIndex\":\t0, \"ModifyIndex\":\t0\t}\t}\n\nNote\tthe\taddress\tfield\tfor\tboth\tthe\tgeolocation\tservices.\tThose\taddresses\twill\n\nbe\tresolved\tto\tthe\trespective\tcontainer's\thostnames\tby\tConsul.\n\nWith\tthat,\twe\thave\tsuccessfully\tregistered\tour\tservices\ton\tConsul\tusing\tDocker. The\tnext\tstep\twill\tbe\tload-balancing\tour\tAPIs\tusing\tConsul,\twhich\twe\twill\tlearn in\tthe\tnext\trecipe.\n\nLoad\tbalancing\tyour\tmicroservice using\tSpring\tCloud\tConsul\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tset\tup\tConsul\tand\tthen\tlearned\thow to\timplement\tservice\tdiscovery\tin\tConsul\tusing\tSpring\tCloud\tConsul.\tNow, your\tother\tservices\tcan\tdiscover\tthe\tgeolocation\tservice\twith\tthe\thelp\tof\tConsul. Earlier,\twe\ttalked\tabout\thow\tsignificant\tload\tbalancing\tis\tand\thow\twe\tcan\tdo\tit using\tZookeeper.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tperform\tload\tbalancing using\tConsul\twith\tthe\thelp\tof\tSpring\tCloud\tConsul.\n\nGetting\tready\n\nThere\tmay\tbe\tscenarios\twhere\tone\tmicroservice\twould\twant\tto\tinvoke\tanother microservice's\tREST\tAPI.\tWhat\tif\tthe\ttarget\tmicroservice\tis\tloadbalanced\tusing Consul?\tThat\tis\texactly\twhat\twe\tare\tgoing\tto\tdemonstrate\tin\tthis\trecipe.\tWe\twill be\twriting\ta\tnew\tmicroservice\tcalled\tgeolocation-consul-lb\tthat\twill\tload balance\tagainst\ttwo\tinstances\tof\tgeolocation\tmicroservice\tin\ta\tround-robin fashion.\tWhen\tyou\tmove\taway\tfrom\ta\tmonolithic\tapplication\tto\tmore\tfocused microservices,\tyou\twill\tend\tup\tin\ta\tsituation\twhere\tyou\twould\twant\tyour microservices\tto\tcommunicate\tin\tan\tefficient\tway.\tThis\trecipe\talong\twith\tthe previous\tone\twill\thelp\tyou\tdo\tthat\tusing\tConsul.\n\nHow\tto\tdo\tit... 1.\t Create\ta\tnew\tMaven\tJAR\tproject\twith\tthe\tgroupId\tset\tto\n\ncom.packt.microservices\tand\tartifactId\tset\tto\tgeolocation-consul- lb.\tAs\tthis\twill\tbe\ta\tSpring\tBoot\tproject,\twe\tneed\tto\tadd\tspring-boot- start-parent\tas\tthe\tparent\tproject.\n\n2.\t We'll\talso\tneed\tthe\tspring-boot-maven-plugin.\tGo\tahead\tand\tadd\tthe following\tsnippet\tto\tyour\tnewly\tcreated\tproject's\tpom.xml\tfile:\t<parent> <groupId>org.springframework.boot</groupId>\t<artifactId>spring-boot- starter-parent</artifactId>\t<version>1.3.6.RELEASE</version>\t</parent> <properties>\t<start-class>com.packt.microservices.geolocation.lb. GeolocationConsulLoadBalancer</start-class>\t</properties>\t<build> <plugins>\t<plugin>\t<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<configuration> <source>1.8</source>\t<target>1.8</target>\t</configuration>\t</plugin> <plugin>\t<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-maven-plugin</artifactId>\t<executions> <execution>\t<goals>\t<goal>repackage</goal>\t</goals>\t</execution> </executions>\t<configuration>\t<mainClass>${start-class}</mainClass> </configuration>\t</plugin>\t</plugins>\t</build>\n\n3.\t We\twill\trequire\ttwo\tdependencies\tfor\tthe\tproject.\tOne\tis\tthe\tspring-boot- starter-web\tdependency\tas\tour\tproject\twill\tuse\tSpring\tMVC,\tand\tthe other\tis\tspring-cloud-starter-consul-all\tas\twe\twill\tbe\tlooking\tup services\tfrom\tConsul:\t<dependencies>\t<dependency> <groupId>org.springframework.boot</groupId>\t<artifactId>spring-boot- starter-web</artifactId>\t</dependency>\t<dependency> <groupId>org.springframework.cloud</groupId>\t<artifactId>spring-cloud- starter-Consul-all</artifactId>\t<version>1.1.2.RELEASE</version> </dependency>\t</dependencies>\n\n4.\t Now\tthat\tthe\tpom.xml\tfile\tis\tready,\tlet's\twrite\tour\tapplication\tclass.\tCreate\ta new\tclass\tcalled com.packt.microservices.geolocation.lb.GeolocationConsulLoadBalancer.java\n\n5.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tclass:\tpackage com.packt.microservices.geolocation.lb;\timport org.springframework.boot.SpringApplication;\timport org.springframework.boot.autoconfigure.\tSpringBootApplication;\timport org.springframework.cloud.client.discovery.\tEnableDiscoveryClient;\n\nimport\torg.springframework.cloud.client.\tloadbalancer.LoadBalanced; import\torg.springframework.context.annotation.Bean;\timport org.springframework.web.client.RestTemplate;\t@SpringBootApplication @EnableDiscoveryClient\tpublic\tclass\tGeolocationConsulLoadBalancer\t{ @LoadBalanced\t@Bean\tpublic\tRestTemplate\trestTemplate()\t{\treturn\tnew RestTemplate();\t}\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{ SpringApplication.run\t(GeolocationConsulLoadBalancer.class,\targs);\t}\t}\n\nThere\tare\ta\tcouple\tof\tannotations\tto\tnote\there.\tThe @EnableDiscoveryClient\tannotation\tis\trequired\tto\ttell\tSpring\tthat\twe\twill be\tconnecting\tto\tConsul\tto\tlook\tup\tservices.\tThe\tsecond\tinteresting annotation\tis\tthe\t@LoadBalanced\tannotation.\tThis\tannotation\tsays\tthat\tthe RestTemplate\tbean\tthat\tis\tdefined\there\tshould\tloadbalance\tagainst\tthe given\tservice\tURL.\tYou\twill\tunderstand\tthis\tvery\tclearly\tonce\twe\twrite\tthe controller\tclass,\tso\thold\ton.\n\n6.\t Let's\twrite\tour\tcontroller,\n\ncom.packt.microservices.geolocation.lb.GeolocationProxyController.java Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tclass:\tpackage com.packt.microservices.geolocation.lb;\timport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.http.HttpEntity;\timport org.springframework.http.HttpHeaders;\timport org.springframework.http.HttpMethod;\timport org.springframework.http.MediaType;\timport org.springframework.web.bind.annotation.RequestBody;\timport org.springframework.web.bind.annotation.RequestMapping;\timport org.springframework.web.bind.annotation.RequestMethod;\timport org.springframework.web.bind.annotation.ResponseBody;\timport org.springframework.web.bind.annotation.RestController;\timport org.springframework.web.client.RestTemplate;\t@RestController @RequestMapping(\"geolocation\")\tpublic\tclass GeolocationProxyController\t{\t@Autowired\tprivate\tRestTemplate restTemplate;\t@RequestMapping(path\t=\t\"\",\tmethod\t= RequestMethod.GET,\tproduces\t=\t\"applicationjson\")\tpublic @ResponseBody\tString\tfindAll()\tthrows\tException\t{\treturn restTemplate.getForObject\t(\"http://geolocation/geolocation\",\tString.class); }\t@RequestMapping(path\t=\t\"\",\tmethod\t=\tRequestMethod.POST,\tproduces\n\n=\t\"application/json\",\tconsumes\t=\t\"application/json\")\tpublic @ResponseBody\tString\tcreate(@RequestBody\tString\tbody)\tthrows Exception\t{\tHttpHeaders\theaders\t=\tnew\tHttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity<String>\tentity\t=\tnew\tHttpEntity<String>(body,\theaders);\treturn restTemplate.exchange\t(\"http://geolocation/geolocation\", HttpMethod.POST,\tentity,\tString.class).getBody();\t}\t}\n\nWe\thave\tcreated\ttwo\trequest\tmappings\tthat\tmatch\tthe\tAPIs\tin\tgeolocation microservice.\tWe\tare\tactually\timplementing\ta\tproxy\tapplication.\tIn\teach\tof the\tmethods,\twe\tare\tusing\ta\tRestTemplate\tto\tmake\tcalls\tto\tthe geolocation\tservice.\tSee\thow\twe\thave\tautowired\tRestTemplate\tinstead\tof instantiating\tit.\tThat\tis\tbecause\twe\twould\tlike\tto\tuse\tthe\tbean\tthat\twas defined\tin\tthe\tGeolocationConsulLoadBalancer.java\tclass.\tThis restTemplate\tbean\twill\tloadbalance\tthe\tservice\tcalls\tagainst\tthe\tdifferent instances\tof\tthe\ttarget\tservice.\tNote\tthat\tthe\trestTemplate\tbean\tmakes\ta call\tto\tthe\tURL\thttp://geolocation/geolocation.\tSee\thow\tthe\thostname is\tset\tto\tgeolocation.\tAs\tthis\trestTemplate\tbean\tis\tConsul\taware,\tit\twill look\tup\tservices\tregistered\twith\tthe\tname\tgeolocation\tand\tloadbalance against\tthose\tservices\tin\ta\tround-robin\tfashion.\tIt\tis\tas\tsimple\tas\tthat. 7.\t The\tfinal\tstep\twe\tneed\tto\tperform\tis\tadd\tapplication.properties\tand bootstrap.properties\tto\tsrc/main/resources.\tLet's\tuse\tport\tnumber 8899\tas\tthe\tweb\tserver\tport\tnumber.\tAdd\tthe\tfollowing\tcontents\tto\tthe application.properties\tfile:\tserver.port=8899\n\n8.\t In\tthe\tbootstrap.properties\tfile,\twe\twill\tadd\tthe\thostname\tand\tport number\tof\tConsul.\tIn\taddition\tto\tthat,\twe\twill\tadd\tthe spring.application.name\tproperty\tas\tthat\twill\tbe\tused\tas\tthe\tservice name\tin\tConsul.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tbootstrap.properties file:\tspring.application.name=geolocation-consul-lb spring.cloud.consul.host=192.168.99.100\tspring.cloud.consul.port=8500\n\n9.\t Now\tthat\tour\tload\tbalancer\tis\tready,\tlet's\tDockerize\tit.\tCreate\ta\tnew Dockerfile\tin\tthe\tgeolocation-consul-lb\tproject\tand\tadd\tthe\tfollowing snippet:\tFROM\topenjdk:8\tADD\ttarget/geolocation-consul-lb-0.0.1- SNAPSHOT.jar\toptpackt/geolocation/\tEXPOSE\t8080\tCMD\t[\"java\",\t\"- jar\",\t\"optpackt/geolocation/geolocation-consul-lb-0.0.1- SNAPSHOT.jar\"]\n\n10.\t Build\tthe\tproject\tusing\tthe\tMaven\tcommand:\tmvn\tclean\tpackage\n\n11.\t Now,\tlet's\tbuild\tthis\tDocker\timage:\tdocker\tbuild\t-t vikrammurugesan/geolocation-consul-lb\t.\n\n12.\t Make\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tEarlier,\twe\twere using\tthe\tdocker-compose-consul.yml\tfile\tin\tthe\tgeolocation\tproject\tto start\tConsul\tand\tthe\tgeolocation\tservices.\n\n13.\t We\twill\tuse\tthe\tsame\tdocker-compose\tfile\tfor\trunning\tthe\tload\tbalancer\tas well.\tAppend\tthe\tfollowing\tsnippet\tto\tdocker-compose-consul.yml: geolocation-consul-lb:\timage:\tvikrammurugesan/geolocation-consul- lb:latest\tports:\t-\t\"8899:8899\"\n\n14.\t Without\tfurther\tado,\topen\ta\tnew\tterminal\tshell\tand\tstart\tthe\tcontainers using\tthe\tfollowing\tcommand:\tdocker-compose\t-f\tdocker-compose- consul.yml\tup\n\n15.\t It\tusually\ttakes\ta\tfew\tminutes\tto\tregister\tall\tthe\tservices\tin\tConsul.\tYou\tcan verify\tthat\tall\tyour\tservices\thave\tbeen\tsuccessfully\tregistered\ton\tConsul\tby viewing\tthe\tservices\tfrom\tthe\tConsul\tUI\tat\thttp://192.168.99.100:8500.\n\nWhen\tall\tthe\tservices\thave\tbeen\tregistered\tsuccessfully,\tyou\twill\tsee something\tlike\tthis\twhen\tyou\tclick\ton\tyour\tnode\tID\tin\tthe\tNodes\ttab:\n\nYou\tmay\tfind\tthat\tthe\thealth\tcheck\tfor\tgeolocation-consul-lb\tis\tfailing. We\tdon't\thave\tto\tworry\tabout\tthat\tmuch\tas\tour\tgoal\tis\tto\tjust\tregister\tthe geolocation\tservices\tin\tConsul.\n\n16.\t Now\tthat\tour\tservices\tare\tregistered\tin\tConsul,\tlet's\tcheck\twhether\tour\n\nRestTemplate\tloadbalances\tall\tHTTP\trequests.\tIssue\tthe\tfollwing\tcurl commands\tin\ta\tnew\tterminal\twindow:\tcurl\t-H\t\"ContentType: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://192.168.99.100:8899/geolocation 17.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} curl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://192.168.99.100:8899/geolocation\n\n18.\t This\tshould\tgiven\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} 19.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing\n\ncurl\tcommand:\tcurl\thttp://192.168.99.100:8899/geolocation\n\n20.\t It\tshould\tgive\tyou\tan\toutput\tthat\tlooks\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t[\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t}\t]\n\n21.\t But\twait;\twe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's try\tthe\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\tan\toutput like\tthis\t(pretty-printed\tfor\treadability):\t[\t{\t\"latitude\":\t9.568012, \"longitude\":\t77.962444,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"timestamp\":\t1468203975\t}\t]\n\nAgain,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime\tit\tis\ta\tdifferent\tone.\tThis\tis because\tour\trequest\tis\tbeing\tsent\tto\tone\tgeolocation\tservice\teach\ttime.\tEach instance\thas\tone\tgeolocation\tstored\tin\tmemory.\tAs\tour\tstorage\tmechanism\tuses a\tvery\tsimple\tin-memory\tapproach,\tthey\tare\tnot\tgrouped\ttogether\tin\ta\tsingle repo.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\tusing\ta\tdatabase,\tand\tall\tinstances\tof this\tmicroservice\twill\tconnect\tto\tthe\tsame\tdatabase.\tAt\tleast\tnow\twe\tknow\twhy our\trequests\twere\tacting\tdifferently.\tAt\tthe\tsame\ttime,\tthis\tproves\tthat\tthe\tload balancing\tworks\tas\texpected.\n\nYay!\tWe\thave\tlearned\thow\tto\tuse\tConsul\tand\tSpring\tCloud\tConsul\tto loadbalance\tHTTP-based\tmicroservices.\tConsul\tis\ta\tvery\tpowerful\ttool,\tand\tit\n\nloadbalance\tHTTP-based\tmicroservices.\tConsul\tis\ta\tvery\tpowerful\ttool,\tand\tit offers\ta\tgreat\tmany\tother\tfeatures.\tWhat\twe\tsaw\tis\tjust\ta\tbasic\tuse\tcase\tof Consul\tin\tmicroservices.\n\nNote\n\nDo\tspend\tsome\ttime\tgoing\tthrough\tthe\tConsul\tdocumentation\tat https://www.consul.io/docs/index.html\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tour\tnext\trecipe,\twe\twill\tlook\tat\thow Nginx\tand\tConsul\thelp\twith\tloadbalancing\tmicroservices.\n\nLoad\tbalancing\tyour\tmicroservice using\tNginx\tand\tConsul\n\nSo\tfar\twe\thave\tlearned\thow\tto\tload\tbalance\tour\tmicroservice\tusing\tZookeeper and\tConsul.\tBoth\tof\tthese\tapproaches\tcome\twith\ttheir\town\tmerits\tand\tdemerits. The\tZookeeper\tapproach\trequired\tus\tto\twrite\ta\tlot\tof\tcode,\tand\tthere\tis\tstill\ta possibility\tof\trace\tcondition\twhere\tour\tproxy\tcontroller\tcould\tinvoke\ta\tservice that\tjust\twent\tdown.\tThe\tSpring\tCloud\tConsul\tapproach\trequired\tus\tto\twrite\tthe proxy\tcontroller.\tIn\tfact,\tin\tboth\tthese\tapproaches\twe\thad\tto\twrite\tour\town\tload balancer\tmicroservice.\tThis\tmight\tnot\tbe\ta\tscalable\tapproach\twhen\tyou\thave hundreds\tof\tmicroservices\tand\ttons\tof\tAPIs.\tThat\tis\twhere\tHTTP\tservers\tsuch\tas Apache\tHTTP\tServer\tand\tNginx\tcome\tto\tthe\trescue.\tNginx\tis\tone\tof\tthe\tmost popular\tHTTP\tservers.\tWe\tcould\tpotentially\tuse\tNginx\tas\tour\tproxy\tserver\tto geolocation\tmicroservices\tin\ta\tround\trobin\tfashion.\tIn\tthis\trecipe\twe\twill\tlearn how\tto\tuse\tNginx\tand\tConsul\ttogether\tto\tload\tbalance\tour\tgeolocation microservice.\n\nGetting\tready\n\nIn\tthis\trecipe\twe\twill\tbe\tusing\ttwo\tnew\tcomponents:\tNginx\tServer\tand\tConsul Template.\tWe\tall\tknow\twhat\tNginx\tis\tand\thow\tit\tcan\tbe\tused\tfor\thosting\tour web\tcontent.\tHowever,\tin\tour\tcase\twe\tare\tvery\tinterested\tin\tNginx's\tproxy_pass module.\tThe\tproxy_pass\tmodule\tcan\tbe\tused\tto\tmake\tNginx,\tforward\trequests received\tfrom\ta\tclient\tto\tanother\tserver\tand\tsend\tback\tresponses\tfrom\tthe\tother server\tback\tto\tthe\tclient.\tIn\tour\tcase,\twe\twill\tbe\tutilizing\tproxy_pass\tto\tproxy requests\tto\tmultiple\tgeolocation\tinstances.\tUsually\tproxy_pass\tconfigurations go\tinto\tthe\tdefault.conf\tfile\tof\tNginx.\tSounds\teasy?\tBut\twait,\thow\tdoes\tNginx know\twhere\tour\tservices\tare\tlocated,\tbecause\twe\twill\tnever\tknow\thow\tmany instances\tof\tgeolocation\tare\tactive\tand\twhere\tthey\tare\tdeployed.\tSo\tthe\teasiest way\tis\tto\tkeep\tupdating\tthe\tdefault.conf\tfile\teach\ttime\ta\tgeolocation\tservice registers\tor\tunregisters\tin\tConsul.\tAt\tthe\tsame\ttime,\teach\ttime\tthe\tdefault.conf file\tis\tupdated,\tNginx\tneeds\tto\tbe\treloaded.\tSomehow\twe\thave\tto\tkeep\tboth Consul\tand\tNginx\tin\tsync.\tThat's\texactly\twhat\tConsul\tTemplate\tdoes.\tConsul Template\tconstantly\tpolls\tConsul\tfor\tany\tchanges\tto\tour\tgeolocation\tservice\tand recreates\tthe\tdefault.conf\tfile.\tIn\tfact,\tthe\twhole\tdefault.conf\tfile\twill\tbe represented\tas\ta\tConsul\tTemplate\tfile.\tConsul\ttemplate\tuses\tthe\tGo\ttemplate format\tfor\tcreating\ttemplate\tfiles.\n\nTo\tlearn\tmore\tabout\tGo\ttemplate\tformat,\tplease\ttake\ta\tlook\tat https://golang.org/pkg/text/template\t.\tThe\toverall\tarchitecture\twill\tlook something\tlike\tthis:\n\nAs\tyou\tcan\tsee\tthe\tclient\tdoesn't\thave\tto\tworry\tabout\tthe\tlocation\tof\tthe geolocation\tmicroservice.\tAll\tit\tneeds\tto\tknow\tis\tthe\tlocation\tof\tour\tNginx server.\n\nHow\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\twe\twill\tneed\tis\ta\tDocker\tcontainer\tfor\tNginx\tand\tConsul Template.\tWe\twill\tbe\tusing\tthe\tofficial\tNginx\tDocker\timage\tand\twill\tinstall Consul\tTemplate\tinside\tit.\tCreate\ta\tnew\tdirectory\talong\tside\tthe\tgeolocation project\tcalled\tgeolocation-consul-nginx-lb.\tCreate\ta\tnew\tDockerfile\tunder geolocation-consul-nginx-lb\tand\tadd\tthe\tfolowing\tcontents\tto\tit:\n\nFROM\tnginx:latest ENV\tCONSUL_URL\tconsul:8500 RUN\tapt-get\tupdate\t&&\tapt-get\tinstall\t-y\tunzip\twget RUN\tmkdir\t-p\toptpackt/consul-template WORKDIR\toptpackt/consul-template RUN\twget\thttps://releases.hashicorp.com/consul- template/0.16.0/consul-template_0.16.0_linux_amd64.zip\t&&\tunzip\t consul-template_0.16.0_linux_amd64.zip ADD\tdefault.ctmpl\toptpackt/consul-template/ ADD\tstartup.sh\toptpackt/consul-template/ RUN\tchmod\t+777\toptpackt/consul-template/startup.sh RUN\trm\tetcnginx/conf.d/default.conf EXPOSE\t80 ENTRYPOINT\t[\"optpackt/consul-template/startup.sh\"]\n\nThere\tare\ta\tlot\tof\tthings\tgoing\ton\tin\tthis\tfile.\tLets\tbreak\tit\tdown\tinto\tparts\tand try\tto\tunderstand\tit\tone\tby\tone.\tFirstly,\twe\tare\tbasing\tthis\timage\toff\tof nginx:latest\timage.\n\nENV\tCONSUL_URL\tconsul:8500\n\nThe\tpreceding\tinstruction\tcreates\ta\tnew\tenvironment\tvariable\tcalled\tCONSUL_URL with\tvalue\tconsul:8500.\tThe\thostname\tconsul\twill\tbe\tresolved\tto\tthe\thostname of\tthe\tconsul\tservice,\tif\twe\tuse\tit\tin\tDocker\tcompose.\n\nRUN\tapt-get\tupdate\t&&\tapt-get\tinstall\t-y\tunzip\twget\n\nThe\tpreceding\tinstruction\tinstalls\tunzip\tand\twget.\tWe\tneed\tthem\tto\tinstall\tand unpack\tConsul\tTemplate.\n\nRUN\tmkdir\t-p\toptpackt/consul-template WORKDIR\toptpackt/consul-template\n\nThese\ttwo\tinstructions\tcreate\tthe\toptpackt/consul-template\tdirectory\tand\tset\n\nthe\tworking\tdirectory\tto\toptpackt/consul-template.\tWe\twill\tbe\tusing\tthis directory\tas\tthe\tinstallation\tdirectory\tof\tconsul\ttemplate.\n\nRUN\twget\thttps://releases.hashicorp.com/consul- template/0.16.0/consul-template_0.16.0_linux_amd64.zip\t&&\tunzip\t consul-template_0.16.0_linux_amd64.zip\n\nThis\tinstruction\tdownloads\tConsul\tTemplate\tand\tunpacks\tthe\tdownloaded\tZIP file.\tThe\tcontent\tof\tthe\tZIP\tfile\tis\tjust\tthe\tconsul-template\tbinary.\tAs\tyou\tcan see\twe\thave\tused\tthe\tversion\t0.16.0,\tbut\tfeel\tfree\tto\tuse\tthe\tmost\trecent\tversion found\tin\thttps://releases.hashicorp.com/consul-template\t.\n\nADD\tdefault.ctmpl\toptpackt/consul-template/ ADD\tstartup.sh\toptpackt/consul-template/ RUN\tchmod\t+x\toptpackt/consul-template/startup.sh\n\nThe\tpreceding\tsnippet\tdoes\tthree\tthings:\tadds\tthe\ttemplate\tfile\tdefault.ctmpl to\tthe\tinstallation\tdirectory\tat\toptpackt/consul-template,\tadds\tthe\tstartup script\tto\tthe\tinstallation\tdirectory\tand\tprovides\texecute\tprivileges\tto\tthe\tstartup script.\tWe\twill\tlook\tat\thow\tto\tcreate\tthe\tdefault.ctmpl\tfile\tand\tstartup.sh\tfile later.\n\nRUN\trm\tetcnginx/conf.d/default.conf\n\nThis\tinstruction\tis\trequired\tto\tremove\tthe\tdefault\tconfig\tfile\tthat\tcomes\twith Nginx's\tinstallation.\n\nEXPOSE\t80\n\nWe\tare\texposing\tport\t80\tof\tNginx\tso\tthat\twe\tcan\taccess\tit\tfrom\toutside\t(after mapping\tit).\n\nENTRYPOINT\t[\"optpackt/consul-template/startup.sh\"]\n\nFinally\tthe\tentry\tpoint\twill\tbe\tthe\tstartup.sh\tscript\tthat\twe\twill\tbe\tcreating next.\tThe\tstartup\tscript\twill\tdo\ttwo\tthings:\tstart\tNginx\tand\tstart\tConsul Template.\tCreate\ta\tnew\tshell\tscript\twith\tname\tstartup.sh\tand\tadd\tthe following\tcontents.\n\n#!/bin/bash service\tnginx\tstart\t&&\toptpackt/consul-template/consul-template\t- consul=$CONSUL_URL\t- template=\"default.ctmpl:etcnginx/conf.d/default.conf:service\tnginx\n\nreload\"\n\nThe\tpreceding\tsnippet\tstarts\tthe\tservice\tcalled\tnginx\tand\tstarts\tConsul\tTemplate with\ttwo\targuments.\tThe\tconsul\targument\tindicates\tthe\tlocation\tof\tConsul.\tWe have\tused\tthe\tCONSUL_URL\tenvironment\tvariable\tthat\twas\tpreviously\tdefined\tin the\tDockerfile.\tThe\ttemplate\targument\tis\tdivided\tinto\tthree\tparts\tseparated\tby\ta colon.\tThe\tfirst\tpart\tindicates\tthe\ttemplate\tfile\titself,\tthe\tsecond\tpart\tindicates the\tfile\tthat\tneeds\tto\tbe\treplaced\tafter\trendering\tthe\ttemplate\tand\tthe\tthird\tpart indicates\tthe\taction\tthat\tneeds\tto\tbe\tperformed\tafter\teach\tupdate.\tIn\tour\tcase\twe are\treloading\tthe\tnginx\tservice\tafter\teach\tupdate.\n\nThe\tnext\tfile\twe\thave\tto\tcreate\tis\tthe\ttemplate\tfile.\tGo\tahead\tand\tcreate\ta\tnew file\tcalled\tdefault.ctmpl.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tfile:\n\nupstream\tgeolocation\t{\t \t\t\t\t\t\tleast_conn;\t \t\t\t\t\t\t{{range\tservice\t\"geolocation\"}}server\t{{.Address}}:{{.Port}} \t\t\t\t\t\tmax_fails=3\tfail_timeout=60\tweight=1;\t \t\t\t\t\t\t{{else}}server\t127.0.0.1:65535;\t#\tforce\ta\t502{{end}}\t \t\t\t\t}\n\nserver\t{\t \t\t\t\t\t\tlisten\t80\tdefault_server;\n\ncharset\tutf-8;\n\nlocation\tgeolocation\t{\t \t\t\t\t\t\t\t\tproxy_pass\thttp:/geolocation;\t \t\t\t\t\t\t\t\tproxy_set_header\tX-Forwarded-For\t $proxy_add_x_forwarded_for;\t \t\t\t\t\t\t\t\tproxy_set_header\tHost\t$host;\t \t\t\t\t\t\t\t\tproxy_set_header\tX-Real-IP\t$remote_addr;\t \t\t\t\t\t\t}\t \t\t\t\t}\n\nIf\tyou\tare\tfamiliar\twith\tNginx,\tyou\twould\talready\tknow\twhat's\tgoing\ton\there. All\twe\thave\tdone\tis\tcreated\tan\tupstream\tcalled\tgeolocation,\twhich\twill\tbe replaced\twith\tthe\tlist\tof\tgeolocation\tservers\tthat\tare\tregistered\tin\tConsul.\tThis rendering\tis\twhat\tConsul\tTemplate\tdoes.\tLater\tin\tthe\tserver\tsection,\twe\thave added\ta\tproxy\tpass\tto\t/geolocation\tURL\tpath,\twhich\twill\tbe\tload\tbalanced against\tthe\tlist\tof\tgeolocation\tservers\tlisted\tin\tupstream\tgeolocation.\tThis template\tfile\twill\tbe\tupdated\tevery\ttime\tthere\tis\ta\tchange\tto\tthe\tgeolocation\n\nservice\tin\tConsul.\n\nThat's\tit.\tWe\tare\tall\tset\tto\tgo.\tIn\torder\tto\ttest\tour\tsetup,\tlets\tuse\tDocker\tcompose. Go\tahead\tand\tcreate\ta\tnew\tDocker\tcompose\tfile\tcalled\tdocker-compose-nginx- consul.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tYAML\tfile:\n\nversion:\t\"2\" \t\t\t\tservices: \t\t\t\t\t\tconsul: \t\t\t\t\t\t\t\timage:\tconsul:latest \t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8500:8500\"\n\ngeolocation-1: \t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8080\" \t\t\t\t\t\t\t\tenvironment: \t\t\t\t\t\t\t\t\t\tGEOLOCATION_SERVICE_PORT:\t\"8080\"\n\ngeolocation-2: \t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8081\" \t\t\t\t\t\t\t\tenvironment: \t\t\t\t\t\t\t\t\t\tGEOLOCATION_SERVICE_PORT:\t\"8081\"\n\nnginx-consul-template: \t\t\t\t\t\t\t\tbuild:\t. \t\t\t\t\t\t\t\tlinks: \t\t\t\t\t\t\t\t\t\t-\tconsul \t\t\t\t\t\t\t\tdepends_on: \t\t\t\t\t\t\t\t\t\t-\tconsul \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8900:80\"\n\nAs\tyou\tcan\tsee,\twe\thave\tthree\timages\tthat\twe\talready\tknow:\tconsul\tand\t2 geolocation\timages.\tThe\tonly\tnew\timage\tin\tthe\tpreceding\tDocker\tcompose\tis the\tnginx-consul-template\timage.\tThis\timage\twill\tbe\tbuilt\tusing\tthe Dockerfile\tlocated\tin\tthe\tcurrent\tdirectory.\tThis\timage\tis\tlinked\tto\tthe\tconsul image\tso\tthat\tit\tknows\twhere\tConsul\tis\tlocated.\tThe\tdepends_on\tsection\tsays that,\tthis\timage\thas\tto\twait\tfor\tthe\tconsul\timage\tto\tbe\tstarted.\tFinally\tport\t80\tof Nginx\tneeds\tto\tbe\tmapped\tto\t8900\tin\tthe\tDocker\thost.\tWithout\tany\tfurther\tado, go\tahead\tand\tstart\tthe\tcontainers\tusing\tthe\tfollowing\tcommand:\n\ndocker-compose\t-f\tdocker-compose-nginx-consul.yml\tup\n\nIt\tusually\ttakes\t2-5\tminutes\tfor\tthe\tgeolocation\tservices\tto\tregister\tto\tConsul depending\ton\tthe\tconfiguration\tof\tyour\tmachine.\tSo\twait\tfor\tthem\tto\tregister\tin Consul.\tYou\tcan\tverify\tif\tthe\tservices\tare\tregistered\tin\tConsul\tby\tlooking\tat Consul's\tweb\tinterface\tat\thttp://192.168.99.100:8500.\tAfter\tall\tyour\tservices are\tregistered,\twe\tare\tready\tto\ttest\tour\tload\tbalancer.\tOpen\tup\ta\tnew\tterminal session\tand\tissue\tthe\tfollowing\tcURL\tcommands:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:8900/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \"latitude\":\t41.803488, \"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"timestamp\":\t1468203975 } curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://192.168.99.100:8900/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor\treadability):\n\n{ \"latitude\":\t9.568012, \"longitude\":\t77.962444, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"timestamp\":\t1468203975 }\n\nTo\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing\tcurl command:\n\ncurl\thttp://192.168.99.100:8900/geolocation\n\nIt\tshould\tgive\tyou\tan\toutput\tthat\tlooks\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ { \"latitude\":\t41.803488, \t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\"timestamp\":\t1468203975 } ]\n\nBut\twait;\twe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's\ttry the\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\tan\toutput\tlike\tthis (pretty-printed\tfor\treadability):\n\n[ { \"latitude\":\t9.568012, \t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\"timestamp\":\t1468203975 } ]\n\nAgain,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime\tit\tis\ta\tdifferent\tone.\tThis\tis because\tour\trequest\tis\tbeing\tsent\tto\tone\tgeolocation\tservice\teach\ttime.\tEach instance\thas\tone\tgeolocation\tstored\tin\tmemory.\tAs\tour\tstorage\tmechanism\tuses a\tvery\tsimple\tin-memory\tapproach,\tthey\tare\tnot\tgrouped\ttogether\tin\ta\tsingle repo.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\tusing\ta\tdatabase,\tand\tall\tinstances\tof this\tmicroservice\twill\tconnect\tto\tthe\tsame\tdatabase.\tAt\tleast\tnow\twe\tknow\tthat our\tnew\tload\tbalancer\tworks\tas\texpected.\n\nNote\n\nNginx\thas\ta\tpaid\tversion\tof\ttheir\tsoftware\tcalled\tNginx\tPlus\twhich\toffers\tmost of\tthe\tfeatures\tthat\tyou\twill\tneed\tin\tany\tHTTP\tserver\tlike\tMonitoring,\tSecurity, Load\tBalancing,\tCaching,\tand\tso\ton.\tIf\tyou\tare\talready\tan\tNginx\tuser\tand\twould like\tto\tcontinue\tusing\tit\talong\twith\tyour\tmicroservices,\tit\tmight\tbe\tworth\ttaking a\tlook\tat\tNginx\tPlus.\tFor\tmore\tinformation\tabout\tload\tbalancing\tusing\tNginx Plus,\tplease\ttake\ta\tlook\tat\thttps://www.nginx.com/products/application-load- balancing\t.\n\nThat's\tit.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe\twe\tnot\tonly learned\thow\tto\tuse\tConsul\tTemplate\tand\tNginx\tbut\talso\timplemented\ta\tload balancer\twithout\thaving\tto\twrite\ttoo\tmuch\tcode.\tThe\treal\tbeauty\tof\tthis\n\nbalancer\twithout\thaving\tto\twrite\ttoo\tmuch\tcode.\tThe\treal\tbeauty\tof\tthis approach\tis\tthat,\tit\tconfigures\tNginx\tto\tload\tbalance\tbetween\tany\tnumber\tof geolocation\tinstances\tthat\tare\tcurrently\tregistered\tin\tConsul.\n\nLoad\tbalancing\tyour\tmicroservice using\tMarathon\tLB\n\nIn\tthis\trecipe,\twe\twill\tlearn\tthe\tconcepts\tof\tMarathon\tLB\tand\thow\tit\tworks behind\tthe\tscreens.\tAt\tthe\ttime\tof\twriting\tthis,\tMarathon\tLB\tworks\tperfectly with\tDC/OS.\tSo\ttrying\tto\tmake\tMarathon\tLB\twork\tin\ta\tnon-DC/OS environment\tmight\tnot\tbe\tthe\tbest\tsolution\tin\tall\tcases.\tWe\twill\tbe\tlearning about\tDC/OS\tin\tChapter\t8\t,\tMore\tClustering\tFrameworks\t-\tDC/OS,\tDocker Swarm,\tand\tYARN.\n\nHow\tit\tworks...\n\nMarathon\tLB\tis\ta\tPython-based\ttool\tthat\tinternally\tuses\tHAProxy\tto\tload- balance\tapplications\tdeployed\ton\tMarathon.\tHAProxy\tis\tone\tof\tthe\tproven solutions\tfor\tload-balancing\tHTTP-based\tendpoints.\tIt\thas\tbeen\tthere\tin\tthe market\tfor\ta\twhile,\tand\tthere\tare\tseveral\tsuccess\tstories\tabout\tit.\tWhen\tyou\tstart Marathon\tLB,\tyou\tneed\tto\tsupply\tthe\tbase\tURL\tof\tMarathon\tas\ta\tconfiguration so\tthat\twhen\tMarathon\tLB\tstarts,\tit\tknows\twhere\tMarathon\tis\trunning\ton\tyour cluster.\tMarathon\tLB\tbinds\tto\tthe\tservice\tports\tof\tall\tthe\tapplications\tand\troutes any\trequest\tthat\tit\treceives\tto\tthe\tapplication\tinstances.\tIt\tdoes\tthree\tthings:\n\nParses\tthe\tMarathon\tapps\t(using\tMarathon's\tREST\tAPI)\tand\tgets\ttheir\tIP and\tservice\tport Creates\ta\tnew\tHAProxy\tconfig\tand\tdrops\tit\tin\ta\tdedicated\tHAProxy directory Reloads\tHAProxy\t(does\tnot\trestart)\n\nThe\tworking\tof\tMarathon\tLB\tis\tsimple.\tIt\tuses\tHAProxy\tas\tthe\tback-end\tload balancer\tand\tinteracts\twith\tthe\tapplications\tdeployed\ton\tMarathon\tand HAProxy.\tThe\tnext\tquestion\tthat\tyou\tmay\thave\tis\thow\tMarathon\tLB\tknows when\tapplications\tin\tMarathon\tare\tmodified:\tupdated,\tremoved,\tor\tcreated.\n\nMarathon\tLB\thas\ta\tfew\tstrategies\tby\twhich\tit\twill\tget\tnotified\twhen\tan application\tis\tmodified\ton\tMarathon.\tSo\twhenever\tit\treceives\tsuch\tan\tevent,\tit updates\tHAProxy\taccordingly\tand\treloads\tHAProxy.\tNot\tall\tapplications\twill\tbe load-balanced\tby\tMarathon\tLB.\tMarathon\tLB\tlooks\tfor\tapplications\tthat\thave the\tHAPROXY_GROUP\tvariable\tset\tto\ta\tspecific\tvalue.\n\nNote\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tMarathon\tLB,\tvisit\ttheir\tGitHub documentation\tat\thttps://github.com/mesosphere/marathon- lb/blob/master/README.md\t.\n\nLike\tI\tmentioned,\tthe\teasiest\tway\tto\ttry\tMarathon\tLB\tis\ton\ta\tDC/OS\tcluster. And\tif\tyou\tare\tso\tdependent\ton\tMesos\tand\tMarathon,\tit\tis\tdefinitely\tworth taking\ta\tlook\tat\tDC/OS.\n\nWith\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\tchapter.\tYou've\tlearned\ta\tlot\tabout\tservice\n\nWith\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\tchapter.\tYou've\tlearned\ta\tlot\tabout\tservice discovery\tand\tload-balancing\tyour\tmicroservices\tin\tthis\tchapter\n\nChapter\t6.\tMonitoring\tMicroservices\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tsetup\ta\tmonitoring\tsystem\tfor\tour microservice.\tWe\twill\tcover\tthe\tfollowing\trecipes:\n\nConfiguring\tSpring\tBoot\tActuator\tmetrics Understanding\tSpring\tBoot\tActuator\tmetrics Creating\tcustom\tmetrics\tusing\tDropwizard Setting\tup\tGraphite\tusing\tDocker Using\tthe\tGraphite\tinterface Exporting\tDropwizard\tmetrics\tover\tto\tGraphite Exporting\tSpring\tBoot\tActuator\tmetrics\tover\tto\tGraphite Setting\tup\tGrafana\tusing\tDocker Configuring\tGrafana\tto\tuse\tGraphite Configuring\tGrafana\tdashboards\tto\tview\tmetrics",
      "page_number": 297
    },
    {
      "number": 6,
      "title": "Monitoring\tMicroservices",
      "start_page": 369,
      "end_page": 433,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nAs\tyou\tstart\tscaling\tout\tto\tseveral\tmicroservices,\tit\tbecomes\tdifficult\tto\tmonitor them.\tYou\tmight\twant\tto\tknow\twhen\tsome\tpart\tof\tyour\tplatform\tis\tnot\tworking as\texpected.\tAt\tthe\tsame\ttime,\tyou\twant\tto\tbe\tnotified\twhen\tsome\tpart\tof\tyour application\tis\tnot\tperforming\twell.\tSo\tmonitoring\tbecomes\ta\tsignificant\taspect of\tmicroservices.\tAt\tthe\tsame\ttime,\tmonitoring\twill\tnot\tmake\tsense\tif\tyou\tdon't monitor\tthe\tright\tmetrics.\tSo\texposing\tthe\tright\tmetrics\tfor\teach\tmicroservices matter\ta\tlot.\tWhile\tyou\tspend\t60\tpercent\tof\tyour\ttime\twriting\tthe\tactual functionality\tof\tthe\tmicroservice,\tthe\tother\t40\tpercent\tshould\tbe\tspent\ton activities\tsuch\tas\tdeployments,\tCI,\tmonitoring,\tand\tlogging.\tIf\tthis\tsounds strange\tto\tyou,\tyou\twill\tstart\tunderstanding\tit\tas\tsoon\tas\tyou\tstart\twriting\tmore and\tmore\tmicroservices.\n\nThe\tbiggest\tquestion\tis\twhere\tdo\twe\tstore\tthese\tmetrics.\tThat's\twhere\tTime Series\tDatabases\tcome\tinto\tpicture.\tThere\tare\tseveral\ttime\tseries\tdatabases\tin the\tmarket\tat\tthe\tmoment\tlike\tGraphite,\tPrometheus,\tRiak,\tand\tso\ton.\tIn\tthis chapter\twe\twill\tbe\tlooking\tat\thow\tto\tuse\tGraphite\tto\tstore\tour\tmetrics.\tThe\tnext step\tis\tvisualizing\tthese\tmetrics\tin\tform\tof\tuser-friendly\tcharts\tand\tgraphs.\tFor that\tpurpose,\twe\twill\tbe\tusing\tone\tof\tthe\tmost\tpopular\tmonitoring\ttools\tcalled Grafana.\n\nConfiguring\tSpring\tBoot\tActuator metrics\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconfigure\tthe\tgeolocation\tproject\tto\texpose some\tpredefined\tmetrics\texposed\tby\tthe\tSpring\tframework\titself.\tThough\tyou might\tnot\tuse\tall\tof\tthem,\tit\tis\talways\tbetter\tto\tknow\tthat\tthey\texist\tso\tthat\tyou can\tfind\tsome\tuse\tfor\tthem\tin\tthe\tfuture.\tIn\tfact,\tmost\tof\tthe\tmetrics\texposed\tby Spring\tare\tmodifiable.\tOn\ttop\tof\tit,\tSpring\tadds\tsecurity\tto\tthem\tso\tthat\tnot everyone\tcan\tview\tyour\tmetrics.\tThese\tare\tsome\tof\tthe\tadvantages\tthat\tyou\tget when\tyou\tuse\tSpring's\tmetrics\tframework.\n\nGetting\tready\n\nWe\twill\tgo\tthrough\tthis\trecipe\twith\tthe\thelp\tof\tthe\tgeolocation\tproject.\tWe\twill be\tusing\tthe\tSpring\tBoot\tActuator\tlibrary\tto\texpose\tthe\tmetrics.\tSo\topen\tyour STS\tIDE.\tBefore\twe\tjump\tinto\tthe\tactual\timplementation,\twe\thave\tto\tcomment out\ta\tfew\tlines\tof\tcode.\tIf\tyou\thave\tbeen\tworking\ton\tthe\tSetting\tup\tConsul\tusing Docker\trecipe\tfrom\tChapter\t5\t,\tService\tDiscovery\tand\tLoad\tBalancing Microservices,\tyou\tmight\tstill\thave\tthe\tZookeeper\tor\tConsul-related\tcode\tin your\tcode\tbase.\tAs\twe\tare\tnot\tgoing\tto\tuse\teither\tof\tthem,\tlet's\tmake\tsure\tthey are\tcommented\tout.\tTo\tcomment\tout\tZookeeper,\tall\tyou\thave\tto\tdo\tis\tcomment out\tthe\tline\tin\tGeoLocationApplication.java\tclass\tfile\twhere\twe\tregister\tour service.\tTo\tcomment\tout\tConsul,\tyou\thave\tto\tfirst\tcomment\tout\tthe @EnableDiscoveryClient\tannotation\tfrom\tthe\tGeoLocationApplication.java class\tand\tremove\tthe\tunused\timport.\tThe\tclass\twill\tnow\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\torg.springframework.boot.SpringApplication; \t\t\t\timport\torg.springframework.boot.autoconfigure. \t\t\t\t\t\tSpringBootApplication;\n\n@SpringBootApplication \t\t\t\t//\t@EnableDiscoveryClient \t\t\t\tpublic\tclass\tGeoLocationApplication\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\tSpringApplication.run(GeoLocationApplication.class,\targs);\n\n//\tcommented\tout\tso\tthat\tthe\tservice\tdoes\tnot\ttry\tto connect \t\t\t\t\t\t\t\tto\tzk \t\t\t\t\t\t\t\t//\tnew\tZookeeper(\"192.168.99.100\",\t2181).register(); \t\t\t\t\t\t} \t\t\t\t}\n\nThe\tnext\tstep\tis\tcommenting\tout\tthe\tspring-cloud-starter-consul-all dependency\tfrom\tthe\tpom.xml\tfile:\n\n<!--\t<dependency> <groupId>org.springframework.cloud</groupId> \t\t\t\t\t\t\t<artifactId>spring-cloud-starter-consul-all</artifactId> \t\t\t\t\t\t\t<version>1.1.2.RELEASE</version> \t\t\t\t\t</dependency>\t-->\n\n</dependency>\t-->\n\nNow\tthat\twe\tknow\tall\tthe\tcode\trelated\tto\tZookeeper\tand\tConsul\tinitialization are\tcommented\tout,\tlet's\twork\ton\tconfiguring\tSpring\tBoot\tActuator.\n\nHow\tto\tdo\tit...\n\nBefore\twe\tstart,\tlet's\ttake\ta\tminute\tto\ttalk\tabout\tSpring\tBoot\tActuator\tand\thow\tit works.\tSpring\tBoot\tActuator\tis\tjust\ta\tMaven\tdependency\tthat\tyou\tneed\tto\tadd\tto your\tproject.\tOnce\tyou\tadd\tthis\tdependency,\tSpring\tautomatically\tinjects\tthe beans\tthat\tare\tresponsible\tfor\texposing\tthese\tmetrics.\tThere\tare\ttwo\tways\tto consume\tthese\tmetrics:\tHTTP\tor\tJMX.\tThough\tJMX\tis\tconsidered\tto\tbe\tthe standard\tway,\tHTTP\tis\tconsidered\tan\teasy\tsolution,\tas\tREST\tis\talmost everywhere\tthese\tdays.\tFor\tsimplicity,\tin\tthis\trecipe,\twe\twill\tbe\ttesting\tour metrics\tusing\tthe\tHTTP\tendpoints.\tActuator\tnot\tonly\texposes\tmetrics\tbut\talso some\tuseful\tendpoints\tto\tmanage\tour\tapplication.\tWe\twill\tlook\tat\tthem\tin\tthe next\trecipe.\n\n1.\t Without\tany\tdelay,\tlets'\tadd\tthe\tspring-boot-starter-actuator dependency\tto\tour\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t<artifactId>spring-boot-starter-actuator</artifactId> \t\t\t\t</dependency>\n\nNote\n\nWe\thave\tnot\tadded\tthe\tversion\tfor\tthe\tspring-boot-starter-actuator dependency.\tThat\tis\tbecause\tit\twill\tpick\tup\tthe\tversion\tmanaged\tby\tthe spring-boot-starter-parent\tPOM.\tIn\tour\tcase,\tthe\tversion\tof\tspring- boot-starter-\tactuator\tthat\twill\tbe\tresolved\tis\t1.3.6\trelease.\n\n2.\t Now\tthat\tour\tproject\tis\tready\twith\tActuator,\tlet's\ttest\tit.\tStart\tthe GeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tIf\tyou\tpay\tclose\tattention\tto\tthe\tlogs,\tthis\ttime\tyou\twill\tsee that\tthere\tare\tsome\tadditional\trequest\tmappings\tregistered,\tsuch\tas\t/beans, /info,\t/configprops,\t/health,\t/autoconfig,\t/mappings,\t/metrics,\t/env, /trace,\tand\t/dump.\tThese\trequest\tmappings\twere\tadded\tby\tthe\tSpring Actuator\tdependency:\n\n3.\t Let's\ttest\tour\tconfigurations.\tOpen\ta\tnew\tterminal\tsession\tand\tissue\tthe following\tcurl\tcommand:\n\ncurl\thttp://localhost:8080/metrics\n\nThis\tshould\thave\treturned\ta\tlist\tof\tmetrics\tthat\tare\tcurrently\tbeing\texposed by\tyour\tmicroservice\tusing\tSpring\tBoot\tActuator.\n\n4.\t You\tshould\tsee\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\"mem\":\t233838, \t\t\t\t\t\t\t\t\"mem.free\":\t65596, \t\t\t\t\t\t\t\t\"processors\":\t4, \t\t\t\t\t\t\t\t\"instance.uptime\":\t909667, \t\t\t\t\t\t\t\t\"uptime\":\t924127, \t\t\t\t\t\t\t\t\"systemload.average\":\t1.62548828125, \t\t\t\t\t\t\t\t\"heap.committed\":\t184832, \t\t\t\t\t\t\t\t\"heap.init\":\t131072, \t\t\t\t\t\t\t\t\"heap.used\":\t119235, \t\t\t\t\t\t\t\t\"heap\":\t1864192, \t\t\t\t\t\t\t\t\"nonheap.committed\":\t49984, \t\t\t\t\t\t\t\t\"nonheap.init\":\t2496, \t\t\t\t\t\t\t\t\"nonheap.used\":\t49006, \t\t\t\t\t\t\t\t\"nonheap\":\t0, \t\t\t\t\t\t\t\t\"threads.peak\":\t29, \t\t\t\t\t\t\t\t\"threads.daemon\":\t19, \t\t\t\t\t\t\t\t\"threads.totalStarted\":\t36, \t\t\t\t\t\t\t\t\"threads\":\t21, \t\t\t\t\t\t\t\t\"classes\":\t6154, \t\t\t\t\t\t\t\t\"classes.loaded\":\t6154, \t\t\t\t\t\t\t\t\"classes.unloaded\":\t0, \t\t\t\t\t\t\t\t\"gc.ps_scavenge.count\":\t8, \t\t\t\t\t\t\t\t\"gc.ps_scavenge.time\":\t101, \t\t\t\t\t\t\t\t\"gc.ps_marksweep.count\":\t1, \t\t\t\t\t\t\t\t\"gc.ps_marksweep.time\":\t46, \t\t\t\t\t\t\t\t\"httpsessions.max\":\t-1,\n\n\"httpsessions.max\":\t-1, \t\t\t\t\t\t\t\t\"httpsessions.active\":\t0, \t\t\t\t\t\t\t\t\"gauge.response.metrics\":\t16, \t\t\t\t\t\t\t\t\"gauge.response.star-star\":\t41, \t\t\t\t\t\t\t\t\"counter.status.200.metrics\":\t1, \t\t\t\t\t\t\t\t\"counter.status.404.star-star\":\t1 \t\t\t\t\t\t}\n\nIdeally,\tyou\twill\thave\tmore\tmetrics.\tAs\tyou\tcan\tsee,\tthe\tprevious\tmetrics are\tmore\ton\tthe\tJVM\tlevel.\tYou\twill\talso\tsee\tsome\tmetrics\tthat\tare\tHTTP related\t(such\tas\t404\tcounts\tand\t200\tcounts).\tThese\tmetrics\tare\tstarter\tbased. For\texample,\tif\tyou\thave\ta\tSpring\tData\tstarter\tconfigured\tin\tyour application,\tyou\twill\tsee\tsome\tdatabase-related\tmetrics\tas\twell.\tIf\tyou\tfind it\tdifficult\tto\tread\tthe\tmetrics\tfrom\tthe\tcommand\tline,\tfeel\tfree\tto\tuse\ttools such\tas\tPostman\tor\tother\tbrowser-based\tplugins\tthat\tcan\trender\tJSON\tin\ta pretty-printed\tformat.\n\n5.\t This\tverifies\tthat\twe\thave\tsuccessfully\tconfigured\tSpring\tBoot\tActuator\tin our\tapplication.\tThese\tmetrics\tmay\tbe\tuseful\ton\tthe\tJVM\tlevel,\tbut\tthey\tare not\tgoing\tto\thelp\tus\tmonitor\tour\tapplication-related\tmetrics,\twhich\tis\twhat we\twill\tbe\tlearning\tin\tlater\trecipes\tof\tthis\tchapter.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto configure\tSpring\tBoot\tActuator\tin\tour\tapplication.\n\nUnderstanding\tSpring\tBoot\tActuator metrics\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tconfigure\tSpring\tBoot\tActuator\tin\tthe geolocation\tapplication.\tWe\talso\tverified\tthe\tconfiguration\tby\taccessing\tthe /metrics\tendpoint.\tIn\tthis\trecipe,\twe\twill\tbe\tlearning\tmore\tabout\tmost\tof\tthe commonly\tused\tmetrics\texposed\tby\tSpring\tBoot\tActuator.\n\nGetting\tready\n\nIn\torder\tto\tunderstand\tthe\tvarious\tmetrics\tand\toperations\texposed\tby\tthe\tSpring Boot\tActuator\tlibrary,\twe\twill\tbe\tinvoking\tthem\tone\tby\tone\tusing\tcURL commands.\tAs\twe\twill\tbe\tanalyzing\tthe\tJSON\tresponse\tof\tour\tmetric\tAPIs\ta\tlot, feel\tfree\tto\tuse\ta\ttool\tsuch\tas\tPostman\tor\tanother\tplugin\tfor\tyour\tbrowser\tto pretty-print\tJSON\tdocuments.\n\nHow\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tgo\tover\tthe\tmost\timportant endpoints\texposed\tby\tSpring\tBoot\tActuator.\n\n1.\t Some\tmetrics\texposed\tby\tActuator\tdepend\ton\tthe\tAPI\tusage,\tso\tlet's\tcreate some\tgeolocations\tand\ttry\tto\tquery\tthem:\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\n3.\t To\tcheck\twhether\tour\tentity\twas\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\tcurl\thttp://localhost:8080/geolocation\n\n4.\t It\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\t[\t{ \"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\":\t\"f1196aac- 470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\t] 5.\t Now\tlet's\tcreate\tthe\tsecond\tgeolocation:\tcurl\t-H\t\"Content-Type:\n\napplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\n\n6.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} 7.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\tcurl\thttp://localhost:8080/geolocation\n\n8.\t It\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t[\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t},\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t}\t]\n\n9.\t Now\tlet's\tinvoke\tthe\tmetrics\tAPI\tand\ttry\tto\tunderstand\tfew\tof\tthe\tmetrics: curl\thttp://localhost:8080/metrics\n\n10.\t You\tshould\treceive\ta\tresponse\tsimilar\tto\tthis\t(pretty-printed\tfor readability):\t{\t\"mem\":\t254684,\t\"mem.free\":\t112813,\t\"processors\":\t4,\n\n\"instance.uptime\":\t618061,\t\"uptime\":\t623669,\t\"systemload.average\": 1.8212890625,\t\"heap.committed\":\t205312,\t\"heap.init\":\t131072, \"heap.used\":\t92498,\t\"heap\":\t1864192,\t\"nonheap.committed\":\t51008, \"nonheap.init\":\t2496,\t\"nonheap.used\":\t49372,\t\"nonheap\":\t0,\t\"threads.peak\": 31,\t\"threads.daemon\":\t24,\t\"threads.totalStarted\":\t41,\t\"threads\":\t26, \"classes\":\t6262,\t\"classes.loaded\":\t6262,\t\"classes.unloaded\":\t0, \"gc.ps_scavenge.count\":\t7,\t\"gc.ps_scavenge.time\":\t93, \"gc.ps_marksweep.count\":\t1,\t\"gc.ps_marksweep.time\":\t58, \"httpsessions.max\":\t-1,\t\"httpsessions.active\":\t0, \"gauge.response.geolocation\":\t5,\t\"gauge.response.metrics\":\t4, \"gauge.response.star-star.favicon.ico\":\t3,\t\"counter.status.200.star- star.favicon.ico\":\t3,\t\"counter.status.200.metrics\":\t4, \"counter.status.200.geolocation\":\t4\t}\n\nHere\tis\ta\tquick\tdescription\tof\tsome\tof\tthese\tmetrics:\n\nmem\tand\tmem.free\tindicate\tthe\tamount\tof\tmemory\tused\tand\tavailable\tin KB. uptime\tindicates\tthe\tuptime\tof\tthe\tsystem\twhereas\tinstance.uptime indicates\tthe\tuptime\tof\tthe\tapplication\tcontext.\tThey\tare\tin\tmilliseconds. heap,\theap.used,\theap.init,\tand\theap.committed\tare\tall\tused\tto\tidentify the\tcurrent\theap\tstatus.\tThey\tare\tin\tKB. threads,\tthreads.peak,\tthreads.totalStarted,\tand\tthreads.daemon provide\tthe\tthread\tcounts. classes,\tclasses.loaded,\tand\tclasses.unloaded\tprovide\tthe\tinformation about\tthe\tclassloader\tlike\ttotal\tnumber\tof\tclasses\tavailable,\ttotal\tnumber\tof classes\tloaded,\tand\ttotal\tnumber\tof\tclasses\tunloaded. httpsessions.max\tand\thttpsessions.active\tindicate\tthe\tmaximum number\tof\tsessions\tand\tcurrently\tactive\tsession\tcount,\trespectively. gauge.response.<request_path>\tindicates\tthe\tresponse\ttime\tof\tthe\tlast request\tfor\tthe\tgiven\trequest\tpath. counter.status.<status_code>.<request_path>\tindicates\tthe\tnumber\tof times\ta\tparticular\tstatus\tcode\twas\treturned\tfor\tthe\tgiven\trequest\tpath.\n\nNote\n\nThis\tlist\tprovides\ta\tquick\tdescription\tof\tthe\tmost\tcommonly\tused\tmetrics. However,\tthere\tare\tother\tmetrics\ttoo,\tsuch\tas\tgarbage\tcollection-related\n\nmetrics.\tYou\tmight\twant\tto\tuse\tthem\tfor\tdebugging.\tTo\tlearn\tmore\tabout\tthose metrics\tplease\tvisit\thttps://docs.spring.io/spring- boot/docs/current/reference/html/production-ready-metrics.html.\n\nThe\tnext\tuseful\tendpoint\tis\tthe\t/health\tendpoint.\tThis\tendpoint\tprovides\ta quick\tsnapshot\tview\tof\tyour\tapplication\tand\tits\tcomponents'\thealth.\tComponents include\tany\tSpring\tmodule,\tsuch\tas\tConsul,\tEureka,\tMySQL,\tand\tso\ton depending\ton\twhether\tyou\tuse\tthem\tin\tyour\tproject.\tIn\tour\tcase,\twe\tdon't\thave any\tSpring\tmodules,\tso\twe\twill\tjust\tsee\ta\thigh-level\thealth\tcheck\tfor\tour\tapp.\n\n1.\t Let's\ttest\tit\tout:\tcurl\thttp://localhost:8080/health 2.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"status\":\t\"UP\",\t\"diskSpace\":\t{\t\"status\":\t\"UP\",\t\"total\": 498876809216,\t\"free\":\t142243303424,\t\"threshold\":\t10485760\t}\t}\n\nAs\tyou\tcan\tsee,\tit\tprovides\tan\toverall\thealth\tstatus\tsaying\tit\tis\tUP\tand\talso provides\tthe\thealth\tof\tthe\tdisk,\tincluding\tsome\tmetrics.\tThis\tendpoint\tis something\tthat\tyou\twill\tend\tup\tusing\tvery\toften,\teither\tto\tcheck\twhether you\tapp\tis\tup\tand\trunning\tor\tto\tcheck\twhether\tall\tthe\tcomponents\tof\tyour app\tare\tworking\tas\texpected.\n\n3.\t The\tnext\tmost\timportant\tendpoint\tis\tthe\t/env\tendpoint.\tThis\tendpoint provides\tuseful\tinformation\tsuch\tas\tJVM\targuments,\tsystem\tproperties,\tand system\tenvironment\tvariables.\tLet's\ttake\ta\tquick\tlook\tat\tit:\tcurl http://localhost:8080/env\n\n4.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"profiles\":\t[],\t\"server.ports\":\t{\t\"local.server.port\":\t8080\t}, \"commandLineArgs\":\t{\t\"spring.output.ansi.enabled\":\t\"always\"\t}, \"servletContextInitParams\":\t{\t},\t\"systemProperties\":\t{ \"com.sun.management.jmxremote.authenticate\":\t\"false\", \"java.runtime.name\":\t\"Java(TM)\tSE\tRuntime\tEnvironment\", \"java.vm.version\":\t\"25.40-b25\",\t\"gopherProxySet\":\t\"false\", \"java.vm.vendor\":\t\"Oracle\tCorporation\",\t\"java.vendor.url\": \"http://java.oracle.com/\",\t\"java.rmi.server.randomIDs\":\t\"true\", \"path.separator\":\t\":\",\t\"java.vm.name\":\t\"Java\tHotSpot(TM)\t64-Bit\tServer VM\",\t\"file.encoding.pkg\":\t\"sun.io\",\t\"user.country\":\t\"US\", \"sun.java.launcher\":\t\"SUN_STANDARD\",\t\"sun.os.patch.level\": \"unknown\",\t\"PID\":\t\"10883\",\t\"com.sun.management.jmxremote.port\": \"64324\",\t\"java.vm.specification.name\":\t\"Java\tVirtual\tMachine\n\nSpecification\",\t.\t.\t.\t},\t\"systemEnvironment\":\t{\t\"PATH\": \"usrbin:/bin:usrsbin:/sbin\",\t\"APP_ICON_6659\":\t\"../Resources/sts.icns\", \"SHELL\":\t\"binbash\",\t\"JAVA_MAIN_CLASS_10883\": \"com.packt.microservices.geolocation.GeoLocationApplication\", \"JAVA_STARTED_ON_FIRST_THREAD_6659\":\t\"1\",\t.\t.\t}, \"applicationConfig:\t[classpath:/application.properties]\":\t{\t\"server.port\": \"${GEOLOCATION_SERVICE_PORT:8080}\"\t}\t}\n\nThe\tmost\timportant\tpart\tof\tthis\tAPI\tis\tthat\tit\tprovides\tthe\tJVM\targuments and\tsystem\tenvironment\tvariables\twith\ttheir\tvalues.\tThis\tis\tvery\tuseful when\tyou\tpass\targuments\tto\tyour\tapplication\tin\tthe\tform\tof\tJVM arguments\tor\tsystem\tenvironment\tvariables.\tIn\tour\tcase,\twe\tuse\tan environment\tvariable\tcalled\tGEOLOCATION_SERVICE_PORT;\thowever,\twe\tsee that\tit\tis\tnot\tbeing\tsupplied\tto\tthe\tenvironment.\tThis\tis\tthe\treason\tour\tserver port\tis\tdefaulted\tto\t8080.\n\n5.\t The\tnext\tuseful\tendpoint\tis\tthe\t/dump\tendpoint.\tThis\tendpoint\tperforms\ta thread\tdump\tand\tprovides\tthe\toutput\tas\tthe\tresponse\tof\tthe\tAPI\tcall.\tGo ahead\tand\texecute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal\tshell:\tcurl http://localhost:8080/dump\t[\t{\t\"threadName\":\t\"http-nio-8080-exec- 10\",\t\"threadId\":\t47,\t\"blockedTime\":\t-1,\t\"blockedCount\":\t0, \"waitedTime\":\t-1,\t\"waitedCount\":\t2,\t\"lockName\": \"java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@3386c54f\", \"lockOwnerId\":\t-1,\t\"lockOwnerName\":\tnull,\t\"inNative\":\tfalse, \"suspended\":\tfalse,\t\"threadState\":\t\"WAITING\",\t\"stackTrace\":\t[\t{ \"methodName\":\t\"park\",\t\"fileName\":\t\"Unsafe.java\",\t\"lineNumber\": -2,\t\"className\":\t\"sun.misc.Unsafe\",\t\"nativeMethod\":\ttrue\t}, This\tresponse\thas\tbeen\ttruncated\tas\tit\twas\ttoo\tlengthy.\tAs\tyou\tcan\tsee,\tthe response\tis\ta\tJSON\trepresentation\tof\tthe\tdump.\tOne\tadvantage\tof\tthe\tJSON representation\tis\tthat\tit\tcan\tbe\tparsed\teasily.\n\n6.\t The\tnext\tuseful\tendpoint\tis\tthe\t/info\tendpoint.\tThis\tendpoint\tprovides\tany information\tthat\tyou\twould\tlike\tto\tdisplay\tabout\tyour\tapplication.\tSome useful\tinformation\tcould\tbe\tthe\tGit\trevision\tID,\tapplication\tartifact\tversion, and\tpublish\tdate\ttime.\n\n7.\t The\tnext\tuseful\tendpoint\tis\tthe\t/trace\tendpoint.\tIt\tideally\tprovides\tthe trace\tlog\tinformation\tof\tthe\tlast\thundred\trequests\tmade\tto\tthe\tservice.\tIn\tthe same\tterminal\tshell,\texecute\tthe\tfollowing\tcurl\tcommand:\tcurl\n\nhttp://localhost:8080/trace\n\n8.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t[\t{ \"timestamp\":\t1481818606409,\t\"info\":\t{\t\"method\":\t\"GET\",\t\"path\": \"/info\",\t\"headers\":\t{\t\"request\":\t{\t\"host\":\t\"localhost:8080\", \"connection\":\t\"keep-alive\",\t\"upgrade-insecure-requests\":\t\"1\",\t\"user- agent\":\t\"Mozilla/5.0\t(Macintosh;\tIntel\tMac\tOS\tX\t10_11_6) AppleWebKit/537.36\t(KHTML,\tlike\tGecko)\tChrome/54.0.2840.98 Safari/537.36\",\t\"accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\", \"accept-encoding\":\t\"gzip,\tdeflate,\tsdch,\tbr\",\t\"accept-language\":\t\"en- US,en;q=0.8,es;q=0.6\"\t},\t\"response\":\t{\t\"X-Application-Context\": \"application:8080\",\t\"Content-Type\":\t\"application/json;charset=UTF- 8\",\t\"Transfer-Encoding\":\t\"chunked\",\t\"Date\":\t\"Thu,\t15\tDec\t2016 16:16:46\tGMT\",\t\"status\":\t\"200\"\t}\t}\t}\t},... As\tyou\tcan\tsee,\twe\thave\ttruncated\tthe\tresponse\tas\tit\twas\ttoo\tlong.\tThe snippet\tshows\tjust\tone\trequest\tand\tits\tinformation.\tThis\twill\tbe\tparticularly useful\twhen\tyou\tare\tdebugging\tyour\tAPI\tfailures.\n\n9.\t Oftentimes,\tyou\tmight\twant\tto\tmodify\tthese\tmetrics.\tBe\tit\texposing\tyour own\thealth\tstatus\tor\texposing\tsome\tinformation\tmetrics,\tthere\tare\tways\tto do\tso\tusing\tSpring. Note\n\nIf\tyou\twould\tlike\tto\tinvest\tmore\ttime\ton\tthese\ttopics,\tgo\tover\tthe descriptive\tdocumentation\ton\tSpring\tBoot's\tGitHub\tdocumentation\tat https://github.com/spring-projects/spring-boot/blob/master/spring-boot- docs/src/main/asciidoc/production-ready-features.adoc\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tThere\tare\tother\tendpoints\tthat\twe\thave not\tdiscussed\tin\tthis\trecipe,\tsuch\tas\t/shutdown,\t/loggers,\t/mappings, /configprops,\t/beans,\tand\t/autoconfig.\tI'll\tleave\tthat\tas\tan\texercise\tfor\tyou to\ttry\tout.\tThe\t/shutdown\tendpoint\tis\tdisabled\tby\tdefault.\tYou\thave\tto\tenable\tit by\tsetting\tthe\tvalue\tof\tendpoints.shutdown.enabled\tto\ttrue\tin\tyour application.properties\tfile.\n\nCreating\tcustom\tmetrics\tusing Dropwizard\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tuse\tthe\tSpring\tBoot\tActuator metrics.\tBut\twhat\tif\tyour\tapplication\tis\tnot\tSpring\tBoot\tand\tyou\tstill\twant\tto create\tmetrics\tof\tyour\town?\tThat\tis\twhat\tthis\trecipe\twill\thelp\tyou\twith.\tNot every\tmicroservice\tneeds\tto\tbe\tSpring\tBoot\tbased.\tThere\tare\tsome\tmicroservices that\tcould\tbe\twritten\twith\tother\tmicroservice\tframeworks.\tIn\tthose\tcases,\tif\tyou would\tlike\tto\tcreate\tyour\town\tmetrics,\tyou\tcould\tuse\tDropwizard's\tCodahale library.\tCodahale\tis\tone\tof\tthe\tmost\tpopular\tmetrics\tlibraries\tavailable\tfor\tJava- based\tapplications.\tIn\tfact,\tSpring\tBoot\tinternally\tuses\tCodahale\tto\tcreate\tsome of\tits\tmetrics.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tCodahale\tlibrary\tto\tcreate\ta metric\tfor\tthe\tgeolocation\tapplication.\n\nGetting\tready\n\nIf\tyou\tare\twondering\twhat\tthe\tassociation\tbetween\tDropwizard\tand\tCodahale\tis, the\tanswer\tis\tthat\tCodahale\tfalls\tunder\tthe\tDropwizard\tumbrella.\tDropwizard\tis an\tecosystem\tof\tlibraries\tthat\tcan\tbe\tused\tto\tbuild\tbetter\tmicroservices.\tSome\tof these\tlibraries\tinclude\tJetty\tfor\tin-memory\tweb\tservers,\tJersey\tfor\tbuilding REST\tAPIs,\tJackson\tfor\tworking\twith\tJSON\tdocuments,\tand\tCodahale\tfor metrics.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tjust\tthe\tCodahale\tlibrary\tto\texpose\tour metrics.\tThe\tgreat\tthing\tabout\tthis\tlibrary\tis\tthat\tit\thas\tbeen\tdeveloped\tin\tsuch\ta way\tthat\tit\tcan\tbe\tused\tindependently\tas\twell-that\tmeans\tyou\tcan\tuse\tCodahale even\twhen\tyour\tproject\tdoes\tnot\tuse\tthe\tother\tDropwizard\tcomponents.\tLet's create\tour\tfirst\tmetric.\tOpen\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe\tgeolocation project.\n\nHow\tto\tdo\tit...\n\nBefore\twe\tjump\tin,\tlet's\tdecide\twhich\ttype\tof\tmetric\twe\tare\tgoing\tto\tcreate. There\tare\tseveral\tmetric\ttypes\tthat\tDropwizard\tCodahale\toffers:\n\nGauges Counters Meters Timers Histograms\n\nA\tgauge\tis\ta\ttype\tof\tmetric\tthat\tcan\thold\tany\tvalue.\tIt\tis,\tin\tfact,\tthe\tmost common\tmetric\ttype.\tThe\tnext\ttype\tof\tmetric\tis\tcounter.\tCounters,\tas\tthe\tname indicates,\tare\tused\tto\tmaintain\ta\tcounter\tand\tare\tusually\tincremented\tin\ta sequence.\tAny\trate\tis\tusually\trepresented\tas\ta\tmeter.\tA\thistogram\tis\tused\tto measure\tthe\tdistribution\tof\tvalues.\tThough\ttimers\tsound\tpretty\tstraightforward, they're\tactually\tnot.\tTimers\tare\ta\tcombination\tof\tboth\thistograms\tand\tmeters. Understanding\ttimers\ttakes\tsome\ttime,\tbut\tputting\tthem\tto\tuse\twill\tadd\tgreat value.\tTo\tlearn\tmore\tabout\thistograms\tplease\ttake\ta\tlook\tat http://metrics.dropwizard.io/3.1.0/getting-started\t.\tIn\tthis\trecipe,\tlet's\ttry\tto create\ttwo\ttypes\tof\tmetrics:\tgauge\tand\tcounter:\n\ngeolocationWriteRequestCount:\tThe\tnumber\tof\ttimes\tthe\tPOST\tAPI\twas invoked\t(counter) geolocationLastWriteTime:\tThe\tmost\trecent\ttimestamp\tof\twhen\ta geolocation\twas\tcreated\t(gauge)\n\nLet's\tstart\tby\tcreating\ta\tnew\tcounter\tfor\tthe\tgeolocationWriteRequestCount metric:\n\n1.\t First\tadd\tthe\tMaven\tdependencies\twe\tneed:\t<dependency> <groupId>io.dropwizard.metrics</groupId>\t\t\t\t\t<artifactId>metrics- core</artifactId>\t</dependency>\n\n2.\t Now\tcreate\ta\tbean\tcalled\n\ncom.packt.microservices.geolocation.MetricSystem.java,\twhich\twill be\tresponsible\tfor\tinstantiating\tand\treporting\tour\tmetrics.\tFor\treporting,\twe will\tuse\tour\tbasic\tConsoleReporter\tuntil\twe\tset\tup\tour\tGraphite\tinstance.\n\n3.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservices.geolocation.MetricSystem.java.\tAnnotate\n\nthis\tclass\twith\tthe\t@Component\tannotation.\tAlso\tadd\tan\tinit()\tmethod\twith @PostConstruct\tannotation.\tThis\tis\twhere\twe\twill\tbe\tsetting\tup\tour metrics:\tpackage\tcom.packt.microservices.geolocation;\timport javax.annotation.PostConstruct;\timport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; @PostConstruct\tpublic\tvoid\tinit()\t{\t}\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tautowired\ta\tbean\tof\ttype\tMetricRegistry\tinstead of\tcreating\tour\town\tMetricRegistry\tinstance.\tSpring\tBoot\tmakes\tthe MetricRegistry\tbean\tavailable.\tSo\tany\tmetric\tcreated\twith\tthis MetricRegistry\tinstance\twill\tbe\texposed\tby\tthe\t/metrics\tendpoint\tas well.\tThis\tis\tthe\treason\twe\tare\tautowiring\tthe\tMetricRegistry\tbean. 4.\t Before\twe\tcreate\tthe\tmetric,\tlet's\tset\tup\ta\tConsoleReporter.\tCodahale\n\nprovides\ta\tset\tof\tmetric\treporters\tresponsible\tfor\tpublishing\tthe\tmetrics\tthat are\tcreated\tto\tanother\tconsumption\tlayer.\tCurrently,\tthere\tis\tsupport\tfor Graphite,\tGanglia,\tSLF4J,\tCSV,\tand\tConsole.\tThe\tConsoleReporter,\tas\tits name\tindicates,\treports\tall\tthe\tmetrics\tto\tstdout.\tIn\tthe\tnext\trecipe,\twe\twill set\tup\tour\town\tGraphite\tinstance\twith\tthe\thelp\tof\tDocker.\tUntil\tthen,\tfor simplicity,\twe\twill\tbe\tusing\tthe\tConsoleReporter.\tAdd\tthe\tfollowing snippet\tto\tthe\tinit()\tmethod:\tConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS);\n\nThere\tare\tthree\tthings\tto\tnote\there.\tThe\tconvertRatesTo()\tmethod\tsays that\tall\tthe\trates\thave\tto\tbe\tconverted\tto\tseconds,\tand\tthe convertDurationsTo()\tmethod\tsays\tthat\tall\tthe\tdurations\tshould\tbe converted\tto\tmilliseconds.\tThe\tstart\tmethod,\thowever,\ttakes\ttwo arguments.\tThese\ttwo\targuments\ttogether\ttell\tCodahale\tto\treport\tmetrics\tto the\tconsole\tevery\t10\tseconds.\n\n5.\t Now\tcreate\ta\tnew\tCounter\tvariable\twith\tthe\tname\n\ngeolocationWriteRequestCount.\tLet's\tdefine\tit\tin\tthe\tinit()\tmethod\tand put\tit\tinto\taction:\tpackage\tcom.packt.microservices.geolocation;\timport\n\njava.util.concurrent.TimeUnit;\timport\tjavax.annotation.PostConstruct; import\torg.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.ConsoleReporter;\timport com.codahale.metrics.Counter;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; private\tCounter\tgeolocationWriteRequestCount;\t@PostConstruct\tpublic void\tinit()\t{\tConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS); geolocationWriteRequestCount\t= metricRegistry.counter(\"geolocationWriteRequestCount\");\t}\tpublic\tCounter geolocationWriteRequestCount()\t{\treturn\tgeolocationWriteRequestCount;\t} }\n\nIt\tis\tas\tsimple\tas\tthat.\tWe\thave\talso\tcreated\ta\tmethod\tto\tget\tthis\tcounter\tso that\tit\tcan\tbe\tused\tfrom\tour\tcontroller.\n\n6.\t Now\tmove\ton\tto\tthe\tGeoLocationController.java\tclass\tand\tincrement\tthe counter\tusing\tthe\tinc()\tmethod\tas\tand\twhen\ta\tnew\tgeolocation\tis\tcreated. Though\tthis\tmight\tnot\tbe\ta\tgood\tpractice,\twe\tare\tgoing\tto\tadd\tit\tto\tthe controller\tfor\tillustration\tpurposes\tonly:\t@Autowired\tprivate\tMetricSystem metricSystem;\t@RequestMapping(method\t=\tRequestMethod.POST, produces\t=\t\"application/json\",\tconsumes\t=\t\"application/json\")\tpublic GeoLocation\tcreate(@RequestBody\tGeoLocation\tgeolocation)\t{ GeoLocation\tnewGeoLocation\t=\tservice.create(geolocation); metricSystem.geolocationWriteRequestCount().inc();\treturn newGeoLocation;\t} As\tyou\tcan\tsee,\twe\thave\tautowired\tthe\tMetricSystem\tbean\tand\tused\tit\tto get\tour\tgeolocationWriteRequestCount\tcounter.\tWe\thave\tthen\tinvoked the\tinc()\tmethod\tto\tincrement\tthe\tcounter.\n\n7.\t That's\tit!\tNow\tlets'\ttest\tit\tout.\tGo\tahead\tand\tstart\tthe\n\nGeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tAfter\tyour\tapplication\thas\tstarted,\tissue\tthe\tfollowing\tcurl\n\ncommands\tto\tcreate\ttwo\tnew\tgeolocations:\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8080/geolocation\n\nThis\tshould\thave\tincremented\tthe\tcounter\tvalue\tto\t2.\n\n8.\t Now\tgo\tback\tto\tyour\tSTS\tIDE,\tand\tlook\tat\tthe\tconsole\tlogs\tof\tthe geolocation\tproject.\tYou\tshould\tsee\tsomething\tlike\tthis\tgetting\tlogged every\t10\tseconds:\tGauges\t-------------------------------------------------- gauge.response.geolocation\tvalue\t=\t32.0\tCounters\t--------------------------- -----------------------\tcounter.status.200.geolocation\tcount\t=\t2 geolocationWriteRequestCount\tcount\t=\t2\n\nWe\tcan\tclearly\tsee\tthat\tthe\tvalue\tof\tgeolocationWriteRequestCount\tis\t2 now.\tAlso\tnote\tthe\tother\ttwo\tmetrics,\tgauge.response.geolocation\tand counter.status.200.geolocation.\tThese\tmetrics\tare\tcreated\tby\tSpring Boot.\tIf\tyou\tremember\tfrom\tthe\tprevious\trecipe,\tthese\tmetrics\twere displayed\ton\tthe\t/metrics\tendpoint.\n\n9.\t Now\tlet's\tquickly\tinvoke\tthe\t/metrics\tendpoint\tto\tcheck\twhether\tour metrics\tare\tpopulated.\tExecute\tthe\tfollowing\tcurl\tcommand\ton\tyour terminal:\tcurl\thttp://localhost:8080/metrics\t{\t.\t. \"counter.status.200.geolocation\":\t2,\t\"gauge.response.geolocation\":\t32, \"geolocationWriteRequestCount\":\t2,\t.\t.\t}\n\nThis\tresponse\thas\tbeen\ttrimmed\tas\tit\twas\tvery\tlong.\tAs\tyou\tcan\tsee,\tamong other\tmetrics,\tthe\tthree\tmetrics\tthat\twe\tsaw\tin\tthe\tconsole\tare\treported. 10.\t Now\tlet's\tcreate\tour\tnext\tmetric,\tgeolocationLastWriteTime.\tThis\tmetric will\tbe\ta\tgauge,\tand\twe\twill\tbe\tstoring\tthe\tepoch\ttime\tas\tthe\tvalue.\tWe\tcan get\tthe\tepoch\ttime\tin\tJava\tusing\tSystem.currentTimeMillis().\tAs\tthis metric\tis\tgoing\tto\tstore\tthe\tlast\twrite\ttimestamp,\tthis\tmetric\tneeds\tto\tbe updated\tonly\twhen\ta\tnew\tgeolocation\tis\tcreated.\tSo\twe\twill\tneed\ta\tholder variable\tin\tour\tMetricSystem\tbean\tthat\tis\tupdated\twith\tthe\ttime\tevery\ttime a\tnew\tgeolocation\tis\tcreated.\tThe\tgauge\tis\ta\tlittle\tdifferent\tfrom\tthe\tcounter for\tthe\tfact\tthat\tit\tgets\tcalculated\tevery\ttime\tit\tgets\treported.\tAfter\tadding\n\nthe\tgeolocationLastWriteTime\tgauge,\tthe\tMetricSystem\tbean\twill\tlook like\tthis:\tpackage\tcom.packt.microservices.geolocation;\timport java.util.concurrent.TimeUnit;\timport\tjavax.annotation.PostConstruct; import\torg.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.ConsoleReporter;\timport com.codahale.metrics.Counter;\timport\tcom.codahale.metrics.Gauge;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; private\tCounter\tgeolocationWriteRequestCount;\tprivate\tLong geolocationLastWriteTime;\t@PostConstruct\tpublic\tvoid\tinit()\t{ ConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS); geolocationWriteRequestCount\t= metricRegistry.counter(\"geolocationWriteRequestCount\"); metricRegistry.register(\"geolocationLastWriteTime\",\tnew\tGauge<Long>() {\t@Override\tpublic\tLong\tgetValue()\t{\treturn\tgeolocationLastWriteTime;\t} });\t}\tpublic\tCounter\tgeolocationWriteRequestCount()\t{\treturn geolocationWriteRequestCount;\t}\tpublic\tvoid markGeolocationLastWriteTime()\t{\tgeolocationLastWriteTime\t= System.currentTimeMillis();\t}\t}\n\nSee\thow\tthe\tgauge\tis\tregistered\twith\tan\tinner\tclass\tthat\thas\ta\tgetter\tmethod called\tgetValue().\tAlso\tsee\thow\twe\thave\tcreated\tthe markGeolocationLastWriteTime()\tmethod\tthat\tupdates\tthis\tvariable\twith the\tcurrent\ttimestamp.\n\n11.\t We\tare\tnow\tready\tto\tincorporate\tthis\tmetric\tinto\tthe\n\nGeoLocationController.java.\tAll\twe\tneed\tto\tdo\tis\tadd\tthis\tline\tof\tcode\tto the\tcreate\tmethod:\tmetricSystem.markGeolocationLastWriteTime();\n\n12.\t That's\tit.\tOur\tgauge\tis\tnow\tready\tto\ttest.\tRestart\tthe\n\nGeolocationApplication.java\tclass\tand\tcreate\ta\tcouple\tof\tgeolocations using\tthe\tcurl\tcommand.\tThis\ttime\taround,\tyou\tshould\tsee\ta\tnew\tgauge with\tthe\tlast\twrite\ttimestamp\tas\tits\tvalue:\t--\tGauges\t---------------------------- -----------------------------------\tgauge.response.geolocation\tvalue\t=\t11.0\n\ngeolocationLastWriteTime\tvalue\t=\t1481939509826\t--\tCounters\t---------- ---------------------------------------------------\tcounter.status.200.geolocation count\t=\t2\tgeolocationWriteRequestCount\tcount\t=\t2\n\n13.\t You\tcan\tverify\tthis\tby\tinvoking\tthe\t/metrics\tendpoint\tas\twell.\n\nThat's\tit!\tWe\tnow\thave\tcome\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned how\tto\tcreate\tcustom\tmetrics\tand\texpose\tthem\tvia\tSpring\tBoot's\t/metrics endpoint.\tWe\talso\tlearned\thow\tto\texpose\tthem\tvia\tthe\tConsoleReporter.\n\nSetting\tup\tGraphite\tusing\tDocker\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tset\tup\tGraphite\tusing\tDocker.\tBefore\tthat, let's\tlearn\ta\tfew\tthings\tabout\tGraphite's\tarchitecture.\tGraphite\tconsists\tof\tthree major\tcomponents:\tWhisper,\tCarbon,\tand\tGraphite-Web.\tWhisper\tis\ta database\tlibrary\tthat\tGraphite\trelies\ton.\tIt\tworks\tlike\ta\tround-robin\tdatabase. Carbon\tis\tthe\tbackend\tdaemon\tthat\tis\tresponsible\tfor\thandling\tclient\trequests. The\tGraphite-Web\tinterface\tis\tused\tto\tcreate\tdashboards\tand\tvisualize\tthe\tdata stored\tin\tGraphite.\n\nGetting\tready\n\nAs\tusual,\twe\twill\tbe\tdefining\tour\tGraphite\timage\tin\ta\tdocker-compose\tfile.\tThe reason\twe\tare\tusing\tdocker-compose\tinstead\tof\trunning\tdocker\trun\tis\tthat\twe will\tlater\tbe\tadding\tGrafana\tto\tthis\tdocker-compose\tfile.\tOpen\tup\tyour\tSTS\tIDE and\tnavigate\tto\tthe\tgeolocation\tproject.\n\nHow\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\tguide\tyou\tthrough\tsetting\tup\ta\tstandalone Graphite\tinstance\tusing\tDocker.\n\n1.\t Create\ta\tnew\tdocker-compose\tYAML\tfile\tcalled\tdocker-compose- graphite.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tYAML\tfile:\n\nversion:\t\"2\"\n\nservices: \t\tgraphite: \t\t\t\timage:\thopsoft/graphite-statsd \t\t\t\tports: \t\t\t\t\t\t-\t\"8100:80\" \t\t\t\t\t\t-\t\"2003:2003\" \t\t\t\t\t\t-\t\"2004:2004\"\n\nAs\tyou\tcan\tsee,\twe\tare\tnot\tusing\tan\tofficial\timage\tfor\tGraphite. Unfortunately,\tthere\tis\tno\tofficial\tversion\tof\tGraphite\tavailable\tat\tthe\ttime of\twriting\tthis.\tSo\twe\thave\tpicked\tthis\timage\tthat\thas\tboth\tGraphite\tand statsd\tconfigured.\tstatsd\tis\ta\tdaemon\tdeveloped\tby\tEtsy\tto\tconsolidate application\tmetrics\tand\tpublish\tthem\tover\tto\ta\tgraphing\tsystem.\n\n2.\t To\tlearn\tmore\tabout\tstatsd,\tvisit\ttheir\tGitHub\tpage\tat\n\nhttps://github.com/etsy/statsd\t.\tIf\tyou\ttake\ta\tlook\tat\tthis\timage's documentation\tat\thttps://hub.docker.com/r/hopsoft/graphite-statsd\t,\tthere are\tseveral\tports\tand\tvolumes\tthat\tcan\tbe\tmapped.\tWe\tare\tnot\tmapping them\tas\twe\twill\tnot\tneed\tthem\tfor\tthis\trecipe.\tBut\tfeel\tfree\tto\tuse\tthem\tif you\tneed\tto.\tPort\t80\tis\tused\tby\tNginx,\twhere\tyour\tweb\tinterface\tand\tREST endpoints\treside.\tPort\t2003\tis\twhere\tthe\tCarbon\treceiver\tis\tlistening.\tPort 2004\tis\twhere\tCarbon\tPickle\treceiver\tis\tlistening.\tWe\tare\tnot\tmapping\tport 80\ton\tthe\tcontainer\tto\tport\t80\ton\tthe\thost\tbecause\tport\t80\tis\ta\tvery\tcommon port\tnumber\tand\tyou\tmight\thave\tother\tapps\trunning\ton\tport\t80.\tSo\twe\tare mapping\tit\tto\tport\t8100\ton\tthe\thost\tmachine.\n\nNote\n\nThere\tare\ttwo\ttypes\tof\tprotocols\tby\twhich\tyou\tcan\tfeed\tmetrics\tto\tCarbon: Plain\ttext\tand\tPickle.\tPlain\ttext\tfollows\tthe\tsimplest\tformat,\twhere\tit\tsends metrics\tin\tthe\tformat\tof\t<path>\t<value>\t<timestamp>,\twhere\tpath\n\nindicates\tthe\tpath\tat\twhich\tthe\tmetric\twill\tbe\tstored\talong\twith\tthe\tmetric name.\tHowever,\tPickle\ton\tthe\tother\thand\tis\tused\tto\tsend\ta\tbatch\tof\tmetrics all\tat\tonce\tto\tCarbon.\tIt\ttakes\tmetrics\tin\tform\tof\ttuples:\t[(path, (timestamp,\tvalue))].\tFor\tmore\tinformation,\tlook\tat\tGraphite's descriptive\tdocumentation\tat http://graphite.readthedocs.io/en/latest/feeding-carbon.html#feeding-in- your-data\t.\n\n3.\t Now\tthat\twe\thave\tour\tdocker-compose\tYAML\tfile,\tlet's\tspin\toff\tour\tfirst Graphite\tinstance.\tOpen\tup\ta\tnew\tterminal\twindow.\tStart\tdocker-machine if\tit\tis\tnot\tstarted\talready,\tand\tset\tup\tDocker\tusing\tthe\tenv\tcommand. Change\tyour\tdirectory\tto\tthe\tgeolocation\tproject\tand\texecute\tthe following\tcommand:\n\ndocker-compose\t-f\tdocker-compose-graphite.yml\tup\n\n4.\t You\tshould\tsee\tsomething\tlike\tthis:\n\nCreating\tgeolocation_graphite_1 Attaching\tto\tgeolocation_graphite_1 graphite_1\t\t|\t***\tRunning\t etcmy_init.d/00_regen_ssh_host_keys.sh... graphite_1\t\t|\t***\tRunning\tetcmy_init.d/01_conf_init.sh... graphite_1\t\t|\t***\tRunning\tetcrc.local... graphite_1\t\t|\t***\tBooting\trunit\tdaemon... graphite_1\t\t|\t***\tRunit\tstarted\tas\tPID\t13\n\n5.\t Now\tthat\tour\tGraphite\tinstance\tis\tup\tand\trunning,\tlet's\tverify\tit\tby accessing\tthe\tweb\tinterface.\tOpen\ta\tnew\tbrowser\tsession\tand\tnavigate\tto this\tURL:\thttp://192.168.99.100:8100.\tYou\tshould\tsee\tthe\tGraphite dashboard\tpage:\n\n6.\t If\tyou\tlog\tin\tto\tthe\tapp\tusing\tthe\tcredentials\troot/root,\tyou\twill\tbe\table\tto manage\tthe\tgraphs\tthat\tyou\thave\tcreated.\tIt\twill\talso\tenable\tcertain\tfeatures on\tthe\twhole\tUI.\tNow\texpand\tthe\tMetrics\tnode\tand\tsee\twhat\tkind\tof metrics\tare\tbeing\texposed:\n\nAs\tyou\tcan\tsee,\tthere\tare\tsome\tmetrics\tingested\tby\tstatsd.\tUsually,\tmetrics created\tby\tstatsd\tstart\twith\tthe\tkeyword\tstats.\tYou\tcan\tplot\teach\tof\tthese metrics\ton\ta\tgraph\tby\tsimply\tclicking\ton\tthem.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tGraphite\tby\titself\toffers\ttons\tof\tfeatures, and\tits\ttrue\tpower\tcan\tbe\texperienced\tonly\twhen\twe\trun\tit\tin\tclustered\tmode.\tIt is\tstrongly\trecommended\tthat\tyou\tunderstand\tGraphite\tand\tits\tcomponents before\tyou\tstart\tusing\tit\tin\tproduction.\n\nNote\n\nFortunately,\tGraphite's\tdocumentation\tis\tvery\tdescriptive\tand\thas\ta\tlot\tof\tuseful information.\tYou\tcan\tfind\tit\tat\thttp://graphite.readthedocs.io/en/latest/index.html .\n\nUsing\tthe\tGraphite\tinterface\n\nIn\tthis\trecipe,\tlet's\tfamiliarize\tourselves\twith\tthe\tGraphite\tweb\tinterface.\tThough it\tlooks\tvery\tsimple,\tit\tis\tpacked\twith\ttons\tof\tgraphing\tfeatures.\tWe\twill\tlook\tat some\tof\tthem\tin\tthis\trecipe.\tFor\tgraphing,\twe\twill\tuse\tthe\tmetrics\tthat\tare created\tby\tstatsd.\n\nGetting\tready\n\nWe\twill\tbe\tpicking\tsome\tbasic\tmetrics\tfrom\tGraphite\tin\torder\tto\tdemonstrate\tits graphing\tabilities.\tAlso,\tlet\tGraphite\tcollect\tsome\tmetrics\tfrom\tstatsd.\tIt\tis recommended\tthat\tyou\tleave\tthe\tGraphite\tcontainer\tup\tand\trunning\tfor\ta\tfew minutes\tbefore\tyou\ttry\tthis\trecipe.\tAfter,\tsay,\t15\tminutes,\topen\ta\tnew\tbrowser tab\tand\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tat\thttp://192.168.99.100:8100.\n\nHow\tto\tdo\tit...\n\nThe\tleft-hand\tside\tpane\tof\tthe\tGraphite\tinterface\tis\tusually\tthe\tmetric\tchooser. That's\twhere\tyou\twill\tbe\table\tto\tfind\tall\tthe\tmetrics\tthat\tare\tavailable\tin Graphite.\tThere\tare\tthree\ttabs:\n\nTree Search AutoCompleter\n\nLets\tstart\twith\tthe\tTree\tview\tfirst.\n\nTree\tview\n\nAs\tthe\tname\tindicates,\tyou\tcan\tnavigate\tthrough\tthe\ttree\tnodes\tand\tview\tall\tthe metrics\tavailable\tunder\teach\tpath.\tClicking\ton\ta\tmetric\twill\tplot\tthe\tmetric\ton the\tgraph\ton\tthe\tright-hand\tside\tpane.\tIn\tthe\tfollowing\tscreenshot,\twe\thave picked\tthe\tmetric\tat\tstats.statsd.processing_time:\n\nNow\tlet's\tmove\ton\tto\tthe\tgraph\tmodal.\tThere\tare\tsome\tuseful\tbuttons\tin\tthis modal.\tFirst\toff,\tthere's\tthe\tDate\tRange\tbutton\tthat\tlooks\tlike\ta\tcalendar. Clicking\ton\tthis\tbutton\tgives\tyou\ttwo\tcalendars\twhere\tyou\tcan\tchoose\tthe\tfrom and\tto\tdates\tand\ttimes.\tThis\tway,\tyou\tcan\tfocus\ton\tthe\ttime\twindow\tthat\tyou\tare interested\tin.\tIt\tlooks\tsomething\tlike\tthis:\n\nThe\tnext\tuseful\tbutton\tin\tthe\tmodal\tis\tthe\tSelect\tRecent\tData\tbutton,\twhich looks\tlike\ta\tclock.\tThis\toption\tlets\tyou\tchoose\tthe\tmost\trecent\ttime\twindow\tin the\tmeasure\tof\tminutes,\thours,\tdays,\tweeks,\tmonths,\tand\tyears.\tIt\tlooks something\tlike\tthis:\n\nThe\tnext\tbutton\tthat\twe\twould\twant\tto\tuse\tmost\tof\tthe\ttime\tis\tthe\tShort\tURL button.\tThis\tbutton\tis\tused\tto\tgenerate\ta\tshort\tURL\tthat\twe\tcan\tuse\tto\trender\tthis graph\tfrom\toutside\tthe\tGraphite\tweb\tinterface.\tIt\tinternally\tuses\tthe\tRender\tAPI,\n\nand\tthese\tgraphs\tcan\tbe\tembedded\tin\tany\tweb\tpage.\tSometimes,\tyou\twould want\tto\tmodify\tyour\tgraph's\tappearance,\tlegend,\tand\tstyle.\tFor\tthis\tpurpose,\tyou can\tuse\tthe\tGraph\tOptions\tbutton.\tIt\thas\ttons\tof\toptions\tthat\tyou\tcan\tuse\tto modify\tthe\tway\tyour\tgraph\tlooks:\n\nAnd\tfinally,\twhat\tif\tyou\twant\tto\tembed\tmultiple\tmetrics\ton\tthe\tsame\tgraph? You\thave\tto\tplot\tthem\tall\tin\ta\tsingle\tgraph.\tThat's\twhere\tthe\tGraph\tData\tbutton will\tbe\tuseful.\tIf\tyou\tclick\ton\tthis\tbutton,\tit\twill\topen\tup\ta\tmodal\tfrom\twhere you\tcan\tchoose\tother\tmetrics,\tand\tit\twill\tautomatically\tplot\tthem\tin\tthe underlying\tgraph:\n\nThe\tAuto\tRefresh\tbutton\tis\ta\ttoggle\tbutton\tthat\tyou\tcan\tenable\tto\tautomatically refresh\tthe\tgraph.\tIt\tis\tuseful\tto\tkeep\tthis\toption\tturned\ton,\tbut\tkeep\tin\tmind\tthat\n\nit\tmakes\tseveral\trequests\tfrequently,\tand\tit\tmight\tslow\tdown\tyour\tdashboard\tif you\thave\tlot\tof\tgraphs\tthat\thave\tthis\toption\tenabled.\tBy\tdefault,\tif\tthis\toption\tis enabled,\tit\trefreshes\tevery\t60\tseconds.\n\nSearch\n\nNow\tlets\tmove\ton\tto\tthe\tnext\ttab:\tSearch.\tThis\ttab\tmight\t(depending\ton\tthe version)\tbe\tdisabled\tif\tyou\tare\tlogged\tin\tas\troot\tuser.\tSo\tgo\tahead\tand\tlogout.\tAs the\tname\tindicates,\tthe\tSearch\ttab\tis\tused\tto\tsearch\tfor\tany\tmetrics\tunder\tthe given\tpath.\tIf\tyou\tenter\tstats\tin\tthe\tsearch\tbar\tand\thit\tEnter,\tyou\tshould\tsee\tall the\tmatching\tmetric\tnames\tin\tthe\tresults\tsection.\tClicking\ton\ta\tmetric\tfrom\tthe result\tsection\twill\tplot\tthe\tmetric\ton\tthe\tgraph\tin\tthe\tright-side\tpane.\tClicking\ton the\tsame\tmetric\tagain\twill\tremove\tit\tfrom\tthe\tplotted\tgraph.\tTo\tget\tmore\thelp\ton the\tSearch\tfeature,\tjust\tclick\ton\tthe\tHelp\thyperlink.\tThe\tfollowing\tscreenshot shows\tthe\tresults\tfor\tthe\tstats\tkeyword:\n\nAutoCompleter\n\nThe\tAutoCompleter\tmode\tis\tvery\tsimilar\tto\tthe\tSearch\tmode\texcept\tfor\tthe fact\tthat\tthe\tsearch\ttextbox\thas\tautocomplete\tenabled.\tThe\tother\tdifference between\tthese\ttwo\tmodes\tis\tthat\tin\tAutoCompleter\tmode,\tyou\thave\tto\tnavigate to\tthe\tmetric\tin\torder\tto\tplot\tit.\tUse\tTab\tto\tselect\ta\tsuggestion\tin\n\nAutoCompleter\tmode.\tThe\tresults\tpane\tis\tnot\tvery\thelpful\tin\tthis\tmode.\tIt\tis surprising\twhy\tthese\ttwo\tmodes\thave\tbeen\tseparated\tinto\ttwo\tdifferent\ttabs.\tIt would\tmake\ta\tlot\tof\tsense\tto\tmerge\ttheir\tfeatures\tand\tkeep\tthem\ttogether\tin\ta single\ttab.\tThe\tfollowing\tscreenshot\tillustrates\thow\tthe\tAutoCompleter\tmode works:\n\nGraphite\n\nThe\tother\timportant\tpage\tin\tGraphite\tis\tthe\tDashboard\tpage\ton\tthe\ttop\tright. The\tDashboard\tview\tis\tused\tto\tcreate\tmultiple\tgraphs\tand\tcreate\ta\tdashboard. You\tcan\tin\tfact\tsave\tthe\tgraphs\tand\tdashboards\tand\tuse\tthem\tlater.\tAs\twe\thave not\tmapped\tthe\tdocker\tvolume\tthat\thold\tthe\tdashboards,\twe\tmight\tnot\tbe\table\tto recover\tthem\tafter\twe\trecreate\tthe\tcontainer.\tBut\tin\tproduction\tmode,\twhen\tyou are\trunning\tit\telsewhere,\tkeep\tin\tmind\tthat\tthe\tgraphs\tand\tdashboards\tshould\tbe recoverable.\tRefer\tto\tthe\tdocumentation\tof\tthis\tcontainer\tto\tsee\twhich\tvolume holds\twhat\tinformation.\tYou\tcan\tperform\tall\tthe\toperations\tthat\twe\tjust\twent through\ton\tthe\tDashboard\tpage\tas\twell.\tThe\tfollowing\tscreenshot\tshows\thow you\tcan\tcreate\tyour\town\tdashboard:\n\nAs\tyou\tcan\tsee,\tthe\ttop\tsection\tis\twhere\tyou\tchoose\tthe\tmetrics,\tand\tthe\tbottom section\tis\twhere\tyou\tcustomize\tyour\tdashboard.\tThere\tare\tseveral\toptions\tthat you\tcan\tperform\ton\tthis\tdashboard.\tI\twill\tleave\tit\tto\tyou\tas\tan\texercise\tto explore\tthe\tDashboard\tview.\tIf\tyou\tare\twondering\twhy\tyou\twould\tneed\tanother tool\tsuch\tas\tGrafana\twhen\tGraphite\talready\thas\tmost\tof\tthe\tgraphing capabilities,\tthe\tanswer\tis-wait\tuntil\tyou\tsee\tthe\tabilities\tof\tGrafana.\tGrafana's only\tfocus\tis\tbuilding\tmonitoring\tsystems.\tWe\twill\tlearn\tmore\tabout\tit\tin\tlater recipes\tof\tthis\tchapter.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\thave\tlearned\thow\tto use\tthe\tGraphite\tweb\tinterface.\tNow\tyou\tknow\thow\tpowerful\tGraphite's\tweb interface\tis.\tIn\tfact,\tGraphite\tlets\tyou\tcreate\tsophisticated\tgraphs,\tsave\tthem,\tand share\tthem.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tbe\texporting\tthe\tmetrics\tthat\twe created\tin\tthe\tgeolocation\tapplication\tover\tto\tGraphite\tand\tplot\tthem\ton\tgraphs using\tGrafana.\n\nExporting\tDropwizard\tmetrics\tover to\tGraphite\n\nIn\tthe\tearly\trecipes\tof\tthis\tchapter,\twe\tlearned\thow\tto\tcreate\tmetrics\tusing Dropwizard's\tCodahale\tlibrary.\tLater,\twe\tlearned\thow\tto\tstart\tGraphite\tusing Docker\tand\tunderstood\tthe\tbasics\tof\tusing\tthe\tGraphite\tinterface.\tIn\tthis\trecipe, we\twill\tbe\texporting\tthe\tmetrics\twe\tcreated\tin\tthe\tgeolocation\tapplication\tover to\tthis\tGraphite\tinstance,\twhich\twill\tthen\tbe\tused\tby\tGrafana\tfor\tgraphing.\n\nGetting\tready\n\nAs\twe\twill\tbe\tworking\ton\tthe\tgeolocation\tapplication,\tfollow\tthese\tsteps:\n\n1.\t Open\tthe\tSTS\tIDE. 2.\t Navigate\tto\tthe\tgeolocation\tproject,\tand\tget\tready\tfor\tthe\tnext\tstep. 3.\t Start\tGraphite\tif\tyou\thaven't\tdone\tso.\tYou\tcan\tuse\tthe\tdocker-compose- graphite.yml\tfile\tthat\twe\tcreated\tearlier\tto\tstart\tGraphite.\n\nHow\tto\tdo\tit...\n\nThe\tgeolocation\tapplication\tcurrently\texposes\ttwo\tmetrics\tusing\tthe\tCodahale MetricRegistry:\tgeolocationWriteRequestCount\tand geolocationLastWriteTime.\tThere\twere\ttwo\tmethods\twe\tused\tto\tview\tthese metrics:\tusing\tSpring's\t/metrics\tendpoint\tand\tusing\tthe\tConsoleReporter.\n\nIn\tthis\trecipe,\twe\twill\tbe\tusing\ta\tdifferent\ttype\tof\treport\tto\treport\tour\tmetrics\tto Graphite.\tCan\tyou\tguess\tthe\tname\tof\tthis\treporter?\tYes,\tyou\tgot\tit\tright.\tIt\tis GraphiteReporter:\n\n1.\t For\tthe\tfirst\tstep,\tlet's\tcomment\tout\tthe\tConsoleReporter\tas\twe\twill\tnot need\tit\tanymore.\tGoing\tforward,\tif\twe\twant\tto\tlook\tat\tour\tmetrics,\twe\tcan always\tuse\tthe\tGraphite\tweb\tinterface\tor\tthe\t/metrics\tendpoint.\tAfter\tyou have\tcommented\tout\tthe\tConsoleReporter,\tgo\tahead\tand\tadd\tthe\tbelow dependency\tto\tyour\tpom.xml\tfile:\t<dependency> <groupId>io.dropwizard.metrics</groupId>\t<artifactId>metrics- graphite</artifactId>\t</dependency>\n\n2.\t Perform\ta\tmaven\tupdate\ton\tthe\tproject\tto\tdownload\tthe\tnew\tdependency. Now\tadd\tthe\tfollowing\tsnippet\tto\tthe\tinit\tmethod\tright\tafter\tthe commented-out\tblock:\tGraphite\tgraphite\t=\tnew\tGraphite(new InetSocketAddress(\"192.168.99.100\",\t2003));\tGraphiteReporter graphiteReporter\t=\tGraphiteReporter.forRegistry(metricRegistry) .prefixedWith(\"com.packt.microservices.geolocation\") .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS) .filter(MetricFilter.ALL)\t.build(graphite);\tgraphiteReporter.start(60, TimeUnit.SECONDS);\n\n3.\t There\tare\tsix\tthings\tto\ttalk\tabout\there:\n\nFirstly,\tthe\tport\ton\twhich\twe\tare\tconnecting\tto\tGraphite.\tPort\tnumber 2003\tis\twhere\tthe\tCarbon\tplaintext\tlistener\tis\trunning.\tIf\tyou\twould like\tto\tuse\tthe\tPickle\tprotocol\tmode,\tyou\twill\tbe\tusing\tport\t2004.\n\nNote\n\nTo\tlearn\thow\tto\tuse\tPickle\tmode,\ttake\ta\tlook\tat\tthis\tpage: http://metrics.dropwizard.io/3.1.0/manual/graphite.\n\nThe\tprefixedWith()\tmethod\tsays\tthat\tany\tmetric\tcreated\ton\tthis\n\nMetricRegistry\tshould\tbe\tprefixed\twith\tthe\tlabel com.packt.microservices.geolocation.\tThis\tis\tmainly\tused\tto group\tour\tmetrics\ttogether. We\talready\tknow\twhat\tthe\tconvertRatesTo()\tand convertDurationsTo()\tmethods\tare\tused\tfor. The\tfilter()\tmethod\tis\tused\tto\tfilter\tany\tmetrics\tfrom\tbeing\treported to\tGraphite.\tIn\tour\tcase,\twe\twant\tall\tour\tmetrics\tto\treport\tto\tGraphite, so\twe\thave\tused\tMetricFilter.ALL,\twhich\tinstructs\tCodahale\tto export\tall\tmetrics.\n\nFinally,\tthe\tinteresting\tpart\tis\tour\tpublish\tinterval.\tWe\thave\tset\tthe\tpublish interval\tto\t60\tseconds.\tThe\treason\twe\tmoved\tfrom\t10\tseconds\tto\t60\tis\tthat\twhen you\tare\tbuilding\ta\tproduction-level\tapplication\tand\tyour\tapplication\tis\tscaled, you\twill\tend\tup\tcreating\ttons\tof\tmetrics\tduring\teach\tinterval.\tSetting\tit\tto\ta granularity\tof\t10\tseconds\tmight\tbe\ttoo\tmuch.\tThat\tis\tthe\treason\twe\tare\tgoing with\ta\thigher\tgranularity\tof\t60\tseconds.\tBut\tthis\tis\tcompletely\tleft\tto\tyou\tto choose.\tIt\talso\tdepends\ton\tthe\ttype\tof\tmetric\tyou\tare\treporting.\tIf\tyou\twould\tlike to\tgo\twith\ta\tdifferent\tinterval,\tfeel\tfree\tto\tdo\tso.\n\nNow,\tour\tapplication\tis\tcompletely\tready\tto\tstart\tpublishing\tmetrics\tover\tto Graphite.\tGo\tahead\tand\tstart\tthe\tapplication\tas\ta\tSpring\tBoot\tapplication.\tOnce your\tapplication\thas\tstarted,\tcreate\ttwo\tgeolocations\tusing\tthe\tfollowing\ttwo curl\tcommands\tand\ttry\tto\tget\tthem\tusing\tanother\tcurl\tcommand:\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\tcurl http://localhost:8080/geolocation\n\nAfter\texecuting\tthese\tthree\tCURL\tcommands,\twait\t60\tseconds.\tThe\treason\twe\n\nare\twaiting\t60\tseconds\tis\tbecause\twe\thave\tset\tthe\treporting\tinterval\tto\t60 seconds\tin\tour\tcode.\tSo\tby\tthen,\twe\tcan\texpect\tto\tsee\tsome\tmetrics\ton\tthe Graphite\tweb\tinterface.\n\nOpen\ta\tnew\tbrowser\ttab\tand\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tat\n\nhttp://192.168.99.100:8100.\tYou\tshould\tnow\tsee\ta\tnew\ttree\tgrouping\tfor\tour metrics\tat\tcom.packt.microservices.geolocation.\tThe\tfollowing\tscreenshot shows\thow\tthey\twould\tlook\tlike\tin\tGraphite's\tTree\tview:\n\nNow,\tthere\tare\ttwo\tways\tto\tlook\tat\tyour\tmetrics\tstored\tin\tGraphite.\tThe\tfirst approach\tis\tsomething\twe\tare\talready\tfamiliar\twith:\tthe\tGraphs\tinterface.\tThe Graphs\tinterface\tgives\tyou\ta\tgraph\twith\tall\tthe\tvalues\tplotted\ton\tthe\tgraph.\tBut this\tview\tmight\tnot\tbe\tvery\thelpful\tall\tthe\ttime.\n\nNow\tlet's\tlook\tat\tthe\tnext\tapproach.\tGraphite\thas\ta\tsophisticated\tREST\tAPI.\tIt\n\nhas\ttwo\tAPIs:\tMetrics\tand\tRender.\tThe\tMetrics\tAPI\tis\tused\tto\tsearch\tfor metrics.\tYou\tcan\tuse\tthis\tto\tperhaps\tbuild\ta\tmetrics\tdiscovery\tsystem.\tThe Render\tAPI,\thowever,\tis\twhat\twe\treally\tneed.\tAs\tthe\tname\tindicates,\tit\tis\tused\tto render\tmetric\tvalues\tin\tvarious\tformats,\tsuch\tas\tgraphs,\tCSV,\tJSON,\tPDF,\tand PNG.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tREST\tAPIs\tavailable\tin\tGraphite,\tvisit\ttheir documentation\tpage\tat\thttps://graphite-api.readthedocs.io/en/latest/api.html\t.\n\nNow\tlet's\tlook\tat\thow\tto\tuse\tthe\tRender\tAPI\tto\tquery\tour\tmetrics.\tThe\tRender\n\nAPI\trequires\ttwo\tquery\tparameters:\ttarget\tand\tformat.\tThe\ttarget\tparameter indicates\tthe\tpath\tat\twhich\tthe\tmetrics\tvalue\tcan\tbe\tlocated.\tThe\tformat parameter,\thowever,\ttells\twhich\tformat\tyou\twould\tlike\tyour\tmetric\tto\tbe displayed\tin.\tBy\tdefault,\tif\tyou\tdo\tnot\tprovide\tthe\tformat,\tit\trenders\tthe\tdata\tin PNG\tformat.\tBut\tthat's\tnot\twhat\twe\twant;\twe\twant\tto\tsee\tthe\tactual\tdata.\tFor that,\twe\tmight\twant\tto\tuse\tthe\tJSON\tformat.\n\nOpen\ta\tnew\tbrowser\ttab\tand\tpaste\tthis\tURL:\n\nhttp://192.168.99.100:8100/render? target=com.packt.microservices.geolocation.geolocationWriteRequestCount.count&format=json\n\nThe\tprevious\tURL\tsays\tthat\twe\tare\trendering\tthe\tmetric\tvalue\tat\n\ncom.packt.microservices.geolocation.geolocationWriteRequestCount.count and\tthe\tformat\tthat\twe\thave\trequested\tis\tJSON.\tSee\thow\twe\thave\tappended .count\tto\tthe\tmetric\tname.\tIf\tyou\twant\tto\tverify,\tlook\tat\thow\tthe\tmetric\tvalue\tis stored\tin\tGraphite\tfrom\tthe\ttree\tview\tof\tthe\tweb\tinterface.\tYou\twill\tsee\tthat\tthe leaf\tnode\tis\tcalled\tcount\tfor\tall\tmetrics\tof\tthe\tcounter\ttype.\tThis\tURL\twould have\tgiven\tyou\tsomething\tlike\tthis:\t[\t{\t\"target\": \"com.packt.microservices.geolocation.geolocationWriteRequestCount.count\", \"datapoints\":\t[\t[\tnull,\t1481917380\t],\t[\tnull,\t1481917440\t],\t.\t.\t[\t2,\t1482003720 ]\t]\t}\t]\n\nYou\twill\tnotice\tthat\tthere\tare\tseveral\tdata\tpoints.\tWe\tare\tparticularly\n\ninterested\tin\tthe\tmost\trecent\tdata\tpoint,\twhich\twill\tbe\tusually\tpopulated\tas\tthe last\tdata\tpoint.\tIf\tyou\tscroll\tall\tthe\tway\tdown\tin\tyour\tbrowser,\tyou\twill\tsee\tthat the\tlast\tdata\tpoint\tis\tpopulated\twith\tthe\tvalue\t2,\tindicating\tthat\twe\thave\treceived two\twrite\trequests\tfor\tthe\tgeolocation\tAPI\tso\tfar.\tThough\tit\tis\tdifficult\tto\twork with\tsuch\ta\thuge\tJSON\tfile,\tit\tis\tvery\tuseful\twhen\tyou\tare\tdebugging.\tIn\tfact, you\tcan\tuse\tthe\tfrom\tand\tuntil\tparameters\tto\tspecify\ta\ttime\trange\tto\tquery\tjust the\tdata\tpoints\tthat\twere\trecorded\tduring\tthat\ttime\trange.\n\nThe\tRender\tAPI\tis\tmuch\tmore\tsophisticated\twith\ta\tlot\tof\tquery\tparameters, such\tas\tbgColor\tand\tareaMode.\tTake\ta\tlook\tat\tGraphite's\tdocumentation\tto\tlearn more\tabout\tthe\tAPI\tbefore\tyou\tstart\tusing\tit.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tlearned\thow\tto\tuse\tGraphite\tto\tstore metrics\tand\talso\tlearned\tabout\tthe\tRender\tAPI\tthat\tGraphite\toffers\tto\tview metrics.\n\nExporting\tSpring\tBoot\tActuator metrics\tover\tto\tGraphite\n\nIn\tthe\tprevious\trecipe\twe\tlearned\thow\tto\texport\tthe\tmetrics\twe\tcreated\tusing Codahale\tover\tto\tGraphite.\tIn\tthis\trecipe,\twe\twill\tsee\thow\twe\tcan\texpose\tsome metrics\tSpring\tBoot\toffers.\tUnfortunately,\tat\tthis\tmoment,\tthe\tMetricRegistry does\tnot\texpose\tall\tthe\tmetrics\tthat\tSpring\tBoot\toffers.\tOnly\tfew\tof\tthem\tare created\tusing\tCodahale.\tIf\tyou\ttake\ta\tlook\tat\tthe\tmetrics\tthat\tare\tavailable\tin /metrics,\tmost\tof\tthem\tare\tJVM\trelated.\tSo\tin\tthis\trecipe,\twe\twill\tfind\tanother way\tto\texpose\tthe\tJVM\tmetrics\tvia\tCodahale.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tadding\ta\tMaven\tdependency\tand\tsome\tJava\tcode\tto\tthe geolocation\tproject.\tSo\topen\tup\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe\tgeolocation project.\tMake\tsure\tyour\tGraphite\tinstance\tis\tup\tand\trunning.\tIf\tnot,\tstart\tit\tusing the\tdocker-compose-graphite.yml\tfile\twe\tcreated.\n\nHow\tto\tdo\tit... 1.\t In\tthis\trecipe,\twe\tare\tgoing\tto\texpose\tsome\tJVM\tmetrics\tusing\tCodahale. This\twill\tbe\texported\tto\tGraphite\tautomatically\tas\twe\thave\tconfigured\tthe GraphiteReporter\tto\texpose\tmetrics\tevery\t60\tseconds.\tAdd\tthe\tfollowing Maven\tdependency\tto\tthe\tpom.xml\tfile:\n\n<dependency> \t\t<groupId>io.dropwizard.metrics</groupId> \t\t<artifactId>metrics-jvm</artifactId> \t\t<version>3.1.2</version> </dependency>\n\n2.\t Note\tthat\twe\thave\tadded\ta\tversion\tto\tthis\tdependency.\tThat\tis\tbecause\tthis is\tnot\tthe\tdefault\tin\tthe\tparent\tPOM,\tand\twe\twill\thave\tto\tuse\tour\town version\tin\tthe\tchild\tPOM.\tNow,\tadd\tthe\tfollowing\tsnippet\tas\tthe\tlast\tline\tof the\tinit()\tmethod\tin\tthe\tMetricSystem.java\tbean: metricRegistry.registerAll(new\tMetricSet()\t{ \t\t@Override \t\tpublic\tMap<String,\tMetric>\tgetMetrics()\t{\n\nMap<String,\tMetric>\tmetrics\t=\tnew\tHashMap<>(); \t\t\t\tmetrics.put(\"geolocationMemoryUsage\",\tnew MemoryUsageGaugeSet()); \t\t\t\tmetrics.put(\"geolocationClassLoading\",\tnew ClassLoadingGaugeSet()); \t\t\t\tmetrics.put(\"geolocationGarbageCollector\",\tnew GarbageCollectorMetricSet()); \t\t\t\treturn\tmetrics; \t\t} });\n\nThe\tprevious\tsnippet\tillustrates\thow\tyou\tcan\tregister\tmetric\tsets\tto\tthe MetricRegistry.\tAll\tthe\tthree\tsets-MemoryUsageGaugeSet, ClassLoadingGaugeSet\tand\tGarbageCollectorMetricSet\tcome\twith\tthe metrics-jvm\tdependency.\tThere\tare\talso\tother\tsets\tlike BufferPoolMericSet,\tCachedThreadStatesGaugeSet, ThreadStateGaugeSet\tand\tso\ton.\tYou\tcan\ttry\tthem\tout\tone\tby\tone\tas\tan exercise.\n\n3.\t Now\tlet's\ttest\tit\tout.\tStart\tthe\tapplication\tas\ta\tSpring\tBoot\tapplication,\topen a\tnew\tbrowser\ttab,\tand\tnavigate\tto\thttp://localhost:8080/metrics.\tThis\n\ntime,\tyou\tshould\tsee\ta\tbunch\tof\tJVM-related\tmetrics\tthat\tstart\twith\tthe keyword\tgeolocation.\tIf\tyou\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tafter 60\tseconds,\tyou\twill\tsee\tthose\tmetrics\tlisted\tunder\tthe\ttree.\n\nThe\tfollowing\tscreenshot\tillustrates\thow\tit\twill\tlook\tlike\tin\tthe\tTree\tview of\tthe\tGraphite\tweb\tinterface:\n\nAs\tyou\tcan\tsee,\twe\tnow\thave\tthree\tnew\tgroupings:\tgeolocationClassLoading, geolocationGargbageCollector,\tand\tgeolocationMemoryUsage.\tIt\tis recommended\tthat\tyou\ttake\tsome\ttime\tto\texplore\tthese\tthree\tmetric\tgroups\tand the\tkind\tof\tmetrics\tthey\texpose.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tlearned\thow\tto\tconfigure\tand\texpose JVM\tmetrics\tusing\tCodahale\tover\tto\tGraphite.\tIn\tthe\tnext\tfew\trecipes,\twe\twill learn\thow\tto\tuse\tthese\tmetrics\tto\tcreate\tvaluable\tgraphs\tusing\tGrafana.\n\nSetting\tup\tGrafana\tusing\tDocker\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tlearned\tthe\tbasics\tof\tmonitoring.\tWe\tlaid\tout\tthe foundation\tof\tour\tmonitoring\tsystem:\tour\tmetrics.\tWe\tlearned\thow\tto\tcreate metrics\tusing\tDropwizard's\tCodahale\tlibrary.\tWe\tthen\tspun\toff\ta\tbrand-new Graphite\tinstance.\tLater,\twe\texported\tthe\tmetrics\tthat\twe\tcreated\tover\tto Graphite.\tIn\tthe\trest\tof\tthe\trecipes\tof\tthis\tchapter,\twe\twill\tbe\tlearning\tmore about\ta\ttool\tcalled\tGrafana\tand\thow\tit\tcan\tbe\tused\tin\tmonitoring\tour microservices.\n\nGetting\tready\n\nInstead\tof\trunning\tGrafana\ton\tits\town\tusing\tthe\tdocker\trun\tcommand,\twe\twill be\tadding\tit\tto\tthe\tdocker-compose\tYAML\tfile\tthat\tholds\tGraphite.\tThe\treason we\tare\tdoing\tthis\tis\tbecause\tthey\tare\tclosely\trelated\tto\teach\tother\tthough\tthey need\tnot\tbe\tlinked.\tBefore\twe\tjump\tin,\tlet's\ttake\tsome\ttime\tto\tunderstand\twhat Grafana\tis.\tGrafana\tis\tan\topen\tsource\ttool\tfor\tmetrics\tvisualization.\tThe\tGrafana interface\tis\tsophisticated\tenough\tthat\tit\tbe\tused\tto\tcreate\tseveral\ttypes\tof\tgraphs. Very\trecently,\tGrafana\tcame\tup\twith\ttheir\tnotification\tsystem,\twhere\tyou\twill\tbe alerted\twhen\ta\tcertain\tmetric\texceeds\tits\tthreshold.\tThe\tbeauty\tof\tthis\tfeature\tis that\tit\tcan\talert\tyou\tnot\tjust\tby\te-mail\tbut\talso\ton\tSlack,\tPagerDuty,\tand webhooks.\tNow\tlet's\topen\tup\tthe\tSTS\tIDE.\n\nHow\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tsetup\tyour\tfirst\tGrafana\tinstance using\tDocker.\n\n1.\t Open\tup\tthe\tYAML\tfile\tthat\talready\thas\tGraphite:\tdocker-compose- graphite.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tit:\n\ngrafana: \t\t\t\timage:\tgrafana/grafana \t\t\t\tports: \t\t\t\t\t\t-\t\"3000:3000\"\n\nThat's\tall\tyou\tneed\tto\tstart\tGrafana.\tPort\t3000\tis\twhere\tthe\tGrafana\tweb interface\twill\tbe\trunning.\tWe\thave\tmapped\tthis\tport\tto\tport\t3000\tof\tthe\thost machine.\tAs\tyou\tcan\tsee,\tthere\tare\tno\tlinks\tto\tthe\tGraphite\tcontainer.\tThe only\treason\twe\tare\tkeeping\tthese\ttwo\tcontainers\ttogether\tis\tbecause\tthey are\tboth\tused\tto\tbuild\tour\tmonitoring\tsystem.\n\n2.\t Now\tlets\tstop\tGraphite\tif\tit\tis\talready\trunning.\tOpen\ta\tnew\tterminal session,\tand\tstart\tGrafana\tand\tGraphite\ttogether\tusing\tthe\tfollowing command: docker-compose\t-f\tdocker-compose-graphite.yml\tup\n\n3.\t The\tlog\tmessages\twill\tnot\tbe\tvery\thelpful\tto\tidentify\twhether\tGrafana\thas started\tor\tnot.\tHowever,\tyou\twill\tknow\tthat\tGrafana\thas\tstarted\twhen\tyour log\tmessages\tstop\ttailing.\tYou\twill\tsee\tsomething\tlike\tthis:\n\n4.\t Now\tthat\tyour\tGrafana\tand\tGraphite\tinstances\tare\tup\tand\trunning,\tlet's\n\nopen\tthe\tGrafana\tweb\tinterface.\tOpen\ta\tnew\tbrowser\tsession\tand\tenter\tthis URL\tto\topen\tGrafana:\thttp://192.168.99.100:3000.\n\n5.\t You\twill\tbe\ttaken\tto\tthe\tlogin\tpage.\tGrafana\thas\ta\tvery\tgood\tlogin mechanism.\tIt\teven\thas\tintegration\twith\tLDAP:\n\nBy\tdefault,\tthe\tusername\tand\tpassword\tare\tboth\tset\tto\tadmin.\n\n6.\t So\tenter\tthe\tcredentials\ton\tthe\tlogin\tpage\tand\thit\tLog\tin.\tOn\tthe\thome page,\tyou\twill\tsee\tthat\twe\tdo\tnot\thave\tany\tdashboards,\tapps,\tpanels,\tor\tdata sources\tcreated:\n\n7.\t The\ttop\tnavigation\tpane\tof\tGrafana\tis\tvery\tuseful.\tIt\thas\tpretty\tmuch\tall\tthe quick\taction\tbuttons\tyou\twill\tneed\twhile\tviewing\tyour\tdashboards:\n\n8.\t The\tfirst\tbutton,\twhich\thas\tthe\tGrafana\ticon,\tis\tthe\tmain\tmenu.\tClicking\ton that\twill\topen\tlinks\tto\tpretty\tmuch\tall\tthe\toptions\tand\tconfigurations.\n\nThe\tHome\tbutton\tacts\tas\ta\tquick-action\tbar\tto\tnavigate\tto\tall\tthe Dashboards\tyou\thave\tin\tthis\tinstance\tof\tGrafana.\n\n9.\t The\tnext\tuseful\tsection\tin\tthe\ttop\tnavigation\tbar\tis\tthe\tRefresh\tRange section.\tClicking\ton\tthe\tdefault\trefresh\trange,\tLast\t6\thours,\twill\topen\ta section\twhere\tyou\tcan\tconfigure\tthe\ttime\trange\tas\twell\tas\tthe\trefresh interval.\tThis\tis\ta\tvery\tsophisticated\tsection.\n\nThat's\tpretty\tmuch\ta\tvery\thigh-level\toverview\tof\tthe\tGrafana\tinterface.\tThere are\tstill\tlots\tof\tfeatures\tthat\tGrafana\toffers.\tWe\twill\tlook\tat\tthem\tin\tlater\trecipes. With\tthat,\twe've\tcome\tto\tthe\tend\tof\tthis\trecipe.\n\nConfiguring\tGrafana\tto\tuse\tGraphite\n\nWe\tnow\thave\ta\tworking\tversion\tof\tGraphite\tand\tGrafana\tconfigured\tusing\tthe docker-compose\tYAML\tfile.\tIn\tthis\trecipe,\twe\twill\tbe\tconfiguring\tGrafana\tto use\tthe\tGraphite\tinstance\twe\tare\tusing\tto\texport\tour\tgeolocation\tmetrics\tto. When\twe\thave\tconfigured\tGrafana\tto\tuse\tthe\tGraphite\tinstance,\twe\twill\tsoon\tbe able\tto\tutilize\tthe\tgeolocation\tmetrics\tto\tcreate\tdashboards\ton\tGrafana.\n\nGetting\tready\n\nBefore\twe\tjump\tinto\tthe\trecipe,\tlet's\tunderstand\ta\tfew\tconcepts\tand terminologies\tused\tin\tGrafana.\tYou\twill\tneed\tto\tunderstand\tfour\tentities:\n\nData\tsources:\tData\tsources\tare\tentities\tthat\thold\tthe\tdata\trequired\tto\tplot your\tgraphs. Panels:\tPanels\tare\tindividual\tvisualizations\tthat\twill\tconnect\tto\ta\tdata source,\tquery\ta\tcertain\tdata\tset,\tand\tplot\tthem\ton\ta\tgraph,\ttable,\tsingle panel\tstat,\tor\ttext. Rows:\tRows\tare\tgroup\tof\tpanels\tthat\tconstitute\ta\trow\ton\tthe\tdashboard. Dashboards:\tOf\tcourse,\twe\tall\tknow\twhat\ta\tdashboard\tis.\tThe\tdashboard comprises\tseveral\trows\tof\tpanels.\n\nHow\tto\tdo\tit...\n\nNow\tguess\twhat\twe\tneed\tto\tcreate\tin\torder\tto\tconfigure\tGrafana\tto\tuse\tthe Graphite\tinstance\tthat\twe\thave.\tYes,\tyou\tare\tright;\twe\thave\tto\tcreate\ta\tdata source.\tBefore\tthat,\tmake\tsure\tyou\thave\tboth\tGrafana\tand\tGraphite\trunning.\tIf they're\tnot,\tstart\tthem\tusing\tthe\tdocker-compose\tYAML\tfile:\n\n1.\t Let's\tstart\tby\tclicking\ton\tthe\tmain\tmenu\tbutton\tat\tthe\ttop\tleft\tof\tthe\tGrafana page.\tThen,\tchoose\tData\tSources\tfrom\tthe\tdropdown.\tOn\tthe\tnext\tscreen, click\ton\tthe\tAdd\tdata\tsource\tbutton\tand\tenter\tthe\tfollowing\tvalues\tin\tthe form: Name:\tgraphite Default:\tTrue\t(checked) Type:\tGraphite Url:\thttp://192.168.99.100:8100 Access:\tdirect\n\nMake\tsure\tneither\tthe\tBasic\tAuth\tnor\tthe\tWith\tCredentials\tcheckbox\tis\n\nchecked:\n\nAfter\tentering\tthe\tprevious\tvalues\tin\tthe\tform,\thit\tthe\tAdd\tbutton.\tRight\tafter\n\nyou\thit\tAdd,\tGrafana\twill\ttry\tto\tping\tGraphite\twith\tthe\tconnection\tparameters that\twe\tprovided\there.\tIf\tyour\tconnection\tis\tsuccessful,\tyou\twill\treceive\ta success\tmessage\ton\tthe\tsame\tscreen:\n\nIf\tfor\tsome\treason\tGrafana\tis\tnot\table\tto\tconnect\tto\tGraphite,\tyou\twill\treceive\tan\n\nIf\tfor\tsome\treason\tGrafana\tis\tnot\table\tto\tconnect\tto\tGraphite,\tyou\twill\treceive\tan error\tmessage\twith\tdetails.\tMost\tof\tthe\ttimes,\tthe\terror\tcould\teither\tbe\tthat Graphite\tis\tnot\trunning\tor\tyou\thave\tnot\tmapped\tthe\tGraphite\tports,\tor\tthat\tyou are\tbehind\ta\tproxy.\tMake\tsure\tyou've\tset\tup\teverything\tright\tand\ttry\tagain.\n\nNow\tgo\tback\tto\tthe\tData\tSources\tpage,\tand\tyou\tshould\tsee\tthe\tnewly\tcreated\n\nGraphite\tdata\tsource:\n\nHere,\tyou\twill\thave\ttwo\ttypes\tof\tviews:\tthe\tgrid\tview\tand\tthe\tlist\tview.\tIn older\tversions\tof\tGrafana,\tthe\tgrid\tview\tis\tthe\tdefault\tfor\tsome\treason.\tHowever, the\tlist\tview\tis\ta\tbetter\tview\tas\tit\tshows\tthe\tcomplete\tURL.\tThe\tlist\tview\tlooks something\tlike\tthis:\n\nThis\tclarifies\tthat\tour\tdata\tsource\twas\tadded\tsuccessfully;\tin\tother\twords, Grafana\thas\tbeen\tconfigured\tto\tuse\tour\tGraphite\tinstance.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\tsimple\trecipe.\n\nConfiguring\tGrafana\tdashboards\tto view\tmetrics\n\nSo\tfar,\twe've\tlearned\thow\tto\tuse\tGraphite\tand\tGrafana.\tIn\tthis\trecipe,\twe\twill learn\thow\tto\tcreate\tdashboards\tand\tpanels\tusing\tGrafana.\tIdeally,\tGrafana dashboards\twill\tbe\tdisplayed\ton\ta\tbig\tscreen\tin\ta\tspace\twhere\tdevelopers\t(or concerned\tpeople)\tcan\tsee\tthem\tso\tthat\tany\todd\tbehavior\tin\tthe\tgraphs\twill\tbe clearly\tvisible\tto\tthe\tdevelopers.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tutilizing\ttwo\tmetrics\tfrom\tthe\tgeolocation\tJVM\tand the\ttwo\tmetrics\tthat\twe\tcreated\tusing\tCodahale.\tThese\tfour\tmetrics\twill\tbe plotted\ton\tgraphs\tin\tthe\tdashboard.\n\n1.\t First,\tmake\tsure\tGraphite\tand\tGrafana\tare\tup\tand\trunning.\tIf\tthey're\tnot, start\tthem\tusing\tthe\tdocker-compose\tYAML\tfile.\n\n2.\t Next,\tmake\tsure\tyour\tgeolocation\tapplication\tis\tup\tand\trunning.\tIf\tit's\tnot, start\tit\tfrom\tyour\tSTS\tIDE\tas\ta\tSpring\tBoot\tapplication.\n\nHow\tto\tdo\tit... 1.\t In\torder\tto\tgenerate\tsome\tmetrics,\texecute\tthe\tfollowing\tcurl\tcommands\tto create\ttwo\tgeolocations:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X POST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6- beb8-9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8080/geolocation\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\tcurl http://localhost:8080/geolocation\n\n2.\t Now,\tin\torder\tto\tgenerate\tsome\tmetrics,\tlet\tthe\tgeolocation\tmicroservice, Graphite,\tand\tGrafana\trun\tfor\ta\tfew\tminutes.\tThe\treason\twe\tare\tdoing\tthis is\tto\tpublish\tsome\tmetrics\tto\tGraphite.\tAfter,\tsay,\t15\tminutes,\tgo\tto\ta\tnew browser\tsession\tand\tnavigate\tto\tthe\tGrafana\tURL\tat http://192.168.99.100:3000.\n\n3.\t In\tGrafana,\tchange\tthe\trefresh\twindow\tfrom\t6\thours\tto\t15\tminutes.\tClick on\tHome\tand\tthen\tselect\tthe\tCreate\tNew\tbutton.\tIn\tthe\tnext\tsection,\tyou will\tsee\tan\tempty\trow\twith\tsome\tpanel\toptions,\tsuch\tas\tGraphs, Singlestat,\tTable,\tText,\tAlert\tList,\tDashboard\tlist,\tand\tPlugin\tlist:\n\nBefore\twe\tadd\tany\tnew\tpanels,\tlet's\tfirst\tname\tour\tdashboard.\tClick\ton\tthe\n\ngear\tbutton\tin\tthe\ttop\tnavigation\tpane\tand\tselect\tSettings.\tIn\tthe\tSettings section,\tenter\tthe\tvalue\tof\tName\tas\tGeolocation\tMicroservice,\tand\tclick\ton the\tSave\tbutton\tin\tthe\ttop\tnavigation\tbar.\n\nNow\tselect\tGraph\tfrom\tthe\tchoice\tof\tpanels.\tIf\tyour\trow\twas\talready created,\thover\tover\tthe\tthree\tdots\ton\tthe\tleft\tside\tof\tthe\trow\tand\tselect\tAdd\n\nPanel\tand\tthen\tchoose\tGraph.\tYou\twill\tsee\tan\tempty\tgraph\twith\tno\tdata.\tIn order\tto\tedit\tthis\tgraph,\tclick\ton\tthe\tgraph\tname\tPanel\tTitle\tand\tselect\tEdit. In\tthe\tEdit\tpane,\tnavigate\tto\tthe\tMetrics\ttab.\tThen,\tselect\tthe\tmetric\tvalue com.packt.microservices.geolocation.geolocationMemoryUsage.heap.used After\tyou\thave\tselected\tthe\tmetric,\tyou\twill\tsee\tthat\tthe\tgraph\tis\tplotted\twith some\tmetrics.\tNow\tlet's\tduplicate\tthis\tmetric\tand\tadd\tanother\tmetric\tto\tthe\tsame graph.\tClick\ton\tthe\thamburger\tmenu\tbutton\tand\tselect\tDuplicate:\n\nThis\ttime,\tuse\tthe\tmetric\n\ncom.packt.microservice.geolocation.geolocationMemoryUsage.heap.commited Once\tyou\thave\tadded\tboth\tthe\tmetrics,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tlines,\tone for\teach\tmetric:\n\nWe\tnow\thave\tto\tchange\tthe\tunit\tof\tour\tLeft\tY\taxis\tto\tbytes.\tGo\tto\tthe\tAxes\ttab\n\nand\tselect\tdata\t(Metric)\t/\tbytes\tas\tthe\tUnit:\n\nBefore\tyou\tsave\tthis\tpanel,\tlet's\tgive\tit\ta\tnice\theader.\tGo\tto\tthe\tGeneral section\tand\tchange\tthe\tTitle\tto\tJVM\tHeap.\tIn\torder\tto\tsave\tthis\tpanel,\thit\tthe small\tx\tin\tthe\ttop-right\tsection\tof\tthis\tpane:\n\nNow\tlet's\tcreate\tpanels\tfor\tthe\tother\ttwo\tmetrics,\tgeolocationLastWriteTime\n\nand\tgeolocationWriteRequestCount.\tHow\tabout\tcreating\ta\tnew\trow\tfor\tthese two\tpanels?\tClick\ton\tthe\tAdd\tRow\tbutton\tat\tthe\tbottom\tof\tthe\texisting\trow. Now\tadd\ta\tnew\tgraph\tand\tconfigure\tit\twith\tthe\tname geolocationWriteRequestCount\tand\tmetric com.microservices.geolocation.geolocationWriteRequestCount.count. Let's\tadd\ta\tnew\tpanel\tfor\tgeolocationLastWriteTime.\tHover\tover\tthe\tthree\tdots on\tthe\tleft-hand\tside\tof\tthis\tpanel\tand\tchoose\tAdd\tPanel:\n\nConfigure\tthe\tsecond\tpanel\tin\tthis\trow\twith\tthe\tname\n\ngeolocationLastWriteTime\tand\tmetric\tvalue com.microservices.geolocation.geolocationLastWriteTime.\tMake\tsure\tyou change\tthe\tunit\tfor\tthe\tLeft\tY\taxis\tto\tnone/none.\tAfter\tyou\thave\tconfigured\tboth the\tpanels,\tclose\tthe\tconfiguration\tpane\tby\thitting\tthe\tx\tbutton.\n\nFinally,\tsave\tthe\tdashboard\tby\thitting\tthe\tSave\tbutton\tfrom\tthe\ttop\tnavigation\n\nbar.\tYour\tfinal\tdashboard\twill\tlook\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tI\thave\tadded\tsome\ttitles\tto\tthe\tpanels\tin\tthe\tsecond\trow.\tThat's it!\tWe\tnow\thave\tour\tfirst\tmonitoring\tplatform\tfor\tour\tmicroservice.\tThe previous\tillustration\tmight\tbe\tpretty\tsimple,\tbut\tthe\tcapabilities\tof\tGrafana\tand Graphite\tare\tawesome\tif\twe\tuse\tit\tin\tthe\tright\tway.\tWe\tdid\tnot\tgo\tin\tdetail\tinto\n\nGraphite\tare\tawesome\tif\twe\tuse\tit\tin\tthe\tright\tway.\tWe\tdid\tnot\tgo\tin\tdetail\tinto either\tGraphite\tor\tGrafana.\tBut\tI'll\tleave\tthat\tto\tyou\tas\tan\texercise\tas\tour\tgoal was\tprimarily\tto\tdemonstrate\tthe\tabilities\tof\tthese\ttools.\tGrafana\tin\tfact\tgets more\tinteresting\twith\tthe\tuse\tof\talerts.\tI\tstrongly\trecommend\tyou\ttry\tthem before\tyou\tstart\tusing\tit\tin\tyour\tproduction\tenvironment.\tGood\tluck\tmonitoring!\n\nChapter\t7.\tBuilding\tAsynchronous Streaming\tSystems\twith\tKafka\tand Spark\n\nIn\tthis\tchapter,\tyou\twill\tlearn\tthe\tfollowing\trecipes:\n\nSetting\tup\tKafka\tusing\tDocker Creating\tKafka\ttopics\tto\tstream\tdata Writing\ta\tstreaming\tprogram\tusing\tKafka\tStreams Improving\tthe\tperformance\tof\tthe\tKafka\tStreams\tprogram Writing\ta\tstreaming\tprogram\tusing\tApache\tSpark Improving\tthe\tperformance\tof\tthe\tSpark\tjob Aggregating\tlogs\tinto\tKafka\tusing\tLog4J Integrating\tKafka\twith\tlog\tmanagement\tsystems",
      "page_number": 369
    },
    {
      "number": 7,
      "title": "Building\tAsynchronous Streaming\tSystems\twith\tKafka\tand Spark",
      "start_page": 434,
      "end_page": 487,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nStreaming\thas\tbeen\tpicking\tup\ttraction\tlately.\tIt\tis\tone\tway\tof\tprocessing\tyour data.\tIn\tfact,\tthere\tare\ttwo\tmodes\tin\twhich\tyour\tdata\tprocessing\tapplication\tcan operate:\tbatching\tand\tstreaming.\tIn\tbatching,\tyou\twork\ton\tbatches\tof\tdatasets\tat frequent\tintervals.\tHowever,\tin\tstreaming,\tyou\tprocess\tdata\tas\tit\tgets\tstreamed. This\tmode\thas\talways\tbeen\ta\tchallenge.\tAchieving\tthis\ttype\tof\tstreaming behavior\twill\topen\tup\ta\tlot\tof\tdifferent\topportunities.\n\nYou\tcould\tmake\tthings\thappen\tquickly.\tFor\texample,\ta\tbanking\tapplication\tcan send\tyou\trelevant\tcoupons\tbased\ton\tyour\tspending\tactivity.\tOr\ta\tshopping application\tcan\trecommend\tproducts\tbased\ton\tyour\tviewing\tactivity.\tAnd\tall\tthis will\thappen\tright\taway\tinstead\tof\twaiting\tuntil\tthe\tmiddle\tof\tthe\tnight\tfor\ta batch\tjob\tto\trun.\tStreaming\thas\tbecome\ta\tcritical\tpart\tof\tmany\tbusinesses\tthese days.\tThe\tpast\tcouple\tof\tyears\thave\tseen\ta\ttremendous\timprovement\tin streaming\ttechnologies.\tFrameworks\tsuch\tas\tApex,\tStorm,\tSpark,\tFlink,\tKafka Streams,\tand\tSamza,\tto\tname\ta\tfew,\tare\tsome\tpopular\tstreaming\tframeworks being\tused\ta\tlot\tthese\tdays.\tA\tstreaming\tframework\twill\tmake\tsense\tonly\twhen you\thave\ta\tsupporting\tmessaging\tsystem.\tKafka,\tRabbitMQ,\tand\tZero\tMQ,\tto name\ta\tfew,\tare\texamples\tof\tpopular\tmessaging\tsystems.\tIn\tthis\tchapter,\twe\twill focus\tmore\ton\tSpark\tand\tKafka.\n\nSetting\tup\tKafka\tusing\tDocker\n\nIn\torder\tto\tdemonstrate\tstreaming,\twe\tfirst\trequire\ta\tstreaming\tendpoint.\tA streaming\tendpoint\tcould\tbe\ta\tTCP\tsocket,\tmessaging\tdestination,\tand\tso\ton.\tIn this\tchapter,\twe\twill\tuse\tKafka\theavily\tto\tdemonstrate\tits\tstreaming\tabilities.\tIn this\trecipe,\twe\twill\tlearn\thow\tto\tset\tup\tKafka\tusing\tDocker\tCompose.\tBefore\twe jump\tinto\tthe\trecipe\tand\tstart\torchestrating\ta\tKafka\tinstance,\tlet's\tfirst\ttake\tsome time\tto\tunderstand\thow\tKafka\tworks.\n\nKafka\n\nAccording\tto\tKafka's\tdocumentation,\tit\tis\ta\tdistributed\tstreaming\tplatform.\tIt\tis distributed\tbecause\tit\thas\tclustering\tabilities\tand\tis\tfault\ttolerant.\tAchieving\tfault tolerance\tis\tnot\tvery\teasy.\tBut\tKafka's\tarchitecture\tmakes\tit\tfault\ttolerant\tand,\tat the\tsame\ttime,\tsimple\tto\twork\twith\tand\tunderstand.\tSimplicity\tis\tone\tof\tthe reasons\tKafka\tis\tbeing\tadopted\tby\tlot\tof\torganizations.\tAt\tthe\tsame\ttime,\tit\tis very\tpowerful.\tIt\tcan\thandle\ta\thuge\tamount\tof\tdata\tat\tonce.\tKafka\tutilizes Zookeeper\tfor\tmost\tof\tits\tclustering\tmechanism.\tIt\tis\ta\tstreaming\tplatform because\tit\thas\tthe\tability\tto\twork\ton\tstreams\tof\tdatasets\tas\tthey\tcome\tthrough the\tdestinations.\n\nIn\tthe\tsimplest\tterms,\tKafka\tis\ta\tpowerful\tpub-sub\tmessaging\tsystem.\tIf\tyou come\tfrom\ta\tJava\tbackground\tand\thave\texperience\tworking\twith\tJMS\t(Java Message\tService),\tthen\tyou\tmight\thave\talready\tguessed\twhat\tKafka\tcould\tbe.\n\nThere\tare\ttwo\ttypes\tof\tcommunication\tmechanisms\tpossible\tin\tany\tmessaging system:\n\nPoint-to-point Pub-sub\n\nPoint-to-point\tmechanism\n\nPoint-to-point\tis\twhere\ta\tmessage\tproducer\tsends\tmessages\tto\ta\tqueue,\twhich\tis then\tpicked\tup\tby\ta\tmessage\tconsumer.\tThere\tcan\tbe\tany\tnumber\tof\tmessage consumers\tlistening\ton\tthe\tqueue;\thowever,\tonly\tone\tconsumer\tcan\tconsume each\tmessage.\n\nPub-sub\tmechanism\n\nIn\ta\tpub-sub\tmechanism,\tproducers\tpublish\tmessages\tto\ta\ttopic,\twhich\tis\tthen broadcasted\tto\tall\tthe\tconsumers\tsubscribed\tto\tthe\ttopic.\tSo\teach\tconsumer\tin\ta pub-sub\tmechanism\twill\treceive\tone\tcopy\tof\tall\tthe\tmessages.\tKafka\toffers\tboth of\tthese\tmodes\twith\tthe\thelp\tof\ttopics.\n\nKafka\tterminology\n\nThere\tare\tfive\tterminologies\tyou\thave\tto\tknow\tbefore\tyou\tstart\tworking\twith Kafka:\n\nBrokers Topics Partitions Producers Consumers\n\nBrokers\n\nBrokers\tare\tnothing\tbut\tKafka\tservers\tthat\twill\thost\tyour\ttopics\tand\tlogs\tinside your\ttopics.\n\nTopics\n\nTopics\tare\tdestinations\tthat\tare\tused\tin\tKafka.\tEach\ttopic\tis\tpartitioned\tinto multiple\tordered\tpartitions\tof\tmessages.\n\nPartitions\n\nPartitions\tdifferentiate\tKafka\tfrom\tother\tmessaging\tsystems.\tAnd\tthey\tmake the\tworking\tof\tKafka\tmuch\tmore\tefficient\tand\tfaster.\n\nProducers\tand\tconsumers\n\nProducers\tproduce\tmessages\tin\ttopics\twhereas\tconsumers\tconsume\tmessages from\ttopics.\n\nThe\tfollowing\tdiagram\tprovides\ta\thigh-level\tidea\tof\thow\tKafka\tworks:\n\nIn\tthe\tpreceding\tdiagram,\tyou\tcan\tsee\tthat\tthere\tare\ttwo\tbrokers\tin\ta\tcluster. There\tis\tone\ttopic\tcalled\tTopic\t1\ton\tboth\tthe\tbrokers\tin\tthe\tcluster.\tThe\ttopic has\ttwo\tpartitions.\tIdeally,\teach\tbroker\twill\ttake\townership\tof\tone\tpartition,\tand the\tother\tbroker\twill\thave\ta\treplica\tof\tthat\tpartition.\tFor\texample,\tif\tBroker\t1 owns\tPartition\t0\tin\tTopic\t1,\tthen\tthere\twill\tbe\ta\treplica\tof\tPartition\t0\tin Broker\t2\tas\twell.\tIn\tother\twords,\tBroker\t1\tis\tthe\tleader\tfor\tPartition\t0\tof Topic\t1.\tI\thope\tyou\tare\table\tto\tgrasp\tthe\tbasics\tof\tKafka.\tWe\twill\tlearn\tsome advanced\tconcepts\tabout\tKafka\tlater\tin\tthis\tchapter,\tbut\tfor\tnow,\tthis\tshould give\tyou\ta\tgood\thead\tstart.\n\nGetting\tready\n\nKafka\trequires\tZookeeper\tin\torder\tto\toperate.\tIt\tuses\tZookeeper\tmainly\tfor electing\ta\tcontroller,\tstoring\tconfigurations\tof\ttopics,\tstoring\tmember information\tof\tthe\tcluster,\tand\tso\ton.\tAt\tthe\ttime\tof\twriting\tthis,\tit\tis\tnot\tpossible to\trun\tKafka\twithout\tZookeeper.\tSo,\tobviously,\twe\twill\tneed\ttwo\tcontainers: Kafka\tand\tZookeeper.\tGo\tahead\tand\topen\tup\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe geolocation\tproject.\n\nHow\tto\tdo\tit...\n\nWe\twill\tuse\tDocker\tCompose\tto\torchestrate\tKafka.\tGo\tahead\tand\tcreate\ta\tnew YML\tfile\tcalled\tdocker-compose-kafka.yml\tdirectly\tunder\tthe\tgeolocation project.\tThen,\tadd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tDocker\tCompose file:\n\nversion:\t\"2\"\n\nservices:\t \t\tzookeeper:\t \t\t\t\timage:\twurstmeister/zookeeper\t \t\t\t\tports:\t \t\t\t\t\t\t-\t\"2181:2181\"\n\nkafka:\t \t\t\t\timage:\twurstmeister/kafka:0.10.1.0-1\t \t\t\t\tports:\t \t\t\t\t\t\t-\t\"9092:9092\"\t \t\t\t\tenvironment:\t \t\t\t\t\t\tKAFKA_ADVERTISED_HOST_NAME:\t192.168.99.100\t \t\t\t\t\t\tKAFKA_ZOOKEEPER_CONNECT:\tzookeeper:2181\t \t\t\t\tvolumes:\t \t\t\t\t\t\t-\tvarrun/docker.sock:varrun/docker.sock\n\nAs\tyou\tcan\tsee,\twe\thave\tnot\tused\tany\tofficial\timages.\tAt\tthe\ttime\tof\twriting this,\tthere\tis\tno\tofficial\timage\tfor\tKafka.\tHowever,\tthere\tare\tKafka\timages\tlisted under\tthe\tConfluent\torganization\tin\tDocker\tHub.\tConfluent\tis\tthe\tcompany behind\tKafka\tand\tthe\tConfluent\tplatform.\tIt\twas\tbuilt\tby\ta\tfew\tof\tthe\tearly committers\tof\tKafka\tback\tfrom\tLinkedIn.\tThe\tcompany\tis\tprimarily\tfocused\ton providing\tstreaming\tsolutions\tand\tproducts\tto\tbuild\tdata\tpipelines\tand\tplatforms.\n\nPort\t2181\tof\tZookeeper\thas\tbeen\tmapped\tto\tthe\tsame\tport\ton\tthe\thost.\tSimilarly, port\t9092\tof\tKafka\thas\tbeen\tmapped\tto\tthe\tsame\tport\ton\tthe\thost.\tPort\t9092\tis where\tKafka\twill\tbe\tlistening.\n\nThere\tare\ttwo\trequired\tenvironment\tvariables:\tKAFKA_ADVERTISED_HOST_NAME and\tKAFKA_ZOOKEEPER_CONNECT.\tThe\tKAFKA_ADVERTISED_HOST_NAME\tproperty defines\tthe\thostname\tto\twhich\tKafka\twill\tbind\tto.\tThe KAFKA_ZOOKEEPER_CONNECT\tproperty\tis\trequired\tto\tspecify\tthe\tURL\tto Zookeeper.\tAs\tboth\tthe\timages\tare\tin\tthe\tsame\tDocker\tCompose\tYML\tfile,\twe\n\nhave\treferenced\tthe\thostname\tof\tZookeeper\tas\tzookeeper\titself,\twhich\thappens to\tbe\tthe\tname\tof\tthe\tZookeeper\tservice.\n\nYou\tmight\tbe\twondering\twhy\twe\thave\texposed\tthe\tDocker\tsocket\tfile\tas\ta volume.\tThe\tDocker\timage\tthat\twe\tare\tusing\tneeds\tto\trun\tsome\tDocker commands\tfrom\tinside\tthe\tcontainer.\tSo\tit\tneeds\tthe\tDocker\tdaemon.\tOnce\tyou get\ta\thold\tof\tthe\tsocket\tfile,\tyou\tcan\trun\tany\toperation\tyou\twant.\tThough\tthis doesn't\tsound\tvery\tsecure,\tit\tis\tstill\tokay\tas\tit\tis\tonly\tour\tlocal\tdevelopment environment.\n\n1.\t Now\tlet's\tspin\toff\tour\tfirst\tKafka\tbroker\tusing\tDocker\tCompose.\tOpen\tup\ta new\tterminal\tsession\tand\trun\tthe\tfollowing\tdocker-compose\tcommand:\n\ndocker-compose\t-f\tdocker-compose-kafka.yml\tup\n\n2.\t You\tshould\tsee\tsomething\tlike\tthis\twhen\tKafka\thas\tstarted:\n\n3.\t Now\tthat\tour\tKafka\tbroker\tis\tup\tand\trunning,\tthe\tnext\tstep\tis\tto\tverify whether\tit\tstarted\tsuccessfully.\tIt\twould\tbe\tgreat\tif\tKafka\thad\ta\tUI\tadmin interface.\tCurrently,\tthere\tare\ta\tfew\tthird-party\tapps\tthat\tcan\tbe\tused\twith Kafka,\tsuch\tas\tKafka\tManager\tand\tKafka\tUI.\tFor\tthis\tchapter,\twe\twill\tnot need\tone.\tSo\tif\tyou\tare\tinterested\tin\thaving\tone,\tfeel\tfree\tto\ttry\tthem\tout and\tsee\twhich\tone\tfits\tyour\tneeds.\tThroughout\tthis\tchapter,\twe\twill\tneed\ta client\tthat\tcan\tbe\tused\tto\tperform\toperations\tsuch\tas\tcreating\ttopics, consuming\tmessages,\tand\tproducing\tmessages.\tWe\twill\tbe\tmaking\tuse\tof\n\nsome\tof\tthe\tshell\tscripts\tthat\tcome\twith\tthe\tKafka\tinstallation\tfor\tthat. 4.\t So\tdownload\tversion\t2-11-0.10.1.0\tfrom\tthe\tApache\tKafka\twebsite\tat\n\nhttps://kafka.apache.org/downloads\t.\tThe\tversion\tnumber\tis\tsplit\tinto\ttwo parts.\t2-11\tindicates\tthe\tversion\tof\tScala\tthat\twas\tused\tto\tbuild\tthis\tversion of\tKafka.\t0.10.1.0\tis\tthe\tactual\tversion\tof\tKafka.\n\n5.\t After\tyour\tdownload\tis\tcomplete,\tunpack\tKafka\tto\tany\tdirectory\tin\tyour computer.\tOpen\ta\tnew\tterminal\tsession\tand\tchange\tthe\tdirectory\tto\tthe Kafka\tdirectory.\tNow\texecute\tthe\tfollowing\tcommand\t(Windows\tusers,\tuse the\tbinary\tequivalent\tfor\tWindows): ./bin/kafka-topics.sh\t--list\t--zookeeper\t192.168.99.100:2181\n\n6.\t The\tpreceding\tcommand\tis\tused\tto\tlist\tall\tthe\ttopics\tavailable\tin\tyour broker.\tLook\thow\twe\thave\tpassed\tthe\tZookeeper\tURL\tinstead\tof\tKafka's. That\tis\tbecause\tthe\tbroker\tis\tlocated\tusing\tZookeeper.\tIf\tthe\tcommand returned\tany\terrors,\tthen\tyou\tdidn't\tinstall\tKafka\tcorrectly,\tor\tyou\tdon't have\tthe\tright\tZookeeper\tURL.\tMost\tof\tthe\ttime,\tit\tis\tsomething\tto\tdo\twith the\thostname\tand\tIP\tof\tZookeeper.\tIf\tyour\tinstallation\twas\tsuccessful,\tyou will\tnot\tget\tany\toutput\tfor\tthis\tcommand,\tas\twe\tdo\tnot\thave\tany\ttopic\tin this\tbroker.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tput Kafka\tinto\taction.\tGo\tKafka!\n\nCreating\tKafka\ttopics\tto\tstream\tdata\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\tour\tKafka\tbroker.\tThe\tnext\tstep\tis obviously\tputting\tKafka\tto\taction.\tIn\torder\tto\tdo\tthat,\twe\tneed\tsome\ttopics\tto work\twith.\tIn\tthis\trecipe,\twe\twill\tcreate\tsome\ttopics\tand\twill\talso\tlearn\thow\tto produce\tand\tconsume\tmessages.\tExchanging\tmessages\tcan\tbe\tdone\tin\ttwo\tways: scripts\tand\tJava\tprograms.\tWe\twill\tbe\tlearning\tthe\tJava\tway.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tsame\tKafka\ttopics\tscript\tto\tcreate\ttopics:\n\n1.\t Open\ta\tnew\tterminal\tshell\tand\tnavigate\tto\tthe\tdirectory\twhere\tyou\thave Kafka\tinstalled.\n\n2.\t Let's\tcreate\ta\tnew\ttopic\tcalled\tgeolocations.\tWe\twill\tthen\twrite\ta\tbasic standalone\tproducer\tprogram\tthat\twill\tproduce\tgeolocations\tfor\tthis\ttopic. We\twill\tintegrate\ta\tconsumer\twith\tour\tgeolocation\tapplication\tthat\twill consume\tall\tmessages\tproduced\tby\tour\tstandalone\tproducer.\n\n3.\t So\tnow,\tour\tgeolocation\tapplication\twill\thave\ttwo\tmodes\tin\twhich\tyou\tcan store\tgeolocations:\tsynchronous\tHTTP\tmode\tand\tasynchronous\tmode\tusing Kafka.\tIt\tis\tstill\tpossible\tto\tmake\tyour\tHTTP\tAPIs\twork\tasynchronous.\n\n4.\t We\twill\tnot\tbe\tgoing\tin\tdepth\tinto\tthat\ttopic.\tFor\tillustration,\twe\twill consider\tour\tHTTP\tendpoint\tto\tbe\tsynchronous\tand\tour\tKafka\tendpoint\tto be,\tobviously,\tasynchronous.\n\n5.\t Before\twe\tjump\tinto\tthe\tactual\trecipe,\tlet's\tcomment\tout\tsome\tunused\tcode from\tthe\tgeolocation\tapplication.\tFrom\tthe\tprevious\tchapter,\tif\tyou\thave either\tConsoleReporter\tor\tGraphiteReporter\tconfigured,\tcomment\tthem both\tout.\n\nHow\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tcreate\tyour\tfirst\tKafka\tProducer and\tKafka\tConsumer\tprograms.\n\nLet's\tcreate\ta\tnew\ttopic\tcalled\tgeolocations.\tGo\tahead\tand\texecute\tthe following\tcommand\tin\tyour\tterminal\tshell:\n\n./bin/kafka-topics.sh\t--create\t--zookeeper\t192.168.99.100:2181\t-- replication-factor\t1\t--partitions\t2\t--topic\tgeolocations Created\ttopic\t\"geolocations\".\n\nThere\tare\ta\tfew\tthings\tto\ttalk\tabout\there.\tFirst,\tlet's\ttalk\tabout\tthe\treplication- factor\toption.\tThe\treplication\tfactor\tsays\thow\tmany\treplicas\tKafka\tneeds\tto maintain\tfor\teach\tpartition\tin\tthe\ttopic.\tIt\tdepends\ton\tthe\tcluster\tsize\tand configuration.\tIn\tour\tcase,\twe\thave\tset\tit\tto\t1.\tThe\tpartitions\toption,\tas\tthe name\tindicates,\tis\tthe\tnumber\tof\tpartitions\tthis\ttopic\tneeds\tto\thave.\tThe\ttopic argument\tindicates\tthe\tname\tof\tour\ttopic.\tAnd,\tof\tcourse,\twe\tneed\tthe zookeeper\targument\tto\tlocate\tour\tbroker:\n\n1.\t Now\tthat\tour\ttopic\tis\tready,\tlet's\tcreate\ta\tsimple\tKafka\tproducer.\tAdd\tthe following\tMaven\tdependency\tto\tthe\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t\t\t\t\t<groupId>org.apache.kafka</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>kafka-clients</artifactId> \t\t\t\t\t\t\t\t\t\t<version>0.10.1.0</version> \t\t\t\t\t\t\t\t</dependency>\n\n2.\t Create\ta\tnew\tclass\tin\tthe\tgeolocation\trepo\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationProducer.java.\n\n3.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tproducer:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.List; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.producer.KafkaProducer; import\torg.apache.kafka.clients.producer.Producer; import\torg.apache.kafka.clients.producer.ProducerRecord; import\torg.apache.kafka.common.serialization.StringSerializer;\n\npublic\tclass\tGeoLocationProducer\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName()); Producer<String,\tString>\tproducer\t=\tnew\tKafkaProducer<>(props);\n\nList<GeoLocation>\tgeolocations\t=\tArrays.asList( \t\t\t\t\t\tnew\tGeoLocation(38.6270,\t90.1994), \t\t\t\t\t\tnew\tGeoLocation(93.9879,\t76.9876),\t//\tinvalid\tlat \t\t\t\t\t\tnew\tGeoLocation(41.8034,\t-88.1440), \t\t\t\t\t\tnew\tGeoLocation(40.9879,\t-200.9876),\t//\tinvalid\tlong \t\t\t\t\t\tnew\tGeoLocation(-93.9879,\t76.9876),\t//\tinvalid\tlat \t\t\t\t\t\tnew\tGeoLocation(9.5680,\t77.9624), \t\t\t\t\t\tnew\tGeoLocation(13.0827,\t80.2707), \t\t\t\t\t\tnew\tGeoLocation(40.9879,\t200.9876),\t//\tinvalid\tlong \t\t\t\t\t\tnew\tGeoLocation(9.9252,\t78.1198));\n\nfor(GeoLocation\tgeolocation\t:\tgeolocations)\t{ \t\t\t\t\t\tSystem.out.println(\"Sending\tgeolocaiton\t[\"\t+ geolocation.toString()\t+\t\"]\"); \t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\tproducer.send(record); \t\t\t\t}\n\nproducer.close(); \t\t} }\n\n4.\t There\tare\tthree\tthings\tto\ttalk\tabout\there:\tproducer,\tgeolocations\tand ProducerRecords.\tIn\torder\tto\tinstantiate\tproducer,\twe\tcreate\ta\tProperties object\twith\tthree\tproperties:\tbootstrap.servers,\tkey.serializer,\tand value.serializer:\n\nThe\tbootstrap.servers\tproperty\tindicates\tthe\tURLs\tto\tthe\tKafka brokers.\tAs\tour\tcluster\tis\ta\tsingle\tbroker\tcluster,\twe\tprovide\tthe\tURL to\tthat\tbroker\tin\tthis\tproperty.\tIf\tyou\thave\tmultiple\tbrokers,\tyou\tcan provide\tcomma-separated\tvalues.\n\nThe\tkey.serializer\tproperty\ttakes\tthe\tfully\tqualified\tname\tof\tthe serializer\tthat\twill\tbe\tused\tto\tserialize\tthe\tkey\tof\tthe\tmessage. Likewise,\tthe\tvalue.serializer\tproperty\ttakes\tthe\tfully\tqualified name\tof\tthe\tserializer\tthat\twill\tbe\tused\tto\tserialize\tthe\tvalue\tof\tthe message.\n\n5.\t Later\tin\tthe\tcode,\twe\tcreate\tnine\tgeolocations,\tout\tof\twhich\tfour\tare\tinvalid (invalid\tgeolocations\thave\ta\tcomment\tright\tnext\tto\tthem).\tThen,\tfor\teach geolocation,\twe\tcreate\ta\tProducerRecord.\tThe\tconstructor\tof ProducerRecord\thas\ttwo\targuments:\tthe\ttopic\tname\tand\tthe\tactual message.\tIn\tthis\trecipe,\tthe\ttopic\tname\tis\tgeolocations.\tLet's\tcome\tback\tto the\tactual\tmessage\tlater.\n\n6.\t Also\tlook\tat\thow\tthe\tProducerRecord\tis\tdefined\tas\ta\tgeneric\tof\t<String, String>.\tThe\tfirst\tgeneric\tdefines\tthe\ttype\tof\tthe\tkey,\tand\tthe\tsecond defines\tthe\ttype\tof\tthe\tvalue.\tThe\tkey\tis\tusually\tused\tto\tassign\tpartitions.\tIn this\trecipe,\tthe\tkey\tis\tnot\tsignificantly\timportant,\tso\twe\tare\tgoing\tto\tignore it.\tIf\tyou\twould\tlike\tto\tuse\tit,\tthen\tyou\thave\tto\tuse\tthe\tappropriate overloaded\tconstructor\tfor\tProducerRecord.\tWe\tthen\tinvoke\tthe\tsend() method\ton\tproducer\twith\tthe\tProducerRecord.\tFinally,\tthe\tproducer instance\tis\tclosed\tby\tinvoking\tthe\tclose()\tmethod.\n\n7.\t Now\tlet's\tgo\tback\tto\tthe\tactual\tmessage.\tIt\tis\ta\ttoString()\tof\tthe GeoLocation\tclass.\tBut\twait;\twe\thaven't\tdefined\ta\ttoString()\tmethod\tin GeoLocation.\tLet's\tdo\tit\tnow.\tWe\twill\tbe\tconverting\tthe\tGeoLocation object\tto\tits\tJSON\tequivalent.\n\n8.\t Let's\tuse\tGSON\tto\tdo\tit.\tGSON\tis\ta\tJSON\tlibrary\tfrom\tGoogle\tand\tis\tvery easy\tto\tuse.\tGo\tahead\tand\tadd\tthe\tfollowing\tMaven\tdependency\tto\tthe pom.xml\tfile: <dependency> \t\t\t\t\t\t\t\t\t\t<groupId>com.google.code.gson</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>gson</artifactId> \t\t\t\t\t\t\t\t</dependency>\n\n9.\t Now\tthat\tour\tdependency\tis\tready,\tadd\tthe\tfollowing\tconstructors\tand toString()\tmethod\tto\tGeoLocation.java:\n\npublic\tGeoLocation()\t{}\n\npublic\tGeoLocation(double\tlatitude,\tdouble\tlongitude)\t{ \t\t\tthis.latitude\t=\tlatitude; \t\t\tthis.longitude\t=\tlongitude; \t\t\tthis.userId\t=\tUUID.randomUUID();\n\nthis.userId\t=\tUUID.randomUUID(); \t\t\tthis.timestamp\t=\tSystem.currentTimeMillis(); } @Override public\tString\ttoString()\t{ \t\treturn\tGSON.toJson(this); }\n\n10.\t GSON\tis\tdefined\tas\ta\tconstant\tin\tthe\tsame\tclass:\n\nprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson();\n\n11.\t Now\tall\tour\tgeolocations\twill\tbe\tsent\tto\tthe\tKafka\ttopic\tas\tJSON\tstrings. 12.\t The\tnext\tstep\tin\tthis\trecipe\tis\tto\tbuild\tthe\tKafka\tconsumer\tthat\twill consume\tmessages\tfrom\tthe\tgeolocations\ttopic.\tGo\tahead\tand\tcreate\ta new\tthread\tcalled com.packt.microservices.geolocation.GeoLocationConsumer.java.\n\n13.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tconsumer\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.consumer.ConsumerRecord; import\torg.apache.kafka.clients.consumer.ConsumerRecords; import\torg.apache.kafka.clients.consumer.KafkaConsumer; import org.apache.kafka.common.serialization.StringDeserializer;\n\nimport\tcom.google.gson.Gson;\n\npublic\tclass\tGeoLocationConsumer\timplements\tRunnable\t{\n\nprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson(); \t\tprivate\tstatic\tfinal\tGeoLocationRepository\tREPO\t=\tnew GeoLocationRepository();\n\npublic\tvoid\trun()\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"group.id\",\t\"geolocationConsumer\"); \t\t\t\tprops.put(\"key.deserializer\", StringDeserializer.class.getName()); \t\t\t\tprops.put(\"value.deserializer\", StringDeserializer.class.getName());\n\ntry\t(KafkaConsumer<String,\tString>\tconsumer\t=\tnew\n\ntry\t(KafkaConsumer<String,\tString>\tconsumer\t=\tnew KafkaConsumer<>(props))\t{ \t\t\t\t\t\tconsumer.subscribe(Arrays.asList(\"geolocations\")); \t\t\t\t\t\twhile\t(true)\t{ \t\t\t\t\t\t\t\tConsumerRecords<String,\tString>\trecords\t= consumer.poll(100); \t\t\t\t\t\t\t\tfor\t(ConsumerRecord<String,\tString>\trecord\t:\trecords)\t{ \t\t\t\t\t\t\t\t\t\tSystem.out.printf(\"offset\t=\t%d,\tkey\t=\t%s,\tvalue\t= %s%n\", \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.offset(), \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.key(), \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.value());\n\nREPO.addGeoLocation(GSON.fromJson(record.value(), GeoLocation.class)); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t} \t\t\t\t}\tcatch\t(Exception\te)\t{ \t\t\t\t\t\tSystem.err.println(\"Error\twhile\tconsuming\tgeolocations. Details:\t\"\t+\te.getMessage()); \t\t\t\t} \t\t} }\n\n14.\t First,\twe\tcreate\ta\tnew\tKafkaConsumer\twith\tfour\tproperties: bootstrap.servers,\tgroup.id,\tkey.deserializer,\tand value.deserializer:\n\nThe\tbootstrap.servers\tproperty\tis\tthe\tsame\tas\tin\tthe\tproducer.\tWe will\ttalk\tabout\tgroup.id\tlater\tin\tthis\tchapter.\tFor\tnow,\tyou\tcan\tkeep\tin mind\tthat\tit\tis\tused\tto\tgroup\tconsumers. The\tkey.deserializer\tproperty\twill\tbe\tthe\tfully\tqualified\tclass\tname of\tthe\tdeserializer\tthat\twill\tbe\tused\tto\tdeserialize\tthe\tserialized\tkey\tof the\tmessage. Likewise,\tvalue.deserializer\tis\tused\tfor\tthe\tvalue\tdeserialization process.\tAs\tyou\tcan\tsee,\tthe\tconsumer.subscribe()\tmethod\ttakes\tan argument\tof\tstring\tarrays.\tSo\tyou\tcan\tuse\tthe\tsame\tconsumer\tto consume\tmessages\tfrom\tmultiple\ttopics.\tIn\tthis\tcase,\twe\thave subscribed\tto\tthe\tgeolocations\ttopic.\n\n15.\t In\tan\tinfinite\tloop,\twe\tcreate\tthe\tConsumerRecord\tinstances\tfor\teach message\treceived\tfrom\tthe\ttopic.\tThe\tmessages,\talong\twith\ttheir\toffset\tin the\ttopic,\ttheir\tkey,\tand\tvalue,\tare\tprinted\tout.\n\n16.\t Finally,\tthe\tmessage\tvalue\tis\tconverted\tto\tGeoLocation\tusing\tGSON\tand stored\tusing\tthe\tGeoLocationRepository\tclass.\tAs\twe\tare\tusing\tan\tinfinite\n\nloop,\tthis\tcode\twill\trun\tand\tkeep\tlistening\tfor\tany\tnew\tmessages\tin\tthe topic\tand\tstore\tthem\tas\tthey\tcome\tthrough.\n\nNote\n\nIf\tyou\tare\twondering\twhy\twe\tinstantiated\ta\tnew\trepository\tinstead\tof autowiring\tit\tas\ta\tbean,\tthe\treason\tis\tbecause\tSpring\tbeans\tand\tthreads\tdo not\tgo\twell\twith\teach\tother.\tUnfortunately,\tour\tconsumer\tmust\tbe\ta\tthread. So\tthe\tbest\tway\tto\taccomplish\tthis\tis\tto\tinstantiate\tthe\trepository\tas\ta regular\tJava\tobject\tusing\tthe\tnew\tkeyword.\tThe\tside\teffect\tof\tthis\tis\tthat\tthe repository\t(and\thence\tthe\tin-memory\tcollection)\tused\tby\tthe GeoLocationConsumer\tand\tthe\tGeoLocationController\twill\tbe\ttotally different.\tIdeally,\tin\ta\treal-time\tscenario,\twe\twould\tbe\tusing\ta\tdatabase\tto store\tour\tdata.\tSo\tthis\tsituation\twill\tnot\thappen.\tFor\tillustrations,\tin\tthis recipe,\twe\twill\tbe\tverifying\twhether\tour\tgeolocations\twere\tcreated\tby looking\tat\tthe\tdata\tdirectory\tat\toptpackt/geolocation/data.\n\n17.\t In\torder\tto\tstart\tthis\tthread,\tadd\tthe\tfollowing\tsnippet\tto\tthe\tmain\tmethod\tof the\tGeoLocationApplication.java\tclass:\n\nnew\tThread(new\tGeoLocationConsumer()).start();\n\n18.\t That's\tit.\tWe\thave\tour\tproducer\tand\tconsumer\tready.\tLet's\ttest\tthem\tout. Start\tthe\tGeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot application.\tThis\ttime,\talong\twith\tthe\tSpring\tMVC\tlogs,\tyou\tshould\tsee some\tKafka\tconsumer\tlogs\ttoo:\n\n19.\t Now\tthat\tour\tconsumer\tis\tready,\tlet's\texecute\tthe\n\nGeoLocationProducer.java\tclass\tas\ta\tJava\tapplication\tfrom\tyour\tSTS IDE.\tThe\tproducer\twill\tdrop\tall\tthe\tnine\tgeolocations\tinto\tthe geolocations\ttopic.\n\n20.\t Now\tlook\tat\tthe\tconsole\tof\tyour\tgeolocation\tmicroservice:\n\nAs\tyou\tcan\tsee,\tthe\tconsumer\treceived\tnine\tmessages\tthat\tthe\tproducer produced.\tThe\toffsets\tstart\tfrom\t17\tinstead\tof\t0\tbecause\tthe\tproducer probably\tproduced\tmore\tmessages\tbefore\tthis\t(I\twas\ttesting\tit\ta\tfew\ttimes before\tthis\texecution).\n\n21.\t Now\tlet's\tverify\twhether\tour\tgeolocations\twere\tcreated\tin\tthe\tdata directory.\tRun\tthe\tfollowing\tls\tcommand\tfrom\ta\tterminal\tshell\tto\tview\tthe contents\tof\tyour\tdata\tdirectory:\n\nls\t-1\toptpackt/geolocation/data user0e7b55ae-ae42-4fba-a0a7-09ea50f018b3_t1482426034840 user2bb53438-2650-485d-ad2c-77bf53367311_t1482426034840 user8c5334e4-8bdb-4351-af8d-20f298082a41_t1482426034840 user92e6069f-6ec8-4339-a020-10fd5fe86502_t1482426034840 usera4b88745-2b55-425f-bad5-d4ebea8c7b27_t1482426034840 userb25977d7-3770-491c-8cfd-578748148ad2_t1482426034840 userc0774179-ee5e-4bf9-92aa-03e800cf076e_t1482426034840 userca40d66f-af00-4240-8ab0-5bfe48aa1df3_t1482426034840 userce5d314a-763f-4010-812f-a07e1945d5f6_t1482426034840\n\n22.\t The\tpreceding\tcommand\tlists\tall\tthe\tfiles\tin\tthe\tgiven\tdirectory.\tIf\tyou\tare curious\tto\tknow\twhether\tthese\tfiles\thave\tthe\tgeolocations,\tuse\tthe\tcat command\tto\tview\tthe\tcontents.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\twrote\ta\tsimple consumer\tand\tproducer\tto\twork\twith\tKafka\ttopics.\tThis\tapplication\tcan\tbe extended\tto\tbuild\ta\tmore\tsophisticated\tand\trobust\tapplication\tfor\tgeolocation entities.\tIn\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto\tuse\tKafka\tStreams\tto\tbuild\tgreat streaming\tapplications.\n\nWriting\ta\tstreaming\tprogram\tusing Kafka\tStreams\n\nIn\tthe\tprevious\trecipe,\twe\twrote\ta\tvery\tbasic\tKafka\tproducer\tand\tconsumer. That\tmight\tnot\tbe\tsufficient\twhen\tyou\twould\tlike\tto\twork\twith\tyour\tdata.\tIn fact,\tthe\tconsumer\twe\twrote\twas\tnot\tsmart\tenough\tto\tfilter\tout\tgeolocations\twith invalid\tlatitudes\tand\tlongitudes.\tThese\tare\tthings\tyou\twould\twant\tto\tdo\twhen you\tbuild\ta\tstreaming\tapplication.\tIn\tthis\trecipe,\twe\twill\tbe\tutilizing\tKafka's Streams\tAPI\tto\tcreate\ta\tKafka\tStreams\tapplication\tthat\twill\tstream\tmessages from\ta\tnew\ttopic\tcalled\tgeolocationStreams,\tfilter\tout\tbad\tgeolocations,\tand forward\tthe\tvalid\tgeolocations\tto\tthe\tgeolocations\ttopic.\tThis\twill\tmake\tsure that\twe\tstore\tonly\tvalid\tgeolocations.\n\nThe\tfollowing\tdiagram\tdepicts\tthe\tflow\tof\tour\tapplication:\n\nGetting\tready 1.\t Before\twe\twrite\tour\tKafka\tStreams\tapplication,\tlet's\tdelete\tany\texisting geolocations\tin\tthe\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommand\tin\ta new\tterminal\tshell:\trm\toptpackt/geolocation/data/*\n\n2.\t Now\tthat\tyou\thave\tcleaned\tup\tall\tthe\texisting\tgeolocations,\tmake\tsure\tyou have\tKafka\tup\tand\trunning.\tIf\tit\tisn't\trunning,\tstart\tit\tusing\tDocker Compose.\tIf\tit\tis\ta\tfresh\tinstallation,\tcreate\tthe\tgeolocations\ttopic.\n\n3.\t The\tnext\tstep\tis\tcreating\ta\tnew\ttopic\tfor\tthe\tstreaming\tapplication.\tExecute the\tfollowing\tcommand\tin\tthe\tsame\tterminal\twindow:\t./bin/kafka- topics.sh\t--create\t--topic\tgeolocationStreams\t--replication-factor\t1\t-- partitions\t2\t--zookeeper\t192.168.99.100:2181\tCreated\ttopic \"geolocationStreams\".\n\nHow\tto\tdo\tit... 1.\t The\tfirst\tstep\tin\tcreating\tthe\tKafka\tStreams\tapplication\tis\twriting\tthe\n\nstreaming\tlogic.\tAdd\tthe\tfollowing\tdependency\tto\tthe\tgeolocation\tproject's pom.xml\tfile:\t<dependency>\t<groupId>org.apache.kafka</groupId> <artifactId>kafka-streams</artifactId>\t<version>0.10.1.0</version> </dependency>\n\n2.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservice.geolocation.GeoLocationStreams.java.\tAdd the\tfollowing\tsnippet\tto\tit:\tpackage com.packt.microservices.geolocation;\timport\tjava.util.HashMap; import\tjava.util.Map;\timport\tjavax.annotation.PostConstruct;\timport org.apache.kafka.common.serialization.Serdes;\timport org.apache.kafka.streams.KafkaStreams;\timport org.apache.kafka.streams.StreamsConfig;\timport org.apache.kafka.streams.kstream.KStreamBuilder;\timport org.apache.kafka.streams.kstream.Predicate;\timport org.springframework.stereotype.Component;\t@Component\tpublic class\tGeoLocationStreams\t{\t@PostConstruct\tpublic\tvoid\tinit()\t{ Map<String,\tObject>\tprops\t=\tnew\tHashMap<>(); props.put(StreamsConfig.APPLICATION_ID_CONFIG,\t\"geolocation- application\"); props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"192.168.99.100:9092\"); props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName()); props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, GeoLocationSerdes.class.getName());\tStreamsConfig\tconfig\t=\tnew StreamsConfig(props);\tKStreamBuilder\tbuilder\t=\tnew KStreamBuilder();\tbuilder.stream(\"geolocationStreams\").filter(new Predicate<Object,\tObject>()\t{\t@Override\tpublic\tboolean\ttest(Object key,\tObject\tvalue)\t{\tGeoLocation\tgeolocation\t=\t(GeoLocation)\tvalue; System.out.println(\"Stream\treceived\t=>\t\"\t+\tvalue);\treturn geolocation.getLatitude()\t>=\t-90\t&&\tgeolocation.getLatitude()\t<\t90\t&& geolocation.getLongitude()\t>=\t-180\t&&\tgeolocation.getLongitude()\t< 180;\t}\t}).to(\"geolocations\");\tKafkaStreams\tstreams\t=\tnew KafkaStreams(builder,\tconfig);\tstreams.start();\t}\t}\n\nAs\tyou\tcan\tsee,\twe\tfirst\tbuild\ta\tStreamsConfig\tinstance.\tThe StreamsConfig\tinstance\tprimarily\tidentifies\tthe\tKafka\tbroker\tURLs, SerDes\tfor\tthe\tkey,\tand\tSerDes\tfor\tthe\tvalue.\tIf\tyou\tare\twondering\twhat SerDes\tis,\tit\tis\tshort\tfor\tSerializerDeserializer.\tSee\thow\twe\thave\tused\ta custom\tSerDes\tfor\tthe\tvalue.\tWe\twill\tbe\tcreating\ta\tSerDes\tcalled GeoLocationSerdes\tlater\tin\tthis\trecipe.\tThe\tfunction\tof\tthis\tSerDes\tis\tto serialize\tand\tdeserialize\tthe\tGeoLocation\tobject\tto\tJSON\t(eventually\tbytes) and\tvice\tversa.\tWe\twill\tlook\tat\thow\tto\tdo\tthis\tlater.\n\n3.\t The\tnext\tstep\tis\tcreating\tthe\tKStreamBuilder\tinstance.\tKStreamBuilder defines\twhere\tyour\tstream\tapplication\twill\tstream\tmessages\tfrom,\thow\tto process\tthe\tmessage\twith\tthe\thelp\tof\tseveral\tmethods\t(such\tas\tmap, flatMap,\tfilter,\tand\tto),\tand,\tfinally,\tsend\tthe\tmessages\tover\tto\ta destination\ttopic:\n\nThe\tstream()\tmethod\ttells\twhere\tthe\tmessages\tshould\tbe\tstreamed from.\tIn\tour\texample,\twe\tare\tstreaming\tfrom\tthe\tgeolocationStreams topic. The\tfilter()\tmethod\ttakes\ta\tpredicate\tthat\twill\tfilter\tgeolocations that\thave\tbad\tlatitude\tand\tlongitude. The\tto()\tmethod\ttells\twhere\tthe\tvalid\tgeolocations\twill\tbe\tsent\tto.\n\nIn\tour\tcase,\twe\tare\tsending\tthem\tto\tthe\tgeolocations\ttopic.\tIf\tyou\tremember, the\tGeoLocationConsumer.java\tclass\twill\tconsume\tthese\tvalid\tgeolocations\tand store\tthem\tin\tthe\tdata\tdirectory.\tIf\tyou\twould\tlike\tto\tbypass\tthe GeoLocationConsumer\tclass,\tthat\tis\tfine\ttoo.\tIn\tfact,\tyou\tcan\tuse\tthe\tmap() method\tto\tcall\tGeoLocationService\tdirectly\tas\ta\tpart\tof\tKStreamBuilder. Finally,\twe\tinstantiate\ta\tnew\tKafkaStreams\tinstance\twith\tKStreamsBuilder\tand StreamsConfig.\tWe\thave\tto\tinvoke\tthe\tstart()\tmethod\tto\tstart\tthe\tstreaming process.\n\nNow\tlet's\tsee\thow\tto\tcreate\tour\tGeoLocationSerdes.java\tclass.\tCreate\ta\tnew\n\nclass\tcalled com.packt.microservices.geolocation.GeoLocationSerdes.java\tand\tadd the\tfollowing\tcode\tto\tit:\tpackage\tcom.packt.microservices.geolocation;\timport java.util.Map;\timport\torg.apache.kafka.common.serialization.Deserializer; import\torg.apache.kafka.common.serialization.Serde;\timport org.apache.kafka.common.serialization.Serializer;\timport com.google.gson.Gson;\tpublic\tclass\tGeoLocationSerdes\timplements Serde<GeoLocation>\t{\tprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson();\tpublic GeoLocationSerdes()\t{}\t@Override\tpublic\tvoid\tconfigure(Map<String,\t?>\n\nconfigs,\tboolean\tisKey)\t{}\t@Override\tpublic\tvoid\tclose()\t{}\t@Override\tpublic Serializer<GeoLocation>\tserializer()\t{\treturn\tnew\tSerializer<GeoLocation>()\t{ @Override\tpublic\tvoid\tconfigure(Map<String,\t?>\tconfigs,\tboolean\tisKey)\t{} @Override\tpublic\tbyte[]\tserialize(String\ttopic,\tGeoLocation\tdata)\t{\treturn data.toString().getBytes();\t}\t@Override\tpublic\tvoid\tclose()\t{}\t};\t}\t@Override public\tDeserializer<GeoLocation>\tdeserializer()\t{\treturn\tnew Deserializer<GeoLocation>()\t{\t@Override\tpublic\tvoid\tconfigure(Map<String,\t? >\tconfigs,\tboolean\tisKey)\t{}\t@Override\tpublic\tGeoLocation\tdeserialize(String topic,\tbyte[]\tdata)\t{\treturn\tGSON.fromJson(new\tString(data), GeoLocation.class);\t}\t@Override\tpublic\tvoid\tclose()\t{}\t};\t}\t}\n\nThe\tGeoLocationSerdes\tmethod\timplements\tthe\tSerde\tinterface:\n\nThe\tconfigure()\tand\tclose()\tmethods\tare\tnot\tvery\tsignificant\tfor\tthis recipe,\tso\tthey\twere\tnot\timplemented\tin\tthe\tpreceding\tsnippet The\tserializer()\tmethod\treturns\ta org.apache.kafka.common.serialization.Serializer<GeoLocation> that\thas\ta\tserialize()\tmethod\tthat\tknows\thow\tto\tconvert\tthe\tGeoLocation object\tto\tbytes Similarly,\tthe\tdeserializer()\tmethod\treturns\ta org.apache.kafka.common.serialization.Deserializer<GeoLocation> that\thas\ta\tdeserialize()\tmethod\tthat\tknows\thow\tto\tconvert\tbytes\tto\tthe GeoLocation\tobjects That's\tit!\tOur\tKafka\tStreams\tapplication\tis\tnow\tready\tto\ttest.\tBefore\twe start\ttesting,\twe\thave\tto\tchange\tthe\tGeoLocationProducer\tclass\tto\tproduce messages\tfor\tthe\tgeolocationStreams\ttopic\tinstead\tof\tgeolocations. So\tlet's\tmake\tthat\tchange.\tWith\tthat\tdone,\trun\tthe\tGeoLocationApplication class\tas\ta\tSpring\tBoot\tapplication.\tThis\ttime\taround,\tyou\tshould\thave\tsee\tmore log\tmessages\twhen\tyou\tapplication\tstarts,\tas\tthe\tStreams\tapplication\thas\tstarted along\twith\tSpring\tMVC\tand\tKafka\tconsumer.\n\nWithout\tfurther\tado,\trun\tGeoLocationProducer\tas\ta\tJava\tapplication.\tThis should\thave\tproduced\tthe\tsame\tnine\tgeolocations\tin\tthe\tgeolocationStreams topic.\n\nNow\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tgeolocation\tmicroservice.\tYou\tshould\n\nsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tonly\tfive\tgeolocations\tthat\thad\tvalid\tlatitude\tand\tlongitude values\twere\tsent\tto\tthe\tgeolocations\ttopic.\tLet's\tverify\tthe\tsame\tby\tlisting\tthe contents\tof\tour\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal shell:\tls\t-1\toptpackt/geolocation/data\tuser352752e1-f9df-4a2c-8bb5- 00df1b001170_t1482431025183\tuser4ca44a13-f737-4bba-84b8- 1ef39f5ebb60_t1482431025183\tuser97b60125-2ef7-48df-9d31- da755ba54bc4_t1482431025183\tuser9d07e2cc-9902-4710-a311- 19fc09a84f3b_t1482431025183\tusercdfb7821-20c8-474e-9cc7- 65b65316a78a_t1482431025183\n\nPerfect!\tThat\tclarifies\tthat\tour\tKafka\tStreams\tapplication\tworked\tas\texpected.\n\nWith\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tlearn how\tto\tprocess\tmore\tgeolocations\tusing\tKafka\tStreams.\n\nImproving\tthe\tperformance\tof\tthe Kafka\tStreams\tprogram\n\nKafka\tclaims\tthat\tit\tis\tso\tfast\tthat\teach\tbroker\tcan\thandle\thundreds\tof\tmegabytes of\tdata\tper\tsecond\tfrom\tseveral\tapplications.\tThat\tis\ta\tbold\tstatement.\tIn\tfact, Kafka\thas\tproved\tto\tbe\tmuch\tfaster\tthan\tthis\tin\tseveral\tsuccess\tstories.\tSo\tusing Kafka\tgives\tyou\tthis\tawesome\tperformance\tby\tdefault.\tWhat\tif\tthat\tis\tnot sufficient?\tThe\tanswer\tto\tthis\tquestion\tis\tscaling.\tKafka\tis\tbuilt\tin\tsuch\ta\tway that\tKafka\tconsumers\tor\tKafka\tStreams\tapplications\tcan\tbe\tscaled\tin\tsuch\ta\tway that\tthey\twork\ttogether\tas\ta\tgroup.\tThat's\twhere\tthe\tterm\t\"consumer\tgroup\" kicks\tin.\tA\tconsumer\tgroup\tis\ta\tgroup\tof\tconsumers\tthat\tshare\tthe\tsame\tID. Consumers\tin\ta\tconsumer\tgroup\tsubscribe\tto\tthe\tsame\ttopic(s);\thowever,\teach consumer\tgroup\tgets\tonly\tone\tcopy\tof\teach\tmessage\tproduced\tin\ta\ttopic.\tThis\tis how\tKafka\tachieves\tpoint-to-point\tbehavior\tusing\ttopics.\tInternally,\teach consumer\tin\tthe\tconsumer\tgroup\twill\tbe\tconsuming\tmessages\tfrom\tone dedicated\tpartition.\tThis\twill\tcontribute\tto\ta\tparallel\tprocessing\tbehavior.\n\nNote\n\nLet's\tconsider\ta\tsituation\twhere\tthere\tis\ta\ttopic\twith\ttwo\tpartitions\tand\tone consumer\tcalled\tconsumer-01.\tNow,\tconsumer-01\twill\tbe\tresponsible\tfor consuming\tmessages\tfrom\tpartition-00\tand\tpartition-01.\tThis\tis\treally\tnot going\tto\tgive\tus\tthe\tperformance\twe\texpect.\tSo\twe\thave\tto\tspin\toff\tanother consumer\twith\tthe\tsame\tgroup\tID\tso\tthat\twe\tcan\tconsume\tmessages\tfrom\tboth partitions\tin\tparallel.\tNow\tif\twe\tspin\toff\tconsumer\t-02,\tconsumer-01\twill consume\tmessages\tfrom\tpartition-00,\tand\tconsumer-02\twill\tconsume messages\tfrom\tpartition-01\t(or\tvice\tversa).\tNow\tlet's\tsay\tyou\tspin\toff\tanother consumer\tcalled\tconsumer-03.\tThis\ttime,\tit\tis\treally\tnot\tgoing\tto\timprove\tyour performance\tany\tfurther\tbecause\tat\tleast\tone\tconsumer\tis\tgoing\tto\tbe\tidle\tall\tthe time.\tConsumers\tdo\tnot\tshare\ttopic\tpartitions.\tKeep\tthis\tin\tmind\twhen\tyou\tbuild your\tapplications\tusing\tKafka.\n\nGetting\tready 1.\t Before\twe\tjump\tinto\tthe\trecipe,\tlet's\tdelete\tany\texisting\tgeolocations\tin\tthe data\tdirectory.\tExecute\tthe\tfollowing\tcommand\tin\ta\tnew\tterminal\tshell:\n\nrm\toptpackt/geolocation/data/*\n\n2.\t Now\tthat\tyou\thave\tcleaned\tup\tall\tthe\texisting\tgeolocations,\tmake\tsure\tyou have\tKafka\tup\tand\trunning.\tIf\tit\tis\tnot\trunning,\tstart\tit\tusing\tDocker Compose.\tIf\tit\tis\ta\tfresh\tinstallation,\tcreate\tthe\tgeolocations\tand geolocationStreams\ttopics.\n\nHow\tto\tdo\tit... 1.\t In\tthis\trecipe,\twe\twill\tbe\tspinning\toff\ttwo\tinstances\tof\tthe\tgeolocation application\tand\twill\tbe\tmonitoring\tthe\tlogs\tto\tsee\thow\tthe\tmessages\tare distributed.\tGo\tahead\tand\tstart\ttwo\tinstances\tof\tthe GeoLocationApplication,\tone\trunning\ton\tport\t8080\tand\tthe\tother\trunning on\tport\t8081.\tMake\tsure\tthere\tare\tno\terrors\tin\tyour\tconsole.\n\n2.\t Now\trun\tthe\tGeoLocationProducer\tclass\tas\ta\tJava\tapplication.\tThis\tshould have\tdropped\tthe\tnine\tgeolocations\tinto\tthe\tgeolocationStreams\ttopic.\n\n3.\t Let's\tsee\twhat\tthe\tconsole\tlooks\tlike\tfor\tboth\tthe\tinstances:\n\nThe\tpreceding\tscreenshot\tshows\tthe\tconsole\tlogs\tfrom\tthe\tfirst\tinstance\tof geolocation.\tAs\tyou\tcan\tsee,\tthe\tGeoLocationStreams\tapplication received\tfive\tmessages\tout\tof\tnine.\tAnd\tthe\tGeoLocationConsumer application\treceived\tthree\tout\tof\tthe\tfive\tmessages.\n\n4.\t Now\tlet's\ttake\ta\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tsecond\tinstance\tof\tthe geolocation\tmicroservice:\n\nAs\tyou\tcan\tsee,\tfour\tout\tof\tnine\tmessages\twere\treceived\tby\tthe GeoLocationStreams\tapplication.\tAnd\tthe\tGeoLocationConsumer application\treceived\ttwo\tout\tof\tthe\tfive\tmessages.\tThis\tdemonstrates\tthat the\tKafkaStreams\tand\tKafkaConsumer\tinstances\tscale\tas\tthe\tapplication scales-which\tis\tobviously\tgreat\tnews.\tBut\tthe\treal\tquestion\tis\thow?\tAlso, we\tdid\tnot\tcreate\tany\tconsumer\tgroups\tin\tthis\trecipe.\tIn\tfact,\twe\tactually created\ta\tconsumer\tgroup\tearlier.\n\n5.\t Now,\tgo\tback\tto\tyour\tconsumer\tclass,\tand\tyou\twill\tnotice\tthat\twe\tpassed\ta parameter\tcalled\tgroup.id\twith\tthe\tvalue\tgeolocationConsumer.\n\nConsumers\twith\tthe\tsame\tgroup.id\tproperty\twill\tbe\tin\tthe\tsame\tconsumer group.\tThat\tis\tthe\treason\tour\tGeoLocationConsumer\tapplication\twas scalable.\tSimilarly,\tthe\tStreamsConfig.APPLICATION_ID_CONFIG\tproperty in\tthe\tGeoLocationStreams\tclass\tdefines\tthe\tconsumer\tgroup\tID\tvalue.\tThe value\tof\tthis\tproperty\thas\tbeen\tset\tto\tgeolocation-application.\tSo\tany Kafka\tStreams\tapplication\tthat\thas\tthe\tconsumer\tgroup\tvalue\tset\tto geolocation-application\twill\tbe\tpart\tof\tthe\tsame\tconsumer\tgroup.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto\tscale our\tKafka\tStreams\tapplication.\tKafka\tStreams\thas\ta\tlot\tmany\tmethods\tto\tbuild\ta complete\tdata\tpipeline,\tsuch\tas\tmap,\tflatMap,\tmapValues,\tflatMapValues,\tand filter.\tIt\tis\tstrongly\trecommended\tthat\tyou\tread\tthe\tdocumentation\tbefore\tyou start\tusing\tKafka\tStreams.\tIn\tfact,\tthere\tis\ta\tslightly\tdifferent\tapproach\tthat\tyou can\tuse\tin\tKafka\tStreams\tto\tbuild\tdata\tprocessors.\tTake\ta\tlook\tat TopologyBuilder\tand\tAbstractProcessor\tto\ttry\tthat\tapproach.\tI'll\tleave\tthat\tas an\texercise\tfor\tyou.\n\nWriting\ta\tstreaming\tprogram\tusing Apache\tSpark\n\nYou\tmight\tbe\twondering\twhat\tApache\tSpark\thas\tto\tdo\twith\tmicroservices.\tThe answer\tis\tpretty\tsimple:\tstreaming\tand\tdata\tprocessing.\tNot\tall\tmicroservices will\trequire\tstreaming,\tbut\tmost\tof\tthem\tthese\tdays\tdo.\n\nThere\tare\ttwo\tways\tyou\tcan\tfeed\tdata\tto\ta\tmicroservice:\tvia\tREST\tor\tmessage brokers.\tWith\tRESTful\tAPIs,\tyou\tcan\tachieve\tthe\tperformance\tyou\texpect.\tBut it\thas\tits\town\tlimitations,\twhich\tis\tthe\treason\tcompanies\tmove\ttowards\tmessage brokers\tsuch\tas\tKafka,\tRabbitMQ,\tand\tZeroMQ.\tUsing\tframeworks\tsuch\tas Kafka,\tyou\tcan\tachieve\ttremendous\tperformance\tand\tlive\tresults.\tIn\tfact,\ttoday's streaming\tis\tall\tabout\tlive\tresults.\tBefore\twe\tjump\tinto\tthe\trecipe,\tlet's\ttake\ta minute\tto\tunderstand\tSpark\tand\tsome\tof\tits\tconcepts.\n\nApache\tSpark\tis\ta\tfast\tdata-processing\tframework.\tIt\thas\tfour\tmajor\tmodules: Spark\tStreaming,\tSpark\tSQL,\tSpark\tMLlib,\tand\tSpark\tGraphx.\tSpark\tStreaming is\tused\tto\tstream\tdata\tfrom\tmessaging\tendpoints\tsuch\tas\tTCP\tSocket\tand\tKafka. Spark\tSQL\tis\tused\tto\texecute\tefficient\tqueries\ton\thuge\tstructured\tdatasets.\tSpark MLlib\tis\tSpark's\tmachine\tlearning\tlibrary.\tAt\tthe\ttime\tof\twriting\tthis,\tSpark MLlib\thas\tmatured\tso\tmuch\tthat\tit\tcan\tbe\tused\tfor\tany\tproduction-level\tuse case.\tSpark\tGraphx\tis\tSpark's\tgraph-processing\tAPI.\tIn\tthis\trecipe,\twe\twill\tbe streaming\tgeolocation\toff\tof\ta\tKafka\ttopic,\tfiltering\tbad\tgeolocations,\tand sending\tthe\tvalid\tgeolocations\tto\tanother\tKafka\ttopic.\tAt\tthe\tcore\tof\tApache Spark\tlies\tthe\tRDD\tAPI.\tRDD\tstands\tfor\tResilient\tDistributed\tDataset.\tIt\tis resilient\tbecause\twhen\tSpark\tjobs\tare\texecuted\tin\ta\tcluster,\teven\tif\ta\tnode\tgoes down\twhile\tprocessing\tan\tRDD,\tthe\tRDD\twill\tbe\thanded\tover\tto\tanother\tactive node\tin\tthe\tcluster.\tIt\tis\tdistributed\tbecause\tRDDs\tare\tdistributed\tacross\tnodes\tin the\tcluster.\tSpark's\tconfigurations\tlet\tyou\tallocate\tresources\tsuch\tas\tCPU\tand memory\tfor\tevery\tSpark\tjob.\tThis\tmakes\tSpark\twork\tvery\twell\twith\tclustering framework\tsuch\tas\tMesos\tand\tYARN.\n\nGetting\tready\n\nWriting\ta\tSpark\tjob\tis\tas\tsimple\tas\twriting\ta\tJava\tprogram.\tWith\tthe\tcurrent availability\tof\tdocumentation\ton\tthe\tInternet,\tit\tjust\ttakes\ta\tfew\tminutes\tto\twrite a\tSpark\tjob.\tThe\treal\ttricky\tpart\tis\tdeploying\tthe\tSpark\tjobs.\tThat's\twhere clustering\tframeworks\tsuch\tas\tMesos\tand\tYARN\tcome\tinto\tthe\tpicture.\tBut developing\ta\tSpark\tjob\tshouldn't\treally\trequire\ta\thuge\tcluster.\tThat's\tthe\treason Spark\tcame\tup\twith\ta\tSpark\tstandalone\tmode.\tThe\tstandalone\tmode\truns\tthe Spark\tjob\tin\tmemory.\tIn\tthis\trecipe,\twe\twill\tbe\texecuting\tour\tSpark\tjob\tin\tSpark standalone\tmode.\tWe\twill\tperform\tthe\tsame\tlogic\tthat\twe\tdid\tusing\tKafka Streams,\tonly\tthis\ttime\tusing\tApache\tSpark.\tThe\tfollowing\tdiagram\tshows\tthe flow\tof\tour\tcode:\n\nBefore\twe\tjump\tin,\tlet's\tclean\tup\tthe\tdata\tdirectory\tthat\twas\tpopulated\tby previous\trecipes:\n\n1.\t Execute\tthe\tfollowing\tcommand\tfrom\ta\tterminal\tshell:\n\nrm\toptpackt/geolocation/data/*\n\n2.\t The\tnext\tstep\tis\tcreating\tthe\tgeolocationJob\ttopic.\tExecute\tthe\tfollowing script\tfrom\tKafka's\troot\tdirectory:\n\n./bin/kafka-topics.sh\t--create\t--topic\tgeolocationJob\t-- replication-factor\t1\t--partitions\t2\t--zookeeper\t 192.168.99.100:2181\n\nHow\tto\tdo\tit... 1.\t We\twill\tneed\tsome\tMaven\tdependencies\tto\twrite\ta\tSpark\tStreaming\n\nprogram.\tAdd\tthe\tfollowing\tthree\tdependencies\tto\tthe\tpom.xml\tfile\tof\tthe geolocation\tproject:\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-core_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-streaming_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-streaming-kafka-0-10_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n2.\t Let's\tright\taway\tcreate\tthe\tSpark\tjob.\tCreate\ta\tnew\tjava\tclass\tcalled com.packt.microservices.geolocation.GeoLocationJob.java\twith\tan empty\tmain\tmethod:\n\npackage\tcom.packt.microservices.geolocation;\n\npublic\tclass\tGeoLocationJob\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows\tException\t{\n\n} }\n\n3.\t Writing\tthis\tSpark\tjob\tcan\tbe\tbroken\tdown\tinto\tmultiple\tlogical\tparts:\n\n1.\tCreating\ta\tstreaming\tcontext.\n\n2.\tCreating\ta\tdirect\tstream\ton\tthe\tgeolocationJob\ttopic.\n\n3.\tConverting\tstring\tvalues\tto\tGeoLocation\tobjects.\n\n4.\tFiltering\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude.\n\n4.\tFiltering\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude.\n\n5.\tSending\tvalid\tgeolocations\tto\tthe\tgeolocations\ttopic.\n\n6.\tStarting\tthe\tcontext\tand\tawait\ttermination.\n\n4.\t Let's\tmove\ton\tto\tthe\tfirst\tstep,\twhere\twe\twill\tcreate\tthe\tstreaming\tcontext. Add\tthe\tfollowing\tsnippet\tto\tthe\tmain\tmethod:\n\nSparkConf\tconf\t=\tnew SparkConf().setAppName(\"geolocationJob\").setMaster(\"local[1]\"); JavaStreamingContext\tcontext\t=\tnew\tJavaStreamingContext(conf, new\tDuration(2000));\n\nAs\tyou\tcan\tsee,\tthe\tapp\tname\tis\tset\tto\tgeolocationJob\tand\tthe\tmaster\tis\tset to\tlocal[1].\tThis\tsays\tthat\twe\twill\tbe\tusing\tstandalone\tmode\tand\tour Spark\tjob\twill\tuse\t1\tthread.\tThe\tJavaStreamingContext\tconstructor instance\ttakes\ttwo\targuments:\tSparkConf\tand\tDuration.\tDuration\tis\tused to\tsay\thow\tfrequently\tthe\tmicro-batches\tshould\tbe\tcreated\tand\tprocessed.\n\n5.\t The\tnext\tstep\tin\tcreating\tour\tSpark\tjob\tis\tcreating\ta\tdirect\tstream\ton\tthe geolocationJob\ttopic.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tmain()\tmethod:\n\nMap<String,\tObject>\tkafkaParams\t=\tnew\tHashMap<>(); kafkaParams.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); kafkaParams.put(\"key.deserializer\",\tStringDeserializer.class); kafkaParams.put(\"value.deserializer\", StringDeserializer.class); kafkaParams.put(\"group.id\",\t\"geolocationJob\"); kafkaParams.put(\"auto.offset.reset\",\t\"latest\"); kafkaParams.put(\"enable.auto.commit\",\tfalse);\n\nCollection<String>\ttopics\t=\tArrays.asList(\"geolocationJob\");\n\nfinal\tJavaInputDStream<ConsumerRecord<String,\tString>>\tdstream =\tKafkaUtils.createDirectStream \t\t\t\t(context, \t\t\t\tLocationStrategies.PreferConsistent(), \t\t\t\t\t\tConsumerStrategies.<String,\tString>Subscribe(topics, kafkaParams));\n\nYou\tshould\tbe\tfamiliar\twith\tmost\tof\tthe\tKafka\tparameters.\tTo\tlearn more\tabout\tthe\tproperties,\trefer\tto\tthe\tKafka\tdocumentation\tat https://kafka.apache.org/documentation/#newconsumerconfigs\t. We\tthen\tcreate\ta\tcollection\tof\ttopics.\tHere,\twe\thave\tused\tthe\ttopic\n\nname\tgeolocationJob,\tfrom\twhich\twe\twill\tbe\tstreaming\tour\tmessages off\tof.\tFinally,\twe\tcreate\ta\tdirect\tstream\t(DStream)\tfrom\tthe\tcontext, topics,\tand\tKafka\tparameters.\tThe\tLocationStrategy\tidentifies\thow our\tpartitions\twill\tbe\tdistributed\tacross\texecutors.\tConsumerStrategy helps\tSpark\tobtain\tthe\tright\tconsumers.\tThe\tsubscribe\tconsumer strategy\tis\tused\tfor\tspecific\ttopic\tnames,\tlike\tin\tour\tcase.\tThe preceding\tsnippet\twill\tcreate\ta\tdirect\tstream\tthat\twill\tstream\tmessages from\tthe\tgeolocationJob\ttopic.\n\n6.\t Let's\tmove\ton\tto\tthe\tnext\tstep:\tconverting\tstring\tvalues\tto\tthe\tGeoLocation objects\tin\tConsumerRecord.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tmain() method:\n\ndstream.map(new\tFunction<ConsumerRecord<String,String>, GeoLocation>()\t{\t//\tmap\tto\tGeoLocation \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -5289370913799710097L;\n\n@Override \t\tpublic\tGeoLocation\tcall(ConsumerRecord<String,\tString> record)\tthrows\tException\t{ \t\t\t\treturn\tnew\tGson().fromJson(record.value(), GeoLocation.class); \t\t\t\t\t\t} })\n\nThis\tsnippet\tconverts\tthe\tstring\tvalues\tfrom\tConsumerRecord\tto\tthe GeoLocation\tobjects\tusing\tGSON.\tAs\tyou\tcan\tsee,\twe\thave\tused\tan anonymous\tinner\tclass\tof org.apache.spark.api.java.function.Function.\n\n7.\t Let's\tmove\ton\tto\tthe\tnext\tstep,\twhere\twe\twill\tbe\tfiltering\tgeolocations\twith invalid\tlatitude\tand\tlongitude\tvalues.\tAppend\tthe\tfollowing\tsnippet\tto\tthe previous\tline: .filter(new\tFunction<GeoLocation,\tBoolean>()\t{\t//\tfilter\tout invalid\tgeolocations \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= 6980980875802694946L;\n\n@Override \t\tpublic\tBoolean\tcall(GeoLocation\tgeolocation)\tthrows\tException { \t\t\t\tSystem.out.println(\"Spark\tJob\treceived\t=>\t\"\t+\tgeolocation); \t\t\t\treturn\tgeolocation.getLatitude()\t>=\t-90\n\nreturn\tgeolocation.getLatitude()\t>=\t-90 \t\t\t\t\t\t\t\t&&\tgeolocation.getLatitude()\t<\t90 \t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t>=\t-180 \t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t<\t180; \t\t} })\n\nThat\tpreceding\tsnippet\tmakes\tuse\tof\tFunction\tthat\twill\tact\tas\ta\tpredicate\tto filter\tout\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude\tvalues.\n\n8.\t The\tnext\tstep\tinvolves\twriting\tour\tvalid\tgeolocations\tto\tthe\tgeolocations Kafka\ttopic.\tAppend\tthe\tfollowing\tsnippet\tto\tthe\tprevious\tline\tof\tcode:\n\n.foreachRDD(new\tVoidFunction<JavaRDD<GeoLocation>>()\t{ //iterate\tover\tRDD \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -4161320579495422870L;\n\n@Override \t\tpublic\tvoid\tcall(JavaRDD<GeoLocation>\trdd)\tthrows\tException\t{ \t\t\t\trdd.foreach(new\tVoidFunction<GeoLocation>()\t{\t\t//\tsend valid\tgeolocations\tto\tanother\ttopic \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -3282778715126743482L;\n\n@Override \t\t\t\t\t\tpublic\tvoid\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\t\t\tgetProducer().send(record); \t\t\t\t\t\t} \t\t\t\t}); \t\t} });\n\nWe\tare\tusing\tthe\tforeachRDD()\tmethod\tto\titerate\tover\tthe\tRDDs.\tThen,\twe grab\tthe\tgeolocations\tfrom\teach\tRDD\tusing\tthe\tforeach()\tmethod.\tIn\tboth these\tcases,\twe\thave\tcreated\tanonymous\tinner\tclasses\tfor org.apache.spark.api.java.function.VoidFunction.\tFinally,\twe\tcreate a\tProducerRecord\tand\tsend\tit\tto\tthe\tgeolocaitons\ttopic\tusing KafkaProducer.\tWe\twill\tsee\thow\tthe\tgetProducer()\tmethod\tis implemented\tlater.\n\nNote\n\nIf\tyou\tare\twondering\twhether\tSpark\tsupports\tan\toperation\twhere\tit\tcan drop\tmessages\tonto\ta\tKafka\ttopic,\tthen\tthe\tanswer\tis\tno.\tCurrently,\tSpark does\tnot\thave\tthat\tsupport\tout\tof\tthe\tbox.\tBut\tthere\tare\tthird-party\tlibraries that\tcan\tdrop\tmessages\tonto\ta\tKafka\ttopic\twithout\tyou\thaving\tto\tcreate your\town\tKafka\tproducer.\n\n9.\t The\tfinal\tstep\tis\tstarting\tthe\tcontext\tand\tawaiting\ttermination.\tIn\tthis\tstep, we\twill\tcall\tthe\tstart()and\tawaitTermination()\tmethods\tof\tthe JavaStreamingContext\tinstance\tso\tthat\twe\tcan\tindefinitely\tlisten\tfor\tany new\tmessages\ton\tthe\tgeolocationJob\ttopic:\n\ncontext.start(); context.awaitTermination();\n\n10.\t The\tKafkaProducer\twas\tearlier\tobtained\tusing\tthe\tgetProducer()\tmethod. Let's\tsee\thow\tthis\tmethod\tlooks.\tAdd\tthe\tfollowing\tsnippet\tto\tthe GeoLocationJob.java\tclass:\n\npublic\tstatic\tProducer<String,\tString>\tproducer;\n\npublic\tstatic\tProducer<String,\tString>\tgetProducer()\t{ if(producer\t==\tnull)\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName());\n\nproducer\t=\tnew\tKafkaProducer<>(props); \t\t} \t\treturn\tproducer; }\n\n11.\t That\twas\tthe\tlast\tstep.\tThe\tfinal\tGeoLocationJob\tclass\twill\tlook\tsomething like\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.Collection; import\tjava.util.HashMap; import\tjava.util.Map;\n\nimport\tjava.util.Map; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.consumer.ConsumerRecord; import\torg.apache.kafka.clients.producer.KafkaProducer; import\torg.apache.kafka.clients.producer.Producer; import\torg.apache.kafka.clients.producer.ProducerRecord; import org.apache.kafka.common.serialization.StringDeserializer; import\torg.apache.kafka.common.serialization.StringSerializer; import\torg.apache.spark.SparkConf; import\torg.apache.spark.api.java.JavaRDD; import\torg.apache.spark.api.java.function.Function; import\torg.apache.spark.api.java.function.VoidFunction; import\torg.apache.spark.streaming.Duration; import\torg.apache.spark.streaming.api.java.JavaInputDStream; import org.apache.spark.streaming.api.java.JavaStreamingContext; import\torg.apache.spark.streaming.kafka010.ConsumerStrategies; import\torg.apache.spark.streaming.kafka010.KafkaUtils; import\torg.apache.spark.streaming.kafka010.LocationStrategies;\n\nimport\tcom.google.gson.Gson;\n\npublic\tclass\tGeoLocationJob\t{\n\npublic\tstatic\tProducer<String,\tString>\tproducer;\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows\tException\t{ \t\t\t\tSparkConf\tconf\t=\tnew SparkConf().setAppName(\"geolocationJob\").setMaster(\"local[1]\"); \t\t\t\tJavaStreamingContext\tcontext\t=\tnew JavaStreamingContext(conf,\tnew\tDuration(2000));\n\nMap<String,\tObject>\tkafkaParams\t=\tnew\tHashMap<>(); \t\t\t\tkafkaParams.put(\"bootstrap.servers\", \"192.168.99.100:9092\"); \t\t\t\tkafkaParams.put(\"key.deserializer\", StringDeserializer.class); \t\t\t\tkafkaParams.put(\"value.deserializer\", StringDeserializer.class); \t\t\t\tkafkaParams.put(\"group.id\",\t\"geolocationJob\"); \t\t\t\tkafkaParams.put(\"auto.offset.reset\",\t\"latest\"); \t\t\t\tkafkaParams.put(\"enable.auto.commit\",\tfalse);\n\nCollection<String>\ttopics\t= Arrays.asList(\"geolocationJob\");\n\nfinal\tJavaInputDStream<ConsumerRecord<String,\tString>> dstream\t=\tKafkaUtils.createDirectStream \t\t\t\t\t\t\t\t\t(context, \t\t\t\t\t\t\t\tLocationStrategies.PreferConsistent(), \t\t\t\t\t\t\t\tConsumerStrategies.<String,\tString>Subscribe(topics, kafkaParams));\n\ndstream.map(new\tFunction<ConsumerRecord<String,String>, GeoLocation>()\t{\t//\tmap\tto\tGeoLocation \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -5289370913799710097L;\n\n@Override \t\t\t\t\t\tpublic\tGeoLocation\tcall(ConsumerRecord<String,\tString> record)\tthrows\tException\t{ \t\t\t\t\t\t\t\treturn\tnew\tGson().fromJson(record.value(), GeoLocation.class); \t\t\t\t\t\t} \t\t\t\t}).filter(new\tFunction<GeoLocation,\tBoolean>()\t{\t//\tfilter out\tinvalid\tgeolocations \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= 6980980875802694946L;\n\n@Override \t\t\t\t\t\tpublic\tBoolean\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\tSystem.out.println(\"Spark\tJob\treceived\t=>\t\"\t+ geolocation); \t\t\t\t\t\t\t\treturn\tgeolocation.getLatitude()\t>=\t-90 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLatitude()\t<\t90 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t>=\t-180 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t<\t180; \t\t\t\t\t\t} \t\t\t\t}).foreachRDD(new\tVoidFunction<JavaRDD<GeoLocation>>()\t{ //iterate\tover\tRDD \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -4161320579495422870L;\n\n@Override \t\t\t\t\t\tpublic\tvoid\tcall(JavaRDD<GeoLocation>\trdd)\tthrows Exception\t{ \t\t\t\t\t\t\t\trdd.foreach(new\tVoidFunction<GeoLocation>()\t{\t\t//\tsend valid\tgeolocations\tto\tanother\ttopic \t\t\t\t\t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -3282778715126743482L;\n\n@Override\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tvoid\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\t\t\t\t\t\t\tgetProducer().send(record); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}); \t\t\t\t\t\t} \t\t\t\t});\n\ncontext.start(); \t\t\t\tcontext.awaitTermination(); \t\t}\n\npublic\tstatic\tProducer<String,\tString>\tgetProducer()\t{ \t\t\t\tif(producer\t==\tnull)\t{ \t\t\t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName());\n\nproducer\t=\tnew\tKafkaProducer<>(props); \t\t\t\t} \t\t\t\treturn\tproducer; \t\t} }\n\n12.\t Without\tfurther\tado,\tlet's\ttest\tthis\tout.\tStart\tthe\tgeolocation\tmicroservice\ton port\t8080.\tThis\twill\tstart\tthe\tGeoLocationStreams\tas\twell\tas\tthe GeoLocationConsumer.\tNow\trun\tthe\tGeoLocationJob\tclass\tas\ta\tJava application.\tAfter\tboth\tthe\tgeolocation\tmicroservice\tand\tthe\tSpark\tjob\thave started\tsuccessfully,\tdrop\tsome\tmessages\ton\tthe\tgeolocationJob\ttopic.\tWe will\tbe\tutilizing\tthe\tGeoLocationProducer\tclass\tto\tdo\tthis.\tModify\tthe GeoLocationProducer\tclass\tto\tuse\tthe\tgeolocationJob\ttopic,\tand\texecute it\tas\ta\tJava\tapplication.\tThis\tshould\thave\tcreated\tnine\tgeolocations\ton\tthe geolocationJob\ttopic.\n\n13.\t Let's\ttake\ta\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tSpark\tjob\tfirst:\n\nAs\tyou\tcan\tsee,\tour\tSpark\tjob\treceived\tall\tthe\tmessages.\tThe\tpreceding screenshot\tdoes\tnot\tshow\tthem\tall,\tthough.\n\n14.\t Now\tlet's\ttake\ta\tlook\tat\tthe\tlog\tmessages\tof\tthe\tgeolocation\tmicroservice:\n\nAs\tyou\tcan\tsee,\tGeoLocationConsumer\treceived\tall\tthe\tgeolocations\twith valid\tlatitude\tand\tlongitude.\n\n15.\t Let's\tquickly\tverify\tthe\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommands\tto list\tthe\tcontents\tof\tthe\tdata\tdirectory:\n\nls\t-1\toptpackt/geolocation/data user2288ea0c-e3e7-453c-a31c-935210195df3_t1482514513790 user3669998e-b114-4714-813d-f8adf9cf4a12_t1482514513790 user45cd0dc9-df2e-4ec9-8f40-4cdd88f7e493_t1482514513790 user6beedc41-284a-4a6a-9e9c-5434768936a0_t1482514513790 usercaabf873-73b6-446d-a02d-c42ecce35d1b_t1482514513790\n\nAwesome!\tWe\thave\tcreated\tour\tfirst\tSpark\tjob.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis\n\nAwesome!\tWe\thave\tcreated\tour\tfirst\tSpark\tjob.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis recipe.\tSpark\thas\tso\tmuch\tto\toffer\tthat\tit\tcan\tbe\tapplied\tin\ta\tlot\tof\tuse\tcases. What\twe\tlearned\tin\tthis\trecipe\twas\tjust\tthe\tbeginning\tof\tSpark.\tIt\tis\tstrongly recommended\tthat\tyour\tlearn\tSpark\tbefore\tyou\ttry\tit\tout.\tIn\tfact,\tSpark's\tofficial documentation\tis\tvery\tdescriptive\tand\tuseful.\n\nImproving\tthe\tperformance\tof\tthe Spark\tjob\n\nIn\tthe\tprevious\trecipe,\twe\twrote\ta\tsimple\tSpark\tjob\tthat\tfilters\tout\tinvalid geolocations\tand\tpushes\tthe\tvalid\tgeolocations\tinto\ta\tKafka\ttopic.\tIn\tthis\trecipe, we\twill\tsee\thow\twe\tcan\timprove\tthe\tperformance\tof\tour\tSpark\tjob.\n\nHow\tto\tdo\tit...\n\nThere\tare\tseveral\tways\tin\twhich\tyou\tcan\timprove\tthe\tperformance\tof\tyour\tSpark job.\tThere\tare\ta\tlot\tmany\tconfigurations\tthat\tSpark\tprovides\tthat\tcan\tbe\ttweaked to\tachieve\tdesired\tperformance.\tFor\texample,\tbased\ton\tthe\tamount\tof\tdata\tthat your\ttopic\treceives,\tyou\tcould\tchange\tthe\tbatch\tduration\tof\tyour\tstream.\tAlso, deploying\tyour\tSpark\tjob\ton\ta\tMesos\tor\tYARN\tcluster\topens\tup\ta\tlot\tof opportunities\tfor\tperformance\timprovement.\tIn\tfact,\trunning\tyour\tSpark\tjob\tin local\tstandalone\tmode\twill\tnot\thelp\tyou\tassess\tthe\tperformance\tof\tyour\tSpark job.\tThe\treal\ttest\tfor\ta\tSpark\tjob\tis\twhen\tit\tis\texecuted\ton\ta\tcluster.\tEach\tSpark job\trequires\ta\tcertain\tamount\tof\tresources\tfor\texecution,\tbe\tit\tCPU\tor\tmemory.\n\nEarlier\tin\tthe\tbook,\twe\ttalked\tabout\tfine-grained\tand\tcoarse-grained\tmodes\tand how\tSpark\tutilizes\tthe\tresources\tin\tboth\tthese\tmodes.\tLikewise,\tthere\tare\tseveral other\tconfigurations\tthat\tcan\tbe\ttweaked\tto\tachieve\tthe\tdesired\tperformance.\n\nNow\tthat\twe\tare\ttalking\tabout\tdeployments,\tlet's\ttalk\tabout\twhether\tor\tnot\tthe Spark\tjob\tshould\tcoexist\talongside\tthe\tmicroservice.\tSpark\tjobs\tare\tbest executed\twithout\tother\tdependencies.\tSo\tit\tis\talways\tbetter\tto\trun\tthe\tSpark\tjob as\ta\tseparate\tdeployment.\tWhile\tthe\tGeoLocationJob\tclass\tcould\trun\ton\tMesos or\tYARN\tas\tits\town\ttask,\tthe\tgeolocation\tmicroservice\twill\trun\tas\ta\tDocker container\tin\tMarathon\tor\tYARN.\tSo\twe\thave\ttwo\tcomponents\tnow:\tAPI\tand Spark\tjob.\tThe\tSpark\tjob\tsends\tdata\tto\tthe\tAPI\tvia\ta\tKafka\ttopic.\tNow\tdo\tyou see\tthe\tvalue\tof\tKafka?\tMaking\tyour\tSpark\tjob\tsend\tdata\tvia\tthe\tAPI\twill\tslow down\tyour\tSpark\tjob.\tThat\tis\tthe\treason\twe\tchose\tto\tconsume\tmessages\tvia Kafka\ttopics\tin\tour\tgeolocation\tmicroservice.\n\nMost\tof\tthe\ttime,\tyou\tcan\tlook\tat\thow\tyour\tjob\tis\tperforming\tusing\tthe\tSpark web\tconsole\tat\thttp://localhost:4040.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tthe\tSpark\tJobs\tpage\tshows\ta\thigh-level\tmetric\tfor\teach operation\tin\tour\tSpark\tjob.\tIn\tthe\tpreceding\tscreenshot,\tit\tshows\tmetrics\tfor\tthe foreach\toperations\tin\tour\tSpark\tjob.\tClicking\ton\teach\tforeach\tjob\twill\tshow more\tdetails\tabout\tit,\tsuch\tas\tEvent\tTimeline\tand\tDAG\tvisualization.\tNow\tlet's take\ta\tquick\tlook\tat\tthe\tStreaming\ttab:\n\nThe\tStreaming\ttab\tprovides\tbetter\tinsights\tinto\tthe\tstreaming\tframework.\tThe current\tversion\tof\tSpark\tprovides\tmetrics\tsuch\tas\tInput\tRate,\tScheduling Delay,\tProcessing\tTime,\tand\tTotal\tDelay.\tThough\tthere\tis\tnot\tmuch\tdata\tto make\tsense\tout\tof\tthese\tcharts\tand\thistograms\tin\tour\tuse\tcase,\twhen\tyou\tare dealing\twith\thuge\tdatasets,\tthese\tmonitoring\ttools\twill\tbe\tvery\tuseful.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tAs\talready\tmentioned,\tApache\tSpark\tis\ta huge\tlibrary\tand\tit\ttakes\ttime\tto\tmaster\tit.\tI\tstrongly\trecommend\tthat\tyou\tread about\tit\tfrom\ttheir\tdocumentation\tbefore\tusing\tit.\n\nAggregating\tlogs\tinto\tKafka\tusing Log4J\n\nLog\tmanagement\tis\ta\tcritical\tpart\tof\tany\tmicroservice\tdeployment.\tWhen\tit comes\tto\tdebugging\tyour\tapplication,\tthe\ttwo\tthings\tthat\tmatter\ta\tlot\tare\tlogs and\tmetrics.\tWe've\talready\tlearned\thow\tto\tuse\tmetrics\tto\tmonitor\tour application,\tand\tin\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconsolidate\tour\tlogs.\tLogs can\tbe\tstored\tin\tplenty\tof\tstores.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tstore\tour logs\tin\ta\tKafka\ttopic.\tOnce\twe\tget\tour\tlog\tmessages\tin\ta\tKafka\ttopic,\twe\tcan use\tLog\tManagement\ttools\tto\tmake\tsome\tsense\tout\tof\tit.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tconfiguring\tthe\tgeolocation\tmicroservice\tto\tsend\tlog messages\tover\tto\ta\tKafka\ttopic\tcalled\tgeolocationLogs.\n\nLet's\tget\tready\tby\tcreating\tthe\ttopic\tin\tKafka.\tIf\tyou\tdon't\thave\tKafka\tup\tand running,\trun\tit\tusing\tDocker\tCompose.\n\nOpen\ta\tnew\tterminal\tshell\tand\tnavigate\tto\tthe\thome\tdirectory\tof\tKafka.\tExecute the\tfollowing\tcommand:\n\n./bin/kafka-topics.sh\t--create\t--topic\tgeolocationLogs\t-- replication-factor\t1\t--partitions\t1\t--zookeeper\t192.168.99.100:2181\n\nHow\tto\tdo\tit...\n\nThe\teasiest\tway\tto\tsend\tour\tlog\tmessages\tto\tKafka\tis\tusing\ta\tlog\tappender.\tA log\tappender\tis\ta\tutility\tin\tany\tlogging\tframework\tthat\tknows\thow\tto\tsend messages\tto\ta\tspecific\tdestination.\tSimilarly,\ta\tKafka\tappender\tknows\thow\tto send\tlog\tmessages\tto\ta\tKafka\ttopic.\tTo\tmake\tit\tsimpler,\tlet's\ttry\tto\tuse\tthe underlying\tlogging\tframework\tof\tSpring\tBoot.\tBy\tdefault,\tSpring\tBoot\tuses logback.\tAt\tthe\ttime\tof\twriting\tthis,\tit\tis\tnot\tvery\teasy\tto\tconfigure\tlogback\twith a\tKafka\tappender.\tBut\tLog4J2\tcomes\twith\ta\tKafka\tappender\tout\tof\tthe\tbox. Let's\tsee\thow\tto\tuse\tKafka\tappender\twith\tLog4J2\tin\tour\tSpring\tBoot\tapp.\tIf\tyou are\tnot\tusing\ta\tSpring\tBoot\tapp,\tthen\tit\tis\treal\tsimple.\tAll\tyou\thave\tto\tdo\tis\tadd the\tlog4j2\tdependency\tand\tstart\tconfiguring\tthe\tKafka\tappender.\tHowever,\tin this\trecipe,\twe\twill\tbe\tlearning\thow\tto\tdo\tit\ton\ta\tSpring\tBoot\tapp\tas\tit\tis\ta\tlittle tricky.\n\n1.\t The\tfirst\tthing\twe\tneed\tto\tdo\tis\tconfigure\tour\tapp\tto\tuse\tLog4J2\tinstead\tof Logback.\tAdd\tthe\tfollowing\ttwo\tdependencies\tto\tthe\tpom.xml\tfile\tof\tthe geolocation\tproject: <dependency> \t\t<groupId>org.springframework.boot</groupId> \t\t<artifactId>spring-boot-starter</artifactId> \t\t<exclusions> \t\t\t\t<exclusion> \t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t<artifactId>spring-boot-starter-logging</artifactId> \t\t\t\t</exclusion> \t\t</exclusions> </dependency>\n\n<dependency> \t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t<artifactId>spring-boot-starter-log4j2</artifactId> </dependency>\n\nAs\tyou\tcan\tsee,\twe\thave\texcluded\tthe\tbasic\tspring-boot-starter- logging\tdependency\tand\tadded\tthe\tspring-boot-starter-log4j2 dependency.\tThis\twill\tintroduce\tlog4j2\tinto\tthe\tproject.\n\n2.\t The\tSpark\tdependencies\tusually\thave\tslf4j-log4j12\tbindings.\tIn\torder\tto use\tlog4j2\twe\tneed\tto\tremove\tthe\tslf4j-log4j12\tbindings.\tGo\tahead\tand exclude\tthis\tartifact\tfrom\tkafka-streams,\tspark-core_2.11\tand\tspark-\n\nstreaming-kafka-0-10_2.11:\n\n<dependency> \t\t\t<groupId>org.apache.kafka</groupId> \t\t\t<artifactId>kafka-streams</artifactId> \t\t\t<version>0.10.1.0</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n<dependency> \t\t\t<groupId>org.apache.spark</groupId> \t\t\t<artifactId>spark-core_2.11</artifactId> \t\t\t<version>2.0.2</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n<dependency> \t\t\t<groupId>org.apache.spark</groupId> \t\t\t<artifactId>spark-streaming-kafka-0-10_2.11</artifactId> \t\t\t<version>2.0.2</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n3.\t Now\tlet's\tadd\tthe\tlog4j2.xml\tconfig\tfile\tto\tthe\tsrc/main/resources directory.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tlog4j2.xml\tfile:\n\n<?xml\tversion=\"1.0\"\tencoding=\"UTF-8\"?>\t <Configuration\tstatus=\"INFO\">\t \t\t<Appenders>\t \t\t\t\t<Console\tname=\"Console\"\ttarget=\"SYSTEM_OUT\">\t \t\t\t\t\t\t<PatternLayout\tpattern=\"%d{HH:mm:ss.SSS}\t[%t]\t%-5level\n\n%logger{36}\t-\t%msg%n\"\t>\t \t\t\t\t<Console>\t \t\t\t\t<Kafka\tname=\"Kafka\"\ttopic=\"geolocationLogs\">\t \t\t\t\t\t\t<PatternLayout\tpattern=\"%date\t%message\"\t>\t \t\t\t\t\t\t<Property\t name=\"bootstrap.servers\">192.168.99.100:9092<Property>\t \t\t\t\t</Kafka>\t \t\t</Appenders>\n\n<Loggers>\t \t\t\t\t<Root\tlevel=\"INFO\">\t \t\t\t\t\t\t<AppenderRef\tref=\"Console\"\t/>\t \t\t\t\t\t\t<AppenderRef\tref=\"Kafka\"\t>\t \t\t\t\t<Root>\t \t\t\t\t<Logger\tname=\"org.apache.kafka\"\tlevel=\"ERROR\"\t>\t<!--\tavoid\t recursive\tlogging\t-->\t \t\t\t\t<Loggers>\t </Configuration>\n\n4.\t The\tconfiguration\tis\tpretty\tstraightforward.\tAll\twe\thave\tto\tdo\tis\tadd\tthe Kafka\tappender\tand\tdefine\tthe\tbootstrap.servers\tproperty\twith\tthe\tKafka broker\tURL.\tThe\tlogger\tfor\tthe\torg.apache.kafka\tpackage\tis\tset\tto\tERROR to\tmake\tsure\twe\tavoid\trecursive\tlogging.\n\nThat's\tit!\tWe\thave\tconfigured\ta\tKafka\tappender\tfor\tLog4J2\tto\tsend\tour\tlog messages\tto\tthe\tgeolocationLogs\tKafka\ttopic.\tWe\tare\tnow\tready\tto\ttest\tthis out.\tIn\torder\tto\tdo\tso,\twe\tneed\ta\tKafka\tconsumer\tthat\tcan\tconsume\tmessages from\tthe\tgeolocationLogs\ttopic.\tLet's\tutilize\tthe\tcommand-line\tconsole consumer\tto\tperform\tthis\ttask.\tOpen\tup\ta\tnew\tterminal\twindow\tand\tnavigate\tto the\thome\tfolder\tof\tyour\tKafka\tinstallation.\tExecute\tthe\tfollowing\tcommand:\n\n./bin/kafka-console-consumer.sh\t--topic\tgeolocationLogs\t--zookeeper\t 192.168.99.100:2181\n\nNow\tthat\tour\tconsumer\tis\tready,\tlet's\tstart\tthe\tgeolocation\tmicroservice\tas\ta Spring\tBoot\tapplication\tand\tkeep\tan\teye\ton\tthe\tconsumer\tlogs:\n\nAs\tyou\tcan\tsee,\tall\tour\tlog\tmessages\tare\tnow\tdirected\tto\tthe\tgeolocationLogs topic\tin\taddition\tto\tthe\tconsole.\tNow,\tit\tis\tup\tto\tus\tto\tuse\tthese\tlog\tmessages\tin the\ttool\tof\tour\tchoice.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tGood\tluck\tlogging\twith\tKafka!\n\nIntegrating\tKafka\twith\tlog management\tsystems\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tconsolidate\tlog\tmessages\tfrom microservices\tinto\ta\tKafka\ttopic\tusing\tLog4J2\tand\tKafka.\tIn\tthis\trecipe,\twe\twill look\tat\tvarious\toptions\tthat\twe\thave\tto\tvisualize\tour\tlogs.\tThere\tare\tseveral\tlog- management\tsystems\tavailable\tin\tthe\tmarket\tat\tthe\tmoment.\tWe\twill\ttalk\tabout few\tof\tthem\tin\tthis\trecipe.\n\nHow\tit\tworks...\n\nThere\tare\tseveral\tlog-management\ttools,\tsuch\tas\tSplunk,\tGraylog2,\tand\tLoggly. Most\tof\tthem\tnowadays\tcome\twith\ta\tKafka\tlistener.\tHowever,\tat\tthe\ttime\tof writing\tthis,\tSplunk\tdoes\tnot\thave\tan\tofficial\tKafka\tconsumer.\tThere\tare\tseveral third-partly\tplugins\tthat\tyou\tcan\tinstall\twith\tSplunk\tto\tconsume\tmessages\tfrom Kafka\ttopics.Graylog2\tis\tanother\tpopular\tlog-management\ttool\tthat\thas\tpicked up\ttraction\tlately\tmostly\tbecause\tit\tis\topen\tsource.\tIt\tcomes\tpacked\twith\ttons\tof features.\tThough\tthe\tinterface\tis\tnot\tvery\tsophisticated,\tit\tgets\tthe\tjob\tdone\twell. Graylog\tcame\twith\ttheir\town\tlog\tformat\tcalled\tGraylog\tExtended\tLog\tFormat (GELF)\tto\taddress\tthe\tpain\tpoints\tin\tregular\tlog\tformats.\tGraylog\thas\tofficial support\tto\tconsume\tmessages\tfrom\ta\tKafka\ttopic.\tFor\tmore\tinformation\ton\thow to\tconfigure\tGraylog\twith\tKafka,\tlook\tat\ttheir\tdocumentation\tpage\tat http://docs.graylog.org\t.\n\nThe\tother\tway\tof\timplementing\tyour\town\tlog-management\tsystem\tis\tusing\tthe ELK\tstack.\tELK\tstands\tfor\tElasticsearch,\tLog\tStash,\tand\tKibana.\tYou\tcan write\tyour\town\tmicroservice\tto\tbridge\tmessages\tfrom\tthe\tKafka\ttopic\tover\tto Log\tStash.\tThere\tare\tseveral\ttutorials\tout\tthere\tto\tset\tup\tthe\tELK\tstack.\tWe\twill not\tbe\tcovering\tthem\tas\tit\tis\tout\tof\tscope\tfor\tthis\tbook.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\tchapter,\twe\tlearned\thow\tto\tuse Kafka\tin\ta\tmicroservice\tecosystem.\tLater,\twe\tlooked\tat\thow\tApache\tSpark\tcan be\tused\tso\tstream\tmessages\tfrom\tKafka.\tFinally,\twe\thad\ta\tlook\tat\tlog management.\tGood\tluck\tstreaming!\n\nChapter\t8.\tMore\tClustering Frameworks\t-\tDC/OS,\tDocker Swarm,\tand\tYARN\n\nIn\tthis\tchapter,\twe\twill\tlook\tat\tthe\tfollowing\trecipes:\n\nDeploying\tinfrastructure\twith\tDC/OS Deploying\tcontainers\twith\tDocker\tSwarm Deploying\tcontainers\ton\tYARN",
      "page_number": 434
    },
    {
      "number": 8,
      "title": "More\tClustering Frameworks\t-\tDC/OS,\tDocker Swarm,\tand\tYARN",
      "start_page": 488,
      "end_page": 506,
      "detection_method": "regex_chapter_title",
      "content": "Introduction\n\nIn\tthe\tprevious\tchapters\tof\tthis\tbook,\twe\tlearned\thow\tto\tuse\tframeworks\tsuch\tas Mesos\tand\tKubernetes\tto\tperform\tdeployments.\tThere\tare\tmany\tsuch frameworks\tlike\tHashicorp\tNomad,\tLightbend\tLagom,\tMesosphere\tDC/OS, Docker\tSwarm,\tand\tYARN\tthat\tcan\tbe\tutilized\tto\tdeploy\tand\tmanage microservices.\tIn\tthis\tchapter,\tyou\twill\tbe\tintroduced\tto\tthree\tof\tthese frameworks.\tThe\tgoal\tof\tthis\tchapter\tis\tto\tgive\tyou\ta\theads-up\tof\tthese frameworks\tand\ttheir\tcapabilities.\tI\twill\talso\thelp\tyou\tby\tlisting\tdown\tsome tools\tthat\twill\tbe\thandy\twhen\tdeploying\tyour\tmicroservices\ton\tthese frameworks.\tOf\tcourse,\tthere\tare\tother\tsimilar\tframeworks\tin\tthe\tmarket\tthat help\twith\tmanaging\tmicroservices.\tPlease\tfeel\tfree\tto\tchoose\ta\tframework\tthat fits\tyour\tneeds\tand\tgo\tfrom\tthere.\n\nDeploying\tinfrastructure\twith\tDC/OS\n\nDC/OS\tstands\tfor\tDatacenter\tOperating\tSystem.\tDC/OS\tis\tbuilt\tand maintained\tby\tMesosphere.\tMesosphere\toffers\tan\topen\tsource\tversion\tof DC/OS,\tas\twell\tas\tan\tenterprise\tversion.\tYou\tcan\tthink\tof\tDC/OS\tas\tan enterprise-ready\tversion\tof\tMesos\twith\tsophisticated\tfeatures\tand\ta\tcollection\tof installable\ttools\tand\tframeworks.\tOne\tof\tthe\ttrickiest\tparts\tof\tmanaging\tyour own\tMesos\tcluster\tis\torchestrating\tthe\tframeworks.\tDC/OS\thas\tmade\tthis\ttask much\teasier\twith\tits\tcommand-line\tinterface.\tYou\tcould\tpotentially\tinstall\tthe DC/OS\tCLI\ton\tyour\tlocal\tcomputer\tand\tmanage\tany\tremote\tDC/OS\tcluster. Using\tthe\tCLI,\tyou\tcan\tinstall\tMarathon,\tsubmit\tDocker\tcontainers,\tand\tso\ton. In\tthis\trecipe,\twe\twill\tbe\tgoing\tover\tthe\tDC/OS\tinterface\tto\tunderstand\tits features\tand\tcapabilities.\n\nGetting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\torchestrating\ta\tDC/OS\tcluster\ton\tAWS\tand\tthen\twe will\tgo\tover\tthe\tbasics\tof\tDC/OS.\tThere\tare\tseveral\tways\tyou\tcan\torchestrate\ta DC/OS\tcluster:\tusing\tVagrant,\tusing\tAWS,\tand\tso\ton.\tUsing\tVagrant,\tyou\tcan spin\toff\ta\tminimal\tcluster\tthat\tyou\tcan\tuse\tfor\tlocal\tdevelopment\ttesting.\tIn\tthis recipe,\twe\thave\torchestrated\ta\treal\tDC/OS\tcluster\ton\tAWS.\tThe\tinstructions\ton the\tDC/OS\twebsite\tfor\torchestrating\tDC/OS\ton\tAWS\tis\tvery\teasy\tbecause\tit uses\tAWS\tCloudFormation.\tAWS\tCloudFormation\tis\tnothing\tbut\tInfrastructure as\tCode.\tYou\twill\tbe\tdescribing\tyour\tinfrastructure\tusing\tCloudFormation templates,\twhich\tcan\tlater\tbe\tused\tfor\torchestration\ton\tAWS.\tYou\tcan\tlearn more\tabout\tCloudFormation\tat http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/GettingStarted.html .\tFortunately,\tMesosphere\twas\tkind\tenough\tto\tcreate\tthese\tCloudFormation scripts\tfor\tus.\tSo\tspinning\toff\ta\tDC/OS\tcluster\tusing\tCloudFormation\tjust\ttakes a\tbutton\tclick\tand\twill\tbe\tdone\tin\tminutes.\tFor\tmore\tinformation,\ttake\ta\tlook\tat https://dcos.io\t.\n\nHow\tto\tdo\tit...\n\nIf\tyou\tfollow\tthe\tinstallation\tinstructions\ton\tthe\tDC/OS\twebsite\tfor\tinstalling DC/OS\ton\tAWS,\tyou\twill\tbe\table\tto\tland\ton\tthe\tDC/OS\tweb\tinterface.\tIn\tthis recipe,\twe\thave\torchestrated\tthe\tsingle\tmaster\tand\tfive\tslave\tcluster.\tIf\tyou would\tlike\tto\tpick\ta\tdifferent\tconfiguration,\tplease\tfeel\tfree\tto\tdo\tso.\tOnce\tthe orchestration\tis\tdone,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tit\tprovides\thigh-level\tresource\tallocation\tand\tusage\tdetails\tof the\tcluster.\tThe\tcluster\tin\tthe\tscreenshot\tsays\tthat,\tout\tof\t24\tCPUs\tonly\ttwo\tof them\tare\tused.\tThe\ttwo\tof\tthem\tare\tused\tby\tthe\tMarathon\tpackage\tthat\twas installed\ton\tthis\tcluster.\tBy\tdefault,\tthe\tcluster\twill\tnot\thave\tany\tpackages\tor services\trunning.\tYou\tcan\tinstall\tthem\tfrom\tthe\tuniverse\tof\tpackages\tavailable for\tinstallation.\tThey\tcan\talso\tbe\tinstalled\tfrom\tthe\tDC/OS\tcommand-line interface.\tOur\tcluster\thas\t82\tGB\tof\tmemory,\tout\tof\twhich\t2\tGB\tis\tbeing allocated\tto\tMarathon.\tSimilarly,\tour\ttotal\tdisk\tspace\tof\t208\tGB\tremains\tunused. The\tdashboard\tpage\tprovides\tmore\tmetrics,\tsuch\tas\tnode\tcount\tand\ttask\tcount. As\tI've\talready\tmentioned,\tthis\tcluster\thas\tone\tmaster\tand\tfive\tslaves,\tso\tyou should\tsee\tthat\tthere\tare\tsix\tnodes\tin\ttotal.\tIf\tyou\tnavigate\tto\tthe\tNodes\ttab,\tthen you\twill\tsee\tthe\tlist\tof\tall\tnodes\tand\ttheir\tresource\tutilization.\tThere\tare\ttwo views\tthat\tyou\tcan\tutilize\tin\tthe\tNodes\ttab:\tGrid\tand\tList.\tThe\tList\tview\tis\ta traditional\tlist-based\tview.\tHowever,\tthe\tGrid\tview\tis\tinteresting\tbecause\tit displays\tthe\tnodes\tin\tthe\tform\tof\tcircles\twith\tthe\tCPU\tutilization\tpercent\tin them.\tThe\tmost\tamazing\tpart\tabout\tthese\twidgets\tis\tthat\tthey\tget\tupdated\treal- time.\tAlso,\tthe\tcircles\tare\tcolor-coded\tbased\ton\tthe\tservice\tthat\tutilizes\tthe\n\nresources\ton\tthat\tnode:\n\nThe\tpreceding\tfigure\tillustrates\tthe\tgrid\tview\tof\tthe\tnodes.\tYou\tcan\tsee\tthat\tthe last\tnode\tuses\t50\tpercent\tof\tits\tCPU,\twhich\tis\tbeing\tutilized\tby\tMarathon.\tThe List\tview\tlooks\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tin\tthe\tList\tview,\tyou\tcan\tsee\tthe\tactual\tIPs\tof\tthe\tslave\tnodes and\ttheir\thealth\tstatus,\ttask\tcount,\tCPU\tutilization,\tmemory\tutilization,\tand\tdisk space\tutilization.\n\nTASKS\tare\tnothing\tbut\tMesos\ttasks.\tDC/OS\tis\tbacked\tby\ta\tMesos\tcluster.\tSo any\ttask\tthat\tis\tbeing\tsubmitted\tto\tthis\tDC/OS\tcluster\tis\tactually\tsubmitted\tto\tthe backing\tMesos\tcluster.\tThe\tservices\tand\tpackages\tthat\tcan\tbe\tinstalled\ton DC/OS\tcan\tbe\tviewed\tfrom\tthe\tUniverse\ttab.\tThe\tUniverse\tis\ta\tpackage manager\tfor\tDC/OS,\twhere\tyou\tcan\tfind\tall\tthe\tpackages\tand\tservices\tthat\tyou can\tinstall\ton\tDC/OS.\tKafka,\tCassandra,\tMarathon,\tand\tArangoDB\tare\ta\tfew\tof\n\nthe\tpackages\tthat\tyou\tcan\tinstall\ton\tDC/OS:\n\nAll\tit\ttakes\tto\tinstall\ta\tpackage\tis\tto\thit\tthe\tInstall\tPackage\tbutton,\tor\tif\tyou would\tlike\tto\tuse\tthe\tDC/OS\tCLI,\tthen\tit\tjust\ttakes\tone\tcommand\tto\tinstall packages.\tThe\tnewer\tversion\tof\tDC/OS\thas\tthe\tability\tto\tspin\toff\ttasks\tfrom\tthe UI.\tPreviously,\tin\torder\tto\tspin\toff\ttasks,\tyou\thad\tto\tuse\ta\tCLI\tcommand.\tThe true\tpower\tof\tDC/OS\tis\tthe\tability\tto\tview\ta\tcluster\tof\tsix\tnodes\tas\tone\tsingle machine\tand\tbeing\table\tto\tutilize\tresources\tin\ta\tvery\tgranular\tmanner.\n\nNow\tlet's\tcome\tto\tthe\treal\tusage\tof\tDC/OS\tin\tour\tcontext:\tmicroservices.\tWe know\tthat\tmicroservices\tby\tthemselves\tcannot\twork\talone;\tthey\tneed\tto\twork together\twith\tother\ttools\tsuch\tas\tSpark,\tKafka,\tConsul,\tand\tZookeeper.\tOne good\treason\tfor\tusing\tDC/OS\tis\tbeing\table\tto\tmanage\tthem\tall\tunder\tone\troof: Marathon,\tload\tbalancer,\tdatabases,\tmiddleware,\tand\tso\ton.\tThere\tare\tseveral packages\tin\tthe\tDC/OS\tUniverse\tthat\tcan\thelp\tus,\tincluding\tdatabases, middleware,\tand\teven\tmicroservice-management\ttools\tsuch\tas\tVAMP.\tIf\tyou would\tlike\tto\tgo\twith\tDC/OS,\ttake\tsome\ttime\tto\tgo\tover\tthe\tlist\tof\tpackages\tand services\tthat\tare\tavailable\tin\tthe\tUniverse.\tThat\tway,\tyou\twill\tknow\twhether your\tarchitecture\tcan\tbe\tmanaged\twith\tDC/OS\tor\tnot.\tOne\tscenario\twhere\tyou might\tnot\tbe\table\tto\tget\tthe\tmost\tout\tof\tDC/OS\tis\twhen\tyou\tare\ton\tthe\tHadoop Ecosystem.\tAt\tthe\ttime\tof\twriting\tthis,\tDC/OS\thas\tminimal\tsupport\tfor\tusing Hadoop.\tDC/OS\thas\ta\tframework\tfor\tHDFS.\tBut\tif\tyou\tare\talready\ton\tthe Hadoop\tPlatform\tand\tuse\tlot\tof\tits\tcomponents,\tyou\tmight\tnot\tbe\table\tto\tmigrate them\tall\tover\tto\tDC/OS.\n\nthem\tall\tover\tto\tDC/OS.\n\nBy\tnow,\tyou\twill\teither\tbe\tvery\texcited\tto\tlearn\tmore\tabout\tDC/OS\tor\tyou\twill have\tmore\tquestions\tabout\tDC/OS.\tEither\tways,\tit\tis\tstrongly\trecommended\tthat you\tgo\tover\tDC/OS\tand\tits\tdocumentation\tbefore\tusing\tit\tin\tproduction.\tWith that\tsaid,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tSo\tfar\tin\tthis\trecipe,\twe've\tseen\tthat DC/OS\tis\ta\tsophisticated\tcluster-management\tplatform\tthat\tnot\tonly\thelps\tus with\tmicroservice\tdeployments\tbut\talso\tmanages\tour\twhole\tinfrastructure.\tIn\tthe next\trecipe,\tyou\twill\tlearn\tmore\tabout\tDocker's\tclustering\tframework,\tcalled Docker\tSwarm.\n\nDeploying\tcontainers\twith\tDocker Swarm\n\nDocker\tSwarm\tis\tDocker's\tsolution\tto\tclustering\tmultiple\tDocker\tengines\tinto one\tcluster.\tIf\tyour\torganization\tis\theavily\treliant\ton\tDocker\tand\tDocker containers,\tit\tmight\tbe\tworth\tlooking\tat\tDocker\tSwarm.\tWhen\tyou\thave\tseveral Docker\tinstallations\tthat\tyou\tmaintain\ton\tseparate\tDocker\thosts,\tthen\tthese Docker\thosts\twill\tbe\tgrouped\ttogether\tas\ta\tcluster\tusing\tDocker\tSwarm.\tDocker Swarm\tbrings\tin\ta\twhole\tlot\tof\tfeatures\tthat\twill\thelp\tmanage\tyour\tapps\ton\ta Swarm\tcluster.\tAnother\tgreat\tadvantage\tof\tusing\tDocker\tSwarm\tis\tthat\tsince\tit uses\tthe\tDocker\tAPI,\tworking\twith\ta\tSwarm\tcluster\tis\tno\tdifferent\tthan\tworking with\ta\tDocker\tdaemon.\tSo\ttools\tsuch\tas\tShipyard\tstill\tcontinue\tto\twork\twith Docker\tSwarm.\tWe\twill\tlook\tat\tShipyard\tlater\tin\tthis\trecipe.\n\nGetting\tready\n\nAt\tthis\tmoment,\tthe\teasiest\tway\tto\torchestrate\ta\tDocker\tSwarm\tcluster\tlocally\tis by\tusing\tdocker-machine\tinstances.\tBefore\tyou\tstart\tthe\tDocker\tSwarm\tcluster, let's\tfamiliarize\tourselves\twith\tsome\tconcepts\tof\tDocker\tSwarm.\n\nDocker\tSwarm\tcomprises\ttwo\ttypes\tof\tnodes:\tmanager\tand\tagent.\tA\tmanager\tis responsible\tfor\tscheduling\tcontainers\tand\tmanaging\tthe\tcluster.\tAn\tagent\tis\tthe node\twhere\tthe\tcontainers\tare\trun.\tThere\tcan\tbe\tseveral\tmanagers\tand\tagents, depending\ton\tthe\ttype\tof\tarchitecture\tyou\trequire.\tIn\tour\trecipe,\twe\twill\tcreate\ta Docker\tSwarm\tcluster\twith\tone\tmanager\tand\tone\tagent.\tSo\tstart\ttwo\tterminal sessions:\tone\tfor\tthe\tmanager\tand\tthe\tother\tfor\tthe\tagent.\n\nHow\tto\tdo\tit... 1.\t The\tfirst\tstep\ttoward\tcreating\tthe\tSwarm\tcluster\tis\tcreating\tdocker-\n\nmachine\tinstances\tfor\tthe\tnodes\tthemselves.\tLet's\tcreate\tour\tmanager\tfirst. In\tthe\tterminal\tsession\tdedicated\tfor\tthe\tmanager,\tissue\tthe\tfollowing command:\tdocker-machine\tcreate\t--driver\tvirtualbox\tmanager\t&&\teval $(docker-machine\tenv\tmanager)\n\nThis\tcommand\tstarts\tthe\tnew\tVM\tand\tsets\tthe\tenvironment\tvariables.\tAlso stop\tany\tdocker-machine\tinstances\tthat\tare\tnot\tbeing\tused,\tin\torder\tto\tfree up\tsome\tresources.\n\n2.\t Once\tyour\tterminal\tsession\tis\tready,\tgo\tahead\tand\tSSH\tinto\tthe\tVM\tusing the\tfollowing\tcommand:\tdocker-machine\tssh\tmanager\n\nYou\tshould\tnow\tbe\tlogged\tin\tto\tthe\tVM\tas\tthe\tdocker\tuser.\tHereafter,\twe will\tbe\tusing\tsome\tdocker\tswarm\tcommands.\n\n3.\t First,\twe\tneed\tto\tinitiate\ta\tnew\tcluster.\tFor\tthat\twe\twill\tneed\tthe\tIP\tof\tthis Docker\tmachine\tinstance.\tUse\tthe\tdocker-machine\tip\tmanager\tcommand to\tfind\tthe\tIP\tof\tthis\tinstance.\tIn\tmy\tcase\tthe\tIP\twas\t192.168.99.100.\tNow go\tahead\tand\tissue\tthe\tfollowing\tcommand\ton\tthe\tsame\tterminal: docker@manager:~$\tdocker\tswarm\tinit\t--advertise-addr 192.168.99.100\tSwarm\tinitialized:\tcurrent\tnode (93h99zo91q7o8cvc0s3pvlwvu)\tis\tnow\ta\tmanager\tTo\tadd\ta\tworker\tto this\tswarm,\trun\tthe\tfollowing\tcommand:\tdocker\tswarm\tjoin\t\\\t--token SWMTKN-1- 1xd50ogywv31v4dmcg70tu15xqt7opsqds3qhe0zu8dp856krl- arslqq0p4qhd85uj2qze4ei5q\t\\\t192.168.99.100:2377\tTo\tadd\ta\tmanager to\tthis\tswarm,\trun\tdocker\tswarm\tjoin-token\tmanager\tand\tfollow\tthe instructions.\n\n4.\t We\thave\tsuccessfully\tset\tup\tour\tmanager\tand\tinitiated\ta\tnew\tSwarm cluster.\tThe\tresult\tof\tthe\tprevious\tcommand\tactually\tgave\tus\tthe\tcommand that\twe\tneed\tto\texecute\tfrom\tthe\tagent\tnode\tto\tjoin\tthis\tcluster.\tBefore\twe move\ton,\tlet's\tquickly\tverify\twhether\tour\tmanager\twas\tcreated\tcorrectly\tby listing\tall\tthe\tnodes\tparticipating\tin\tthis\tcluster:\tdocker@manager:~$ docker\tnode\tls\tID\tHOSTNAME\tSTATUS\tAVAILABILITY MANAGER\tSTATUS\t93h99zo91q7o8cvc0s3pvlwvu\t*\tmanager\tReady Active\tLeader\n\n5.\t There\tis\tjust\tone\tnode\tin\tour\tcluster\tthat\tacts\tas\tthe\tLeader.\tThe\tnext\tstep\tis to\tadd\ta\tnew\tagent\tnode\tto\tthis\tcluster.\tNow\tmove\ton\tto\tthe\tnext\tterminal window\tthat\twas\tdedicated\tfor\tour\tagent.\tWe\tare\tgoing\tto\tcall\tthis\tnode worker.\tGo\tahead\tand\tcreate\tthis\tnew\tVM\tfirst:\tdocker-machine\tcreate\t-- driver\tvirtualbox\tworker\t&&\teval\t$(docker-machine\tenv\tworker) This\tcommand\tstarts\tthe\tnew\tVM\tand\tsets\tthe\tenvironment\tvariables. 6.\t Once\tyour\tterminal\tsession\tis\tready,\tgo\tahead\tand\tSSH\tinto\tthe\tVM\tusing\n\nthe\tfollowing\tcommand:\tdocker-machine\tssh\tworker\n\n7.\t Let's\tissue\tthe\tdocker\tswarm\tjoin\tcommand\tthat\twe\treceived\tas\toutput when\twe\tinitiated\tthe\tcluster\ton\tthe\tmanager:\tdocker@worker:~$\tdocker swarm\tjoin\t\\\t>\t--token\tSWMTKN-1- 1xd50ogywv31v4dmcg70tu15xqt7opsqds3qhe0zu8dp856krl- arslqq0p4qhd85uj2qze4ei5q\t\\\t>\t192.168.99.100:2377\tThis\tnode\tjoined\ta swarm\tas\ta\tworker.\n\n8.\t We\thave\tsuccessfully\tset\tup\tour\tagent.\tNow\tgo\tback\tto\tthe\tmanager terminal\tsession\tand\texecute\tdocker\tnode\tls\tto\tverify\twhether\tthere\tare two\tnodes\tin\tthe\tcluster\tnow.\tYou\tshould\treceive\tsomething\tlike\tthis:\tID HOSTNAME\tSTATUS\tAVAILABILITY\tMANAGER\tSTATUS 3i78zp35bxmioy3dvdfmui3gv\tworker\tReady\tActive 93h99zo91q7o8cvc0s3pvlwvu\t*\tmanager\tReady\tActive\tLeader\n\nThat's\tit!\tYou\thave\tsuccessfully\torchestrated\ta\tminimal\tdocker\tswarm cluster.\n\n9.\t Our\tnext\tstep\twould\tbe\tspinning\toff\tour\tgeolocation\tservice\ton\tthis\tcluster. Without\tany\tfurther\tdelay,\texecute\tthe\tfollowing\tcommand\tto\tstart\tthe geolocation\tservice\ton\tthe\tcluster:\tdocker\tservice\tcreate\t--replicas\t2\t-- name\tgeolocation\tvikrammurugesan/geolocation\n\nThis\tcommand\tsays\tthat\twe\twould\tlike\tto\tstart\ttwo\tcontainers\tfor\tthe\timage vikrammurugesan/geolocation\twith\tthe\tservice\tname\tgeolocation. 10.\t To\tlist\tdown\tall\tthe\tservices\trunning\tin\tthe\tcluster,\texecute\tthe\tfollowing\n\ndocker\tservice\tcommand:\tdocker\tservice\tps\tgeolocation\tID\tNAME IMAGE\tNODE\tDESIRED\tSTATE\tCURRENT\tSTATE\tERROR 46zzwpszqfqvmmmqz0tx8rgo3\tgeolocation.1 vikrammurugesan/geolocation\tmanager\tRunning\tPreparing\tabout\ta minute\tago\t9ppgezl20vme1p6fi4ko7mui1\tgeolocation.2 vikrammurugesan/geolocation\tworker\tRunning\tPreparing\tabout\ta\n\nminute\tago\n\n11.\t If\tyou\twould\tlike\tto\tknow\tmore\tabout\tyour\tservice,\tyou\tcould\tuse\tthe inspect\tcommand\tto\tdo\tso:\tdocker\tservice\tinspect\t--pretty\tgeolocation ID:\t68jy7i3vwe88c2a797jri6anv\tName:\tgeolocation\tMode:\tReplicated Replicas:\t2\tPlacement:\tUpdateConfig:\tParallelism:\t1\tOn\tfailure:pause ContainerSpec:\tImage:\tvikrammurugesan/geolocation\tResources:\n\nThis\tconsole\toutput\thas\tbeen\ttruncated\tas\tit\tis\tlengthy.\tIf\tyou\twould\tlike\tto view\tthe\toutput\tin\tJSON\tformat,\tjust\tomit\tthe\t--pretty\targument\tfrom\tthe inspect\tcommand.\n\n12.\t Now\twait\tfor\tthe\tcontainers\tto\tstart\tup.\tBefore\tthe\tcontainers\ttry\tto\tstart\tup, Docker\twill\tpull\tthe\timage\tfrom\tDocker\tHub\tfirst.\tSo\tfor\tthe\tfirst\ttime,\tit might\ttake\ta\tfew\tminutes\tdepending\ton\tthe\tsize\tof\tyour\timage.\tGreat!\tNow the\tnext\tthing\tthat\tyou\tmight\twant\tto\tdo\tis\tscale\tyour\tmicroservice. Fortunately,\tDocker\tSwarm\tcomes\twith\ta\tcommand\tto\tscale\tour\tservices. Let's\ttry\tto\tscale\tdown\tour\tgeolocation\tservice\tto\ta\tfactor\tof\t1. docker\tservice\tscale\tgeolocation=1 geolocation\tscaled\tto\t1\n\n13.\t Easy,\tisn't\tit?\tNow\tlet's\tsay\tyou\twould\tlike\tto\tdelete\tthis\tservice;\tyou\twould use\tthe\tdocker\tservice\trm\tcommand:\tdocker\tservice\trm\tgeolocation\n\nThese\tare\tsome\tof\tthe\tbasic\toperations\tyou\twould\twant\tto\tdo\twith\tyour\tSwarm cluster.\tOf\tcourse,\tthere\tare\ttons\tof\tother\tthings\tyou\tcould\tdo\twith\tDocker Swarm.\tBut\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tour\tbook,\tso\twe\twon't\tgo\tany\tdeeper. However,\tone\tof\tthe\tmost\tcommon\tthings\tthat\tyou\twould\twant\tto\tdo\tis\tbeing able\tto\tmanage\ta\tSwarm\tcluster\twith\tease.\tCommand-line\tmanagement\twill\tget a\tlittle\ttrickier\tif\tyour\tcluster\tis\thuge.\tThat's\twhere\ttools\tsuch\tas\tShipyard, Rancher,\tand\tcAdvisor\tcome\tinto\tpicture.\tShipyard\tis\ta\ttool\tused\tfor\tmanaging Docker\tcontainers\tand\timages.\tIt\talso\thas\tthe\tability\tto\twork\twith\tprivate registries.\tSimilarly,\tRancher\tis\ta\tsophisticated\ttool\tfor\tmanaging\tcontainers. cAdvisor\tis\ta\tlittle\tdifferent\tas\tit\tis\ta\tmonitoring\ttool\tfor\tcontainers.\tYou\tmight also\twant\tto\tlook\tat\tDocker's\tremote\tAPI,\tif\tyou\twould\tlike\tto\tautomate deployments\tto\tDocker\tSwarm:\thttps://docs.docker.com/engine/api/.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tDocker Swarm\tcould\tbe\tused\tto\tdeploy\tour\tmicroservices.\tOf\tcourse,\tthis\tis\tjust\tan introduction.\tIf\tyou\tare\tinterested\tin\tinvesting\tmore\ttime\tin\tDocker\tSwarm,\tread\n\nintroduction.\tIf\tyou\tare\tinterested\tin\tinvesting\tmore\ttime\tin\tDocker\tSwarm,\tread their\tdocumentation;\tit\tusually\thas\teverything\tyou\twould\tneed.\n\nDeploying\tcontainers\ton\tYARN\n\nIn\tthis\trecipe,\tyou\twill\tlearn\thow\tYARN\tcan\tbe\tused\tas\ta\tcluster\tto\tdeploy applications.\tThe\tframework\tused\tto\tdeploy\tapplications\tto\tYARN\tis\tcalled Apache\tSlider.\tAt\tthe\ttime\tof\twriting\tthis,\tApache\tSlider\tis\tstill\tin\tApache's Incubator\tstatus.\tIn\torder\tto\tlearn\tApache\tSlider,\tyou\twill\tneed\ta\tYARN\tcluster. For\tthose\tof\tyou\twho\tare\tnot\tfamiliar\twith\tYARN,\tit\tstands\tfor\tYet\tAnother Resource\tNavigator,\tand\tit\tis\tthe\tcluster\ton\twhich\tmost\tof\tyour\tHadoop ecosystem\toperates.\tThe\tgoal\tof\tthe\tSlider\tproject\tis\tto\tprovide\tthe\tability\tto\trun applications\ton\tthe\tYARN\tcluster,\tscale\tthem,\tand\tmonitor\tthem.\tIn\tthis\trecipe,\tI will\tonly\tbe\table\tgive\tyou\tan\toverview\tof\tSlider\tas\tit\tis\tstill\tnascent.\n\nGetting\tready\n\nThe\tfirst\tthing\tthat\tyou\tneed\tis\ta\tYARN\tcluster.\tThere\tare\tseveral\tways\tto orchestrate\ta\tYARN\tcluster.\tYou\tcould\torchestrate\tyour\town\tvanilla\tHadoop cluster,\tor\tyou\tcould\tuse\tplatforms\tsuch\tas\tHortonworks\tor\tCloudera\tto\tmake\tit much\tmore\teasier.\tUsing\tplatforms\tsuch\tas\tHortonworks\tor\tCloudera\tcomes with\tits\town\tadvantages.\tRead\tthrough\ttheir\tdocumentation\tand\tpick\twhat\tis right\tfor\tyou.\n\nHow\tit\tworks...\n\nThere\tare\tthree\tmain\tcomponents\tin\ta\tYARN\tcluster:\tResource\tManager,\tNode Manager\tand\tApplication\tMaster.\tThe\tResource\tManager\tis\tthe\tcore component\tof\tthe\tcluster\tand\tis\tresponsible\tfor\tany\tresource\tallocation\tto applications.\tThe\tResource\tManager\tperforms\tthis\twith\tthe\thelp\tof\ta Scheduler\tthat\tallocates\tresources\tto\tapplications\tbased\ton\tthe\toffer\tand priority.\tResources\tare\tnothing\tbut\tCPU,\tmemory\tand\tdisk\tspace.\tThe\tNode Manager\tis\tavailable\ton\teach\tnode\tof\tthe\tcluster\tand\tis\tresponsible\tfor\tspinning of\ttasks,\tmonitoring\tresource\tusage\tand\tso\ton.\tLastly,\tthe\tApplication\tMaster\tis a\tframework\tspecific\tcomponent\tthat\tis\tresponsible\tfor\trunning\tthe\ttasks\ton\tthe nodes.\tThe\tfollowing\tdiagram\tshows\tthe\tcomponents\tof\ta\tYARN\tcluster:\n\nSlider\tis\ta\tcommand-line\ttool.\tAt\tthe\tcore\tof\tSlider\tlies\tthe\tYARN\tApplication Master\t(AM),\tthe\tSlider\tAM,\tand\ta\tclient\tthat\tcommunicates\tbetween\tYARN and\tSlider\tAM\tusing\tAPIs.\tThe\tclient\tis\tthe\tcommand\tline\tinterface\tthat\tcan\tbe used\tto\ttalk\tto\tSlider.\tTo\tlearn\tmore\tabout\tthe\tworking\tof\tSlider\tAM,\tplease\ttake a\tlook\tat\thttps://slider.incubator.apache.org/design/architecture.html#am- architecture\t.\tThe\tSlider\tdeployment\trequests\tindicate\tthe\tresources\trequired\tfor the\tapplication\tas\twell\tas\tthe\tdetails\tof\tthe\tapplication.\tThe\tdeployment\trequests\n\nare\tusually\tin\tthe\tform\tof\tJSON\tthat\tlooks\tvery\tsimilar\tto\tMarathon's\tJSON request.\tThere\tare\ttwo\tJSON\tdocuments\tthat\tyou\tneed\tto\tprovide\tin\torder\tto deploy\tapplications\tusing\tSlider:\tresources.json\tand\tappConfig.json.\n\nThe\tresources.json\tfile\tis\tused\tto\ttell\tSlider\thow\tmuch\tresources\t(memory\tand CPU)\tshould\tbe\tallocated\tfor\tthat\tparticular\tapplication.\tSome\tresource\tconfig options\tare\tyarn.memory,\tyarn.vcores,\tyarn.container.failure.threshold, yarn.component.instances,\tand\tyarn.role.priority.\n\nWhile\tmost\tof\tthese\tproperties\tare\tself-explanatory,\tyarn.role.priority\tmight deserve\tan\texplanation.\tIt\tis\tmainly\tused\twhen\tyou\thave\tmultiple\tcomponents. Components\twith\tthe\thighest\tpriority\t(1)\twill\tbe\torchestrated\tfirst.\n\nThe\tyarn.container.failure.threshold\toption\tindicates\tthe\tnumber\tof\ttimes a\tcomponent\tmay\tfail\twithin\tthe\tgiven\ttime\twindow.\tThe\tfailure\ttime\twindow\tis usually\tindicated\tusing\tthree properties:yarn.container.failure.window.days, yarn.container.failure.window.hours,\tand yarn.container.failure.minutes.\n\nThe\tnext\tJSON\tfile\tthat\tyou\twill\tneed\tis\tappConfig.json.\tWhile resources.json\twas\tmore\tof\ta\tconfig\tfile\tto\tSlider\t(or\tYARN), appConfig.json\tis\tmostly\tfor\tthe\tapplication.\tTwo\tof\tthe\tmost\timportant properties\tare\tapplication.def\tand\tjava_home.\tIn\taddition\tto\tthis,\tyou\tcould add\tyour\town\tproperties\tas\twell,\tsuch\tas\tJVM\tsize.\tThe\tapplication.def property\tindicates\tthe\tlocation\tof\tthe\tapplication\tpackage\titself\ton\tHDFS. Usually,\tthe\tapplication\tis\tpackaged\tas\ta\tZIP\tfile.\n\nSlider\tis\tcurrently\tCLI\tdriven.\tThough\tSlider\tneeds\tmore\tfeatures\tto\tbecome more\tsophisticated\tlike\tother\tschedulers,\tit\tis\tcurrently\tthe\tonly\tavailable solution\tfor\tYARN.\tIf\tyou\tare\tusing\tYARN\talready,\tit\tis\tworth\tchecking\tout.\n\nTo\tlearn\tmore\tabout\tSlider,\tvisit\ttheir\tGetting\tStarted\tpage: http://slider.incubator.apache.org/docs/getting_started.html\t.\tAt\tthe\ttime\tof writing\tthis,\tthe\tlink\tstill\tlives\tin\tApache's\tincubator\tdomain.\tIf\tthis\tlink\tis broken,\tfeel\tfree\tto\tvisit\tSlider's\twebsite\tand\tnavigate\tto\ttheir\tGetting\tStarted page.\n\nWith\tthat\tsaid,\twe\tcome\tto\tthe\tend\tof\tthe\trecipe,\tthe\tchapter,\tand\tthe\tbook.\tIn this\tbook,\tI\thave\tintroduced\tyou\tto\ta\tlot\tof\ttechnologies,\ttools,\tand\tframeworks. While\tit\ttakes\tmore\tthan\ta\tbook\tto\tmake\tyou\tan\texpert\ton\teach\tof\tthem,\tmy\tgoal was\tto\tgive\tyou\ta\thead\tstart\tand\tshow\tyou\thow\tto\tproceed\tand\tsolve\tthe\tmost common\tchallenges.\tThroughout\tthe\tbook,\twe\thave\tlearned\trecipes\tto\taddress most\tof\tthe\tchallenges\tthat\tyou\twill\tface\twhen\tyou\tmove\ttoward\ta\tmicroservice- based\tarchitecture,\tincluding\tdevelopment,\tcontainerization,\tdeployments, service\tdiscovery,\tload\tbalancing,\tmonitoring,\tlogging,\tand\tstreaming.\tOf course,\tthere\twill\tbe\tmore\tchallenges\tas\tyou\tstart\tscaling\tout\tto\thundreds\tand hundreds\tof\tmicroservices\tin\tyour\torganization.\tBut\tthere\tare\talways\ttools\tand frameworks\tout\tthere\tto\tsolve\tthem.\tI\thope\tthis\tbook\twill\thelp\tyou\tout\ton\tyour microservice\tjourney.\tHappy\tmicroservicing!",
      "page_number": 488
    }
  ],
  "pages": [
    {
      "page_number": 2,
      "content": "Microservices\tDeployment\tCookbook",
      "content_length": 33,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 3,
      "content": "Table\tof\tContents\n\nMicroservices\tDeployment\tCookbook Credits About\tthe\tAuthor About\tthe\tReviewer www.PacktPub.com Why\tsubscribe? Customer\tFeedback Preface\n\nWhat\tthis\tbook\tcovers What\tyou\tneed\tfor\tthis\tbook Who\tthis\tbook\tis\tfor Sections\n\nGetting\tready How\tto\tdo\tit How\tit\tworks There's\tmore See\talso Conventions Reader\tfeedback Customer\tsupport\n\nDownloading\tthe\texample\tcode Errata Piracy Questions\n\n1.\tBuilding\tMicroservices\twith\tJava\n\nIntroduction Creating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven\n\nGetting\tready How\tto\tdo\tit... There's\tmore...\n\nWriting\tmicroservices\twith\tSpring\tBoot\n\nGetting\tready How\tto\tdo\tit...",
      "content_length": 617,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 4,
      "content": "Writing\tREST\tAPIs\twith\tSpring\tMVC\n\nGetting\tready How\tto\tdo\tit...\n\nWriting\tmicroservices\twith\tWildFly\tSwarm\n\nGetting\tready How\tto\tdo\tit...\n\nWriting\tmicroservices\twith\tDropwizard\n\nGetting\tready How\tto\tdo\tit...\n\nWriting\tREST\tAPIs\twith\tSparkJava\n\nGetting\tready How\tto\tdo\tit...\n\nConclusion\n\n2.\tContainerizing\tMicroservices\twith\tDocker\n\nBuilding\tan\texecutable\tJAR\tusing\tMaven\tShade\tplugin\n\nGetting\tready How\tto\tdo\tit...\n\nBuilding\tan\texecutable\tJAR\tusing\tthe\tSpring\tBoot\tMaven\tplugin\n\nGetting\tready How\tto\tdo\tit...\n\nInstalling\tand\tsetting\tup\tDocker\n\nGetting\tready How\tto\tdo\tit...\n\nWriting\tyour\tDockerfile\n\nGetting\tready How\tto\tdo\tit...\n\nBuilding\tyour\tDocker\timage\n\nGetting\tready How\tto\tdo\tit...\n\nRunning\tyour\tmicroservice\tinside\ta\tDocker\tcontainer\n\nGetting\tready How\tto\tdo\tit...\n\nPushing\tyour\timage\tto\tDocker\tHub\n\nGetting\tready How\tto\tdo\tit...\n\n3.\tDeploying\tMicroservices\ton\tMesos Introduction",
      "content_length": 886,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 5,
      "content": "Setting\tup\ta\tMesos\tcluster\tusing\tDocker\n\nGetting\tready Zookeeper Mesos\tmasters\tand\tMesos\tslaves Mesos\tframeworks\n\nHow\tto\tdo\tit...\n\nUnderstanding\tthe\tMesos\tand\tMarathon\tinterface\n\nGetting\tready How\tto\tdo\tit...\n\nThe\tMesos\tinterface\n\nThe\tMesos\thome\tpage Frameworks\n\nThe\tMarathon\tweb\tUI\n\nDeploying\tyour\tmicroservice\tto\tMesos\tusing\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tports\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tvolumes\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tenvironment\tvariables\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nScaling\tyour\tmicroservice\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nDestroying\tyour\tmicroservice\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nMonitoring\tyour\tmicroservice\tlogs\tin\tMarathon\n\nGetting\tready How\tto\tdo\tit...\n\nMonitoring\tyour\tmicroservice\tlogs\tin\tMesos\n\nGetting\tready How\tto\tdo\tit...",
      "content_length": 866,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 6,
      "content": "Managing\tyour\tmicroservice\tusing\tMarathon's\tREST\tAPI\n\nGetting\tready How\tto\tdo\tit...\n\n4.\tDeploying\tMicroservices\ton\tKubernetes Introduction\n\nKubernetes\tmaster API\tserver etcd Scheduler Controller\tmanager Kubernetes\tnode\n\nSetting\tup\tKubernetes\tcluster\tusing\tDocker\n\nGetting\tready How\tto\tdo\tit...\n\nUnderstanding\tthe\tKubernetes\tdashboard\n\nGetting\tready How\tto\tdo\tit...\n\nDeploying\tyour\tmicroservice\ton\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tports\tin\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tvolumes\tin\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tenvironment\tvariables\tin\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nScaling\tyour\tmicroservice\tin\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nDestroying\tyour\tmicroservice\tin\tKubernetes\n\nGetting\tready How\tto\tdo\tit...\n\nMonitoring\tyour\tmicroservice\tlogs\tin\tKubernetes\n\nGetting\tready",
      "content_length": 859,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 7,
      "content": "How\tto\tdo\tit...\n\n5.\tService\tDiscovery\tand\tLoad\tBalancing\tMicroservices Introduction Setting\tup\tZookeeper\tusing\tDocker\n\nGetting\tready How\tto\tdo\tit...\n\nLoad\tbalancing\tmicroservices\tusing\tZookeeper\n\nGetting\tready How\tto\tdo\tit...\n\nSetting\tup\tConsul\tusing\tDocker\n\nGetting\tready How\tto\tdo\tit...\n\nUnderstanding\tthe\tconcepts\tof\tConsul\n\nImplementing\tservice\tdiscovery\tusing\tSpring\tCloud\tConsul\n\nGetting\tready How\tto\tdo\tit...\n\nLoad\tbalancing\tyour\tmicroservice\tusing\tSpring\tCloud\tConsul\n\nGetting\tready How\tto\tdo\tit...\n\nLoad\tbalancing\tyour\tmicroservice\tusing\tNginx\tand\tConsul\n\nGetting\tready How\tto\tdo\tit...\n\nLoad\tbalancing\tyour\tmicroservice\tusing\tMarathon\tLB\n\nHow\tit\tworks... 6.\tMonitoring\tMicroservices\n\nIntroduction Configuring\tSpring\tBoot\tActuator\tmetrics\n\nGetting\tready How\tto\tdo\tit...\n\nUnderstanding\tSpring\tBoot\tActuator\tmetrics\n\nGetting\tready How\tto\tdo\tit...\n\nCreating\tcustom\tmetrics\tusing\tDropwizard\n\nGetting\tready How\tto\tdo\tit...\n\nSetting\tup\tGraphite\tusing\tDocker\n\nGetting\tready",
      "content_length": 974,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 8,
      "content": "How\tto\tdo\tit...\n\nUsing\tthe\tGraphite\tinterface\n\nGetting\tready How\tto\tdo\tit... Tree\tview Search Auto-Completer Graphite\n\nExporting\tDropwizard\tmetrics\tover\tto\tGraphite\n\nGetting\tready How\tto\tdo\tit...\n\nExporting\tSpring\tBoot\tActuator\tmetrics\tover\tto\tGraphite\n\nGetting\tready How\tto\tdo\tit...\n\nSetting\tup\tGrafana\tusing\tDocker\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tGrafana\tto\tuse\tGraphite\n\nGetting\tready How\tto\tdo\tit...\n\nConfiguring\tGrafana\tdashboards\tto\tview\tmetrics\n\nGetting\tready How\tto\tdo\tit...\n\n7.\tBuilding\tAsynchronous\tStreaming\tSystems\twith\tKafka\tand\tSpark Introduction Setting\tup\tKafka\tusing\tDocker\n\nKafka\n\nPoint-to-point\tmechanism Pub-sub\tmechanism\n\nKafka\tterminology\n\nBrokers Topics Partitions Producers\tand\tconsumers\n\nGetting\tready How\tto\tdo\tit... Creating\tKafka\ttopics\tto\tstream\tdata",
      "content_length": 791,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 9,
      "content": "Getting\tready How\tto\tdo\tit...\n\nWriting\ta\tstreaming\tprogram\tusing\tKafka\tStreams\n\nGetting\tready How\tto\tdo\tit...\n\nImproving\tthe\tperformance\tof\tthe\tKafka\tStreams\tprogram\n\nGetting\tready How\tto\tdo\tit...\n\nWriting\ta\tstreaming\tprogram\tusing\tApache\tSpark\n\nGetting\tready How\tto\tdo\tit...\n\nImproving\tthe\tperformance\tof\tthe\tSpark\tjob\n\nHow\tto\tdo\tit...\n\nAggregating\tlogs\tinto\tKafka\tusing\tLog4J\n\nGetting\tready How\tto\tdo\tit...\n\nIntegrating\tKafka\twith\tlog\tmanagement\tsystems\n\nHow\tit\tworks...\n\n8.\tMore\tClustering\tFrameworks\t-\tDC/OS,\tDocker\tSwarm,\tand\tYARN Introduction Deploying\tinfrastructure\twith\tDC/OS\n\nGetting\tready How\tto\tdo\tit...\n\nDeploying\tcontainers\twith\tDocker\tSwarm\n\nGetting\tready How\tto\tdo\tit...\n\nDeploying\tcontainers\ton\tYARN\n\nGetting\tready How\tit\tworks...",
      "content_length": 747,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 10,
      "content": "Microservices\tDeployment\tCookbook",
      "content_length": 33,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 11,
      "content": "Microservices\tDeployment\tCookbook\n\nCopyright\t\t2017\tPackt\tPublishing\n\nAll\trights\treserved.\tNo\tpart\tof\tthis\tbook\tmay\tbe\treproduced,\tstored\tin\ta\tretrieval system,\tor\ttransmitted\tin\tany\tform\tor\tby\tany\tmeans,\twithout\tthe\tprior\twritten permission\tof\tthe\tpublisher,\texcept\tin\tthe\tcase\tof\tbrief\tquotations\tembedded\tin critical\tarticles\tor\treviews.\n\nEvery\teffort\thas\tbeen\tmade\tin\tthe\tpreparation\tof\tthis\tbook\tto\tensure\tthe\taccuracy of\tthe\tinformation\tpresented.\tHowever,\tthe\tinformation\tcontained\tin\tthis\tbook\tis sold\twithout\twarranty,\teither\texpress\tor\timplied.\tNeither\tthe\tauthor,\tnor\tPackt Publishing,\tand\tits\tdealers\tand\tdistributors\twill\tbe\theld\tliable\tfor\tany\tdamages caused\tor\talleged\tto\tbe\tcaused\tdirectly\tor\tindirectly\tby\tthis\tbook.\n\nPackt\tPublishing\thas\tendeavored\tto\tprovide\ttrademark\tinformation\tabout\tall\tof the\tcompanies\tand\tproducts\tmentioned\tin\tthis\tbook\tby\tthe\tappropriate\tuse\tof capitals.\tHowever,\tPackt\tPublishing\tcannot\tguarantee\tthe\taccuracy\tof\tthis information.\n\nFirst\tpublished:\tJanuary\t2017\n\nProduction\treference:\t1240117\n\nPublished\tby\tPackt\tPublishing\tLtd.\n\nLivery\tPlace\n\n35\tLivery\tStreet\n\nBirmingham\n\nB3\t2PB,\tUK.\n\nISBN\t978-1-78646-943-4\n\nwww.packtpub.com",
      "content_length": 1172,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 12,
      "content": "Credits\n\nAuthor\n\nVikram\tMurugesan\n\nReviewer\n\nKishore\tKumar\tYekkanti\n\nCommissioning\tEditor\n\nKartikey\tPandey\n\nAcquisition\tEditor\n\nVijin\tBoricha\n\nContent\tDevelopment\tEditor\n\nAmedh\tGemraram\tPohad\n\nTechnical\tEditors\n\nPrashant\tChaudhari\tVishal\tKamal\tMewada\n\nCopy\tEditor\n\nMadhusudan\tUchil\n\nProject\tCoordinator\n\nJudie\tJose\n\nProofreader\n\nSafis\tEditing\n\nIndexer\n\nPratik\tShirodkar\n\nGraphics\n\nKirk\tD'Penha\n\nProduction\tCoordinator\n\nMelwyn\tDsa",
      "content_length": 429,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 13,
      "content": "About\tthe\tAuthor\n\nVikram\tMurugesan\tis\ta\tsoftware\tarchitect\twho\thas\tover\t10\tyears\tof\texperience building\tdistributed\tsystems\tand\tproducts.\tHe\tcurrently\tworks\tas\ta\tprincipal architect\twith\tEgen\tSolutions\tInc.\tIn\this\tcurrent\tjob,\the\tfocuses\ton\tbuilding platforms\tbased\ton\tJVM\t(Java,\tScala,\tand\tGroovy),\tbig\tdata,\tand\tcloud technologies.\tHe\tis\ta\tpassionate\tprogrammer\tand\tis\tinterested\tin\tlearning\tnew technologies.\tHe\tis\talso\tinterested\tin\tcoaching,\tmentoring,\tand\tbuilding\tscalable teams\tthat\tbuild\tgreat\tsoftware.\n\nI\twould\tlike\tto\ttake\ta\tmoment\tto\tthank\teveryone\tthat\thas\tbeen\ta\thuge support\tduring\tthe\tcourse\tof\twriting\tthis\tbook.\tFirstly,\tthanks\tto\tMr.\tRaghu Potini,\twho\tmotivated\tme\tto\twrite\tthis\tbook\tand\thas\tbeen\tsupportive throughout\tthe\twriting\tprocess.\tWithout\this\tsupport\tand\tmotivation,\tthis book\twould\thave\tnot\tbeen\tpossible.\tSecondly,\tI\twould\tlike\tto\tthank\tMr. Andrew\tLeasck,\twho\thas\tbeen\tmy\tinspiration\tsince\tthe\tbeginning\tof\tmy career.\tWhen\tI\tstarted\twriting\tthe\tbook,\tI\tdid\tnot\tknow\tmuch\tabout\tthe publishing\tprocess\tor\tthe\tamount\tof\tteam\twork\tit\tneeds.\tWhile\tworking with\tthe\tPackt\tPublishing\tteam,\tthey\tmade\tme\trealize\tthat\tit\trequires enormous\tamount\tof\tteam\teffort,\tcoordination\tand\tpatience.\tThe\tPackt Publishing\tteam\tmade\tit\tlook\tso\tsimple,\tbut\tbehind\tthe\tscenes,\tthey\tput\tso much\teffort\tand\tthoughts\tinto\tgiving\tlife\tto\tthis\tbook.\tWithout\tthem,\tthis would\thave\tnot\tbeen\tpossible.\tHats\toff\tto\tthe\tPackt\tteam\tmembers\tthat helped\tme\tduring\tthis\tprocess.\tEveryone\thas\ta\trole\tmodel\tin\tlife.\tMy\tfather has\talways\tbeen\tmy\trole\tmodel\tand\tan\tinspiration.\tThanks\tto\tmy\tfather, Mr.\tMurugesan,\twho\twould\thave\tbeen\treally\tproud\tabout\tthis\tbook.\tSpecial thanks\tto\tmy\tmother,\tVijayarani,\twife,\tSubamalar,\tand\tdaughther,\tSreesha, who\thave\tbeen\tvery\tpatient\tand\tsupportive\tduring\tthe\tcourse\tof\twriting\tthis book.",
      "content_length": 1816,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 14,
      "content": "About\tthe\tReviewer\n\nKishore\tKumar\tYekkanti\tis\tan\tseasoned\tdeveloper\twho\tworked\tacross\tvarious domains\tand\ttechnologies\tover\tthe\tpast\t10\tyears.\tHe\tplayed\tkey\troles\tin\tvarious product\tand\tagile\tconsulting\tcompanies\tsuch\tas\tStayzilla,\tThoughtworks,\tand, currently\tat\tCurrencyFair.\tHis\tdomain\texpertise\tspans\tthe\tfinance,\tsupply\tchain, e-commerce,\tcloud,\tinfrastructure\tmanagement,\thealth,\tretail,\tICT4D,\tand entertainment\tindustries.\tHe\tis\tpassionate\tabout\topen\tsource\tsoftware\tand\tis\ta core\tcontributor\tto\tmany\thumanitarian\topen\tsource\tprojects.\tHis\tcurrent\tfocus\tis on\tscaling\tmicroservices\tin\thighly\tdistributed\tapplications\tthat\tare\tdeployed using\tcontainer-based\tsystems\tin\tthe\tcloud.\tKishore\tis\talso\ta\tcore\treviewer\tfor another\tmicroservices\tbook\tcalled\tDeveloping\tMicroservices\twith\tNode.js.\n\nI\twould\tlike\tthank\tmy\twife,\tJyothsna,\tand\tmy\tdaughter,\tDhruti,\twho\tput\tup with\tme\tall\talong\tirrespective\tof\tmy\tcrazy\tschedules.",
      "content_length": 924,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 15,
      "content": "www.PacktPub.com\n\nFor\tsupport\tfiles\tand\tdownloads\trelated\tto\tyour\tbook,\tplease visit\twww.PacktPub.com.\n\nDid\tyou\tknow\tthat\tPackt\toffers\teBook\tversions\tof\tevery\tbook\tpublished,\twith PDF\tand\tePub\tfiles\tavailable?\tYou\tcan\tupgrade\tto\tthe\teBook\tversion at\twww.PacktPub.com\tand\tas\ta\tprint\tbook\tcustomer,\tyou\tare\tentitled\tto\ta discount\ton\tthe\teBook\tcopy.\tGet\tin\ttouch\twith\tus\tat\tservice@packtpub.com\tfor more\tdetails.\n\nAt\twww.PacktPub.com,\tyou\tcan\talso\tread\ta\tcollection\tof\tfree\ttechnical\tarticles, sign\tup\tfor\ta\trange\tof\tfree\tnewsletters\tand\treceive\texclusive\tdiscounts\tand\toffers on\tPackt\tbooks\tand\teBooks.\n\nhttps://www.packtpub.com/mapt\n\nGet\tthe\tmost\tin-demand\tsoftware\tskills\twith\tMapt.\tMapt\tgives\tyou\tfull\taccess\tto all\tPackt\tbooks\tand\tvideo\tcourses,\tas\twell\tas\tindustry-leading\ttools\tto\thelp\tyou plan\tyour\tpersonal\tdevelopment\tand\tadvance\tyour\tcareer.",
      "content_length": 849,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 16,
      "content": "Why\tsubscribe?\n\nFully\tsearchable\tacross\tevery\tbook\tpublished\tby\tPackt Copy\tand\tpaste,\tprint,\tand\tbookmark\tcontent On\tdemand\tand\taccessible\tvia\ta\tweb\tbrowser",
      "content_length": 156,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 17,
      "content": "Customer\tFeedback\n\nThank\tyou\tfor\tpurchasing\tthis\tPackt\tbook.\tWe\ttake\tour\tcommitment\tto improving\tour\tcontent\tand\tproducts\tto\tmeet\tyour\tneeds\tseriouslythat's\twhy your\tfeedback\tis\tso\tvaluable.\tWhatever\tyour\tfeelings\tabout\tyour\tpurchase, please\tconsider\tleaving\ta\treview\ton\tthis\tbook's\tAmazon\tpage.\tNot\tonly\twill\tthis help\tus,\tmore\timportantly\tit\twill\talso\thelp\tothers\tin\tthe\tcommunity\tto\tmake\tan informed\tdecision\tabout\tthe\tresources\tthat\tthey\tinvest\tin\tto\tlearn.\n\nYou\tcan\talso\treview\tfor\tus\ton\ta\tregular\tbasis\tby\tjoining\tour\treviewers'\tclub.\tIf you're\tinterested\tin\tjoining,\tor\twould\tlike\tto\tlearn\tmore\tabout\tthe\tbenefits we\toffer,\tplease\tcontact\tus:\tcustomerreviews@packtpub.com.",
      "content_length": 680,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 18,
      "content": "Preface\n\nThe\tgoal\tof\tthis\tbook\tis\tto\tintroduce\tyou\tto\tsome\tof\tthe\tmost\tpopular\tand\tnewest technologies\tand\tframeworks\tthat\twill\thelp\tyou\tbuild\tand\tdeploy\tmicroservices at\tscale.\tWith\tthe\tcurrent\tevolution\tin\tthis\tspace,\tit\tis\treally\tdifficult\tto\tkeep\tup with\tall\tthe\tnew\tframeworks\tand\ttools.\tIf\tyou\tare\tan\topen\tsource\tfan\tlike\tme, you\twould\talready\tknow\tthat\tyou\thave\tto\tspend\ta\tlot\tof\ttime\tin\ttrying\tout\tthese new\tframeworks\tand\tlibraries\tin\torder\tto\tunderstand\ttheir\tpotential\tand\tthe\texact problem\tthat\tthey\tare\ttrying\tto\tsolve.\tOf\tcourse,\teach\tframework\twould\thave been\tbuilt\tfor\ta\tspecific\tpurpose,\tand\tyou\twill\toften\tend\tup\tin\ta\tsituation\twhere you\tdont\thave\ta\tsilver\tbullet\tfor\tall\tyour\tmicroservice\tconcerns.\tIn\tthis\tbook, you\twill\tlearn\tsome\tof\tthe\tmost\tcommonly\tused\tframeworks\tand\ttechnologies that\thelp\tyou\tbuild\tand\tdeploy\tmicroservices\tat\tscale.\n\nThroughout\tthis\tbook,\twe\twill\tbe\tsticking\tto\ta\tspecific\tapplication\tand\twill\ttry\tto build\tupon\tthat\tapplication.\tFor\texample,\twe\twill\tbe\tusing\tthe\tsame\tapplication to\tconfigure\tservice\tdiscovery,\tmonitoring,\tstreaming,\tlog\tmanagement,\tand load\tbalancing.\tSo\tby\tthe\tend\tof\tthis\tbook,\tyou\twill\thave\ta\tfully\tloaded microservice\tthat\tdemonstrates\tevery\taspect\tof\ta\tmicroservice.\n\nThis\tbook\tcovers\tseveral\tlibraries\tand\tframeworks\tthat\thelp\tyou\tbuild\tand deploy\tmicroservices.\tAfter\treading\tthis\tbook,\tyou\twill\tnot\tbe\tan\texpert\ton\tall\tof them,\tbut\tyou\twill\tknow\twhere\tto\tstart\tand\thow\tto\tproceed.\tThats\tthe\twhole intention\tof\tthis\tbook.\tI\thope\tyou'll\tlike\tit.\tGood\tluck\tmicroservicing!",
      "content_length": 1544,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 19,
      "content": "What\tthis\tbook\tcovers\n\nChapter\t1,\tBuilding\tMicroservices\twith\tJava,\tshows\tyou\thow\tto\tbuild\tJava- based\tRESTful\tmicroservices\tusing\tframeworks\tsuch\tas\tSpring\tBoot,\tWildfly Swarm,\tDropwizard,\tand\tSpark\tJava\t.\tThis\tchapter\twill\talso\tshow\tyou\thow\tto write\tRESTful\tAPIs\tusing\tSpring\tMVC\tand\tSpark\tJava.\n\nChapter\t2,\tContainerizing\tMicroservices\twith\tDocker,\tshows\tyou\thow\tto package\tyour\tapplication\tusing\tMaven\tplugins\tsuch\tas\tthe\tMaven\tShade\tplugin and\tSpring\tBoot\tMaven\tplugin.\tThis\tchapter\twill\talso\tshow\tyou\thow\tto\tinstall Docker\ton\tyour\tlocal\tcomputer.\tYou\twill\talso\tlearn\thow\tto\tcontainerize\tyour application\tusing\tDocker\tand\tlater\tpush\tyour\tmicroservices\tDocker\timage\tto the\tpublic\tDocker\tHub.\n\nChapter\t3,\tDeploying\tMicroservices\ton\tMesos,\tshows\tyou\thow\tto\torchestrate\ta Dockerized\tMesos\tcluster\twith\tMarathon\ton\tyour\tlocal\tmachine.\tYou\twill\talso learn\thow\tto\tdeploy\tyour\tDockerized\tmicroservice\tto\ta\tMesos\tcluster\tusing Marathon.\tLater,\tyou\twill\tlearn\thow\tto\tscale\tyour\tmicroservice;\tconfigure\tports, volumes,\tand\tenvironment\tvariables;\tand\tview\tcontainer\tlogs\tin\tMarathon. Finally\tyou\twill\tlearn\thow\tto\tuse\tMarathon's\tREST\tAPI\tfor\tmanaging\tyour microservice.\n\nChapter\t4,\tDeploying\tMicroservices\ton\tKubernetes,\tshows\tyou\thow\tto orchestrate\ta\tDockerized\tKubernetes\tcluster\tusing\tMinikube\ton\tyour\tlocal machine.\tYou\twill\talso\tlearn\thow\tto\tdeploy\tyour\tDockerized\tmicroservice\tto\ta Kubernetes\tcluster\tusing\tthe\tKubernetes\tdashboard\tas\twell\tas\tkubectl.\tLater,\tyou will\tlearn\thow\tto\tscale\tyour\tmicroservice;\tconfigure\tports,\tvolumes,\tand environment\tvariables;\tand\tview\tcontainer\tlogs\tin\tKubernetes\tusing\tthe dashboard\tas\twell\tas\tkubectl.\n\nChapter\t5,\tService\tDiscovery\tand\tLoad\tBalancing\tMicroservices,\tshows\tyou how\tyou\tto\trun\ta\tDockerized\tZookeeper\tinstance\ton\tyour\tlocal\tmachine.\tYou will\tlearn\thow\tto\timplement\tservice\tdiscovery\tand\tload\tbalancing\tusing Zookeeper.\tThis\tchapter\talso\tintroduces\tyou\tto\tConsul,\twhere\tyou\twill\tbe running\ta\tDockerized\tConsul\tinstance\ton\tyour\tlocal\tmachine.\tLater,\tyou\twill learn\thow\tto\timplement\tservice\tdiscovery\tand\tload\tbalancing\tusing\tConsul\tand Spring\tCloud.\tYou\twill\talso\tlearn\thow\tto\timplement\tservice\tdiscovery\tand\tload",
      "content_length": 2159,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 20,
      "content": "balancing\tusing\tConsul\tand\tNginx.\n\nChapter\t6,\tMonitoring\tMicroservices,\tshows\tyou\thow\tto\tconfigure\tSpring\tBoot Actuator\tand\tgives\tyou\tan\toverview\tof\tall\tthe\tmetrics\tthat\tare\texposed\tby\tSpring Boot\tActuator.\tYou\twill\talso\tlearn\thow\tto\tcreate\tyour\town\tmetrics\tusing\tthe Dropwizard\tmetrics\tlibrary\tand\tlater\texpose\tthem\tvia\tSpring\tBoot\tActuator. Later,\tyou\twill\tlearn\thow\tto\trun\ta\tDockerized\tGraphite\tinstance\ton\tyour\tlocal machine.\tThe\tmetrics\tthat\tyou\tcreated\tusing\tDropwizard\twill\tthen\tbe\tpublished to\tGraphite.\tFinally,\tyou\twill\tlearn\thow\tto\trun\ta\tDockerized\tGrafana\tinstance\ton your\tlocal\tmachine\tand\tthen\tuse\tit\tto\texpose\tyour\tmetrics\tin\tthe\tform\tof dashboards.\n\nChapter\t7,\tBuilding\tAsynchronous\tStreaming\tSystems\twith\tKafka\tand\tSpark, shows\tyou\thow\tto\tset\tup\tand\trun\ta\tDockerized\tKafka\tbroker\ton\tyour\tlocal machine.\tYou\twill\tlearn\thow\tto\tcreate\ttopics\tin\tKafka\tand\tbuild\tKafka\tStreams application\tin\tour\tmicroservice\tthat\twill\tstream\tdata\tasynchronously.\tYou\twill build\ta\tsimilar\tSpark\tStreaming\tjob\tthat\twill\thave\tthe\tability\tto\tstream\tdata asynchronously.\tYou\twill\tget\tan\toverview\tof\timproving\tthe\tperformance\tof\tyour streaming\tapplication.\tLater,\tyou\twill\tlearn\thow\tto\taggregate\tyour\tapplication logs\tinto\ta\tKafka\ttopic\tand\tthen\texplore\tthe\tpossibilities\tof\tintegrating\tit\twith popular\tlog-management\tsystems.\n\nChapter\t8,\tMore\tClustering\tFrameworks\t-\tDC/OS,\tDocker\tSwarm,\tand\tYARN, will\tgive\tyou\tan\toverview\tof\tother\tpopular\tclustering\tframeworks\tin\tthe\tmarket. You\twill\tget\ta\thigh-level\tidea\tof\tMesospheres\tDC/OS,\tDocker\tSwarm,\tand Apache\tYARN.\tYou\twill\talso\tget\tto\tsee\thow\tDC/OS\tand\tDocker\tSwarm\tcan\tbe used\tto\tdeploy\tmicroservices\ton\ta\tlarger\tscale.",
      "content_length": 1660,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 21,
      "content": "What\tyou\tneed\tfor\tthis\tbook\n\nYou\twill\tneed\tthe\tfollowing\tsoftware\tand\thardware\tto\texecute\tthe\trecipes\ton\tthis book.\n\nHardware:\n\nDesktop\tor\tlaptop\twith\tat\tleast\t16\tGB\tmemory\tand\ta\t4-core\tCPU\n\nSoftware:\n\nJava\tDevelopment\tKit Apache\tMaven Spring\tTool\tSuite",
      "content_length": 253,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 22,
      "content": "Who\tthis\tbook\tis\tfor\n\nThis\tbook\tis\tfor\tJava\tdevelopers\tthat\twould\tlike\tto\tlearn\thow\tto\tbuild microservices,\tdeploy\tthem\ton\ta\tclustered\tenvironment,\tmonitor\tthem,\tand manage\tthem\tat\tscale.\tFamiliarity\twith\tJava\tis\ta\tplus,\tas\tmost\tof\tthe\trecipes\tin this\tbook\tare\tbased\ton\tJava.",
      "content_length": 275,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 23,
      "content": "Sections\n\nIn\tthis\tbook,\tyou\twill\tfind\tseveral\theadings\tthat\tappear\tfrequently\t(Getting ready,\tHow\tto\tdo\tit...,\tHow\tit\tworks...,\tThere's\tmore...,\tand\tSee\talso).\n\nTo\tgive\tclear\tinstructions\ton\thow\tto\tcomplete\ta\trecipe,\twe\tuse\tthese\tsections\tas follows:",
      "content_length": 250,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 24,
      "content": "Getting\tready\n\nThis\tsection\ttells\tyou\twhat\tto\texpect\tin\tthe\trecipe,\tand\tdescribes\thow\tto\tset\tup any\tsoftware\tor\tany\tpreliminary\tsettings\trequired\tfor\tthe\trecipe.",
      "content_length": 161,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 25,
      "content": "How\tto\tdo\tit\n\nThis\tsection\tcontains\tthe\tsteps\trequired\tto\tfollow\tthe\trecipe.",
      "content_length": 77,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 26,
      "content": "How\tit\tworks\n\nThis\tsection\tusually\tconsists\tof\ta\tdetailed\texplanation\tof\twhat\thappened\tin\tthe previous\tsection.",
      "content_length": 112,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 27,
      "content": "There's\tmore\n\nThis\tsection\tconsists\tof\tadditional\tinformation\tabout\tthe\trecipe\tin\torder\tto\tmake the\treader\tmore\tknowledgeable\tabout\tthe\trecipe.",
      "content_length": 144,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 28,
      "content": "See\talso\n\nThis\tsection\tprovides\thelpful\tlinks\tto\tother\tuseful\tinformation\tfor\tthe\trecipe.",
      "content_length": 89,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 29,
      "content": "Conventions\n\nIn\tthis\tbook,\tyou\twill\tfind\ta\tnumber\tof\ttext\tstyles\tthat\tdistinguish\tbetween different\tkinds\tof\tinformation.\tHere\tare\tsome\texamples\tof\tthese\tstyles\tand\tan explanation\tof\ttheir\tmeaning.\n\nCode\twords\tin\ttext,\tdatabase\ttable\tnames,\tfolder\tnames,\tfilenames,\tfile extensions,\tpathnames,\tdummy\tURLs,\tuser\tinput,\tand\tTwitter\thandles\tare\tshown as\tfollows:\t\"Start\tthe\tGeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot application\tfrom\tyour\tSTS\tIDE.\"\n\nA\tblock\tof\tcode\tis\tset\tas\tfollows:\n\n<!--\t<dependency> \t\t\t\t\t<groupId>org.springframework.cloud</groupId> \t\t\t\t\t<artifactId>spring-cloud-starter-consul-all</artifactId> \t\t\t\t\t<version>1.1.2.RELEASE</version> \t\t\t\t</dependency>\t-->\n\nAny\tcommand-line\tinput\tor\toutput\tis\twritten\tas\tfollows:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tGET\t http://localhost:8080/geolocation\n\nNew\tterms\tand\timportant\twords\tare\tshown\tin\tbold.\tWords\tthat\tyou\tsee\ton\tthe screen,\tfor\texample,\tin\tmenus\tor\tdialog\tboxes,\tappear\tin\tthe\ttext\tlike\tthis:\t\"The next\tbutton\tthat\twe\twould\twant\tto\tuse\tmost\tof\tthe\ttime\tis\tthe\tShort\tURL button.\"\n\nNote\n\nWarnings\tor\timportant\tnotes\tappear\tin\ta\tbox\tlike\tthis.\n\nTip\n\nTips\tand\ttricks\tappear\tlike\tthis.",
      "content_length": 1162,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 30,
      "content": "Reader\tfeedback\n\nFeedback\tfrom\tour\treaders\tis\talways\twelcome.\tLet\tus\tknow\twhat\tyou\tthink about\tthis\tbookwhat\tyou\tliked\tor\tdisliked.\tReader\tfeedback\tis\timportant\tfor\tus as\tit\thelps\tus\tdevelop\ttitles\tthat\tyou\twill\treally\tget\tthe\tmost\tout\tof.\n\nTo\tsend\tus\tgeneral\tfeedback,\tsimply\te-mail\tfeedback@packtpub.com,\tand mention\tthe\tbook's\ttitle\tin\tthe\tsubject\tof\tyour\tmessage.\n\nIf\tthere\tis\ta\ttopic\tthat\tyou\thave\texpertise\tin\tand\tyou\tare\tinterested\tin\teither writing\tor\tcontributing\tto\ta\tbook,\tsee\tour\tauthor\tguide at\twww.packtpub.com/authors.",
      "content_length": 534,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 31,
      "content": "Customer\tsupport\n\nNow\tthat\tyou\tare\tthe\tproud\towner\tof\ta\tPackt\tbook,\twe\thave\ta\tnumber\tof\tthings to\thelp\tyou\tto\tget\tthe\tmost\tfrom\tyour\tpurchase.",
      "content_length": 142,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 32,
      "content": "Downloading\tthe\texample\tcode\n\nYou\tcan\tdownload\tthe\texample\tcode\tfiles\tfor\tthis\tbook\tfrom\tyour\taccount\tat http://www.packtpub.com.\tIf\tyou\tpurchased\tthis\tbook\telsewhere,\tyou\tcan\tvisit http://www.packtpub.com/support\tand\tregister\tto\thave\tthe\tfiles\te-mailed\tdirectly to\tyou.\n\nYou\tcan\tdownload\tthe\tcode\tfiles\tby\tfollowing\tthese\tsteps:\n\n1.\t Log\tin\tor\tregister\tto\tour\twebsite\tusing\tyour\te-mail\taddress\tand\tpassword. 2.\t Hover\tthe\tmouse\tpointer\ton\tthe\tSUPPORT\ttab\tat\tthe\ttop. 3.\t Click\ton\tCode\tDownloads\t&\tErrata. 4.\t Enter\tthe\tname\tof\tthe\tbook\tin\tthe\tSearch\tbox. 5.\t Select\tthe\tbook\tfor\twhich\tyou're\tlooking\tto\tdownload\tthe\tcode\tfiles. 6.\t Choose\tfrom\tthe\tdrop-down\tmenu\twhere\tyou\tpurchased\tthis\tbook\tfrom. 7.\t Click\ton\tCode\tDownload.\n\nYou\tcan\talso\tdownload\tthe\tcode\tfiles\tby\tclicking\ton\tthe\tCode\tFiles\tbutton\ton the\tbook's\twebpage\tat\tthe\tPackt\tPublishing\twebsite.\tThis\tpage\tcan\tbe\taccessed by\tentering\tthe\tbook's\tname\tin\tthe\tSearch\tbox.\tPlease\tnote\tthat\tyou\tneed\tto\tbe logged\tin\tto\tyour\tPackt\taccount.\n\nOnce\tthe\tfile\tis\tdownloaded,\tplease\tmake\tsure\tthat\tyou\tunzip\tor\textract\tthe folder\tusing\tthe\tlatest\tversion\tof:\n\nWinRAR\t/\t7-Zip\tfor\tWindows Zipeg\t/\tiZip\t/\tUnRarX\tfor\tMac 7-Zip\t/\tPeaZip\tfor\tLinux\n\nThe\tcode\tbundle\tfor\tthe\tbook\tis\talso\thosted\ton\tGitHub\tat https://github.com/PacktPublishing/Microservices-Deployment-Cookbook.\tWe also\thave\tother\tcode\tbundles\tfrom\tour\trich\tcatalog\tof\tbooks\tand\tvideos\tavailable at\thttps://github.com/PacktPublishing/.\tCheck\tthem\tout!",
      "content_length": 1459,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 33,
      "content": "Errata\n\nAlthough\twe\thave\ttaken\tevery\tcare\tto\tensure\tthe\taccuracy\tof\tour\tcontent, mistakes\tdo\thappen.\tIf\tyou\tfind\ta\tmistake\tin\tone\tof\tour\tbooksmaybe\ta\tmistake in\tthe\ttext\tor\tthe\tcodewe\twould\tbe\tgrateful\tif\tyou\tcould\treport\tthis\tto\tus.\tBy doing\tso,\tyou\tcan\tsave\tother\treaders\tfrom\tfrustration\tand\thelp\tus\timprove subsequent\tversions\tof\tthis\tbook.\tIf\tyou\tfind\tany\terrata,\tplease\treport\tthem\tby visiting\thttp://www.packtpub.com/submit-errata,\tselecting\tyour\tbook,\tclicking on\tthe\tErrata\tSubmission\tForm\tlink,\tand\tentering\tthe\tdetails\tof\tyour\terrata. Once\tyour\terrata\tare\tverified,\tyour\tsubmission\twill\tbe\taccepted\tand\tthe\terrata will\tbe\tuploaded\tto\tour\twebsite\tor\tadded\tto\tany\tlist\tof\texisting\terrata\tunder\tthe Errata\tsection\tof\tthat\ttitle.\n\nTo\tview\tthe\tpreviously\tsubmitted\terrata,\tgo\tto https://www.packtpub.com/books/content/support\tand\tenter\tthe\tname\tof\tthe book\tin\tthe\tsearch\tfield.\tThe\trequired\tinformation\twill\tappear\tunder\tthe\tErrata section.",
      "content_length": 948,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 34,
      "content": "Piracy\n\nPiracy\tof\tcopyrighted\tmaterial\ton\tthe\tInternet\tis\tan\tongoing\tproblem\tacross\tall media.\tAt\tPackt,\twe\ttake\tthe\tprotection\tof\tour\tcopyright\tand\tlicenses\tvery seriously.\tIf\tyou\tcome\tacross\tany\tillegal\tcopies\tof\tour\tworks\tin\tany\tform\ton\tthe Internet,\tplease\tprovide\tus\twith\tthe\tlocation\taddress\tor\twebsite\tname immediately\tso\tthat\twe\tcan\tpursue\ta\tremedy.\n\nPlease\tcontact\tus\tat\tcopyright@packtpub.com\twith\ta\tlink\tto\tthe\tsuspected pirated\tmaterial.\n\nWe\tappreciate\tyour\thelp\tin\tprotecting\tour\tauthors\tand\tour\tability\tto\tbring\tyou valuable\tcontent.",
      "content_length": 547,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 35,
      "content": "Questions\n\nIf\tyou\thave\ta\tproblem\twith\tany\taspect\tof\tthis\tbook,\tyou\tcan\tcontact\tus at\tquestions@packtpub.com,\tand\twe\twill\tdo\tour\tbest\tto\taddress\tthe\tproblem.",
      "content_length": 156,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 36,
      "content": "Chapter\t1.\tBuilding\tMicroservices with\tJava\n\nIn\tthis\tchapter,\twe\twill\tcover\tthe\tfollowing\trecipes:\n\nCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven Writing\tmicroservices\twith\tSpring\tBoot Writing\tREST\tAPIs\twith\tSpring\tMVC Writing\tmicroservices\twith\tWildFly\tSwarm Writing\tmicroservices\twith\tDropwizard Writing\tREST\tAPIs\twith\tSparkJava\n\nMicroservices\thave\tgained\ta\tlot\tof\ttraction\trecently.\tA\tmicroservice-based architecture\tis\tone\tway\tof\tdesigning\tyour\tsoftware.\tIn\tsuch\tan\tarchitecture, applications\tare\tbroken\tdown\tinto\tsmaller\tservices\tso\tthat\tthey\tcan\tbe\tdeployed and\tmanaged\tseparately.\tThis\ttakes\taway\ta\tlot\tof\tpain\tpoints\tthat\toccur\tin traditional\tmonolithic\tapplications.\tWith\tthat\tbeing\tsaid,\tmicroservices\tcan\tbe built\tusing\tany\tprogramming\tlanguage.\tIn\tfact,\tthere\tare\tmany\tlibraries\tand frameworks\tthat\thelp\tprogrammers\tbuild\tmicroservices\tusing\tJava,\tScala,\tC#, JavaScript,\tPython,\tRuby,\tand\tso\ton.\tIn\tthis\tbook,\twe\twill\tfocus\tmore\ton building\tand\tdeploying\tmicroservices\twith\tJava.",
      "content_length": 993,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 37,
      "content": "Introduction\n\nIn\ta\ttraditional\tmicroservice-based\tdesign,\tmonolithic\tapplications\twill\tbe broken\tdown\tinto\tsmaller\tservices\tthat\tcan\ttalk\tto\tother\tservices\teither\tin\ta synchronous\tor\tasynchronous\tmodel,\tbased\ton\tthe\tneed\tand\tuse\tcase.\tThe\tfirst question\tthat\tanyone\twould\thave\twhen\tbreaking\tdown\tmonolithic\tapplications\tis \"what\tare\tthe\tpotential\tservices\tthat\tmy\tapplication\tcan\tbe\tbroken\tdown\tinto?\" There\tis\tno\trule\tof\tthumb\tor\tstraight-forward\tanswer\tto\tthis.\tBut\tusually,\tone looks\tfor\tindependent\tfunctionalities.\tEach\tand\tevery\tfunctionality\tcan\tbe considered\tto\tbe\tbuilt\tas\tits\town\tservice.\n\nTo\tillustrate\tthis,\tlet's\ttake\ta\tlook\tat\tan\texample\tapplication\tand\tsee\thow\tit\tcould be\tbroken\tdown\tinto\tsmaller,\tmanageable\tand\tdeployable\tmicroservices.\tThe sample\tapplication\twe\twill\tbe\tlooking\tat\tis\ta\tbiker\ttracking\tapplication.\tThis application\twill\thave\tthe\tfollowing\tfunctionalities:\n\nWeb\tinterface\tto\tmonitor\tthe\tuser's\tprogress\ton\ta\tmap REST\tAPI\tto\tconsume\tthe\tuser's\tgeolocation\tdata\tconstantly Analytics\tcode\tto\tperform\tcalculations\tfor\tbiking\troute\tsuggestions, weather\tpredictions,\tbiking\tgear\tsuggestions,\tcalories\tburnt,\twater\tintake, and\tso\ton\n\nLet's\ttake\ta\tlook\tat\thow\tthis\tapplication\tmight\thave\tbeen\tdesigned\tas\ta monolithic\tapplication:\n\nAs\tyou\tcan\tsee,\tthe\twhole\tapplication\tis\tbundled\tas\tone\tartifact\tand\ttherefore promotes\ta\tsingle\tpoint\tof\tfailure\t(SPOF).\tIf\tfor\tsome\treason\tthe\tanalytics\tcode crashes\tyour\tJVM,\twe\twill\tlose\tthe\tweb\tinterface,\tREST\tAPIs,\tand\tanalytics\tas\ta whole.\tNow,\tlet's\ttake\ta\tlook\tat\thow\tthis\tmight\tbe\tbroken\tdown\tinto\tmanageable",
      "content_length": 1576,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 38,
      "content": "microservices:\n\nIn\tthis\tarchitecture\tdiagram,\tyou\tcan\tsee\tthat\teach\tand\tevery\tfunctionality\tis deployed\tas\tits\town\tmicroservice.\tThe\tservice\timplementations\thave\tbeen broken\tdown\tinto\ta\tNotification\tService,\twhich\twill\ttake\tcare\tof\tsending notifications\tto\tthe\tusers,\tand\tthe\tGeo\tLocation\tTracker\tService,\twhich\tkeeps track\tof\tthe\tgeolocation\t(latitude\tand\tlongitude)\tinformation\tof\tall\tthe\tusers.\tThe Analytics\tcode\thas\tbeen\tbroken\tdown\tinto\tits\town\tmicroservices.\tSo\tif\tone\ttype of\tanalytics\tmicroservice\tgoes\tdown,\tthe\tother\tmicroservices\twill\tkeep functioning\tproperly.\tYou\tmight\thave\tnoticed\tthat\tthe\tREST\tAPIs\tare\tmissing. They\tare\tactually\tnot\tmissing,\tbut\tintegrated\tinto\ttheir\trespective\tmicroservices.\n\nNow\tlet's\tnot\twaste\tany\tmore\ttime\tand\tjump\tdirectly\tinto\tbuilding\tone\tpart\tof this\tapplication.\tTo\tbe\table\tto\tillustrate\tthe\textensive\tconcepts\tthat\tthis\tbook offers,\tI\thave\tchosen\tthe\tgeolocation\ttracker\tservice\tas\tour\texample microservice.\tThis\tservice\twill\tbe\tresponsible\tfor\tcollecting\tthe\tgeolocation\tof all\tusers\tof\tthis\tapplication\tand\tthen\tstoring\tthem\tin\ta\tdata\tstore.",
      "content_length": 1090,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 39,
      "content": "Creating\ta\tproject\ttemplate\tusing STS\tand\tMaven\n\nCreating\ta\tproject\tfor\tyour\tmicroservice\tis\tno\tdifferent\tthan\tcreating\ta\tsimple Java\tproject.\tWe\twill\tuse\tMaven\tas\tour\tbuild\tframework\tas\tit\tis\tconsidered\tto\tbe one\tof\tthe\tmost\tpopular\tbuild\tframeworks.\tIf\tyou\tare\tcomfortable\tusing\tother frameworks,\tsuch\tas\tGradle,\tSBT,\tor\tIvy,\tfeel\tfree\tto\tuse\tthem.\tBut\tkeep\tin\tmind that\tthe\trecipes\tthroughout\tthis\tbook\twill\tuse\tMaven\textensively.\tUnless\tyou\tare an\texpert\tin\tyour\tpreferred\tframework,\tI\tstrongly\trecommend\tusing\tMaven.",
      "content_length": 521,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 40,
      "content": "Getting\tready\n\nIn\torder\tto\tcreate\tyour\tmicroservice\tproject,\tyou\twill\tneed\tthe\tfollowing software.\tFollow\tthe\tinstructions\ton\ttheir\trespective\twebsites\tto\tinstall\tthem:\n\nJDK\t1.8+ Maven\t3.3.9+ Spring\tTool\tSuite\t(STS)\t3.8.0+\n\nMake\tsure\tboth\tJava\tand\tMaven\tare\tin\tyour\tPATH\tvariable\tso\tthat\tyou\tcan\tuse the\tjava\tand\tmvn\tcommands\ton\tevery\tterminal\tshell\twithout\thaving\tto\tset\tPATH each\ttime.\tSpring\tTool\tSuite\tis\ta\tsophisticated\tversion\tof\tEclipse\tthat\thas\tlot\tof Spring\tplugins\tand\textensions.\tIf\tyou\tare\tfamiliar\twith\tother\tIDEs,\tfeel\tfree\tto use\tthem.\tBut\tfor\tfamiliarity,\tthis\tbook\twill\tuse\tSTS\tfor\tall\trecipes.",
      "content_length": 611,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 41,
      "content": "How\tto\tdo\tit...\n\nAfter\tyou\thave\tinstalled\tthe\tabove-mentioned\tsoftware,\topen\tSpring\tTool\tSuite. The\tfirst\ttime\tyou\topen\tit,\tyou\twill\tbe\trequested\tto\tchoose\ta\tworkspace.\tGo ahead\tand\tenter\tyour\tworkspace\tlocation.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto create\ta\ttemplate\tMaven\tproject\tusing\tSTS\tand\tMaven.\tSTS\tcomes\twith\tMaven Integration\tout\tof\tthe\tbox.\tSo\twe\tdon't\thave\tto\tconfigure\tit\tany\tfurther.\tAfter your\tSTS\tIDE\thas\tcompleted\tstartup,\tfollow\tthe\tbelow\tinstructions\tto\tcreate\ta new\tMaven\tproject:\n\n1.\t In\tyour\tSTS\twindow,\tright-click\tanywhere\ton\tthe\tPackage\tExplorer, select\tNew,\tand\tthen\tselect\tMaven\tProject,\tas\tshown\tin\tthe\tfollowing screenshot:",
      "content_length": 652,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 42,
      "content": "2.\t This\twill\topen\ta\tpopup\tthat\twill\tlet\tyou\tchose\tthe\ttype\tof\tMaven\tproject you\twould\tlike\tto\tcreate.\tWe\twill\tskip\tthe\tarchetype\tselection\tby\tchecking the\tbox\tthat\tsays\tCreate\ta\tsimple\tproject\t(skip\tarchetype\tselection)\tand then\thit\tNext:",
      "content_length": 239,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 43,
      "content": "3.\t In\tthe\tnext\twindow,\tenter\tthe\tfollowing\tdetails\tto\tcreate\tyour\tproject: Group\tId:\tcom.packt.microservices Artifact\tId:\tgeolocation Name:\tgeolocation\n\n4.\t After\tyou\thave\tentered\tthe\tdetails,\thit\tFinish:",
      "content_length": 205,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 44,
      "content": "5.\t This\twill\tcreate\ta\tsimple\tMaven\tJAR\tmodule\twith\tall\tthe\trequired directories\tin\tplace.\tDepending\ton\tyour\tIDE\tsettings,\tSTS\tconfigures\tyour new\tproject\twith\tthe\tdefault\tJava\tversion.\tIf\tyou\thave\tnot\tset\tany\tdefaults, it\twill\tconfigure\tyour\tproject\twith\tJava\t1.5.\tYou\tcan\tverify\tthis\tby\tchecking your\tproject\tstructure\tin\tSTS.\tThe\tfollowing\tscreenshot\tshows\tthat\tSTS uses\tJava\t1.5\tfor\tyour\tproject:",
      "content_length": 400,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 45,
      "content": "6.\t We\twill\tuse\tJava\t8's\tlambda\texpressions\tin\tother\tchapters.\tSo\tlet's\tchange the\tJava\tversion\tfrom\t1.5\tto\t1.8.\tIn\torder\tto\tchange\tthe\tJava\tversion,\twe will\tconfigure\tthe\tmaven-compiler-plugin\tin\tthe\tpom.xmlfile.\tAdd\tthe following\tsection\tof\tcode\tto\tyour\tpom.xml\tfile's\tproject\tsection:\t<build> <plugins>\t<plugin>\t<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<version>3.5.1</version> <configuration>\t<source>1.8</source>\t<target>1.8</target> </configuration>\t</plugin>\t</plugins>\t</build>\n\n7.\t Save\tyour\tpom.xml\tfile,\tright-click\ton\tyour\tproject,\tchoose\tMaven,\tand then\thit\tUpdate\tProject...\tor\tuse\tthe\tkeyboard\tshortcut\tAlt\t+\tF5.\tThis\twill automatically\tchange\tyour\tproject's\tJava\tversion\tto\t1.8.\n\n8.\t Our\tmicroservice\tproject\tis\tnow\tready\tto\tplay\twith.",
      "content_length": 801,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 46,
      "content": "There's\tmore...\n\nIf\tyou\tare\tmore\tcomfortable\tusing\tthe\tcommand\tline\tto\tcreate\tMaven\tprojects, issue\tthe\tfollowing\tcommand\tin\tyour\tterminal\tto\tcreate\tthe\tnew\tproject:\n\nmvn\t-B\tarchetype:generate\t- DarchetypeGroupId=org.apache.maven.archetypes\t\\ -DgroupId=com.packt.microservices\t-DartifactId=geolocation\t\\\t -Dname=geolocation\n\nAfter\tMaven\tcreates\tthe\tproject,\tyou\tshould\tbe\table\tto\timport\tyour\tproject\tinto your\tIDE.\tAs\tthis\tis\tsomething\tout\tof\tthe\tscope\tof\tthis\tbook,\twe\twill\tnot\tbe looking\tat\thow\tto\timport\tan\texisting\tMaven\tproject\tinto\tyour\tIDE.",
      "content_length": 547,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 47,
      "content": "Writing\tmicroservices\twith\tSpring Boot\n\nNow\tthat\tour\tproject\tis\tready,\tlet's\tlook\tat\thow\tto\twrite\tour\tmicroservice.\tThere are\tseveral\tJava-based\tframeworks\tthat\tlet\tyou\tcreate\tmicroservices.\tOne\tof\tthe most\tpopular\tframeworks\tfrom\tthe\tSpring\tecosystem\tis\tthe\tSpring\tBoot framework.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tcreate\ta\tsimple\tmicroservice application\tusing\tSpring\tBoot.",
      "content_length": 380,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 48,
      "content": "Getting\tready\n\nAny\tapplication\trequires\tan\tentry\tpoint\tto\tstart\tthe\tapplication.\tFor\tJava-based applications,\tyou\tcan\twrite\ta\tclass\tthat\thas\tthe\tmain\tmethod\tand\trun\tthat\tclass\tas a\tJava\tapplication.\tSimilarly,\tSpring\tBoot\trequires\ta\tsimple\tJava\tclass\twith\tthe main\tmethod\tto\trun\tit\tas\ta\tSpring\tBoot\tapplication\t(microservice).\tBefore\tyou start\twriting\tyour\tSpring\tBoot\tmicroservice,\tyou\twill\talso\trequire\tsome\tMaven dependencies\tin\tyour\tpom.xml\tfile.",
      "content_length": 450,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 49,
      "content": "How\tto\tdo\tit... 1.\t Create\ta\tJava\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationApplication.java and\tgive\tit\tan\tempty\tmain\tmethod:\n\npackage\tcom.packt.microservices.geolocation;\t\t \t\t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\t{\t\t \t\t\t\t\t\t\t\t\t\t\t\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{\t \t\t\t\t\t\t\t\t\t\t\t\t//\tleft\tempty\tintentionally\t \t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\n\n2.\t Now\tthat\twe\thave\tour\tbasic\ttemplate\tproject,\tlet's\tmake\tour\tproject\ta\tchild project\tof\tSpring\tBoot's\tspring-boot-starter-parent\tpom\tmodule.\tThis module\thas\ta\tlot\tof\tprerequisite\tconfigurations\tin\tits\tpom.xml\tfile,\tthereby reducing\tthe\tamount\tof\tboilerplate\tcode\tin\tour\tpom.xml\tfile.\tAt\tthe\ttime\tof writing\tthis,\t1.3.6.RELEASE\twas\tthe\tmost\trecent\tversion: <parent>\t \t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId>\t \t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-starter-parent</artifactId>\t \t\t\t\t\t\t\t\t\t\t<version>1.3.6.RELEASE</version>\t \t\t\t\t\t\t\t\t</parent>\n\n3.\t After\tthis\tstep,\tyou\tmight\twant\tto\trun\ta\tMaven\tupdate\ton\tyour\tproject\tas you\thave\tadded\ta\tnew\tparent\tmodule.\tIf\tyou\tsee\tany\twarnings\tabout\tthe version\tof\tthe\tmaven-compiler\t\tplugin,\tyou\tcan\teither\tignore\tit\tor\tjust remove\tthe\t<version>3.5.1</version>\telement.\tIf\tyou\tremove\tthe\tversion element,\tplease\tperform\ta\tMaven\tupdate\tafterward.\n\n4.\t Spring\tBoot\thas\tthe\tability\tto\tenable\tor\tdisable\tSpring\tmodules\tsuch\tas Spring\tMVC,\tSpring\tData,\tand\tSpring\tCaching.\tIn\tour\tuse\tcase,\twe\twill\tbe creating\tsome\tREST\tAPIs\tto\tconsume\tthe\tgeolocation\tinformation\tof\tthe users.\tSo\twe\twill\tneed\tSpring\tMVC.\tAdd\tthe\tfollowing\tdependencies\tto your\tpom.xml\tfile:\n\n<dependencies>\t \t\t\t\t\t\t\t\t\t\t<dependency>\t \t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId>\t \t\t\t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-starter-web</artifactId>\t \t\t\t\t\t\t\t\t\t\t</dependency>\t \t\t\t\t\t\t\t\t</dependencies>",
      "content_length": 1772,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 50,
      "content": "5.\t We\talso\tneed\tto\texpose\tthe\tAPIs\tusing\tweb\tservers\tsuch\tas\tTomcat,\tJetty, or\tUndertow.\tSpring\tBoot\thas\tan\tin-memory\tTomcat\tserver\tthat\tstarts\tup\tas soon\tas\tyou\tstart\tyour\tSpring\tBoot\tapplication.\tSo\twe\talready\thave\tan\tin- memory\tTomcat\tserver\tthat\twe\tcould\tutilize.\n\n6.\t Now\tlet's\tmodify\tthe\tGeoLocationApplication.java\tclass\tto\tmake\tit\ta Spring\tBoot\tapplication:\n\npackage\tcom.packt.microservices.geolocation;\t \t\t\t\t\t\t\t\timport\torg.springframework.boot.SpringApplication;\t \t\t\t\t\t\t\t\timport\torg.springframework.boot.autoconfigure \t\t\t\t\t\t\t\t\t.SpringBootApplication;\t \t\t\t\t\t\t\t\t\t\t@SpringBootApplication\t \t\t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\t{\t \t\t\t\t\t\t\t\t\t\t\t\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\t\t\t\t\tSpringApplication.run(GeoLocationApplication.class,\t args);\t \t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tadded\tan\tannotation,\t@SpringBootApplication,\tto\tour class.\tThe\t@SpringBootApplication\tannotation\treduces\tthe\tnumber\tof\tlines\tof code\twritten\tby\tadding\tthe\tfollowing\tthree\tannotations\timplicitly:\n\n@Configuration\n\n@ComponentScan\n\n@EnableAutoConfiguration\n\nIf\tyou\tare\tfamiliar\twith\tSpring,\tyou\twill\talready\tknow\twhat\tthe\tfirst\ttwo annotations\tdo.\t@EnableAutoConfiguration\tis\tthe\tonly\tannotation\tthat\tis\tpart\tof Spring\tBoot.\tThe\tAutoConfiguration\tpackage\thas\tan\tintelligent\tmechanism\tthat guesses\tthe\tconfiguration\tof\tyour\tapplication\tand\tautomatically\tconfigures\tthe beans\tthat\tyou\twill\tlikely\tneed\tin\tyour\tcode.\n\nYou\tcan\talso\tsee\tthat\twe\thave\tadded\tone\tmore\tline\tto\tthe\tmain\tmethod,\twhich actually\ttells\tSpring\tBoot\tthe\tclass\tthat\twill\tbe\tused\tto\tstart\tthis\tapplication.\tIn our\tcase,\tit\tis\tGeoLocationApplication.class.\tIf\tyou\twould\tlike\tto\tadd\tmore initialization\tlogic\tto\tyour\tapplication,\tsuch\tas\tsetting\tup\tthe\tdatabase\tor\tsetting up\tyour\tcache,\tfeel\tfree\tto\tadd\tit\there.\n\n1.\t Now\tthat\tour\tSpring\tBoot\tapplication\tis\tall\tset\tto\trun,\tlet's\tsee\thow\tto\trun",
      "content_length": 1877,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 51,
      "content": "our\tmicroservice.\tRight-click\ton\tGeoLocationApplication.java\tfrom Package\tExplorer,\tselect\tRun\tAs,\tand\tthen\tselect\tSpring\tBoot\tApp.\tYou can\talso\tchoose\tJava\tApplication\tinstead\tof\tSpring\tBoot\tApp.\tBoth\tthe options\tultimately\tdo\tthe\tsame\tthing.\tYou\tshould\tsee\tsomething\tlike\tthis\ton your\tSTS\tconsole:\n\n2.\t If\tyou\tlook\tclosely\tat\tthe\tconsole\tlogs,\tyou\twill\tnotice\tthat\tTomcat\tis\tbeing started\ton\tport\tnumber\t8080.\tIn\torder\tto\tmake\tsure\tour\tTomcat\tserver\tis listening,\tlet's\trun\ta\tsimple\tcurl\tcommand.\tcURL\tis\ta\tcommand-line\tutility available\ton\tmost\tUnix\tand\tMac\tsystems.\tFor\tWindows,\tuse\ttools\tsuch\tas Cygwin\tor\teven\tPostman.\tPostman\tis\ta\tGoogle\tChrome\textension\tthat\tgives you\tthe\tability\tto\tsend\tand\treceive\tHTTP\trequests.\tFor\tsimplicity,\twe\twill use\tcURL.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal: curl\thttp://localhost:8080\n\n3.\t This\tshould\tgive\tus\tan\toutput\tlike\tthis:\n\n{\"timestamp\":1467420963000,\"status\":404,\"error\":\"Not \t\t\t\t\t\tFound\",\"message\":\"No\tmessage\tavailable\",\"path\":\"/\"}\n\nThis\terror\tmessage\tis\tbeing\tproduced\tby\tSpring.\tThis\tverifies\tthat\tour\tSpring Boot\tmicroservice\tis\tready\tto\tstart\tbuilding\ton\twith\tmore\tfeatures.\tThere\tare more\tconfigurations\tthat\tare\tneeded\tfor\tSpring\tBoot,\twhich\twe\twill\tperform",
      "content_length": 1222,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 52,
      "content": "more\tconfigurations\tthat\tare\tneeded\tfor\tSpring\tBoot,\twhich\twe\twill\tperform later\tin\tthis\tchapter\talong\twith\tSpring\tMVC.",
      "content_length": 119,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 53,
      "content": "Writing\tREST\tAPIs\twith\tSpring MVC\n\nThere\tare\ttwo\ttypes\tof\tcommunication\tmodels.\tOne\tof\tthem\tis\tsynchronous, where\tthe\tclient\twaits\tfor\tthe\tserver\tto\trespond\tto\tits\trequest.\tThe\tother\tis asynchronous,\twhere\tthe\tclient\tfires\ta\trequest\tand\tforgets.\tThough\tServlet\t3.0 and\tabove\tlet\tyou\tcreate\tasynchronous\tservlets,\tin\tour\trecipes,\twe\twill\tfocus\ton traditional\tservlet-based\tHTTP\tAPIs\tfor\tsimplicity.\tWe\twill\talso\tbe\tlooking\tat asynchronous\tcommunication\tin\tlater\tchapters.",
      "content_length": 470,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 54,
      "content": "Getting\tready\n\nWhen\tit\tcomes\tto\tbuilding\tREST\tAPIs,\tthere\tare\tseveral\tframeworks\tto\tchoose from.\tAs\twe\talready\tset\tup\tthe\tSpring\tecosystem\tin\tour\tprevious\trecipe,\tit\twould make\tmore\tsense\tand\tbe\tmuch\teasier\tto\tuse\tSpring\tMVC\tto\texpose\tREST\tAPIs.",
      "content_length": 245,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 55,
      "content": "How\tto\tdo\tit...\n\nThe\ttrue\tadvantage\tof\tSpring\tBoot\tis\tthat\tyou\tdo\tnot\thave\tto\tadd\tany\tnew dependencies\tto\tenable\tweb\tsupport\tfor\tyour\tapplication.\tSpring\tBoot's\tparent pom\tfile\t(spring-boot-starter-parent)\ttakes\tcare\tof\tthat\tfor\tyou.\tNow\tlet's take\ta\tlook\tat\thow\tto\twrite\tour\tfirst\tAPI.\tIf\tyou\tare\tfamiliar\twith\tSpring\tMVC, this\tshould\tbe\treally\tstraight-forward\tfor\tyou:\n\n1.\t Create\ta\tController\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationController.java, which\twill\tbe\tresponsible\tfor\tbasic\tCRUD\toperations\tfor\tthe\tgeolocation\tof all\tusers:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport org.springframework.web.bind.annotation.RequestMapping; \t\t\t\t\t\t\t\timport org.springframework.web.bind.annotation.RestController;\n\n@RestController \t\t\t\t\t\t\t\t@RequestMapping(\"/geolocation\") \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationController\t{\n\n}\n\nThere\tare\ttwo\tthings\tto\tnote\there.\tThe\t@RestController\tannotation indicates\tthat\twe\tare\tgoing\tto\tuse\tthis\tcontroller\tto\texpose\tour\tREST\tAPIs. It\timplicitly\tadds\tthe\t@ResponseBody\tannotation\tto\tall\tcontroller\tmethods\tas that\tis\tsomething\tyou\twould\twant\tto\tdo\twhen\texposing\tyour\tREST\tAPIs using\tSpring\tMVC.\tThe\t@RequestMapping\tannotation\tspecifies\twhere\tyour HTTP\tresource\tis\tlocated.\tWe\tare\tsetting\t@RequestMapping\ton\tthe controller\tlevel\tto\tapply\tit\tto\tall\tcontroller\tmethods.\n\nNote\n\nUsing\t@RequestMapping\ton\tthe\tController\tclass\tlevel\tto\tdefine\ta\troot resource\tpath\tis\tconsidered\tto\tbe\tone\tof\tthe\tbest\tpractices.\tInstead\tof\thaving to\tcreate\tAPI\tpaths\tsuch\tas\t/getGeolocation\tor\t/createGeolocation,\tit is\talways\ta\tbetter\tpractice\tto\tuse\tthe\tsame\tpath,\t/geolocation,\twith\tthe\tGET method\tto\tget\tgeolocation\tdata\tand\tthe\tPOST\tmethod\tto\tcreate\tgeolocation",
      "content_length": 1699,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 56,
      "content": "data.\n\n2.\t Before\twe\tjump\tinto\tcreating\tour\tAPIs,\twe\twill\tneed\tsome\tclasses\tfor\tthe domain\tobject\tand\tservice.\tLet's\tstart\twith\tcreating\tour\tdomain\tobject. Assume\tthat\tour\tGeoLocation\tconsists\tlatitude\tand\tlongitude.\tWe\twill\tbe defining\tboth\tlatitude\tand\tlongitude\tas\tdouble\tto\tprovide\tbetter\tprecision. Now\twe\twill\thave\tto\tsay\twhich\tuser's\tgeolocation\tit\tis.\tSo\twe\tmight\twant\tto add\ta\tuserId.\tWe\talso\tneed\tto\tsay\tat\twhat\ttime\tthe\tuser\twas\tat\tthe geolocation.\tSo\twe\tmight\twant\tto\tadd\ta\ttimestamp\tin\tEPOCH\ttime\tformat. The\ttimestamp\twill\tbe\tof\ttype\tlong.\tThis\tis\thow\tyour\tplain\told\tjava\tobject (POJO)\tclass\twill\tlook: import\tjava.io.Serializable; \t\t\t\t\t\t\t\timport\tjava.util.UUID;\n\npublic\tclass\tGeoLocation\timplements\tSerializable\t{\n\nprivate\tstatic\tfinal\tlong\tserialVersionUID\t=\t1L;\n\nprivate\tdouble\tlatitude; \t\t\t\t\t\t\t\t\t\t\tprivate\tdouble\tlongitude; \t\t\t\t\t\t\t\t\t\t\tprivate\tUUID\tuserId; \t\t\t\t\t\t\t\t\t\t\tprivate\tlong\ttimestamp;\n\npublic\tdouble\tgetLatitude()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\tlatitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetLatitude(double\tlatitude)\t{ \t\t\t\t\t\t\t\t\t\t\t\tthis.latitude\t=\tlatitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tdouble\tgetLongitude()\t{ \t\t\t\t\t\t\t\t\t\t\treturn\tlongitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetLongitude(double\tlongitude)\t{ \t\t\t\t\t\t\t\t\t\t\t\tthis.longitude\t=\tlongitude; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tUUID\tgetUserId()\t{ \t\t\t\t\t\t\t\t\t\t\treturn\tuserId; \t\t\t\t\t\t\t\t\t\t}",
      "content_length": 1310,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 57,
      "content": "public\tvoid\tsetUserId(UUID\tuserId)\t{ \t\t\t\t\t\t\t\t\t\t\tthis.userId\t=\tuserId; \t\t\t\t\t\t\t\t\t\t}\n\npublic\tlong\tgetTimestamp()\t{ \t\t\t\t\t\t\t\t\t\treturn\ttimestamp; \t\t\t\t\t\t\t\t\t}\n\npublic\tvoid\tsetTimestamp(long\ttimestamp)\t{ \t\t\t\t\t\t\t\t\t\tthis.timestamp\t=\ttimestamp; \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tused\tthe\tjava.util.UUID\tclass\tto\trepresent\tthe userId,\tassuming\tthat\tthis\tUUID\tuniquely\tidentifies\ta\tuser.\tWe\twill\tnot\tbe creating\tthe\tuser\tPOJO\tas\tit\tis\tout\tof\tscope\tfor\tthis\trecipe.\n\nIn\tan\tideal\tscenario,\tone\twould\tbe\tusing\ta\tNoSQL\tor\trelational\tdatabase\tto store\tthe\tgeolocations.\tIn\tthis\tcase,\tNoSQL\tsounds\tmore\tsuitable\tdue\tto several\treasons,\tincluding\tthe\tfact\tthat\tour\tdata\tis\ttime\tseries\tdata,\tin\tJSON format,\tunstructured\tbut\twill\tchange\tover\ttime\tand\twe\twill\thave\ta humongous\tamount\tof\tdata.\n\n3.\t For\tsimplicity\tpurposes,\twe\twill\tbe\tstoring\tour\tgeolocations\tin\tan\tin- memory\tjava.util.List<GeoLocation>\tcollection.\tLet's\tcreate\tour repository\tthat\tholds\tall\tour\tgeolocation\tobjects, com.packt.microservices.geolocation.GeoLocationRepository.java: package\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList; \t\t\t\t\t\t\t\timport\tjava.util.Collections; \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\n@Repository \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew \t\t\t\t\t\t\t\t\t\tArrayList<GeoLocation>();\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation) { \t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation);",
      "content_length": 1470,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 58,
      "content": "geolocations.add(geolocation); \t\t\t\t\t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\treturn Collections.unmodifiableList(geolocations); \t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t}\n\n4.\t Now\tlet's\ttake\ta\tlook\tat\thow\tyour\tService\tinterface\twill\tlook:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.List;\n\npublic\tinterface\tGeoLocationService\t{\n\npublic\tGeoLocation\tcreate(GeoLocation\tgeolocation); \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll(); \t\t\t\t\t\t\t\t}\n\n5.\t Both\tour\trepository\tand\tservice\thave\ta\tvery\tsimple\tinterface.\tIdeally\tin real-time\tapplications,\tyou\tmight\twant\tto\tadd\tmore\tcomplicated\tmethods that\tnot\tonly\tperform\tCRUD\toperations\tbut\talso\tsort,\tfilter,\tselect\tonly specific\tfields,\tand\tso\ton.\tNow\tlet's\ttake\ta\tlook\tat\tour com.packt.microservices.geolocation.GeoLocationServiceImpl.java class:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.List;\n\nimport org.springframework.beans.factory.annotation.Autowired;\n\nimport\torg.springframework.stereotype.Service;\n\n@Service \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationServiceImpl\timplements \t\t\t\t\t\t\t\tGeoLocationService\t{\n\n@Autowired \t\t\t\t\t\t\t\t\t\tprivate\tGeoLocationRepository\trepository;\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\t\t\trepository.addGeoLocation(geolocation); \t\t\t\t\t\t\t\t\t\t\treturn\tgeolocation;",
      "content_length": 1311,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 59,
      "content": "return\tgeolocation; \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\trepository.getGeoLocations(); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nNote\n\nIt\tis\talways\tstrongly\trecommended\tthat\tyou\twrite\tunit\ttest\tcases\tfor\tany new\tcode.\tBut\tas\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tthis\tbook,\twe\twill\tnot\tbe writing\tunit\ttest\tcases\tfor\tany\tof\tthe\tprevious\tcode.\tTo\tlearn\tmore\tabout unit\ttesting\tSpring\tBoot\tapplications,\tplease\ttake\ta\tlook\tat\tSpring\tBoot's documentation\tat\thttps://docs.spring.io/spring- boot/docs/current/reference/html/boot-features-testing.html.\n\n6.\t Now\tthat\tour\tdomain\tand\tservice\tclasses\tare\tall\tset\tto\tgo,\tlet's\tmodify\tour Controller\tclass\tto\tsave\tand\tfind\tgeolocations.\tAdd\tthe\tfollowing\tsnippet into\tyour\tController\tclass\tbody: @Autowired \t\t\t\t\t\t\t\tprivate\tGeoLocationService\tservice;\n\n@RequestMapping(method\t=\tRequestMethod.POST,\tproduces\t=\t \"application/json\",\tconsumes\t=\t\"application/json\") \t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(@RequestBody\tGeoLocation\t geolocation)\t{ \t\t\t\t\t\t\t\t\t\treturn\tservice.create(geolocation); \t\t\t\t\t\t\t\t}\n\n@RequestMapping(method\t=\tRequestMethod.GET,\tproduces\t=\t \"application/json\") \t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t\t\t}\n\nIn\tthis\timplementation,\tthere\tare\ta\tfew\tthings\tto\tnotice.\tThe\t@RequestMapping annotation\tdoes\tnot\thave\ta\tpath\tdefined\tas\tit\tis\talready\tderived\tfrom\tthe\tclass- level\tannotation.\tFor\tboth\tthe\tcreate\tand\tfindAll\tmethods,\twe\tare\tusing\tthe same\tpath\tbut\tdifferent\tHTTP\tmethods\tas\tper\tbest\tpractice.\tSince\twe\tare\tdealing only\twith\tJSON\there,\twe\thave\tset\tthe\tproduces\tand\tconsumes\tvalues\tto",
      "content_length": 1611,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 60,
      "content": "application/json.\tThe\treturn\ttypes\tof\tthe\tcreate\tand\tfindAll\tmethods\tare GeoLocation\tand\tList<GeoLocation>\trespectively.\tSpring\tMVC\tinternally\tuses Jackson\tto\tconvert\tthem\tto\ttheir\tequivalent\tJSON\tstrings.\n\nThat's\tit!\tWe\tare\tnow\tready\tto\ttest\tour\tapplication:\n\n1.\t Let's\ttry\tto\tcreate\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto retrieve\tthem\tusing\tthe\tGET\tmethod.\tExecute\tthe\tfollowing\tcURL commands\tin\tyour\tterminal\tone\tby\tone: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{\t \t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488,\t \t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404,\t \t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n3.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n4.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation",
      "content_length": 1540,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 61,
      "content": "5.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[\t \t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t},\t \t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t]\n\nYou\tnow\thave\ta\tfully\tworking\tversion\tof\tyour\tmicroservice.\tThe remaining\trecipes\tin\tthis\tchapter\ttry\tto\tachieve\tthe\tsame\tlogic\twith\tdifferent frameworks,\tsuch\tas\tWildFly\tSwarm\tand\tDropwizard.\tLater\tin\tthis\tchapter,\twe will\talso\tlook\tat\tanother\tframework\tthat\thelps\tyou\tbuild\tREST\tAPIs\tquickly called\tSparkJava\t(different\tfrom\tApache\tSpark).\tIf\tyou\twill\tbe\tusing\tSpring Boot\tfor\tyour\tmicroservices,\tyou\tcan\tjump\tto\tthe\tnext\tchapter.\tIf\tyou\tare interested\tin\tany\tof\tthe\tframeworks\tthat\twere\tmentioned,\tjump\tto\tthe\tappropriate recipe\tin\tthis\tchapter.",
      "content_length": 1030,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 62,
      "content": "Writing\tmicroservices\twith\tWildFly Swarm\n\nWildFly\tSwarm\tis\ta\tJ2EE\tapplication\tpackaging\tframework\tfrom\tRedHat\tthat utilizes\tthe\tin-memory\tUndertow\tserver\tto\tdeploy\tmicroservices.\tIn\tthis\trecipe, we\twill\tcreate\tthe\tsame\tGeoLocation\tAPI\tusing\tWildFly\tSwarm\tand\tJAX-RS.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe WildFly\tSwarm\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there to\thelp\tyou\tget\tstarted\ton\tWildFly\tSwarm.\tWhen\tyou\tare\tbuilding\tyour production-level\tapplication,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly Swarm,\tDropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.",
      "content_length": 629,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 63,
      "content": "Getting\tready\n\nSimilar\tto\thow\twe\tcreated\tthe\tSpring\tBoot\tMaven\tproject,\tcreate\ta\tMaven\tWAR module\twith\tthe\tgroupId\t\tcom.packt.microservices\tand\tname/artifactId\t geolocation-wildfly.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline.\tBe aware\tthat\tsome\tIDEs\tcomplain\tabout\ta\tmissing\tweb.xml\tfile.\tWe\twill\tsee\thow to\tfix\tthat\tin\tthe\tnext\tsection.",
      "content_length": 347,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 64,
      "content": "How\tto\tdo\tit... 1.\t Before\twe\tset\tup\tthe\tWildFly\tSwarm\tproject,\twe\thave\tto\tfix\tthe\tmissing\n\nweb.xml\terror.\tThe\terror\tmessage\tsays\tthat\tMaven\texpects\tto\tsee\ta\tweb.xml file\tin\tyour\tproject\tas\tit\tis\ta\tWAR\tmodule,\tbut\tthis\tfile\tis\tmissing\tin\tyour project.\tIn\torder\tto\tfix\tthis,\twe\thave\tto\tadd\tand\tconfigure\tmaven-war- plugin.\tAdd\tthe\tfollowing\tcode\tsnippet\tto\tyour\tpom.xml\tfile's\tproject section:\n\n<build> \t\t\t\t\t\t\t\t\t\t<plugins> \t\t\t\t\t\t\t\t\t\t\t\t<plugin> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>maven-war-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<version>2.6</version> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<configuration>\n\n<failOnMissingWebXml>false</failOnMissingWebXml> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t\t\t\t\t</plugin> \t\t\t\t\t\t\t\t\t\t\t</plugins> \t\t\t\t\t\t\t\t</build>\n\n2.\t After\tadding\tthe\tsnippet,\tsave\tyour\tpom.xml\tfile\tand\tperform\ta\tMaven update.\tAlso,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion\tother\tthan 1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven\trecipe\tto change\tthe\tJava\tversion\tto\t1.8.\tAgain,\tperform\ta\tMaven\tupdate\tfor\tthe changes\tto\ttake\teffect.\n\n3.\t Now,\tlet's\tadd\tthe\tdependencies\trequired\tfor\tthis\tproject.\tAs\twe\tknow\tthat we\twill\tbe\texposing\tour\tAPIs,\twe\thave\tto\tadd\tthe\tJAX-RS\tlibrary.\tJAX-RS is\tthe\tstandard\tJSR-compliant\tAPI\tfor\tcreating\tRESTful\tweb\tservices. JBoss\thas\tits\town\tversion\tof\tJAX-RS.\tSo\tlet's\tadd\tthat\tdependency\tto\tthe pom.xml\tfile:\n\n<dependencies> \t\t\t\t\t\t\t\t\t\t<dependency> \t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.jboss.spec.javax.ws.rs</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>jboss-jaxrs-api_2.0_spec</artifactId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<version>1.0.0.Final</version> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<scope>provided</scope> \t\t\t\t\t\t\t\t\t\t</dependency> \t\t\t\t\t\t\t\t</dependencies>",
      "content_length": 1685,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 65,
      "content": "Note\n\nThe\tone\tthing\tthat\tyou\thave\tto\tnote\there\tis\tthe\tprovided\tscope.\tThe provided\tscope\tin\tgeneral\tmeans\tthat\tthis\tJAR\tneed\tnot\tbe\tbundled\twith\tthe final\tartifact\twhen\tit\tis\tbuilt.\tUsually,\tthe\tdependencies\twith\tprovided\tscope will\tbe\tavailable\tto\tyour\tapplication\teither\tvia\tyour\tweb\tserver\tor application\tserver.\tIn\tthis\tcase,\twhen\tWildfly\tSwarm\tbundles\tyour\tapp\tand runs\tit\ton\tthe\tin-memory\tUndertow\tserver,\tyour\tserver\twill\talready\thave this\tdependency.\n\n4.\t The\tnext\tstep\ttoward\tcreating\tthe\tGeoLocation\tAPI\tusing\tWildfly\tSwarm is\tcreating\tthe\tdomain\tobject.\tUse\tthe com.packt.microservices.geolocation.GeoLocation.java\tfile\tfrom\tthe previous\trecipe.\n\n5.\t Now\tthat\twe\thave\tthe\tdomain\tobject,\tthere\tare\ttwo\tclasses\tthat\tyou\tneed\tto create\tin\torder\tto\twrite\tyour\tfirst\tJAX-RS\tweb\tservice.\tThe\tfirst\tof\tthose\tis the\tApplication\tclass.\tThe\tApplication\tclass\tin\tJAX-RS\tis\tused\tto\tdefine the\tvarious\tcomponents\tthat\tyou\twill\tbe\tusing\tin\tyour\tapplication.\tIt\tcan also\thold\tsome\tmetadata\tabout\tyour\tapplication,\tsuch\tas\tyour\tbasePath\t(or ApplicationPath)\tto\tall\tresources\tlisted\tin\tthis\tApplication\tclass.\tIn\tthis case,\twe\tare\tgoing\tto\tuse\t/geolocation\tas\tour\tbasePath.\tLet's\tsee\thow\tthat looks: package\tcom.packt.microservices.geolocation;\n\nimport\tjavax.ws.rs.ApplicationPath; \t\t\t\t\t\t\timport\tjavax.ws.rs.core.Application;\n\n@ApplicationPath(\"/geolocation\") \t\t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationApplication\textends Application\t{\n\npublic\tGeoLocationApplication()\t{} \t\t\t\t\t\t\t\t\t}\n\nThere\tare\ttwo\tthings\tto\tnote\tin\tthis\tclass;\tone\tis\tthe\tApplication\tclass\tand the\tother\tis\tthe\t@ApplicationPath\tannotation-both\tof\twhich\twe've\talready talked\tabout.\n\n6.\t Now\tlet's\tmove\ton\tto\tthe\tresource\tclass,\twhich\tis\tresponsible\tfor\texposing the\tAPIs.\tIf\tyou\tare\tfamiliar\twith\tSpring\tMVC,\tyou\tcan\tcompare\tResource",
      "content_length": 1784,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 66,
      "content": "classes\tto\tControllers.\tThey\tare\tresponsible\tfor\tdefining\tthe\tAPI\tfor\tany specific\tresource.\tThe\tannotations\tare\tslightly\tdifferent\tfrom\tthat\tof\tSpring MVC.\tLet's\tcreate\ta\tnew\tresource\tclass\tcalled com.packt.microservices.geolocation.GeoLocationResource.java that\texposes\ta\tsimple\tGET\tAPI:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList;\t \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\tjavax.ws.rs.GET;\t \t\t\t\t\t\t\t\timport\tjavax.ws.rs.Path;\t \t\t\t\t\t\t\t\timport\tjavax.ws.rs.Produces;\n\n@Path(\"\")\t \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationResource\t{\n\n@GET\t \t\t\t\t\t\t\t\t\t@Produces(\"applicationjson\")\t \t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{\t \t\t\t\t\t\t\t\t\t\t\treturn\tnew\tArrayList<>();\t \t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}\n\nAll\tthe\tthree\tannotations,\t@GET,\t@Path,\tand\t@Produces,\tare\tpretty\tself explanatory.\n\nBefore\twe\tstart\twriting\tthe\tAPIs\tand\tthe\tservice\tclass,\tlet's\ttest\tthe\tapplication from\tthe\tcommand\tline\tto\tmake\tsure\tit\tworks\tas\texpected.\tWith\tthe\tcurrent implementation,\tany\tGET\trequest\tsent\tto\tthe\t/geolocation\tURL\tshould\treturn\tan empty\tJSON\tarray.\n\nSo\tfar,\twe\thave\tcreated\tthe\tRESTful\tAPIs\tusing\tJAX-RS.\tIt's\tjust\tanother\tJAX- RS\tproject:\n\n1.\t In\torder\tto\tmake\tit\ta\tmicroservice\tusing\tWildfly\tSwarm,\tall\tyou\thave\tto\tdo is\tadd\tthe\twildfly-swarm-plugin\tto\tthe\tMaven\tpom.xml\tfile.\tThis\tplugin will\tbe\ttied\tto\tthe\tpackage\tphase\tof\tthe\tbuild\tso\tthat\twhenever\tthe\tpackage goal\tis\ttriggered,\tthe\tplugin\twill\tcreate\tan\tuber\tJAR\twith\tall\trequired dependencies.\tAn\tuber\tJAR\tis\tjust\ta\tfat\tJAR\tthat\thas\tall\tdependencies bundled\tinside\titself.\tIt\talso\tdeploys\tour\tapplication\tin\tan\tin-memory",
      "content_length": 1571,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 67,
      "content": "Undertow\tserver.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tplugins\tsection\tof\tthe pom.xml\tfile:\n\n<plugin> \t\t\t\t\t\t\t\t\t\t<groupId>org.wildfly.swarm</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>wildfly-swarm-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t<version>1.0.0.Final</version> \t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<id>package</id> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>package</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t</plugin>\n\n2.\t Now\texecute\tthe\tmvn\tclean\tpackage\tcommand\tfrom\tthe\tproject's\troot directory,\tand\twait\tfor\tthe\tMaven\tbuild\tto\tbe\tsuccessful.\tIf\tyou\tlook\tat\tthe logs,\tyou\tcan\tsee\tthat\twildfly-swarm-plugin\twill\tcreate\tthe\tuber\tJAR, which\thas\tall\tits\tdependencies.\tYou\tshould\tsee\tsomething\tlike\tthis\tin\tyour console\tlogs:\n\n3.\t After\tthe\tbuild\tis\tsuccessful,\tyou\twill\tfind\ttwo\tartifacts\tin\tthe\ttarget directory\tof\tyour\tproject.\tThe\tgeolocation-wildfly-0.0.1-SNAPSHOT.war file\tis\tthe\tfinal\tWAR\tcreated\tby\tthe\tmaven-war-plugin.\tThe\tgeolocation- wildfly-0.0.1-SNAPSHOT-swarm.jar\tfile\tis\tthe\tuber\tJAR\tcreated\tby\tthe wildfly-swarm-plugin.\tExecute\tthe\tfollowing\tcommand\tin\tthe\tsame terminal\tto\tstart\tyour\tmicroservice:\n\njava\t-jar\ttarget/geolocation-wildfly-0.0.1-SNAPSHOT- swarm.jar\n\n4.\t After\texecuting\tthis\tcommand,\tyou\twill\tsee\tthat\tUndertow\thas\tstarted\ton port\tnumber\t8080,\texposing\tthe\tgeolocation\tresource\twe\tcreated.\tYou\twill see\tsomething\tlike\tthis:",
      "content_length": 1403,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 68,
      "content": "5.\t Execute\tthe\tfollowing\tcURL\tcommand\tin\ta\tseparate\tterminal\twindow\tto make\tsure\tour\tAPI\tis\texposed.\tThe\tresponse\tof\tthe\tcommand\tshould\tbe\t[], indicating\tthere\tare\tno\tgeolocations:\n\ncurl\thttp://localhost:8080/geolocation\n\n6.\t Now\tlet's\tbuild\tthe\tservice\tclass\tand\tfinish\tthe\tAPIs\tthat\twe\tstarted.\tFor simplicity\tpurposes,\twe\tare\tgoing\tto\tstore\tthe\tgeolocations\tin\ta\tcollection\tin the\tservice\tclass\titself.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\twriting repository\tclasses\tor\tDAOs\tthat\ttalk\tto\tthe\tdatabase\tthat\tholds\tyour geolocations.\tGet\tthe com.packt.microservices.geolocation.GeoLocationService.java interface\tfrom\tthe\tprevious\trecipe.\tWe'll\tuse\tthe\tsame\tinterface\there.\n\n7.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java that\textends\tthe\tGeoLocationService\tinterface:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.ArrayList; \t\t\t\t\t\t\t\timport\tjava.util.Collections; \t\t\t\t\t\t\t\timport\tjava.util.List;\n\npublic\tclass\tGeoLocationServiceImpl\timplements \t\t\t\t\t\t\t\tGeoLocationService\t{\n\nprivate\tstatic\tList<GeoLocation>\tgeolocations\t=\tnew \t\t\t\t\t\t\t\t\t\t\tArrayList<> \t\t\t\t\t\t\t\t\t\t();\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{",
      "content_length": 1201,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 69,
      "content": "public\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation); \t\t\t\t\t\t\t\t\t\t\t\treturn\tgeolocation; \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\n8.\t Now\tthat\tour\tservice\tclasses\tare\timplemented,\tlet's\tfinish\tbuilding\tthe\tAPIs. We\talready\thave\ta\tvery\tbasic\tstubbed-out\tGET\tAPI.\tLet's\tjust\tintroduce\tthe service\tclass\tto\tthe\tresource\tclass\tand\tcall\tthe\tfindAll\tmethod.\tSimilarly, let's\tuse\tthe\tservice's\tcreate\tmethod\tfor\tPOST\tAPI\tcalls.\tAdd\tthe\tfollowing snippet\tto\tGeoLocationResource.java: private\tGeoLocationService\tservice\t=\tnew \t\t\t\t\t\t\tGeoLocationServiceImpl();\n\n@GET \t\t\t\t\t\t\t@Produces(\"application/json\") \t\t\t\t\t\t\tpublic\tList<GeoLocation>\tfindAll()\t{ \t\t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t\t}\n\n@POST \t\t\t\t\t\t\t@Produces(\"application/json\") \t\t\t\t\t\t\t@Consumes(\"application/json\") \t\t\t\t\t\t\tpublic\tGeoLocation\tcreate(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\t\treturn\tservice.create(geolocation); \t\t\t\t\t\t\t}\n\n9.\t We\tare\tnow\tready\tto\ttest\tour\tapplication.\tGo\tahead\tand\tbuild\tyour application.\tAfter\tthe\tbuild\tis\tsuccessful,\trun\tyour\tmicroservice:\tlet's\ttry\tto create\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem using\tthe\tGET\tmethod.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour terminal\tone\tby\tone:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n10.\t This\tshould\tgive\tyou\tsomething\tlike\tthe\tfollowing\toutput\t(pretty-printed\tfor readability):",
      "content_length": 1654,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 70,
      "content": "{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n11.\t This\tcommand\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975\t \t\t\t\t\t\t\t\t}\n\n12.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation\n\n13.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t}, \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t]\n\nWhatever\twe\thave\tseen\tso\tfar\twill\tgive\tyou\ta\thead\tstart\tin\tbuilding microservices\twith\tWildFly\tSwarm.\tOf\tcourse,\tthere\tare\ttons\tof\tfeatures\tthat",
      "content_length": 1436,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 71,
      "content": "microservices\twith\tWildFly\tSwarm.\tOf\tcourse,\tthere\tare\ttons\tof\tfeatures\tthat WildFly\tSwarm\toffers.\tFeel\tfree\tto\ttry\tthem\tout\tbased\ton\tyour\tapplication needs.\tI\tstrongly\trecommend\tgoing\tthrough\tthe\tWildFly\tSwarm\tdocumentation for\tany\tadvanced\tusages.\tIf\tyou\talready\tknow\tthat\tyou\tare\tgoing\tto\tbe\tusing WildFly\tSwarm\tfor\tyour\tmicroservices,\tyou\tcan\tskip\tthe\trest\tof\tthe\trecipes\tin this\tchapter\tand\tjump\tto\tnext\tchapter.\tThe\tfinal\ttwo\trecipes\tin\tthis\tchapter\twill show\tyou\thow\tto\tcreate\tmicroservices\tusing\tDropwizard\tand\thow\tto\tcreate RESTful\tAPIs\twith\tSparkJava.",
      "content_length": 561,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 72,
      "content": "Writing\tmicroservices\twith Dropwizard\n\nDropwizard\tis\ta\tcollection\tof\tlibraries\tthat\thelp\tyou\tbuild\tpowerful\tapplications quickly\tand\teasily.\tThe\tlibraries\tvary\tfrom\tJackson,\tJersey,\tJetty,\tand\tso\ton.\tYou can\ttake\ta\tlook\tat\tthe\tfull\tlist\tof\tlibraries\ton\ttheir\twebsite.\tThis\tecosystem\tof libraries\tthat\thelp\tyou\tbuild\tpowerful\tapplications\tcould\tbe\tutilized\tto\tcreate microservices\tas\twell.\tAs\twe\tsaw\tearlier,\tit\tutilizes\tJetty\tto\texpose\tits\tservices. In\tthis\trecipe,\twe\twill\tcreate\tthe\tsame\tGeoLocation\tAPI\tusing\tDropwizard\tand Jersey.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe Dropwizard\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there\tto help\tyou\tget\tstarted\twith\tDropwizard.\tWhen\tyou\tare\tbuilding\tyour\tproduction- level\tapplication,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly\tSwarm, Dropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.",
      "content_length": 894,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 73,
      "content": "Getting\tready\n\nSimilar\tto\thow\twe\tcreated\tother\tMaven\tprojects,\tcreate\ta\tMaven\tJAR\tmodule with\tthe\tgroupId\t\tcom.packt.microservices\tand\tname/artifactId\t geolocation-dropwizard.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline. After\tthe\tproject\tis\tcreated,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion other\tthan\t1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven recipe\tto\tchange\tthe\tJava\tversion\tto\t1.8.\tPerform\ta\tMaven\tupdate\tfor\tthe\tchange to\ttake\teffect.",
      "content_length": 483,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 74,
      "content": "How\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\tyou\twill\tneed\tis\tthe\tdropwizard-core\tMaven\tdependency. Add\tthe\tfollowing\tsnippet\tto\tyour\tproject's\tpom.xml\tfile:\n\n<dependencies> \t\t\t\t<dependency> \t\t\t\t\t\t<groupId>io.dropwizard</groupId> \t\t\t\t\t\t<artifactId>dropwizard-core</artifactId> \t\t\t\t\t\t<version>0.9.3</version> \t\t\t\t</dependency> \t\t</dependencies>\n\nGuess\twhat?\tThis\tis\tthe\tonly\tdependency\tyou\twill\tneed\tto\tspin\tup\ta\tsimple Jersey-based\tDropwizard\tmicroservice.\n\nBefore\twe\tstart\tconfiguring\tDropwizard,\twe\thave\tto\tcreate\tthe\tdomain\tobject, service\tclass,\tand\tresource\tclass.\tFollow\tthe\tsteps\tfrom\tthe\tprevious\trecipe\tto create\tthe\tfollowing\tfour\tfiles:\n\ncom.packt.microservices.geolocation.GeoLocation.java\n\ncom.packt.microservices.geolocation.GeoLocationService.java\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java\n\ncom.packt.microservices.geolocation.\tGeoLocationResource.java\n\nLet's\tsee\twhat\teach\tof\tthese\tclasses\tdoes.\tThe\tGeoLocation.java\tclass\tis\tour domain\tobject\tthat\tholds\tthe\tgeolocation\tinformation.\tThe GeoLocationService.java\tclass\tdefines\tour\tinterface,\twhich\tis\tthen implemented\tby\tthe\tGeoLocationServiceImpl.java\tclass.\tIf\tyou\ttake\ta\tlook\tat the\tGeoLocationServiceImpl.java\tclass,\twe\tare\tusing\ta\tsimple\tcollection\tto store\tthe\tGeoLocation\tdomain\tobjects.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe persisting\tthese\tobjects\tin\ta\tdatabase.\tBut\tto\tkeep\tit\tsimple,\twe\twill\tnot\tgo\tthat far.\n\nTo\tbe\tconsistent\twith\tthe\tprevious\trecipe,\tlet's\tchange\tthe\tpath\tof GeoLocationResource\tto\t/geolocation.\tTo\tdo\tso,\treplace\t@Path(\"/\")\twith @Path(\"/geolocation\")\ton\tline\tnumber\t11\tof\tthe\tGeoLocationResource.java class.\n\nWe\thave\tnow\tcreated\tthe\tservice\tclasses,\tdomain\tobject,\tand\tresource\tclass.",
      "content_length": 1696,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 75,
      "content": "Let's\tconfigure\tDropwizard.\n\nIn\torder\tto\tmake\tyour\tproject\ta\tmicroservice,\tyou\thave\tto\tdo\ttwo\tthings:\n\n1.\t Create\ta\tDropwizard\tconfiguration\tclass.\tThis\tis\tused\tto\tstore\tany\tmeta- information\tor\tresource\tinformation\tthat\tyour\tapplication\twill\tneed\tduring runtime,\tsuch\tas\tDB\tconnection,\tJetty\tserver,\tlogging,\tand\tmetrics configurations.\tThese\tconfigurations\tare\tideally\tstored\tin\ta\tYAML\tfile, which\twill\tthen\tbe\tmapped\tto\tyour\tConfiguration\tclass\tusing\tJackson.\tIn this\tapplication,\twe\tare\tnot\tgoing\tto\tuse\tthe\tYAML\tconfiguration\tas\tit\tis out\tof\tscope\tfor\tthis\tbook.\n\nNote\n\nIf\tyou\twould\tlike\tto\tknow\tmore\tabout\tconfiguring\tDropwizard,\trefer\tto their\tGetting\tStarted\tdocumentation\tpage\tat http://www.dropwizard.io/0.7.1/docs/getting-started.html\t.\n\n2.\t Let's\tcreate\tan\tempty\tConfiguration\tclass\tcalled GeoLocationConfiguration.java:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tio.dropwizard.Configuration;\n\npublic\tclass\tGeoLocationConfiguration\textends Configuration\t{\n\n}\n\n3.\t The\tYAML\tconfiguration\tfile\thas\ta\tlot\tto\toffer.\tTake\ta\tlook\tat\ta\tsample YAML\tfile\tfrom\tDropwizard's\tGetting\tStarted\tdocumentation\tpage\tto\tlearn more.\tThe\tname\tof\tthe\tYAML\tfile\tis\tusually\tderived\tfrom\tthe\tname\tof\tyour microservice.\tThe\tmicroservice\tname\tis\tusually\tidentified\tby\tthe\treturn value\tof\tthe\toverridden\tmethod\tpublic\tString\tgetName()\tin\tyour Application\tclass.\tNow\tlet's\tcreate\tthe\tGeoLocationApplication.java application\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tio.dropwizard.Application; \t\t\t\t\t\t\t\timport\tio.dropwizard.setup.Environment;\n\npublic\tclass\tGeoLocationApplication\textends",
      "content_length": 1599,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 76,
      "content": "public\tclass\tGeoLocationApplication\textends \t\t\t\t\t\t\t\tApplication<GeoLocationConfiguration>\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows Exception\t{ \t\t\t\t\t\t\t\t\t\t\t\tnew\tGeoLocationApplication().run(args); \t\t\t\t\t\t\t\t\t\t}\n\n@Override \t\t\t\t\t\t\t\t\t\tpublic\tvoid\trun(GeoLocationConfiguration\tconfig, Environment \t\t\t\t\t\t\t\t\t\t\t\t\tenv)\tthrows\tException\t{ \t\t\t\t\t\t\t\t\t\t\t\t\tenv.jersey().register(new\tGeoLocationResource()); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nThere\tare\ta\tlot\tof\tthings\tgoing\ton\there.\tLet's\tlook\tat\tthem\tone\tby\tone. Firstly,\tthis\tclass\textends\tApplication\twith\tthe GeoLocationConfiguration\tgeneric.\tThis\tclearly\tmakes\tan\tinstance\tof your\tGeoLocationConfiguraiton.java\tclass\tavailable\tso\tthat\tyou\thave access\tto\tall\tthe\tproperties\tyou\thave\tdefined\tin\tyour\tYAML\tfile\tat\tthe\tsame time\tmapped\tin\tthe\tConfiguration\tclass.\tThe\tnext\tone\tis\tthe\trun\tmethod. The\trun\tmethod\ttakes\ttwo\targuments:\tyour\tconfiguration\tand environment.\tThe\tEnvironment\tinstance\tis\ta\twrapper\tto\tother\tlibrary- specific\tobjects\tsuch\tas\tMetricsRegistry,\tHealthCheckRegistry,\tand JerseyEnvironment.\tFor\texample,\twe\tcould\tregister\tour\tJersey\tresources using\tthe\tJerseyEnvironment\tinstance.\tThe\tenv.jersey().register(new GeoLocationResource())\tline\tdoes\texactly\tthat.\tThe\tmain\tmethod\tis\tpretty straight-forward.\tAll\tit\tdoes\tis\tcall\tthe\trun\tmethod.\n\n4.\t Before\twe\tcan\tstart\tthe\tmicroservice,\twe\thave\tto\tconfigure\tthis\tproject\tto create\ta\trunnable\tuber\tJAR.\tUber\tJARs\tare\tjust\tfat\tJARs\tthat\tbundle\ttheir dependencies\tin\tthemselves.\tFor\tthis\tpurpose,\twe\twill\tbe\tusing\tthe\tmaven- shade-plugin.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tbuild\tsection\tof\tthe pom.xml\tfile.\tIf\tthis\tis\tyour\tfirst\tplugin,\tyou\tmight\twant\tto\twrap\tit\tin\ta <plugins>\telement\tunder\t<build>: <plugin> \t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t<artifactId>maven-shade-plugin</artifactId> \t\t\t\t\t\t<version>2.3</version> \t\t\t\t\t\t<configuration>\n\n<createDependencyReducedPom>true</createDependencyReducedPom>",
      "content_length": 1912,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 77,
      "content": "<filters> \t\t\t\t\t\t\t\t\t\t<filter> \t\t\t\t\t\t\t\t\t\t\t\t<artifact>*:*</artifact> \t\t\t\t\t\t\t\t\t\t\t\t<excludes> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.SF</exclude> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.DSA</exclude> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<exclude>META-INF/*.RSA</exclude> \t\t\t\t\t\t\t\t\t\t\t\t</excludes> \t\t\t\t\t\t\t\t\t\t</filter> \t\t\t\t\t\t\t\t</filters> \t\t\t\t\t\t</configuration> \t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t<phase>package</phase> \t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t<goal>shade</goal> \t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t<transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\t implementation=\"org.apache.maven.plugins.shade.resource.Service sResourceTransformer\"\t> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\t implementation=\"org.apache.maven.plugins.shade.resource.Manifes tResourceTransformer\">\n\n<mainClass>com.packt.microservices.geolocation.GeoLocationAppli cation<mainClass> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformer> \t\t\t\t\t\t\t\t\t\t\t\t</transformers> \t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t</executions> \t\t\t\t</plugin>\n\n5.\t The\tprevious\tsnippet\tdoes\tthe\tfollowing:\n\nIt\tcreates\ta\trunnable\tuber\tJAR\tthat\thas\ta\treduced\tpom.xml\tfile\tthat\tdoes\tnot include\tthe\tdependencies\tthat\tare\tadded\tto\tthe\tuber\tJAR.\tTo\tlearn\tmore about\tthis\tproperty,\ttake\ta\tlook\tat\tthe\tdocumentation\tof\tmaven-shade- plugin.\n\nIt\tutilizes com.packt.microservices.geolocation.GeoLocationApplication\tas\tthe",
      "content_length": 1315,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 78,
      "content": "class\twhose\tmain\tmethod\twill\tbe\tinvoked\twhen\tthis\tJAR\tis\texecuted.\tThis is\tdone\tby\tupdating\tthe\tMANIFEST\tfile.\n\nIt\texcludes\tall\tsignatures\tfrom\tsigned\tJARs.\tThis\tis\trequired\tto\tavoid security\terrors.\n\n6.\t Now\tthat\tour\tproject\tis\tproperly\tconfigured,\tlet's\ttry\tto\tbuild\tand\trun\tit\tfrom the\tcommand\tline.\tTo\tbuild\tthe\tproject,\texecute\tmvn\tclean\tpackage\tfrom the\tproject's\troot\tdirectory\tin\tyour\tterminal.\tThis\twill\tcreate\tyour\tfinal\tJAR in\tthe\ttarget\tdirectory.\tExecute\tthe\tfollowing\tcommand\tto\tstart\tyour microservice: java\t-jar\ttarget/geolocation-dropwizard-0.0.1- SNAPSHOT.jar\tserver\n\n7.\t The\tserver\targument\tinstructs\tDropwizard\tto\tstart\tthe\tJetty\tserver.\tAfter you\tissue\tthe\tcommand,\tyou\tshould\tbe\table\tto\tsee\tthat\tDropwizard\thas started\tthe\tin-memory\tJetty\tserver\ton\tport\t8080.\tIf\tyou\tsee\tany\twarnings about\thealth\tchecks,\tignore\tthem.\tYour\tconsole\tlogs\tshould\tlook\tsomething like\tthis:",
      "content_length": 890,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 79,
      "content": "8.\t We\tare\tnow\tready\tto\ttest\tour\tapplication.\tLet's\ttry\tto\tcreate\ttwo geolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem\tusing\tthe\tGET method.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal\tone\tby one:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\n9.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:8080/geolocation\n\n10.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{\t\t \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n11.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:8080/geolocation\n\n12.\t It\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",",
      "content_length": 1553,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 80,
      "content": "\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t}, \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t]\n\nExcellent!\tYou\thave\tcreated\tyour\tfirst\tmicroservice\twith\tDropwizard. Dropwizard\toffers\tmore\tthan\twhat\twe\thave\tseen\tso\tfar.\tSome\tof\tit\tis\tout\tof scope\tfor\tthis\tbook.\tI\tbelieve\tthe\tmetrics\tAPI\tthat\tDropwizard\tuses\tcould\tbe used\tin\tany\ttype\tof\tapplication.\tTherefore,\twe\twill\tlook\tat\thow\tto\tuse\tit\tin\tlater chapters.",
      "content_length": 551,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 81,
      "content": "Writing\tREST\tAPIs\twith\tSparkJava\n\nIn\tthe\tprevious\trecipes,\twe\tsaw\thow\tto\tcreate\ta\tmicroservice\tusing\tvarious frameworks\tsuch\tas\tSpring\tBoot,\tWildFly\tSwarm,\tand\tDropwizard.\tThis\trecipe is\tgoing\tto\tbe\ta\tlittle\tdifferent\tfor\tthe\tfact\tthat\twe\tare\tgoing\tto\tsee\thow\tto\tcreate a\tself-managed\tRESTful\tAPI\tusing\ta\tframework\tcalled\tSparkJava.\tNot\tto\tbe confused\twith\tApache\tSpark,\tthe\tSparkJava\tframework\tclaims\tto\tbe\ta\tmicro- framework\tfor\tbuilding\tweb\tapplications.\tTheir\tHTTP\tAPI\twas\tinspired\tby Ruby's\tSinatra\tframework.\tIt\tis\tso\tsimple\tthat\tbringing\tup\tan\tHTTP\tGET\tAPI requires\tfewer\tthan\tten\tlines\tof\tcode.\tOwing\tto\tthis,\tSparkJava\tis\tsomething\tthat could\tbe\tconsidered\twhen\tyou\twould\tlike\tto\tquickly\tbuild\tHTTP-based microservices.\n\nTo\tavoid\tconfusion\tand\tdependency\tconflicts\tin\tour\tproject,\twe\twill\tcreate\tthe SparkJava\tmicroservice\tas\tits\town\tMaven\tproject.\tThis\trecipe\tis\tjust\there\tto\thelp you\tget\tstarted\twith\tSparkJava.\tWhen\tyou\tare\tbuilding\tyour\tproduction-level application,\tit\tis\tyour\tchoice\tto\teither\tuse\tSpring\tBoot,\tWildFly\tSwarm, Dropwizard,\tor\tSparkJava\tbased\ton\tyour\tneeds.",
      "content_length": 1085,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 82,
      "content": "Getting\tready\n\nSimilar\tto\thow\twe\tcreated\tother\tMaven\tprojects,\tcreate\ta\tMaven\tJAR\tmodule with\tthe\tgroupId\tcom.packt.microservices\tand\tname/artifactId geolocation-sparkjava.\tFeel\tfree\tto\tuse\teither\tyour\tIDE\tor\tthe\tcommand\tline. After\tthe\tproject\tis\tcreated,\tif\tyou\tsee\tthat\tyour\tproject\tis\tusing\ta\tJava\tversion other\tthan\t1.8,\tfollow\tthe\tCreating\ta\tproject\ttemplate\tusing\tSTS\tand\tMaven recipe\tto\tchange\tthe\tJava\tversion\tto\t1.8.\tPerform\ta\tMaven\tupdate\tfor\tthe\tchange to\ttake\teffect.",
      "content_length": 480,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 83,
      "content": "How\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\tyou\twill\tneed\tis\tthe\tSparkJava\tdependency.\tAdd\tthe following\tsnippet\tto\tyour\tproject's\tpom.xml\tfile:\n\n<dependencies> \t\t\t\t<dependency> \t\t\t\t\t\t<groupId>com.sparkjava</groupId> \t\t\t\t\t\t<artifactId>spark-core</artifactId> \t\t\t\t\t\t<version>2.5</version> \t\t\t\t</dependency> \t\t</dependencies>\n\nWe\tnow\thave\tto\tcreate\tthe\tdomain\tobject\tand\tservice\tclass.\tFollow\tthe\tWriting microservices\twith\tWildFly\tSwarm\trecipe\tto\tcreate\tthe\tfollowing\tthree\tfiles:\n\ncom.packt.microservices.geolocation.GeoLocation.java\n\ncom.packt.microservices.geolocation.GeoLocationService.java\n\ncom.packt.microservices.geolocation.GeoLocationServiceImpl.java\n\nLet's\tsee\twhat\teach\tof\tthese\tclasses\tdoes.\tThe\tGeoLocation.java\tclass\tis\tour domain\tobject\tthat\tholds\tthe\tgeolocation\tinformation.\tThe GeoLocationService.java\tinterface\tdefines\tour\tinterface,\twhich\tis\tthen implemented\tby\tthe\tGeoLocationServiceImpl.java\tclass.\tIf\tyou\ttake\ta\tlook\tat the\tGeoLocationServiceImpl.java\tclass,\twe\tare\tusing\ta\tsimple\tcollection\tto store\tthe\tGeoLocation\tdomain\tobjects.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe persisting\tthese\tobjects\tin\ta\tdatabase.\tBut\tto\tkeep\tit\tsimple,\twe\twill\tnot\tgo\tthat far.\n\nThe\tnext\tthing\tthat\tSparkJava\tneeds\tis\ta\tcontroller.\tIf\tyou\tare\tfamiliar\twith Spring\tMVC,\tyou\tcan\trelate\tthis\tcontroller\tto\tthat\tof\tSpring\tMVC's.\tThe controller\thas\ta\tcollection\tof\troutes\tdefined\tfor\teach\tURL\tpattern\tin\tyour\tAPI. Follow\tthese\tsteps:\n\n1.\t Let's\tcreate\tour\tcontroller\n\ncom.packt.microservices.geolocation.GeoLocationController.java with\ta\tstubbed-out\tGET\tAPI:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tstatic\tspark.Spark.*;",
      "content_length": 1626,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 84,
      "content": "public\tclass\tGeoLocationController\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\t\t\tget(\"/geolocation\",\t(req,\tresp)\t->\t\"[]\"); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t}\n\n2.\t The\tquickest\tway\tto\ttest\tthis\tis\tby\trunning\tthis\tclass\tas\ta\tJava\tapplication.\tIf you\tget\tSLF4J\terrors\tin\tyour\tconsole\tafter\tyou\tstart\tthe\tapplication,\tadd\tthe following\tMaven\tdependency\tto\tyour\tpom.xml\tfile\tand\trestart\tyour application: <dependency> \t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t<artifactId>slf4j-simple</artifactId> \t\t\t\t\t\t\t\t<version>1.7.21</version> \t\t\t\t\t\t</dependency>\n\nThe\tslf4j-simple\tdependency\troutes\tall\tthe\tSLF4Jlog\tmessages\tto\tthe System.err\tstream.\n\n3.\t Your\tconsole\tlogs\tshould\tlook\tsomething\tlike\tthis\tafter\tthe\trestart:\n\nFrom\tthe\tlogs,\twe\tcan\tclearly\tsee\tthat\tthe\tservice\tis\trunning\ton\tport\t4567. 4.\t Execute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal\twindow\tto\tmake\tsure\n\nour\tAPI\tis\texposed.\tThe\tresponse\tof\tthe\tfollowing\tcommand\tshould\tbe\t[], indicating\tthere\tare\tno\tgeolocations:\n\ncurl\thttp://localhost:4567/geolocation\n\n5.\t Now\tlet's\tfinish\tbuilding\tthe\tAPIs.\tWe\talready\thave\ta\tvery\tbasic\tstubbed- out\tGET\tAPI.\tLet's\tjust\tintroduce\tthe\tservice\tclass\tto\tthe\tcontroller\tand\tcall the\tfindAll\tmethod.\tSimilarly,\tlet's\tuse\tthe\tservice's\tcreate\tmethod\tfor POST\tAPI\tcalls.\tBefore\twe\tdo\tthat,\twe\tneed\tto\tdo\tone\tmore\tthing.\tBy default,\tSparkJava\tdoes\tnot\tperform\tJSON\tserialization\tand\tdeserialization.",
      "content_length": 1378,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 85,
      "content": "We\twill\tbe\tusing\ta\tlibrary\tcalled\tgson\tto\tdo\tthat.\tSo\tadd\tthe\tfollowing dependency\tto\tyour\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t\t\t\t\t<groupId>com.google.code.gson</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>gson</artifactId> \t\t\t\t\t\t\t\t\t\t<version>2.7</version> \t\t\t\t\t\t\t\t</dependency>\n\n6.\t Now\tlet's\treplace\tthe\tmain\tmethod\tof\tGeoLocationController.java\twith this:\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\tGeoLocationService\tservice\t=\tnew\t GeoLocationServiceImpl(); \t\t\t\t\t\tGson\tgson\t=\tnew\tGson();\n\nget(\"geolocation\",\t(req,\tresp)\t->\t{ \t\t\t\t\t\t\t\treturn\tservice.findAll(); \t\t\t\t\t\t},\tgson::toJson);\n\npost(\"geolocation\",\t(req,\tresp)\t->\t{ \t\t\t\t\t\t\t\treturn\tservice.create(gson.fromJson(req.body(),\t GeoLocation.class)); \t\t\t\t\t\t},\tgson::toJson); \t\t\t\t}\n\nYes,\tthere\tare\ttoo\tmany\tthings\thappening\there.\tLet's\ttry\tto\tunderstand\tthem\tone by\tone:\n\nThe\tget\tmethod\tnow\tuses\tthe\tservice's\tfindAll\tmethod The\tthird\targument\tto\tthe\tget\tmethod\tis\tthe\tResponseTransformer,\twhich says\thow\tyour\tresponse\tshould\tbe\ttransformed\tbefore\tbeing\tsent\tto\tthe client Since\tthe\tResponseTransformer\tis\ta\tFunctionalInterface\twith\tjust\tone method\trender\tthat\ttakes\tin\tthe\trendering\tlogic\tas\tan\tobject,\twe\tare\tpassing the\tmethod\treference\tto\tGson's\ttoJson\tmethod\tas\tthe\trendering\tlogic\there. The\tpost\tmethod,\twhich\tuses\tthe\tservice's\tcreate\tmethod,\tuses\tGson\tto transform\tthe\trequest\tbody\tto\ta\tGeoLocation\tvalue.\n\nWe\tare\tnow\tready\tto\ttest\tour\tapplication.\tRestart\tthe\tapplication.\tLet's\ttry\tto create\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI\tand\tlater\ttry\tto\tretrieve\tthem\tusing",
      "content_length": 1515,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 86,
      "content": "the\tGET\tmethod:\n\n1.\t Execute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal\tone\tby\tone:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:4567/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://localhost:4567/geolocation\n\n3.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n4.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing cURL\tcommand:\n\ncurl\thttp://localhost:4567/geolocation\n\n5.\t It\tshould\tgive\tyou\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t},",
      "content_length": 1460,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 87,
      "content": "{ \t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t]\n\nThere\tare\tseveral\tother\tconfigurations\tthat\tyou\tcan\tmake\tto\tSparkJava,\tsuch\tas changing\tthe\tdefault\tport,\tusing\tquery\tparameters,\tand\tusing\tpath\tparameters.\tI'll leave\tthat\tto\tyou\tto\texperiment.",
      "content_length": 386,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 88,
      "content": "Conclusion\n\nAt\tthe\tbeginning\tof\tthis\tchapter,\twe\tquickly\tsaw\tan\toverview\tof\twhat microservices\tare\tand\thow\tthey\tbenefit\torganizations\tby\tmaking\tit\teasier\tto manage\tand\tdeploy\tindependent\tservices.\tWe\tlooked\tat\tan\texample\tof\ta geolocation\ttracker\tapplication\tto\tsee\thow\tit\tcan\tbe\tbroken\tdown\tinto\tsmaller and\tmanageable\tservices.\tNext,\twe\tsaw\thow\tto\tcreate\tthe\tGeoLocationTracker service\tusing\tthe\tSpring\tBoot\tframework.\tWe\talso\tlearned\thow\tto\texpose\tour APIs\tthat\tconsume\tand\tread\tgeolocations\tusing\tSpring\tMVC.\tNext,\twe\tsaw\thow to\tbuild\tthe\tsame\tapplication\tusing\tWildFly\tSwarm,\tand\tJAX-RS.\tLater,\twe built\tthe\tsame\tapplication\tusing\tDropwizard.\tFinally,\twe\tsaw\thow\tto\timplement the\tsame\tservice\tusing\tthe\tSparkJava\tframework.\n\nI\thope\tyou\tnow\thave\ta\tgood\tunderstanding\tof\twhat\tmicroservices\tare\tand\thow\tto create\tthem\tusing\tyour\tfavorite\tframework.\tThe\tchoice\tof\tframework\tcompletely depends\ton\tyour\tneeds\tand\tyour\tcurrent\tecosystem.\tWe\tstrongly\trecommend you\tevaluate\tthem\tbefore\tpicking\tone.\tIn\tthe\tnext\tchapter,\twe\twill\tlearn\thow\tto package\tthis\tmicroservice\tand\tlater\tcontainerize\tit\tusing\tDocker.",
      "content_length": 1102,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 89,
      "content": "Chapter\t2.\tContainerizing Microservices\twith\tDocker\n\nIn\tthis\tchapter,\twe\twill\tfocus\tmore\ton\thow\tto\tpackage\tand\tship\tour microservice.\tWe\twill\tlearn\tthe\tfollowing\trecipes:\n\nBuilding\tan\texecutable\tJAR\tusing\tthe\tMaven\tShade\tplugin Building\tan\texecutable\tJAR\tusing\tthe\tSpring\tBoot\tMaven\tplugin Installing\tand\tsetting\tup\tDocker Writing\tyour\tDockerfile Building\tyour\tDocker\timage Running\tyour\tmicroservice\tinside\ta\tDocker\tcontainer Pushing\tyour\timage\tto\tDocker\tHub",
      "content_length": 458,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 90,
      "content": "Building\tan\texecutable\tJAR\tusing Maven\tShade\tplugin\n\nBefore\twe\tjump\tinto\tthis\trecipe,\tlet's\ttalk\tabout\twhy\twe\tare\tdoing\tthis.\tOur\tgoal is\tto\tconstruct\ta\tshippable\tartifact\tthat\tcan\tbe\texecuted\tfrom\tany\tplatform\tor machine.\tIn\torder\tto\tdo\tthat,\twe\thave\tto\tmake\tsure\tour\tfinal\tartifact\thas\tall dependencies\tpackaged\tin\tit.\tAll\twe\tare\ttrying\tto\tdo\there\tis\tbuild\ta\tfat\tJAR\twith all\tdependencies,\tcalled\tthe\tuber\tJAR,\twhich\twe\ttalked\tabout\tin\tthe\tprevious chapter.\tAlmost\tall\tframeworks\tthat\thelp\tbuild\tmicroservices,\tsuch\tas\tSpring Boot\tand\tWildFly\tSwarm,\thave\ttheir\town\tMaven\tplugins\tthat\thelp\tyou\tbuild\tan executable\tJAR.\n\nBut\tif\tyou\tuse\tframeworks\tsuch\tas\tSparkJava\tand\tRatPack\tthat\tare\tnot\treally microservice\tframeworks\tbut\thelp\tin\tbuilding\tHTTP\tAPIs,\tyou\twill\thave\tto make\tsure\tyou\tuse\tthe\tright\tMaven\tor\tGradle\tplugin\tto\tcreate\tan\texecutable JAR.\n\nNote\n\nRatpack\tis\ta\tframework\tthat\tlets\tyou\tbuild\thigh-performance\tHTTP\tservices. Internally,\tit\tuses\tNetty\tas\tits\tHTTP\tengine.\tIt\tutilizes\tNetty's\tevent-based\tnon- blocking\tmechanism\tto\texpose\tHTTP\tservices,\tso\tyour\tAPIs\twill\tbe asynchronous.\tAlso,\tthe\tway\tyou\twrite\tAPIs\tin\tRatpack\tis\ta\tlittle\tdifferent\tfrom how\tyou\twrite\tthem\tin\tother\tlibraries.\tFor\tmore\tinformation\tabout\tRatpack,\tlook at\ttheir\tdocumentation\tat\thttps://ratpack.io/manual/current/\t.",
      "content_length": 1303,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 91,
      "content": "Getting\tready\n\nIf\tyou\tare\talready\tusing\tSpring\tBoot\tor\tWildFly\tSwarm,\tyou\tcan\tskip\tthis\trecipe as\tit\talready\ttakes\tcare\tof\tpackaging\tyour\tapplication.\tIn\torder\tto\tenforce\tthe packaging\tof\tyour\texecutable\tJAR,\twe\twill\tbe\tusing\tthe\tmaven-shade-plugin. This\tplugin\tis\tespecially\tbuilt\tfor\tthis\tpurpose.\tLet's\ttake\ta\tlook\tat\thow\tto\tdo\tthis in\tour\tSparkJava\tproject.\tAll\tthis\ttime,\twe\thave\tbeen\trunning\tour\tgeolocation- sparkjava\tproject\tfrom\tthe\tIDE.\tNow\tlet's\tsee\thow\twe\tcan\tcreate\tan\texecutable JAR\tfor\tthis\tproject\tand\trun\tit\tfrom\tthe\tcommand-line.",
      "content_length": 547,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 92,
      "content": "How\tto\tdo\tit... 1.\t Add\tthis\tsnippet\tto\tthe\tBuild\t|\tPlugins\tsection\tof\tyour\tproject's\tpom.xml\n\nfile:\n\n<plugin> \t\t\t\t\t\t\t\t<groupId>org.apache.maven.plugins</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>maven-shade-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t\t<version>2.4.3</version> \t\t\t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<phase>package</phase> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>shade</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<transformer\n\nimplementation=\"org.apache.maven.plugins.shade. \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tresource.ManifestResourceTransformer\"> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<mainClass>com.packt.microservices.\n\ngeolocation.GeoLocationController</mainClass> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformer> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</transformers> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t</plugin>\n\n2.\t Let's\ttry\tto\tunderstand\tthe\tsnippet.\tThe\tplugin\tmakes\tsure\tthat\twhenever\tthe package\tphase\tof\tyour\tMaven\tbuild\tis\ttriggered,\tit\tuses\tthe ManifestResourceTransformer\tto\tadd\tthe\tgiven\tmainClass\tname\tto\tyour META-INF/MANIFEST.MF\tfile's\tMain-Class\tproperty.\tThis\tproperty\tspecifies the\tentry\tpoint\tto\tyour\tJAR\tfile.\tWith\tthat\tsaid,\tlet's\tgo\tahead\tand\trun\tthe Maven\tpackage\tgoal.\tIssue\tthe\tfollowing\tcommand\tfrom\tthe\tproject's\troot directory\tin\tyour\tterminal:\n\nmvn\tclean\tpackage\n\n3.\t The\tprevious\tMaven\tcommand\tpackages\tyour\tproject\tinto\tan\texecutable JAR\tusing\tthe\tmaven-shade-plugin.\tBefore\tit\tpackages,\tit\talso\truns\tother Maven\tgoals,\tincluding\tclean,\tvalidate,\tcompile,\tand\ttest.\tWe\twill\tnot",
      "content_length": 1579,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 93,
      "content": "be\tdiscussing\tthese\tMaven\tgoals\tin\tdepth\tas\tthey\tare\tout\tof\tthe\tscope\tof\tthis book.\tThe\tprevious\tcommand\tshould\tgive\tyou\tsomething\tlike\tthis\ton\tyour console:\n\n4.\t If\tyou\twatch\tclosely,\tyou\tcan\tsee\tthat\ttowards\tthe\tend\tof\tthe\tbuild,\tthe maven-shade-plugin\tis\tcreating\ta\tshaded\tartifact\twith\tdependencies\tsuch as\tsparkjava,\tslf4j,\tjetty,\tand\tgson.\tThese\tJARs\tare\trequired\tduring\tthe run\ttime\tof\tthis\tapplication.\tThe\tfinal\tartifact\twill\tbe\tavailable\tin\tthe target\tdirectory\tof\tthe\tproject.\tThe\tmaven-shade-plugin\twill\treplace\tthe original\tgeolocation-sparkjava-0.0.1-SNAPSHOT.jar\tartifact\twith\tthe shaded\tartifact.\n\n5.\t Now\tlet's\tgo\tahead\tand\trun\tthe\tapplication;\tissue\tthe\tfollowing\tJava command:\n\njava\t-jar\ttarget/geolocation-sparkjava-0.0.1-SNAPSHOT.jar\n\n6.\t With\tthis\tcommand,\tyou\tcan\tsee\tthat\tyour\tapplication\thas\tstarted\tand\tis listening\tfor\tnew\trequests\ton\tport\t4567:",
      "content_length": 872,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 94,
      "content": "7.\t Now\tthat\tour\tservice\tis\tready,\tlet's\tgo\tahead\tand\ttest\tit\tby\tposting\ta geolocation.\tExecute\tthe\tfollowing\tcURL\tcommands\tin\tyour\tterminal:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:4567/geolocation\n\n8.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t}\n\n9.\t The\tprevious\tMaven\tplugin\tcan\tbe\tused\twith\tany\ttype\tof\tproject.\tIf\tyou\tare planning\tto\tuse\tother\tframeworks\tand\twant\tto\tmake\tan\texecutable\tJAR, you\tcan\tuse\tthe\tmaven-shade-plugin\tto\tdo\tso.",
      "content_length": 821,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 95,
      "content": "Building\tan\texecutable\tJAR\tusing\tthe Spring\tBoot\tMaven\tplugin\n\nThis\trecipe\tis\tintended\tfor\tSpring\tBoot\tusers\tonly.\tIf\tyou\tare\tusing\ta\tdifferent framework\tthat\tdoes\tnot\tsupport\tbuilding\texecutable\tJARS,\tplease\trefer\tto previous\trecipe.",
      "content_length": 234,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 96,
      "content": "Getting\tready\n\nThe\tspring-boot-maven-plugin\tis\ta\tMaven\tplugin\tbuilt\tby\tthe\tSpring\tBoot team\tto\tmake\tpackaging\tyour\tSpring\tBoot\tapplications\teasier.\tIt\tnot\tonly\tallows you\tto\tpackage\tyour\tproject,\tbut\talso\thelps\twith\trunning\tand\tdebugging\tyour application.\tIt\tintroduces\ta\tnew\tgoal\tcalled\trepackage,\twhich\tpretty\tmuch repackages\tyour\toriginal\tartifact\t(JAR\tor\tWAR)\twith\tan\texecutable\tuber\tJAR that\thas\tall\tdependencies\tin\tit.\tIf\tyou\tare\tfamiliar\twith\tthe\tmaven-shade-plugin, the\trepackage\tgoal\tin\tSpring\tBoot\tdoes\tshading.",
      "content_length": 521,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 97,
      "content": "How\tto\tdo\tit...\n\nIn\torder\tto\tillustrate\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tgeolocation\tproject\tthat\twe built\tin\tChapter\t1\t,\tBuilding\tMicroservices\twith\tJava\tusing\tSpring\tBoot:\n\n1.\t Open\tthe\tpom.xml\tfile\tof\tthe\tgeolocation\tproject\tand\tlook\tat\tthe\tparent section.\tYou\twill\tsee\tthat\twe\thave\tspecified\tspring-boot-starter-parent\tas the\tparent\tMaven\tmodule.\tThis\tmodule\tdoes\ta\tfew\tthings:\tit\tis\tresponsible for\tdeclaring\tthe\tbasic\tspring-core\tdependency\tin\tthe dependencyManagement\tsection\tof\tits\tpom.xml\tfile.\tIt\talso\tdefines\tthe pluginManagement\tsection\tof\tthe\tpom.xml\tfile\twith\tall\tthe\tMaven\tplugins that\tyou\twill\tneed.\tOne\tof\tthose\tplugins\tis\tspring-boot-maven-plugin.\tIf you\tare\tusing\tSTS\tIDE,\tplease\tgo\tahead\tand\tclick\ton\tits\tparent\tsection\tin the\tpom.xml\tfile\tby\tholding\tthe\tCtrl\tbutton\t(Command\tin\tMac).\n\n2.\t This\twill\ttake\tyou\tto\tthe\tpom.xml\tfile\tof\tthe\tspring-boot-starter-parent project.\tYou\twill\tsee\tsomething\tlike\tthis\tin\tthe\tpluginManagement\tsection:\n\n<plugin> \t\t\t\t\t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>spring-boot-maven-plugin</artifactId> \t\t\t\t\t\t\t\t\t\t<executions> \t\t\t\t\t\t\t\t\t\t\t\t<execution> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goals> \t\t\t\t\t\t\t\t\t\t\t\t\t\t<goal>repackage</goal> \t\t\t\t\t\t\t\t\t\t\t\t\t\t</goals> \t\t\t\t\t\t\t\t\t\t\t\t</execution> \t\t\t\t\t\t\t\t\t\t</executions> \t\t\t\t\t\t\t\t\t\t<configuration> \t\t\t\t\t\t\t\t\t\t\t\t<mainClass>${start-class}</mainClass> \t\t\t\t\t\t\t\t\t\t</configuration> \t\t\t\t\t\t\t\t</plugin>\n\n3.\t Go\tahead\tand\tadd\tthe\tabove\tplugin\tto\tthe\tpom\tfile\tof\tgeolocation\tproject. As\tyou\tcan\tsee,\tthe\tplugin\tuses\tthe\trepackage\tgoal\tto\tcreate\tthe\texecutable JAR\tfile.\tThe\tother\tthing\tthat\tyou\thave\tto\tnotice\tis\tthe\tmainClass configuration.\tIt\tholds\tthe\t${start-class}\tvalue.\tThis\tindicates\tthat\twe have\tto\tdefine\ta\tproperty\tin\tour\tpom.xml\tfile\twith\tthe\tname\tstart-class. 4.\t Let's\tgo\tahead\tand\tdefine\tthe\tstart-class\tproperty\tin\tthe\tpom.xml\tfile\tof our\tgeolocation\tproject.\tUse\tthe\tfollowing\tsnippet\tto\tadd\tthe\tstart-class property\tto\tyour\tPOM\tfile's\tproject\tsection:\n\n<properties> \t\t\t\t\t\t\t\t<start-class>com.packt.microservices.geolocation.",
      "content_length": 2018,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 98,
      "content": "<start-class>com.packt.microservices.geolocation. \t\t\t\t\t\t\t\t\t\tGeoLocationApplication</start-class> \t\t\t\t\t\t\t\t</properties>\n\n5.\t After\tadding\tthe\tproperty,\tif\tyou\tsee\tany\terrors\tin\tyour\tproject,\tperform\ta Maven\tupdate.\tNow,\twe\tare\tready\tto\ttest\tour\tapplication\tfrom\tthe command\tline.\n\n6.\t Open\ta\tterminal\tand\tissue\tthe\tfollowing\tcommand\tfrom\tthe\tproject's\troot directory:\n\nmvn\tclean\tpackage\tspring-boot:run\n\n7.\t As\tyou\tcan\tsee,\twe\tare\tusing\tthe\trun\tgoal\tof\tspring-boot-maven\tplugin. This\twill\tfirst\tbuild\tyour\tproject\tand\tthen\tgive\tyou\tsomething\tlike\tthis\ton the\tconsole:\n\n8.\t The\tpackage\tgoal\tin\tthe\tprevious\tcommand\tshould\thave\tcreated\tthe\tuber JAR\tin\tthe\ttarget\tdirectory\tfor\tus.\tIf\tyou\twish,\tyou\tcould\ttry\trunning\tthe JAR\tusing\tthe\tjava\t-jar\tcommand\tas\twell.\tNow\tthat\tour\tservice\tis\tready, let's\tgo\tahead\tand\ttest\tit\tby\tposting\ta\tgeolocation.\tExecute\tthe\tfollowing curl\tcommands\tin\tyour\tterminal: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\"longitude\":\t-88.144040}'",
      "content_length": 1074,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 99,
      "content": "http://localhost:8080/geolocation\n\n9.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\nThe\tprevious\tmethod\tshowed\tyou\thow\tto\tpackage\tyour\tapplication\tusing\tthe spring-boot-maven-plugin.\tBut\tif\tyou\twould\tlike\tto\tuse\tthe\tmaven-shade- plugin,\tyou\tcan\tdo\tthat\ttoo.\tThe\tsupport\tfor\tusing\tmaven-shade-plugin\tis available\tin\tthe\tspring-boot-starter-parent\tproject.\tIf\tyou\tlook\tat\tthe\tPOM\tfile of\tthe\tparent\tproject,\tyou\tcan\tsee\tthe\tmaven-shade-plugin\tdefined.\tThe\tchoice of\tusing\teither\tspring-boot-maven-plugin\tor\tmaven-shade-plugin\tis\tleft\tto you\tand\tpurely\tdepends\ton\tyour\tneed.\n\nThere\tare\tother\tgoals\tthat\tspring-boot-maven-plugin\tprovides.\tSome\tof\tthem are\tthe\tstart\tand\tstop\tgoals.\tThe\tstart\tgoal\tis\tvery\tsimilar\tto\trun,\texcept\tit\tdoes not\tblock\tthe\toperation.\tIt\tis\tusually\tused\twhen\tyou\twould\tlike\tto\trun\tintegration tests\ton\tyour\tmicroservice.\tThe\tstop\tgoal\tis\tused\tto\tstop\tthe\tapplication\tthat\twas started\tusing\tthe\tstart\tgoal.\tTo\tlearn\tmore\tabout\tthis\tplugin,\tvisit\tthe documentation\tpage\tat\thttp://docs.spring.io/spring- boot/docs/1.3.6.RELEASE/maven-plugin/index.html\t.",
      "content_length": 1292,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 100,
      "content": "Installing\tand\tsetting\tup\tDocker\n\nBefore\twe\tlook\tat\tthe\trecipe,\tlet's\tquickly\ttalk\tabout\twhy\twe\twill\tneed\tDocker installed.\tDocker\thas\tbeen\tone\tof\tthe\tmost\tpopular\tcontainer\tframeworks\tand has\tpicked\tup\ttraction\tin\tthe\tpast\tfew\tyears.\tIn\tfact,\tthere\tare\ta\tlot\tmany organizations\tthat\tcompletely\tdepend\ton\tDocker\tfor\tshipping\tand\tdeploying their\tapplications.\tGone\tare\tthe\tdays\twhen\tDevelopers,\tBuild\tMeisters, Infrastructure\tEngineers,\tand\tDeployment\tCoordinators\twould\tdeploy\tany\tnew code\tand\tinfrastructure\tevery\trelease\tin\tthe\tmiddle\tof\tthe\tnight,\tmaking\tsure\tthe deployment\tof\tthe\tnew\tcode\tor\tinfrastructure\tdoes\tnot\taffect\texisting\tusers.\tWith frameworks\tsuch\tas\tDocker,\tMesos,\tand\tKubernetes,\tdeployments\thave\tbecome so\tmuch\teasier\tthan\thow\tthey\twere\ta\tfew\tyears\tback.\n\nLet's\tsay\tyou\twould\tlike\tto\tdeploy\ta\tweb\tapplication\tto\tTomcat.\tThere\tare definitely\tsome\tprerequisites;\tfor\tinstance,\tyou\twill\tneed\tat\tleast\ta\tfour-core machine\twith\t16\tGB\tmemory\tand\t100\tGB\tdisk\tspace.\tAnd\tafter\tthat,\tyou\thave to\tinstall\tan\toperating\tsystem\ton\tit.\tAfter\tyou\thave\tyour\tOS\tinstalled,\tyou\tneed many\tother\ttools,\tsuch\tas\tJava,\tTomcat,\tNginx,\tand\tperhaps\tother\tmonitoring and\tlog\tmanagement\ttools.\tNow\tyou\tneed\tsomeone\tto\tmaintain\tthis\tmachine- upgrades,\tinstallations,\tdeployments,\tand\tso\ton.\tIt\tbecomes\teven\tharder\tif\tyou want\ta\thorizontal\tand\tvertical\tcluster.\n\nNow\tyou\tneed\tmore\tresources,\tplus\tyou\twill\tneed\tmore\tadministrators\tto manage\tyour\tmachines.\tWhat\tif\tyou\tcould\trun\tyour\tapplication\tinside\ta container\tthat\thas\tall\tthese\tprerequisites\talready\tset\tup?\tWhat\tif\tyou\tcould\tcreate images\tthat\talready\thave\tyour\tprerequisites\tand\tyour\tapplication?\tThat's\texactly what\tDocker\thelps\tyou\twith.\tDocker\thelps\tyou\tbuild\timages\twith\twhatever\tyou need\tand\talso\thelps\tyou\trun\tcontainers\tfor\tyour\timages\ton\tmachines\tthat\thave Docker\tinstalled.\tMachines\tthat\thave\tDocker\tinstalled\tare\tcalled\tDocker\thosts. You\twill\tsee\tthis\tterm\tbeing\tused\ta\tlot\tthroughout\tthe\tbook.",
      "content_length": 1952,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 101,
      "content": "Getting\tready\n\nAt\tthe\ttime\tof\twriting\tthis,\tnative\tDocker\tinstallations\tfor\tboth\tMac\tand Windows\tare\tstill\tin\tbeta.\tSo\twe\twill\tbe\tusing\tDocker\tMachine\tin\tthis\trecipe\tand the\trest\tof\tthe\tbook.\tMoreover,\twe\twill\tbe\tusing\tthe\tMac\tversion\tof\tDocker Machine.\tIf\tyou\tare\ta\tWindows\tuser,\tmost\tof\tthe\tinstructions\tare\tstill\tgoing\tto\tbe the\tsame.\n\nIf\tyou\tare\ta\tLinux\tuser,\tyou\tcan\tskip\tthe\tsteps\twhere\twe\twork\twith\tDocker Machine.\tInstalling\tDocker\ton\tLinux\tis\tso\tmuch\teasier\tcompared\tto\tMac\tand Windows.\tPlease\tfollow\tthe\tinstallation\tinstructions\ton\tDocker's\twebsite\tto install\tit\ton\tyour\tLinux\tmachine.\tYou\tcan\tfind\tthe\tdocumentation\there:\t https://docs.docker.com/engine/installation/#/on-linux\t.\n\nDocker\tMachine\tfor\tMac\tor\tWindows\tutilizes\tOracle\tVirtualBox\tto\tspin\toff virtual\tmachines\tthat\tact\tas\tDocker\thosts.\tDocker\tMachine\twill\tcommunicate with\tthe\tVirtualBox\tVM\tinstances\tfor\tany\tcommands\tyou\tissue\tin\tyour command\tline.\tFor\tmore\tinformation\ton\thow\tDocker\tMachine\tworks,\ttake\ta look\tat\tthis\tlink:\thttps://docs.docker.com/machine/concepts\t.\tAs\tthis\tis\ta\tlittle out\tof\tscope\tfor\tthis\tbook,\tit\tis\tstrongly\trecommended\tthat\tyou\tread\tand understand\thow\tDocker\tand\tDocker\tMachine\twork\tbefore\tmoving\tto\tthe\tnext section.",
      "content_length": 1215,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 102,
      "content": "How\tto\tdo\tit... 1.\t Let's\tgo\tto\tthe\thomepage\tof\tDocker\tToolbox\tat\n\nhttps://www.docker.com/products/docker-toolbox\t.\tDocker\tToolbox\tis currently\tsupported\tfor\tWindows\tand\tMac.\tIt\tis\tjust\ta\tpackage\tof\tfour different\tproducts\tfrom\tDocker:\tDocker\tEngine,\tDocker\tMachine,\tDocker Compose,\tand\tDocker\tKitematic.\n\nNote\n\nDocker\tKitematic\tis\tDocker's\tattempt\tat\ta\tUI-driven\tmanagement\tconsole for\tDocker\ton\tyour\tmachine.\tWe\twill\tbe\tlooking\tat\tDocker\tCompose\tin\tthe next\tchapter.\n\n2.\t From\tthe\thome\tpage,\tchoose\tyour\toperating\tsystem\ttype\tand\tdownload\tthe DMG\t(for\tMac)\tor\tEXE\t(for\tWindows)\tfile.\tAt\tthe\ttime\tof\twriting\tthis,\tthe following\tis\thow\tthe\tDocker\tToolbox\thomepage\tlooked\tlike.\tOver\ttime, there\tcould\tbe\tchanges\tbut\tthe\tidea\tis\tto\tdownload\tthe\tDMG\tor\tEXE\tfile from\tthe\thome\tpage.\n\n3.\t Once\tthe\tdownload\tis\tcomplete,\tgo\tahead\tand\topen\tthe\tdownloaded installer\tfile.\tYou\tshould\tsee\tsomething\tlike\tthis.\tGo\tahead\tand\tclick\ton",
      "content_length": 921,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 103,
      "content": "Continue.\n\n4.\t In\tthe\tOverview\tsection,\tyou\twill\thave\tthe\toption\tto\tlet\tDocker\tcollect anonymous\tdata\tfor\ttheir\tpurposes.\tEither\tcheck\tor\tuncheck\tthat\toption\tand hit\tContinue:",
      "content_length": 175,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 104,
      "content": "5.\t The\tnext\ttwo\tsections,\tDestination\tSelect\tand\tInstallation\tType,\tare\tpretty straight-forward.\tYou\twill\tbe\tprompted\tto\tchoose\twhere\tyou\twould\tlike\tto install\tDocker\tToolbox.\tChoose\tthe\tdirectory\tof\tyour\tchoice\tand\thit\tInstall:",
      "content_length": 229,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 105,
      "content": "6.\t You\twill\tbe\tshown\tthe\tprogress\tof\tyour\tinstallation,\tand\twhen\tit\tis complete,\tyou\twill\tsee\tsomething\tlike\tthis:",
      "content_length": 115,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 106,
      "content": "7.\t You\twill\tbe\tprompted\tto\teither\topen\tDocker\tQuickstart\tTerminal\tor Kitematic.\tSkip\tthem\tboth\tand\thit\tContinue\tto\tcomplete\tthe\tinstallation. 8.\t Now\tlet's\ttest\tour\tinstallation.\tAs\twe\tare\tusing\tMac\tin\tour\trecipes,\tyou\twill see\tUnix\tcommands\tused\tthroughout\tthe\tbook.\tFor\tWindows\tusers,\tit\tmight be\ta\tgood\tidea\tto\tinstall\tCygwin\tif\tyou\tare\tfamiliar\twith\tit.\tEither\tway,\tthe commands\tshould\tbe\tthe\tsame\ton\tboth\toperating\tsystems.\tIssue\tthe following\tcommand\ton\tyour\tterminal:\n\ndocker-machine\tls\n\n9.\t This\tcommand\tis\tused\tto\tlist\tthe\tVirtualBox\tVMs\tcreated\tin\tyour\tmachine. By\tdefault,\tyou\twill\tsee\tone\tVM\tcreated,\twith\tthe\tname\tdefault.\tYou\twill see\tsomething\tlike\tthis:\n\n10.\t By\tdefault,\tthis\tVM\tmight\tnot\thave\tsufficient\tresources\tto\trun\tthe",
      "content_length": 743,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 107,
      "content": "frameworks\twe\twould\twant\tto\tuse.\tSo\tlet's\trecreate\tthis\tVM\twith\t4\tCPUs and\t4096\tMB\tmemory.\tExecute\tthe\tfollowing\tcommand\tto\trecreate\tyour VM\t(if\tit\tasks\tfor\tdelete\tconfirmation,\tchoose\tYes):\n\ndocker-machine\trm\tdefault\t&&\tdocker-machine\tcreate\t-d\t virtualbox\t--virtualbox-memory=4096\t--virtualbox-cpu-count=4\t default\n\n11.\t We\tare\tdoing\ttwo\tthings\tin\tthe\tpreceding\tcommand:\tremoving\tthe\texisting VM\tand\trecreating\tthe\tVM\twith\tmore\tresources.\tAs\tyou\tcan\tsee,\twe\tare passing\tVirtualBox\tspecific\targuments\t--virtualbox-memory\tand\t-- virtualbox-cpu-count\t\t\tto\tincrease\tthe\tmemory\tand\tCPU\tcount respectively.\tIn\tour\tcase,\twe\thave\tprovided\t4\tCPUs\tand\t4096\tMB\tmemory to\tour\tVM.\tThis\tshould\tbe\tsufficient\tto\trun\tthe\tframeworks\tthat\twe\twill\tbe using\tin\tthis\tbook. After\tyou\trun\tthe\tcommand\tyou\tshould\thave\tseen\tsomething\tlike\tthis:\n\n12.\t If\tyou\tsee\tthat\tyour\tVM\tis\tstopped,\tissue\tthe\tfollowing\tcommand\tto\tstart\tit:\n\ndocker-machine\tstart\tdefault\n\n13.\t After\tyou\tissue\tthe\tprevious\tcommand,\tyou\twill\tsee\tthis:",
      "content_length": 997,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 108,
      "content": "14.\t As\tyou\tcan\tsee,\tyou\twill\thave\tto\trun\tthe\tenv\tcommand\tto\tmake\tyour\tshell ready\tto\tuse\tthis\tdocker-machine\tinstance.\tIn\torder\tto\tdo\tthat,\tissue\tthe following\tcommand\ton\tyour\tconsole: eval\t$(docker-machine\tenv\tdefault)\n\n15.\t This\tmakes\tyour\tshell\tready\tto\tuse\tyour\tnewly\tcreated\tDocker\tMachine instance\tcalled\tdefault.\tIf\tyou\twould\tlike\tto\tsee\tyour\tVirtualBox\tVM, open\tVirtualBox,\tand\tyou\twill\tsee\tthat\tyour\tDocker\thost\thas\tbeen\tcreated and\tis\trunning.\tNow\tlet's\ttry\tto\tspin\toff\tour\tfirst\tDocker\tcontainer: docker\trun\thello-world\n\n16.\t You\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 573,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 109,
      "content": "17.\t There\tare\tlots\tof\tthings\tgoing\ton\there.\tLet's\ttry\tto\tunderstand\tthem\tone\tby one:\n\nFirst,\tlet's\tunderstand\tthe\tline\tthat\tsays\tUnable\tto\tfind\timage 'hello-world:latest'\tlocally.\tThis\tline\tsays\tthat\tyou\tare\ttrying\tto run\ta\tcontainer\tfor\tan\timage\tthat\tdoes\tnot\texist\tin\tyour\tDocker\thost. Docker\tthen\tdownloads\tthe\timage\tfrom\tDocker\tHub\t(over\tthe Internet)\tand\tlater\tuses\tthat\timage\tto\trun\ta\tcontainer. You\tcan\tfind\tthis\timage\ton\tDocker\tHub\there: https://hub.docker.com/_/hello-world/\t.\tWhile\thello-world\tis\tthe name\tof\tthe\timage,\tlatest\tis\tits\ttag. Tags\tare\tpretty\tmuch\tthe\tsame\tas\tversions.\tAs\tyou\tcan\tsee,\teven\twhen we\tdid\tnot\tprovide\tthe\tdocker\ttag\tin\tour\tdocker\trun\tcommand, Docker\tautomatically\tused\tthe\tlatest\ttag. After\tthe\tdownload,\tyou\tcan\tsee\tthe\thello\tworld\tmessage.\tThis\tsays that\twe\thave\tsuccessfully\trun\tthis\tcontainer\tand\thence\tsuccessfully",
      "content_length": 856,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 110,
      "content": "installed\tDocker.\n\n18.\t If\tyou\twould\tlike\tto\tsee\tthe\timages\tavailable\ton\tyour\tDocker\thost,\tissue\tthe following\tcommand:\n\ndocker\timages\n\n19.\t You\tshould\tsee\tsomething\tlike\tthis:\n\n20.\t If\tyou\twould\tlike\tto\tsee\tthe\tcontainers\tthat\tare\trunning\ton\tyour\tDocker machine,\tuse\tthe\tfollowing\tcommand:\n\ndocker\tps\t-a\n\n21.\t The\t-a\tflag\trequests\tDocker\tto\tshow\tall\tcontainers,\tincluding\tthe\tones\tthat were\tstopped.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto Dockerize\tour\tmicroservice.",
      "content_length": 546,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 111,
      "content": "Writing\tyour\tDockerfile\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tseen\thow\tto\tpackage\tour\tapplication\tand\thow\tto install\tDocker.\tNow\tthat\twe\thave\tour\tJAR\tartifact\tand\tDocker\tset\tup,\tlet's\tsee how\tto\tDockerize\tour\tmicroservice\tapplication\tusing\tDocker.",
      "content_length": 242,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 112,
      "content": "Getting\tready\n\nIn\torder\tto\tDockerize\tour\tapplication,\twe\twill\thave\tto\ttell\tDocker\thow\tour\timage is\tgoing\tto\tlook\tlike.\tThis\tis\texactly\tthe\tpurpose\tof\ta\tDockerfile.\tA\tDockerfile has\tits\town\tsyntax\t(or\tDockerfile\tinstructions)\tand\twill\tbe\tused\tby\tDocker\tto create\timages.\tThroughout\tthis\trecipe,\twe\twill\ttry\tto\tunderstand\tsome\tof\tthe most\tcommonly\tused\tDockerfile\tinstructions\tas\twe\twrite\tour\tDockerfile\tfor\tthe geolocation\ttracker\tmicroservice.",
      "content_length": 443,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 113,
      "content": "How\tto\tdo\tit... 1.\t First,\topen\tyour\tSTS\tIDE\tand\tcreate\ta\tnew\tfile\tcalled\tDockerfile\tin\tthe geolocation\tproject.\tThe\tfirst\tline\tof\tthe\tDockerfile\tis\talways\tthe\tFROM instruction\tfollowed\tby\tthe\tbase\timage\tthat\tyou\twould\tlike\tto\tcreate\tyour image\tfrom.\tThere\tare\tthousands\tof\timages\ton\tDocker\tHub\tto\tchoose\tfrom. In\tour\tcase,\twe\twould\tneed\tsomething\tthat\talready\thas\tJava\tinstalled\ton\tit. There\tare\tsome\timages\tthat\tare\tofficial,\tmeaning\tthey\tare\twell\tdocumented and\tmaintained.\n\nNote\n\nDocker\tOfficial\tRepositories\tare\tvery\twell\tdocumented,\tand\tthey\tfollow best\tpractices\tand\tstandards.\tDocker\thas\tits\town\tteam\tto\tmaintain\tthese repositories.\tThis\tis\tessential\tin\torder\tto\tkeep\tthe\trepository\tclear,\tthus helping\tthe\tuser\tmake\tthe\tright\tchoice\tof\trepository.\tTo\tread\tmore\tabout Docker\tOfficial\tRepositories,\ttake\ta\tlook\tat https://docs.docker.com/docker-hub/official_repos/\t.\n\n2.\t We\twill\tbe\tusing\tthe\tJava\tofficial\trepository.\tTo\tfind\tthe\tofficial\trepository, go\tto\thub.docker.com\tand\tsearch\tfor\tjava.\tYou\thave\tto\tchoose\tthe\tone\tthat says\tofficial.\tAt\tthe\ttime\tof\twriting\tthis,\tthe\tJava\timage\tdocumentation\tsays it\twill\tsoon\tbe\tdeprecated\tin\tfavor\tof\tthe\topenjdk\timage.\tSo\tthe\tfirst\tline\tof our\tDockerfile\twill\tlook\tlike\tthis: FROM\topenjdk:8\n\n3.\t As\tyou\tcan\tsee,\twe\thave\tused\tversion\t(or\ttag)\t8\tfor\tour\timage.\tIf\tyou\tare wondering\twhat\ttype\tof\toperating\tsystem\tthis\timage\tuses,\ttake\ta\tlook\tat\tthe Dockerfile\tof\tthis\timage,\twhich\tyou\tcan\tget\tfrom\tthe\tDocker\tHub\tpage. Docker\timages\tare\tusually\ttagged\twith\tthe\tversion\tof\tthe\tsoftware\tthey\tare written\tfor.\tThat\tway,\tit\tis\teasy\tfor\tusers\tto\tpick\tfrom.\tThe\tnext\tstep\tis creating\ta\tdirectory\tfor\tour\tproject\twhere\twe\twill\tstore\tour\tJAR\tartifact. Add\tthis\tas\tyour\tnext\tline:\n\nRUN\tmkdir\t-p\toptpackt/geolocation\n\nThis\tis\ta\tsimple\tUnix\tcommand\tthat\tcreates\tthe\toptpackt/geolocation directory.\tThe\t-p\tflag\tinstructs\tit\tto\tcreate\tthe\tintermediate\tdirectories\tif they\tdon't\texist.\tNow\tlet's\tcreate\tan\tinstruction\tthat\twill\tadd\tthe\tJAR\tfile",
      "content_length": 1977,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 114,
      "content": "that\twas\tcreated\tin\tyour\tlocal\tmachine\tinto\tthe\tcontainer\tat optpackt/geolocation.\n\nADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar\toptpackt/geolocation/\n\n4.\t As\tyou\tcan\tsee,\twe\tare\tpicking\tup\tthe\tuber\tJAR\tfrom\ttarget\tdirectory\tand dropping\tit\tinto\tthe\toptpackt/geolocation/\tdirectory\tof\tthe\tcontainer. Take\ta\tlook\tat\tthe\t/\tat\tthe\tend\tof\tthe\ttarget\tpath.\tThat\tsays\tthat\tthe\tJAR\thas to\tbe\tcopied\tinto\tthe\tdirectory.\n\n5.\t Before\twe\tcan\tstart\tthe\tapplication,\tthere\tis\tone\tthing\twe\thave\tto\tdo,\tthat\tis, expose\tthe\tports\tthat\twe\twould\tlike\tto\tbe\tmapped\tto\tthe\tDocker\thost\tports. In\tour\tcase,\tthe\tin-memory\tTomcat\tinstance\tis\trunning\ton\tport\t8080.\tIn order\tto\tbe\table\tto\tmap\tport\t8080\tof\tour\tcontainer\tto\tany\tport\ton\tour Docker\thost,\twe\thave\tto\texpose\tit\tfirst.\tFor\tthat,\twe\twill\tuse\tthe\tEXPOSE instruction.\tAdd\tthe\tfollowing\tline\tto\tyour\tDockerfile: EXPOSE\t8080\n\n6.\t Now\tthat\twe\tare\tready\tto\tstart\tthe\tapp,\tlet's\tgo\tahead\tand\ttell\tDocker\thow to\tstart\ta\tcontainer\tfor\tthis\timage.\tFor\tthat,\twe\twill\tuse\tthe\tCMD\tinstruction:\n\nCMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\nThere\tare\ttwo\tthings\twe\thave\tto\tnote\there.\tOne\tis\tthe\tway\twe\tare\tstarting\tthe application\tand\tthe\tother\tis\thow\tthe\tcommand\tis\tbroken\tdown\tinto\tcomma- separated\tStrings.\n\nFirst,\tlet's\ttalk\tabout\thow\twe\tstart\tthe\tapplication.\tYou\tmight\tbe\twondering\twhy we\thaven't\tused\tthe\tmvn\tspring-boot:run\tcommand\tto\tstart\tthe\tapplication. Keep\tin\tmind\tthat\tthis\tcommand\twill\tbe\texecuted\tinside\tthe\tcontainer,\tand\tour container\tdoes\tnot\thave\tMaven\tinstalled,\tonly\tOpenJDK\t8.\tIf\tyou\twould\tlike\tto use\tthe\tmvn\tcommand,\ttake\tthat\tas\tan\texercise,\tand\ttry\tto\tinstall\tMaven\ton\tyour container\tand\tuse\tthe\tmvn\tcommand\tto\tstart\tthe\tapplication.\tNow\tthat\twe\tknow we\thave\tJava\tinstalled,\twe\tare\tissuing\ta\tvery\tsimple\tjava\t-jar\tcommand\tto\trun the\tJAR.\tIn\tfact,\tthe\tSpring\tBoot\tMaven\tplugin\tinternally\tissues\tthe\tsame command.\n\nThe\tnext\tthing\tis\thow\tthe\tcommand\thas\tbeen\tbroken\tdown\tinto\tcomma- separated\tStrings.\tThis\tis\ta\tstandard\tthat\tthe\tCMD\tinstruction\tfollows.\tTo\tkeep\tit",
      "content_length": 2040,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 115,
      "content": "simple,\tkeep\tin\tmind\tthat\tfor\twhatever\tcommand\tyou\twould\tlike\tto\trun\tupon running\tthe\tcontainer,\tjust\tbreak\tit\tdown\tinto\tcomma-separated\tStrings\t(in whitespaces).\n\nYour\tfinal\tDockerfile\tshould\tlook\tsomething\tlike\tthis:\n\nFROM\topenjdk:8 RUN\tmkdir\t-p\toptpackt/geolocation ADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar \t\t\t\t\t\t\t\t\t\t\t\toptpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\nThis\tDockerfile\tis\tone\tof\tthe\tsimplest\timplementations.\tDockerfiles\tcan sometimes\tget\tbigger\tdue\tto\tthe\tfact\tthat\tyou\tneed\ta\tlot\tof\tcustomizations\tto your\timage.\tIn\tsuch\tcases,\tit\tis\ta\tgood\tidea\tto\tbreak\tit\tdown\tinto\tmultiple\timages that\tcan\tbe\treused\tand\tmaintained\tseparately.\n\nWith\tthat\tsaid,\twe've\tcome\tto\tthe\tcompletion\tof\tthis\trecipe.\tThere\tare\tsome\tbest practices\tto\tfollow\twhenever\tyou\tcreate\tyour\town\tDockerfile\tand\timage. Though\twe\thaven't\tcovered\tthat\there\tas\tit\tis\tout\tof\tthe\tscope\tof\tthis\tbook,\tyou still\tshould\ttake\ta\tlook\tat\tthem\tand\tfollow\tthem.\tTo\tlearn\tmore\tabout\tthe\tvarious Dockerfile\tinstructions,\tgo\tto\thttps://docs.docker.com/engine/reference/builder/\t.",
      "content_length": 1111,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 116,
      "content": "Building\tyour\tDocker\timage\n\nIn\tthe\tprevious\trecipe,\twe\tcreated\tthe\tDockerfile,\twhich\twill\tbe\tused\tin\tthis recipe\tto\tcreate\tan\timage\tfor\tour\tmicroservice.\tIf\tyou\tare\twondering\twhy\twe would\tneed\tan\timage,\tit\tis\tthe\tonly\tway\twe\tcan\tship\tour\tsoftware\tto\tany\tsystem. Once\tyou\thave\tyour\timage\tcreated\tand\tuploaded\tto\ta\tcommon\trepository,\tit\twill be\teasier\tto\tpull\tyour\timage\tfrom\tany\tlocation.",
      "content_length": 387,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 117,
      "content": "Getting\tready\n\nBefore\tyou\tjump\tinto\tthe\tactual\trecipe,\tit\tmight\tbe\ta\tgood\tidea\tto\tget\tyourself familiar\twith\tsome\tof\tthe\tmost\tcommonly\tused\tDocker\tcommands.\tIn\tthis recipe,\twe\twill\tuse\tthe\tbuild\tcommand.\tTake\ta\tlook\tat\tthis\tURL\tto\tunderstand the\tother\tcommands: https://docs.docker.com/engine/reference/commandline/#/image-commands\t. After\tfamiliarizing\tyourself\twith\tthe\tcommands,\topen\tup\ta\tnew\tterminal,\tand change\tyour\tdirectory\tto\tthe\troot\tof\tthe\tgeolocation\tproject.\tMake\tsure\tyour docker-machine\tinstance\tis\trunning.\tIf\tit\tis\tnot\trunning,\tuse\tthe\tdocker- machine\tstart\tcommand\tto\trun\tyour\tdocker-machine\tinstance:\n\ndocker-machine\tstart\tdefault\n\nIf\tyou\thave\tto\tconfigure\tyour\tshell\tfor\tthe\tdefault\tDocker\tmachine,\tgo\tahead\tand execute\tthe\tfollowing\tcommand:\n\neval\t$(docker-machine\tenv\tdefault)",
      "content_length": 798,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 118,
      "content": "How\tto\tdo\tit... 1.\t From\tthe\tterminal,\tissue\tthe\tfollowing\tdocker\tbuild\tcommand:\n\ndocker\tbuild\t-t\tpackt/geolocation\t.\n\n2.\t We'll\ttry\tto\tunderstand\tthe\tcommand\tlater.\tFor\tnow,\tlet's\tsee\twhat\thappens after\tyou\tissue\tthe\tpreceding\tcommand.\tYou\tshould\tsee\tDocker downloading\tthe\topenjdk\timage\tfrom\tDocker\tHub.\n\n3.\t Once\tthe\timage\thas\tbeen\tdownloaded,\tyou\twill\tsee\tthat\tDocker\ttries\tto validate\teach\tand\tevery\tinstruction\tprovided\tin\tthe\tDockerfile.\tWhen\tthe last\tinstruction\thas\tbeen\tprocessed,\tyou\twill\tsee\ta\tmessage\tsaying Successfully\tbuilt.\tThis\tsays\tthat\tyour\timage\thas\tbeen\tsuccessfully built.",
      "content_length": 595,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 119,
      "content": "4.\t Now\tlet's\ttry\tto\tunderstand\tthe\tcommand.\tThere\tare\tthree\tthings\tto\tnote here:\n\nThe\tfirst\tthing\tis\tthe\tdocker\tbuild\tcommand\titself.\tThe\tdocker build\tcommand\tis\tused\tto\tbuild\ta\tDocker\timage\tfrom\ta\tDockerfile.\tIt needs\tat\tleast\tone\tinput,\twhich\tis\tusually\tthe\tlocation\tof\tthe Dockerfile.\n\nNote\n\nDockerfiles\tcan\tbe\trenamed\tto\tsomething\tother\tthan\tDockerfile\tand can\tbe\treferred\tto\tusing\tthe\t-f\toption\tof\tthe\tdocker\tbuild\tcommand.\tAn instance\tof\tthis\tbeing\tused\tis\twhen\tteams\thave\tdifferent\tDockerfiles for\tdifferent\tbuild\tenvironments,\tfor\texample,\tusing\tDockerfileDev\tfor the\tdevelopment\tenvironment,\tDockerfileStaging\tfor\tthe\tstaging",
      "content_length": 635,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 120,
      "content": "environment,\tand\tDockerfileProd\tfor\tthe\tproduction\tenvironment.\tIt\tis still\tencouraged\tas\ta\tbest\tpractice\tto\tuse\tother\tDocker\toptions\t(like passing\targuments)\tin\torder\tto\tkeep\tthe\tsame\tDockerfile\tfor\tall environments.\tFor\tmore\tinformation\ton\thow\tto\tpass\targuments\tto Dockerfile,\tplease\ttake\ta\tlook\tat\tthis\tdocumentation: https://docs.docker.com/engine/reference/builder/#arg\n\nThe\tsecond\tthing\tis\tthe\t-t\toption.\tThe\t-t\toption\ttakes\tthe\tname\tof\tthe repo\tand\ta\ttag.\tIn\tour\tcase,\twe\thave\tnot\tmentioned\tthe\ttag,\tso\tby default,\tit\twill\tpick\tup\tlatest\tas\tthe\ttag.\tIf\tyou\tlook\tat\tthe\trepo\tname, it\tis\tdifferent\tfrom\tthe\tofficial\topenjdk\timage\tname.\tIt\thas\ttwo\tparts: packt\tand\tgeolocation.\tIt\tis\talways\ta\tgood\tpractice\tto\tput\tthe\tDocker Hub\taccount\tname\tfollowed\tby\tthe\tactual\timage\tname\tas\tthe\tname\tof your\trepo.\tFor\tnow,\twe\twill\tuse\tpackt\tas\tour\ttemporary\taccount\tname, but\tin\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto\tcreate\tour\town\tDocker\tHub account\tand\tuse\tthat\taccount\tname\there. The\tthird\tthing\tis\tthe\tdot\tat\tthe\tend.\tThe\tdot\toperator\tsays\tthat\tthe Dockerfile\tis\tlocated\tin\tthe\tcurrent\tdirectory,\tor\tthe\tpresent\tworking directory\tto\tbe\tmore\tprecise.\n\n5.\t Let's\tgo\tahead\tand\tverify\twhether\tour\timage\twas\tcreated.\tIn\torder\tto\tdo that,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\timages\n\n6.\t The\tdocker\timages\tcommand\tis\tused\tto\tlist\tdown\tall\timages\tavailable\tin your\tDocker\thost.\tAfter\tissuing\tthe\tcommand,\tyou\tshould\tsee\tsomething like\tthis:\n\nAs\tyou\tcan\tsee,\tthe\tnewly\tbuilt\timage\tis\tlisted\tas\tpackt/geolocation\tin\tyour Docker\thost.\tThe\ttag\tfor\tthis\timage\tis\tlatest\tas\twe\tdid\tnot\tspecify\tany.\tThe image\tID\tuniquely\tidentifies\tyour\timage.\tNote\tthe\tsize\tof\tthe\timage.\tIt\tis\ta\tfew megabytes\tbigger\tthan\tthe\topenjdk:8\timage.\tThat\tis\tmost\tprobably\tbecause\tof the\tsize\tof\tour\texecutable\tuber\tJAR\tinside\tthe\tcontainer.",
      "content_length": 1814,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 121,
      "content": "Now\tthat\twe\tknow\thow\tto\tbuild\tan\timage\tusing\tan\texisting\tDockerfile,\twe\tare\tat the\tend\tof\tthis\trecipe.\tThis\tis\tjust\ta\tvery\tquick\tintro\tto\tthe\tdocker\tbuild command.\tThere\tare\tmore\toptions\tthat\tyou\tcan\tprovide\tto\tthe\tcommand,\tsuch\tas CPUs\tand\tmemory.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tdocker\tbuild\tcommand,\ttake\ta\tlook\tat\tthis\tpage:\t https://docs.docker.com/engine/reference/commandline/build/",
      "content_length": 388,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 122,
      "content": "Running\tyour\tmicroservice\tinside\ta Docker\tcontainer\n\nIn\tthe\tprevious\trecipe,\twe\tsuccessfully\tcreated\tour\tDocker\timage\tin\tthe\tDocker host.\tKeep\tin\tmind\tthat\tif\tyou\tare\tusing\tWindows\tor\tMac,\tyour\tDocker\thost\tis the\tVirtualBox\tVM\tand\tnot\tyour\tlocal\tcomputer.\tIn\tthis\trecipe,\twe\twill\tlook\tat how\tto\tspin\toff\ta\tcontainer\tfor\tthe\tnewly\tcreated\timage.",
      "content_length": 344,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 123,
      "content": "Getting\tready\n\nTo\tspin\toff\ta\tnew\tcontainer\tfor\tour\tpackt/geolocation\timage,\twe\twill\tuse\tthe docker\trun\tcommand.\tThis\tcommand\tis\tused\tto\trun\tany\tcommand\tinside\tyour container,\tgiven\tthe\timage.\tOpen\tyour\tterminal\tand\tgo\tto\tthe\troot\tof\tthe geolocation\tproject.\tIf\tyou\thave\tto\tstart\tyour\tDocker\tmachine\tinstance,\tthen\tdo so\tby\tusing\tthe\tdocker-machine\tstart\tcommand,\tand\tset\tthe\tenvironment using\tthe\tdocker-machine\tenv\tcommand.",
      "content_length": 424,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 124,
      "content": "How\tto\tdo\tit... 1.\t Go\tahead\tand\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\trun\tpackt/geolocation\n\n2.\t Right\tafter\tyou\trun\tthe\tcommand,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nYay!\tWe\tcan\tsee\tthat\tour\tmicroservice\tis\trunning\tas\ta\tDocker\tcontainer. But\twait-there\tis\tmore\tto\tit.\tLet's\tsee\thow\twe\tcan\taccess\tour\tmicroservice's in-memory\tTomcat\tinstance.\tTry\tto\trun\ta\tcurl\tcommand\tto\tsee\tif\tour\tapp\tis up\tand\trunning:\n\n3.\t Open\ta\tnew\tterminal\tinstance\tand\texecute\tthe\tfollowing\tcURL\tcommand\tin that\tshell:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":-88.144040}'\t http://localhost:8080/geolocation\n\n4.\t Did\tyou\tget\tan\terror\tmessage\tlike\tthis?\n\ncurl:\t(7)\tFailed\tto\tconnect\tto\tlocalhost\tport\t8080: \t\t\t\t\t\t\t\t\t\t\t\tConnection\trefused\n\nLet's\ttry\tto\tunderstand\twhat\thappened\there.\tWhy\twould\twe\tget\ta\tconnection refused\terror\twhen\tour\tmicroservice\tlogs\tclearly\tsay\tthat\tit\tis\trunning\ton\tport 8080?\tYes,\tyou\tguessed\tit\tright:\tthe\tmicroservice\tis\tnot\trunning\ton\tyour\tlocal",
      "content_length": 1087,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 125,
      "content": "computer;\tit\tis\tactually\trunning\tinside\tthe\tcontainer,\twhich\tin\tturn\tis\trunning inside\tyour\tDocker\thost.\tHere,\tyour\tDocker\thost\tis\tthe\tVirtualBox\tVM\tcalled default.\n\nSo\twe\thave\tto\treplace\tlocalhost\tin\tyour\tcURL\tcommand\twith\tthe\tIP\tof\tthe container.\tBut\tgetting\tthe\tIP\tof\tthe\tcontainer\tis\tnot\tstraight-forward.\tThat\tis\tthe reason\twe\tare\tgoing\tto\tmap\tport\t8080\tof\tthe\tcontainer\tto\tthe\tsame\tport\ton\tthe VM.\tThis\tmapping\twill\tmake\tsure\tthat\tany\trequest\tmade\tto\tport\t8080\ton\tthe\tVM will\tbe\tforwarded\tto\tport\t8080\tof\tthe\tcontainer.\n\n1.\t Now\tgo\tto\tthe\tshell\tthat\tis\tcurrently\trunning\tyour\tcontainer,\tand\tstop\tyour container.\tUsually,\tCtrl\t+\tC\twill\tdo\tthe\tjob.\tAfter\tyour\tcontainer\tis\tstopped, issue\tthe\tfollowing\tcommand:\n\ndocker\trun\t-p\t8080:8080\tpackt/geolocation\n\n2.\t The\t-p\toption\tdoes\tthe\tport\tmapping\tfrom\tDocker\thost\tto\tcontainer.\tThe port\tnumber\tto\tthe\tleft\tof\tthe\tcolon\tindicates\tthe\tport\tnumber\tof\tthe\tDocker host,\tand\tthe\tport\tnumber\tto\tthe\tright\tof\tthe\tcolon\tindicates\tthat\tof\tthe container.\tIn\tour\tcase,\tboth\tof\tthem\tare\tsame.\tAfter\tyou\texecute\tthe previous\tcommand,\tyou\tshould\tsee\tthe\tsame\tlogs\tthat\tyou\tsaw\tbefore. 3.\t We\tare\tnot\tdone\tyet.\tWe\tstill\thave\tto\tfind\tthe\tIP\tthat\twe\thave\tto\tuse\tto\thit our\tRESTful\tendpoint.\tThe\tIP\tthat\twe\thave\tto\tuse\tis\tthe\tIP\tof\tour\tDocker Machine\tVM.\tTo\tfind\tthe\tIP\tof\tthe\tdocker-machine\tinstance,\texecute\tthe following\tcommand\tin\ta\tnew\tterminal\tinstance:\n\ndocker-machine\tip\tdefault\n\n4.\t This\tshould\tgive\tyou\tthe\tIP\tof\tthe\tVM.\tLet's\tsay\tthe\tIP\tthat\tyou\treceived was\t192.168.99.100.\tNow,\treplace\tlocalhost\tin\tyour\tcURL\tcommand with\tthis\tIP,\tand\texecute\tthe\tcURL\tcommand\tagain: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":-88.144040}'\t http://192.168.99.100:8080/geolocation\n\n5.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",",
      "content_length": 2055,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 126,
      "content": "\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n6.\t This\tconfirms\tthat\tyou\tare\table\tto\taccess\tyour\tmicroservice\tfrom\tthe outside.\tBefore\tyou\tmove\ton\tto\tthe\tnext\trecipe,\ttake\ta\tmoment\tto understand\thow\tthe\tport\tmapping\tis\tdone.\tThe\tfollowing\tfigure\tshows\thow your\tmachine,\tVM,\tand\tcontainer\tare\torchestrated:\n\nAs\tyou\tcan\tsee,\tthe\tDocker\tcontainer\tis\trunning\tinside\tthe\tDocker\thost (VirtualBox\tVM),\twhich\tin\tturn\tis\trunning\ton\tour\tlocal\tcomputer.\tThis\tis\tthe hierarchy\tin\twhich\tthe\tmachines\tare\torchestrated.\tOur\tport\tmapping\tmaps\tport 8080\ton\tthe\tDocker\thost\tto\tport\t8080\tof\tthe\tDocker\tcontainer.",
      "content_length": 642,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 127,
      "content": "Pushing\tyour\timage\tto\tDocker\tHub\n\nIn\tthe\tprevious\trecipe,\twe\tsaw\thow\tto\trun\tyour\tmicroservice\tas\ta\tDocker container.\tYour\timage\tis\tnot\treally\tuseful\tunless\tyou\tmake\tit\teasier\tfor\tshipping. In\torder\tfor\tyour\timage\tto\tbe\taccessible\tfrom\tother\tplaces,\tyou\tshould\tfirst\thost it\tsomewhere.\n\nThere\tare\ttwo\tways\tof\tdoing\tthis:\teither\tpush\tyour\timage\tto\tthe\tDocker\tHub central\trepository,\tor\tcreate\tyour\town\tprivate\tDocker\tregistry\tand\tpush\tit\tthere. Repositories\tcreated\ton\tDocker\tHub\tare\tby\tdefault\tpublic.\tYou\tcan\tstill\tpurchase various\tplans\tto\tmake\tyour\trepositories\tprivate.\tThat\tis\tcompletely\tup\tto\tyou\tand depends\ton\tyour\tuse\tcase.",
      "content_length": 631,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 128,
      "content": "Getting\tready 1.\t Before\tyou\tcan\tpush\tthe\timage\tto\tDocker\tHub,\tyou\twill\tfirst\tneed\ta\tDocker Hub\taccount.\tIf\tyou\talready\thave\tone,\tskip\tthis\tstep.\tIf\tyou\tdon't\thave\tone, go\tto\thttps://hub.docker.com/\tand\tstart\tcreating\tan\taccount\tfor\tyourself. You\twill\tneed\tthree\tthings:\n\nUser\tID Email\tassociated Password\n\n2.\t After\tyou\thave\tcreated\ta\tnew\taccount,\tlog\tin\twith\tyour\tcredentials.\tTake some\ttime\tto\tget\tfamiliar\twith\tthe\tDocker\tHub\tuser\tinterface.\tIt\tis\tpretty simple\tand\tstraight-forward.\n\n3.\t The\tnext\tthing\twe\thave\tto\tdo\tis\tcreate\ta\trepository\tfor\tour\tnew microservice.\tThis\tis\trequired\tbefore\twe\tstart\ttrying\tto\tpush\tthe\timage\tto Docker\tHub.\tTo\tcreate\ta\tnew\trepository,\tclick\ton\tthe\tCreate\tRepository button:\n\n4.\t In\tthe\tCreate\tRepository\tform,\tenter\tthe\trepository\tname\tas\tgeolocation. Give\tthe\tshort\tdescription\tas\tGeo\tLocation\tTracking\tService\tand\tthe\tfull description\tas\tGeo\tlocation\ttracking\tmicroservice\tthat\twill\tbe responsible\tfor\tcollecting\tand\tstoring\tgeolocations\tof\tusers. Mark\tthe\tvisibility\tof\tyour\timage\tas\tpublic.\tIf\tyou\thave\tsome\tsensitive information\tin\tyour\timage,\tit\tis\trecommended\tyou\tuse\tprivate.\tBut\tsince our\timage\tis\tnot\tthat\tsensitive,\twe\twill\tuse\tpublic\tvisibility.\tMoreover, using\tthe\tprivate\tvisibility\trequires\tadditional\tconfiguration\twhen\tyou\ttry to\tpull\tyour\timage\tfrom\tMarathon\tand\tKubernetes.",
      "content_length": 1329,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 129,
      "content": "5.\t After\tentering\tall\tthese\tfields,\thit\tthe\tCreate\tbutton.\tAfter\tthe\trepository\tis created,\tyou\tshould\tsee\ta\tscreen\tsimilar\tto\tthis:",
      "content_length": 133,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 130,
      "content": "As\tyou\tcan\tsee,\tfor\tconsistency,\twe\twill\tuse\tmy\tDocker\tHub\taccount\tthroughout the\tbook.\tNow\tthat\twe\thave\tour\trepository\tready,\twe\tjust\thave\tto\tpush\tour image\tto\tthis\trepository.",
      "content_length": 177,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 131,
      "content": "How\tto\tdo\tit... 1.\t Before\tyou\tcan\tpush\tthe\timage\tto\tyour\tnewly\tcreated\tDocker\tHub\trepo,\n\nyou\thave\tto\tfirst\ttag\tthe\timage\tbecause\tyou\twill\tbe\tpushing\tit\tto\tyour\town repo\tand\tnot\tpackt.\tIn\tthis\tcase,\twe\twill\tbe\tpushing\tit\tto\tmy\taccount, vikrammurugesan.\tBut\tplease\tchange\tit\tto\tyour\taccount\tname\twherever\tyou see\tvikrammurugesan\tgoing\tforward.\tOpen\ta\tterminal\twindow\tand\tmake sure\tyou\thave\tdocker-machine\tstarted.\tIf\tnot,\tgo\tahead\tand\tstart\tit,\tand\tset the\tenvironment\tas\twell.\tExecute\tthe\tfollowing\tcommand\tin\tyour\tshell:\n\ndocker\ttag\tpackt/geolocation\tvikrammurugesan/geolocation\n\n2.\t To\tcheck\twhether\tyour\timage\twas\ttagged\twith\tthe\tnew\trepo\tname,\tissue\tthe docker\timages\tcommand\tand\tsee\twhether\tyou\tget\tsomething\tlike\tthis:\n\n3.\t As\tyou\tcan\tsee,\tthere\tis\ta\tnew\timage\tnow\twith\tthe\tnew\trepo\tname\twe\tjust created.\tIf\tyou\tlook\tat\tthe\timage\tIDs\tof\tthese\ttwo\timages,\tthey're\tthe\tsame. That\tis\tbecause\twe\tjust\ttagged\tthe\tpackt\timage\twith\tthe\tnew\trepository's account\tname\twithout\tany\tmodifications. Note\n\nTo\tlearn\tmore\tabout\tthe\tdocker\ttag\tcommand,\ttake\ta\tlook\tat\tits documentation:\thttps://docs.docker.com/engine/reference/commandline/tag/\n\n4.\t The\tnext\tstep\twill\tbe\tpushing\tthe\timage\tover\tto\tDocker\tHub.\tTo\tdo\tthat, execute\tthe\tfollowing\tcommand:\n\ndocker\tpush\tvikrammurugesan/geolocation\n\n5.\t You\twill\tsee\tthat\tin\torder\tto\tpush\tthe\timage\tto\tthe\trepo\tin\tmy\taccount, authentication\tis\trequired.\tThis\tis\tto\tmake\tsure\tanother\tuser\tis\tnot\tusing\tthe same\trepo.",
      "content_length": 1449,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 132,
      "content": "6.\t To\tauthenticate\tyourself,\tyou\tneed\tto\tuse\tthe\tdocker\tlogin\tcommand.\tUse the\tfollowing\tcommand\tto\tauthenticate\tyourself:\n\ndocker\tlogin\n\n7.\t After\tyou\texecute\tthe\tprevious\tcommand,\tDocker\twill\task\tyou\tto\tenter\tyour credentials.\tAfter\tsuccessful\tauthentication,\texecute\tthe\tsame\tdocker\tpush command\tagain.\tThis\ttime\tyou\twill\tsee\tthat\tyour\timage\tis\tbeing\tuploaded to\tDocker\tHub:\n\n8.\t This\tprocess\tusually\ttakes\tsome\ttime\tbecause\tit\tis\tuploading\ta\t656.6\tMB file\tto\tthe\tInternet.\tThe\ttime\ttaken\tdepends\ton\tthe\tspeed\tof\tyour connection.\tNow\tthat\tyour\timage\thas\tbeen\tsuccessfully\tuploaded\tto\tDocker Hub,\tlet's\tgo\tahead\tand\tverify\tthat\tyour\timage\tis\tavailable\ton\tit.\tGo\tto\tyour Docker\tHub\tpage\tfrom\tyour\tbrowser\tand\tnavigate\tto\tthe\tgeolocation\trepo. From\tthere,\tclick\ton\tthe\tTags\ttab\tand\tmake\tsure\tyou\tsee\ta\tnew\tentry\tfor\tthe latest\ttag:",
      "content_length": 832,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 133,
      "content": "This\tconfirms\tthat\tyour\timage\thas\tbeen\tsuccessfully\tpushed\tto\tDocker\tHub. Note\tthe\tsize\tof\tthe\timage:\tit\tis\tmuch\tsmaller\tthan\tthe\tactual\tsize\tof\tthe\timage. That\tis\tbecause\tDocker\tcompresses\tthe\timage\tbefore\tit\tuploads\tit\tto\tDocker Hub.\n\nThat's\tit!\tYou\thave\tsuccessfully\tcreated\tand\tuploaded\tyour\tmicroservice\timage to\tDocker\tHub.\tYour\timage\tcan\tnow\tbe\tpulled\tfrom\tany\tlocation.\n\nWhat\twe\thave\tseen\tso\tfar\tis\tjust\ta\tsimple\tapproach\tto\tdockerizing\tyour microservice\tand\tpushing\tit\tto\tDocker\tHub.\tIn\ta\treal-life\tscenario,\tyou\twill\tbe required\tto\tuse\tdifferent\tdocker\tcommands\tand\tdifferent\ttechniques.\tIt\tis strongly\trecommended\tthat\tyou\tgo\tthrough\tDocker's\tdocumentation\tto understand\teach\tand\tevery\tcommand\tand\ttheir\tadditional\toptions.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\tchapter.",
      "content_length": 778,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 134,
      "content": "Chapter\t3.\tDeploying\tMicroservices on\tMesos\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tdeploy\tmicroservices\ton\tMesos,\twhich\tis\tan open\tsource\tcluster\tmanagement\tframework\tfrom\tApache.\tWe\twill\tcover\tthe following\trecipes:\n\nSetting\tup\ta\tMesos\tcluster\tusing\tDocker Understanding\tthe\tMesos\tand\tMarathon\tinterface Deploying\tyour\tmicroservice\tto\tMesos\tusing\tMarathon Configuring\tports\tin\tMarathon Configuring\tvolumes\tin\tMarathon Configuring\tenvironment\tvariables\tin\tMarathon Scaling\tyour\tmicroservice\tin\tMarathon Destroying\tyour\tmicroservice\tin\tMarathon Monitoring\tyour\tmicroservice\tlogs\tin\tMarathon Monitoring\tyour\tmicroservice\tlogs\tin\tMesos Managing\tyour\tmicroservice\tusing\tMarathon's\tREST\tAPI",
      "content_length": 685,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 135,
      "content": "Introduction\n\nBefore\twe\tjump\tinto\tthe\trecipes\tand\ttry\tcreating\ta\tMesos\tcluster,\tit\tis\tvery important\tthat\tyou\tknow\twhat\tMesos\tis\tand\twhy\twe\tuse\tit\tto\tdeploy microservices.\n\nLet's\tanswer\tthe\tfirst\tquestion:\tWhat\tis\tMesos?\n\nMesos\tis\ta\tcluster\tmanagement\tframework\tthat\tmakes\tresource\tallocation\teasier in\torder\tto\trun\tdistributed\tapplications.\tIf\tyou\tbreak\tthis\tsentence\tdown,\tit\twill start\tmaking\tmore\tsense.\tMesos\tis\tcalled\ta\tcluster\tmanagement\tframework because\tit\tgroups\tmultiple\tmachines\tinto\tone\tsingle\tvirtual\tresource\tpool.\tLet's say\tyou\thave\t10\tmachines\twith\t4\tGB\tmemory,\t4\tcores\teach,\tand\t10\tGB\tdisk space.\tNow\tyou\twould\tlike\tto\tuse\tthese\tmachines\tto\tdo\tdifferent\tthings,\tsuch\tas the\tfollowing:\n\nRun\tSpark\tjobs Run\tlong\trunning\tservices Run\tCron\tjobs Run\tHadoop Run\tCassandra\n\nIn\tthis\tcase,\tyou\twould\tideally\thave\tto\tgo\tto\ta\twhiteboard\tand\tdraw\tout\tan architecture\tdiagram\tthat\tidentifies\twhat\tis\tgoing\tto\trun\ton\twhat\tmachine.\tYou will\thave\tmachines\tdedicated\tfor\ta\tsingle\tpurpose.\tA\tmachine\tdedicated\tto\trun Spark\tjobs\tmight\tnot\tbe\tused\tto\trun\tDocker\tcontainers\tunless\tyou\tgo\tand\tinstall Docker\ton\tthat\tmachine.\tSo\tas\tyou\tcan\tsee,\tthere\tis\tquite\ta\tbit\tof\twork\tinvolved in\torder\tto\tmaintain\tthis\tcluster.\tAt\tthe\tsame\ttime,\tthis\tsetup\tis\tnot\tfault\ttolerant. This\tis\texactly\twhat\tMesos\tsolves.\tIf\tyou\tinstall\tMesos\ton\tthose\t10\tmachines, you\twill\tget\ta\tcluster\twith\ttotal\tresources\tof\t40\tGB\tmemory,\t40\tcores,\tand\t100 GB\tdisk\tspace\t(keeping\tin\tmind\tthat\tone\tother\tmachine\tis\tused\tas\tthe\tmaster). With\tthat\tsaid,\tMesos\tmakes\tit\teasier\tto\trun\tany\ttype\tof\ttask\ton\tany\tof\tthese\t10 machines.\n\nNow\tlet's\tmove\ton\tto\tresource\tallocation.\tAs\tMesos\tgroups\tall\tthe\tresources from\tall\tthe\tmachines\t(slaves\tor\tagents\tin\tMesos\tterms)\tinto\tone\tsingle\tvirtual resource\tpool,\tallocation\tof\tresources\tis\tautomatically\ttaken\tcare\tof\tby\tMesos.",
      "content_length": 1827,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 136,
      "content": "For\texample,\tif\tyou\twould\tlike\tto\tspin\toff\ta\tSpark\tjob\tthat\tneeds\t2\tcores,\t2\tGB memory\tand\t1\tGB\tdisk\tspace,\tMesos\tautomatically\tmakes\ta\tdecision\ton\twhere this\tSpark\tjob\tis\tgoing\tto\tbe\tsubmitted\tbased\ton\tthe\tavailability\tof\tresources. This\tis\tone\tof\tthe\ttrue\twins\tof\tMesos\tcompared\tto\tother\tcluster\tmanagement frameworks.\n\nFinally,\tlet's\ttalk\tabout\trunning\tdistributed\tapplications.\tPart\tof\tthis\twas\tactually explained\tin\tthe\tprevious\tsection\tthat\ttalked\tabout\tSpark\tjob\tsubmissions.\tOne example\tof\thow\tMesos\thelps\trun\tdistributed\tapplications\tis\tthe\texecution\tmode of\tSpark\tjobs.\tIf\tyou\tare\trunning\tSpark\tjobs\ton\ta\tMesos\tcluster,\tyou\tcan\tchoose between\ttwo\tmodes:\tcoarse\tgrained\tand\tfine\tgrained.\tBoth\tof\tthese\tmodes\tdefine how\tthe\tcores\tare\tshared\tbetween\tmultiple\tSpark\ttasks.\tAs\tthe\tname\tsuggests, fine-grained\tmode\tis\tresponsible\tfor\tsharing\tthe\tcores\tat\ta\tmore\tgranular\tlevel. At\tthe\ttime\tof\twriting\tthis,\tfine-grained\tmode\thas\tbeen\tdeprecated\tby\tSpark\tand will\tsoon\tbe\tremoved.\n\nThe\tother\texample\tis\tbeing\table\tto\trun\tmultiple\tinstances\tof\tthe\tsame\tDocker image\tfrom\tMarathon.\tBy\tdoing\tso,\tyou\tare\tactually\tscaling\tyour\tapplication without\thaving\tto\tworry\tabout\twhere\tyour\tcontainer\tis\trunning.\tThis\twill\tbe covered\tin\tlater\trecipes\tin\tthis\tchapter.\tThese\tfeatures\tclearly\tdepict\thow\tMesos helps\tus\trun\tdistributed\tapplications.\n\nNow\tlet's\tanswer\tour\tsecond\tquestion:\tWhy\tMesos\tto\tdeploy\tmicroservices?\n\nWe\talready\tanswered\tthis\tquestion\tin\tthe\tprevious\tsection\ta\tlittle\tbit.\tLet's\tget into\tthe\tdetails\tnow.\tMesos\tbasically\tfollows\ta\tmaster-slave\tarchitecture,\twhere there\tcan\tbe\tone\tor\tmore\tmasters\tand\tmultiple\tslaves.\tAt\tany\tpoint\tof\ttime,\tonly one\tmaster\twill\tbe\tin\tcharge\t(also\tcalled\tthe\tleader).\tThe\tmaster's\tresponsibility is\tto\tcoordinate\tand\tdelegate\toffers\t(resource\trequests\tto\trun\ttasks)\tbetween\tthe framework\tschedulers\tand\tframework\texecutors.\tFrameworks\tin\tMesos\tare\tused to\trun\tany\tparticular\ttask\ton\ta\tMesos\tcluster.\tThese\ttasks\tcould\tbe\tSpark\tjobs, Cassandra\ttasks,\tDocker\tcontainers,\tand\tso\ton.\tThe\tframework\tthat\tis\tused\tto run\tlong-running\tjobs\tor\tDocker\tcontainers\tis\tcalled\tMarathon.\n\nIn\tthis\tchapter,\twe\twill\tbe\tlearning\textensively\tabout\tMarathon.\tAs\twe\talready have\tour\tapplication\tDockerized\tas\ta\tDocker\timage,\twe\twill\tuse\tMarathon\tand its\tabilities\tto\texpose\tour\tmicroservice.",
      "content_length": 2311,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 137,
      "content": "Setting\tup\ta\tMesos\tcluster\tusing Docker\n\nIn\tthis\trecipe,\twe\twill\tbe\tlearning\thow\tto\torchestrate\tour\tfirst\tMesos\tCluster with\tMarathon\tframework\tconfigured.\tWe\twill\tbe\torchestrating\tthis\tcluster\tin our\tlocal\tmachine\tusing\tDocker\tand\tDocker\tCompose.",
      "content_length": 247,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 138,
      "content": "Getting\tready\n\nNow\tthat\twe\tknow\twhat\tMesos\tis\tand\twhy\twe\tuse\tit\tto\tdeploy\tour\tmicroservice, let's\torchestrate\tour\tfirst\tMesos\tcluster.\tIn\torder\tto\tdo\tso,\twe\tfirst\tneed\tto understand\tthe\tbuilding\tblocks\tof\tMesos.\tMesos\tis\tmade\tof\tthe\tfollowing\tfour components:\n\nZookeeper Mesos\tmaster Mesos\tslaves\t(also\tcalled\tas\tagents) Mesos\tframeworks\n\nZookeeper\n\nZookeeper\tis\tan\topen\tsource\ttool\tfrom\tApache\tused\tfor\tcentralizing\tcluster information\tor\tother\tconfigurations.\tMesos\tuses\tZookeeper\tto\tstore\tits\tcluster information.\tOne\tuse\tof\tZookeeper\tin\tMesos\tis\tto\tstore\tinformation\tabout various\tmasters\tin\tthe\tMesos\tcluster.\tMesos\tclusters\tideally\thave\tmore\tthan\tone master\tto\tprovide\tfault\ttolerance;\tthis\tway,\tif\tone\tmaster\tgoes\tdown,\tanother master\ttakes\tcharge.\tAnother\tuse\tof\tZookeeper\tin\tMesos\tis\tto\tstore\tslave information\tto\tkeep\ttrack\tof\tthe\tslaves\tthat\tare\tpart\tof\tthe\tcluster.\tIn\tproduction scenarios,\tit\tis\talways\tideal\tto\thave\ta\tzookeeper\tcluster\tinstead\tof\tstandalone zookeeper\tinstances.\tThis\tmakes\tyour\tcluster\tmore\tfault\ttolerant\tand\tstable.\n\nMesos\tmasters\tand\tMesos\tslaves\n\nThe\tMesos\tmaster\tis\tusually\tresponsible\tfor\tcoordinating\tand\tdelegating\toffers to\tdeploy\ttasks\tto\tMesos\tslaves.\tMesos\tslaves\tideally\thave\tframework-specific executors,\twhich\ttell\tMesos\thow\tto\trun\ta\tspecific\ttask\ton\ta\tslave.\tSchedulers\tfor each\tframework\tare\tresponsible\tfor\tmaking\ta\tdecision\ton\twhether\tor\tnot\tto accept\tan\toffer.\tAn\toffer\tcould\tbe\tas\tsimple\tas\t\"run\tDocker\timage jenkins:latest\ton\tMarathon\twith\t1\tCore,\t2\tGB\tmemory,\tand\t10\tGB\tdisk space.\"\tAt\tthe\tsame\ttime,\tthe\tmaster\tis\talways\taware\tof\tthe\tresource\tavailability on\teach\tslave,\twhich\tis\talso\tsent\tto\tthe\tscheduler.\tAs\tsoon\tas\tthe\tmaster\tsends\tan offer\tover\tto\tthe\tscheduler,\tthe\tscheduler\ttakes\ta\tdecision\ton\twhether\tto\taccept the\toffer\tor\tdecline\tit\tbased\ton\tthe\tresource\tavailability\tand\toffer\trequest.\n\nMesos\tframeworks\n\nMesos\tframeworks\tare\tcomposed\tof\tthe\tScheduler\tand\tExecutor.\tWhile\tthe",
      "content_length": 1942,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 139,
      "content": "Mesos\tframeworks\tare\tcomposed\tof\tthe\tScheduler\tand\tExecutor.\tWhile\tthe Scheduler\tis\tresponsible\tfor\tmaking\toffer\tdecisions,\tthe\tExecutor\tis\tresponsible for\trunning\tthe\tactual\tframework\ttask.\tSome\tof\tthe\tmost\tcommonly\tused frameworks\tare:\n\nSpark Cassandra Aurora Marathon Chronos\n\nNote\n\nTo\tget\ta\tfull\tlist\tof\tframeworks,\tvisit http://mesos.apache.org/documentation/latest/frameworks/\t.\n\nThe\tfollowing\tdiagram\tdepicts\tthe\tworking\tof\ta\tMesos\tcluster\twith\tmultiple frameworks:\n\nIn\tthis\tcluster,\tthere\tare\ttwo\tor\tmore\tmasters,\tthree\tor\tmore\tslaves,\tand\tthree frameworks.\tThere\tis\talso\ta\tZookeeper\tquorum\twith\tthree\treplicated\tservers.\tA Zookeeper\tquorum\tis\ta\tset\tof\treplicated\tZookeeper\tservers\tthat\thave\tthe\tsame configuration.\tAs\tyou\tcan\tsee,\tthe\tZookeeper\tquorum\ttalks\tto\tthe\tmasters\tand slaves\tto\telect\tleaders\tfrom\tmasters\tand\tkeep\ttrack\tof\tslaves\tjoining\tthe\tcluster. Also,\tyou\tcan\tsee\thow\tone\tof\tthe\tmasters\tis\tmarked\tas\tLeader\tand\tis\tcurrently active,\tand\tthe\tother\tis\tgrayed\tout\tto\tindicate\tthat\tit\tis\tcurrently\tnot\telected\tas\tthe leader.\tThough\tthe\tframework\tscheduler\tis\tshown\tas\ta\tseparate\tcomponent,\tit\tis still\tpart\tof\ta\tframework.\tAs\twe've\tdiscussed\talready,\ta\tframework\tcontains\ta Scheduler\tand\tExecutor.\tFor\tsimplicity\tand\tunderstandability,\tthe\tscheduler\tand executor\tare\tshown\tas\tseparate\tcomponents.",
      "content_length": 1314,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 140,
      "content": "Note\n\nTo\tlearn\tmore\tabout\tthe\tMesos\tarchitecture,\ttake\ta\tlook\tat\tthis\tpage: http://mesos.apache.org/documentation/latest/architecture/\n\nNow\twe\tknow\tthat\twe\tneed\tZookeeper,\ta\tMesos\tmaster,\tMesos\tslaves,\tand framework\tto\torchestrate\ta\tminimal\tMesos\tcluster.\tIn\tthis\trecipe,\twe\twill\tbe using\tDocker\tto\trun\tour\tMesos\tcluster.\tThis\tmeans\tthat\tZookeeper,\tthe\tMesos master,\tMesos\tslave,\tand\tframework\twill\tbe\trunning\tas\tDocker\tcontainers\tin your\tlocal\tmachine.\tIn\torder\tto\tdo\tthis,\twe\twill\tuse\tDocker\tCompose.\tDocker Compose\tis\ta\tutility\tfrom\tDocker\tthat\thelps\tyou\trun\tmultiple\tcontainers\tusing\tits powerful\tdocker-compose\tcommand.\tTo\tkeep\tour\tcluster\tsimple\tand\treduce\tthe resource\tutilization\tof\tyour\tlocal\tmachine,\tthe\tcluster\twe\tare\tbuilding\twill consist\tof\tone\tZookeeper\tinstance,\tone\tMesos\tmaster,\tand\tone\tMesos\tslave.",
      "content_length": 817,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 141,
      "content": "How\tto\tdo\tit... 1.\t To\tcreate\tyour\tfirst\tdocker-compose\tfile,\topen\tyour\tSTS\tIDE\tand\tcreate\ta new\tfile\tcalled\tdocker-compose-mesos.yml\tin\tyour\tgeolocation\tproject. The\tfirst\tline\tof\tyour\tDocker\tCompose\tfile\tis\tusually\tthe\tversion\tof\tDocker Compose.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tversion2.\tSo\tadd\tthe\tfollowing line\tto\tyour\tDocker\tCompose\tfile:\tversion:\t\"2\"\n\nAt\tone\tpoint,\tDocker\tmade\ta\tchange\tto\thow\tthe\tservices\tare\tdescribed\tin the\tDocker\tCompose\tYAML\tfile.\tTo\tindicate\tthe\tdifference,\tthe\tversion property\twas\tadded\tas\tthe\tfirst\tline\tof\tthe\tYAML\tfiles.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tdifferences,\tread https://docs.docker.com/compose/compose-file/#/versioning\t.\n\n2.\t Now\tlet's\tstart\tdefining\tour\tservices.\tGo\tahead\tand\tadd\tthe\tfollowing services\tsection\tto\tyour\tYAML\tfile:\tservices:\n\nNote\n\nKeep\tin\tmind\tthat\tthis\tis\ta\tYAML\tfile,\tso\tmake\tsure\tyou\tuse\tblank\tspaces instead\tof\tusing\ttabs.\tThe\tindentation\tlevel\tused\tis\ttwo\tblank\tspaces.\n\n3.\t The\tnext\tsection\tin\tyour\tDocker\tCompose\tfile\tis\tto\tspin\tup\tZookeeper.\tAt the\ttime\tof\twriting\tthis,\tthere\tare\tno\tofficial\tZookeeper\timages\tavailable\ton Docker\tHub.\tSo\twe\twill\tbe\tusing\tmy\tZookeeper\timage\tin\tthis\trecipe.\tGo ahead\tand\tadd\tthe\tfollowing\tsnippet\tto\tdefine\tyour\tZookeeper\tinstance: zookeeper:\t\t\t\timage:\tvikrammurugesan/zookeeper\t\t\t\t\tnetwork_mode: host\n\nThere\tare\tthree\tthings\tto\tnote\there:\tThe\tfirst\tone\tis\tthe\tname\tof\tthe service\titself.\tIn\tthis\tcase,\twe\thave\tused\tZookeeper\tas\tour\tservice name.\n\nThe\tnext\timportant\tsection\tis\tthe\timage.\tThis\tsays\twhich\tDocker image\tshould\tbe\tused\tto\tspin\toff\tthis\tcontainer\t(or\tservice).\n\nThe\tlast\tone\tis\tvery\tinteresting.\tThe\tnetwork_mode\tcommand\tspecifies how\tto\tconfigure\tthe\tDocker\tnetwork\tfor\tthis\tcontainer.",
      "content_length": 1703,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 142,
      "content": "There\tare\tseveral\tmodes,\tsuch\tas\tcontainer,\thost,\tbridged,\tand\tnone. In\tthis\texample,\tfor\tsimplicity,\twe\twill\tuse\thost.\tThe\tnetwork\tmode host\tsays\tthat\twe\twill\tbe\tusing\tthe\thost\tnetwork\tstack\tinside\tthe container,\twhich\twill\texpose\tthe\tservice\tvia\t127.0.0.1.\n\nTo\tlearn\tmore\tabout\tDocker\tnetwork\tmodes,\ttake\ta\tlook\tat https://docs.docker.com/engine/userguide/networking/\t.\n\n4.\t Before\twe\tmove\ton\tto\tthe\tnext\tstep,\tlet's\ttry\tto\tvalidate\twhat\twe\thave\tdone so\tfar\tby\tstarting\tZookeeper\tusing\tdocker-compose.\tYour\tdocker- compose-mesos.yml\tfile\tshould\tlook\tsomething\tlike\tthis:\tversion:\t\"2\" services:\tzookeeper:\timage:\tvikrammurugesan/zookeeper network_mode:\thost\n\n5.\t Now\tgo\tto\tthe\tterminal\tand\tchange\tthe\tdirectory\tto\tthe\troot\tof\tthe geolocation\tproject,\twhere\tyou\thave\tcreated\tthe\tdocker-compose- mesos.yml\tfile.\tExecute\tthe\tfollowing\tcommand:\tdocker-compose\t-f docker-compose-mesos.yml\tup This\tcommand\tis\tused\tto\tbring\tup\tany\tservices\tin\tyour\tdocker-compose file.\tBy\tdefault,\tDocker\tCompose\tassumes\tthat\tthe\tname\tof\tthe\tDocker Compose\tfile\tis\tdocker-compose.yml.\tAs\twe\thave\tused\ta\tdifferent\tname, we\tare\tusing\tthe\t-f\toption\tto\tmention\tthe\tname\tof\tour\tCompose\tfile\tas docker-compose-mesos.yml.\n\n6.\t If\tyou\tget\terrors\tabout\tthe\tDocker\tmachine\tbeing\tdown,\tstart\tyour\tDocker machine\tinstance,\tset\tup\tthe\tenvironment,\tand\treissue\tthe\tsame\tcommand. You\twill\tnotice\tthat\tDocker\tdownloads\tthe\tZookeeper\timage\tfrom\tDocker Hub\tas\tit\tis\tnot\tavailable\tin\tyour\tDocker\thost.\tAfter\tthe\tdownload\tis complete,\tDocker\tCompose\twill\tstart\tyour\tZookeeper\tserver\tand\twill\tshow you\tthe\tlogs\tfrom\tthe\tcontainer:\n\nThe\tpreceding\ttwo\tlog\tmessages\tconfirm\tthat\tyour\tZookeeper\tinstance\tis\tup\tand running.\n\nBefore\tyou\tmove\ton\tto\tthe\tnext\tstep,\tstop\tand\tremove\tthe\tZookeeper",
      "content_length": 1742,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 143,
      "content": "container.\tYou\tcan\tstop\tthe\tcontainer\teither\tby\thitting\tCtrl\t\t+\t\tC\tin\tthe\tconsole or\tusing\tthe\tdocker\tstop\tcommand.\n\nNow\tlet's\tmove\ton\tand\tconfigure\tthe\tCompose\tfile\tto\tstart\tthe\tMesos\tmaster\n\nalong\twith\tZookeeper.\tAgain,\tat\tthe\ttime\tof\twriting\tthis,\tthere\tis\tno\tofficial image\tfor\tthe\tMesos\tmaster.\tSo\twe\twill\tbe\tpicking\tup\tan\timage\tfrom\tDocker Hub.\tIn\tthis\trecipe,\twe\twill\tuse\tthe\tmesos-master\timage\tfrom\tmesosphere. Mesosphere\tis\tthe\tcompany\tbehind\tthe\tpowerful\tcluster\tmanagement\t\"operating system\"\tcalled\tDC/OS.\tWe\twill\tlearn\tmore\tabout\tDC/OS\tin\tlater\tchapters. Go\tahead\tand\tadd\tthe\tfollowing\tsnippet\tto\tyour\tDocker\tCompose\tfile:\n\nmesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper\n\nAs\tyou\tcan\tsee,\twe\thave\tused\tthe\tmesos-master\timage\tfrom\tmesosphere,\tand the\tversion\tthat\twe\thave\tused\tis\t1.0.1-2.0.93.ubuntu1404.\tThis\tversion\tis\tthe latest\tstable\tversion\tat\tthe\ttime\tof\twriting\tthis\tbook.\tWe\talready\tknow\tabout network_mode.\n\nThe\ttwo\tnew\telements\tare\tenvironment\tand\tdepends_on.\tLet's\ttalk\tabout depends_on\tfirst\tas\tit\tis\tsimpler.\tThe\tdepends_on\telement\tsimply\tstates\tthat\tthe service\tthat\tis\tmarked\twith\tthe\tname\tzookeeper\tneeds\tto\tbe\tstarted\tbefore starting\tthis\tservice.\n\nNow\tlet's\ttalk\tabout\tenvironment.\tThe\tenvironment\telement\tis\tused\tto\tadd\n\nany\tenvironment\tvariables\tto\tthe\tcontainer.\n\nFor\texample,\tin\tthe\tprevious\tcase,\twe\tsee\ttwo\tvariables,\tMESOS_ZK\tand\n\nMESOS_HOSTNAME.\tMESOS_ZK\thas\tthe\tvalue\tzk://127.0.0.1:2181/mesos,\twhich specifies\thow\tto\tlook\tup\tMesos\tconfigs\ton\tZookeeper.\tAnd\tthe\tMESOS_HOSTNAME environment\tvariable\tis\tused\tto\tindicate\tthe\tIP\tor\thostname\tto\twhich\tthe\tMesos master\twill\tbe\tbound.\n\nIn\tour\tcase,\twe\thave\tused\tthe\tIP\tof\tour\tDocker\thost,\t192.168.99.100.\tIf\tyou are\tusing\ta\tdocker-machine\tinstance\twith\ta\tdifferent\tIP,\tuse\tthat\tIP\there.\tYour docker-compose-mesos.yml\tfile\twill\tlook\tlike\tthis:\tversion:\t\"2\"\tservices: zookeeper:\timage:\tvikrammurugesan/zookeeper\tnetwork_mode:\thost mesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper\n\nNow\tthat\twe\thave\tour\tZookeeper\tinstance\tand\tMesos\tmaster,\tlet's\tvalidate\tour\n\nwork\tso\tfar.\tTo\tdo\tso,\tstart\tyour\tservices\tusing\tthe\tdocker-compose\tcommand:",
      "content_length": 2402,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 144,
      "content": "docker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nAfter\tyou\texecute\tthe\tpreceding\tcommand,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nThese\tlogs\tare\tjust\ta\tportion\tof\tthe\tlogs\tthat\tyour\tcontainers\tshow,\tbut\tthey should\tlook\tsimilar.\tAs\tyou\tcan\tsee,\tlogs\tfrom\tdifferent\tcontainers\tare\tmarked with\ttheir\tname\tand\tare\tcolor-coded.\n\nNow\tlet's\tverify\tthat\tour\tMesos\tcluster\tis\tup\tand\trunning\tby\taccessing\tits\tweb interface.\tMesos'\tweb\tUI\tis\tvery\teasy\tto\tuse\tand\thas\tall\tthe\tinformation\tyou\twill need\tto\tknow\tabout\tyour\tcluster.\tThough\tyou\twill\tnot\tbe\tusing\tthis\tvery\toften,\tit is\tstill\ta\tgood\tidea\tto\ttake\ta\tlook\tat\tit.\tYou\tshould\tbe\table\tto\taccess\tthe\tMesos web\tUI\tusing\tthis\tURL:\thttp://192.168.99.100:5050.\t5050\tis\tthe\tdefault\tport used\tby\tMesos\tunless\tyou\tchange\tit\tvia\tconfig.\tYou\tshould\tsee\tsomething\tlike this:",
      "content_length": 803,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 145,
      "content": "On\tthe\tleft\thand\tside,\tyou\tcan\tsee\tthat\tthere\tare\tzero\tagent\tnodes\tavailable\t(an\n\nagent\tis\tthe\tsame\tthing\tas\ta\tslave\tor\tworker).\tThis\tis\tbecause\twe\thaven't\tadded any\tMesos\tslaves\tto\tthe\tcluster.\tAt\tthis\ttime,\tour\tcluster\tis\tnot\tuseful,\tas\tit\tdoes not\thave\tany\tslaves.\tBefore\tyou\tmove\ton\tto\tthe\tnext\tstep,\tstop\tand\tremove\tall containers\trunning\tin\tyour\thost.\tYou\talready\tknow\thow\tto\tstop\tthe\tcontainers. You\tcan\tremove\tthe\tcontainers\tby\trunning\tthe\tfollowing\tcommand:\tdocker\trm $(docker\tps\t-a\t-q)\n\nThe\tpreceding\tcommand\tcan\tbe\tbroken\tdown\tinto\ttwo\tparts.\tWe\tfirst\tlist\tdown all\tthe\tcontainers\tusing\tthe\tps\tcommand.\tWe\tpass\t-q\t(quiet\tmode)\targument\tto list\tonly\tthe\tcontainer\tIDs.\tThe\tcontainer\tIDs\tare\tthen\tpassed\tto\tthe\trm\tcommand for\tremoval.\n\nNow\tlet's\tadd\tour\tfirst\tMesos\tslave\tto\tthe\tcluster.\tIn\torder\tto\tdo\tthat,\tadd\tthe\n\nfollowing\tsnippet\tto\tthe\tDocker\tCompose\tfile:\tmesos_slave:\timage: mesosphere/mesos-slave:1.0.1-2.0.93.ubuntu1404\tnetwork_mode:\thost environment:\tMESOS_MASTER:\tzk://127.0.0.1:2181/mesos MESOS_WORK_DIR:\t/tmp\tMESOS_CONTAINERIZERS:\tdocker MESOS_HOSTNAME:\t192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\n\nThere\tare\ta\tfew\tthings\tto\tnote\there:\tfirst,\tthe\tname\tof\tthe\tservice.\tAs\tthe\tname",
      "content_length": 1332,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 146,
      "content": "indicates,\tthis\tservice\twill\tbe\tour\tmesos_slave.\tThe\timage\tis\tdifferent\tfrom\tthat of\tthe\tmaster\tby\tits\tname.\tThe\tversion\tis\texactly\tthe\tsame.\tAgain,\twe\tare\ttaking this\timage\tfrom\tmesosphere.\tThere\tare\tfour\tenvironment\tvariables.\tThe MESOS_MASTER\tenvironment\tvariable\ttells\tthe\tslave\thow\tto\tlook\tup\tthe\tMesos master\tconfig\tfrom\tZookeeper.\n\nIn\tthe\tprevious\tsnippet,\twe\thave\tused\tzk://127.0.0.1:2181/mesos.\tSee\thow 127.0.0.1\tis\tbeing\tused\tas\tthe\thostname\tfor\tZookeeper.\tMESOS_WORK_DIR\tis\tthe directory\ton\tthe\tslave\tthat\twill\tbe\tused\tfor\tstoring\tany\ttemp\tfiles\tor\tany\tother files\tcreated\tby\tthe\texecutor.\tWe\thave\tused\t/tmp\tfor\tthis.\tAs\tfor MESOS_CONTAINERIZERS,\tthough\tthe\tname\tmight\tbe\tpretty\tstraightforward,\tthere are\ta\tfew\tthings\tthat\tyou\tneed\tto\tknow\tabout\tit.\n\nNote\n\nTo\tknow\tmore\tabout\tthis\tproperty,\ttake\ta\tlook\tat\tthis\tpage: http://mesos.apache.org/documentation/latest/containerizer/\n\nIn\tour\texample,\twe\thave\tused\tjust\tdocker.\tThe\tMESOS_HOSTNAME\tenvironment\tis used\tto\tindicate\tthe\tIP\tor\thostname\tto\twhich\tthe\tslave\tshould\tbe\tbound.\tIn\tthe snippet,\twe\thave\tused\tthe\tIP\tof\tour\tdocker-machine\tinstance,\t192.168.99.100. If\tthe\tIP\tof\tyour\tdocker-machine\tinstance\tis\tdifferent,\tuse\tthat\tIP\there.\tThe MESOS_PORT\tenvironment\tvariable\tdefines\tthe\tport\twhere\tyour\tagent\tor\tslave\tis listening.\n\nThe\tvolumes\tsection\tis\tpretty\tinteresting.\tVolumes\tare\tused\tto\tmap\tmount paths\tand\tany\tnamed\tvolumes\tto\tany\tpath\ton\tthe\tDocker\thost.\tIn\tthe\tpreceding example,\twe\thave\tthree\tdifferent\tmappings.\tThese\tmappings\tare\trequired\tto\trun a\tDocker\tcontainer\tinside\tthe\tslave,\twhich\tis\tagain\ta\tDocker\tcontainer.\tThe mappings\tto\tthe\tdocker.sock\tfile\t(varrun/docker.sock)\tand\tthe\tDocker\tbinary (usrbin/docker)\tare\tused\tto\tmake\tthis\thappen.\tThe\tcgroup\tmapping (/sys/fs/cgroup)\tis\trequired\tby\tMesos\titself.\tFinally,\tthe\tdepends_on\tsection\tis something\twe\tsaw\tearlier.\n\nYour\tdocker-compose-mesos.yml\tfile\twill\tlook\tlike\tthis:\tversion:\t\"2\"\tservices: zookeeper:\timage:\tvikrammurugesan/zookeeper\tnetwork_mode:\thost mesos_master:\timage:\tmesosphere/mesos-master:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_ZK:\tzk://127.0.0.1:2181/mesos MESOS_HOSTNAME:\t192.168.99.100\tdepends_on:\t-\tzookeeper",
      "content_length": 2176,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 147,
      "content": "mesos_slave_one:\timage:\tmesosphere/mesos-slave:1.0.1-2.0.93.ubuntu1404 network_mode:\thost\tenvironment:\tMESOS_MASTER: zk://127.0.0.1:2181/mesos\tMESOS_WORK_DIR:\t/tmp MESOS_CONTAINERIZERS:\tdocker\tMESOS_HOSTNAME: 192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\n\nNow\tlet's\tcheck\twhether\twe\tcan\tsee\tour\tnew\tslave\tdetected\tby\tMesos.\tTo\tdo so,\tissue\tthe\tdocker\tcompose\tup\tcommand\ton\tyour\tconsole:\tdocker-compose\t-f docker-compose-mesos.yml\tup\n\nThis\ttime,\tyou\tshould\tsee\tsome\tadditional\tlog\tmessages\tfrom\tthe\tMesos\tslave container:\n\nNow\tthat\tour\tMesos\tcluster\tis\trunning,\taccess\tthe\tweb\tUI\tfrom\ta\tbrowser\tusing the\tURL\thttp://192.168.99.100:5050:",
      "content_length": 762,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 148,
      "content": "As\tyou\tcan\tsee,\tnow\tthere\tis\tone\tnew\tslave\t(or\tagent)\tthat\tis\tactivated.\tYou\n\ncan\talso\tsee\tthat\tthe\tResources\tsection\treflects\tthe\tamount\tof\tresources available\tfor\tthis\tcluster.\tThe\tamount\tof\tresources\tdepends\ton\tthe\tsize\tof\tour Docker\thost.\tIf\tyou\twould\tlike\tto\tincrease\tthe\tresources\tallocated\tto\tyour\tDocker host,\tyou\thave\tto\trecreate\tyour\tVM\twith\tmore\tresources\tusing\tthe\tdocker- machine\tcreate\tcommand.\n\nTip\n\nIf\tyou\twant\tanother\tslave,\tfeel\tfree\tto\tcopy\tthe\tmesos_slave\tsection\tand\tpaste\tit in\tthe\tDocker\tCompose\tfile\tagain\twith\ta\tdifferent\tMESOS_PORT\tnumber.\tAt\tthe same\ttime,\tyou\twill\thave\tto\tchange\tthe\tservice\tname.\n\nWith\tthat\tsaid,\tcan\twe\tsay\tthat\twe\tnow\thave\ta\tfully\tfunctional\tcluster?\tMaybe. That\tis\tbecause\twe\tstill\tdo\tnot\thave\ta\tframework\tinstalled.\tAs\twe\twill\tbe\tusing this\tMesos\tcluster\tto\tdeploy\tour\tDockerized\tmicroservice,\twe\twill\tbe\tinstalling the\tMarathon\tframework\ton\tthis\tcluster.\n\nTo\tregister\tthe\tMarathon\tframework,\tadd\tthe\tfollowing\tsnippet\tto\tyour\tDocker\n\nCompose\tfile:\tmarathon:\timage:\tmesosphere/marathon:v1.1.2 network_mode:\thost\tenvironment:\tMARATHON_MASTER: zk://127.0.0.1:2181/mesos\tdepends_on:\t-\tzookeeper\n\nThe\timage\tthat\twe\thave\tused\tis\tagain\tfrom\tmesosphere,\tand\tthe\tname\tof\tthe",
      "content_length": 1216,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 149,
      "content": "image\tis\tmarathon.\tSee\tthat\twe\thave\tused\ta\tversion\tdifferent\tthan\tthat\tof\tthe Mesos\tmaster\tand\tslave.\tThis\tis\tbecause\tthe\tframeworks\tare\tnot\ttied\tto\tany\tone version\tof\tmaster\tor\tslave\timages.\tThe\tonly\tenvironment\tvariable\tthat\tis\tused\tis MARATHON_MASTER,\twhich\tis\tset\tto\tzk://127.0.0.1:2181/mesos,\tspecifying\thow to\tlook\tup\tthe\tMesos\tconfigs\ton\tZookeeper.\tFinally,\tthis\tservice\tdepends\ton\tthe Zookeeper\tservice.\n\nYour\tfinal\tdocker-compose-mesos.yml\tfile\twill\tlook\tsomething\tlike\tthis: version:\t\"2\"\tservices:\tzookeeper:\timage:\tvikrammurugesan/zookeeper network_mode:\thost\tmesos_master:\timage:\tmesosphere/mesos-master:1.0.1- 2.0.93.ubuntu1404\tnetwork_mode:\thost\tenvironment:\tMESOS_ZK: zk://127.0.0.1:2181/mesos\tMESOS_HOSTNAME:\t192.168.99.100 depends_on:\t-\tzookeeper\tmesos_slave_one:\timage:\tmesosphere/mesos- slave:1.0.1-2.0.93.ubuntu1404\tnetwork_mode:\thost\tenvironment: MESOS_MASTER:\tzk://127.0.0.1:2181/mesos\tMESOS_WORK_DIR:\t/tmp MESOS_CONTAINERIZERS:\tdocker\tMESOS_HOSTNAME: 192.168.99.100\tMESOS_PORT:\t5051\tvolumes:\t- /sys/fs/cgroup:/sys/fs/cgroup\t-\tvarrun/docker.sock:varrun/docker.sock\t- usrlocal/bin/docker:usrbin/docker\tdepends_on:\t-\tzookeeper\tmarathon: image:\tmesosphere/marathon:v1.1.2\tnetwork_mode:\thost\tenvironment: MARATHON_MASTER:\tzk://127.0.0.1:2181/mesos\tdepends_on:\t- zookeeper\n\nWith\tthat\tsaid,\twe\tare\tnow\tready\tto\tvalidate\twhether\twe\thave\tMarathon\n\ninstalled\ton\tour\tcluster.\tStop\tand\tremove\tany\tcontainers\tthat\tare\talready\trunning. Now\texecute\tthe\tfollowing\tcommand\ton\tyour\tconsole\tto\tstart\tthe\tMesos\tcluster: docker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nThis\ttime,\tyou\twill\tsee\tsome\tadditional\tlogs\tfrom\tMarathon:",
      "content_length": 1629,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 150,
      "content": "Now\tlet's\tverify\twhether\tMarathon\tis\tregistered\tas\ta\tMesos\tframework\ton\tour cluster.\tTo\tdo\tthat,\topen\tthe\tMesos\tweb\tUI\tfrom\tyour\tbrowser\tand\tclick\ton\tthe Frameworks\ttab.\tYou\tshould\tnow\tsee\ta\tnew\tentry\tin\tthe\tActive\tFrameworks grid\tfor\tMarathon.\tYou\tcan\tsee\tthe\tname\tof\tthe\tframework\tin\tthe\tName\tcolumn:\n\nThat's\tit!\tYou\thave\tsuccessfully\tcreated\tyour\tfirst\tMesos\tcluster\tusing\tDocker. Now,\tit\tis\ttime\tto\tplay\twith\tthis\tcluster\tby\tspinning\toff\tsome\tMarathon\ttasks.",
      "content_length": 462,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 151,
      "content": "Understanding\tthe\tMesos\tand Marathon\tinterface\n\nNow\tthat\twe\thave\ta\tfully\tfunctional\tMesos\tcluster\twith\tthe\tMarathon framework,\twe\tare\tready\tto\tspin\toff\tnew\ttasks\t(or\tDocker\tcontainers)\tto Marathon.\tBefore\twe\tdo\tthat,\tit\tis\thighly\timportant\tthat\twe\tunderstand\tthe Mesos\tand\tMarathon\tweb\tinterface.",
      "content_length": 296,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 152,
      "content": "Getting\tready\n\nWe\talready\tknow\tthat\tthe\tMesos\tweb\tUI\tis\tlocated\tat\tport\t5050.\tTo\taccess\tthe web\tUI,\topen\thttp://192.168.99.100:5050\tin\ta\tweb\tbrowser.\tSimilarly, Marathon\thas\ta\tsophisticated\tweb\tinterface\tlocated\tat\tport\t8080.\tTo\taccess\tthe Marathon\tweb\tUI,\topen\thttp://192.168.99.100:8080\tin\tanother\ttab\tof\tyour web\tbrowser.",
      "content_length": 324,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 153,
      "content": "How\tto\tdo\tit...\n\nFirst,\tlet's\ttry\tto\tget\tfamiliar\twith\tthe\tMesos\tinterface.\n\nThe\tMesos\tinterface\n\nThere\tare\tfour\ttabs\tin\tthe\tMesos\tweb\tUI.\tLet's\tgo\tone\tby\tone.\tThe\tfirst\tone\tis\tthe Mesos\thome\tpage.\n\nThe\tMesos\thome\tpage\n\nThis\tis\twhere\tyou\tactually\tget\tto\tsee\tmost\tof\tthe\tinformation\tabout\tyour\ttasks. Let's\tstart\twith\tthe\tleft-hand\tside\tmenu\tpane.\tThe\tfirst\tsection\tof\tthe\tpane\tis\tthe cluster\tinformation.\tIt\thas\tinformation\tsuch\tas\tcluster\tname,\tmaster\tURL, version,\twhen\tthis\tversion\twas\tbuilt,\twhen\tthis\tmaster\twas\tstarted,\tand\twhen\tthis master\twas\telected\tas\tleader.\tThese\tare\tthe\toptions\tthat\tare\tavailable\tin\tthis particular\tversion\tof\tMesos.\tThis\tlist\tis\tprone\tto\tchange\tif\tyou\tuse\tany\tother version\tof\tMesos.\tIt\twill\tlook\tsomething\tlike\tthis:\n\nThe\tcluster\tname\tis\t(Unnamed)\tbecause\twe\tdid\tnot\tpass\tthe\tMESOS_CLUSTER environment\tvariable\tto\tthe\tmaster.\tIf\twe\thad\tset\tthat\tenvironment\tvariable\tin the\tDocker\tCompose\tfile\tfor\tthe\tmaster,\tthen\tthat\tcluster\tname\twould\thave\tbeen displayed\there.\tIn\tproduction\tsystems,\tthis\tis\tvery\timportant\twhen\tyou\thave",
      "content_length": 1056,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 154,
      "content": "multiple\tmasters.\tWe\thave\tnot\tdone\tthat\tin\torder\tto\tmake\tthe\tcluster configuration\tsimple.\n\nRight\tfollowing\tthe\tCluster\tsection,\tyou\twill\tsee\ta\thyperlink\tcalled\tLOG.\tThis\tis used\tto\tlook\tat\tthe\tlogs\tof\tthe\tmaster.\tIf\tyou\tclick\ton\tthis,\tyou\twill\tsee\tthe following\terror:\n\nThis\tis\tbecause\twe\thave\tnot\tset\tthe\tconfig\tproperty\tthat\tspecifies\twhere\twe would\tlike\tthe\tlog\tfiles\tto\tbe\tcreated.\n\nTo\tconfigure\tthat,\twe\thave\tto\tset\tthe\tMESOS_LOG_DIR\tenvironment\tvariable\tin\tthe Docker\tCompose\tfile\tfor\tthe\tMesos\tmaster.\n\nAgents\n\nThe\tnext\tsection\tis\tAgents.\tMesos\tstarted\tadopting\tthe\tterm\t\"agents\"\tfor\tslaves recently.\tWherever\tyou\tsee\tthe\tterm\tagents\thenceforth,\tkeep\tin\tmind\tthat\tthey are\tsynonymous\twith\tslaves.\tThis\tsection\tis\twhere\tyou\twill\tsee\tthe\tnumber\tof slaves\tthat\tare\tactivated\tand\tthe\tnumber\tof\tslaves\tthat\tare\tdeactivated.\tIt\twill look\tsomething\tlike\tthis:",
      "content_length": 860,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 155,
      "content": "Tasks\n\nThis\tnext\tsection,\tTasks,\tshows\tthe\tnumber\tof\ttasks\tgrouped\tby\ttheir\tstatuses\ton all\tslaves.\tMesos\thas\tbeen\tadding\tnew\tstatuses\trecently\tto\tprovide\ta\tmore granular\tunderstanding\tof\twhere\teach\ttask\tis.\tAt\tthe\ttime\tof\twriting\tthis,\tthere are\tnine\tstatuses:\tStaging,\tStarting,\tRunning,\tKilling,\tFinished,\tKilled, Failed,\tLost,\tOrphan.\tIn\tyour\tMesos\tweb\tUI,\tthis\tlooks\tsomething\tlike\tthe following:",
      "content_length": 401,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 156,
      "content": "Resources\n\nThe\tnext\tsection\tis\tthe\tResources\tsection,\twhich\tshows\tthe\tresource\tutilization by\ttask\tand\tresource\tavailability\tin\tthe\tslaves.\tResources\tinclude\tCPUs,\tGPUs, memory,\tand\tdisk\tspace.\tLet's\ttalk\tabout\tgraphics\tprocessing\tunit\t(GPU)\tas\tit is\tnew\tto\tthis\tlist.\tNow\tthat\tMesos\tis\tbeing\tused\tfor\tmore\tadvanced\tuse\tcases such\tas\tgraphics\tand\tvideo\tprocessing,\tMesos\tand\tNvidia\thave\tcome\ttogether\tto include\tGPUs\tin\tMesos.\tThis\tsection\twill\tlook\tsomething\tlike\tthis:",
      "content_length": 470,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 157,
      "content": "As\tyou\tcan\tsee\tin\tthe\tpreceding\tpicture,\tnone\tof\tthe\tresources\tare\tbeing\tused\tor offered\tbecause\twe\thave\tnot\trun\tany\ttasks\ton\tthe\tcluster\tyet.\tMoving\ton\tto\tthe main\tsection\tof\tthe\thome\tpage\tis\tthe\tTasks\tbreakout.\tBy\tdefault,\tyou\thave\tthree grids:\tActive\tTasks,\tCompleted\tTasks,\tand\tOrphan\tTasks.\n\nTask\ttypes\n\nActive\ttasks\tare\ttasks\tthat\tare\tcurrently\texecuting.\tCompleted\ttasks\tare\ttasks\tthat have\tfinished\texecution\t(either\tcompleted\tsuccessfully\tor\tfailed\tor\tkilled). Orphan\ttasks\tare\ttasks\tthat\tare\torphaned\tafter\ta\tmaster\tfailure\twhen\tthe framework\tfails\tto\treregister.\tAs\twe\tdo\tnot\thave\tany\ttasks\tnow,\tthis\tsection\tis empty.\tBut\tideally,\tyou\twill\tsee\tthat\tfor\teach\ttask,\tthere\tis\ta\tnew\tentry\tin\tone\tof these\tgrids:",
      "content_length": 719,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 158,
      "content": "Frameworks\n\nThe\tsecond\ttab\tis\tthe\tFrameworks\ttab.\tThe\tFrameworks\ttab\tmainly\tshows\tthe list\tof\tactive,\tcompleted,\tand\tinactive\tframeworks\tin\tthe\tcluster.\tThe\tframeworks can\tbe\tanything,\tsuch\tas\tSpark,\tCassandra,\tAurora,\tMarathon,\tand\tChronos:\n\nAgents\n\nThe\tAgents\ttab\tusually\tdisplays\tthe\tlist\tof\tall\tslaves\tregistered\tin\tthe\tcluster.\tIn our\tcluster,\twe\thave\tonly\tone\tslave\tregistered.\tYou\tshould\tsee\tsomething\tlike this:",
      "content_length": 419,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 159,
      "content": "Offers\n\nThe\tlast\ttab\tis\tthe\tOffers\ttab,\twhich\tlists\tdown\tall\tthe\toffers\tthat\tare\tcurrently open\tfor\ta\tslave\tto\tbe\tpicked\tup:\n\nThat's\tpretty\tmuch\teverything\ton\tthe\tMesos\tweb\tinterface.\tThough\tyou\twill\tnot be\tusing\tthis\tinterface\ta\tlot,\tit\tis\tstill\ta\tgood\tidea\tto\tbecome\tfamiliar\twith\tthis interface\tso\tthat\tyou\tcan\tuse\tit\tfor\tdebugging.\tDebugging\tsituations\tcan\thappen when\tone\tof\tyour\ttasks\tkeeps\trestarting\tor\twhen\tyou\twould\tlike\tto\tknow whether\tyou\thave\tenough\tresources\tto\tspin\toff\tmore\ttasks.\n\nThe\tMarathon\tweb\tUI\n\nNow\tlet's\topen\tup\tthe\tMarathon\tweb\tUI\tand\tunderstand\tthe\tmain\tscreen.\tAs\twe still\thaven't\tlearned\thow\tto\tdeploy\tDocker\tcontainers\tin\tMarathon,\twe\twill\tjust understand\tthe\tbasic\tsections\tof\tthe\tMarathon\tweb\tUI.\tWe\twill\tlearn\tabout\tthe other\tscreens\tas\twe\tdeploy\tour\tapplication.\n\nOpen\tthe\ttab\tthat\tyou\talready\thad\tfor\tMarathon.\tIf\tyou\tclosed\tit\tby\tmistake,\tuse this\tURL\tto\topen\tit:\thttp://192.168.99.100:8080:",
      "content_length": 927,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 160,
      "content": "As\tyou\tcan\tsee,\tit\tis\ta\tvery\tsimple\tinterface\twith\tsome\tuseful\tfilters\ton\tthe\tleft- hand\tside\tmenu.\tThe\tfilters\tare\tbased\tmainly\ton\tthe\tstatus,\thealth,\tand\tvolumes. The\tCreate\tApplication\tbutton\tis\tused\tto\tdeploy\tyour\tDocker\tcontainer\ton\tthe Mesos\tcluster\tusing\tMarathon.\tRight\tnow,\twe\tdo\tnot\thave\tany\tnew\tapplications already\tdeployed.\tIf\twe\thad\tone,\tit\twould\tbe\tdisplayed\tin\tthe\tApplications section\tof\tthe\tpage.\tYou\tcan\talso\tcreate\tgroups\tto\tgroup\tyour\tapplications.\n\nWith\tthat\tsaid,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tWe\twill\tget\tto\tplay\twith\tthe Marathon\tinterface\tin\tthe\trest\tof\tthis\tchapter.",
      "content_length": 598,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 161,
      "content": "Deploying\tyour\tmicroservice\tto Mesos\tusing\tMarathon\n\nNow\tthat\twe\thave\ta\tfully\tfunctional\tMesos\tcluster\twith\tthe\tMarathon framework,\twe\tare\tready\tto\tspin\toff\tnew\ttasks\t(or\tDocker\tcontainers)\ton Marathon.\tIn\tthis\trecipe,\twe\twill\tdeploy\tour\tDockerized\tgeolocation microservice\ton\tMarathon.",
      "content_length": 286,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 162,
      "content": "Getting\tready\n\nBefore\tyou\tstart,\tmake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tYou\tcan\tdo this\tby\texecuting\tthe\tdocker\tps\t-a\tcommand.\tYou\tshould\tsee\tfour\tcontainers running:\tMesos\tmaster,\tMesos\tslave,\tMarathon,\tand\tZookeeper:\n\nSometimes,\tit\tis\tpossible\tthat\teither\tthe\tMesos\tmaster\tor\tslave,\tor\teven\tthe Marathon\tcontainer,\tmight\tgo\tdown.\tThis\tusually\thappens\twhen\tit\truns\tout\tof resources\tor\tprobably\twhen\tyou\trestart\tyour\tcomputer\tand\tthey\ttry\tto\tcome\tback up,\tbut\tthey\tmight\tnot\tbe\table\tto\torchestrate\tproperly.\tIn\tthose\tcases,\tmake\tsure you\tstop\tthe\twhole\tcluster\tand\tperform\ta\tclean\tstart.\tYou\tcan\tdo\tthat\tby\trunning the\tfollowing\tcommand:\tdocker\tstop\t$(docker\tps\t-a\t-q)\t&&\tdocker\trm $(docker\tps\t-a\t-q)\t&&\tdocker-compose\t-f\tdocker-compose-mesos.yml\tup\n\nThe\tcommand\tuses\t&&\tto\tcombine\tthree\tdifferent\tcommands.\tThe\tfirst\tone\tis used\tto\tstop\tall\trunning\tand\tstopped\tcontainers.\tThe\tsecond\tone\tremoves\tall\tthe containers\tthat\twere\tstopped\tby\tthe\tprevious\tcommand\t(including\tthe\tones\tthat were\tpreviously\tstopped,\tif\tany),\tand\tthe\tthird\tcommand\tstarts\tthe\tcluster\tback up.\n\nNow\tthat\tyour\tcluster\tis\tup\tand\trunning,\topen\ta\tbrowser\tand\tnavigate\tto\tthe Marathon\tweb\tinterface\tat\thttp://192.168.99.100:8080.",
      "content_length": 1206,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 163,
      "content": "How\tto\tdo\tit... 1.\t Let's\tstart\tby\tunderstanding\tthe\tMarathon\tinterface.\tMarathon's\tuser\n\ninterface\thas\timproved\ta\tlot\tlately\tand\tis\tvery\teasy\tto\tuse.\tClick\ton\tthe Create\tApplication\tbutton.\tYou\tshould\tsee\ta\tmodal\tsimilar\tto\tthis:\n\nAs\tyou\tcan\tsee,\tthere\tare\tseveral\tsections\ton\tthe\tleft-hand\tside,\tsuch\tas\tGeneral, Docker\tContainer,\tPorts,\tEnvironmentVariables,\tLabels,\tHealth\tChecks, and\tVolumes.\n\nLet's\tstart\twith\tthe\tGeneral\tsection.\tThe\tfirst\tfield\tthat\tis\trequired\tin\tthis section\tis\tthe\tID\tfield.\tThe\tvalue\tof\tID\tuniquely\tidentifies\tthe\tapplication\tin Marathon.\tIn\tour\tcase,\tas\twe\tare\tdeploying\tthe\tgeolocation\tapplication,\twe\tcan",
      "content_length": 636,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 164,
      "content": "probably\tuse\tgeolocation\tas\tthe\tID\tof\tour\tapplication.\tThe\tother\tfields\tin\tthis modal\tthat\twe\tshould\tcare\tabout\tnow\tare\tCPUs,\tMemory,\tand\tDisk\tSpace. The\tdefault\tCPU\tvalue\tof\t1\tshould\tbe\tmore\tthan\tenough\tfor\tour application.\tMesos'\tCPUs\tparameter\tis\ta\tlittle\ttricky\tto\tunderstand.\tYou\tcan even\tassign\tvalues\tsuch\tas\t0.1\tor\t0.25\tto\tthe\tCPUs\tfield.\tIt\tmainly\thelps you\tidentify\thow\tmany\tresources\tare\tleft\tin\tyour\tcluster\trather\tthan\tlimiting access\tto\tthe\tCPU\titself.\tEven\tthough\tyou\tset\tthe\tvalue\tof\tCPUs\tto\t1,\tyour application\twill\thave\taccess\tto\tall\tthe\tother\tCPUs\tin\tyour\tslave. The\tMemory\tfield\tis\tset\tat\t128\tMB\tby\tdefault.\tFor\tour\tapplication,\twe could\tgo\ta\tlittle\thigher\tand\tassign\tit\t512\tMB.\tIn\tproduction\tscenarios,\t512 MB\tmight\tnot\tbe\tsufficient,\tand\tyou\tmight\thave\tto\tgo\twith\ta\tminimum\tof\t4 GB\tof\tmemory\tbased\ton\tyour\tapplication's\tusage.\tIf,\tfor\tsome\treason,\tyou are\tforced\tto\tallocate\tmore\tthan\t4\tGB\tof\tmemory\tfor\ta\tsimilar\tapplication, it\tis\ta\tsignal\tthat\tthere\tcould\teither\tbe\tan\tarchitectural\trefactor\tthat\tcould reduce\tyour\tmemory\tallocation,\tor\tyour\tapplication\tis\tbecoming\tmore monolithic,\tthereby\tdefeating\tthe\tpurpose\tof\tbuilding\ta\tmicroservice.\tHere, the\t4\tGB\tlimit\twas\tpicked\tas\tan\texample\tthat\tis\tused\tfor\tthe\tgeolocation application,\tbut\tthe\tpoint\tis\tto\tmake\tsure\tyou\tdon't\tbuild\tan\tapplication\tthat is\tmonolithic\tor\tfollows\tbad\tarchitectural\tdesign. The\tDisk\tSpace\tfield\tis\talso\treally\timportant\twhen\tyou\tcreate\ta\tnew application\tin\tMarathon.\tThough\tit\tmight\tnot\tmatter\ta\tlot\tin\tour\tcase,\tit becomes\tsuper\timportant\twhen\tyou\tare\tdeploying\ta\tcontainer\tthat\tstores information\tin\tthe\tfilesystem.\tFor\texample,\tif\tyou\tare\trunning\tKafka\tor\ta database\tas\ta\tcontainer,\tyou\tdefinitely\tdon't\twant\tto\tallocate\tit\t1\tGB\tof\tdisk space.\tIt\tis\tdefinitely\tgoing\tto\trun\tout\tof\tdisk\tspace\tsooner\tor\tlater.\tFor\tthe geolocation\tapplication,\tas\tit\tis\tnot\tgoing\tto\twrite\tanything\tto\tthe filesystem,\tlet's\tallocate\tit\t1\tGB\tof\tdisk\tspace.\n\nTo\tsummarize,\tthese\tare\tthe\tfields\tand\ttheir\trespective\tvalues:\n\nID:\tgeolocation CPUs:\t1 Memory:\t512 Disk\tSpace:\t1024 Instances:\t1 Command:\tLeave\tthis\tfield\tempty\n\nNow,\tlet's\tmove\ton\tto\tthe\timportant\tsection:\tthe\tDocker\tcontainer\tsection.\tThe Docker\tcontainer\tsection\tis\twhere\twe\tget\tto\tprovide\tthe\tcontainer\tinformation\tto Marathon.\tThere\tare\tfive\timportant\tfields\tin\tthis\tsection:",
      "content_length": 2323,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 165,
      "content": "The\tImage\tfield\ttells\tMarathon,\tthe\tname\tand\ttag\tof\tthe\tDocker\timage\tthat it\thas\tto\tpull\tfrom\tDocker\tHub.\tBy\tdefault,\tMarathon\ttries\tto\tpull\tthe\timage from\tthe\tpublic\tDocker\tHub.\tBut\tif\tyou\thave\tyour\town\tprivate\tDocker Hub,\tyou\thave\tto\tmake\ta\tfew\tchanges\tto\tyour\tdeployment\tto\tinstruct Marathon\tto\tauthenticate\tand\tget\tthe\timage\tfrom\tyour\tprivate\trepository.\tIn our\tcase,\twe\twill\tuse\tthe\tpublic\trepository,\tand\tthe\tname\tof\tour\timage\tis vikrammurugesan/geolocation.\tPlease\tkeep\tin\tmind\tthat\tthis\tis\tmy Docker\tHub\taccount,\tand\tyou\tshould\tbe\tusing\tthe\timage\tin\tyour\taccount. We\tdon't\thave\tto\tprovide\tthe\tlatest\ttag\tas\tMarathon\tuses\tit\tas\tthe\tdefault tag\tif\tyou\tdon't\tprovide\tone. The\tNetwork\tmode\tcan\teither\tbe\tBridged\tor\tHost.\tFor\tnow,\twe\twill\tuse Bridged\tmode.\tWe\twill\tlearn\tmore\tabout\tthe\tbridged\tnetworking\tmode\tin later\trecipes\tin\tthis\tchapter.\tThe\tForce\tpull\timage\ton\tevery\tlaunch\toption is\tpretty\tself-explanatory.\tYou\tdon't\thave\tto\tcheck\tthis\toption.\tThe\tExtend runtime\tprivileges\toption\tlets\tyou\trun\tthe\tcontainer\tin\tprivileged\tmode. You\tcan\tuse\tthis\toption\tif\tyou\tare\tgoing\tto\trun\tDocker\tinside\tthis\tDocker container.\tFor\tnow,\twe\twill\tnot\tneed\tit.\n\nNote\n\nFor\tmore\tinformation\ton\tprivileged\tcontainers,\ttake\ta\tlook\tat\tthis\tpage: https://docs.docker.com/engine/reference/run/#/runtime-privilege-and- linux-capabilities\n\nThe\tParameters\tare\tnothing\tbut\tDocker\tenvironment\tvariables.\tIf your\tapplication\tneeds\tenvironment\tvariables,\tyou\tcan\tlist\tthem\there. For\tnow,\tthe\tconfigurations\twe\thave\tdone\tso\tfar\twill\tlet\tus\tstart\tthe application\ton\tMarathon.\tWe\twill\tlook\tat\tother\tsections\tin\tlater\trecipes in\tthis\tchapter.\tWith\tthat\tsaid,\tthe\tDocker\tContainer\tsection\tshould look\tsomething\tlike\tthis:",
      "content_length": 1696,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 166,
      "content": "Now\tthat\tyou\thave\teverything\tset\tup\tright,\tclick\ton\tthe\tCreate\tApplication button.\tYou\tshould\tsee\tthat\tMarathon\tis\ttrying\tto\tdeploy\tour\tmicroservice.\tYou can\tconfirm\tthis\tby\tlooking\tat\tthe\tstatus\tof\tyour\tapplication.\tIt\tshould\tshow\tup as\tDeploying.\tDuring\tthis\tstep,\tthe\tslave\twill\ttry\tto\tpull\tthe\timage\tfrom\tDocker Hub\tand\tstart\tthe\tcontainer\twith\tthe\tconfigurations\twe\tprovided\tin\tthe\tCreate Application\tmodal:",
      "content_length": 412,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 167,
      "content": "A\tfew\tseconds\tlater,\tyou\tshould\tsee\tthat\tthe\tapplication's\tstatus\tchanges\tfrom\n\nDeploying\tto\tRunning,\tindicating\tthat\tit\tis\tready\tto\tbe\tconsumed:\n\nWithout\twasting\tany\tmore\ttime,\tlet's\ttest\tour\tservice.\tBefore\tthat,\thow\tdo\tyou know\twhich\thost\tyour\tapplication\tis\trunning\ton?\tTo\tfind\tout,\tyou\twill\tneed\tthe IP\tof\tyour\tMesos\tslave.\tMarathon\tmakes\tit\teasy\tfor\tyou\tto\tfind\tthe\thost\tand\tport your\tapplication\tis\trunning\ton.\tFrom\tMarathon's\thome\tpage,\tclick\ton\tyour application\tname.\tIt\tshould\ttake\tyou\tto\tthe\tapplication\tdetails\tpage\tfor\tthe geolocation\tapplication:\n\nThere\tare\tlots\tof\tthings\ton\tthis\tpage.\tBut\tlet's\tjust\tfocus\ton\tthe\tInstances\tgrid.\n\nRight\tfollowing\tthe\tID\tof\tthe\tapplication\tinstance,\twe\tcan\tsee\ta\t<hostname>: <port>\tcombination.\tThe\thostname\tis\tsomething\tyou\tare\talready\tfamiliar\twith. That\tis\tthe\tIP\tof\tour\tDocker\thost\t(VirtualBox\tVM).\tThe\tport\tis\ta\trandom\tport that\tMarathon\thas\telected\tto\texpose\tour\tapplication\ton.\n\nExecute\ta\tcurl\tcommand\tto\tGET\tall\tgeolocations\tsaved\tin\tthe\tapplication. Since\tthis\tis\ta\tbrand\tnew\tdeployment,\tyou\tshould\tget\tan\tempty\tarray\tback, indicating\tthere\tare\tno\tgeolocations\tsaved\tin\tthe\tsystem:\tcurl http://192.168.99.100:31756/geolocation\n\nThe\toutput\tshould\tbe\tsomething\tlike\tthis:\tcurl:\t(7)\tFailed\tto\tconnect\tto\n\n192.168.99.100\tport\t31756:\tConnection\trefused\n\nWhat\tjust\thappened\there?\tWe\tare\tnot\table\tto\tconnect\tto\tour\tservice\ton\thost 192.168.99.100\tand\tport\t31756.\tWith\tthat\tsaid,\twe\tnow\tclearly\tknow\tthat\tthe",
      "content_length": 1456,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 168,
      "content": "port\tnumber\twe\thave\tis\tnot\tright.\tThere\tis\tdefinitely\ta\tway\tto\tconfigure\tour application\tin\tsuch\ta\tway\tthat\tit\texposes\tthe\tAPI\ton\tthe\tright\tport.\tWe\twill\tlook at\tthat\tin\tour\tnext\trecipe.",
      "content_length": 186,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 169,
      "content": "Configuring\tports\tin\tMarathon\n\nIn\tthe\tprevious\trecipe,\twe\tsaw\thow\tto\tdeploy\tour\tmicroservice\tin\tMarathon.\tWe were\table\tto\tdeploy\tthe\tgeolocation\tmicroservice\ton\tMarathon,\tbut\tit\twas\tnot really\tuseful\tbecause\twe\thaven't\tfigured\tout\thow\tto\ttalk\tto\tour\tmicroservice\tvia its\tRESTful\tAPI.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconfigure\tour\tapplication's service\tand\thost\tports\tin\tMarathon\tto\texpose\tthe\tRESTful\tAPIs.",
      "content_length": 411,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 170,
      "content": "Getting\tready\n\nIf\tyou\tdon't\thave\tyour\tcluster\tup\tand\trunning,\tbring\tit\tback\tup.\tAlso\tmake\tsure you\thave\tthe\tgeolocation\tapplication\tup\tand\trunning\tin\tyour\tcluster.\tYou\tcan verify\tthat\tfrom\tthe\tMarathon\tweb\tinterface.",
      "content_length": 216,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 171,
      "content": "How\tto\tdo\tit... 1.\t From\tthe\tInstances\tgrid,\tclick\ton\tthe\tapplication\tinstance\tand\tgo\tto\tthe\n\nConfiguration\ttab.\tThe\tConfiguration\ttab\tis\tused\tto\tshow\tthe\tMarathon configurations\tfor\tyour\tapplication.\tYou\twill\tsee\tseveral\tconfigurations, such\tas\tthe\tmemory,\tCPU,\tdisk\tspace,\tDocker\tcontainer,\tand\thealth\tchecks:",
      "content_length": 311,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 172,
      "content": "2.\t In\tthe\tContainer\tsection,\tyou\twill\tsee\tJSON\tcode\tsimilar\tto\tthis:\n\n{ \t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\", \t\t\t\t\t\t\t\t\t\t\"volumes\":\t[], \t\t\t\t\t\t\t\t\t\t\"docker\":\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesan/geolocation\", \t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\", \t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[ \t\t\t\t\t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t10000, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",",
      "content_length": 418,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 173,
      "content": "\"protocol\":\t\"tcp\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{} \t\t\t\t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t\t\t], \t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse, \t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[], \t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse \t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\nThe\tone\tthat\twe\tare\treally\tconcerned\tabout\tis\tportMappings\tin\tthe Container\tsection.\tIn\tsome\tversions\tof\tMarathon,\tthe\tportMappings\twill\tbe listed\tunder\tPort\tDefinitions\tproperty.\tSo\tdon't\tpanic\tif\tyour\tinterface looks\tdifferent.\tThe\tinstructions\tin\tthis\trecipe\tare\tstill\tgoing\tto\tbe\tthe\tsame. You\tcan\tsee\tthat\tthe\tcontainerPort\tis\tmarked\tas\t0.\tIdeally,\twe\tshould expect\t8080\tthere,\tas\tthat's\twhere\tour\tAPI\tis\tlistening.\n\nThe\thostPort\tis\tthe\tport\ton\tthe\tDocker\thost\tto\twhich\tMarathon\twill\tbind this\tcontainerPort.\tThe\thostPort\tcan\talso\ttake\tthe\tvalue\t0,\tinstructing Marathon\tto\tchoose\ta\trandom\tport\tnumber.\tIn\tmost\tcases,\tthe\thostPort\tis the\tport\tnumber\ton\tthe\tMesos\tslave\tthat\tis\trunning\tthis\tcontainer.\tAgain, identifying\tthe\tslave\tIP\ton\ta\tcluster\twith\thundreds\tof\tslaves\tis\tnot\tideal.\n\nThat's\twhere\tthe\tservicePort\tcomes\tto\tthe\trescue.\tThe\tservicePort\tis currently\tset\tto\t10000\tby\tdefault.\tIn\tproduction\tenvironments,\tthe servicePort\tis\tmanually\tset\tto\ta\twell-known\tvalue,\tsuch\tas\t8899\tor\t8181. Once\tyou\tset\tthe\tservicePort\tto\ta\twell-known\tvalue\tthat\tyou\tcan remember,\tyou\tcan\tthen\tuse\tservice\tdiscovery\ttools\tsuch\tas\tConsul\tor\ttools such\tas\tHAProxy\tto\tperform\ta\tforwarding\tfrom\tthe\thostPort\tto\tthe servicePort.\tMarathon\tpreviously\tprovided\ta\tscript\tcalled\thaproxy- marathon-bridge\tto\tdo\texactly\tthis.\tIt\tcreates\ta\tHAProxy\tconfig\tfile\tthat can\tbe\tused\twith\tHAProxy\tto\tmake\tthis\tbalancing\thappen.\tAt\tthe\ttime\tof writing\tthis,\tthis\tscript\thas\tbeen\tdeprecated\tin\tfavor\tof\tthe\tMarathon\tLoad Balancer\t(LB).\tWe\twill\tlearn\tmore\tabout\tMarathon\tLB\tin\tChapter\t5, Service\tDiscovery\tand\tLoad\tBalancing\tMicroservices.\tAfter\tyou\tenable service\tdiscovery\tand\tconfigure\tMarathon,\tyou\twill\tbe\table\tto\taccess\tyour service\tfrom\tmesosMasterHostName:servicePort.\tIf\tyou\thave\tmultiple masters,\tit\tis\trecommended\tthat\tyou\thave\ta\tcommon\thostname\tthat\talways points\tto\tthe\tactive\tmaster.\n\nThe\tprotocol\tcan\tbe\tUDP\tor\tTCP.\tYou\twon't\thave\tto\tuse\tUDP\tin\tmost",
      "content_length": 2131,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 174,
      "content": "The\tprotocol\tcan\tbe\tUDP\tor\tTCP.\tYou\twon't\thave\tto\tuse\tUDP\tin\tmost cases.\tWe\twill\tstick\tto\tTCP\tthroughout\tthis\tbook.\n\n3.\t Now\tlet's\tmodify\tthe\tapplication's\tMarathon\tconfiguration\tto\tinclude\tthe hostPort\tand\tservicePort.\tIn\torder\tto\tdo\tthat,\tclick\ton\tthe\tEdit\tbutton\ton the\tConfiguration\tscreen,\tand\tgo\tto\tthe\tPorts\tsection.\tEnter\tthe\tContainer Port\tvalue\tas\t8080.\tLeave\tthe\tprotocol\tvalue\tas\ttcp:\n\n4.\t Now,\tif\tyou\tare\twondering\twhere\thostPort\tand\tservicePort\tare, Marathon\tleaves\tthose\tas\tadvanced\tconfigurations,\tand\tthe\tonly\tway\tto configure\tthe\tadvanced\tconfigurations\tis\tusing\tJSON\tmode.\tIn\torder\tto\tuse JSON\tmode,\tclick\ton\tthe\ttoggle\tbutton\tin\tthe\ttop\tright\tof\tthe\tmodal\tthat says\tJSON\tMode.\tYou\tshould\tsee\tthe\tJSON\tthat\tMarathon\tuses\tto\tpost\tto its\tREST\tservice,\twhich\tin\tturn\tconverts\tit\tinto\ta\tMesos\ttask\trequest.\tIn\tthe",
      "content_length": 828,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 175,
      "content": "portMappings\tsection,\tyou\tshould\tnow\tsee\tthat\tcontainerPort\tis populated\twith\tthe\tvalue\t8080.\tGo\tahead\tand\tadd\tthese\ttwo\tfields\tto\tthis port\tmapping\tobject:\n\n\"hostPort\":\t0, \t\t\t\t\t\t\t\t\"servicePort\":\t8899",
      "content_length": 200,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 176,
      "content": "This\twill\ttell\tMarathon\tto\tuse\tany\trandom\tport\tas\tthe\thost\tport\tand\tuse\t8899 as\tthe\tservice.\tLike\twe\tsaw\tearlier,\tit\tis\tour\tresponsibility\tto\tperform\ta\tport forwarding\tfrom\tthe\thost\tport\tto\tthe\tservice\tport\tusing\ttools\tsuch\tas HAProxy\tor\tMarathon\tLB,\twhich\twe\twill\tbe\tlooking\tat\tin\tlater\tchapters. For\tnow,\twhat\tthis\twill\tdo\tis\texpose\tthe\tRESTful\tservices\tin\tthe geolocation\tapplication\ton\tany\trandom\tport\ton\tthe\thost\tmachine.\tIn\tour case,\tthe\thost\tmachine\tis\tthe\tVirtual\tBox\tVM\tat\t192.168.99.100.\n\nWith\tthat\tsaid,\tclick\ton\tChange\tand\tdeploy\tconfiguration.\tUsually,\tit takes\ta\tfew\tseconds\tto\tfinish\tthe\tdeployment.\tYou\tcan\tlook\tat\tthe\tpending deployments\tfrom\tthe\tDeployments\ttab\tof\tMarathon.\tYou\tcan\tmake\tsure that\tyour\tconfigurations\tare\tupdated\tby\tlooking\tat\tthe\tDocker\tcontainer",
      "content_length": 782,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 177,
      "content": "setting\tin\tthe\tConfiguration\ttab.\tIt\tshould\tinclude\tthe\tservicePort\tand hostPort:\n\n{ \t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\", \t\t\t\t\t\t\t\t\t\t\"volumes\":\t[], \t\t\t\t\t\t\t\t\t\t\"docker\":\t{ \t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesan/geolocation\", \t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\", \t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[ \t\t\t\t\t\t\t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{} \t\t\t\t\t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t\t\t\t\t], \t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse, \t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[], \t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\n5.\t Now,\tlet's\ttest\tour\tservice\tusing\tthe\tcurl\tcommand.\tBefore\tthat,\tyou\thave to\tknow\twhat\thost\tport\tyour\tservice\tis\trunning\ton.\tYou\tcan\tget\tthat\tfrom the\tInstances\tsection:",
      "content_length": 788,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 178,
      "content": "As\tyou\tcan\tsee,\tit\tis\trunning\ton\tport\t31434.\tYours\tmight\tbe\tdifferent\tas\tit gets\trandomly\tgenerated.\tSo\tplease\tmake\tsure\tyou\tuse\tyour\tport\tnumber\tin the\tnext\tcURL\tcommand.\n\n6.\t Now,\topen\ta\tnew\tterminal\tsession\tand\tissue\tthe\tfollowing\tcurl\tcommand:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31434/geolocation\n\n7.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t}\n\nNote\n\nConfiguring\tports\tin\tMarathon\tis\ttrickier\tthan\tyou\tthink.\tYou\thave\tto",
      "content_length": 812,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 179,
      "content": "understand\tthe\tusage\tof\tservicePorts,\thostPorts,\tand\trequirePorts\tas well\tas\tthe\tvarious\tnetworking\tmodes,\tsuch\tas\tHOST\tand\tBRIDGE.\tIt\tis strongly\trecommended\tyou\ttake\ta\tlook\tat https://mesosphere.github.io/marathon/docs/ports.html\tbefore\tyou\tstart playing\twith\tthem\ton\tyour\tproduction\tcluster.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tYou\tnow\tknow\thow\tto\tdeploy\tyour\town microservice\ton\ta\tMesos\tcluster\tusing\tMarathon.",
      "content_length": 421,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 180,
      "content": "Configuring\tvolumes\tin\tMarathon\n\nSo\tfar,\twe\thave\tlearned\thow\tto\tdeploy\tour\tmicroservice\ton\ta\tMesos\tcluster using\tMarathon\tand\tconfigure\tports\tusing\tMarathon's\tweb\tUI.\tOne\tof\tthe\tmost common\tthings\tyou\twould\twant\tto\tdo\tis\tbe\table\tto\tmap\tvolumes\tin\tyour container\tto\tthe\thost\tmachine.\tThough\tthis\tis\tnot\tsomething\tthat\tis\tsuper important\tto\tour\tgeolocation\tapplication,\twhen\tyou\tdeal\twith\tapplications\tthat save\tfiles\ton\tthe\tfilesystem,\tthis\tis\tcritical.\tYou\twouldn't\twant\tto\tlose\tyour\tdata, would\tyou?\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tmap\tvolumes\tusing\tMarathon.",
      "content_length": 567,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 181,
      "content": "Getting\tready\n\nIn\torder\tto\tlearn\thow\tto\tconfigure\tvolume\tmapping\tin\tMarathon,\tlet's\tmake\tour application\tsave\tsomething\tto\tthe\tfilesystem.\tLet's\tsay\tthe\tgeolocation application\twould\tlike\tto\tstore\tthe\tgeolocation\tJSON\tto\tthe\tfilesystem\tas\tit receives\tthem.\tIt\tmight\tnot\tbe\ta\tgreat\tdesign,\tbut\tfor\tour\tunderstanding,\tlet's make\tour\tgeolocation\tapplication\tstore\tthe\tgeolocation\tJSON\tfiles\tin\ta\tdedicated data\tdirectory\tas\tand\twhen\tthey\tarrive.\tIn\torder\tto\tdo\tso,\tlet's\topen\tup\tour\tSTS IDE.",
      "content_length": 488,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 182,
      "content": "How\tto\tdo\tit...\n\nIn\torder\tto\tcreate\tthis\tdata\tdirectory,\twe\thave\tto\tdo\ttwo\tthings:\n\nCreate\tthe\tdirectory\ton\tthe\thost\tmachine\tand\tmake\tit\taccessible Make\tthe\tGeoLocationRepository.java\tfile\twrite\tany\tnew\tgeolocation JSON\tto\tthe\tdata\tdirectory\n\nBefore\twe\tcan\timplement\tthis\tin\tthe\tcontainer,\tlet's\ttry\tto\tdo\tit\tlocally:\n\n1.\t Issue\tthe\tfollowing\ttwo\tcommands\ton\tyour\tterminal:\n\nmkdir\t-p\toptpackt/geolocation/data chmod\t-R\t777\t/opt\n\nUse\tsudo\tif\tneeded.\tThe\tmkdir\tcommand\tcreates\tthe\tgiven\tdirectory structure\tin\tyour\tlocal\tfilesystem,\tand\tthe\tchmod\tcommand\tgives\teveryone read,\twrite,\tand\texecute\tpermissions\ton\tthe\t/opt\tdirectory\tand\tits subdirectories.\tYou\tcan\tverify\tthis\tby\trunning\tthe\tls\t-l\tcommand.\tSetting 777\tprivileges\tis\tnot\ta\tsafe\tapproach\tas\tit\topens\tup\tsecurity\trisks.\tWhen\tyou are\tdoing\tsomething\tsimilar\tin\tyour\tapplication,\tmake\tsure\tthat\tyou\tgive just\tthe\trequired\tprivileges.\n\n2.\t Now\tthat\tour\tdirectory\tis\tready,\tlet's\tmake\tchanges\tin\tour\trepository\tclass to\tstart\twriting\tgeolocations\tto\tthis\tdirectory.\tAs\twe\twould\tneed\tone\tfile\tper geolocation,\twe\thave\tto\tcome\tup\twith\ta\tnaming\tconvention\tso\tthat\tthe\tfiles don't\tget\toverwritten.\tThe\ttimestamp\twill\tmore\tor\tless\tbe\tunique\tfor\tall geolocations.\tBut\twhat\thappens\twhen\tyou\tare\twriting\tgeolocations\tfor multiple\tusers\tat\tthe\tsame\ttime?\tSo,\tmaybe\ta\tcombination\tof\ttimestamp\tand user\tID?\tYes,\tthat\tshould\twork\tfor\tnow.\tTo\tdifferentiate\tthe\tuser\tID\tfrom the\ttimestamp,\twe\tcould\tuse\tthe\tfollowing\tconvention:\n\nuser<userId>_t<timestamp>\n\n3.\t Let's\tmake\tchanges\tto\tthe\tGeoLocationRepository.java\tfile\tto\tfollow\tthis naming\tconvention.\tThe\tfirst\tthing\tthat\twe\twill\tneed\tis\tan\tobject-to-JSON string\tserializer.\tWe\twill\tuse com.fasterxml.jackson.databind.ObjectMapper\tas\tit\tis\talready\tused\tby Spring\tMVC.\tThe\tObjectMapper.writeValue(File,\tString)\tmethod\tis used\tto\twrite\ta\tfile\twith\tthe\tgiven\tstring\tcontent,\twhich\tsuits\tour\tneeds perfectly.",
      "content_length": 1896,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 183,
      "content": "4.\t Go\tahead\tand\tuse\tthis\tmethod\tin\tthe\tGeoLocationRepository\tclass' addGeoLocation\tmethod.\tAfter\tyou\tare\tdone,\tyour GeoLocationRepository.java\tclass\twill\tlook\tsomething\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation; import\tjava.io.File; import\tjava.util.ArrayList; import\tjava.util.Collections; import\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\nimport\tcom.fasterxml.jackson.databind.ObjectMapper;\n\n@Repository public\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew\t ArrayList<GeoLocation>();\n\nprivate\tstatic\tfinal\tObjectMapper\tMAPPER\t=\tnew\t ObjectMapper();\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation)\t{ \t\t\t\t\t\t\t\tgeolocations.add(geolocation);\n\ntry\t{ \t\t\t\t\t\t\t\t\t\t\t\tMAPPER.writeValue(new\t File(\"optpackt/geolocation/data/user\"\t+\tgeolocation.getUserId()\t +\t\"_t\"\t+\tgeolocation.getTimestamp()),\tgeolocation); \t\t\t\t\t\t\t\t}\tcatch\t(Exception\te)\t{ \t\t\t\t\t\t\t\t\t\t\t\te.printStackTrace(); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{ \t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations); \t\t\t\t} }\n\n5.\t Now\tthat\tboth\tour\tdirectory\tand\tcode\tare\tready,\tlet's\ttest\tthe\tapplication. Start\tyour\tGeoLocationApplication.java\tapplication\tas\ta\tSpring\tBoot application\tfrom\tyour\tSTS\tIDE.\tNow\tissue\tthe\tfollowing\tcurl\tcommand\tto create\ta\tgeolocation: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-",
      "content_length": 1364,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 184,
      "content": "d'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://localhost:8080/geolocation\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nAlso,\tthis\tshould\thave\tcreated\tthe\tdata\tfile\tat\tthe optpackt/geolocation/data\tdirectory.\tLet's\tverify\tthat.\tIssue\tthe following\tcommand\tto\tlook\tat\tthe\tcontents\tof\tthe\tdata\tfile:\n\ncat\toptpackt/geolocation/data/userf1196aac-470e-11e6-beb8- 9e71128cae77_t1468203975\n\n6.\t This\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty- printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t}\n\n7.\t Now\tthat\tour\tcode\tworks\tgreat,\tthe\tnext\tsteps\tare\tas\tfollows:\n\n1.\tBuild\tthe\tproject\tto\tgenerate\ta\tnew\tJAR\tartifact\n\n2.\tCreate\ta\tnew\tDocker\timage\tbecause\tour\tcode\thas\tchanged\n\n3.\tUpload\tthe\tnew\timage\tto\tDocker\tHub\n\n4.\tRedeploy\tthe\tnew\timage\twith\tvolume\tconfigurations\n\n5.\tVerify\twhether\tthe\tvolume\tis\tmapped\n\n8.\t Go\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand. This\tshould\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe",
      "content_length": 1452,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 185,
      "content": "target\tdirectory.\n\n9.\t In\torder\tto\tcreate\tthe\tnew\timage,\twe\thave\tto\tadd\ttwo\tnew\tlines\tto\tthe Dockerfile\tto\tcreate\tthe\tdata\tdirectory\tand\tgive\tit\twrite\tprivileges.\tAdd\tthe following\ttwo\tlines\tto\tyour\tDocker\tfile:\n\nRUN\tmkdir\t-p\toptpackt/geolocation/data RUN\tchmod\t-R\t777\t/opt\n\n10.\t After\tyou\tadd\tthis,\tyour\tDocker\tfile\twill\tlook\tsomething\tlike\tthis:\n\nFROM\topenjdk:8 RUN\tmkdir\t-p\toptpackt/geolocation/data RUN\tchmod\t777\t/opt ADD\ttarget/geolocation-0.0.1-SNAPSHOT.jar \t\t\t\t\t\t\t\t\t\t\toptpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-0.0.1- SNAPSHOT.jar\"]\n\n11.\t Now\tlet's\tbuild\tthe\timage\twith\tnew\tcode.\tKeep\tin\tmind\tthat\tin\taddition\tto creating\tthe\tdata\tdirectory,\tthe\tother\tchange\tin\tthe\timage\tis\tgeolocation- 0.0.1-SNAPSHOT.jar.\tThis\tfile\twould\thave\tbeen\tautomatically\tcreated\tby your\tIDE\twhen\tyou\tmade\tthe\tchange\tto\tyour GeoLocationRepository.java\tfile.\tThough\tI\tdidn't\texplicitly\tmention earlier,\tbe\taware\tthat\tit\tis\talso\tgetting\tchanged\tin\tyour\timage.\n\n12.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\timage\twe\talready\thave.\tTo do\tthat,\trun\tthe\tfollowing\ttwo\tcommands\tone\tby\tone:\n\ndocker\trmi\tpackt/geolocation docker\trmi\tvikrammurugesan/geolocation\n\nWe\tare\tremoving\tthe\tpackt/geolocation\timage\tas\tit\treferences\tthe vikrammurugesan/geolocation\timage.\tIf\tyou\ttry\tto\tremove\tthe vikrammurugesan/geolocation\timage\twithout\tremoving\tthe packt/geolocation\timage,\tDocker\twill\tcomplain\tabout\treferences\tand\twill not\tremove\tthe\timage.\tTo\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton your\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\nRemember\tto\tuse\tyour\taccount\tname\tinstead\tof\tmine\tin\tthis\tcommand. After\tyour\timage\thas\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto\tDocker\tHub using\tthe\tfollowing\tcommand.\tYou\tmay\tbe\tasked\tto\tlog\tin\tto\tyour\tDocker Hub\taccount\tif\tyou\thaven't\talready\tdone\tso.",
      "content_length": 1828,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 186,
      "content": "Hub\taccount\tif\tyou\thaven't\talready\tdone\tso.\n\ndocker\tpush\tvikrammurugesan/geolocation\n\nAgain,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe last\tupdated\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent.\n\n13.\t Now\tthat\tour\timage\tis\tready\tto\tbe\tused,\tlet's\tspin\toff\tour\tmicroservice\ton Mesos\tusing\tMarathon.\tMake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tIf it\tis\tdown,\tkill\tyour\tcluster\tand\tstart\tit\tagain.\tOnce\tyour\tcluster\tis\tback\tup, open\tthe\tMarathon\tweb\tUI\ton\tyour\tbrowser.\tClick\ton\tthe\tCreate Application\tbutton\tand\tgo\tinto\tJSON\tmode.\tWe\twill\tbe\tusing\tJSON\tmode to\tquickly\tpopulate\tthe\tmodal.\n\nIn\tJSON\tmode,\tdelete\tthe\texisting\tJSON\tand\tpaste\tthe\tfollowing:\n\n{\t \t\t\t\t\t\t\t\t\t\t\"id\":\t\"geolocation\",\t \t\t\t\t\t\t\t\t\t\t\"cmd\":\tnull,\t \t\t\t\t\t\t\t\t\t\t\"cpus\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"mem\":\t512,\t \t\t\t\t\t\t\t\t\t\t\"disk\":\t1024,\t \t\t\t\t\t\t\t\t\t\t\"instances\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"container\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\",\t \t\t\t\t\t\t\t\t\t\t\t\t\"docker\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesangeolocation\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}",
      "content_length": 1502,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 187,
      "content": "14.\t Now\tgo\tback\tto\tUI\tmode\tby\ttoggling\tthe\tJSON\tMode\tbutton.\tNavigate\tto the\tVolumes\tsection.\tIn\tthe\tVolumes\tsection,\tyou\twill\tsee\ttwo\tthings.\tOne is\tPersistent\tVolumes,\twhich\tis\tmostly\tused\tin\tapplications\tthat\tneed stateful\tbehavior.\tThe\tnext\tone\tis\tthe\tDocker\tContainer\tVolumes,\twhich is\tused\tto\tmap\tvolumes\tbetween\tthe\tcontainer\tand\thost.\tIn\tour\tcase,\twe have\tto\tadd\ta\tDocker\tcontainer\tvolume.\tAdd\tthe\tfollowing\tentries\tto\tthe Docker\tContainer\tVolumes\tsection\tand\thit\tCreate\tApplication: Container\tPath:\toptpackt/geolocation/data Host\tPath:\toptpackt/geolocation/data Mode:\tRead\tand\tWrite\n\nAs\tyou\tcan\tsee,\twe\tare\tusing\tthe\tsame\tpath\tin\tthe\tcontainer\tand\tthe\thost. Marathon\twill\tdeploy\tthe\tapplication\twith\tthe\tnewer\tversion\tof\tyour\timage. 15.\t Now\tthat\tour\tapplication\tis\tready\tto\ttest,\tlet's\tcreate\ttwo\tgeolocations\tusing curl.\tMake\tsure\tthe\tport\tnumber\tthat\tyou\tuse\tis\tthe\tsame\tport\tnumber\tthat is\tadvertised\tin\tMarathon.\tIn\tmy\tcase,\tthe\tport\tnumber\twas\tchanged\tfrom 31434\tto\t31758.\tThat's\tbecause\twe\tredeployed\tthe\tapplication.\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t- d'{\"timestamp\":\t1474843159,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31758/geolocation curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1474843900,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t42.803488,\t\"longitude\":-87.144040}'\t http://192.168.99.100:31758/geolocation\n\nThese\ttwo\tcommands\tshould\thave\tcreated\ttwo\tfiles\tin\tthe optpackt/geolocation/data\tdirectory\tof\tthe\tcontainer\tas\twell\tas\tthe\thost.\n\n16.\t First,\tlet's\tverify\tthat\tthe\tfile\tis\tcreated\tin\tthe\tcontainer.\tTo\tlist\tthe\tfiles\tin the\toptpackt/geolocation/data\tdirectory,\twe\thave\tto\tfind\tout\tthe\tID\tof the\tcontainer.\tIdeally,\twhen\tyou\thave\ta\treal\tnon-dockerized\tMesos\tcluster, your\tcontainer\twill\tbe\trunning\ton\ta\tremote\tMesos\tslave.\tBut\tas\tour installation\tis\ta\tDockerized\tversion,\tthe\tgeolocation\tapplication\twill\tbe running\tas\ta\tcontainer\ton\tour\tDocker\thost.\tYou\tcan\tverify\tthat\tusing\tthe docker\tps\t-a\tcommand:",
      "content_length": 2078,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 188,
      "content": "In\tthis\tscreenshot,\tsome\tportion\tof\tthe\tconsole\thas\tbeen\tcropped\tout\tto highlight\tonly\tthe\trelevant\tinformation.\tBut\tas\tyou\tcan\tsee,\tthe\tgeolocation application\tis\trunning\tas\ta\tDocker\tcontainer,\tand\tits\tID\tis\t924b3f748273. Now\tthat\twe\tknow\tthe\tcontainer\tID,\tissue\tthe\tfollowing\tDocker\tcommand to\tlist\tthe\tcontents\tof\tthe\tdata\tdirectory\tand\tthe\tdata\tfiles\tthemselves:\n\ndocker\texec\t924b3f748273\tls\toptpackt/geolocation/data\n\nThis\tshould\tshow\tsomething\tlike\tthe\tfollowing:\n\nuserf1196aac-470e-11e6-beb8-9e71128cae77_t1474843159 userf1196aac-470e-11e6-beb8-9e71128cae77_t1474843900\n\n17.\t To\tverify\tthe\tcontents\tof\tthe\tfiles,\tissue\tthe\tfollowing\tcommands\tone\tby one:\n\ndocker\texec\t924b3f748273\t catoptpackt/geolocation/data/userf1196aac-470e-11e6-beb8- 9e71128cae77_t1474843159\n\n18.\t You\tshould\tsee\tthis\toutput\t(pretty-printed\tfor\treadability):\n\n{\t \t\t\t\t\t\t\t\t\t\t\"latitude\":41.803488,\t \t\t\t\t\t\t\t\t\t\t\"longitude\":-88.14404,\t \t\t\t\t\t\t\t\t\t\t\"userId\":\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \t\t\t\t\t\t\t\t\t\t\"timestamp\":1474843159\t \t\t\t\t\t\t\t\t}\n\ndocker\texec\t924b3f748273\tcat\t \t\t\t\t\t\t\t\t\t\toptpackt/geolocation/data/userf1196aac-470e-11e6- beb8- \t\t\t\t\t\t\t\t\t\t9e71128cae77_t1474843900\n\n19.\t You\tshould\tsee\tthis\toutput\t(pretty-printed\tfor\treadability):",
      "content_length": 1211,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 189,
      "content": "{ \t\t\t\t\t\t\t\t\t\t\"latitude\":42.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":-87.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":1474843900 \t\t\t\t\t\t\t\t}\n\nWith\tthat,\twe\thave\tverified\tthat\tour\tapplication\tcreates\tthe\tdata\tfiles\tin\tthe data\tdirectory\tof\tthe\tcontainer.\n\n20.\t In\torder\tto\tverify\tthat\tour\tvolume\tmappings\twork,\twe\thave\tto\tcheck whether\tthose\tfiles\tare\tavailable\tin\tthe\tDocker\thost.\tKeep\tin\tmind\tthat\tas we\tare\tusing\tDocker\tMachine,\tthe\tDocker\thost\tin\tthis\tcase\tis\tthe\tOracle VirtualBox\tVM\tand\tnot\tour\tlocal\tcomputer.\tIn\torder\tto\tlook\tat\tthe\tcontents of\tthe\tVM,\twe\thave\tto\tfirst\tSSH\tinto\tthe\tVM.\tDocker\tMachine\thas\tan\tssh command\tthat\tlets\tyou\tSSH\tinto\tthe\tVM.\tGo\tahead\tand\tissue\tthe\tfollowing command\tto\tSSH\tinto\tthe\tVM:\n\ndocker-machine\tssh\tdefault\n\nYou\tshould\tsee\tsomething\tlike\tthis:\n\n21.\t List\tthe\tfiles\tin\tthe\toptpackt/geolocation/data\tdirectory\tusing\tthe\tls command:",
      "content_length": 898,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 190,
      "content": "ls\t-l\toptpackt/geolocation/data\n\nYou\tshould\tsee\tthat\ttwo\tfiles\thave\tbeen\tcreated\twith\tthe\tsame\tnames\tas\tin the\tcontainer:\n\nIf\tyou\twould\tlike\tto\tlook\tat\tthe\tcontents,\texecute\tthe\tcat\tcommand\tto\tlook at\tthe\tcontents\tof\tthe\tdata\tfiles.\tThat's\tit!\tWe\thave\tlearned\thow\tto\tmap volumes\tusing\tMarathon.\tIn\ta\treal-time\tscenario,\tit\tis\tworth\tusing\tvolume mapping\tto\ttake\tbackups\tof\tany\tcritical\tdata\tsuch\tas\tDB\tdata\tfiles,\tsensitive log\tfiles,\tand\traw\tmachine\tdata.\tSome\torganizations\tutilize\tMesos frameworks\tsuch\tas\tChronos\tto\tperform\tdata\tbackups\tof\tthese\tdata.\n\nNote\n\nTo\tlearn\tmore\tabout\tChronos,\ttake\ta\tlook\tat\tthis\tpage: https://mesos.github.io/chronos/",
      "content_length": 649,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 191,
      "content": "Configuring\tenvironment\tvariables\tin Marathon\n\nEnvironment\tvariables\tplay\ta\tvital\trole\tin\tany\tcontainer.\tBe\tit\tyour\tdatabase\tor messaging\tserver\tor\tyour\town\tRESTful\tAPI,\tenvironment\tvariables\tcan\tbe\tused to\tstore\tconfigurations\tof\tyour\tcontainer.\tSo\tfar\tin\tour\tgeolocation\tmicroservice, we\thaven't\tcome\tacross\ta\tscenario\tto\tuse\tenvironment\tvariables\tas\tit\tis\ta standalone\tapplication\tand\tdoes\tnot\thave\tto\ttalk\tto\tany\tother\tserver\tor middleware.\tBut\tin\tproduction\tscenario\twhere\tyou\tmicroservice\thas\tto\ttalk\tto\ta database\tor\tKafka\tbroker,\tyou\thave\tto\tstore\tthe\tconfigurations\tof\tyour\tdatabase or\tbroker\tsomewhere.\tThat's\twhere\tdevelopers\tprefer\tusing\tenvironment variables.\tIn\tthis\trecipe\twe\twill\ttake\ta\tlook\tat\thow\tto\tconfigure\tour\tgeolocation application\tto\tuse\tan\tenvironment\tvariable\tand\talso\tsee\thow\tto\tpass\tthat\tvariable using\tMarathon.",
      "content_length": 841,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 192,
      "content": "Getting\tready\n\nBefore\twe\tmove\ton,\twe\tfirst\tneed\tto\tknow\tthe\tenvironment\tvariable\tthat\twe\tare going\tto\tparameterize\tand\thow\tthe\tgeolocation\tapplication\tis\tgoing\tto\tuse\tit.\tOne use\tcase\tcould\tbe\tgetting\tthe\tlocation\tof\tthe\tdata\tfiles\tas\tan\tenvironment variable.\tLet's\tgo\tahead\tand\tdo\tthat!\tAs\twe\twill\thave\tto\tmake\tsome\tcode changes,\tgo\tahead\tand\topen\tup\tSTS\tIDE.",
      "content_length": 360,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 193,
      "content": "How\tto\tdo\tit...\n\nOpen\tthe\tGeolocationRepository.java\tfile\tthat\tis\tresponsible\tfor\tcreating\tthe geolocations\tand\tpersisting\tthe\tgeolocation\tJSONs\tto\tthe\tlocal\tfile\tsystem.\tIn this\trecipe\twe\twill\tbe\tparameterizing\tthe\tpath\tto\tthe\tdata\tdirectory optpackt/geolocation/data.\tCreate\ta\tnew\tconstant\tcalled\tDATA_FILES_DIR and\tassign\tit\twith\tthe\tvalue\tof\tthe\tenvironment\tvariable GEOLOCATION_DATA_FILES_DIR.\n\nprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t= \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\");\n\nBut\twait,\twhat\tif\tthe\tperson\tthat\tdeploys\tthe\tapplication\tforgets\tto\tpass\tthis environment\tvariable?\tSo\tit\tis\talways\tsafer\tto\tgive\ta\tdefault\tvalue\tto environment\tvalues\tif\tthey\tare\tnull\t(while\tthey\tare\tnon-nullable).\tWith\tthat\tsaid, lets\tgo\tahead\tand\trewrite\tthe\tpreceding\tline\twith\tthis:\n\nprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t=\t \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t!=\tnull\t\t\t\t\t\t\t ?\t \t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t:\t \t\t\t\t\t\t\t\t\t\t\"optpackt/geolocation/data\";\n\nAs\tyou\tcan\tsee\twe\thave\tdefaulted\tthe\tvalue\tto\toptpackt/geolocation/data. Now\tmodify\tthe\taddGeoLocation\tmethod\tto\tuse\tthis\tvariable.\tAfter modification,\tthis\tclass\twill\tlook\tsomething\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.io.File;\t \t\t\t\t\t\t\t\timport\tjava.util.ArrayList;\t \t\t\t\t\t\t\t\timport\tjava.util.Collections;\t \t\t\t\t\t\t\t\timport\tjava.util.List;\n\nimport\torg.springframework.stereotype.Repository;\n\nimport\tcom.fasterxml.jackson.databind.ObjectMapper;\n\n@Repository\t \t\t\t\t\t\t\t\tpublic\tclass\tGeoLocationRepository\t{\n\nprivate\tList<GeoLocation>\tgeolocations\t=\tnew\t \t\t\t\t\t\t\t\t\t\t\t\tArrayList<GeoLocation>();",
      "content_length": 1623,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 194,
      "content": "private\tstatic\tfinal\tObjectMapper\tMAPPER\t=\tnew \t\t\t\t\t\t\t\t\t\t\t\tObjectMapper();\t \t\t\t\t\t\t\t\t\t\tprivate\tstatic\tfinal\tString\tDATA_FILES_DIR\t=\t \t\t\t\t\t\t\t\t\t\t\t\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t!=\tnull\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t?\tSystem.getenv(\"GEOLOCATION_DATA_FILES_DIR\")\t: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"optpackt/geolocation/data\";\n\npublic\tvoid\taddGeoLocation(GeoLocation\tgeolocation)\t{\t \t\t\t\t\t\t\t\t\t\t\t\tgeolocations.add(geolocation);\n\ntry\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\tMAPPER.writeValue(new\tFile(DATA_FILES_DIR\t+\t\"/user\"\t+ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.getUserId()\t+\t\"_t\"\t+ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.getTimestamp()),\tgeolocation);\t \t\t\t\t\t\t\t\t\t\t\t\t}\tcatch\t(Exception\te)\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\te.printStackTrace();\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t}\n\npublic\tList<GeoLocation>\tgetGeoLocations()\t{\t \t\t\t\t\t\t\t\t\t\t\t\treturn\tCollections.unmodifiableList(geolocations);\t \t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t}\n\nNow\tthat\tour\tcode\tis\tready,\tlet's\tgo\tahead\tand\ttest\tthe\tapplication.\tStart\tyour application\tGeoLocationApplication.java\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tNow\tissue\tthe\tfollowing\tcURL\tcommand\tto\tcreate\ta\tgeolocation:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t\t\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\t\t\t \"latitude\":\t41.803488,\"longitude\":-88.144040}'\t http://localhost:8080/geolocation\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\t(output\thas\tbeen\tpretty\tprinted for\treadability\tpurposes):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nAlso,\tthis\tshould\thave\tcreated\tthe\tdata\tfile\tat\toptpackt/geolocation/data",
      "content_length": 1653,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 195,
      "content": "directory.\tLet's\tgo\tahead\tand\tverify\tthat.\tIssue\tthe\tfollowing\tcommand\tto\tlook\tat the\tcontents\tof\tthe\tdata\tfile:\n\ncat\toptpackt/geolocation/data/userf1196aac-470e-11e6-beb8\t -9e71128cae77_t1468203975\n\nThis\tshould\thave\tgiven\tyou\tan\toutput\tsimilar\tto\t(output\thas\tbeen\tpretty\tprinted for\treadability\tpurposes):\n\n{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t\t\t\t\t}\n\nNow\tthat\tour\tcode\tworks\tgreat,\tthe\tnext\tsteps\tare:\n\n1.\t Build\tthe\tproject\tto\tgenerate\ta\tnew\tJAR\tartifact. 2.\t Creating\ta\tnew\tDocker\tImage\tas\tour\tcode\thas\tchanged. 3.\t Upload\tthe\tnew\timage\tto\tDocker\tHub. 4.\t Redeploy\tthe\tnew\timage\twith\tenvironment\tvariable. 5.\t Verify\tif\tthe\tenvironment\tvariable\tis\tbeing\tused.\n\nGo\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand.\tThis should\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe\ttarget directory.\n\nBefore\twe\tbuild\tthe\tnew\timage,\tlet's\tgo\tahead\tand\tremove\tthe\texisting\timage that\twe\talready\thave.\tTo\tdo\tthat\tgo\tahead\tand\trun\tthe\tfollowing\tcommand:\n\ndocker\trmi\tvikrammurugesan/geolocation\n\nTo\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\nPlease\tuse\tyour\taccount\tname\tinstead\tof\tthe\tauthor's\tin\tthe\tpreceding commands.\tAfter\tyour\timage\thas\tbeen\tbuilt,\tgo\tahead\tand\tpush\tyour\tDocker image\tto\tthe\tDocker\tHub\tusing\tthe\tfollowing\tcommand.\tYou\tmight\tbe\tasked\tto log\tin\tto\tyour\tDocker\tHub\taccount\tif\tyou\thaven't\talready\tdone\tso.",
      "content_length": 1561,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 196,
      "content": "docker\tpush\tvikrammurugesan/geolocation\n\nAgain\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe\timage has\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe\t\"Last Updated\"\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent.\tNow\tthat\tour\timage is\tready\tto\tbe\tused,\tlet's\tgo\tahead\tand\tspin\toff\tour\tmicroservice\ton\tMesos\tusing Marathon.\tMake\tsure\tyour\tMesos\tcluster\tis\tup\tand\trunning.\tIf\tit\tis\tdown,\tplease kill\tyour\tcluster\tand\tstart\tit\tagain.\tOnce\tyour\tcluster\tis\tback\tup,\tgo\tahead\tand open\tup\tMarathon\tweb\tUI\ton\tyour\tbrowser.\tClick\ton\tthe\tCreate\tApplication button\tand\tgo\tto\tthe\tJSON\tmode.\tWe\twill\tbe\tusing\tthe\tJSON\tmode\tto\tquickly populate\tthe\tmodal.\tIn\tthe\tJSON\tmode,\tdelete\tthe\texisting\tJSON\tand\tpaste\tthe following\tJSON.\n\n{\t \t\t\t\t\t\t\t\t\t\t\"id\":\t\"geolocation\",\t \t\t\t\t\t\t\t\t\t\t\"cmd\":\tnull,\t \t\t\t\t\t\t\t\t\t\t\"cpus\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"mem\":\t512,\t \t\t\t\t\t\t\t\t\t\t\"disk\":\t1024,\t \t\t\t\t\t\t\t\t\t\t\"instances\":\t1,\t \t\t\t\t\t\t\t\t\t\t\"container\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\"type\":\t\"DOCKER\",\t \t\t\t\t\t\t\t\t\t\t\t\t\"docker\":\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"image\":\t\"vikrammurugesangeolocation\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"network\":\t\"BRIDGE\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"portMappings\":\t[\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"containerPort\":\t8080,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"hostPort\":\t0,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"servicePort\":\t8899,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"protocol\":\t\"tcp\",\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"labels\":\t{}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"privileged\":\tfalse,\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"parameters\":\t[],\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\"forcePullImage\":\tfalse\t \t\t\t\t\t\t\t\t\t\t\t\t}\t \t\t\t\t\t\t\t\t\t\t}\t \t}\n\nNow\tflip\tback\tto\tthe\tfriendly\tform\tview\tand\tgo\tto\tthe\tEnvironment\tVariables section.\tIn\tthe\tenvironment\tvariables\tsection,\tadd\tthe\tfollowing\tentry\tand\thit Create\tApplication.",
      "content_length": 1667,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 197,
      "content": "Key:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nTo\tverify\tif\tthe\tenvironment\tvariable\thas\tcreated\tcorrectly,\tgo\tahead\tand\ttake\ta look\tat\tthe\tConfiguration\tsection\tof\tthe\tapplication\ton\tMarathon.\tYou\tshould see\tsomething\tlike\tthis:\n\nAs\ta\tnext\tstep,\tlet's\tgo\tahead\tand\tcreate\ttwo\tgeolocations\tusing\tthe\tPOST\tAPI",
      "content_length": 327,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 198,
      "content": "and\tverify\tif\tthe\tfiles\twere\tcreated\ton\tthe\tright\tdirectory\tof\tthe\tcontainer.\tGo ahead\tand\tissue\tthe\tfollowing\ttwo\tcURL\tcommands\tone\tby\tone\ton\tyour\tterminal window:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t\t\t\t 1474843159,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:31758/geolocation curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1474843900,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t42.803488,\t\"longitude\":\t-87.144040}'\t http://192.168.99.100:31758/geolocation\n\nPlease\tnote\tthat\tthe\tport\tnumber\tof\tthe\tcontainer\tmight\tbe\tdifferent\ton\tyour installation.\tIn\tthe\tpreceding\tcommand\twe\thave\tused\t31758\tas\tthat's\twhat Marathon\tuses\tfor\tthis\tinstance.\tNow\tissue\tthe\tfollowing\tdocker\texec command\tto\tverify\tthe\tcontents\tof\tthe\tdata\tdirectory\tinside\tthe\tcontainer:\n\ndocker\texec\t1d52a2617a8e\tls\toptpackt/geolocation/data\n\nThis\tshould\tshow\tsomething\tlike\tthis:\n\nuserf1196aac-470e-11e6-beb8-9e71128cae77_t1474843159 userf1196aac-470e-11e6-beb8-9e71128cae77_t1474843900\n\nAgain\tnote\tthe\tcontainer\tID\tin\tthe\tpreceding\tcommand.\tPlease\tfind\tyour container's\tID\tusing\tthe\tdocker\tps\tcommand\tand\tuse\tthat\tcontainer\tID\tin\tthe preceding\tcommand.\n\nWith\tthat\tsaid\twe\tnow\tknow\thow\tto\tconfigure\tenvironment\tvariables\tin Marathon.\tThough\twe\tdon't\thave\ta\tsolid\tuse\tcase\tof\tthe\tenvironment\tvariable\tin this\texample,\twe\twill\tbe\tusing\tenvironment\tvariables\theavily\tin\tour\tfuture chapters.",
      "content_length": 1507,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 199,
      "content": "Scaling\tyour\tmicroservice\tin Marathon\n\nOne\tof\tthe\tmost\timportant\tdesign\tdecisions\tin\tbuilding\ta\tmicroservice\tis scalability.\tIf\tyour\tmicroservice\tis\tnot\tscalable,\tthere\tis\tno\tpoint\tin\tdeploying\tit as\ta\tmicroservice;\tit\tcould\tin\tfact\tbe\ta\thuge\tmonolithic\tapplication.\tThere\tare several\tways\tto\tscale\ta\tmicroservice.\tIt\talso\tdepends\ton\tthe\ttransport\ttype\tyour microservice\tuses.\tIf\tyour\tmicroservice\tuses\tHTTP,\tyou\tshould\tconsider\tload- balancing\tyour\tHTTP\tendpoints\tin\tvarious\tinstances\tof\tyour\tmicroservice. Another\tapproach\tis\tusing\tan\tasynchronous\tmessaging\tsystem,\tsuch\tas ActiveMQ,\tKafka,\tRabbitMQ,\tand\tZeroMQ.",
      "content_length": 614,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 200,
      "content": "Getting\tready\n\nThe\tgeolocation\tmicroservice\tuses\tRESTful\tAPIs\tto\texpose\tits\tendpoints.\tWe should\tbe\tconsidering\tload-balancing\ttools\tto\tload-balance\tthe\tendpoints\tacross instances\tof\tthe\tgeolocation\tapplication.\tIn\torder\tto\tscale\tour\tapplication,\tlet's first\tbring\tup\tthe\tMarathon\tweb\tinterface.",
      "content_length": 295,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 201,
      "content": "How\tto\tdo\tit... 1.\t Once\tthe\tMarathon\tweb\tUI\tis\tup\tand\trunning,\tdeploy\tthe\tapplication\tif\tit\tis not\talready\trunning.\tInstead\tof\trunning\tthe\tapplication\tfrom\tthe\tCreate Application\tmodal,\tusing\tJSON\tmode\tis\talways\tquicker\tand\tsimpler.\tUse the\tfollowing\tJSON\tto\tcreate\tyour\tapplication:\t{\t\"id\":\t\"geolocation\", \"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t1024,\t\"instances\":\t1, \"container\":\t{\t\"type\":\t\"DOCKER\",\t\"volumes\":\t[\t{\t\"containerPath\": \"opt/packt/geolocation/data\",\t\"hostPath\":\t\"optpackt/geolocation/data\", \"mode\":\t\"RW\"\t}\t],\t\"docker\":\t{\t\"image\":\t\"vikrammurugesan/geolocation\", \"network\":\t\"BRIDGE\",\t\"portMappings\":\t[\t{\t\"containerPort\":\t8080, \"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t], \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\t}\t}\n\n2.\t After\tthe\tgeolocation\tapplication\tstarts,\tclick\ton\tthe\tapplication\tfrom\tthe applications\tgrid,\tand\tgo\tto\tthe\tgeolocation-specific\tpage.\tThere,\tyou should\tsee\tthe\tScale\tApplication\tbutton.\tClick\ton\tit.\tIt\tshould\topen\ta modal\tlike\tthis:\n\nChoose\t4\tfrom\tthe\tdropdown\tand\thit\tScale\tApplication.\tYou\tshould\tnow\tsee\n\nthat\tMarathon\thas\tdeployed\tthe\tapplication\tas\tfour\tdifferent\tinstances,\teach exposing\tdifferent\tports:",
      "content_length": 1203,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 202,
      "content": "If\tyou\twould\tlike\tto\tverify\tthat\tthe\tapp\tis\trunning\ton\tthese\tports,\ttest\tthem\tone by\tone\tusing\tthe\tcurl\tcommand.\tIf\tyou\tdo\tnot\thave\tenough\tresources\tin\tyour cluster,\tscaling\tmight\tnot\twork.\tPlease\ttry\tincreasing\tthe\tresources\tby\trecreating your\tDocker\tMachine\tVM.\n\nAll\tthis\ttime,\twe\thave\tbeen\tinterfacing\twith\tthe\tMarathon\tweb\tUI.\tFor\ta change,\tlet's\tlook\tat\tthe\tMesos\tweb\tUI\tat\thttp://192.168.99.100:5050.\tYou should\tsee\tthat\tthere\tare\tfour\tdifferent\ttasks\trunning,\teach\tof\tthem\tindicating\tthe various\tgeolocation\tinstances:\n\nWe\tjust\tlearned\thow\tto\tscale\tup\tapplications\tusing\tMarathon.\tLet's\tsay\tyou would\tlike\tto\tscale\tthe\tgeolocation\tapplication\tback\tto\tjust\tone\tinstance;\tin\tother words,\tscale\tit\tdown.\tYou\tcan\tuse\tthe\tsame\tScale\tApplication\tmodal\tto\tscale\tit down\tto\t1\tinstance.\tAfter\tyou\tscale\tit\tdown,\tyou\tshould\tnow\tsee\tthat\tthere\tis only\tone\tinstance\tof\tthe\tapplication\trunning.\tYou\thave\tno\tcontrol\tover\twhich",
      "content_length": 919,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 203,
      "content": "three\tout\tof\tthe\tprevious\tfour\twill\tget\tdestroyed.\tThis\tdecision\tis\tmade\tby\tMesos based\ton\tthe\tresource\tavailability\ton\tthe\tMesos\tslaves:\n\nNow\tgo\tback\tto\tthe\tMesos\tweb\tinterface,\tand\tyou\twill\tnotice\tthat\tthree\ttasks\n\nare\tin\tKILLED\tstatus:",
      "content_length": 238,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 204,
      "content": "Destroying\tyour\tmicroservice\tin Marathon\n\nThere\tmight\tbe\ttimes\tyou\twant\tto\tdestroy\ta\tmicroservice\tor\tapplication\tthat\tis already\trunning\ton\tMarathon\teither\tbecause\tyou\twant\tto\tfree\tup\tsome\tresources or\tbecause\tyou\twould\tlike\tto\tredeploy\tthe\tapplication\twith\ta\tdifferent\tset\tof Marathon\tconfigurations.\tThis\tcan\tbe\teasily\tachieved\tfrom\tthe\tapplication- specific\tpage\tin\tMarathon.",
      "content_length": 378,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 205,
      "content": "Getting\tready\n\nOpen\tthe\tMarathon\tweb\tinterface\tin\tyour\tbrowser,\tand\tnavigate\tto\tthe geolocation\tapplication\tpage.\tIf\tyou\tdon't\thave\tthe\tapplication\tup\tand\trunning, use\tJSON\tmode\tand\tdeploy\tthe\tapplication\tusing\tthe\tJSON\tthat\twas\tused\tin previous\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon.",
      "content_length": 291,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 206,
      "content": "How\tto\tdo\tit... 1.\t Marathon\tapplications\tcan\teither\tbe\tsuspended\tor\tdestroyed.\tSuspended\n\napplications\tcan\tbe\tredeployed,\twhile\tdestroyed\tapplications\tcannot.\tClick on\tthe\tbutton\tthat\tlooks\tlike\ta\tgear.\tThis\tbutton\thas\ttwo\toptions:\tSuspend and\tDestroy.\tLet's\ttry\tto\tsuspend\tthe\tapplication:\n\nAs\tyou\tcan\tsee,\tthe\tstatus\tof\tthe\tapplication\tis\tmarked\tas\tSuspended,\tand\tthere are\tno\tactive\tinstances\tof\tthe\tapplication\trunning.\tIn\torder\tto\tredeploy\tthe application,\twe\twill\thave\tto\tscale\tit.\n\nScale\tthe\tapplication\tusing\tthe\tScale\tApplication\tmodal\twith\ta\tscaling\tfactor\n\nof\t1.\tWithin\ta\tfew\tseconds,\tyou\tshould\tsee\ta\tbrand\tnew\tinstance\tof\tthe geolocation\tapplication\tup\tand\trunning.\tThe\tSuspend\toption\tis\toften\tused\tto temporarily\tbring\tdown\ta\tservice.\tWhen\tyou\tsuspend\tyour\tapplication, Marathon\tsaves\tthe\tconfigurations\tof\tyour\tapplication\tso\tthat\tyou\tcan\tbring\tit back\tup\twith\tthe\tsame\tset\tof\tconfigurations\twithout\thaving\tto\tre-enter\tthem.\n\nThe\tnext\toption\twe\tare\tinterested\tin\tis\tDestroy.\tUnlike\tSuspend,\tthe\tDestroy\n\noption\tremoves\tthe\tapplication\tand\tits\tconfigurations\tcompletely\tfrom Marathon.\tLike\twe\tsaw\tearlier,\tyou\tmay\twant\tto\tdestroy\tyour\tapplication\teither to\tfree\tup\tsome\tresources\tor\tredeploy\tthe\tapplication\twith\ta\tnew\tset\tof configurations.\n\nGo\tahead\tand\tclick\ton\tthe\tgear\tbutton,\tand\tthen\thit\tthe\tDestroy\tbutton. Marathon\twill\task\tyou\tfor\tconfirmation\tas\tyou\tcannot\trecover\tfrom\tthis\tstep:",
      "content_length": 1406,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 207,
      "content": "If\tyou\tconfirm\tthat\tyou\twould\tlike\tto\tdestroy\tthe\tapplication,\tyou\twill\tbe\ttaken to\tthe\tMarathon\tmain\tscreen,\tand\tyou\twill\tnot\tsee\tany\tapplications\trunning:",
      "content_length": 156,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 208,
      "content": "Monitoring\tyour\tmicroservice\tlogs\tin Marathon\n\nSo\tfar,\twe\thave\tlearned\thow\tto\tdeploy,\tscale,\tsuspend,\tand\tdestroy\tour microservice\tin\ta\tMesos\tcluster\tusing\tMarathon.\tAll\tthese\tsteps\tare\tpart\tof\tyour deployment\tprocess,\tbut\tthere\tis\tone\tthing\tyou\twould\twant\tto\tdo\tpost deployment:\tmonitor\tthe\tlogs.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tmonitor\tour application\tlogs\tusing\tMarathon.",
      "content_length": 381,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 209,
      "content": "Getting\tready\n\nFortunately,\tthere\tis\tan\teasy\tway\tto\tlook\tat\tyour\tapplication's\tlog\tfiles\tusing Marathon's\tweb\tinterface.\tThough\tit\tis\tnot\tvery\tuser\tfriendly,\tit\tis\tstill\tpossible. To\tillustrate\tthis,\tlet's\tdeploy\tthe\tgeolocation\tmicroservice\tusing\tMarathon.\tIf you\thave\tto\trestart\tyour\tMesos\tcluster,\tdo\tso.\tIn\tMarathon,\tuse\tJSON\tmode\tand the\tJSON\tthat\twas\tused\tin\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon\tto deploy\tthe\tapplication.",
      "content_length": 436,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 210,
      "content": "How\tto\tdo\tit... 1.\t Once\tyour\tapplication\thas\tstarted,\tgo\tto\tthe\tgeolocation\tapplication's\tpage in\tMarathon.\tYou\twill\tsee\tthat\tone\tinstance\tof\tyour\tapplication\tis\trunning. Click\ton\tthe\trunning\tinstance\tof\tthe\tgeolocation\tapplication.\tYou\twill\tsee something\tlike\tthis:\n\nThe\tfirst\tsection,\tat\tthe\ttop,\tprovides\tinformation\tsuch\tas\tthe\thost\ton\twhich\tyour application\tis\tdeployed,\tthe\tIP\taddress\tof\tyour\tDocker\tcontainer,\tports\texposed, and\tendpoints\texposed.\tThe\tsection\tthat\treally\tmatters\tto\tus\tnow\tis\tWorking Directory.\tIt\tshows\ttwo\tfiles\there:\tstdout\tand\tstderr.\tBoth\tof\tthem\thave\tthe same\tpermissions,\trw/r/r.\n\nMarathon\tuses\tDocker's\tlogging\tbehavior\tto\tconsume\tand\tdisplay\tthe\tlogs. Any\tstandard\toutput\tlogged\tby\tthe\tDocker\tcontainer\tgoes\tinto\tstdout,\tand\tany standard\terror\tlogged\tby\tDocker\tcontainer\tgoes\tinto\tstderr.\tThe\tversion\tof Marathon\twe\tare\tusing\tdoes\tnot\tlet\tyou\tview\tthe\tlogs\ton\tthe\tscreen.\tThe\tonly way\tto\tlook\tat\tthem\tis\tto\tdownload\tthem\tfirst\tand\topen\tthem\twith\tyour\tpreferred editor.\n\nHit\tthe\tDownload\tbutton\ton\tstdout.\tThis\tshould\tdownload\tthe\t7\tKB\tfile.\n\nOpen\tthe\tdownloaded\tfile\twith\tyour\tpreferred\teditor.\tIn\tthe\tfollowing screenshot,\tI\thave\tused\tOS\tX's\tTextEdit\tapplication:",
      "content_length": 1198,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 211,
      "content": "As\tyou\tcan\tsee,\tthere\tare\tsome\tSpring\tBoot\tlogs\tin\tstdout.\tTowards\tthe\tend\tof the\tlogs,\tyou\tcan\tsee\tthe\tin-memory\tTomcat\tservice\tstarted\ton\tport\t8080 exposing\tour\tREST\tAPIs.\n\nSimilarly,\tdownload\tstderr\tand\ttake\ta\tlook\tat\tits\tcontents:\n\nThere\tare\tsome\tlog\tmessages\tfrom\tsome\tC++\tfiles,\tshowing\tthat\tthe\tDocker container\twas\tstarted.\n\nThough\tusing\tthe\tMarathon\tweb\tinterface\tto\tview\tlogs\tis\tnot\tvery\tconvenient,\tit",
      "content_length": 412,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 212,
      "content": "is\tone\tstep\ttoward\tviewing\tyour\tlogs.\tIn\tthe\tfuture,\twe\tcan\texpect\ta\tmore sophisticated\tinterface\tfrom\tMarathon.\tThe\tintended\tuse\tof\tWorking\tDirectory is\twhen\tyou\twould\tlike\tto\texpose\tsome\tresource\tfiles\tused\tby\tyour\tapplication. In\tour\tgeolocation\tapplication,\twe\tdo\tnot\thave\tany\tfiles\tin\tthe\tworking\tdirectory.",
      "content_length": 312,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 213,
      "content": "Monitoring\tyour\tmicroservice\tlogs\tin Mesos\n\nWe've\talready\tseen\tthat\tviewing\tlogs\tin\tMarathon\tis\tnot\tvery\teasy.\tOftentimes, you\twill\twant\tto\tperform\tmore\tadvanced\toperations,\tsuch\tas\ttailing\tlogs, viewing\tlogs\ton\tscreen,\tor\tviewing\tmultiple\tlogs\tat\tthe\tsame\ttime.\tFortunately, you\tcan\tdo\tthis\tusing\tMesos.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tmonitor application\tlogs-in\tother\twords,\ttask\tlogs-using\tthe\tMesos\tweb\tUI.",
      "content_length": 416,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 214,
      "content": "Getting\tready\n\nTo\tcheck\tthis\tout,\tdeploy\tthe\tgeolocation\tmicroservice\tusing\tMarathon.\tIf\tyou have\tto\trestart\tyour\tMesos\tcluster,\tdo\tso.\tIn\tMarathon,\tuse\tJSON\tmode\tand\tthe JSON\tthat\twas\tused\tin\trecipe\tScaling\tyour\tMicroservice\tin\tMarathon\tto\tdeploy the\tapplication.",
      "content_length": 264,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 215,
      "content": "How\tto\tdo\tit... 1.\t Once\tyour\tapplication\thas\tstarted,\tgo\tto\tthe\tMesos\tweb\tinterface\tusing\tthe URL\thttp://192.168.99.100:5050,\tand\tverify\tthat\tyour\tapplication's\ttask is\trunning:\n\nFrom\tthe\tpreceding\tscreenshot,\tyou\tcan\tsee\tthat\tthere\tis\tone\tactive\ttask\tand several\tcompleted\ttasks\tfor\tthe\tgeolocation\tmicroservice.\tThe\tcompleted\ttasks were\tfrom\tprevious\texecutions,\tand\tthe\trunning\ttask\tis\tthe\tone\tthat\twe\tare concerned\tabout.\tIn\tfact,\tyou\tcan\tstill\tlook\tat\tthe\tlogs\tof\tthe\tcompleted\ttasks,\tbut in\tthis\trecipe,\twe\twill\tbe\tlooking\tat\tthe\tactive\ttask's\tlogs,\tas\tthe\tsteps\tare\texactly the\tsame.\tIn\tActive\tTasks,\tthere\tis\ta\thyperlink\tcalled\tSandbox.\tClick\ton\tit.\tYou should\tsee\ta\tscreen\tthat\tdisplays\ttwo\titems:\tstdout\tand\tstderr.",
      "content_length": 726,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 216,
      "content": "This\tis\tpretty\tmuch\tthe\tsame\tthing\twe\tsaw\tin\tMarathon.\tYou\tcan\tdo\ttwo\tthings: either\tdownload\tthe\tlogs\tusing\tthe\tDownload\tbutton\tand\ttake\ta\tlook\tat\tthem using\tyour\tfavorite\ttext\teditor,\tor\ttail\tthe\tlogs\tby\tclicking\ton\tthe\tfile\tnames.\n\nGo\tahead\tand\tclick\ton\tstdout.\tYou\twill\tsee\tthat\ta\tpopup\twindow\topens\tup\n\nwith\tthe\tcontents\tof\tstdout:\n\nA\tgreat\tadvantage\tof\tthis\tview\tis\tthat\tit\tconstantly\ttails\tany\tnew\tstdout\tcalls. You\tcan\tkeep\tthis\twindow\topen\tto\tlook\tat\tthe\tlive\tlogs\tas\tthey\tcome.\n\nSimilarly,\tclick\ton\tstderr\tto\tlook\tat\tthe\tcontents\tof\tstderr:\n\nThe\ttailing\tfeature\tis\tespecially\thelpful\twhen\tyou\tare\tmonitoring\tlogs\tof multiple\tapplications.\tKeep\tin\tmind\tthat\tthis\tis\ta\tfeature\tof\tMesos,\tand\tMesos lets\tyou\tlook\tat\tlogs\ton\ttasks\tdeployed\tusing\tany\tframework:\tSpark,\tChronos, Marathon,\tAurora,\tCassandra,\tand\tso\ton.\n\nIn\tthis\trecipe,\twe\tlearned\ttwo\tways\tof\tmonitoring\tthe\tlogs\tof\tapplications\tthat are\tdeployed\tin\tMarathon.\tWith\tthis\trecipe,\tyou\thave\tfinished\tlearning\tthe\tbasics",
      "content_length": 984,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 217,
      "content": "are\tdeployed\tin\tMarathon.\tWith\tthis\trecipe,\tyou\thave\tfinished\tlearning\tthe\tbasics of\tMesos\tand\tMarathon.\tYou\tcan\tnow\tstart\tplaying\taround\twith\tMesos\tand Marathon\tto\tfit\tyour\tneeds.",
      "content_length": 180,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 218,
      "content": "Managing\tyour\tmicroservice\tusing Marathon's\tREST\tAPI\n\nMarathon's\tweb\tinterface\tis\tdefinitely\tone\tof\tthe\tbest\tuser\tinterfaces.\tIt\tis\tvery intuitive\tand\tsophisticated.\tSo\tfar,\twe\thave\tbeen\tusing\tthe\tweb\tinterface\tbecause it\twas\tthe\teasiest\tway\tto\tget\tyou\tup\tto\tspeed.\tUsing\tthe\tweb\tinterface\tmight\tnot be\tscalable\twhen\tyou\tare\tdealing\twith\thundreds\tof\tmicroservices,\tthough.\tMesos and\tMarathon\tare\tnow\tproduction\tready.\tIn\tfact,\ta\tlot\tof\torganizations\thave\tbeen using\tMesos\tand\tMarathon\tto\tdeploy\thundreds\tof\tmicroservices.\tIn\tthis\trecipe, we\twill\tlook\tat\thow\tto\tdeploy\tmicroservices\tin\tMarathon\tusing\tits\tREST\tAPI. This\tenables\tyou\tto\timplement\tcontinuous\tdeployments.\n\nContinuous\tdeployments\thave\tbeen\tpicking\tup\ttraction\tlately.\tContinuous deployment\tis\ta\tprocess\tin\twhich\tyou\tdeploy\tyour\tapplication\tto\tproduction\tas soon\tas\tit\thas\tbeen\tchecked\tin,\tpackaged,\ttested,\tand\tvalidated.\tOrganizations use\tcontinuous\tintegration\t(CI)\ttools\tsuch\tas\tJenkins,\tHudson,\tBamboo,\tand Travis\tCI\tto\tautomate\ttheir\tdeployments.\tIf\tyou\thave\tthe\tright\tset\tof\ttest\tcases and\tthe\tright\ttools\tto\tvalidate\tand\tautomate\tyour\ttests,\tyou\tcan\tconfidently deploy\tyour\tapplication\tafter\tit\thas\tbeen\ttested\tand\tvalidated.\tWith\tthe\trecent improvements\tin\tthe\taforementioned\ttools,\tit\tis\tnow\tpossible\tto\tautomate deployments\teasily.\tBefore\tMesos\tor\tKubernetes,\tdeployments\twere\tdone\tusing build\tframeworks\tsuch\tas\tMaven,\tGradle,\tand\tAnt.\tOne\tsuch\texample\tis\tthe Cargo\tplugin.\tThe\tCargo\tplugin\tfor\tMaven,\tAnt,\tand\tGradle\tcan\tdeploy\tyour artifacts\tto\tseveral\tweb\tand\tapplication\tservers,\tincluding\tbut\tnot\tlimited\tto Tomcat,\tWildFly,\tGlassfish,\tWeblogic,\tand\tWebsphere.\tIf\tyou\thave\tused\tthe Cargo\tplugin,\tyou\twill\tknow\tthat\tit\tis\tnot\tvery\teasy\tto\tconfigure.",
      "content_length": 1726,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 219,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tuse\tthe\tvarious\tRESTful\tAPIs\tof\tMarathon. This\twill\tbe\tparticularly\tuseful\twhen\tyou\tare\tautomating\tyour\tdeployments\tto Mesos\tand\tMarathon.\tBefore\twe\tstart\tthis\trecipe,\tlet's\trebuild\tthe\tMesos\tcluster. As\tour\tMesos\tcluster\tis\tDockerized,\tI\tsuggest\tyou\trestart\tthe\tcluster\tevery\tonce in\ta\twhile.\tThis\tis\tbecause,\tsometimes\tthe\tcontainers\ttend\tto\trun\tout\tof resources.\tHowever\tyou\tdon't\thave\tto\tworry\tabout\tthis\tin\tproduction\tif\tyou\thave sufficient\tresources.\tOnce\tyour\tcluster\tis\tup\tand\trunning,\topen\tthe\tMarathon web\tinterface\tin\ta\tbrowser.\tWe\twill\tbe\tusing\tthe\tterminal\tto\thit\tMarathon's\tAPI using\tcurl\tcommands.\tSo\tkeep\ta\tterminal\twindow\topen\tall\tthe\ttime.",
      "content_length": 709,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 220,
      "content": "How\tto\tdo\tit...\n\nIn\tthis\trecipe,\twe\twill\tbe\tlooking\tat\tseveral\tMarathon\tREST\tAPIs\tthat\tlet\tyou:\n\nDeploy\tan\tapplication Scale\tan\tapplication List\tall\tinstances\tof\ta\tgiven\tapplication Destroy\tan\tapplication\n\n1.\t First,\tlet's\ttake\ta\tlook\tat\thow\twe\tcan\tdeploy\tthe\tgeolocation\tapplication using\tMarathon's\tREST\tendpoint.\tAll\tthe\tapplication-related\tAPIs\tare\tlisted under\tthe\t/apps\tdomain.\tThe\tmost\trecent\tversion\tof\tthe\tMarathon\tREST endpoints\tis\tv2.\tHence,\tthe\t/apps\tdomain\tAPIs\tare\tlisted\tunder\tthe\tpath v2apps.\tTo\tcreate\ta\tnew\tapplication\ton\tMarathon,\tall\tyou\thave\tto\tdo\tis POST\tthe\tJSON\trepresentation\tof\tyour\tapplication\tto\tthe\tURL http://192.168.99.100:8080v2apps.\n\nThe\tschema\tfor\tthis\tJSON\tis\texactly\tthe\tsame\tone\twe\tused\tin\tJSON\tmode from\tprevious\trecipes:\t{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"instances\":\t1,\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}",
      "content_length": 1009,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 221,
      "content": "],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n}\n\n}\n\n2.\t As\twe\twill\tbe\tusing\tcurl\tas\tour\tclient,\tlet's\tmake\tthe\twhole\tJSON\twrap into\tone\tsingle\tline.\tYou\tcan\tuse\tyour\tfavorite\ttext\teditor\tto\tdo\tthis.\tThe final\tcurl\tcommand\twill\tlook\tsomething\tlike\tthis: curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"id\":\t \"/geolocation\",\t\"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t 1024,\t\"instances\":\t1,\t\"container\":\t{\"type\":\t\"DOCKER\",\t \"volumes\":\t[{\"containerPath\":\t\"optpackt/geolocation/data\",\t \"hostPath\":\t\"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"}\t],\t \"docker\":\t{\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t \"BRIDGE\",\t\"portMappings\":\t[{\"containerPort\":\t8080,\t\"hostPort\":\t 0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t],\t \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t }\t}\t}'\thttp://192.168.99.100:8080v2apps\n\n3.\t You\tshould\tget\ta\tresponse\tsaying\tyour\tapplication\thas\tbeen\tqueued\tfor deployment\t(pretty-printed\tfor\treadability):\n\n{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,",
      "content_length": 1219,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 222,
      "content": "\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"args\":\tnull,\n\n\"user\":\tnull,\n\n\"env\":\t{},\n\n\"instances\":\t1,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"executor\":\t\"\",\n\n\"constraints\":\t[],\t\"uris\":\t[],\n\n\"fetch\":\t[],\n\n\"storeUrls\":\t[],\n\n\"ports\":\t[\n\n8899\n\n\"portDefinitions\":\t[\n\n\"port\":\t8899,\n\n\"protocol\":\t\"tcp\",\t\"labels\":\t{}\n\n],\n\n{\n\n}\n\n],",
      "content_length": 316,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 223,
      "content": "\"requirePorts\":\tfalse,\t\"backoffSeconds\":\t1,\t\"backoffFactor\":\t1.15, \"maxLaunchDelaySeconds\":\t3600,\t\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n},\n\n\"healthChecks\":\t[],\t\"readinessChecks\":\t[],\t\"dependencies\":\t[], \"upgradeStrategy\":\t{\n\n\"minimumHealthCapacity\":\t1,\t\"maximumOverCapacity\":\t1\n\n},\n\n\"labels\":\t{},",
      "content_length": 678,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 224,
      "content": "\"acceptedResourceRoles\":\tnull,\t\"ipAddress\":\tnull,\t\"version\":\t\"2016-09- 26T02:03:43.284Z\",\t\"residency\":\tnull,\t\"tasksStaged\":\t0,\n\n\"tasksRunning\":\t0,\t\"tasksHealthy\":\t0,\t\"tasksUnhealthy\":\t0,\t\"deployments\": [\n\n{\n\n\"id\":\t\"6f569b52-181f-4909-974a-23666d7a2c6f\"\n\n}\n\n],\n\n\"tasks\":\t[]\n\n}\n\n4.\t Go\tto\tMarathon\tand\tmake\tsure\tthat\tyour\tapplication\tis\tup\tand\trunning. 5.\t Now\tlet's\tscale\tour\tapplication\tto\ta\tfactor\tof\t2.\tTo\tdo\tthis,\twe\twill\tuse\tthe PUT\tmethod\tand\tthe\tpath\tv2apps/geolocation,\twhere\t/geolocation\tis\tthe unique\tID\tof\tour\tapplication\tin\tMarathon.\tIf\tyou\tlook\tat\tthe\tfollowing request\tbody,\tit\tis\texactly\tthe\tsame\tas\tthe\tprevious\trequest,\texcept\tfor\tthe number\tof\tinstances.\tHere,\twe've\tset\tthe\tvalue\tof\tinstances\tto\t2:\n\n{\n\n\"id\":\t\"/geolocation\",\t\"cmd\":\tnull,\n\n\"cpus\":\t1,\n\n\"mem\":\t512,\n\n\"disk\":\t1024,\n\n\"instances\":\t2,\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[",
      "content_length": 860,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 225,
      "content": "{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}\n\n}\n\n}\n\n6.\t Go\tahead\tand\texecute\tthe\tfollowing\tcurl\tcommand:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPUT\t-d\t'{\"id\":\t \"/geolocation\",\t\"cmd\":\tnull,\t\"cpus\":\t1,\t\"mem\":\t512,\t\"disk\":\t 1024,\t\"instances\":\t2,\t\"container\":\t{\"type\":\t\"DOCKER\",\t \"volumes\":\t[{\"containerPath\":\t\"optpackt/geolocation/data\",\t \"hostPath\":\t\"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"}\t],\t \"docker\":\t{\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t \"BRIDGE\",\t\"portMappings\":\t[{\"containerPort\":\t8080,\t\"hostPort\":\t 0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\",\t\"labels\":\t{}\t}\t],\t \"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t }\t}\t}'\thttp://192.168.99.100:8080v2apps/geolocation\n\nYou\tshould\thave\treceived\ta\tresponse\tsimilar\tto\tthis,\tindicating\tthe",
      "content_length": 1100,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 226,
      "content": "You\tshould\thave\treceived\ta\tresponse\tsimilar\tto\tthis,\tindicating\tthe deployment\tID\tfor\tthe\trequest\t(pretty-printed\tfor\treadability):\t{\n\n\"version\":\t\"2016-09-26T02:09:51.476Z\",\t\"deploymentId\":\t\"1eb0ae12-8ce9- 497a-b0df-0e07261e993a\"\n\n}\n\n7.\t Now\tif\tyou\tgo\tto\tMarathon,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tinstances\tof geolocation\tshowing\tup\tas\trunning:\n\n8.\t You\tcan\tscale\tdown\tthe\tapplication\tby\tposting\tthe\tsame\tPUT\trequest\twith\ta scaling\tfactor\tof\t1.\tYou\tmight\twant\tto\tlist\tdown\tthe\tinstances\tthat\tare running\tfor\tthe\tgiven\tapplication.\tYou\tcan\tdo\tthat\tby\tusing\tthe\tGET\tmethod and\tURL\tpath\tv2apps/geolocation.\tExecute\tthe\tfollowing\tcurl\tcommand on\tyour\tconsole: curl\thttp://192.168.99.100:8080v2apps/geolocation\n\n9.\t You\tshould\tget\tthe\tfollowing\tresponse,\tindicating\tthat\ttwo\tinstances\tof\tthe same\tapplication\tare\trunning\tin\tMarathon\t(parts\tof\tthe\tresponse\thave\tbeen",
      "content_length": 860,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 227,
      "content": "truncated\tfor\treadability):\n\n{\n\n\"app\":\t{\n\n\"id\":\t\"/geolocation\",\t.\n\n.\n\n.\n\n\"container\":\t{\n\n\"type\":\t\"DOCKER\",\t\"volumes\":\t[\n\n{\n\n\"containerPath\":\t\"optpackt/geolocation/data\",\t\"hostPath\": \"optpackt/geolocation/data\",\t\"mode\":\t\"RW\"\n\n}\n\n],\n\n\"docker\":\t{\n\n\"image\":\t\"vikrammurugesan/geolocation\",\t\"network\":\t\"BRIDGE\", \"portMappings\":\t[\n\n{\n\n\"containerPort\":\t8080,\t\"hostPort\":\t0,\t\"servicePort\":\t8899,\t\"protocol\":\t\"tcp\", \"labels\":\t{}\n\n}\n\n],\n\n\"privileged\":\tfalse,\t\"parameters\":\t[],\t\"forcePullImage\":\tfalse\t}",
      "content_length": 491,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 228,
      "content": "},\n\n.\n\n.\n\n.\n\n\"tasksStaged\":\t0,\t\"tasksRunning\":\t2,\t\"tasksHealthy\":\t0,\t\"tasksUnhealthy\": 0,\t\"deployments\":\t[],\t\"tasks\":\t[\n\n{\n\n\"id\":\t\"geolocation.73ad18be-838d-11e6-9e4b-02423267746a\",\t\"slaveId\": \"be077ff3-9864-4517-8b49-e0f8fd66d977-S0\",\t\"host\":\t\"192.168.99.100\", \"state\":\t\"TASK_RUNNING\",\t\"startedAt\":\t\"2016-09-26T02:03:44.505Z\", \"stagedAt\":\t\"2016-09-26T02:03:43.601Z\",\t\"ports\":\t[\n\n31981\n\n],\n\n\"version\":\t\"2016-09-26T02:03:43.284Z\",\t\"ipAddresses\":\t[\n\n{\n\n\"ipAddress\":\t\"172.17.0.2\",\t\"protocol\":\t\"IPv4\"\n\n}\n\n],\n\n\"appId\":\t\"/geolocation\"\n\n},\n\n{\n\n\"id\":\t\"geolocation.4efe1dbf-838e-11e6-9e4b-02423267746a\",\t\"slaveId\": \"be077ff3-9864-4517-8b49-e0f8fd66d977-S0\",\t.",
      "content_length": 650,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 229,
      "content": ".\n\n.\n\n}\n\n]\n\n}\n\n}\n\n10.\t If\tyou\twould\tlike\tto\tdestroy\tthe\tgeolocation\tapplication\tcompletely,\tuse\tthe DELETE\tmethod\ton\tthe\tURL\tv2apps/geolocation.\tThe\tresponse\tof\tthe DELETE\trequest\tis\tusually\tsimilar\tto\tthat\tof\tthe\tGET\trequest,\tlisting\tthe application\tdetails\tand\tthe\ttasks\tthat\twere\tstopped\tby\tthis\tDELETE\trequest. Here's\tthe\tcommand: curl\t-X\tDELETE\thttp://192.168.99.100:8080v2apps/geolocation\n\nNote\n\nThere\tare\tseveral\tways\tof\timplementing\tcontinuous\tdeployment\tto Marathon\tfrom\ttools\tsuch\tas\tJenkins,\tHudson,\tand\tother\tCI\ttools.\tOne\tsuch option\tis\tdoing\tthe\tsame\tthing\twe\tdid\there:\tuse\tCURL.\tYou\tcan\twrite\tshell scripts\tthat\tdeploy\tthe\tapplication\tto\tMarathon\tusing\tthe\tcurl\tcommand after\tyour\tbuilds\tpass.\tThe\tother\tapproach\tis\twriting\tcustom\tbuild framework\tplugins,\tsuch\tas\tthe\tMaven\tMarathon\tor\tGradle\tMarathon plugins.\tI'll\tleave\tthat\tup\tto\tyou\tto\ttry\tout.\n\nTo\tlearn\thow\tto\twrite\ta\tMaven\tplugin,\ttake\ta\tlook\tat\tthis\tpage: https://maven.apache.org/guides/plugin/guide-java-plugin- development.html\t.\n\nTo\tlearn\thow\tto\twrite\ta\tGradle\tplugin,\ttake\ta\tlook\tat\tthis\tpage: https://docs.gradle.org/current/userguide/custom_plugins.html\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe\tand\tthe\tchapter.\tYou\tare\tnow\tready\tto manage\tyour\town\tMesos\tcluster\tand\tmanage\tyour\tapplications\ton\ta\tMesos cluster\tusing\tMarathon.\tGood\tluck\tusing\tMesos\tand\tMarathon!",
      "content_length": 1345,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 230,
      "content": "cluster\tusing\tMarathon.\tGood\tluck\tusing\tMesos\tand\tMarathon!",
      "content_length": 59,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 231,
      "content": "Chapter\t4.\tDeploying\tMicroservices on\tKubernetes\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tdeploy\tmicroservices\ton\tKubernetes,\twhich is\tan\topen\tsource\tframework\tfrom\tGoogle\tfor\torchestrating\tand\tmanaging containers.\tWe\twill\tcover\tthe\tfollowing\trecipes:\n\nSetting\tup\ta\tKubernetes\tcluster\tusing\tDocker Understanding\tthe\tKubernetes\tdashboard Deploying\tyour\tmicroservice\ton\tKubernetes Configuring\tports\tin\tKubernetes Configuring\tvolumes\tin\tKubernetes Configuring\tenvironment\tvariables\tin\tKubernetes Scaling\tyour\tmicroservice\tin\tKubernetes Destroying\tyour\tmicroservice\tin\tKubernetes Monitoring\tyour\tmicroservice\tlogs\tin\tKubernetes",
      "content_length": 621,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 232,
      "content": "Introduction\n\nBefore\twe\tjump\tinto\tthe\trecipes,\tit\tis\tvery\timportant\tthat\tyou\tknow\twhat Kubernetes\tis\tand\twhy\twe\tuse\tit\tto\tdeploy\tmicroservices.\n\nIf\tyou've\tread\tthe\tprevious\tchapter,\tyou\twill\tunderstand\twhy\twe\tneed\ta clustering\tframework\tlike\tMesos.\tJust\tas\tMesos\tis\ta\tclustering\tframework\tfrom the\tApache\tfoundation,\tKubernetes\tis\ta\tcontainerization\tplatform\tfrom\tGoogle that\tlets\tyou\torchestrate\tand\tmanage\tcontainers.\tIt\tis\tsimilar\tto\tthe\tMesos\tand Marathon\tcombo.\tIt\tcomes\twith\tall\tthe\tfeatures\tyou\twill\tneed\tto\tdeploy containers,\tsuch\tas\tscaling,\tload\tbalancing,\tdeploying,\tand\tmonitoring.\tOne more\tthing\tKubernetes\tdoes\tcompared\tto\tMesos\tis\tthat\tit\tlets\tyou\tdeploy\trkt containers.\tBut\twith\tMesos'\trecent\trelease,\tthey\thave\tadded\tunified\tcontainerizer support,\twhich\twill\tlet\tMesos\tdeploy\tnot\tjust\tDocker\tcontainers,\tbut\talso\trkt containers.\tRkt\t(pronounced\t\"rock\tit\")\twas\tinitially\tdeveloped\twith\tthe\tintent\tof providing\ta\tmuch\tmore\tsecured\tcontainerizing\tframework.\tOne\tthing\tto\tnote here\tis\tthat\trkt\tis\tan\timplementation\tof\tappc.\tIt\tis\tstrongly\trecommended\tthat you\tread\tabout\tappc\tbefore\tyou\tmove\ton\tto\tthe\tnext\tsection.\tWe\twill\tnot\tbe discussing\tappc\tas\tit\tis\tout\tof\tthe\tscope\tof\tthis\tbook\n\nNote\n\nTo\tlearn\tmore\tabout\tApp\tContainer\t(appc),\tvisit\ttheir\tGitHub\tspecifications page,\twhich\thas\tlot\tof\tuseful\tinformation,\tat\t\thttps://GitHub.com/appc/spec\t.\n\nWith\tthat\tsaid,\tyou\tshould\tnow\thave\tunderstood\tthat\tKubernetes,\tor\tK8s\t(the\t8 stands\tfor\tubernete)\twill\thelp\tus\tdeploy\tand\tmanage\tour\tmicroservices.\tThat's right;\tin\tthis\tchapter,\twe\twill\tlearn\thow\tto\twork\twith\ta\tKubernetes\tcluster.\n\nNow\tlet's\ttake\ta\tmoment\tto\tunderstand\tthe\tvarious\tcomponents\tthat\tmake\tup\tthe Kubernetes\tcluster.\tWe\twill\tnot\tbe\tgoing\tdeep\tinto\teach\tand\tevery\tcomponent\tof Kubernetes\tas\tit\tis\tout\tof\tscope\tfor\tthis\tbook.\tInstead,\twe\twill\tjust\ttry\tto understand\tthe\tvarious\tcomponents\tand\ttheir\tusage.\tSimilar\tto\tMesos, Kubernetes\talso\tfollows\ta\tmaster-slave\tarchitecture.\tSo,\tobviously,\tthere\tis\ta master\tthat\tis\tresponsible\tfor\tscheduling\tthe\tcontainers\ton\tto\tone\tor\tmore\tslaves. But\tunlike\tMesos,\tin\tKubernetes,\tcontainers\tare\torganized\tin\tsmaller\tmortal units\tcalled\tpods.\tPods\t(or\tcontainers\tin\tdifferent\tpods,\tto\tbe\tprecise)\tcan",
      "content_length": 2212,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 233,
      "content": "communicate\tusing\tservices.\tTake\ta\tlook\tat\tthe\tfollowing\tdiagram:",
      "content_length": 65,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 234,
      "content": "As\tyou\tcan\tsee,\ta\tsimple\tKubernetes\tcluster\tis\tcomposed\tof\tseveral\tcomponents. Let's\tbreak\tit\tdown\tinto\tmultiple\tcomponents\tand\tsee\twhat\tthey\tare\tused\tfor\tone by\tone.",
      "content_length": 166,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 235,
      "content": "Kubernetes\tmaster\n\nThe\tKubernetes\tmaster\tconsists\tof\tfour\tmajor\tsubcomponents\tthat\tenable\tthe functions\tof\ta\tKubernetes\tcluster.\tIn\tthe\tprevious\tdiagram,\twe\tonly\thave\tone master.\tBut\tin\tan\tideal\tproduction\tinfrastructure,\tit\tis\tnormal\tto\thave\tmultiple masters\tin\torder\tto\tprovide\thigh\tavailability.\tNow\tlet's\ttake\ta\tlook\tat\tthe\tfour different\tcomponents\tof\tthe\tmaster.\n\nAPI\tserver\n\nThe\tmaster\tAPI\tserver\tis\tresponsible\tfor\thandling\tand\tconfiguring\tthe\tdata\tfor pods,\tservices,\tand\treplication\tcontrollers.\tThe\tAPI\tserver\tholds\tthe\tREST endpoints\tthat\tcan\tbe\tused\tto\ttalk\tto\tthe\tcluster.\n\netcd\n\nThe\tetcd\tservice\tis\tused\tas\ta\tpersistent\tstorage\tto\thold\tthe\tstate\tof\tthe\tmaster.\tIn general,\tetcd\tis\ta\tdistributed\tkey-value\tstore\tthat\tuses\tthe\tRaft\tprotocol.\tIt\tis most\tcommonly\tused\tin\tcases\twhere\tthere\tare\tmultiple\tnodes\tin\ta\tcluster\ttrying to\tshare\tconfigurations.\tKubernetes\trelies\theavily\ton\tetcd\tfor\tstoring\tthe\tmaster's state\tas\twell\tas\tfor\tHA\tconfigurations.\n\nNote\n\nIf\tyou\twould\tlike\tto\tknow\tmore\tabout\tetcd,\tthen\tplease\ttake\ta\tlook\tat\ttheir website\t\t\thttps://coreos.com/etcd\t.\n\nScheduler\n\nSimply\tput,\tthe\tscheduler\tis\tused\tto\tbind\tany\tunbound\tpods\tto\tthe\tnodes.\tThere is\ta\tlot\tgoing\ton\tbehind\tthe\tbinding\tprocess,\tsuch\tas\tpriorities\tand\tpredicates.\tAs it\tis\tout\tof\tscope\tfor\tthis\tbook,\twe\twill\tnot\tbe\tdiscussing\tthem\tnow.\n\nNote\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tthe\tbinding\tprocess,\ttake\ta\tlook\tat\tthis GitHub\treadme\tat\t https://github.com/kubernetes/community/blob/master/contributors/devel/scheduler.md .",
      "content_length": 1517,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 236,
      "content": "Controller\tmanager\n\nThe\tcontroller\tmanager\titself\tis\tcomposed\tof\tseveral\tcontrollers,\tsuch\tas\ta replication\tcontroller,\tendpoint\tcontroller,\tand\tnamespace\tcontroller,\twhich\thelp in\tmaintaining\tthe\tstate\tof\tthe\tcluster\tby\twatching\tfor\tany\tchanges\tto\tthe\tstates in\tetcd.\tFor\texample,\tthe\treplication\tcontroller\tis\tresponsible\tfor\treplicating\tpods across\tnodes,\talso\tknown\tas\tpod\treplicas.\n\nKubernetes\tnode\n\nKubernetes\tnodes\tare\tsimilar\tto\tMesos\tslaves\t(or\tagents),\twhich\tare\tresponsible for\tholding\tpods\tand\ttheir\tcontainers.\tNodes\tcan\tbe\teither\tphysical\tservers\tor virtual\tmachines.\tEarlier,\twe\twere\tintroduced\tto\ta\tnew\tterm\tcalled\tPod.\tIn\tvery simple\tterms,\ta\tpod\tis\tjust\ta\tgroup\tof\tcontainers\tin\tthe\tsame\tlogical\thost.\tWith that\tsaid,\tcontainers\tin\tthe\tsame\tpod\tshare\tthe\tsame\tIP\tand\tpool\tof\tports.\tIn order\tto\trun\ta\tDocker\tcontainer\ton\ta\tKubernetes\tnode,\tthe\tnode\tfirst\tneeds Docker\tinstalled\ton\tit.\tThat's\twhat\tyou\tsee\tin\tthe\tdiagram.\n\nIn\taddition\tto\tDocker,\ta\tnode\thas\ttwo\tother\tcomponents:\tkubeproxy\tand kubelet.\tLet's\ttalk\tabout\tthem\tone\tby\tone.\tBefore\twe\ttry\tto\tunderstand\twhat\ta kubeproxy\tis,\twe\thave\tto\tknow\tabout\tKubernetes'\tservices.\tNow\tthat\twe\tknow containers\treside\tin\tpods,\tand\tpods\tcan\tbe\treplicated\tacross\tnodes.\tWhat\tif\tyou have\tan\tapplication\tthat\tis\tscaled\tto\ta\tfactor\tgreater\tthan\tone\tand\tyou\twould\tlike to\tload-balance\tbetween\tthe\tcontainers?\tThat's\twhere\tKubernetes'\tservices\tcome in.\n\nKubernetes\tservices\tare\tjust\tabstractions\tof\tpods\tthat\tdefine\tpolicies\tto\taccess them.\tServices\tare\tusually\tidentified\tby\tlabels\ton\tthe\tpods.\tThe\tservice\tand\tthe kubeproxy\ttogether\twork\twith\tthe\tDNS\tserver\tto\tperform\tload\tbalancing\ton requests\tto\tservices\t(containers).\n\nA\tkubelet\tis\tan\tagent\tthat\truns\ton\teach\tnode.\tThe\tkubelet\tis\tresponsible\tfor maintaining\ta\tYAML\tmanifest\tfile\tthat\tdescribes\tthe\tpods.\tIt\tis\talso\tresponsible for\trunning\tthe\tcontainers\tand\tmake\tsure\tthey\tare\tup\tand\trunning\tall\tthe\ttime.\n\nThat\twas\ta\tvery\tquick\tand\tsimple\tillustration\tof\ta\tKubernetes\tcluster.\tOf\tcourse, the\tfunctioning\tand\tinternals\tof\ta\tKubernetes\tcluster\tare\tmuch\tmore\tcomplicated and\tsophisticated\tthan\twhat\twe've\ttalked\tabout\there.\tBut\tour\tgoal\tfor\tnow\tis\tto understand\tthe\tcomponents\tand\tconstruction\tof\ta\tKubernetes\tcluster.\tWith\tthat",
      "content_length": 2237,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 237,
      "content": "understand\tthe\tcomponents\tand\tconstruction\tof\ta\tKubernetes\tcluster.\tWith\tthat said,\tlet's\tmove\ton\tto\tour\tfirst\trecipe,\twhere\twe\twill\tlook\tat\tdifferent\tways\tto orchestrate\ta\tKubernetes\tcluster.",
      "content_length": 192,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 238,
      "content": "Setting\tup\tKubernetes\tcluster\tusing Docker\n\nWe\tnow\thave\ta\tbasic\tunderstanding\tof\tKubernetes\tand\tits\tcomponents.\tThough this\tis\tsufficient\tto\tget\tstarted\twith\tour\trecipes,\tit\tis\tstrongly\trecommended\tthat you\tlearn\tmore\tabout\tKubernetes\tfrom\tGoogle's\tdocumentation\tat http://kubernetes.io/docs/\tbefore\tyou\tstart\tusing\tKubernetes\tat\tscale.",
      "content_length": 336,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 239,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\torchestrate\ta\tlocal\tDockerized\tKubernetes\tcluster.\n\n1.\t The\teasiest\tway\tto\tcreate\ta\tKubernetes\tcluster\tat\tscale\tis\tusing\tGoogle Cloud\tPlatform\tat\thttps://cloud.google.com/container-engine\t.\tIf\tyou\thave\ta Google\taccount,\tyou\tshould\tbe\table\tto\tuse\tGoogle\tCloud\tPlatform\tright away.\tBut\tfor\tsimplicity,\tin\tthis\trecipe,\twe\twill\tbe\tbuilding\tour\tKubernetes cluster\ton\tour\tlocal\tmachines\tusing\tDocker.\n\n2.\t There\tare\tseveral\tways\tto\trun\ta\tDockerized\tKubernetes\tcluster,\tincluding but\tnot\tlimited\tto:\n\nBuilding\tour\town\tDocker\tCompose\tfile Using\tkid Using\tMinikube\n\n3.\t Building\tour\town\tDocker\tCompose\tfile\tmight\ttake\tlonger\tcompared\tto using\tkid\tand\tMinikube.\tKid\tstands\tfor\tKubernetes\tin\tDocker.\tIt\tis\ta\tthird- party\tscript\tthat\twill\tspin\toff\ta\tKubernetes\tcluster\tusing\tDocker.\tMinikube is\tKubernetes'\trecommended\tmethod\tfor\tcreating\ta\tsingle-node\tcluster\ton the\tlocal\tmachine.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tMinikube\tand\tkubectl\tto orchestrate\tand\tmanage\tour\tlocal\tsingle-node\tKubernetes\tcluster.\tkubectl is\ta\tCLI\tfor\tmanaging\tKubernetes\tclusters.\n\nNote\n\nBefore\tyou\tstart\tusing\tkubectl,\tit\tis\tstrongly\trecommended\tthat\tyou\tread its\tmanual\tpages.\tA\tvery\tdescriptive\toverview\tof\tkubectl\tis\tgiven\there\tat\t http://kubernetes.io/docs/user-guide/kubectl-overview\t.\n\n4.\t One\tof\tthe\tprerequisites\tfor\trunning\tMinikube\tis\tOracle\tVirtualBox.\tYou should\talready\thave\tit\ton\tyour\tlocal\tmachine\tif\tyou\tare\tusing\tdocker- machine.\tIf\tyou\tare\tusing\tnative\tDocker,\tyou\tmight\thave\tto\tinstall\tthe\tmost recent\tversion\tof\tVirtualBox. Note\n\nYou\tcan\tdownload\tand\tfind\tinstallation\tinstructions\tfor\tVirtualBox\there at\thttps://www.virtualbox.org/wiki/Downloads.",
      "content_length": 1670,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 240,
      "content": "How\tto\tdo\tit...\n\nMinikube\tis\tmaintained\tby\tthe\tKubernetes\tcommunity.\tInstalling\tit\tis\tas\tsimple as\trunning\ta\tshell\tscript.\tThe\tinstallation\tinstructions\tfor\tMinikube\tare\tusually included\tin\tthe\trelease\tpage\tof\teach\tversion.\tYou\tcan\tfind\tthe\tinstructions\tfor\tthe most\trecent\tversion\there:\thttps://GitHub.com/kubernetes/minikube/releases\t.\tAt the\ttime\tof\twriting\tthis,\tthe\tmost\trecent\tversion\tof\tMinikube\tis\tv0.12.0.\tYou could\tinstall\tthe\tmost\trecent\tversion.\tThis\tpage\thas\tinstructions\tfor\tOS\tX,\tLinux, and\tWindows.\n\nIn\tthis\trecipe,\tyou\twill\tfind\tinstructions\tfor\tOS\tX.\tYou\tshould\tfollow\tthe\tright instructions\tfor\tyour\toperating\tsystem.\n\n1.\t Open\ta\tterminal\twindow\tand\texecute\tthe\tfollowing\tcommand,\n\ncurl\t-Lo\tminikube\t https://storage.googleapis.com/minikube/releases/v0.12.0/miniku be-darwin-amd64\t&&\tchmod\t+x\tminikube\t&&\tsudo\tmv\tminikube\t usrlocal/bin/\n\n2.\t This\tcommand\tdoes\tthree\tthings:\n\nDownload\tthe\tminikube\tpackage Add\texecute\tpermissions\tto\tthe\tminikube\tbinary\tfile\tfor\tall\tusers Move\tthe\tminikube\tbinary\tfile\tto\tusrlocal/bin\n\n3.\t If\tyou\tare\tfamiliar\twith\tthe\tLinux\tenvironment,\tyou\tshould\talready understand\tthe\tcommand.\tThe\t&&\toperator\texecutes\tthe\tsecond\tcommand only\twhen\tthe\tfirst\tis\tsuccessful.\tThe\tfirst\ttwo\tcommands\tare\tpretty\tself- explanatory.\tThe\tthird\tcommand\tis\trequired\tso\tyou\tdon't\thave\tto\tconfigure your\tPATH\tvariable\teach\ttime\tyou\topen\ta\tnew\tterminal.\tUpon\texecution, you\tshould\tsee\tsomething\tlike\tthis:\n\n4.\t If\tyou\tare\tprompted\tfor\tyour\tpassword,\ttype\tit.\tIt\tmight\tbe\trequired\tto\trun the\tmv\tcommand\tas\tit\tis\texecuted\twith\tsudo\tpermissions.\n\n5.\t Now\tlet's\tverify\tthat\twe\thave\tthe\tminikube\tpackage\tinstalled\tsuccessfully. Go\tahead\tand\tissue\tthe\tfollowing\tcommand\tfrom\tthe\tsame\tterminal",
      "content_length": 1711,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 241,
      "content": "window:\n\nminikube\n\n6.\t You\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 58,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 242,
      "content": "Note\n\nTake\ta\tfew\tminutes\tto\tget\tfamiliar\twith\tthe\tMinikube\tcommands.\tIf\tyou would\tlike\tto\tknow\tmore\tabout\tMinikube,\tread\ttheir\tdocumentation: https://github.com/kubernetes/minikube/blob/master/README.md.\n\nIf\tyou\tlook\tat\tthe\tpossible\tcommands\tin\tMinikube\tfrom\tthe\tscreenshot,\tyou can\tsee\tthat\tMinikube\tby\titself\tis\tjust\tused\tfor\torchestrating\ta\tcluster.\tWhen it\tcomes\tto\tmanaging\tthe\tcluster\titself,\tyou\twill\tneed\tsomething\tlike kubectl.\tFortunately,\tminikube\tcan\twork\talong\twith\tkubectl\tif\tyou\thave\tit installed.\n\n7.\t So\tlet's\tinstall\tkubectl.\tIn\tthe\tsame\tterminal\twindow,\texecute\tthe\tfollowing command:\n\ncurl\t-LO\thttps://storage.googleapis.com/kubernetes- release/release/$(curl\t-s\t https://storage.googleapis.com/kubernetes- release/release/stable.txt)/bin/darwin/amd64/kubectl\t&&\tchmod\t +x\t./kubectl\t&&\tsudo\tmv\t./kubectl\tusrlocal/bin/kubectl",
      "content_length": 844,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 243,
      "content": "8.\t The\tpreceding\tcommand\tis\tvery\tsimilar\tto\tthe\tcommand\twe\tused\tto\tinstall minikube.\tIt\thas\tthree\tcommands\texecuted\tone\tafter\tthe\tother:\tthe\tfirst command\tdownloads\tthe\tmost\trecent\tversion\tof\tkubectl\tbinary,\tthe\tsecond command\tadds\texecute\tpermissions\tto\tthe\tbinary\tfile\tfor\tall\tusers,\tand\tthe third\tcommand\tmoves\tthe\tkubectl\tfile\tto\tthe\tusrlocal/bin\tdirectory\tso that\tyou\tdon't\thave\tto\tconfigure\tyour\tPATH\tto\tinclude\tthe\tkubectl\tbinary each\ttime\tyou\topen\ta\tnew\tterminal. Note\n\nAlternatively,\tif\tyou\tare\ta\tMac\tOS\tX\tuser,\tyou\tcould\talso\tuse\tHomebrew\tto install\tkubectl.\tThis\tway,\tyou\tdon't\thave\tto\tworry\tabout\tpermissions\tand configuring\tthe\tPATH\tas\tHomebrew\ttakes\tcare\tof\tthat\tfor\tyou.\tTo\tinstall kubectl\tvia\tHomebrew,\tall\tyou\thave\tto\tdo\tis\trun\tthis\tsimple\tHomebrew command:\tbrew\tinstall\tkubectl\n\n9.\t To\tverify\tthat\tyou\thave\tkubectl\tinstalled\tcorrect,\texecute\tthe\tfollowing command\ton\tthe\tsame\tterminal:\n\nkubectl",
      "content_length": 913,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 244,
      "content": "10.\t Remember\tto\ttake\ta\tmoment\tto\tread\tthrough\tthe\tmanual\tpages\tof\tkubectl. It\tis\ta\tvery\tpowerful\tCLI\ttool\tthat\tis\tcapable\tof\tmanaging\tyour\tentire Kubernetes\tcluster.\tWith\tthat\tsaid,\tlet's\tcreate\tour\tfirst\tKubernetes\tcluster. Issue\tthe\tfollowing\tcommand: minikube\tstart\n\n11.\t It\tusually\ttakes\ta\tfew\tminutes\tto\tstart\tyour\tcluster\tbecause\tbehind\tthe scenes,\tMinikube\ttries\tto\tcreate\ta\tnew\tVirtualBox\tVM\twith\tall\tnecessary tools\tand\tsoftware\tinstalled\ton\tit.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nStarting\tlocal\tKubernetes\tcluster... \t\t\t\t\t\t\t\tKubectl\tis\tnow\tconfigured\tto\tuse\tthe\tcluster.\n\n12.\t As\tyou\tcan\tsee,\tkubectl\tis\tnow\tconfigured\tto\tuse\tthe\tcluster\tthat\twas",
      "content_length": 659,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 245,
      "content": "created\tby\tMinikube.\tNow\tthat\twe\thave\tour\tcluster\trunning\tlocally,\tlet's make\tsure\tour\tcluster\tis\tup\tand\trunning.\tOne\tway\tto\tdo\tthis\tis\tlisting\tall\tthe Docker\tcontainers\trunning\ton\tthe\tVirtualBox\tVM.\tIn\torder\tto\tdo\tthat,\tyou need\tto\tperform\tan\textra\tstep.\tGo\tahead\tand\trun\tthe\tfollowing\tcommand:\n\neval\t$(minikube\tdocker-env)\n\n13.\t This\teval\tcommand\tsets\tyour\tDocker\tvariables\tto\twork\twith\tthe\tminikube VM.\tIf\tyou\tare\tcurious\tabout\tthe\tminikube\tVM,\topen\tup\tVirtualBox,\tand you\tshould\tsee\ta\tnewly\tcreated\tVM\tcalled\tminikube.\tNow\tthat\tour environment\tis\tset,\tissue\tthe\tfollowing\tcommand\tto\tlist\tall\tthe\tDocker containers\tthat\tare\trunning: docker\tps\t-a\n\n14.\t You\tshould\tbe\table\tto\tsee\tthe\tcontainers\trunning\ton\tthe\tminikube\tVM:\n\n15.\t As\tyou\tcan\tsee,\tthere\tis\tone\tcontainer\tcalled\tkube-addon-manager\tand\ttwo containers\tfor\tthe\timage\tpause-amd64.\tThe\taddon-manager\tcontainer makes\tsure\tall\tthe\tadd-ons\tare\tupdate\tas\tper\tthe\tKubernetes\tmanifest. Note\n\nTo\tlearn\tmore\tabout\tadd-ons,\ttake\ta\tlook\tat\tthis\tGitHub\tpage https://github.com/kubernetes/kubernetes/tree/master/cluster/addons\t.\n\n16.\t The\tpause\tcontainer\tis\tsomething\tspecial.\tIt\tis\tresponsible\tfor\tstoring\tthe network\tinformation\tfor\tany\tnew\tpod.\tIn\tour\tcluster,\tthere\tare\ttwo\tpause containers,\tmeaning\tthere\tcould\tpotentially\tbe\ttwo\tpods\teven\tbefore\twe create\tone.\tWe\twill\ttake\ta\tlook\tat\tthem\tin\tthe\tnext\trecipe.\n\n17.\t The\tother\tcomponents\twill\tbe\talready\tinstalled\ton\tthe\tminikube\tVM.\tIf\tyou want\tto\tbe\tvery\tsure\tabout\twhether\tor\tnot\tyour\tcluster\tis\trunning,\tyou\tcan execute\tthe\tminikube\tstatus\tcommand.\tIt\twill\tspit\tout\tsomething\tlike\tthis:\n\nminikubeVM:\tRunning localkube:\tRunning\n\n18.\t We\tknow\tthat\tminikubeVM\tindicates\tthe\tVirtualBox\tVM.\tlocalkube\tis",
      "content_length": 1703,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 246,
      "content": "nothing\tbut\tthe\tname\tof\tour\tKubernetes\tcluster.\tYou\tcan\tstop\tyour\tcluster by\tissuing\tthe\tfollowing\tcommand:\n\nminikube\tstop\n\n19.\t This\twill\tshut\tdown\tthe\tminikube\tVM\tin\tVirtualBox.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tCongratulations!\tYou\thave\tsuccessfully created\tyour\tfirst\tKubernetes\tcluster.",
      "content_length": 300,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 247,
      "content": "Understanding\tthe\tKubernetes dashboard\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tstart\tand\tstop\tour\tlocal\tsingle-node Kubernetes\tcluster.\tWe\tcall\tit\ta\tsingle-node\tcluster\tbecause\tit\twill\tjust\thave\tone Kubernetes\tnode\tconfigured.\tSo\tall\tthe\tcontainers\tthat\tyou\tdeploy\tare\tgoing\tto be\tdeployed\ton\tthis\tsingle\tKubernetes\tnode.\tKubernetes\tcomes\twith\ta sophisticated\tweb\tUI.\tThe\tweb\tUI\tacts\tas\tan\tadministration\tconsole\tfor\tyour cluster.\tYou\tcan\tperform\talmost\tall\toperations\tthat\tyou\tcan\twith\tkubectl,\ton\tthe web\tUI.\tIn\tfact,\tyou\tcould\talso\tmonitor\tthe\tresource\tutilization\tof\tyour\tcluster from\tthe\tweb\tUI.\tIn\tthis\trecipe,\twe\tare\tgoing\tto\tget\tfamiliar\twith\tthe\tKubernetes dashboard\tso\tthat\twe\tcan\teasily\tmanage\tour\tmicroservice\ton\tany\tKubernetes cluster.",
      "content_length": 751,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 248,
      "content": "Getting\tready 1.\t The\tfirst\tthing\tyou\tneed\tto\tknow\tis\tthe\tURL\tto\tthe\tKubernetes\tUI\n\ndashboard.\tOne\tway\tto\tdo\tthat\tis\tidentifying\tthe\tIP\tof\tyour\tminikube\tVM and\tuse\tthe\tdefault\tKubernetes\tdashboard\tport,\t30000.\n\n2.\t To\tfind\tthe\tIP\tof\tyour\tminikube\tVM,\trun\tthe\tfollowing\tcommand\ton\tyour terminal:\tminikube\tip\n\n3.\t After\tyou\tget\tthe\tIP,\tuse\tthe\tport\tnumber\t30000\tto\taccess\tthe\tKubernetes dashboard\tfrom\tyour\tweb\tbrowser.\n\nThough\tthis\tapproach\tworks\tmost\tof\tthe\ttime,\twe're\tstill\tmaking\tan\tassumption about\tthe\tport\tnumber.\tWhat\tif\tthe\tdefault\tport\tnumber\tchanges?\tSo\tlet's\tsee\tthe other\tway\tto\topen\tour\tdashboard.",
      "content_length": 610,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 249,
      "content": "How\tto\tdo\tit... 1.\t Fortunately,\tMinikube\tcomes\twith\tan\teasy-to-use\tcommand\tthat\twhen\n\nexecuted\tin\tyour\tterminal\twill\tautomatically\topen\tthe\tdashboard\tin\tyour default\tweb\tbrowser.\tLet's\ttry\tthat\tout:\tminikube\tdashboard\n\n2.\t If\tyour\tcluster\tis\talready\trunning,\tyou\tshould\tsee\tthe\tdashboard\tin\tyour\tweb browser.\tSometimes,\tif\tyou\ttry\tto\trun\tthis\tcommand\tright\tafter\tyour minikube\tstart\tcommand,\tit\tmight\ttake\ta\twhile\tto\topen\tup.\tIdeally,\tit pings\tthe\tcluster\tstatus\tAPI\tto\tcheck\tthe\tstatus\tof\tyour\tKubernetes\tcluster. On\tyour\tbrowser,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nTo\tbetter\tunderstand\tthe\tinterface,\tlet's\tspin\toff\ta\tsimple\techoserver\tcontainer\n\non\tKubernetes.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal:\tkubectl\trun hello-minikube\t--image=gcr.io/google_containers/echoserver:1.4\n\nFor\tnow,\tlet's\tnot\tdig\tdeeper\tinto\thow\tthe\tcommand\tworks.\tAll\twe\tdid\twas spin\toff\ta\tsimple\techoserver\tcontainer.\tWe\tare\tdoing\tthis\tonly\tto\tpopulate\tthe UI\twith\tsome\tinformation.\tWe\twill\tdig\tdeeper\tinto\thow\tto\trun\ta\tcontainer\tin\tour next\trecipe.\tYou\tshould\tget\ta\tresponse\tsimilar\tto\tthis:\tdeployment\t\"hello- minikube\"\tcreated\n\nNow\tgo\tto\tthe\tdashboard\tand\trefresh\tthe\tWorkloads\tpage.\tYou\tshould\tnow\n\nsee\tsomething\tlike\tthis:",
      "content_length": 1213,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 250,
      "content": "As\tyou\tcan\tsee,\tthere\tare\tthree\tsections:\n\nDeployments Replica\tsets Pods\n\nDeployments\tshows\tall\tthe\tcontainers\tthat\tare\tdeployed\ton\tyour\tpod.\tA\treplica set\tis\tnothing\tbut\tthe\tnext\tgeneration\tof\treplication\tcontroller.\tReplica\tsets sections\tshows\tthe\tdifferent\treplicas\tof\tyour\tcontainers.\tThe\tPods\tsection,\tas\tits name\tindicates,\tshows\tall\tthe\tpods\tthat\tare\tcurrently\tavailable\tin\tyour\tcluster.\n\nInstead\tof\tgoing\tinto\tthese\tindividual\tsections\ton\tthe\tleft-hand\tside\tpane,\tlet's go\tdirectly\tto\tthe\titems\tlisted\tin\teach\tof\tthese\tsections.\tFirst,\tlet's\tstart\twith\tthe hello-minikube\tdeployment\tby\tclicking\ton\tthe\thello-minikube\tdeployment item\tfrom\tthe\tDeployments\tgrid.\tYou\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 703,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 251,
      "content": "Some\tsections\thave\tbeen\tignored\tin\tthe\tpreceding\tscreenshot\tto\tfocus\tjust\ton\n\nthe\tmost\timportant\tsections\tand\tthe\tones\tyou\twill\tbe\tusing\tvery\toften.\tThe Details\tsection\tis\twhere\tyou\twill\tfind\tthe\thigh-level\tdetails\tabout\tyour\tDocker container\tdeployment.\tNote\tthe\tword\t\"deployment\"\tin\tthe\tprevious\tstatement.\tIf you\twant\tto\tsee\tdetails\tabout\tthe\tDocker\tcontainer\titself,\tyou\twill\thave\tto\ttake\ta look\tat\tthe\tNew\tReplica\tSet\tsection.\tNote\tthe\tlabels\tassociated\twith\tthe deployment\tas\twell\tas\tthe\treplica\tset.\tThese\tlabels\twere\tauto-generated\tby Kubernetes\twhen\tyou\tdeployed\tthe\tcontainer\tusing\tkubectl.\n\nYou\tcan\tgo\tto\tthe\tReplica\tSets\tsection\tby\tusing\tthe\tReplica\tSets\toption\tin\tthe\n\nleft-hand\tside\tmenu\tor\tby\tclicking\ton\tthe\thello-minikube-2713628163\treplica set\ton\tthe\tDeployments\tpage.\tEither\tway,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nThe\tDetails\tsection\tis\twhere\tyou\twill\tfind\tthe\tcontainer\tinformation,\tsuch\tas image\tname,\tversion,\tstatus,\tand\treplica\tset\tname.\tThe\tPods\tsection\tlists\tall\tthe pods\ton\twhich\tthis\tcontainer\thas\tbeen\tdeployed\tor\treplicated.\tIt\talso\tshows\tthe status\tof\tthe\tpod\tand\tits\town\tIP\taddress.\tIf\tyou\thad\tthe\tapp\tin\tmultiple\tpods,\tyou will\tsee\tall\tthe\tpods\tlisted\there\twith\ttheir\tunique\tIPs\taddresses.\tThe\tEvents section\tshows\tthe\tvarious\tevents\trelated\tto\tthis\tcontainer\ton\tthe\tcluster.\tThis\tis especially\tuseful\twhen\tyou\tare\tdebugging\tyour\tapplication\tor\tdeployment.\n\nThe\tnext\timportant\tsection\tis\tthe\tPods\tsection.\tYou\tcan\tgo\tto\tthe\tPods\tsection\n\nby\tchoosing\tthe\toption\tin\tthe\tleft-hand\tside\tmenu\tor\tclicking\ton\tthe\thello- minikube-2713628163-x6ge3\tpod\tin\tthe\tPods\tgrid\tof\tthe\tReplica\tSets\tpage.",
      "content_length": 1622,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 252,
      "content": "Either\tway,\tyou\tshould\tend\tup\ton\ta\tpage\tlike\tthis:\n\nThe\ttop\tsection\tshows\tthe\thigh-level\tdetails\tof\tthe\tpod,\tsuch\tas\tname,\tstatus,\n\nlabels,\tstart\ttime,\tand\tnamespace.\tOne\timportant\tdetail\tyou\twill\tfind\tin\tthis section\tis\tthe\tNode\tthat\tthis\tpod\tis\trunning\ton\tand\tthe\tIP\taddress\tof\tthe\tpod.\tThe next\timportant\tscreen\tin\tthe\tdashboard\tis\tthe\tNodes\tsection.\tLet's\tget\tthere\tby clicking\ton\tthe\tnode\tnamed\tminikube.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nThe\tscreenshot\tonly\tshows\tpart\tof\tthe\tpage.\tThe\trest\tof\tthe\tpage\twill\tbe",
      "content_length": 519,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 253,
      "content": "discussed\tin\tthe\tnext\tsection.\tThe\tDetails\tand\tSystem\tInfo\tsections\tgive\tyou\ta lot\tof\tuseful\tinformation,\tsuch\tas\tOS,\tversion\tinformation,\tarchitecture,\tand name.\tAllocated\tresources\tshows\tthe\tresource\tallocation\tfor\tthis\tparticular node.\n\nFrom\tthe\tscreenshot,\twe\tcan\tsay\tthat\t0.005\tout\tof\t2\tCPUs\thave\tbeen\tused,\t50 MB\tout\tof\t1.955\tGB\tof\tmemory\thas\tbeen\tused,\tand\t3\tout\tof\t110\tpods\thave\tbeen allocated.\tThe\tmaximum\tnumber\tof\tpods\tallocated\tper\tnode\tis\tset\tto\t110\tdue\tto several\tperformance\treasons.\tHowever,\tthis\tcan\tbe\tchanged\twith\tthe\tkubelet configuration\tmax-pods.\tThe\tremainder\tof\tthe\tpage\tshows\tthe\tvarious\tpods\tthat are\tavailable\ton\tthis\tnode.\tFor\tour\tlocal\tcluster,\tyou\tshould\tbe\table\tto\tsee\tthree pods:\n\nAs\tyou\tcan\tsee,\tthere\tare\ttwo\tadditional\tpods:\tkube-addon-manager-minikube and\tkubernetes-dashboard-xk3ih.\tFrom\tthe\tnames\tof\tthese\tpods,\tit\tis\tpretty obvious\tthat\tkube-addon-manager-minikube\thas\tthe\tadd-on\tmanager\tin\tit\tand kubernetes-dashboard-xk3ih\thas\tthe\tKubernetes\tdashboard\titself\tdeployed. The\tother\ttwo\timportant\tsections\tare\tNamespaces\tand\tPersistent\tVolumes. We\twill\tbe\tlooking\tat\tPersistent\tVolumes\tin\tlater\trecipes\tin\tthis\tchapter.\tLet's take\ta\tlook\tat\tthe\tNamespace\tsection.\tGo\tahead\tand\tclick\ton\tNamespaces\tfrom the\tleft-hand\tside\tmenu.\tYou\tshould\tsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tthere\tare\ttwo\tnamespaces:\tdefault\tand\tkube-system.\n\nNamespaces\tare\tnothing\tbut\tvirtual\tclusters\tthat\tare\tpart\tof\tthe\tsame\tphysical cluster.\tThe\tdefault\tnamespace\tis\twhere\tthe\tall\tour\tnew\tdeployments\tgo,\tand\tthe",
      "content_length": 1527,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 254,
      "content": "kube-system\tnamespace\tis\twhere\tthe\tdashboard\tand\tadd-on\tmanager\tare deployed.\n\nAll\tthis\ttime,\twe\thave\tbeen\tlooking\tat\tthe\tdefault\tnamespace.\tIf\tyou\twould like\tto\tlook\tat\tthe\tdeployments,\treplication\tcontrollers,\tand\tpods\tin\tthe\tkube- system\tnamespace,\tuse\tthe\tNamespace\tdropdown\tfrom\tthe\tleft-hand\tside\tmenu to\tchoose\tyour\tnamespace.\n\nThat's\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tThe\tgoal\tof\tthis\trecipe\tis\tto\tget\tyou familiar\twith\tthe\tKubernetes\tdashboard\tand\tits\tvarious\tsections.\tKubernetes itself\tis\ta\tvast\ttopic,\tand\tit\tis\tstrongly\trecommended\tthat\tyou\tresearch\tit\tmore before\tyou\tstart\tusing\tit.",
      "content_length": 600,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 255,
      "content": "Deploying\tyour\tmicroservice\ton Kubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tsuccessfully\torchestrated\ta\tsingle\tnode Kubernetes\tcluster\tusing\tDocker,\tand\twe\thave\tfamiliarized\tourselves\twith\tthe Kubernetes\tdashboard.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tdeploy\tour geolocation\tmicroservice\ton\tour\tKubernetes\tcluster.",
      "content_length": 313,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 256,
      "content": "Getting\tready\n\nDeploying\ta\tmicroservice\tin\tKubernetes\tcan\tbe\tdone\tin\tseveral\tways.\tWe\tcan use\tkubectl\tto\tsubmit\tour\tdeployment\tto\tthe\tKubernetes\tcluster.\tWe\tcan\talso use\tthe\tdashboard\tto\tcreate\ta\tdeployment\tvia\tthe\tUI.\tIn\tthe\tprevious\trecipe,\twe used\tkubectl\tto\tcreate\ta\tdeployment\tfor\tthe\techoserver\tcontainer.\tIn\tthis recipe,\tlet's\tuse\tthe\tdashboard\tto\tdeploy\tthe\tgeolocation\tmicroservice\tin Kubernetes.\n\nGo\tahead\tand\topen\tup\tthe\tKubernetes\tdashboard\tusing\tthe\tminikube\tcommand:\n\nminikube\tdashboard",
      "content_length": 500,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 257,
      "content": "How\tto\tdo\tit... 1.\t To\tcreate\ta\tnew\tdeployment,\tclick\ton\tthe\tCreate\tbutton\tat\tthe\ttop\tright\tof\n\nthe\tdashboard.\tYou\tshould\tsee\ta\tscreen\tsimilar\tto\tMarathon's\tNew Application\tmodal.\tMost\tof\tthe\tproperties\ton\tthis\tscreen\tare\tvery\tsimilar\tto that\tof\tMarathon's,\texcept\tmaybe\tfor\tthe\tterminologies.\tSo\tif\tyou\tare familiar\twith\tusing\tMarathon,\tyou\twill\tfind\tthis\treally\teasy.\n\n2.\t You\twill\tfind\tfour\tmajor\tfields: App\tname Container\tname Number\tof\tpods Service\n\n3.\t In\torder\tto\tdeploy\tour\tgeolocation\tmicroservice,\twe\tjust\tneed\tthe\tapp\tname and\tcontainer\tname.\tWe\twill\tlook\tat\tthe\tnumber\tof\tpods\tand\tservice\tin\tlater recipes\tin\tthis\tchapter.\tGo\tahead\tand\tenter\tgeolocation\tas\tthe\tapplication name\tand\tvikrammurugesan/geolocation:latest\tas\tthe\tcontainer\tname. Please\tchange\tthe\tDocker\tHub\taccount\tname\tfrom\tmine\tto\tyour\taccount name.\tThe\tlatest\ttag\tis\toptional\there,\tas\tit\tdefaults\tto\tthat\tif\tyou\tdon't provide\tone.",
      "content_length": 908,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 258,
      "content": "In\tthe\tpreceding\tscreenshot,\tyou\tcan\tsee\tanother\toption\tfor\tcreating\tan application:\tUpload\ta\tYAML\tor\tJSON\tfile.\tThis\tlets\tyou\tupload\tyour\tapp configurations\tin\tthe\tform\tof\ta\tYAML\tor\tJSON\tfile.\tWe\twill\tlook\tat\tthis later\tin\tthis\tchapter;\tfor\tnow,\twe\twill\tuse\tthe\tuser\tinterface\tto\tcreate\tthe application.\n\n4.\t Go\tahead\tand\tclick\ton\tthe\tDeploy\tbutton\twhen\tyou\tare\tdone.\tYou\tshould now\tsee\tthat\tthere\tis\tone\tnew\tapplication\tfor\tgeolocation\tand\ta\tpod associated\twith\tit:",
      "content_length": 467,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 259,
      "content": "5.\t It\tusually\ttakes\ta\tfew\tseconds\tto\ta\tfew\tminutes\tto\tdeploy\tyour\tapplication. Once\tit\tis\tdone,\tthe\tstatus\ticons\tshould\tshow\ta\tgreen\ttick\ticon,\tindicating\tit is\trunning.\tOnce\tyour\tpod\tand\treplication\tcontroller\tare\tup\tand\trunning, you\twill\tsee\tthat\ta\tnew\tIP\thas\tbeen\tassigned\tto\tyour\tpod.\tThat\tis\tthe\tIP\twe will\tbe\tusing\tto\taccess\tour\tapplication.\tIn\tmy\tcase,\tthe\tIP\tassigned\twas 172.17.0.4.\tSo\twe\twill\tbe\tusing\tthis\tIP\tin\tall\tfuture\treferences\tto\tthe\tpod. 6.\t Now\tthat\tour\tgeolocation\tapplication\tis\trunning,\tlet's\tinvoke\tthe\tGET\tAPI\tof application\tto\tmake\tsure\twe\tget\ta\t200\tresponse\tback.\tGo\tahead\tand\tissue the\tfollowing\tcURL\tcommand\tin\tyour\tterminal\twindow: curl\thttp://172.17.0.4:8080/geolocation \t\t\t\t\t\t\t\tcurl:\t(7)\tFailed\tto\tconnect\tto\t172.17.0.4\tport\t8080:\t Operation\ttimed\tout\n\n7.\t After\ta\tfew\tseconds,\tyour\tconnection\tshould\ttime\tout.\tThat\tis\tbecause\tthe IP\tthat\twe\thave\tused\tis\tan\tinternal\tIP\tand\tcannot\tbe\taccessed\toutside\tour host.\tIn\tthis\tcase,\tthe\thost\tis\tthe\tminikube\tVirtualBox\tVM.\tNow\twe\tclearly know\tthat\twe\tstill\thave\tsome\twork\tto\tdo\twith\trespect\tto\tthe\tports.\tAnd that's\twhat\tyou\twill\tbe\tlearning\tin\tthe\tnext\trecipe.\n\nBut\tbefore\tyou\tjump\tinto\tthe\tnext\trecipe,\tif\tyou\tare\tcurious\tto\tknow\thow\tthe same\tprocess\tcan\tbe\tdone\tusing\tthe\tYAML\tor\tJSON\tfile\tapproach,\tkeep reading:",
      "content_length": 1291,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 260,
      "content": "1.\t First,\tdelete\tthe\treplication\tcontroller\tand\tservice\tfor\tgeolocation.\tDeleting the\treplication\tcontroller\twill\tautomatically\tdelete\tthe\tpod\tand\tthe containers\tin\tthe\tpod.\tAfter\tthey\thave\tbeen\tdeleted,\twe\tnow\thave\tto\tcreate\ta YAML\tfile\twith\tour\tdeployment\tconfigurations.\tOpen\tyour\tSTS\tIDE\tand create\ta\tnew\tYAML\tfile\tcalled\tkube-deployment.yml\tdirectly\tunder\tthe geolocation\tproject\tdirectory.\tPaste\tthe\tfollowing\tcontents\tinto\tthe\tfile:\n\napiVersion:\textensions/v1beta1 \t\t\t\t\t\t\t\tkind:\tDeployment \t\t\t\t\t\t\t\tmetadata: \t\t\t\t\t\t\t\t\t\tname:\tgeolocation \t\t\t\t\t\t\t\tspec: \t\t\t\t\t\t\t\t\t\treplicas:\t1 \t\t\t\t\t\t\t\t\t\ttemplate: \t\t\t\t\t\t\t\t\t\t\t\tmetadata: \t\t\t\t\t\t\t\t\t\t\t\t\t\tlabels: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tapp:\tgeolocation \t\t\t\t\t\t\t\t\t\t\t\tspec: \t\t\t\t\t\t\t\t\t\t\t\t\t\tcontainers: \t\t\t\t\t\t\t\t\t\t\t\t\t\t-\tname:\tgeolocation \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-\tcontainerPort:\t8080\n\nThere\tare\ta\tfew\tthings\tto\ttalk\tabout\tin\tthis\tfile.\tThe\tapiVersion property\tidentifies\tthe\tversion\tof\tthe\textensions\tAPI\tthat\twill\tbe used.\tThe\textensions\tAPI\tis\ta\tsophisticated\tAPI\twith\toperations related\tto\tdaemon\tsets,\tdeployments,\tjobs,\tand\tso\ton.\n\nNote\n\nTo\tread\tmore\tabout\tthe\textensions\tAPI,\tvisit http://kubernetes.io/docs/api-reference/extensions/v1beta1/operations\t.\n\nThe\tkind\tproperty\tidentifies\tthe\tkind\tof\tresource\twe\tare\ttrying\tto create\tin\tKubernetes.\tNote\tthat\there\twe\tare\tcreating\ta\tDeployment, rather\tthan\treplication\tcontroller\tlike\tlast\ttime. The\treplicas\tproperty\tis\tset\tto\t1,\tindicating\tthat\twe\tjust\tneed\tone replica\tof\tthis\tdeployment.\tThe\tcontainer\tname\tis\tgeolocation\tand the\timage\tused\tis\tvikrammurugesan/geolocation:latest.\tPlease don't\tforget\tto\tuse\tthe\timage\tin\tyour\tDocker\tHub\taccount\tinstead\tof the\tauthor's.\tNote\tthat\twe\thave\tlisted\tthe\tcontainer\tport\tas\t8080\tin\tthe",
      "content_length": 1771,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 261,
      "content": "ports\tsection,\twhich\tcan\tlater\tbe\texposed\tvia\ta\tservice. We\thave\tadded\ta\tlabel\twith\tthe\tkey\tapp\tand\tvalue\tgeolocation.\tThis label\tcan\tbe\tused\twhen\tyou\tcreate\ta\tservice.\tWe\twill\tsee\thow\tto\tdo that\tafter\twe\tdeploy\tthe\tcontainer.\tSave\tthe\tfile\tand\tclose\tyour\tIDE. 2.\t Go\tahead\tand\tclick\ton\tthe\tCreate\tbutton\tto\tcreate\ta\tnew\tapplication.\tThis\n\ntime,\tchoose\tUpload\ta\tYAML\tor\tJSON\tfile.\tChoose\tthe\tkube- deployment.yml\tfile\tthat\twe\tjust\tcreated\tand\thit\tDeploy:",
      "content_length": 454,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 262,
      "content": "3.\t As\tyou\tcan\tsee,\tthere\tis\ta\tnew\tdeployment\tcalled\tgeolocation.\tIt\talso created\ta\tpod,\treplication\tset,\tand\treplication\tcontroller.\tThe\tsame\tthing\tcan be\tdone\tusing\tthe\tfollowing\tkubectl\tcommand:\n\nkubectl\tcreate\t-f\tkube-deployment.yml\n\nThis\tcommand-line\tbased\tapproach\tis\trecommended\twhen\tyou\tare\tperforming automated\tdeployments\tusing\tcontinuous\tintegration\ttools\tsuch\tas\tJenkins.\tOne thing\tto\tnote\tin\tthis\tapproach\tis\tthat\tit\twill\tnot\tcreate\ta\tservice\tfor\tyou.\tYou\thave to\tcreate\tthe\tservice\tmanually,\teither\tusing\tkubectl\tor\tfrom\tthe\tdashboard.\tWe will\tlook\tat\thow\tto\tcreate\ta\tservice\tusing\tkubectl\tin\tthe\tnext\trecipe.\tThe\tchoice",
      "content_length": 634,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 263,
      "content": "of\twhether\tto\tuse\tthe\tdashboard\tor\tkubectl\tdepends\tcompletely\ton\tyour\tusage. That\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tI\thope\tyou\tnow\thave\ta\tgood\thold\ton deploying\tyour\tapplications\ton\tKubernetes.\tIn\tthe\tnext\trecipe,\twe\twill\tlook\tat how\tto\tconfigure\tports\tand\tservices.",
      "content_length": 269,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 264,
      "content": "Configuring\tports\tin\tKubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tcreated\tour\town\tKubernetes\tcluster\tand\tdeployed our\tgeolocation\tmicroservice\ton\tthe\tcluster.\tBut\tunfortunately,\twe\twere\tnot\table to\taccess\tour\tmicroservice\tbecause\twe\thaven't\texposed\tour\tports\t(in\tthe dashboard\tmethod)\tor\tcreated\tservices\t(in\tthe\tkubectl\tmethod).\tIn\tthis\trecipe, we\twill\tlearn\thow\tto\tmap\tour\tports\tand\tcreate\tservices.",
      "content_length": 400,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 265,
      "content": "Getting\tready\n\nWhen\twe\tdeploy\tour\tapplication\tfrom\tthe\tfriendly\tform\tin\tthe\tKubernetes dashboard,\twe\thave\tsome\tadvanced\tsettings\tthat\twe\tcould\tutilize\tto\texpose ports.\tOpen\tthe\tdashboard\tusing\tthe\tminikube\tcommand:\tminikube\tdashboard\n\nDelete\tany\tdeployments,\treplication\tcontrollers,\tor\tservices\tyou\talready\thave\tfor geolocation.\tYou\tcan\tleave\tthe\techoserver\tcontainer\tthat\twe\tcreated\tearlier\tor delete\tit-it\tshouldn't\treally\taffect\tus.",
      "content_length": 436,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 266,
      "content": "How\tto\tdo\tit... 1.\t Go\tahead\tand\tcreate\ta\tnew\tapplication.\tEnter\tthe\tapplication\tname\n\ngeolocation\tand\tcontainer\timage\tvikrammurugesan/geolocation:latest. This\ttime,\tconfigure\tan\tinternal\tservice\twith\tsource\tport\t8080,\ttarget\tport 8080,\tand\tprotocol\tTCP.\tThe\tsource\tport\tis\tthe\tport\twe\twill\tuse\tto\taccess the\tservice,\tand\tthe\ttarget\tport\tis\tthe\tport\tthat\tneeds\tto\tbe\texposed\ton\tthe container.\n\nAlso\texpand\tthe\tAdvanced\tOptions\tsection\tto\tgo\tthrough\tthe\tother\toptions that\tKubernetes\toffers.\tScroll\tdown\tto\tthe\tCPU\tsection\tand\tenter\t1\tfor CPU\trequirement.\tProvide\tthe\tvalue\t512\tfor\tMemory\trequirement.\tOnce you\tare\tdone,\thit\tDeploy.\n\n2.\t Now,\tlet's\tverify\tthat\ta\tservice\thas\tbeen\tcreated\tfor\tthis\tport\tmapping.\tIf you\tgo\tto\tthe\tServices\tsection,\tyou\tshould\tsee\ta\tnew\tservice\tcalled geolocation.\tClick\ton\tthat\tto\ttake\ta\tlook\tat\tthe\tservice\tdetails.\tYou\tshould see\tsomething\tlike\tthis:",
      "content_length": 882,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 267,
      "content": "If\tyou\tlook\tat\tthe\tConnection\tsection,\tthere\tis\tthis\tfield\tcalled\tCluster\tIP.\tIn the\tscreenshot,\tthe\tCluster\tIP\tis\t10.0.0.20.\tThis\tIP\tis\tthe\tone\tthat\twe\tshould\tbe using\tto\taccess\tour\tgeolocation\tservice\ton\tport\t8080.\tWithout\tfurther\tado,\tlet's open\tup\ta\tterminal.\tOn\tthe\tterminal,\texecute\tthe\tfollowing\tcURL\tcommand: curl\thttp://10.0.0.20:8080/geolocation\tcurl:\t(7)\tFailed\tto\tconnect\tto\t10.0.0.20 port\t8080:\tOperation\ttimed\tout\n\nWhat\thappened\tnow?\tThis\ttime,\tthe\trequest\ttimed\tout\tbecause\talthough\tyou\n\nhave\tthe\tservice\tconfigured\tto\tperform\ta\tport\tmapping\tfrom\tport\t8080\tof\tthe node\tto\tthe\tcontainer,\twe\tare\tstill\ttrying\tto\taccess\tthis\thost\tfrom\tour\tlocal computer.\tSince\tthis\tis\ta\tDockerized\tenvironment,\twe\twill\thave\tto\trun\tthe\tsame command\tfrom\tinside\tthe\tminikube\tVM.\n\nIn\torder\tto\trun\tthis\tcommand\tfrom\tinside\tthe\tVM,\twe\tneed\tto\tSSH\tinto\tthe VM.\tFortunately,\tMinikube\thas\tthe\tability\tto\tSSH\tinto\tthe\tminikube\tVM.\tOn\tthe same\tterminal,\texecute\tthe\tfollowing\tcommand:\tminikube\tssh\n\nYou\tshould\tget\tsomething\tlike\tthis:\t##\t.\t##\t##\t##\t==\t##\t##\t##\t##\t##\t===\n\n\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\\___\t===\t~~~\t{~~\t~~~~\t~~~\t~~~~\t~~~\t/\t===-\t~~ \\______\to\t__/\t\\\t\\\t__/\t\\____\\_______/\t____\t|\t|__\t___\t___\t|\t|_|___\t\\\t__|\t|\t___\t___|\t| ____\t__\t|\t'_\t\\\t_\t\\\t\\|\t_|\t__)\t/\t_`\t|\t_\t\\\t__|\t|/\t/\t\\\t'_|\t|\t|_)\t|\t(_)\t|\t(_)\t|\t|_\t/\t__/\t(_|\t|\t(_)\t|\t(__| <\t__/\t|\t|_.__/\t\\___/\t\\___/\t\\__|_____\\__,_|\\___/\t\\___|_|\\_\\___|_|\tBoot2Docker version\t1.11.1,\tbuild\tmaster\t:\t901340f\t-\tFri\tJul\t1\t22:52:19\tUTC\t2016\tDocker version\t1.11.1,\tbuild\t5604cbe\tdocker@minikube:~$\n\nOnce\tyou\tare\tinside\tthe\tVM,\trun\tthe\tsame\tcURL\tcommand\tagain:\tcurl\n\nhttp://10.0.0.20:8080/geolocation",
      "content_length": 1608,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 268,
      "content": "This\ttime,\tyou\tshould\tget\tan\tempty\tarray\t([])\tfrom\tthe\tserver,\tindicating\tthat\n\nthere\tare\tno\tgeolocations\tavailable.\tWe\tnow\tknow\thow\tto\taccess\tour\tservice. But\twait;\tthis\tis\tnot\ta\tscalable\tsolution\tbecause\twe\tcan't\tlog\tin\tto\tthe\tVM\teach time\twe\tdeploy\tone\tor\tmore\tservices.\tWe\tshould\tbe\table\tto\taccess\tour\tservices from\tour\tlocal\tcomputer.\tTo\tdo\tthat,\twe\tneed\tsome\tkind\tof\tport\tforwarding mechanism.\tkubectl\thas\tport\tforwarding\tcapability\tthat\tforwards\tany\trequest from\tour\tlocal\tmachine\tto\tthe\tpod.\tIf\twe\tcan\tget\tour\trequest\tto\tthe\tpod,\tthe service\twill\tautomatically\ttake\tcare\tof\tsending\tour\trequest\tto\tthe\tright microservice\thost\tand\tport.\tExit\tfrom\tthe\tminikube\tVM.\n\nBefore\twe\tcan\trun\tthe\tkubectl\tport-forward\tcommand,\twe\tneed\tto\tknow\n\nthe\tname\tof\tthe\tpod.\tWe\tcan\teither\tget\tit\tfrom\tthe\tdashboard\tor\tuse\tthe following\tcommand\tin\tyour\tterminal\twindow:\tkubectl\tget\tpods\n\nYou\tshould\tget\tsomething\tlike\tthis:\tNAME\tREADY\tSTATUS\tRESTARTS\n\nAGE\tgeolocation-qr86h\t1/1\tRunning\t0\t27m\thello-minikube-2713628163- x6ge3\t1/1\tRunning\t0\t1d\n\nNow\tthat\twe\tknow\tthe\tpod\tname,\tissue\tthe\tfollowing\tkubectl\tcommand\tfrom the\tsame\tterminal\twindow:\tkubectl\tport-forward\tgeolocation-qr86\t8085:8080 Forwarding\tfrom\t127.0.0.1:8085\t->\t8080\tForwarding\tfrom\t[::1]:8085\t-> 8080\n\nIn\tthis\tcommand,\tthe\t8085\ton\tthe\tleft-hand\tside\tof\tthe\tcolon\tindicates\tthe\tport\n\nnumber\ton\tour\tlocal\tmachine,\tand\t8080\ton\tthe\tright-hand\tside\tof\tthe\tcolon indicates\tthe\tport\tnumber\tto\tforward\tto\ton\tthe\tpod.\tAfter\tyou\texecute\tthe command,\tit\twill\tgo\tto\tinteractive\tmode\tand\tkeep\tlistening\tfor\tany\tnew\trequests on\tport\t8085\tof\tyour\tlocal\tmachine.\tAny\tnew\trequests\twill\tbe\tforwarded\tto\tport 8080\tof\tthe\tpod,\tand\tthe\tresponses\twill\tbe\tsent\tback\tto\tthe\tclient.\n\nNow\tthat\twe\thave\tour\tport\tforwarding\tagent\tand\tKubernetes\tservice\tset\tup,\n\nlet's\tverify\tthat\tour\tAPIs\tare\taccessible\tfrom\tthe\tlocal\tmachine.\tOpen\ta\tnew terminal\twindow\tand\tissue\tthe\tfollowing\tcURL\tcommand\tto\tcreate\ta\tnew geolocation:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nWith\tthat,\twe\tare\table\tto\taccess\tour\tgeolocation\tmicroservice\ton\tthe\n\nKubernetes\tcluster\tfrom\tour\tlocal\tmachine.\tThe\tremainder\tof\tthe\trecipe\twill\thelp",
      "content_length": 2520,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 269,
      "content": "you\tcreate\ta\tservice\tif\tyou\twould\tlike\tto\tuse\tthe\tYAML-file\tbased\tkubectl create\tcommand\tto\tdeploy\tyour\tmicroservice\ton\tKubernetes.\tIf\tyou\tprefer using\tthe\tdashboard\tUI\tto\tdeploy\tapplications,\tfeel\tfree\tto\tskip\tthe\trest\tof\tthis recipe\tand\tjump\tto\tthe\tnext\trecipe.\tIf\tyou\thave\tused\tthe\tkubectl\tcreate command\tto\tcreate\tyour\tmicroservice,\tit\twill\tnot\tcreate\ta\tservice\tfor\tyou.\tYou have\tto\tmanually\tcreate\tit\tusing\tkubectl\texpose\tcommand.\tThis\tis\tuseful\twhen you\tare\tautomating\tdeployments\tor\tautomating\tintegration\ttests\tin\ta\tcontinuous integration\tenvironment.\n\nCreating\ta\tservice\tusing\tthe\tkubectl\tcommand\tis\tvery\tsimple.\tAll\tyou\tneed\tto\n\nknow\tis\tyour\tdeployment\tname.\tIn\tthe\tkube-deployment.yml\tfile,\twe\thave\tset the\tdeployment\tname\tas\tgeolocation,\tso\twe\twill\tuse\tthe\tsame\there.\tOpen\tup\ta new\tterminal\tand\tissue\tthe\tfollowing\tcommand:\tkubectl\texpose deployment/geolocation\tservice\t\"geolocation\"\texposed\n\nNow\tlet's\tverify\tthat\tour\tservice\thas\tbeen\tcreated.\tExecute\tthe\tfollowing\n\ncommand\tin\tthe\tsame\tterminal\twindow:\tkubectl\tget\tservices\tNAME CLUSTER-IP\tEXTERNAL-IP\tPORT(S)\tAGE\tgeolocation\t10.0.0.254 <none>\t8080/TCP\t1m\tkubernetes\t10.0.0.1\t<none>\t443/TCP\t1d\n\nAs\tyou\tcan\tsee,\tport\t8080\thas\tbeen\texposed\tby\tthe\tgeolocation\tservice.\tIf\tyou would\tlike\tto\tget\tmore\tinformation\tabout\tthe\tservice\twithout\thaving\tto\tgo\tto\tthe dashboard,\tuse\tthe\tfollowing\tcommand:\tkubectl\tdescribe\tservice/geolocation Name:\tgeolocation\tNamespace:\tdefault\tLabels:\tapp=geolocation\tSelector: app=geolocation\tType:\tClusterIP\tIP:\t10.0.0.254\tPort:\t<unset>\t8080/TCP Endpoints:\t172.17.0.4:8080\tSession\tAffinity:\tNone\tNo\tevents.\n\nFrom\tthe\tpreceding\tconsole\toutput,\twe\tcan\tsee\tthat\tthe\tClusterIP\tis\n\n10.0.0.254,\tand\tthere\tis\tone\tendpoint\texposed\tby\tthis\tservice\tat 172.17.0.4:8080.\tIf\tyou\tare\tin\ta\tDockerized\tenvironment,\tas\twe\tdiscussed earlier\tin\tthis\trecipe,\tyou\twill\thave\tto\tperform\ta\tport\tforwarding\tusing\tthe kubectl\tport-forward\tcommand.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\thave\tsuccessfully\tdeployed\tour geolocation\tmicroservice\tand\texposed\tits\tendpoints\tso\tthat\tit\tcan\tbe\taccessed from\toutside.\tIn\tthe\tfollowing\trecipes,\twe\twill\tlook\tat\thow\tto\tconfigure\tvolumes and\tenvironment\tvariables\tusing\tthe\tdashboard\tUI.",
      "content_length": 2195,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 270,
      "content": "Configuring\tvolumes\tin\tKubernetes\n\nVolumes\tare\thandled\tvery\tdifferently\tin\tKubernetes\tcompared\tto\tApache\tMesos. In\tfact,\tKubernetes\tpersistent\tvolumes\tsupport\tAzure,\tvCloud,\tand\tAWS. Kubernetes\talso\tsupports\tCeph,\tFlocker,\tGluster\tFS,\tand\teven\tGit.\tThis extensive\tsupport\topens\tup\topportunities\tfor\tstoring\tyour\tdata\ton\tthe\tcloud\tand also\tenables\teasy\tbackups.\n\nNote\n\nTo\ttake\ta\tlook\tat\tthe\tcomplete\tset\tof\tsupported\tvolumes,\tgo\tto http://kubernetes.io/docs/user-guide/volumes/#types-of-volumes\t.",
      "content_length": 495,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 271,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tmap\tthe\tvolume\twhere\tour\tdata\tfiles\tare stored\tin\tthe\tgeolocation\tmicroservice.\n\n1.\t First,\tdelete\tany\tdeployments,\treplication\tcontrollers,\tport\tforwards,\tor services\tthat\tyou\talready\thave\tfor\tgeolocation.\tYou\tcan\tleave\tthe echoserver\tcontainer\tthat\twe\tcreated\tearlier\tor\tdelete\tit.\tIt\tshouldn't\treally affect\tus.\tAlso,\talways\tdelete\tthe\tservice\tfirst\tand\tthe\treplication\tcontroller afterward.\tIf\tyou\ttry\tto\tdelete\tthe\tpod\tor\tcontainer,\tit\twill\tbe\trecreated\tby the\treplication\tcontroller\tto\tmake\tsure\tat\tleast\tone\treplica\tof\tyour\tpod\tand container\tis\tavailable\t(as\tour\treplication\tfactor\tis\t1).\n\n2.\t Before\twe\tjump\tinto\tthe\trecipe,\tyou\thave\tto\tlearn\thow\tKubernetes\thandles volumes.\tThere\tare\ttwo\tconcepts:\tpersistent\tvolumes\tand\tpersistent\tvolume claims. A\tpersistent\tvolume\tis\tjust\ta\tstorage\tprovisioned\ton\tthe\tcluster network\tby\tthe\tcluster\tadministrator.\tThe\tcluster\tadministrator\tcan\tbe someone\tin\tyour\torganization\tresponsible\tfor\tthe\tKubernetes\tcluster's infrastructure\tand\tavailability. Unlike\tMesos,\twhere\tyou\tmap\ta\tvolume\tdirectly\tfrom\tthe\tcontainer\tto the\thost\tmachine,\there\tin\tKubernetes,\tyou\thave\tto\tcreate\ta\tpersistent volume\tfirst\tand\tcreate\ta\tpersistent\tvolume\tclaim,\twhich\tis\tnothing\tbut a\trequest\tmade\tby\tthe\tpod\tfor\tstorage\ton\tthe\tcluster.\n\nNote\n\nIt\tis\thighly\trecommended\tthat\tyou\tread\thttp://kubernetes.io/docs/user- guide/persistent-volumes\tbefore\tyou\tstart\tusing\tvolumes\ton\tKubernetes,\tas the\tprocess\tis\tnot\tstraight-forward.\n\n3.\t In\tour\trecipe,\tfor\tsimplicity,\twe\twill\tbe\tcreating\ta\thostPath\tvolume\tand will\tbe\tmapping\tit\tto\tthe\tdata\tdirectory\tof\tthe\tgeolocation\tmicroservice.\tIf you\tremember\tfrom\tChapter\t3\t,\tDeploying\tMicroservices\ton\tMesos,\twe persisted\tour\tgeolocations\tin\tthe\tform\tof\tJSON\tfiles\tin\tthe\tdata\tdirectory\tat optpackt/geolocation/data.\tThe\thostPath\tvolume\tis\tmostly\tused\twhen you\twould\tlike\tto\texpose\tsomething\ton\tthe\thost\tmachine,\tfor\texample, Docker\tinternals,\tshared\tfolders,\tand\tconfig\tdirectories.",
      "content_length": 1993,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 272,
      "content": "How\tto\tdo\tit...\n\nIn\tthis\trecipe,\twe\twill\tbe\tdeploying\tour\tmicroservice\ta\tlittle\tdifferently\tfrom\tthe previous\tmethods.\tSo\tfar,\twe\thave\tcreated\treplication\tcontrollers\tand deployments\tboth\tfrom\tthe\tUI\tand\tusing\tkubectl.\tIn\tthis\trecipe,\twe\twill\tbe creating\ta\tpod\tusing\tkubectl.\tThe\treason\twe\tare\tcreating\ta\tpod\tis\tthat\twe\twill also\tbe\tcreating\tour\thostPath\tvolume\talong\twith\tthe\tpod.\n\n1.\t Open\tyour\tSTS\tIDE\tand\tgo\tto\tthe\tgeolocation\tproject.\tCreate\ta\tnew YAML\tfile\tcalled\tkube-pod.yml,\tand\tpaste\tthe\tfollowing\tcontents\tin\tit: apiVersion:\tv1\tkind:\tPod\tmetadata:\tname:\tgeolocation\tspec: containers:\t-\timage:\tvikrammurugesan/geolocation:latest\tname: geolocation\tports:\t-\tcontainerPort:\t8080\tvolumeMounts:\t-\tmountPath: optpackt/geolocation/data\tname:\tgeodata\tvolumes:\t-\tname:\tgeodata hostPath:\tpath:\toptpackt/geolocation/data\n\n2.\t There\tare\tfew\tthings\tto\ttake\ta\tlook\tat\there\tin\tthe\tYAML\tfile.\tThe\tAPI version\twe\tare\tusing\tis\tv1.\tThe\tkind\tof\tentity\twe\tare\tcreating\tis\tPod.\tThe name\tof\tthe\tpod\tis\tgeolocation.\tThe\tpod\thas\tone\tcontainer\twith\tthe\tname geolocation.\tIt\tuses\tthe\tvikrammurugesan/geolocation:latest\timage, and\tthe\tcontainer\tport\tfor\tthis\tcontainer\tis\t8080.\tThe\tpod\thas\tone\tvolume called\tgeodata.\tThe\tvolume\tgeodata\tis\tof\ttype\thostPath,\tand\tthe\tpath\tin the\thost\tis\toptpackt/geolocation/data.\tThe\tgeolocation\tcontainer\thas one\tvolume\tmapping\tfor\tthe\toptpackt/geolocation/data\tcontainer\tpath on\tthe\tvolume\tthat\tmatches\tthe\tname\tgeodata\twhich\tis\tthe\thostPath volume.\n\n3.\t Go\tahead\tand\tcreate\ta\tnew\tpod\tusing\tthe\tfollowing\tkubectl\tcreate command:\tkubectl\tcreate\t-f\tkube-pod.yml\tpod\t\"geolocation\"\tcreated 4.\t Now\tlet's\tmake\tsure\tour\tpod\tis\tup\tand\trunning.\tTo\tverify\tits\tstatus,\tissue\n\nthe\tfollowing\tcommand\ton\tthe\tterminal:\tkubectl\tget\tpods\tNAME\tREADY STATUS\tRESTARTS\tAGE\tgeolocation\t0/1\tContainerCreating\t0\t5m hello-minikube-2713628163-x6ge3\t1/1\tRunning\t1\t5d\n\n5.\t As\tyou\tcan\tsee,\tthe\tgeolocation\tpod\tis\tin\tthe\tContainerCreating\tstate, which\tmeans\tit\tis\tin\tthe\tprocess\tof\tpulling\tand\tstarting\tthe\tcontainer.\tIt\tmay take\ta\tfew\tseconds\tfor\tyour\tpod\tto\tgo\tinto\tthe\tRunning\tstate.\n\n6.\t You\tcan\talways\ttake\ta\tlook\tat\tyour\tpod\tin\tthe\tKubernetes\tdashboard\tas well.\tOnce\tthe\tpod\tis\tcreated,\tlook\tat\tthe\tdetails\tof\tthe\tgeolocation\tpod\tin the\tdashboard.\tYou\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 2276,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 273,
      "content": "The\tnext\tstep\tis\tsetting\tup\tport\tforwarding\tusing\tkubectl.\tUse\tthe\tfollowing\n\ncommand\tto\tsetup\tport\tforwarding:\tkubectl\tport-forward\tgeolocation 8085:8080\n\nNow\tthat\tyou\tknow\tyour\tpod\tand\tcontainer\tare\tup\tand\trunning,\tlet's\tsend\ta couple\tof\tgeolocations\tto\tthe\tPOST\tAPI.\tUse\tthe\tfollowing\ttwo\tcurl\tcommands to\tcreate\tgeolocations:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\tcurl -H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203976,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8085/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\":\t\"f1196aac-470e-",
      "content_length": 1118,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 274,
      "content": "11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nNow\tlet's\tverify\twhether\tthe\tfiles\twe\tcreated\tare\tavailable\ton\tthe\thost\n\nmachine.\tBut\tthe\tquestion\there\tis\tthis:\twhich\tone\tis\tthe\thost\tmachine?\tSince\twe are\tusing\ta\tDockerized\tenvironment,\tthe\thost\tmachine\twill\tbe\tthe\tminikube VirtualBox\tVM.\tTo\tcheck\twhether\tthe\tfiles\tare\tavailable\tin\tthe\tVM,\twe\thave\tto SSH\tinto\tthe\tVM\tfirst.\tTo\tdo\tthat,\tlet's\tuse\tthe\tminikubessh\tcommand: minikube\tssh\n\nYou\tshould\tget\tsomething\tlike\tthis:\t##\t.\t##\t##\t##\t==\t##\t##\t##\t##\t##\t===\n\n\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\\___\t===\t~~~\t{~~\t~~~~\t~~~\t~~~~\t~~~\t/\t===-\t~~ \\______\to\t__/\t\\\t\\\t__/\t\\____\\_______/\t____\t|\t|__\t___\t___\t|\t|_|___\t\\\t__|\t|\t___\t___|\t| ____\t__\t|\t'_\t\\\t_\t\\\t\\|\t_|\t__)\t/\t_`\t|\t_\t\\\t__|\t|/\t/\t\\\t'_|\t|\t|_)\t|\t(_)\t|\t(_)\t|\t|_\t/\t__/\t(_|\t|\t(_)\t|\t(__| <\t__/\t|\t|_.__/\t\\___/\t\\___/\t\\__|_____\\__,_|\\___/\t\\___|_|\\_\\___|_|\tBoot2Docker version\t1.11.1,\tbuild\tmaster\t:\t901340f\t-\tFri\tJul\t1\t22:52:19\tUTC\t2016\tDocker version\t1.11.1,\tbuild\t5604cbe\tdocker@minikube:~$\n\nOnce\tyou\tare\tinside\tthe\tVM,\texecute\tthe\tfollowing\tls\tcommand\tto\tcheck\n\nwhether\tthe\tfiles\thave\tbeen\tcreated\tsuccessfully:\tls\t-ls optpackt/geolocation/data\n\nYou\tshould\tget\tsomething\tlike\tthis:\n\nWe\thave\tsuccessfully\tconfigured\tvolume\tmappings\ton\tKubernetes\tusing\tthe hostPath\tmethod.\tThough\tthis\tis\tone\tof\tthe\tsimplest\tconfigurations\tyou\tcan achieve\twith\tKubernetes,\tthe\tidea\there\tis\tto\tgive\tyou\tan\tintroduction\tto\tthe abilities\tof\tKubernetes\twhen\tit\tcomes\tto\tMicroservice\tdeployments.\tIn production\tscenarios,\tit\tis\tmore\tideal\tto\tuse\tAzure,\tAWS,\tor\tvCloud,\tbased\ton your\tstack.\n\nBefore\twe\tmove\ton\tto\tthe\tnext\trecipe,\tlet's\tdelete\tour\tpod\tusing\tthe\tfollowing command:\tkubectl\tdelete\tpod/geolocation\tpod\t\"geolocation\"\tdeleted\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tlook\tat\thow\tto configure\tenvironment\tvariables\tin\tKubernetes.",
      "content_length": 1818,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 275,
      "content": "Configuring\tenvironment\tvariables\tin Kubernetes\n\nIn\tthe\tprevious\tchapter,\twe\tused\tMarathon\tto\tadd\tan\tenvironment\tvariable\tfor the\tgeolocation\tdata\tdirectory\tpath,\twhich\twill\tin\tturn\tbe\tused\tby\tthe application\tto\tlocate\tthe\tdata\tdirectory.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tuse the\tKubernetes\tdashboard\tas\twell\tas\tkubectl\tto\tconfigure\tthe\tsame\tenvironment variable.",
      "content_length": 367,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 276,
      "content": "Getting\tready\n\nFirst,\tdelete\tany\treplication\tcontrollers,\tservices,\tport\tforwards\tor\tpods\tthat\twere created\tin\tthe\tprevious\trecipe.\tYou\tcan\tleave\tthe\techoserver\tup\tand\trunning;\tit should\tnot\taffect\tanything.\tThere\tare\ttwo\tways\tyou\tmight\twant\tto\tadd environment\tvariables\tto\tyour\tcontainer:\tfrom\tthe\tdashboard\tUI\tor\tfrom\tthe command\tline\tusing\tkubectl.\n\nWe\twill\tlook\tat\tthe\tdashboard\tUI\tfirst.\tIf\tyou\tdon't\thave\tthe\tdashboard\tup\tand running,\tissue\tthe\tfollowing\tcommand\tto\topen\tup\tthe\tKubernetes\tdashboard: minikube\tdashboard",
      "content_length": 524,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 277,
      "content": "How\tto\tdo\tit... 1.\t Once\tthe\tdashboard\tis\tup,\tclick\ton\tthe\tCreate\tbutton\tto\tdeploy\tour\n\nmicroservice.\tLet's\tuse\tthe\tfriendly\tform\tto\tdeploy\tthe\tmicroservice.\tUse the\tfollowing\tconfigurations:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t1 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nTake\ta\tlook\tat\tthe\tEnvironment\tVariables\tsection.\tWe\thave\tadded\tthe\n\nGEOLOCATION_DATA_FILES_DIR\tvariable\twith\tthe\tvalue optpackt/geolocation/data:",
      "content_length": 638,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 278,
      "content": "Note\n\nKeep\tin\tmind\tthat\tthe\tEnvironment\tVariables\tsection\twill\tbe\tburied\tunder\tthe advanced\toptions\tat\tthe\tbottom.\n\nOnce\tyou\thave\tentered\tall\tthe\tvalues,\tclick\ton\tDeploy\tto\tdeploy\tthe\n\nmicroservice.\tIt\ttakes\ta\tfew\tseconds\tfor\tyour\tpod\tand\treplication\tcontroller\tto get\tto\tthe\tRunning\tstate.\n\nThat's\tit!\tThe\tgeolocation\tmicroservice\tshould\tnow\tuse\tthe\tnew\tenvironment\n\nvariable\tto\tlocate\tthe\tdata\tdirectory\tinside\tthe\tcontainer.\tThe\tnext\tstep\tis\tto check\twhether\tthe\tgeolocation\tmicroservice\tis\tusing\tour\tnewly\tcreated environment\tvariable.\n\nIn\torder\tto\tverify\tthe\tworking\tof\tour\tenvironment\tvariable,\twe\thave\tto\texpose\n\nport\t8080\tof\tthe\tpod\tto\tour\tlocal\tmachine.\tGo\tahead\tand\tissue\tthe\tfollowing command\tin\tyour\tterminal\twindow:\tkubectl\tport-forward\tgeolocation-qr86 8080:8080\tForwarding\tfrom\t127.0.0.1:8080\t->\t8080\tForwarding\tfrom [::1]:8080\t->\t8080\n\nIn\tthis\tcommand,\tthe\tname\tof\tthe\tpod\twas\tgeolocation-qr86.\tIf\tthe\tname\tof\n\nyour\tpod\tis\tdifferent,\tuse\tthat.\tOtherwise,\tyou\twill\tget\tan\terror\tmessage\tfrom kubectl\tsaying\tthat\ta\tpod\twith\tthe\tgiven\tname\tis\tnot\tavailable.\tNow\tthat\tyour service\tis\tlistening\ton\tport\t8080\tof\tlocalhost,\topen\ta\tnew\tterminal\twindow. Execute\tthe\tfollowing\ttwo\tcurl\tcommands\tone\tby\tone:\tcurl\t-H\t\"Content- Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\tcurl -H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203976,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8080/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\nNow\tlet's\tvalidate\twhether\tthe\tfiles\thave\tbeen\tcreated\tusing\ta\tsimple\tdocker\n\nexec\tcommand.\tYou\tcan\tfind\tthe\tID\tof\tthe\tgeolocation\tcontainer\tusing\tthe docker\tps\tcommand.\tIn\tthe\tsame\tterminal\twindow,\texecute\tthe\tfollowing",
      "content_length": 2281,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 279,
      "content": "Docker\tcommand:\tdocker\texec\t9ae486e3d63a\tls\toptpackt/geolocation/data userf1196aac-470e-11e6-beb8-9e71128cae77_t1468203975\tuserf1196aac- 470e-11e6-beb8-9e71128cae77_t1468203976\n\nYay!\tOur\tdata\tfiles\thave\tbeen\tcreated\tat\tthe\tlocation\tthat\twas\tpassed\tin\tthe GEOLOCATION_DATA_FILES_DIR\tenvironment\tvariable.\n\nNow\tlet's\ttake\ta\tlook\tat\thow\tto\tconfigure\tenvironment\tvariables\tusing\tkubectl\n\nand\ta\tYAML\tfile.\tBefore\twe\tmove\ton,\tdelete\tthe\treplication\tcontroller\tand\tthe services\tthat\twe\tcreated.\n\nNow,\topen\tthe\tkube-pod.yml\tfile\tthat\twe\tcreated\tin\tthe\tprevious\trecipe\tin\n\nSTS.\tAdd\tthe\tfollowing\tsection\tto\tthe\tgeolocation\tcontainer\tsection\tin\tthe YAML\tfile.\tRemember\tto\tbe\tcareful\twhen\tyou\twork\twith\tYAML\tfiles,\tas\tit does\tnot\taccept\ttab\tspaces.\tInstead\tof\ttab\tspaces,\tuse\tblank\tspaces:\tenv:\t\t\t\t\t- name:\tGEOLOCATION_DATA_FILES_DIR\t\t\t\t\t\t\tvalue: \"optpackt/geolocation/data\"\n\nAfter\tyou\thave\tadded\tthe\tenvironment\tvariables,\tyour\tfinal\tYAML\tfile\twill look\tlike\tthis:\tapiVersion:\tv1\tkind:\tpod\tmetadata:\tname:\tgeolocation\tspec: containers:\t-\timage:\tvikrammurugesan/geolocation:latest\tname:\tgeolocation ports:\t-\tcontainerPort:\t8080\tvolumeMounts:\t-\tmountPath: optpackt/geolocation/data\tname:\tgeodata\tenv:\t-\tname: GEOLOCATION_DATA_FILES_DIR\tvalue:\t\"optpackt/geolocation/data\" volumes:\t-\tname:\tgeodata\thostPath:\tpath:\toptpackt/geolocation/data Spin\toff\tthe\tpod\tusing\tkubectl\tfrom\tany\tterminal\twindow,\tusing\tthe following\tcommand:\tkubectl\tcreate\t-f\tkube-pod.yml\tpod\t\"geolocation\" created\n\nNow\tyou\tcan\tverify\twhether\tthe\tenvironment\tvariable\twas\tcreated\tby\tposting\n\nsome\tgeolocations\tto\tthe\tAPI\tand\tchecking\tthe\tcontents\tof\tthe optpackt/geolocation/data\tdirectory\tin\tthe\tminikube\tVirtualBox\tVM.",
      "content_length": 1674,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 280,
      "content": "Scaling\tyour\tmicroservice\tin Kubernetes\n\nIf\tyou\tread\tthe\tprevious\tchapter,\tyou\twill\tknow\thow\timportant\tbeing\table\tto scale\tmicroservices\tis.\tScaling\tis\ta\tsignificant\tfeature\tfor\tany\tclustering framework\tbecause\twith\tthe\tincreasing\tusage\tof\tcontainers,\tusers\tprefer\tsimpler methods\tto\tscale\ttheir\tcontainers.\tLike\tMarathon,\tKubernetes'\tdashboard\tcan\tbe used\tto\teasily\tscale\tcontainers\tup\tand\tdown.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe Kubernetes\tdashboard\tto\tscale\tup\tand\tscale\tdown\tthe\tgeolocation\tmicroservice.",
      "content_length": 511,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 281,
      "content": "Getting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.",
      "content_length": 358,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 282,
      "content": "How\tto\tdo\tit... 1.\t Click\ton\tthe\tCreate\tbutton\tand\tfill\tout\tthe\tfriendly\tform\twith\tthe\tfollowing\n\ninformation:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nThere\tis\tone\tsignificant\tchange\tin\tthis\tconfiguration\tfrom\tour\tprevious deployments.\tThis\ttime,\twe\thave\tset\tthe\tCPUs\tto\t0.5.\tThis\tchange\tis\trequired\tto support\tthe\tnumber\tof\tpods\tthat\tcan\trun\tin\tour\tMinikube\tsetup.\tThe\tdefault number\tof\tCPUs\tis\t2,\twhich\thas\talready\tbeen\tused\tby\tour\tfirst\tinstance\tof geolocation,\thello-minikube,\tthe\tdashboard,\tand\tthe\tadd-on\tmanager.\tYou could\talso\tincrease\tthe\tnumber\tof\tCPUs\tused\tby\tMinikube\tby\trecreating\tthe minikube\tVM\twith\tthe\t--cpu\toption.\t\tGo\tahead\tand\thit\tDeploy.\n\nNote\n\nFor\tmore\tinformation,\tread https://GitHub.com/kubernetes/minikube/blob/master/docs/minikube_start.md\t.\n\nNote\tthat\twe\thave\tset\tthe\tnumber\tof\tpods\tto\t1.\tYou\tmust\thave\tguessed\tby\tnow\n\nthat\tthe\tnumber\tof\tpods\tis\twhat\tthat\twill\thelp\tus\tscale\tour\tmicroservice.\tNow let's\tsay\tyou\twould\tlike\tto\tincrease\tthe\tnumber\tof\tinstances\tof\tyour\tapplication to\t2:\tclick\ton\tWorkloads\tin\tthe\tleft-hand\tside\tmenu.\tFrom\tthe\tReplication controllers\tsection,\tclick\ton\tthe\tthree\tdots,\tand\tselect\tScale:",
      "content_length": 1405,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 283,
      "content": "After\tyou\tclick\ton\tScale,\tyou\twill\tbe\tprompted\tto\tenter\tthe\tnumber\tof\tpods\n\nyou\twould\tlike\tto\tscale\tto.\tAs\tyou\tcan\tsee,\tyou\twill\tnot\tbe\tscaling\tyour application\tinstance\tin\tthe\tsame\tpod;\trather,\tKubernetes\tlets\tyou\tscale\tthe number\tof\tpods\titself.\tThis\tis\tslightly\tdifferent\tfrom\thow\tApache\tMesos\tand Marathon\twork.\tBut\tit\tmakes\ta\tlot\tof\tsense\twhen\tit\tcomes\tto\tscaling\tyour applications\tin\tthe\tKubernetes\tecosystem.\tIn\tthe\tmodal,\tenter\t2\tand\thit\tOK:\n\nNow\tyou\tshould\tbe\table\tto\tsee\ttwo\tpods\tfor\tgeolocation;\tthey\tstart\twith\n\ngeolocation-.\tIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tyour\tpod\tand\tthe containers\tthat\tare\trunning\tinside\tit,\tclick\ton\tthe\tpod\tname:",
      "content_length": 654,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 284,
      "content": "With\tthat,\tyou\thave\tsuccessfully\tscaled\tyour\tapplication\tto\ta\tscaling\tfactor\tof\t2. If\tyour\tcluster\thas\tsufficient\tresources,\tyou\twill\tbe\table\tto\teasily\tscale\tyour application\tto\tany\tnumber\tof\tpods.\n\nScaling\tdown\tan\tapplication\tis\tvery\tstraight-forward\tand\tuses\tthe\tsame\n\nstrategy.\tNow\tlet's\tsay\tyou\twould\tlike\tto\tdown-scale\tthe\tgeolocation\tapplication to\ta\tscaling\tfactor\tof\t1.\tAll\tyou\thave\tto\tdo\tis\tgo\tto\tthe\tWorkloads\tpage,\tclick\ton the\tthree\tdots\tnext\tto\tthe\tgeolocation\treplication\tcontroller,\tand\tclick\ton\tScale. In\tthe\tscaling\tmodal,\tenter\tthe\tscaling\tfactor\t1\tand\thit\tOK:\n\nAs\tyou\tcan\tsee,\tthere\tis\tonly\tone\tinstance\tof\tthe\tgeolocation\tpod,\tand\tthe\tother one\twas\tautomatically\tdestroyed.\tThere\tis\tno\tguarantee\twhich\tpods\twill\tbe destroyed\tand\twhich\tones\twill\tbe\tretained.\tThat\tdecision\tis\tmade\tby\tKubernetes. So\tit\tis\thighly\trecommended\tthat\tyou\tdon't\twrite\tany\tlogic\tthat\tis\tvery deployment\tspecific.\tIn\tfact,\tthat\tis\tthe\twhole\tpoint\tof\tbuilding\tmicroservices. There\tare\tother\tways\tto\tscale\tyour\tmicroservice,\tsuch\tas\tmodifying\tthe\n\nYAML\tfile\tfrom\tinside\tthe\tKubernetes\tdashboard\tand\tusing\tkubectl\tto\tchange the\treplicas\tproperty\tof\tyour\tdeployment.\tWe\twill\ttake\ta\tvery\tquick\tlook\tat how\tyou\tcan\tdo\tit\twith\tkubectl,\tbecause\tthat\tis\tsomething\tyou\tmight\twant\tto\tdo when\tautomating\tyour\tdeployment\tprocess.\tFrom\tyour\tterminal\tshell,\texecute the\tfollowing\tkubectl\tcommand:\tkubectl\tscale\trc\tgeolocation\t--replicas=2",
      "content_length": 1417,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 285,
      "content": "replicationcontroller\t\"geolocation\"\tscaled\n\nHere,\trc\tstands\tfor\treplication\tcontroller.\tWe\tare\trequesting\tkubectl\tto\tscale\n\nthe\treplica\tof\tthe\tgeolocation\treplication\tcontroller\tto\t2.\tNewer\tversions\tof Kubernetes\tare\treplacing\treplication\tcontrollers\twith\treplica\tsets.\tScaling\tthem\tis slightly\tdifferent\tfrom\tthe\tpreceding\tapproach.\tNow\tto\tverify\tthe\tnumber\tof geolocation\tpods\trunning,\texecute\tthe\tfollowing\tcommand\tin\tthe\tsame\tterminal: kubectl\tget\tpods\tNAME\tREADY\tSTATUS\tRESTARTS\tAGE\tgeolocation- a2xce\t1/1\tRunning\t0\t42m\tgeolocation-l50r2\t1/1\tRunning\t0\t2m\thello- minikube-2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nThere\tare\t2\tgeolocation\tpods.\tScaling\tdown\tis\tas\tsimple\tas\tusing\tthe\tsame\n\ncommand\twith\t--replicas\tset\tto\t1.\n\nkubectl\tscale\trc\tgeolocation\t--replicas=1 replicationcontroller\t\"geolocation\"\tscaled\n\nNow,\tverify\tthat\tyou\thave\tonly\tone\tinstance\tof\tthe\tgeolocation\tpod\trunning,\n\nusing\tthe\tfollowing\tcommand:\tkubectl\tget\tpods\tNAME\tREADY\tSTATUS RESTARTS\tAGE\tgeolocation-a2xce\t1/1\tRunning\t0\t44m\thello-minikube- 2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto\tscale our\tapplication\tusing\tkubectl\tas\twell\tas\tthe\tKubernetes\tdashboard.",
      "content_length": 1198,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 286,
      "content": "Destroying\tyour\tmicroservice\tin Kubernetes\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tdeploy\tand\tscale\tour\tmicroservice\tin a\tKubernetes\tcluster.\tThere\twill\tbe\tscenarios\twhere\tyou\twould\twant\tto\tdestroy your\tmicroservice\tcompletely\tfrom\tyour\tcluster,\tprobably\tbecause\tyou\twould like\tto\tperform\ta\tclean\tredeploy.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tdestroy\tour microservice.",
      "content_length": 375,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 287,
      "content": "Getting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.",
      "content_length": 358,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 288,
      "content": "How\tto\tdo\tit... 1.\t To\tillustrate\tthe\tdestroy\tfunctionality,\tlet's\tdeploy\tthe\tgeolocation microservice\tfirst.\tUse\tthe\tfriendly\tform\tand\tenter\tthe\tfollowing configurations\tto\tcreate\tyour\tmicroservice:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nGo\tahead\tand\thit\tDeploy.\tAfter\tyour\tpod\tand\treplication\tcontroller\tare\tup\tand\n\nrunning,\tclick\ton\tthe\tthree\tdots\tnext\tto\tthe\tgeolocation\treplication\tcontroller. Then,\tchoose\tDelete\tfrom\tthe\tpopup\tmenu:\n\nIf\tyou\tare\tasked\tfor\tconfirmation,\tclick\ton\tOK.\tAfter\ta\tfew\tseconds,\tyou\twill notice\tthat\tthe\treplication\tcontroller\tand\tthe\tpod\twill\tbe\tdestroyed\tsuccessfully. At\tthe\ttime\tof\twriting\tthis,\tI\twas\tusing\ta\tversion\tof\tthe\tdashboard\tthat\tneeded\ta manual\trefresh\tto\tview\tthe\tstatus\tof\tthe\tpod\tand\treplication\tcontroller.\n\nAlso,\tif\tyou\tgo\tto\tthe\tServices\tsection,\tyou\twill\tsee\tthat\tthe\tgeolocation service\tis\tstill\trunning.\tGo\tahead\tand\tdelete\tthe\tservice\tfrom\tthe\tdashboard. You\tcan\talso\tdo\tthe\tsame\tthing\tusing\tthe\tkubectl\tcommand\twhen\tyou\tare automating\tdeployments\tusing\ttools\tsuch\tas\tJenkins\tor\tHudson.\tBefore\twe\ttry our\tkubectl\tcommand,\tcreate\tthe\tmicroservice\tagain\tusing\tthe\tKubernetes",
      "content_length": 1391,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 289,
      "content": "dashboard.\tAfter\tyour\tservice\tis\tup\tand\trunning,\tissue\tthe\tfollowing\tcommand\tin a\tterminal\twindow:\tkubectl\tdelete\trc\tgeolocation\treplicationcontroller \"geolocation\"\tdeleted\n\nAfter\ta\tfew\tseconds,\tif\tyou\trefresh\tyour\tdashboard\tpage,\tyou\twill\tsee\tthat\tthe\n\ngeolocation\treplication\tcontroller\tand\tpod\thave\tbeen\tsuccessfully\tdeleted.\tThe geolocation\tservice\twill\tstill\tbe\tup\tand\trunning.\tIn\torder\tto\tdelete\tit,\texecute\tthe following\tcommand\tfrom\tthe\tsame\tterminal\twindow:\tkubectl\tdelete\tservice geolocation\tservice\t\"geolocation\"\tdeleted\n\nNow\tgo\tback\tto\tyour\tdashboard\tand\tmake\tsure\tthe\tgeolocation\tservice\thas\tbeen successfully\tdeleted.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe,\twhere\twe\tlearned\thow\tto\tdelete\tour replication\tcontrollers,\tpods,\tand\tservices\tusing\tthe\tKubernetes\tdashboard\tas well\tas\tkubectl.\n\nNote\n\nIn\tmost\tautomation\tscenarios\twhere\tyou\tare\ttrying\tto\tautomate\tyour deployments\tto\ta\tKubernetes\tcluster,\tyou\twould\twant\tto\tinteract\twith Kubernetes'\tREST\tAPI.\tFortunately,\tKubernetes\tprovides\ta\tsophisticated\tREST API\tto\tperform\tall\tthe\toperations\twe\thave\tseen\tso\tfar\tin\tthis\tchapter.\tThe documentation\tfor\tthe\tREST\tAPI\tis\tavailable\there\tat\t http://kubernetes.io/docs/api\t.",
      "content_length": 1183,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 290,
      "content": "Monitoring\tyour\tmicroservice\tlogs\tin Kubernetes\n\nOne\tof\tthe\tmost\timportant\tfeatures\tthat\twill\tbe\thelpful\tafter\tyour\tmicroservices are\tdeployed\tto\ta\tcluster\tis\tbeing\table\tto\tmonitor\tthe\tlogs\tof\tyour\tapplication.\tIn this\trecipe,\tyou\twill\tlearn\thow\tto\tmonitor\tthe\tlogs\tof\tyour\tapplication\tfrom\tthe Kubernetes\tdashboard\tas\twell\tas\tkubectl.",
      "content_length": 335,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 291,
      "content": "Getting\tready\n\nOpen\tup\tthe\tKubernetes\tdashboard\tif\tyou\talready\thave\tyour\tcluster\trunning.\tIf not,\tuse\tMinikube\tto\tstart\tthe\tcluster\tand\topen\tthe\tdashboard.\tMake\tsure\tthere are\tno\tinstances\tof\tthe\tgeolocation\tcontainer\trunning\ton\tyour\tKubernetes\tcluster. If\tyou\thave\tany\tinstance\tof\tgeolocation\trunning,\tdelete\tthe\treplication controllers,\tservices,\tand\tpods.",
      "content_length": 358,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 292,
      "content": "How\tto\tdo\tit... 1.\t To\tbe\table\tto\tview\tthe\tlogs,\twe\tneed\tour\tmicroservice\tdeployed\ton\n\nKubernetes\tfirst.\tBefore\tthat,\tlet's\tget\tfamiliar\twith\tviewing\tthe\tlogs\tfrom the\tKubernetes\tdashboard.\tOpen\tit\tup.\tUse\tthe\tfriendly\tform\tand\tenter\tthe following\tconfigurations\tto\tcreate\tyour\tmicroservice:\n\nApp\tname:\tgeolocation Container\timage:\tvikrammurugesan/geolocation:latest Number\tof\tpods:\t1 Service:\tInternal Port:\t8080 Target\tport:\t8080 Protocol:\tTCP CPU\trequirement\t(cores):\t0.5 Memory\trequirement\t(MiB):\t512 Environment\tVariables Name:\tGEOLOCATION_DATA_FILES_DIR Value:\toptpackt/geolocation/data\n\nGo\tahead\tand\thit\tDeploy.\tOnce\tyour\tapplication\tis\tup\tand\trunning,\tclick\ton the\ticon\twith\tfour\tstripes\tnext\tto\tthe\tgeolocation\tpod\tfrom\tthe\tdashboard.\tThis icon\tindicates\tthe\tlogs\tbutton,\twhich\twill\ttail\tthe\tlogs\tfrom\tany\tcontainer\tin\tthat pod:\n\nAfter\tyou\tclick\ton\tthe\ticon,\tyou\twill\tbe\tshown\ta\tscreen\tthat\tlooks\tvery\tsimilar\n\nto\tyour\tterminal\tshell.\tYou\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 979,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 293,
      "content": "There\tare\ta\tfew\tuseful\toptions\tin\tthis\tterminal.\tFrom\tthe\tdropdown\tin\tthe\ttop section,\tyou\twill\tbe\table\tto\tchoose\tthe\tpod\tof\tyour\tchoice\tand\tview\tthe\tlogs\tfor that\tpod.\tIn\tour\tcase,\tthere\tis\tonly\tone\tpod\tin\tthe\treplication\tcontroller,\tso\tif\tyou click\ton\tthat\tdropdown,\tyou\twill\tbe\table\tto\tsee\tonly\tone\toption.\tThe\ticon\tthat says\tA\tis\tused\tto\ttoggle\tthe\tfont\tcolor\tand\tbackground\tcolor\tof\tyour\tterminal. The\tTt\ticon\tnext\tto\tthe\tA\ticon\tis\tused\tto\ttoggle\tbetween\ttwo\tfont\tsizes.\tThese two\toptions\tare\tparticularly\tuseful\twhen\tyou\thave\ta\tlot\tof\tuseful\tlogs\tthat\tyou would\tlike\tto\tmonitor\tas\tpart\tof\tyour\tdebugging\tprocess.\n\nThis\tscreenshot\tshows\thow\tthe\tterminal\twill\tlook\tlike\twhen\tyou\ttoggle\tthe\n\nfont\tcolor\tand\tfont\tsize:",
      "content_length": 720,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 294,
      "content": "You\twill\talso\tbe\table\tto\tview\tthe\tsame\tlogs\tfrom\tthe\tContainers\tsection under\tthe\tpod\tdetails.\tGo\tahead\tand\tclick\ton\tthe\tpod\tname\tand\tthen\tthe\tView Logs\thyperlink\tin\tthe\tgeolocation\tcontainer.\tThis\tshould\ttake\tyou\tto\ta\tlog\tpage like\tthe\tone\twe\tsaw\tearlier:",
      "content_length": 256,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 295,
      "content": "The\tnext\tuseful\ttip\tis\tbeing\table\tto\tview\tthe\tlogs\tusing\tkubectl.\tIt\tis\tvery simple\tto\tview\tthe\tlogs\tusing\tkubectl.\tFirst,\twe\tneed\tthe\tpod\tname.\tOpen\ta terminal\twindow\tand\texecute\tthe\tfollowing\tcommand:\tkubectl\tget\tpods\tNAME READY\tSTATUS\tRESTARTS\tAGE\tgeolocation-f0yk2\t1/1\tRunning\t0\t26m hello-minikube-2713628163-x6ge3\t1/1\tRunning\t3\t11d\n\nNow\tthat\twe\thave\tour\tpod\tnamed\tgeolocation-f0yk2,\tissue\tthe\tfollowing\n\ncommand\tin\tthe\tsame\tterminal:\tkubectl\tlogs\t-f\tgeolocation-f0yk2\n\nThe\t-f\toption\tsays\tthat\tyou\twant\tto\tfollow\tthe\tlogs\tor,\tin\tsimpler\tterms,\tit\twill\n\nlet\tyou\ttail\tthe\tlogs.\tYou\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 615,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 296,
      "content": "This\tis\tvery\tsimilar\tto\tthe\tdocker\tlogs\tcommand,\tright?\tThere\tare\ta\tfew\tmore options\tthat\tyou\tcan\tuse\twith\tthe\tkubectl\tlogs\tcommand,\tfor\texample,\tyou\tcan tail\tlogs\tfor\tthe\tpast\tfew\tminutes\tor\thours,\tand\tyou\tcan\ttail\tjust\ta\tfew\tlines\tof logs.\n\nNote\n\nTo\tlearn\tmore\tabout\tthese\toptions,\tread\tmore\tat\thttp://kubernetes.io/docs/user- guide/kubectl/kubectl_logs\t.\n\nThat's\tit!\tThat\tbrings\tus\tto\tthe\tend\tof\tthis\tchapter.\tIt\tgave\tyou\ta\tquick\toverview of\tthe\tKubernetes\tcluster\tand\thow\tto\tuse\tit\tlocally.\tIn\tproduction\tdeployments, there\tare\ta\tlot\tmany\tconsiderations\tand\tdesign\tdecisions\tthat\tyou\tmight\twant\tto think\tabout.\tAs\tthat\tis\tcompletely\tout\tof\tscope\tfor\tour\tbook,\twe\twill\tnot\tbe talking\tabout\tthose.\tHowever,\tit\tis\tstrongly\trecommended\tthat\tyou\tread\tmore about\tKubernetes\tbefore\tstarting\tto\t\"productionalize\"\tyour\tdeployments\tusing Kubernetes.",
      "content_length": 843,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 297,
      "content": "Chapter\t5.\tService\tDiscovery\tand Load\tBalancing\tMicroservices\n\nIn\tthis\tchapter,\tyou\twill\tlearn\thow\tto\timplement\tservice\tdiscovery\tand\tload balancing\tin\tmicroservices\tusing\tZookeeper\tand\tConsul.\tWe\twill\tcover\tthe following\trecipes:\n\nSetting\tup\tZookeeper\tusing\tDocker Load-balancing\tmicroservices\tusing\tZookeeper Setting\tup\tConsul\tusing\tDocker Implementing\tservice\tdiscovery\tusing\tSpring\tCloud\tConsul Load-balancing\tyour\tmicroservice\tusing\tSpring\tCloud\tConsul Load-balancing\tyour\tmicroservices\tusing\tNginx\tand\tConsul Load-balancing\tyour\tmicroservice\tusing\tMarathon\tLB",
      "content_length": 565,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 298,
      "content": "Introduction\n\nWhen\tyou\tbreak\tdown\tyour\tmonolithic\tapplication\tto\tseveral\tfocused microservices,\tyou\twill\thave\tto\tfind\tan\tefficient\tway\tto\tlocate\tyour\tservices; moreover,\tservices\twill\thave\tto\tcommunicate\twith\teach\tother.\tThat\tis\texactly what\tservice\tdiscovery\tis\tall\tabout.\tNow\tlet's\tsay\tyou\tfigured\tout\ta\tway\tto\tlocate them:\twhat\thappens\tto\tthose\tservices\tthat\tare\tscaled\tto\ta\tfactor\tgreater\tthan\tone? You\thave\tto\tefficiently\tload-balance\tthem.\tThis\tis\tanother\tproblem\tthat\tthis chapter\tintends\tto\tsolve.",
      "content_length": 505,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 299,
      "content": "Setting\tup\tZookeeper\tusing\tDocker\n\nIn\tChapter\t3\t,\tDeploying\tMicroservices\ton\tMesos,\twe\tlearned\ta\tlittle\tbit\tabout Zookeeper.\tTo\tkeep\tit\tvery\tsimple,\tZookeeper\tis\ta\tcluster-management\ttool\tthat is\tmainly\tused\tfor\tstoring\tyour\tcluster\tconfigurations.\tZookeeper\tis\tused\tby several\tApache\tbig\tdata\tprojects\tsuch\tas\tMesos,\tKafka,\tand\tBookkeeper.\tIn\tthis chapter,\twe\twill\tsee\thow\twe\tcan\tuse\tZookeeper\tto\tstore\tour\tmicroservice configurations\tand\tlater\tuse\tthem\tto\tperform\tload-balancing.\tThis\trecipe\twill show\tyou\thow\tto\tstart\tZookeeper\tand\tExhibitor\tusing\tDocker.\tExhibitor\tis\ta management\tinterface\tfor\tZookeeper.\tIn\taddition\tto\tproviding\ta\tweb\tinterface\tto manage\tZookeeper,\tit\talso\tperforms\tlog\tfile\tcleanups\tand\tbackups.\tWe\twill\tbe using\tthe\tExhibitor\tweb\tinterface\tto\tverify\tthat\tour\tservice\twas\tregistered\ton Zookeeper.",
      "content_length": 820,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 300,
      "content": "Getting\tready 1.\t We\tnow\tknow\tthat\twe\tneed\ttwo\tcomponents:\n\nZookeeper Exhibitor\n\nThey\tcould\teither\tbe\ttwo\tindividual\tcontainers\tlinked\ttogether\tvia\tdocker- compose\tor\tcould\tcoexist\tin\tthe\tsame\tcontainer.\n\n2.\t We\twill\tbe\tusing\tan\texisting\timage\tthat\thas\tboth\tZookeeper\tand\tExhibitor coexisting\tin\tthe\tsame\timage.\n\n3.\t We\twill\tbe\tcreating\ta\tdocker-compose.yml\tfile\tjust\tfor\tZookeeper\tand Exhibitor.\n\n4.\t The\treason\twe\tuse\tDocker\tCompose\teven\twhen\tthere\tis\tjust\tone\tcontainer is\tfor\tgrouping\tpurposes.\tI\talways\tlike\tkeeping\tmy\tcontainers\tgrouped together\tin\tCompose\tfiles\tso\tthat\tin\tcase\tyou\tneed\tto\tadd\ta\tnew\tdependent container\tin\tthe\tfuture,\tit\twill\tbe\teasy\tto\tadd\tit.\tIt\talso\thelps\tin\tversioning. On\ttop\tof\tthat,\tyou\tget\tto\tuse\tthe\tsophisticated\tDocker\tCompose\tcommand- line\tfeatures.\n\n5.\t Go\tahead\tand\topen\tyour\tSTS\tIDE.",
      "content_length": 822,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 301,
      "content": "How\tto\tdo\tit... 1.\t Create\ta\tnew\tfile\tcalled\tdocker-compose-zk.yml\tin\tthe\tgeolocation\n\nproject.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tDocker\tcompose file:\n\nversion:\t\"2\" services: \t\t\t\t\t\t\t\tzookeeper: \t\t\t\t\t\t\t\t\t\timage:\tmbabineau/zookeeper-exhibitor:latest \t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t-\t\"8181:8181\" \t\t\t\t\t\t\t\t\t\t\t\t-\t\"2181:2181\"\n\nAs\tyou\tcan\tsee,\twe\tare\tusing\tthe\timage\tcalled\tmbabineau/zookeeper- exhibitor,\tand\twe\tare\tusing\tthe\tlatest\ttag\tof\tthis\timage.\tThis\timage comes\twith\tZookeeper\tand\tExhibitor\tby\tdefault.\tThere\tare\ttons\tof\tother images\tthat\tyou\tcan\tuse\tif\tyou\tprefer\tto\tuse\tthem.\tYou\tcan\talso\tcreate\tyour own\timage\twith\tZookeeper\tand\tExhibitor\tin\tit\tor\tput\tZookeeper\tand Exhibitor\tin\ttheir\town\timages\tand\tlink\tthem\tusing\tdocker-compose.\tFor simplicity,\twe\tare\tusing\tthis\timage\tas\tit\tcomes\tout\tof\tthe\tbox\twith\tall\tthe components\twe\tneed.\tWe\thave\texposed\ttwo\tports,\t2181\tand\t8181.\t2181\tis the\tport\texposed\tby\tZookeeper\tthat\twe\twill\tbe\tusing\tin\tour\tcode\tto\tconnect to\tit.\tPort\t8181\tis\twhere\tthe\tExhibitor\tweb\tinterface\twill\tbe\tlistening.\tSo\twe need\tthese\ttwo\tports\tto\tbe\texposed\tfrom\tthese\tcontainers.\tAlso,\tas\tyou\tcan see,\tthese\tports\tare\tmapped\tto\tthe\tsame\tport\tnumber\ton\tthe\thost. 2.\t Without\tany\tdelay,\tlet's\tspin\toff\tZookeeper\tand\tExhibitor.\tOpen\tup\ta\n\nterminal\tshell\tand\tissue\tthe\tfollowing\tcommand:\n\ndocker-compose\t-f\tdocker-compose-zk.yml\tup\n\n3.\t As\tyou\tcan\tsee,\twe\tare\tpassing\tthe\tDocker\tCompose\tYML\tfile\tname\tas\tan argument\tas\twe\tare\tnot\tusing\tthe\tdefault\tdocker-compose.yml\tfilename.\tIt usually\ttakes\ta\tfew\tseconds\tto\tfew\tminutes\tto\tstart\tup\tExhibitor\tand Zookeeper\tcompletely.\tExhibitor\tmay\tbe\tup\tin\ta\tfew\tseconds,\tbut Zookeeper\ttakes\ta\tfew\tseconds\tto\ta\tcouple\tof\tminutes.\tSo\twait\tfor\tboth\tof them\tto\tbe\tup\tand\trunning.\tYou\tcan\tverify\tthat\tZookeeper\thas\tstarted\tif\tyou see\tsomething\tlike\tthis\tin\tyour\tconsole:",
      "content_length": 1827,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 302,
      "content": "4.\t After\tyou\tknow\tthat\tboth\tZookeeper\tand\tExhibitor\tare\tup\tand\trunning, open\tup\ta\tnew\tbrowser\ttab.\tEnter\tthis\tURL\tto\topen\tthe\tExhibitor\tweb interface:\thttp://192.168.99.100:8181/exhibitor/v1/ui/index.html. You\tshould\tsee\tthe\tExhibitor\thome\tpage,\twhich\tshows\tthe\tlist\tof\tinstances that\tare\tcurrently\trunning:\n\n5.\t Now\tmove\ton\tto\tthe\tExplorer\ttab.\tYou\tshould\tsee\ta\ttree\tthat\tlists\tall\tthe registered\tservices.\tIf\tyou\tare\table\tto\tsee\tZookeeper\tas\tshown\tin\tthe\tnext screenshot,\tExhibitor\tis\tproperly\tconfigured\tto\twork\twith\tour\tZookeeper instance:",
      "content_length": 544,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 303,
      "content": "That\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tnow\thave\ta\tfunctional\tZookeeper and\tExhibitor\tinstance.\tIn\tthe\tnext\trecipe,\twe\twill\tutilize\tthese\tservers\tto\tload- balance\tthe\tgeolocation\tmicroservice.",
      "content_length": 197,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 304,
      "content": "Load\tbalancing\tmicroservices\tusing Zookeeper\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\ta\tZookeeper\tinstance\talong\twith\tan Exhibitor\tinstance.\tIn\tthis\trecipe,\twe\twill\tutilize\tthese\tinstances\tto\tload-balance the\tgeolocation\tmicroservice.\tWe\twill\tbe\tspinning\toff\ttwo\tinstances\tof\tthe geolocation\tmicroservice\tand\tsee\thow\twe\tcan\tuse\tZookeeper\tand\tthe\tCurator API\tto\tperform\tround-robin\tstyle\tload\tbalancing\ton\tthe\tHTTP\tendpoints exposed\tby\tthe\tgeolocation\tmicroservice.\n\nLoad-balancing\tHTTP-based\tmicroservices\tis\ta\tsignificant\tstep\ttowards onboarding\tyour\tmicroservice\tto\ta\tcluster\tsuch\tas\tMesos\tor\tKubernetes. Scalability\twill\tnot\thave\tany\tvalue\tunless\tyou\tfigure\tout\ta\tway\tto\tload-balance your\tmicroservices.\tZookeeper\tis\tjust\tone\tway\tto\tdo\tthis;\twith\tthe\ttools\tcurrently available,\tthere\tare\tseveral\tways\tto\tdo\tthis:\tusing\tframeworks\tsuch\tas\tConsul and\tMarathon\tLB\t(Mesos/Marathon\tspecific).\tIn\tfact,\tthere\tare\tlibraries\tthat even\tlet\tyou\tperform\tload-balancing\ton\tthe\tclient\tside.\tWe\twill\tbe\tlooking\tat Consul\tand\tMarathon\tLB\tlater\tin\tthis\tchapter.",
      "content_length": 1048,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 305,
      "content": "Getting\tready\n\nImplementing\ta\tload\tbalancer\tusing\tZookeeper\tand\tthe\tCurator\tAPI\tinvolves two\tsteps.\tLet's\tlook\tat\tthem\tone\tby\tone:\n\n1.\t Register\tthe\tgeolocation\tmicroservice\tin\tZookeeper:\tIn\tthis\tstep,\tthe geolocation\tmicroservice\twill\tbe\tconfigured\tto\tregister\titself\tin\tZookeeper with\tthe\thost\tand\tport\tinformation\tof\tthe\tHTTP\tAPI.\n\n2.\t Implement\tload\tbalancer:\tIn\tthis\tstep,\twe\twill\tbe\tcreating\ta\tnew\tload balancer\tmicroservice\tthat\twill\tlook\tup\tthe\tgeolocation\tconfigs\tfrom Zookeeper\tand\tuse\tthem\tto\tproxy\tthe\tHTTP\trequests.",
      "content_length": 528,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 306,
      "content": "How\tto\tdo\tit...\n\nLet's\ttake\ta\tlook\tat\tthe\tfirst\tstep:\tregistering\tthe\tgeolocation\tmicroservice\tin Zookeeper.\tThis\tstep\tsays\tthat\tas\tand\twhen\ta\tnew\tinstance\tof\tthe\tgeolocation service\tstarts,\tit\tshould\tregister\titself\ton\tthe\tZookeeper\tinstance.\tRegistering\tthe service\tis\tnot\tjust\tadding\tthe\tservice\ton\tZookeeper,\tbut\talso\tstoring\tany\tconfig information\tabout\tthe\tgeolocation\tservice.\tIn\tthis\tcase,\tit\twill\tmake\tmore\tsense to\tstore\tthe\thostname\tand\tport\ton\twhich\tthe\tservice\tis\tlistening\ton\tas\tconfig information.\n\nIn\tthis\trecipe,\twe\twill\tbe\trelying\ton\tthe\tCurator\tAPI\tto\timplement\tservice discovery.\tCurator\tis\ta\tsophisticated\tJava\tlibrary\tfor\tZookeeper\tthat\thelps\tyou work\twith\tany\tZookeeper\tcluster.\tIt\thas\tseveral\tlibraries,\tsuch\tas\tclient, framework,\tRPC,\tand\tdiscovery.\tIn\tour\tapplication,\twe\twill\trequire\tthe framework\tand\tdiscovery\tlibraries.\n\n1.\t Without\tfurther\tado,\tlet's\tadd\tthese\ttwo\tdependencies\tto\tthe\tpom.xml\tfile\tof the\tgeolocation\tproject:\n\n<dependency>\t<groupId>org.apache.curator</groupId> <artifactId>curator-framework</artifactId> <version>2.11.0</version>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-x-discovery</artifactId> <version>2.11.0</version>\t</dependency>\n\nThe\tversion\t2.11.0\tworks\twith\tthe\tversion\tof\tZookeeper\tthat\twe\tare\tusing. Usually\tif\tyou\tdon't\tuse\tthe\tright\tversion\tof\tCurator,\tyour\tcode\twill\tnot\tbe able\tto\tconnect\tto\tZookeeper.\n\n2.\t Go\tahead\tand\tperform\ta\tMaven\tupdate\ton\tthe\tgeolocation\tproject\tso\tthat Maven\tdownloads\tthe\trequired\tdependencies.\tNext,\tlet's\tcreate\ta\tnew\tclass that\twill\tregister\tthe\tgeolocation\tservice\tin\tZookeeper.\tCreate\ta\tnew\tJava",
      "content_length": 1636,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 307,
      "content": "class\twith\tthe\tname com.packt.microservices.geolocation.Zookeeper.java.\tIn\torder\tto connect\tto\tZookeeper,\twe\tneed\tto\tknow\tthe\thost\tand\tport\ton\twhich\tit\tis running.\tSo\tlet's\tdefine\thost\tand\tport\tas\tmembers\tof\tthis\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\npublic\tclass\tZookeeper\t{\n\nprivate\tString\thost;\n\nprivate\tint\tport;\n\npublic\tZookeeper(String\thost,\tint\tport)\t{\n\nthis.host\t=\thost;\n\nthis.port\t=\tport;\n\n}\n\npublic\tvoid\tregister()\t{\n\n}\n\n}\n\n3.\t As\tyou\tcan\tsee,\twe\thave\talso\tcreated\ta\tconstructor\tto\tinstantiate\tthis\tclass. If\tyou\tare\ta\tSpring\tfan,\tyou\tcan\tcreate\tthis\tas\ta\tSpring\tbean\ttoo.\tThere\tis also\tan\tempty\tregister()\tmethod\tthat\twe\twill\tbe\tlater\tusing\tto\tregister\tthis",
      "content_length": 684,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 308,
      "content": "service\tin\tZookeeper.\tBefore\twe\tstart\timplementing\tthe\tregister() method,\tlet's\tdecide\twhere\tto\tinvoke\tthis\tmethod.\tSince\tour\tapp\tis\ta\tSpring Boot\tapplication,\tit\twould\tbe\ta\tgood\tidea\tto\tinvoke\tthis\tmethod\tfrom\tthe main\tmethod\tof\tthe\tGeolocationApplication.java\tclass.\tGo\tahead\tand invoke\tthe\tregister()\tmethod\tas\tthe\tlast\tline\tof\tthe\tmain\tmethod\tin GeolocationApplication.java.\tThe\tGeolocationApplication.java\tclass will\tnow\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\torg.springframework.boot.SpringApplication; import\torg.springframework.boot.autoconfigure.\n\nSpringBootApplication;\n\n@SpringBootApplication\n\npublic\tclass\tGeoLocationApplication\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{\n\nSpringApplication.run(GeoLocationApplication.class, args);\n\nnew\tZookeeper(\"192.168.99.100\",\t2181).register();\t}\n\n}\n\n4.\t As\tyou\tcan\tsee,\twe\thave\thardcoded\tthe\tZookeeper\thost\tand\tport\tnumber\tas 192.168.99.100\tand\t2181,\trespectively.\tTo\tmake\tyour\tmicroservice\tmore",
      "content_length": 978,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 309,
      "content": "configurable,\tthese\ttwo\targuments\tcan\tbe\tpassed\tas\t\tenvironment\tvariables to\tthe\tDocker\tcontainer\tand\tI'll\tleave\tthat\tas\tan\texercise\tfor\tyou\tto\ttry. 5.\t Now\tlet's\timplement\tthe\tremaining\tpieces\tin\tthe\tZookeeper.java\tclass.\n\nThere\tis\tone\tmore\tthing\twe\tneed\tto\tdo\tbefore\twe\timplement\tthe register()\tmethod.\tYes,\tyou\tare\tright:\twe\tneed\tthe\thostname\tand\tport number\ton\twhich\tthe\tgeolocation\tmicroservice\tis\trunning,\tbecause\tthey\t(at least\tthe\thost)\twill\tbe\tdifferent\tfor\tdifferent\tcontainers.\tLet's\tfirst\thandle\tthe hostname\tpart\tof\tit.\tGo\tahead\tand\tadd\tthe\tfollowing\tmethod\tto\tthe Zookeeper.java\tclass:\n\nprivate\tString\tgetIp()\t{\n\ntry\t{\n\nreturn\tInetAddress.getLocalHost().getHostAddress(); }\tcatch\t(UnknownHostException\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tlocal\tIP. Using\tlocalhost\tfor\tnow.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\nreturn\t\"localhost\";\n\n}\n\n}\n\nHere,\twe\tare\tusing\tthe\tInetAddress\tclass\tto\tget\tthe\tlocal\tIP\tof\tthe\tmachine on\twhich\tthis\tservice\tis\trunning.\tIf\tit\tthrows\tan\tUnknownHostException,\twe are\tdefaulting\tthe\thostname\tto\tlocalhost.\tThough\tthis\tis\tnot\ta\tgreat implementation,\tthe\tgoal\tof\tthis\trecipe\tis\tto\tgive\tyou\tan\tidea\tof\thow\tyou can\tuse\tZookeeper\tfor\tload-balancing,\tso\tthis\timplementation\twill\twork\tfor now.\n\n6.\t The\tnext\tconfiguration\twe\tneed\tis\tthe\tport\tnumber\ton\twhich\tthe\tapplication",
      "content_length": 1329,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 310,
      "content": "is\trunning.\tThis\tis\ta\tlittle\ttricky\tbecause\tSpring\tBoot\tdefaults\tthe\tport number\tof\tthe\tin-memory\tweb\tserver\tto\t8080.\tBut\tif\twe\tfind\ta\tway\tto\tuse an\tenvironment\tvariable,\tit\twould\thelp\tus\tdrive\tthe\tport\tnumber dynamically,\twhich\tcan\tthen\tbe\tpassed\tas\ta\tDocker\tenvironment\tvariable\tto our\tgeolocation\tcontainer.\tHowever,\tif\tyou\tknow\tthat\tyou\twill\talways\tbe using\t8080,\tthen\tyou\tdon't\thave\tto\tchange\tthis.\tIf\tyou\tdo\thave\tto\tchange ports,\tfortunately,\tSpring\tBoot\tlets\tyou\tchange\tthe\tport\tnumber\ton\twhich the\tweb\tserver\tstarts\tusing\ta\tproperty\tin\tthe\tapplication.properties\tfile. So\tcreate\ta\tnew\tproperties\tfile\tcalled\tapplication.properties\tin src/main/resources.\tIn\tthe\tfile,\tdrop\tthe\tfollowing\tline:\n\nserver.port=${GEOLOCATION_SERVICE_PORT:8080}\n\n7.\t As\tyou\tcan\tsee,\twe\tare\tderiving\tthe\tport\tnumber\tfrom\tan\tenvironment variable\tcalled\tGEOLOCATION_SERVICE_PORT.\tIf\tthe\tenvironment\tvariable\tis not\tdefined,\tit\tis\tdefaulted\tto\t8080.\tNow\tlet's\timplement\ta\tnew\tmethod\tin the\tZookeeper.java\tclass\tto\tget\tthis\tport\tnumber.\tAdd\tthe\tfollowing method\tto\tZookeeper.java:\n\nprivate\tint\tgetPort()\t{\n\ntry\t{\n\nreturn\tInteger.valueOf(System.getenv (\"GEOLOCATION_SERVICE_PORT\"));\t}\tcatch(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tservice port.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\nreturn\t8080;\n\n}\n\n}",
      "content_length": 1334,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 311,
      "content": "In\tthe\tgetPort()\tmethod,\twe\tare\tparsing\tthe\tport\tnumber\tfrom\tthe GEOLOCATION_SERVICE_PORT\tenvironment\tproperty.\tIf\tthe\tparsing\tfails,\twe default\tthe\tport\tnumber\tto\t8080.\tAgain,\tthis\tis\tnot\ta\tgreat\timplementation, but\tit\tis\ta\tgood\tstart\tto\timplementing\tload-balancing\tusing\tZookeeper. 8.\t With\tthat\tsaid,\tlet's\tadd\timplementation\tto\tthe\tregister()\tmethod.\tAdd\tthe\n\nfollowing\tsnippet\tto\tthe\tregister\tmethod:\n\npublic\tvoid\tregister()\t{\n\nCuratorFramework\tcurator\t=\n\nCuratorFrameworkFactory.newClient(host\t+\t\":\"\t+ port,\tnew\tRetryNTimes(3,\t3000));\n\ncurator.start();\n\ntry\t{\n\nfinal\tServiceInstance<Object>\tserviceInstance\t=\n\nServiceInstance.builder()\t\t\t\t\t\t.uriSpec(new UriSpec(\"\n\n{scheme}://{address}:{port}\")) .address(getIp()).port(getPort())\t.name(\"geolocation\")\n\n.build();\n\nfinal\tServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curator)",
      "content_length": 919,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 312,
      "content": ".basePath(\"com.packt.microservices\")\t.client(curator)\n\n.thisInstance(serviceInstance)\t.build();\n\nserviceDiscovery.start();\n\nRuntime.getRuntime().addShutdownHook(new\tThread(() ->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService(serviceInstance);\t}\tcatch (Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering service\tin\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\n}\n\n}));\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tregistering\tservice in\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();\n\n}",
      "content_length": 539,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 313,
      "content": "}\n\n9.\t There\tare\tfour\tmajor\tthings\thappening\there.\tLet's\ttake\ta\tlook\tat\tthem\tone by\tone:\n\nCuratorFramework\tcurator\t=\n\nCuratorFrameworkFactory.newClient(host\t+\t\":\"\t+\tport, new\tRetryNTimes(3,\t3000));\n\ncurator.start();\n\n10.\t In\tthe\tpreceding\tline,\twe\tconnect\tto\tZookeeper\tand\tstart\tthe\n\nCuratorFramework.\tThe\thost\tand\tport\tproperties\tthat\tare\tbeing\tused\tin\tthe preceding\tline\tare\tthe\thostname\tand\tport\tnumber\tof\tZookeeper\t(which\twere hardcoded\tto\t192.168.99.100\tand\t2181,\trespectively).\tRetryNTimes\tcomes with\tthe\tCurator\tAPI,\tand\tit\ttries\tthree\ttimes\tto\tconnect\tto\tZookeeper\twith\ta 3-second\ttimeout\teach\ttime.\n\nfinal\tServiceInstance<Object>\tserviceInstance\t=\n\nServiceInstance.builder().uriSpec(new\tUriSpec(\" {scheme}://{address}:\n\n{port}\")).address(getIp())\n\n.port(getPort())\n\n.name(\"geolocation\").build();\n\n11.\t The\tServiceInstance\tidentifies\tan\tinstance\tof\tour\tgeolocation\tservice\tin Zookeeper.\tAs\tyou\tcan\tsee,\twe\thave\talso\tpassed\tthe\taddress\tand\tport number\tof\tour\tservice\tusing\tthe\tgetIp()\tand\tgetPort()\tmethods.\tThe name\tof\tthe\tservice\tthat\twill\tbe\tused\tfor\tregistering\tand\tlookup\tis",
      "content_length": 1086,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 314,
      "content": "geolocation:\n\nfinal\tServiceDiscovery<Object> serviceDiscovery=ServiceDiscoveryBuilder\t.builder(Object.class)\n\n.basePath(\"com.packt.microservices\")\t.client(curator)\n\n.thisInstance(serviceInstance)\n\n.build();\n\nserviceDiscovery.start();\n\n12.\t In\tthe\tpreceding\tsnippet,\twe\tare\tregistering\tthe\tgeolocation\tservice\tinstance in\tZookeeper\twith\tthe\tbase\tpath\tcom.packt.microservices.\tIn\tthe\tfuture, if\tyou\twould\tlike\tto\tgroup\tmultiple\tservices,\tyou\tcould\tstill\tuse\tthe\tsame basePath\tbut\tdifferent\tservice\tnames.\n\nRuntime.getRuntime().addShutdownHook(new\tThread(()\t->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService(serviceInstance);\t}\tcatch (Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering service\tin\tZookeeper.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();",
      "content_length": 766,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 315,
      "content": "}\n\n}));\n\n13.\t In\tthe\tpreceding\tsnippet,\twe\tare\tadding\ta\tshutdown\thook\tto\tunregister\tthe geolocation\tservice\twhen\tthe\tmicroservice\tshuts\tdown.\tThis\tis\tstrongly recommended\tin\torder\tto\tclean\tup\tZookeeper\tso\tthat\tyou\tdon't\thave\tstale services\tregistered\tin\tZookeeper.\n\n14.\t After\tthese\tmodifications,\tthe\tZookeeper.java\tclass\tshould\tlook\tsomething like\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.net.InetAddress;\n\nimport\tjava.net.UnknownHostException;\n\nimport\torg.apache.curator.framework.CuratorFramework; import\torg.apache.curator.framework.CuratorFrameworkFactory; import\torg.apache.curator.retry.RetryNTimes;\timport org.apache.curator.x.discovery.ServiceDiscovery;\timport org.apache.curator.x.discovery.ServiceDiscoveryBuilder;\timport org.apache.curator.x.discovery.ServiceInstance;\timport org.apache.curator.x.discovery.UriSpec;\n\npublic\tclass\tZookeeper\t{\n\nprivate\tString\thost;\n\nprivate\tint\tport;",
      "content_length": 919,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 316,
      "content": "public\tZookeeper(String\thost,\tint\tport)\t{\n\nthis.host\t=\thost;\n\nthis.port\t=\tport;\n\n}\n\npublic\tvoid\tregister()\t{\n\nCuratorFramework\tcurator\t= CuratorFrameworkFactory.newClient(host\t+\t\":\"\n\n+\tport,\tnew\tRetryNTimes(3,\t3000)); curator.start();\n\ntry\t{\n\nfinal\tServiceInstance<Object>\tserviceInstance\t= ServiceInstance.builder()\t.uriSpec(new\tUriSpec(\" {scheme}://{address}:{port}\"))\t.address(getIp())\n\n.port(getPort())\n\n.name(\"geolocation\")\n\n.build();\n\nfinal\tServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curator)",
      "content_length": 591,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 317,
      "content": ".thisInstance(serviceInstance)\t.build();\n\nserviceDiscovery.start();\n\nRuntime.getRuntime().addShutdownHook(new Thread(()\t->\t{\n\ntry\t{\n\nserviceDiscovery.unregisterService (serviceInstance);\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tunregistering servicein\tZookeeper.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\n}\n\n}));\n\n}\tcatch\t(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tregistering service\tin\tZookeeper.\tDetails:\t\"\t+\te.getMessage()); e.printStackTrace();",
      "content_length": 484,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 318,
      "content": "e.printStackTrace();\n\n}\n\n}\n\nprivate\tString\tgetIp()\t{\n\ntry\t{\n\nreturn InetAddress.getLocalHost().getHostAddress();\t}\tcatch (UnknownHostException\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding\tlocal\tIP. Using\tlocalhost\tfor\tnow.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\nreturn\t\"localhost\";\n\n}\n\n}\n\nprivate\tint\tgetPort()\t{\n\ntry\t{\n\nreturn\tInteger.valueOf(System.getenv (\"GEOLOCATION_SERVICE_PORT\"));\t}\tcatch(Exception\te)\t{\n\nSystem.err.println(\"Error\twhile\tfinding service\tport.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+",
      "content_length": 520,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 319,
      "content": "service\tport.\tUsing\tdefault\tport\t8080.\tDetails:\t\"\t+\n\ne.getMessage());\n\ne.printStackTrace();\n\nreturn\t8080;\n\n}\n\n}\n\n}\n\n15.\t Now\tthat\tour\tmicroservice\tis\tready\tto\twork\twith\tZookeeper,\tlet's\tspin\toff two\tinstances\tof\tthe\tgeolocation\tservice\tand\tverify\tthat\tthey\tregister successfully\ton\tZookeeper.\tBut\tbefore\tthat,\tlet's\tbuild\ta\tnew\timage\tand push\tit\tto\tDocker\tHub.\n\n16.\t Go\tahead\tand\tbuild\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand. This\tshould\tcreate\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe target\tdirectory.\n\n17.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\texisting\timage.\tTo\tdo\tso, run\tthe\tfollowing\tcommand:\n\ndocker\trmi\tvikrammurugesan/geolocation\n\n18.\t To\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation\t.\n\n19.\t Make\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine\tin\tthe\tpreceding commands.\tAfter\tyour\timage\thas\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto Docker\tHub\tusing\tthe\tfollowing\tcommand.\tYou\tmight\tbe\tasked\tto\tlogin\tto your\tDocker\tHub\taccount\tif\tyou\thaven't\talready\tdone\tso. docker\tpush\tvikrammurugesan/geolocation",
      "content_length": 1102,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 320,
      "content": "20.\t Again,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe Last\tUpdated\ttime\tof\tyour\timage\tis\tsomething\tmore\trecent.\tNow\tthat\tour image\tis\tready\tto\tuse,\topen\tup\ttwo\tterminals\tand\tspin\toff\ttwo\tinstances\tof the\tgeolocation\tmicroservice:\n\ndocker\trun\tvikrammurugesan/geolocation\n\n21.\t While\tyou\tstart\tthe\tmicroservice,\tif\tyou\tsee\ta\tstack\ttrace\tthat\tsays\tthere\tis\ta NullPointerException\tin\tthe\tgetIp()\tmethod,\tit's\tbecause\twe\tdid\tnot\tpass the\tGEOLOCATION_SERVICE_PORT\tport\tnumber\tproperty\tto\teither\tof\tthe containers.\tYou\tcan\tignore\tas\tour\tservice\twill\tuse\t8080\tby\tdefault.\n\n22.\t After\tboth\tyour\tgeolocation\tservices\thave\tstarted,\topen\tup\tthe\tExhibitor\tUI using\tthe\tURL http://192.168.99.100:8181/exhibitor/v1/ui/index.html,\tand navigate\tto\tthe\tExplorer\ttab.\tNow\tyou\tshould\tsee\ta\tnew\titem\tcalled com.packt.microservices,\tand\tyou\tshould\tsee\tgeolocation\tunder\tit.\tIf you\texpand\tgeolocation,\tyou\tshould\tsee\ttwo\tinstances\twith\ttheir\town unique\tidentifiers:\n\n23.\t If\tyou\twant\tto\texplore\tfurther,\tclick\ton\tany\tof\tthe\tinstances\tand\tlook\tat\tits details\tat\tthe\tbottom\tof\tthe\tpage.\tYou\tshould\tbe\table\tto\tsee\tthe\tservice name,\tID,\thost,\tport\tnumber,\tand\tother\tconfigurations\tof\tthis\tservice\tunder the\tData\tas\tString\tsection:",
      "content_length": 1299,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 321,
      "content": "This\tbrings\tus\tto\tthe\tend\tof\tthe\tfirst\tpart\tof\tour\trecipe:\tregistering\tthe geolocation\tmicroservice\tin\tZookeeper.\n\nNow\tlet's\ttake\ta\tlook\tat\tbuilding\tour\tZookeeper-based\tload\tbalancer.\tThe\tload balancer\twill\tbe\tanother\tSpring\tBoot\tmicroservice\tthat\twill\tproxy\trequests\tover to\tthe\tgeolocation\tmicroservices\tin\ta\tround-robin\tfashion.\tIn\torder\tto\tachieve this\tbehavior,\twe\tneed\tthe\texact\tsame\tAPIs\ton\tthe\tload\tbalancer\tmicroservice.\n\n1.\t Go\tahead\tand\tcreate\ta\tnew\tMaven\tJAR\tproject\tcalled\tgeolocation-zk-lb with\tthe\tgroupId\tset\tto\tcom.packt.microservices\tand\tartifactId\tset to\tgeolocation-zk-lb.\tAs\tthis\tis\ta\tSpring\tBoot\tproject,\tadd\tspring-boot- starter-parent\tas\tthe\tparent\tmodule: <parent>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-parent</artifactId> <version>1.3.6.RELEASE</version>\t</parent>\n\n2.\t We\twill\tneed\ttwo\tMaven\tplugins\tfor\tthis\tmodule:\tmaven-compiler-plugin and\tspring-boot-maven-plugin.\tAdd\tthe\tsnippet\tto\tyour\tpom.xml\tfile:\n\n<properties>\t<start-class>com.packt.microservices.\n\ngeolocation.lb.GeolocationZkLoadBalancer</start- class>\t</properties>",
      "content_length": 1095,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 322,
      "content": "class>\t</properties>\n\n<build>\n\n<plugins>\n\n<plugin>\n\n<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<configuration>\n\n<source>1.8</source>\t<target>1.8</target> </configuration>\n\n</plugin>\n\n<plugin>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-maven-plugin</artifactId>\t<executions>\n\n<execution>\n\n<goals>\n\n<goal>repackage</goal>\t</goals>\n\n</execution>\n\n</executions>\n\n<configuration>",
      "content_length": 448,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 323,
      "content": "<configuration>\n\n<mainClass>${start-class}</mainClass> </configuration>\n\n</plugin>\n\n</plugins>\n\n</build>\n\n3.\t You\tshould\talready\tbe\tfamiliar\twith\tthe\tpreceding\tcode\tsnippet\tas\twe already\tcreated\ta\tmicroservice\tusing\tSpring\tBoot\tin\tthe\tfirst\tchapter.\tNow let's\tadd\tthe\tfollowing\tthree\tdependencies,\twhich\tyou\tare\talready\tfamiliar with:\n\n<dependencies>\t<dependency>\n\n<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-web</artifactId>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-framework</artifactId> <version>2.11.0</version>\t</dependency>\n\n<dependency>\n\n<groupId>org.apache.curator</groupId> <artifactId>curator-x-discovery</artifactId> <version>2.11.0</version>\t</dependency>",
      "content_length": 745,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 324,
      "content": "</dependencies>\n\n4.\t Perform\ta\tMaven\tupdate\ton\tthe\tproject\tto\tmake\tsure\tall\trequired\n\ndependencies\tare\tresolved.\tAfter\tthe\tbuild\tis\tcomplete,\tlet's\tcreate\tour Spring\tBoot\tapplication\tclass, com.packt.microservices.geolocation.lb.GeolocationZkLoadBalancer.java\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\torg.springframework.boot.SpringApplication; import\n\norg.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\n\npublic\tclass\tGeolocationZkLoadBalancer\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{\n\nSpringApplication.run (GeolocationZkLoadBalancer.class,\targs);\n\n}\n\n}\n\n5.\t The\tnext\tstep\tin\tour\tload\tbalancer\tmicroservice\tis\twriting\tthe\tZookeeper service-discovery\tlogic\tthat\tlooks\tup\tthe\tgeolocation\tservice\tinstances\tfrom Zookeeper\tin\ta\tround-robin\tfashion.\tTo\tdo\tthis,\tlet's\tcreate\ta\tnew\tclass",
      "content_length": 836,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 325,
      "content": "called com.packt.microservices.geolocation.lb.ZookeeperServiceDiscovery.java\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\tjava.net.URI;\n\nimport\torg.apache.curator.framework.CuratorFramework; import\torg.apache.curator.framework.CuratorFrameworkFactory; import\torg.apache.curator.retry.RetryNTimes;\timport org.apache.curator.x.discovery.ServiceDiscovery;\timport org.apache.curator.x.discovery.ServiceDiscoveryBuilder;\timport org.apache.curator.x.discovery.ServiceProvider;\n\npublic\tclass\tZookeeperServiceDiscovery\t{\n\nprivate\tstatic\tServiceProvider<Object> geolocationServiceProvider;\t\tprivate\tstatic ServiceProvider<Object>\tgetGeolocationServiceProvider()\tthrows Exception\t{\n\nif(geolocationServiceProvider\t==\tnull)\t{\n\nCuratorFramework\tcuratorFramework\t=\n\nCuratorFrameworkFactory.newClient (\"192.168.99.100:2181\",\tnew\tRetryNTimes(5,\t1000)); curatorFramework.start();\n\nServiceDiscovery<Object>\tserviceDiscovery\t=\n\nServiceDiscoveryBuilder.builder(Object.class)",
      "content_length": 966,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 326,
      "content": "ServiceDiscoveryBuilder.builder(Object.class) .basePath(\"com.packt.microservices\")\t.client(curatorFramework)\n\n.build(); serviceDiscovery.start();\n\ngeolocationServiceProvider\t=\n\nserviceDiscovery.serviceProviderBuilder() .serviceName(\"geolocation\")\t.build();\n\ngeolocationServiceProvider.start();\t}\n\nreturn\tgeolocationServiceProvider;\t}\n\npublic\tstatic\tURI\tgetGeolocationServiceUri()\tthrows Exception\t{\n\nreturn\tnew\n\nURI(getGeolocationServiceProvider() .getInstance().buildUriSpec());\t}\n\n}\n\nThere\tare\ta\tfew\tthings\tgoing\ton\there.\tFirst,\twe\tstart\tthe\tCurator\tframework, and\tthen,\twe\tuse\tthe\tServiceDiscovery\tinstance\tto\tbuild\tthe ServiceProvider\tobject\tfor\tthe\tgeolocation\tmicroservice\tat\tthe\tbasePath com.packt.microservices.\tYou\tcan\talso\tsee\tthat\tthe geolocationServiceProvider\tobject\tis\tkept\tsingleton\tso\tthat\twe\tdon't have\tto\tstart\tthe\tservice-discovery\tinstance\teach\ttime.",
      "content_length": 870,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 327,
      "content": "6.\t Now\tthat\tour\tdiscovery\tlogic\tis\tready,\tlet's\twrite\tour\tcontroller\tthat\tcalls proxy\trequests\tto\tthe\tgeolocation\tmicroservice.\tGo\tahead\tand\tcreate\ta\tnew controller\tcalled com.packt.microservices.geolocation.lb.GeolocationProxyController.java.\n\n7.\t Let's\tfirst\tcreate\tthe\tfindAll()\tmethod,\twhich\tobtains\tall\tgeolocations saved\tby\tthe\tgeolocation\tmicroservice.\tAdd\tthe\tfollowing\tsnippet\tto\tthe GeolocationProxyController.java\tclass:\n\n@RequestMapping(path\t=\t\"/geolocation\",\tmethod\t=\n\nRequestMethod.GET,\tproduces\t=\t\"application/json\") public\t@ResponseBody\tString\tfindAll()\tthrows\tException\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();\n\nSystem.out.println(\"Proxying\tGET\trequest\tto\tservice\t\" +\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,\n\nserviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(),\n\nrequest.getQueryString(),\n\nnull);",
      "content_length": 941,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 328,
      "content": "null);\n\nreturn\trestTemplate.getForEntity(uri, String.class).getBody();\n\n}\n\nIn\tthe\tpreceding\tAPI,\twe\tare\tfirst\tobtaining\tthe\tURI\tfor\tour\tgeolocation microservice\tand\tthen\tusing\tthat\tURI\tto\tconstruct\ta\tnew\tURI\twith\tthe\tright path\tand\theaders.\tThe\tnewly\tcreated\tURI\tis\tthen\tinvoked\tusing\ta RestTemplate.\n\n8.\t We\twill\timplement\ta\tsimilar\tAPI\tfor\tcreating\tgeolocations.\tFinally,\ta\tfully refactored\tGeolocationProxyController.java\tclass\twill\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation.lb;\n\nimport\tjava.net.URI;\n\nimport\tjavax.servlet.http.HttpServletRequest;\n\nimport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.http.HttpEntity;\timport org.springframework.http.HttpHeaders;\timport org.springframework.http.HttpMethod;\timport org.springframework.http.MediaType;\timport org.springframework.stereotype.Controller;\timport org.springframework.web.bind.annotation.RequestBody;\timport org.springframework.web.bind.annotation.RequestMapping;\timport org.springframework.web.bind.annotation.RequestMethod;\timport org.springframework.web.bind.annotation.ResponseBody;\timport org.springframework.web.client.RestTemplate;\n\n@Controller",
      "content_length": 1170,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 329,
      "content": "@RequestMapping(\"/geolocation\")\n\npublic\tclass\tGeolocationProxyController\t{\n\nprivate\tRestTemplate\trestTemplate\t=\tnew RestTemplate();\n\n@Autowired\n\nprivate\tHttpServletRequest\trequest;\n\n@RequestMapping(path\t=\t\"\",\tmethod\t= RequestMethod.POST,\tproduces\t=\t\"application/json\",\tconsumes\t=\n\n\"application/json\")\n\npublic\t@ResponseBody\tString\tcreate(@RequestBody String\tbody)\tthrows\tException\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();\n\nSystem.out.println(\"Proxying\tPOST\trequest\tto\tservice \"\t+\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,",
      "content_length": 627,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 330,
      "content": "serviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(),\n\nrequest.getQueryString(),\n\nnull);\n\nHttpHeaders\theaders\t=\tnew\tHttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON);\n\nHttpEntity<String>\tentity\t=\tnew\tHttpEntity<String> (body,\theaders);\n\nreturn\trestTemplate.exchange(uri,\tHttpMethod.POST, entity,\tString.class).getBody();\n\n}\n\n@RequestMapping(path\t=\t\"\",\tmethod\t=\tRequestMethod.GET, produces\t=\t\"application/json\")\n\npublic\t@ResponseBody\tString\tfindAll()\tthrows Exception\t{\n\nURI\tserviceUri\t=\n\nZookeeperServiceDiscovery.getGeolocationServiceUri();",
      "content_length": 574,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 331,
      "content": "System.out.println(\"Proxying\tGET\trequest\tto\tservice \"\t+\n\nserviceUri.toString()\t+\t\"\tat\tpath\t\"\t+\n\nrequest.getRequestURI());\n\nURI\turi\t=\tnew\tURI(serviceUri.getScheme(),\tnull,\n\nserviceUri.getHost(),\n\nserviceUri.getPort(),\n\nrequest.getRequestURI(), request.getQueryString(),\tnull);\n\nreturn\trestTemplate.getForEntity(uri, String.class).getBody();\n\n}\n\n}\n\n9.\t Without\tfurther\tdelay,\tlet's\ttest\tour\tnewly\tcreated\tZookeeper-based\tHTTP load\tbalancer.\tIn\torder\tto\tdo\tthat,\twe\thave\tto\tfollow\tthese\tsteps:\n\n1.\tStart\tZookeeper\tand\tExhibitor.\n\n2.\tStart\ttwo\tinstances\tof\tgeolocation\t(as\tDocker\tcontainers).\n\n3.\tStart\tgeolocation-zk-lb.\n\n10.\t Use\tthe\tdocker-compose-zk.yml\tfile\tto\tstart\tZookeeper\tand\tExhibitor.",
      "content_length": 692,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 332,
      "content": "Open\tup\ttwo\tterminal\tsessions\tand\tissue\tthe\tfollowing\tcommand\ton\tboth\tof them:\n\ndocker\trun\tvikrammurugesan/geolocation\n\n11.\t Once\tyour\tgeolocation\tinstances\tare\tup\tand\trunning\t(which\tincludes registering\tto\tZookeeper\tas\twell),\tverify\tthat\tthese\tservices\tare\tregistered\tin Zookeeper\twith\tthe\tname\tgeolocation\tunder\tthe basePathcom.packt.microservices.\tYou\tshould\tbe\table\tto\tuse\tthe Exhibitor\tUI\tat http://192.168.99.100:8181/exhibitor/v1/ui/index.html\tto\tdo\tthis.\n\n12.\t Before\twe\tcan\tstart\tthe\tgeolocation-zk-lb\tmicroservice,\tit\tneeds\tto\tbe Dockerized\tso\tthat\tit\tcan\trun\tas\ta\tDocker\tcontainer.\tGo\tahead\tand\tcreate\ta Dockerfile\tin\tthe\tgeolocation-zk-lb\tproject,\twith\tthe\tfollowing\tcontents:\n\nFROM\topenjdk:8 ADD\ttarget/geolocation-zk-lb-0.0.1-SNAPSHOT.jar\t optpackt/geolocation/ EXPOSE\t8080 CMD\t[\"java\",\t\"-jar\",\t\"optpackt/geolocation/geolocation-zk-lb- 0.0.1-SNAPSHOT.jar\"]\n\n13.\t Build\tthe\tproject\tusing\tthe\tmaven\tcommand:\tmvn\tclean\tpackage 14.\t Now\tbuild\tand\tstart\tthe\tgeolocation-zk-lb\timage\tusing\tthe\tfollowing command:\n\ndocker\tbuild\t-t\tvikrammurugesan/geolocation-zk-lb\t.\t&&\tdocker\t run\t-p\t8080:8080\tvikrammurugesan/geolocation-zk-lb\n\n15.\t Once\tthe\tgeolocation-zk-lb\tcontainer\tis\tup\tand\trunning,\tissue\tthe following\tcurl\tcommands\tto\ttest\tthe\tload\tbalancer:\n\ncurl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:8080/geolocation\n\n16.\t This\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\"timestamp\":\t1468203975",
      "content_length": 1723,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 333,
      "content": "} curl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t '{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://192.168.99.100:8080/geolocation\n\n17.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthis\t(pretty-printed\tfor readability):\n\n{ \t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\"timestamp\":\t1468203975 }\n\n18.\t To\tcheck\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\n\ncurl\thttp://192.168.99.100:8080/geolocation\n\n19.\t It\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n[ \t\t{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t41.803488, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t} ]\n\n20.\t But\twait!\tWe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's try\tthe\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\toutput\tlike this\t(pretty-printed\tfor\treadability): [ \t\t\t\t\t\t\t\t{ \t\t\t\t\t\t\t\t\t\t\"latitude\":\t9.568012, \t\t\t\t\t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\t\t\t\t\"timestamp\":\t1468203975 \t\t\t\t\t\t\t\t} ]\n\n21.\t Again,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime,\tit\tis\ta\tdifferent\tone.\tIn",
      "content_length": 1338,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 334,
      "content": "order\tto\tunderstand\twhat\tis\tgoing\ton,\twe\tshould\tfirst\tlook\tat\tthe\tlogs\tof\tthe geolocation-zk-lb\tcontainer.\tYou\tshould\thave\tsomething\tlike\tthis:\n\nProxying\tPOST\trequest\tto\tservice\thttp://172.17.0.2:8080\tat\tpath\t /geolocation Proxying\tPOST\trequest\tto\tservice\thttp://172.17.0.3:8080\tat\tpath\t /geolocation Proxying\tGET\trequest\tto\tservice\thttp://172.17.0.2:8080\tat\tpath\t /geolocation Proxying\tGET\trequest\tto\tservice\thttp://172.17.0.3:8080\tat\tpath\t /geolocation\n\n22.\t If\tyou\tnotice\tthe\tIPs\tin\tthe\tpreceding\tlogs,\tthey\tare\talternating.\tThis indicates\tthat\tour\tservice-discovery\tlogic\tuses\tround\trobin\tand\tworks\tas expected.\tAs\tour\tgeolocations\tare\tstored\tin\tmemory,\teach\tgeolocation instance\twas\tholding\tone\tgeolocation\teach.\tThat\tis\tthe\treason\twe\tgot\tone\tas a\tresult\tof\tthe\tGET\tAPI\teach\ttime.\tFor\tsimplicity,\twe\tstored\tour geolocations\tin\tmemory,\tbut\tin\tproduction\tscenarios,\tyou\twill\tbe\tstoring them\tin\tdatabases\tthat\tare\tshared\tby\tall\tthese\tinstances,\tso\twe\twill\tnot\thave this\tissue.\n\nNote\n\nThe\tZookeeperServiceDiscovery.java\tclass\tcan\tbe\trefactored\tto\thold\tmultiple service\tproviders,\tone\tfor\teach\tof\tyour\tmicroservices.\tIf\tyour\tecosystem\thas several\tmicroservices,\tyou\tcould\tstill\tuse\tthis\tapproach\tto\tload-balance\tthem using\tZookeeper.\tBut\tthis\tcomes\twith\tits\town\tmerits\tand\tdemerits.\tOne\tof\tthe demerits\tis\tthat\tyou\thave\tto\tcreate\tan\tAPI\tthat\tmatches\tthe\tmicroservice's\tAPI. Any\tchange\tto\tthe\tmicroservice's\tAPI\tcontract\twill\trequire\ta\tchange\tin\tthe\tload balancer\tas\twell.\tSo\twhen\tit\tcomes\tto\tseveral\thundred\tmicroservices,\tthis\tmight not\tbe\tscalable.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tCongrats!\tYou\tnow\tknow\thow\tto\tload- balance\tyour\tHTTP-based\tmicroservices\tusing\tZookeeper.",
      "content_length": 1684,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 335,
      "content": "Setting\tup\tConsul\tusing\tDocker\n\nSo\tfar\tin\tthis\tchapter,\twe've\ttalked\tabout\tthe\tneed\tfor\tservice\tdiscovery\tand\tload balancing.\tWe\talso\tlearned\thow\tto\tuse\tZookeeper\tto\tperform\tservice\tdiscovery and\tload\tbalancing.\tIf\tyou've\ttried\tthe\tprevious\trecipes\tin\tthis\tchapter,\tyou\twill have\trealized\tit\trequires\tsome\teffort\tto\tmanage\tyour\tservices\tin\tZookeeper.\tIt also\trequires\tsome\tcode\tto\tbe\twritten.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tlearn\tto\tdo the\tsame\tthing\twith\tConsul.\tConsul\tis\ta\tservice-discovery\tframework\tfrom HashiCorp\tthat\tis\tmulti-datacenter\taware.\tOne\tvery\tuseful\tfeature\tConsul\tcomes with\tis\tdistributed\tkey-value\tstorage.\tThis\tis\treally\tuseful\twhen\tyou\twant\tto store\tconfiguration\tinformation.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\torchestrate Consul\tusing\tDocker.",
      "content_length": 770,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 336,
      "content": "Getting\tready\n\nHashiCorp\thas\treleased\tofficial\timages\tof\tconsul\tand\ttheir\tother\tproducts.\tSo this\trecipe\tis\tgoing\tto\tbe\tpretty\tstraightforward.\n\n1.\t The\teasiest\tway\tto\tstart\tConsul\tis\tby\texecuting\ta\tdocker\trun\tcommand with\tthe\timage\tname.\n\n2.\t The\tname\tof\tthe\timage\tis\tpretty\tstraightforward\ttoo:\tconsul.\tLike\twe\tsaw in\tthe\tfirst\trecipe\tof\tthis\tchapter,\tit\tis\talways\teasier\tto\tgroup\tyour\timages into\tDocker\tCompose\tfiles.\n\n3.\t So\twe\twill\tbe\tcreating\ta\tdocker-compose\tfile\tthat\thas\tjust\tConsul\tin\tit.\tWe will\tbe\tadding\tmore\tcontainers\tto\tthe\tCompose\tYML\tfile\tin\tlater\trecipes.\n\n4.\t Open\tyour\tSTS\tIDE.",
      "content_length": 599,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 337,
      "content": "How\tto\tdo\tit... 1.\t Create\ta\tnew\tdocker-compose\tYML\tfile\tand\tname\tit\tdocker-compose-\n\nconsul.yml.\tIn\tthe\tcompose\tfile,\tdrop\tthe\tfollowing\tsnippet:\n\nversion:\t\"2\" services: \t\t\t\t\t\t\t\tconsul: \t\t\t\t\t\t\t\t\t\timage:\tconsul:latest \t\t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t\t\t-\t\"8500:8500\"\n\n2.\t Now\tthat\tour\tdocker-compose\tfile\tis\tcomplete,\twe\tare\tall\tset\tto\tstart consul.\tBefore\tthat,\tlet's\tget\tfamiliar\twith\tsome\tbasic\tconcepts\tof\tconsul. Only\tthen\twill\twe\tbe\table\tto\tunderstand\twhy\twe\tare\tperforming\tthe\tnext few\tsteps\tin\tthis\tchapter.\n\nUnderstanding\tthe\tconcepts\tof\tConsul\n\nLike\twe\talready\tknow,\tConsul\tis\ta\tservice-discovery\ttool.\tIt\tachieves\tthis\tusing agents.\tTo\tput\tit\tin\ta\tsimpler\tway,\tconsul\tagents\tare\tlong-running\tprocesses\tthat keep\ttrack\tof\tall\tyour\tservices\tand\tany\tkey-value\tpairs.\tThough\tthis\tstatement makes\tconsul\tlook\tas\tif\tit\tis\ta\tsimple\ttool,\tit\tactually\toffers\tmore\tthan\tthat\t(such as\tDNS),\tand\tthe\tworking\tof\tconsul\tis\tmore\tcomplicated\tthan\tit\tlooks.\tNow\tlet's talk\ta\tlittle\tbit\tabout\tagents.\tAgents\tcan\tstart\teither\tas\ta\tclient\tor\tserver.\tIdeally, in\tany\tconsul\tcluster,\tthere\twill\tbe\tthree\tto\tfive\tservers\tand\ta\tfew\tclients.\n\nA\tclient\tis\ta\tlightweight\tprocess\tresponsible\tfor\tregistering\tservices\tand performing\thealth\tchecks.\tIn\tan\tideal\tproduction\tscenario,\tthere\tcould\tbe hundreds\tor\teven\tthousands\tof\tclients.\tOne\tof\tthe\tservers\tis\talways\tthe\tleader, and\tthe\tothers\tare\tfollowers.\tThe\treason\tfor\thaving\tmore\tservers\tis\tto\tensure\tthat if\tthe\tleader\tgoes\tdown,\tthere\tis\talways\tanother\tserver\tto\tbe\telected\tas\tleader.\tIf you\thave\ta\tmulti-datacenter\tinfrastructure,\tit\tis\trecommended\tthat\tyou\thave similar\tclusters\ton\teach\tdatacenter,\tand\tthey\tall\twill\twork\ttogether.\tThis\tis\thow an\tideal\tconsul\tcluster\ton\ta\tsingle\tdatacenter\tlooks\tlike:",
      "content_length": 1735,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 338,
      "content": "Note\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tthe\tarchitecture\tof\tconsul\tand\thow\tall these\tcomponents\twork\ttogether,\tvisit\tconsul's\tdocumentation\tpage\tat https://www.consul.io/docs/internals/architecture.html\t.\n\nWith\tthat,\twe\tnow\tknow\twhat\twe\tneed\tto\tdo\tnext.\tYou\tguessed\tit:\twe\tneed\tto start\ta\tconsul\tagent.\tIn\tthis\trecipe,\twe\twill\tbe\tstarting\tan\tagent\tin\tdevelopment mode.\tDevelopment\tmode\tstarts\tjust\tone\tserver,\tand\tconsul\thighly\tdiscourages the\tuse\tof\tthis\tmode\tin\tproduction\tunless\tused\tfor\tlocal\tdevelopment\tand\ttesting purposes.\n\n1.\t Now,\topen\ta\tterminal\tsession\tand\tissue\tthe\tfollowing\tcommand:\n\ndocker-compose\t-f\tdocker-compose-consul.yml\tup",
      "content_length": 649,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 339,
      "content": "2.\t You\tshould\tsee\tsomething\tlike\tthis:\n\nIf\tyou\tlook\tat\tthe\tconsole\tlogs\tclosely,\tyou\tcan\tsee\tthat\tconsul\thas\tstarted one\tserver,\tand\tthis\tnode\tis\tpart\tof\tthe\tdata\tcenter\tcalled\tDC1.\tThe\tLAN and\tWAN\tservers\tare\tboth\trunning\ton\tport\t8300.\tWhile\tthe\tformer\tis\tused for\tcommunication\tbetween\tnodes\tin\tthe\tsame\tdata\tcenter,\tthe\tlatter\tis\tused for\tcommunication\twith\tservers\ton\tanother\tdata\tcenter.\n\n3.\t Once\tyou\tknow\tthat\tyour\tconsul\tagent\thas\tstarted\tsuccessfully,\topen\tup\ta new\tbrowser\tand\tnavigate\tto\tthis\tURL:\thttp://192.168.99.100:8500. 4.\t You\twill\tsee\tthe\tconsul\thome\tpage,\tand\tthe\tServices\ttab\twill\tbe\tselected\tby default.\tThis\tis\twhere\tyou\twill\tsee\tall\tyour\tregistered\tservices.\tYou\tshould see\ta\tservice\tcalled\tconsul.\tThat\tis\tbecause\tconsul\twill\thave\tregistered\tthe server\tas\ta\tservice:\n\n5.\t The\tother\ttab\tyou\tmight\tbe\tinterested\tin\tis\tthe\tKey/Value\ttab.\tThis\tis where\tyou\tcan\tcreate,\tview,\tupdate,\tand\tdelete\tyour\tkey-value\tpairs.\tAt\tthe top\tright,\tyou\tshould\tsee\ta\tdropdown\twith\tthe\tname\tof\tthe\tcurrently selected\tdata\tcenter.\tIf\tyou\thave\tmultiple\tdata\tcenters,\tthis\tdropdown\twill have\tmore\tthan\tone\tvalue,\tand\tyou\twill\tbe\table\tto\tsee\tthe\tnodes,\tservices,",
      "content_length": 1163,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 340,
      "content": "and\tkey-value\tpairs\tin\teach\tdata\tcenter.\tThis\tis\tvery\tuseful\twhen\tyou\thave\ta multi-datacenter\tsetup.\n\n6.\t Though\tServices\tis\tthe\tdefault\ttab\tselected\twhen\tyou\topen\tthe\tUI,\tthe Nodes\ttab\tis\tsomething\tthat\tmakes\tmore\tsense\tto\tstart\twith.\tNow\tlet's\tclick on\tit.\tOn\tthe\tleft-hand\tside,\tyou\twill\tsee\tthe\tlist\tof\tnodes\twith\ttheir\tIDs. Click\ton\tthe\tnode.\tNow\tyou\twill\tsee\tsome\tinteresting\tinformation\ton\tthe right-hand\tside:\n\nAs\tyou\tcan\tsee,\tit\tshows\tthe\tservices\tthat\tare\tcurrently\tdiscovered\tand shows\tthe\tSerf\tHealth\tStatus.\tSerf\tis\tanother\tproduct\tfrom\tHashiCorp\tthat is\tused\tby\tconsul\tfor\tcluster\tmemberships,\thealth\tchecks,\tand\tfailure detection.\n\nNote\n\nImportant\tinformation\tto\tnote\ton\tthis\tpage\tis\tthe\tport\tnumber,\t8300,\ton\tthe consul\tserver\twidget.\tIt\ttells\tyou\tthat\tthe\tConsul\tserver\tis\trunning\ton\tport 8300.\tAt\tthe\ttop\tright\tof\tthe\tpage,\tyou\tshould\tbe\table\tto\tsee\tthe\tDeregister button,\twhich\twill\tderegister\tthis\tnode\tfrom\tthe\tcluster.\tIf\tyou\tare interested,\tyou\tcan\tdrill\ta\tlittle\tdeeper\tto\tthe\tservice\tlevel.\n\n7.\t Go\tahead\tand\tclick\ton\tthe\tConsul\tservice,\tand\texplore\tthe\tvarious\toptions that\tconsul\toffers.\tAs\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tour\tbook,\twe\twill\tnot",
      "content_length": 1173,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 341,
      "content": "be\ttalking\tabout\tit.\tHowever\tyou\twill\tget\ta\tchance\tto\tunderstand\tsome sections\tof\tthe\tservice\tpage\tin\tour\tnext\trecipe.",
      "content_length": 118,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 342,
      "content": "Implementing\tservice\tdiscovery\tusing Spring\tCloud\tConsul\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\ta\tconsul\tagent\tin\tdevelopment.\tIn\tthis recipe,\twe\twill\tbe\tusing\tthat\tconsul\tagent\tto\timplement\tservice\tdiscovery\tfor\tthe geolocation\tmicroservice.\tWhen\twe\tdid\tsomething\tsimilar\tusing\tZookeeper, there\twas\tlot\tof\tcode\tinvolved\tto\tconnect\tto\tZookeeper,\tidentify\tthe\tIP,\tidentify the\tport,\tand\tfinally\tregister\tthe\tservice.\tWe\tperformed\tthese\tsteps\tusing\tthe curator\tAPI,\twhich\tmade\tour\tlife\teasier.\tBut\tfortunately,\tyou\tdon't\thave\tto\tdo\tall this\tfor\tconsul.\tSpring\tCloud\thas\ta\tlibrary\tfor\tconsul,\twhich\tautomatically registers\tthe\tservice\twith\tthe\thost\tand\tport\tinformation.\tAll\twe\thave\tto\tprovide\tis a\tcouple\tof\tproperties.\tLet's\ttake\ta\tlook\tat\thow\tto\tdo\tthat\tnow.",
      "content_length": 760,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 343,
      "content": "Getting\tready 1.\t In\torder\tto\tregister\tthe\tgeolocation\tservice\tin\tconsul,\twe\tfirst\thave\tto\tmake sure\tthat\tthe\tconsul\tagent\tis\tup\tand\trunning.\tIf\tyou\tdon't\thave\tan\tagent running,\tstart\tit\tusing\tdocker-compose.\n\n2.\t Go\tahead\tand\tmake\tsure\tconsul\twas\tproperly\tstarted\tby\taccessing\tthe\tweb interface\tat\thttp://192.168.99.100:8500.\n\n3.\t There\tis\tone\tmore\tthing\twe\tneed\tto\tdo\tbefore\twe\tintegrate\tconsul\tinto\tour microservice.\tWe\thave\tto\tcomment\tout\tthe\tline\tof\tcode\tin\tthe GeolocationApplication.java\tclass,\twhere\tit\ttries\tto\tconnect\tto Zookeeper.\tSimply\tcomment\tout\tthat\tline\tso\tthat\tthe\tnext\ttime\tyou\tstart\tthe application,\tit\tdoes\tnot\ttry\tto\tconnect\tto\tZookeeper.\n\n4.\t Also,\tadd\ta\tcomment\tpreceding\tit\tsaying\tit\thas\tbeen\tcommented\tout\tfor\ta reason:\t//\tcommented\tout\tso\tthat\tthe\tservice\tdoes\tnot\ttry\tto\tconnect\tto zk\t//\tnew\tZookeeper(\"192.168.99.100\",\t2181).register();\n\nThat's\tit!\tNow\tlet's\tmove\ton\tto\tthe\tactual\timplementation\tpart,\twhere\twe\twill integrate\tconsul\twith\tthe\tgeolocation\tmicroservice.",
      "content_length": 996,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 344,
      "content": "How\tto\tdo\tit... 1.\t The\tfirst\tthing\twe\tneed\tto\tdo\tis\tadd\tthe\trequired\tdependencies\tto\tour pom.xml\tfile.\tThe\tdependency\tthat\tgeolocation\twill\tneed\tis\tspring- cloud-starter-consul-all.\tLet's\tadd\tit\tto\tthe\tdependencies\tsection\tof the\tpom.xml\tfile\tin\tthe\tgeolocation\tproject:\t<dependency> <groupId>org.springframework.cloud</groupId>\t<artifactId>spring-cloud- starter-consul-all</artifactId>\t<version>1.1.2.RELEASE</version> </dependency>\n\nThe\tpreceding\tdependency\tpacks\tpretty\tmuch\tall\tthe\tdependencies\tthat\tare required\tfor\tour\tproject\tto\tconnect\tto\tconsul\tand\tregister\tour\tservice.\tAs\twe have\tadded\ta\tnew\tdependency,\twe\thave\tto\tperform\ta\tMaven\tupdate\tto resolve\tall\tthe\tnew\tdependencies.\n\n2.\t When\tthe\tbuild\tis\tcomplete,\tcreate\ta\tnew\tproperties\tfile\tcalled bootstrap.properties\tin\tthe\tsrc/main/resources\tdirectory.\tAdd\tthe following\tsnippet\tto\tthe\tfile:\tspring.application.name=geolocation spring.cloud.consul.host=192.168.99.100\tspring.cloud.consul.port=8500\n\nThe\tspring.application.name\tproperty\tis\toptional,\tbut\tit\tis\thighly recommended\tbecause\tthat\tis\tthe\tname\twith\twhich\tthis\tservice\twill\tbe registered\ton\tconsul.\n\nThe\tother\ttwo\tproperties\tare\trequired\tto\ttell\tSpring\twhich\tConsul\tserver\tto connect\tto.\tThe\tspring.cloud.consul.host\tproperty\tindicates\tthe\thost\ton which\tconsul\tis\trunning,\tand\tspring.cloud.consul.port\tindicates\tthe\tport on\twhich\tthe\tconsul\tis\tlistening.\n\n3.\t The\tnext\tstep\tis\tadding\tthe\t@EnableDiscoveryClient\tannotation\tto\tthe GeolocationApplication.java\tclass.\tGo\tahead\tand\tadd\tthis\tannotation: @SpringBootApplication\t@EnableDiscoveryClient\tpublic\tclass GeoLocationApplication\t{\n\nThat\tis\tall\tyou\tneed\tto\tregister\tthis\tservice\ton\tconsul.\tSee\thow\teasy\tit\twas compared\tto\tdoing\tthe\tsame\tthing\twith\tZookeeper?\tThanks\tto\tSpring\tfor eliminating\tmost\tof\tour\tboilerplate\tcode.\n\n4.\t Before\twe\ttry\tto\tspin\toff\tan\tinstance\tof\tgeolocation,\tlet's\tbuild\ta\tDocker image\tfor\tthe\tnew\tcode\tchanges\tand\tpush\tit\tto\tDocker\tHub.\tGo\tahead\tand build\tyour\tproject\tusing\tthe\tmvn\tclean\tpackage\tcommand.\tThis\tshould",
      "content_length": 2009,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 345,
      "content": "create\ta\tnew\tgeolocation-0.0.1-SNAPSHOT.jar\tartifact\tin\tthe\ttarget directory.\n\n5.\t Before\twe\tbuild\tthe\tnew\timage,\tlet's\tremove\tthe\texisting\timage\tthat\twe already\thave.\tTo\tdo\tthat,\trun\tthe\tfollowing\tcommand:\tdocker\trmi vikrammurugesan/geolocation\n\n6.\t To\tbuild\tour\timage,\tissue\tthe\tfollowing\tcommand\ton\tyour\tterminal:\tdocker build\t-t\tvikrammurugesan/geolocation\t.\n\n7.\t Use\tyour\taccount\tname\tinstead\tof\tmine\tin\tthe\tcommand.\tAfter\tyour\timage has\tbeen\tbuilt,\tpush\tyour\tDocker\timage\tto\tDocker\tHub\tusing\tthe\tfollowing command.\tYou\tmight\tbe\tasked\tto\tlog\tin\tto\tyour\tDocker\tHub\taccount\tif\tyou haven't\talready\tdone\tso:\tdocker\tpush\tvikrammurugesan/geolocation 8.\t Again,\tmake\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tAfter\tthe image\thas\tbeen\tuploaded\tsuccessfully,\tgo\tto\tDocker\tHub\tand\tverify\tthat\tthe Last\tUpdated\ttime\tof\tyour\timage\tshows\tsomething\tmore\trecent. 9.\t Now\tthat\tour\timage\tis\tready\tto\tuse,\tlet's\ttry\tto\tstart\tour\tgeolocation\n\nservices.\tUsually,\twe\tstart\tthem\tusing\ta\tdocker\trun\tcommand,\tbut\tthis time,\tlet's\ttry\tstarting\tthem\tusing\tdocker-compose.\tGo\tahead\tand\tappend the\tfollowing\tsnippet\tto\tthe\tdocker-compose-consul.yml\tfile: geolocation-1:\timage:\tvikrammurugesan/geolocation:latest\tports:\t- \"8080\"\tenvironment:\tGEOLOCATION_SERVICE_PORT:\t\"8080\" geolocation-2:\timage:\tvikrammurugesan/geolocation:latest\tports:\t- \"8081\"\tenvironment:\tGEOLOCATION_SERVICE_PORT:\t\"8081\"\n\nAs\tyou\tcan\tsee,\twe\thave\tadded\ttwo\tinstances\tof\tgeolocation;\tone\trunning on\tport\t8080\tand\tthe\tother\ton\tport\t8081.\n\n10.\t Now\tstop\tany\trunning\tcontainers\ton\tyour\tcomputer.\tMake\tsure\tthere\tare\tno instances\tof\tconsul\tor\tgeolocation\trunning.\tStart\tthe\tconsul\tagent\tand geolocation\tservices\tusing\tthe\tfollowing\tdocker-compose\tcommand: docker-compose\t-f\tdocker-compose-consul.yml\tup\n\n11.\t Usually,\tit\ttakes\ta\tfew\tminutes\tto\tregister\tthe\ttwo\tservices\ton\tconsul.\tIn\tthe meantime,\tyou\tcan\topen\tup\tthe\tconsul\tUI\tconsole\tat http://192.168.99.100:8500.\n\n12.\t Keep\trefreshing\tthe\tServices\tpage\tand\twait\tfor\tboth\tthe\tgeolocation services\tto\tbe\tup\tand\trunning.\tIt\ttakes\tat\tleast\t2-5\tminutes,\tbased\ton\tthe configuration\tof\tyour\tmachine.\tYou\twill\tknow\tthat\tboth\tthe\tservices\tare running\twhen\tyou\tsee\tthat\tall\tfour\tchecks\tpassed\tfor\tthe\tgeolocation service.",
      "content_length": 2214,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 346,
      "content": "13.\t Both\tthe\tinstances\twill\thave\tthe\tsame\tname\tgeolocation\tand\teach\tof\tthem will\thave\ttwo\tchecks:\tSerf\tcheck\tand\thealth\tcheck.\tWe\twill\ttalk\tmore\tabout health\tchecks\tin\tChapter\t6,\tMonitoring\tMicroservices.\tFor\tnow,\tjust\tkeep in\tmind\tthat\tit\tis\tan\tendpoint\texposed\tby\tSpring\tto\tprovide\thigh-level health\tinformation\tabout\tthe\tapplication.\tYou\twill\tknow\tthat\tboth\tthe services\thave\tbeen\tregistered\tonce\tyou\tsee\tsomething\tlike\tthis:\n\nNow\tmove\ton\tto\tthe\tNodes\ttab\tand\tclick\ton\tthe\tnode\tID.\tOn\tthe\tright-hand side,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tinstances\tof\tgeolocation\tservices\tregistered, one\trunning\ton\tport\t8080\tand\tthe\tother\ton\tport\t8081:\n\nIf\tyou\tdo\tnot\thave\taccess\tto\tthe\tconsul\tUI,\tyou\tcan\tstill\tget\tthe\tlist\tof\n\nregistered\tservices\tusing\ta\tsimple\tcURL\tcommand.\tConsul\thas\ta\tgood\tREST API\tthat\tcan\tbe\tused\tto\tperform\tpretty\tmuch\tmost\tof\tthe\toperations\tthat\tyou\tcan perform\tfrom\tthe\tUI.\tExecute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal session:\tcurl\thttp://192.168.99.100:8500/v1/agent/services\n\nYou\tshould\thave\ta\tresponse\tsimilar\tto\tthis\t(pretty-printed\tfor\treadability):\t{ \"consul\":\t{\t\"ID\":\t\"consul\",\t\"Service\":\t\"consul\",\t\"Tags\":\t[],\t\"Address\":\t\"\",\t\"Port\": 8300,\t\"EnableTagOverride\":\tfalse,\t\"CreateIndex\":\t0,\t\"ModifyIndex\":\t0\t},",
      "content_length": 1233,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 347,
      "content": "\"geolocation-8080\":\t{\t\"ID\":\t\"geolocation-8080\",\t\"Service\":\t\"geolocation\", \"Tags\":\t[],\t\"Address\":\t\"e5da6bf7309d\",\t\"Port\":\t8080,\t\"EnableTagOverride\": false,\t\"CreateIndex\":\t0,\t\"ModifyIndex\":\t0\t},\t\"geolocation-8081\":\t{\t\"ID\": \"geolocation-8081\",\t\"Service\":\t\"geolocation\",\t\"Tags\":\t[],\t\"Address\": \"23039f240cd5\",\t\"Port\":\t8081,\t\"EnableTagOverride\":\tfalse,\t\"CreateIndex\":\t0, \"ModifyIndex\":\t0\t}\t}\n\nNote\tthe\taddress\tfield\tfor\tboth\tthe\tgeolocation\tservices.\tThose\taddresses\twill\n\nbe\tresolved\tto\tthe\trespective\tcontainer's\thostnames\tby\tConsul.\n\nWith\tthat,\twe\thave\tsuccessfully\tregistered\tour\tservices\ton\tConsul\tusing\tDocker. The\tnext\tstep\twill\tbe\tload-balancing\tour\tAPIs\tusing\tConsul,\twhich\twe\twill\tlearn in\tthe\tnext\trecipe.",
      "content_length": 711,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 348,
      "content": "Load\tbalancing\tyour\tmicroservice using\tSpring\tCloud\tConsul\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tset\tup\tConsul\tand\tthen\tlearned\thow to\timplement\tservice\tdiscovery\tin\tConsul\tusing\tSpring\tCloud\tConsul.\tNow, your\tother\tservices\tcan\tdiscover\tthe\tgeolocation\tservice\twith\tthe\thelp\tof\tConsul. Earlier,\twe\ttalked\tabout\thow\tsignificant\tload\tbalancing\tis\tand\thow\twe\tcan\tdo\tit using\tZookeeper.\tIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tperform\tload\tbalancing using\tConsul\twith\tthe\thelp\tof\tSpring\tCloud\tConsul.",
      "content_length": 502,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 349,
      "content": "Getting\tready\n\nThere\tmay\tbe\tscenarios\twhere\tone\tmicroservice\twould\twant\tto\tinvoke\tanother microservice's\tREST\tAPI.\tWhat\tif\tthe\ttarget\tmicroservice\tis\tloadbalanced\tusing Consul?\tThat\tis\texactly\twhat\twe\tare\tgoing\tto\tdemonstrate\tin\tthis\trecipe.\tWe\twill be\twriting\ta\tnew\tmicroservice\tcalled\tgeolocation-consul-lb\tthat\twill\tload balance\tagainst\ttwo\tinstances\tof\tgeolocation\tmicroservice\tin\ta\tround-robin fashion.\tWhen\tyou\tmove\taway\tfrom\ta\tmonolithic\tapplication\tto\tmore\tfocused microservices,\tyou\twill\tend\tup\tin\ta\tsituation\twhere\tyou\twould\twant\tyour microservices\tto\tcommunicate\tin\tan\tefficient\tway.\tThis\trecipe\talong\twith\tthe previous\tone\twill\thelp\tyou\tdo\tthat\tusing\tConsul.",
      "content_length": 670,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 350,
      "content": "How\tto\tdo\tit... 1.\t Create\ta\tnew\tMaven\tJAR\tproject\twith\tthe\tgroupId\tset\tto\n\ncom.packt.microservices\tand\tartifactId\tset\tto\tgeolocation-consul- lb.\tAs\tthis\twill\tbe\ta\tSpring\tBoot\tproject,\twe\tneed\tto\tadd\tspring-boot- start-parent\tas\tthe\tparent\tproject.\n\n2.\t We'll\talso\tneed\tthe\tspring-boot-maven-plugin.\tGo\tahead\tand\tadd\tthe following\tsnippet\tto\tyour\tnewly\tcreated\tproject's\tpom.xml\tfile:\t<parent> <groupId>org.springframework.boot</groupId>\t<artifactId>spring-boot- starter-parent</artifactId>\t<version>1.3.6.RELEASE</version>\t</parent> <properties>\t<start-class>com.packt.microservices.geolocation.lb. GeolocationConsulLoadBalancer</start-class>\t</properties>\t<build> <plugins>\t<plugin>\t<groupId>org.apache.maven.plugins</groupId> <artifactId>maven-compiler-plugin</artifactId>\t<configuration> <source>1.8</source>\t<target>1.8</target>\t</configuration>\t</plugin> <plugin>\t<groupId>org.springframework.boot</groupId> <artifactId>spring-boot-maven-plugin</artifactId>\t<executions> <execution>\t<goals>\t<goal>repackage</goal>\t</goals>\t</execution> </executions>\t<configuration>\t<mainClass>${start-class}</mainClass> </configuration>\t</plugin>\t</plugins>\t</build>\n\n3.\t We\twill\trequire\ttwo\tdependencies\tfor\tthe\tproject.\tOne\tis\tthe\tspring-boot- starter-web\tdependency\tas\tour\tproject\twill\tuse\tSpring\tMVC,\tand\tthe other\tis\tspring-cloud-starter-consul-all\tas\twe\twill\tbe\tlooking\tup services\tfrom\tConsul:\t<dependencies>\t<dependency> <groupId>org.springframework.boot</groupId>\t<artifactId>spring-boot- starter-web</artifactId>\t</dependency>\t<dependency> <groupId>org.springframework.cloud</groupId>\t<artifactId>spring-cloud- starter-Consul-all</artifactId>\t<version>1.1.2.RELEASE</version> </dependency>\t</dependencies>\n\n4.\t Now\tthat\tthe\tpom.xml\tfile\tis\tready,\tlet's\twrite\tour\tapplication\tclass.\tCreate\ta new\tclass\tcalled com.packt.microservices.geolocation.lb.GeolocationConsulLoadBalancer.java\n\n5.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tclass:\tpackage com.packt.microservices.geolocation.lb;\timport org.springframework.boot.SpringApplication;\timport org.springframework.boot.autoconfigure.\tSpringBootApplication;\timport org.springframework.cloud.client.discovery.\tEnableDiscoveryClient;",
      "content_length": 2183,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 351,
      "content": "import\torg.springframework.cloud.client.\tloadbalancer.LoadBalanced; import\torg.springframework.context.annotation.Bean;\timport org.springframework.web.client.RestTemplate;\t@SpringBootApplication @EnableDiscoveryClient\tpublic\tclass\tGeolocationConsulLoadBalancer\t{ @LoadBalanced\t@Bean\tpublic\tRestTemplate\trestTemplate()\t{\treturn\tnew RestTemplate();\t}\tpublic\tstatic\tvoid\tmain(String[]\targs)\t{ SpringApplication.run\t(GeolocationConsulLoadBalancer.class,\targs);\t}\t}\n\nThere\tare\ta\tcouple\tof\tannotations\tto\tnote\there.\tThe @EnableDiscoveryClient\tannotation\tis\trequired\tto\ttell\tSpring\tthat\twe\twill be\tconnecting\tto\tConsul\tto\tlook\tup\tservices.\tThe\tsecond\tinteresting annotation\tis\tthe\t@LoadBalanced\tannotation.\tThis\tannotation\tsays\tthat\tthe RestTemplate\tbean\tthat\tis\tdefined\there\tshould\tloadbalance\tagainst\tthe given\tservice\tURL.\tYou\twill\tunderstand\tthis\tvery\tclearly\tonce\twe\twrite\tthe controller\tclass,\tso\thold\ton.\n\n6.\t Let's\twrite\tour\tcontroller,\n\ncom.packt.microservices.geolocation.lb.GeolocationProxyController.java Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tclass:\tpackage com.packt.microservices.geolocation.lb;\timport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.http.HttpEntity;\timport org.springframework.http.HttpHeaders;\timport org.springframework.http.HttpMethod;\timport org.springframework.http.MediaType;\timport org.springframework.web.bind.annotation.RequestBody;\timport org.springframework.web.bind.annotation.RequestMapping;\timport org.springframework.web.bind.annotation.RequestMethod;\timport org.springframework.web.bind.annotation.ResponseBody;\timport org.springframework.web.bind.annotation.RestController;\timport org.springframework.web.client.RestTemplate;\t@RestController @RequestMapping(\"geolocation\")\tpublic\tclass GeolocationProxyController\t{\t@Autowired\tprivate\tRestTemplate restTemplate;\t@RequestMapping(path\t=\t\"\",\tmethod\t= RequestMethod.GET,\tproduces\t=\t\"applicationjson\")\tpublic @ResponseBody\tString\tfindAll()\tthrows\tException\t{\treturn restTemplate.getForObject\t(\"http://geolocation/geolocation\",\tString.class); }\t@RequestMapping(path\t=\t\"\",\tmethod\t=\tRequestMethod.POST,\tproduces",
      "content_length": 2138,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 352,
      "content": "=\t\"application/json\",\tconsumes\t=\t\"application/json\")\tpublic @ResponseBody\tString\tcreate(@RequestBody\tString\tbody)\tthrows Exception\t{\tHttpHeaders\theaders\t=\tnew\tHttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity<String>\tentity\t=\tnew\tHttpEntity<String>(body,\theaders);\treturn restTemplate.exchange\t(\"http://geolocation/geolocation\", HttpMethod.POST,\tentity,\tString.class).getBody();\t}\t}\n\nWe\thave\tcreated\ttwo\trequest\tmappings\tthat\tmatch\tthe\tAPIs\tin\tgeolocation microservice.\tWe\tare\tactually\timplementing\ta\tproxy\tapplication.\tIn\teach\tof the\tmethods,\twe\tare\tusing\ta\tRestTemplate\tto\tmake\tcalls\tto\tthe geolocation\tservice.\tSee\thow\twe\thave\tautowired\tRestTemplate\tinstead\tof instantiating\tit.\tThat\tis\tbecause\twe\twould\tlike\tto\tuse\tthe\tbean\tthat\twas defined\tin\tthe\tGeolocationConsulLoadBalancer.java\tclass.\tThis restTemplate\tbean\twill\tloadbalance\tthe\tservice\tcalls\tagainst\tthe\tdifferent instances\tof\tthe\ttarget\tservice.\tNote\tthat\tthe\trestTemplate\tbean\tmakes\ta call\tto\tthe\tURL\thttp://geolocation/geolocation.\tSee\thow\tthe\thostname is\tset\tto\tgeolocation.\tAs\tthis\trestTemplate\tbean\tis\tConsul\taware,\tit\twill look\tup\tservices\tregistered\twith\tthe\tname\tgeolocation\tand\tloadbalance against\tthose\tservices\tin\ta\tround-robin\tfashion.\tIt\tis\tas\tsimple\tas\tthat. 7.\t The\tfinal\tstep\twe\tneed\tto\tperform\tis\tadd\tapplication.properties\tand bootstrap.properties\tto\tsrc/main/resources.\tLet's\tuse\tport\tnumber 8899\tas\tthe\tweb\tserver\tport\tnumber.\tAdd\tthe\tfollowing\tcontents\tto\tthe application.properties\tfile:\tserver.port=8899\n\n8.\t In\tthe\tbootstrap.properties\tfile,\twe\twill\tadd\tthe\thostname\tand\tport number\tof\tConsul.\tIn\taddition\tto\tthat,\twe\twill\tadd\tthe spring.application.name\tproperty\tas\tthat\twill\tbe\tused\tas\tthe\tservice name\tin\tConsul.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tbootstrap.properties file:\tspring.application.name=geolocation-consul-lb spring.cloud.consul.host=192.168.99.100\tspring.cloud.consul.port=8500\n\n9.\t Now\tthat\tour\tload\tbalancer\tis\tready,\tlet's\tDockerize\tit.\tCreate\ta\tnew Dockerfile\tin\tthe\tgeolocation-consul-lb\tproject\tand\tadd\tthe\tfollowing snippet:\tFROM\topenjdk:8\tADD\ttarget/geolocation-consul-lb-0.0.1- SNAPSHOT.jar\toptpackt/geolocation/\tEXPOSE\t8080\tCMD\t[\"java\",\t\"- jar\",\t\"optpackt/geolocation/geolocation-consul-lb-0.0.1- SNAPSHOT.jar\"]\n\n10.\t Build\tthe\tproject\tusing\tthe\tMaven\tcommand:\tmvn\tclean\tpackage",
      "content_length": 2315,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 353,
      "content": "11.\t Now,\tlet's\tbuild\tthis\tDocker\timage:\tdocker\tbuild\t-t vikrammurugesan/geolocation-consul-lb\t.\n\n12.\t Make\tsure\tyou\tuse\tyour\taccount\tname\tinstead\tof\tmine.\tEarlier,\twe\twere using\tthe\tdocker-compose-consul.yml\tfile\tin\tthe\tgeolocation\tproject\tto start\tConsul\tand\tthe\tgeolocation\tservices.\n\n13.\t We\twill\tuse\tthe\tsame\tdocker-compose\tfile\tfor\trunning\tthe\tload\tbalancer\tas well.\tAppend\tthe\tfollowing\tsnippet\tto\tdocker-compose-consul.yml: geolocation-consul-lb:\timage:\tvikrammurugesan/geolocation-consul- lb:latest\tports:\t-\t\"8899:8899\"\n\n14.\t Without\tfurther\tado,\topen\ta\tnew\tterminal\tshell\tand\tstart\tthe\tcontainers using\tthe\tfollowing\tcommand:\tdocker-compose\t-f\tdocker-compose- consul.yml\tup\n\n15.\t It\tusually\ttakes\ta\tfew\tminutes\tto\tregister\tall\tthe\tservices\tin\tConsul.\tYou\tcan verify\tthat\tall\tyour\tservices\thave\tbeen\tsuccessfully\tregistered\ton\tConsul\tby viewing\tthe\tservices\tfrom\tthe\tConsul\tUI\tat\thttp://192.168.99.100:8500.\n\nWhen\tall\tthe\tservices\thave\tbeen\tregistered\tsuccessfully,\tyou\twill\tsee something\tlike\tthis\twhen\tyou\tclick\ton\tyour\tnode\tID\tin\tthe\tNodes\ttab:\n\nYou\tmay\tfind\tthat\tthe\thealth\tcheck\tfor\tgeolocation-consul-lb\tis\tfailing. We\tdon't\thave\tto\tworry\tabout\tthat\tmuch\tas\tour\tgoal\tis\tto\tjust\tregister\tthe geolocation\tservices\tin\tConsul.\n\n16.\t Now\tthat\tour\tservices\tare\tregistered\tin\tConsul,\tlet's\tcheck\twhether\tour",
      "content_length": 1315,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 354,
      "content": "RestTemplate\tloadbalances\tall\tHTTP\trequests.\tIssue\tthe\tfollwing\tcurl commands\tin\ta\tnew\tterminal\twindow:\tcurl\t-H\t\"ContentType: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://192.168.99.100:8899/geolocation 17.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} curl\t-H\t\"ContentType:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://192.168.99.100:8899/geolocation\n\n18.\t This\tshould\tgiven\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} 19.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing\n\ncurl\tcommand:\tcurl\thttp://192.168.99.100:8899/geolocation\n\n20.\t It\tshould\tgive\tyou\tan\toutput\tthat\tlooks\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t[\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t}\t]\n\n21.\t But\twait;\twe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's try\tthe\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\tan\toutput like\tthis\t(pretty-printed\tfor\treadability):\t[\t{\t\"latitude\":\t9.568012, \"longitude\":\t77.962444,\t\"userId\":\t\"f1196aac-470e-11e6-beb8- 9e71128cae77\",\t\"timestamp\":\t1468203975\t}\t]\n\nAgain,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime\tit\tis\ta\tdifferent\tone.\tThis\tis because\tour\trequest\tis\tbeing\tsent\tto\tone\tgeolocation\tservice\teach\ttime.\tEach instance\thas\tone\tgeolocation\tstored\tin\tmemory.\tAs\tour\tstorage\tmechanism\tuses a\tvery\tsimple\tin-memory\tapproach,\tthey\tare\tnot\tgrouped\ttogether\tin\ta\tsingle repo.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\tusing\ta\tdatabase,\tand\tall\tinstances\tof this\tmicroservice\twill\tconnect\tto\tthe\tsame\tdatabase.\tAt\tleast\tnow\twe\tknow\twhy our\trequests\twere\tacting\tdifferently.\tAt\tthe\tsame\ttime,\tthis\tproves\tthat\tthe\tload balancing\tworks\tas\texpected.\n\nYay!\tWe\thave\tlearned\thow\tto\tuse\tConsul\tand\tSpring\tCloud\tConsul\tto loadbalance\tHTTP-based\tmicroservices.\tConsul\tis\ta\tvery\tpowerful\ttool,\tand\tit",
      "content_length": 2390,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 355,
      "content": "loadbalance\tHTTP-based\tmicroservices.\tConsul\tis\ta\tvery\tpowerful\ttool,\tand\tit offers\ta\tgreat\tmany\tother\tfeatures.\tWhat\twe\tsaw\tis\tjust\ta\tbasic\tuse\tcase\tof Consul\tin\tmicroservices.\n\nNote\n\nDo\tspend\tsome\ttime\tgoing\tthrough\tthe\tConsul\tdocumentation\tat https://www.consul.io/docs/index.html\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tour\tnext\trecipe,\twe\twill\tlook\tat\thow Nginx\tand\tConsul\thelp\twith\tloadbalancing\tmicroservices.",
      "content_length": 424,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 356,
      "content": "Load\tbalancing\tyour\tmicroservice using\tNginx\tand\tConsul\n\nSo\tfar\twe\thave\tlearned\thow\tto\tload\tbalance\tour\tmicroservice\tusing\tZookeeper and\tConsul.\tBoth\tof\tthese\tapproaches\tcome\twith\ttheir\town\tmerits\tand\tdemerits. The\tZookeeper\tapproach\trequired\tus\tto\twrite\ta\tlot\tof\tcode,\tand\tthere\tis\tstill\ta possibility\tof\trace\tcondition\twhere\tour\tproxy\tcontroller\tcould\tinvoke\ta\tservice that\tjust\twent\tdown.\tThe\tSpring\tCloud\tConsul\tapproach\trequired\tus\tto\twrite\tthe proxy\tcontroller.\tIn\tfact,\tin\tboth\tthese\tapproaches\twe\thad\tto\twrite\tour\town\tload balancer\tmicroservice.\tThis\tmight\tnot\tbe\ta\tscalable\tapproach\twhen\tyou\thave hundreds\tof\tmicroservices\tand\ttons\tof\tAPIs.\tThat\tis\twhere\tHTTP\tservers\tsuch\tas Apache\tHTTP\tServer\tand\tNginx\tcome\tto\tthe\trescue.\tNginx\tis\tone\tof\tthe\tmost popular\tHTTP\tservers.\tWe\tcould\tpotentially\tuse\tNginx\tas\tour\tproxy\tserver\tto geolocation\tmicroservices\tin\ta\tround\trobin\tfashion.\tIn\tthis\trecipe\twe\twill\tlearn how\tto\tuse\tNginx\tand\tConsul\ttogether\tto\tload\tbalance\tour\tgeolocation microservice.",
      "content_length": 998,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 357,
      "content": "Getting\tready\n\nIn\tthis\trecipe\twe\twill\tbe\tusing\ttwo\tnew\tcomponents:\tNginx\tServer\tand\tConsul Template.\tWe\tall\tknow\twhat\tNginx\tis\tand\thow\tit\tcan\tbe\tused\tfor\thosting\tour web\tcontent.\tHowever,\tin\tour\tcase\twe\tare\tvery\tinterested\tin\tNginx's\tproxy_pass module.\tThe\tproxy_pass\tmodule\tcan\tbe\tused\tto\tmake\tNginx,\tforward\trequests received\tfrom\ta\tclient\tto\tanother\tserver\tand\tsend\tback\tresponses\tfrom\tthe\tother server\tback\tto\tthe\tclient.\tIn\tour\tcase,\twe\twill\tbe\tutilizing\tproxy_pass\tto\tproxy requests\tto\tmultiple\tgeolocation\tinstances.\tUsually\tproxy_pass\tconfigurations go\tinto\tthe\tdefault.conf\tfile\tof\tNginx.\tSounds\teasy?\tBut\twait,\thow\tdoes\tNginx know\twhere\tour\tservices\tare\tlocated,\tbecause\twe\twill\tnever\tknow\thow\tmany instances\tof\tgeolocation\tare\tactive\tand\twhere\tthey\tare\tdeployed.\tSo\tthe\teasiest way\tis\tto\tkeep\tupdating\tthe\tdefault.conf\tfile\teach\ttime\ta\tgeolocation\tservice registers\tor\tunregisters\tin\tConsul.\tAt\tthe\tsame\ttime,\teach\ttime\tthe\tdefault.conf file\tis\tupdated,\tNginx\tneeds\tto\tbe\treloaded.\tSomehow\twe\thave\tto\tkeep\tboth Consul\tand\tNginx\tin\tsync.\tThat's\texactly\twhat\tConsul\tTemplate\tdoes.\tConsul Template\tconstantly\tpolls\tConsul\tfor\tany\tchanges\tto\tour\tgeolocation\tservice\tand recreates\tthe\tdefault.conf\tfile.\tIn\tfact,\tthe\twhole\tdefault.conf\tfile\twill\tbe represented\tas\ta\tConsul\tTemplate\tfile.\tConsul\ttemplate\tuses\tthe\tGo\ttemplate format\tfor\tcreating\ttemplate\tfiles.\n\nTo\tlearn\tmore\tabout\tGo\ttemplate\tformat,\tplease\ttake\ta\tlook\tat https://golang.org/pkg/text/template\t.\tThe\toverall\tarchitecture\twill\tlook something\tlike\tthis:",
      "content_length": 1524,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 358,
      "content": "As\tyou\tcan\tsee\tthe\tclient\tdoesn't\thave\tto\tworry\tabout\tthe\tlocation\tof\tthe geolocation\tmicroservice.\tAll\tit\tneeds\tto\tknow\tis\tthe\tlocation\tof\tour\tNginx server.",
      "content_length": 157,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 359,
      "content": "How\tto\tdo\tit...\n\nThe\tfirst\tthing\tthat\twe\twill\tneed\tis\ta\tDocker\tcontainer\tfor\tNginx\tand\tConsul Template.\tWe\twill\tbe\tusing\tthe\tofficial\tNginx\tDocker\timage\tand\twill\tinstall Consul\tTemplate\tinside\tit.\tCreate\ta\tnew\tdirectory\talong\tside\tthe\tgeolocation project\tcalled\tgeolocation-consul-nginx-lb.\tCreate\ta\tnew\tDockerfile\tunder geolocation-consul-nginx-lb\tand\tadd\tthe\tfolowing\tcontents\tto\tit:\n\nFROM\tnginx:latest ENV\tCONSUL_URL\tconsul:8500 RUN\tapt-get\tupdate\t&&\tapt-get\tinstall\t-y\tunzip\twget RUN\tmkdir\t-p\toptpackt/consul-template WORKDIR\toptpackt/consul-template RUN\twget\thttps://releases.hashicorp.com/consul- template/0.16.0/consul-template_0.16.0_linux_amd64.zip\t&&\tunzip\t consul-template_0.16.0_linux_amd64.zip ADD\tdefault.ctmpl\toptpackt/consul-template/ ADD\tstartup.sh\toptpackt/consul-template/ RUN\tchmod\t+777\toptpackt/consul-template/startup.sh RUN\trm\tetcnginx/conf.d/default.conf EXPOSE\t80 ENTRYPOINT\t[\"optpackt/consul-template/startup.sh\"]\n\nThere\tare\ta\tlot\tof\tthings\tgoing\ton\tin\tthis\tfile.\tLets\tbreak\tit\tdown\tinto\tparts\tand try\tto\tunderstand\tit\tone\tby\tone.\tFirstly,\twe\tare\tbasing\tthis\timage\toff\tof nginx:latest\timage.\n\nENV\tCONSUL_URL\tconsul:8500\n\nThe\tpreceding\tinstruction\tcreates\ta\tnew\tenvironment\tvariable\tcalled\tCONSUL_URL with\tvalue\tconsul:8500.\tThe\thostname\tconsul\twill\tbe\tresolved\tto\tthe\thostname of\tthe\tconsul\tservice,\tif\twe\tuse\tit\tin\tDocker\tcompose.\n\nRUN\tapt-get\tupdate\t&&\tapt-get\tinstall\t-y\tunzip\twget\n\nThe\tpreceding\tinstruction\tinstalls\tunzip\tand\twget.\tWe\tneed\tthem\tto\tinstall\tand unpack\tConsul\tTemplate.\n\nRUN\tmkdir\t-p\toptpackt/consul-template WORKDIR\toptpackt/consul-template\n\nThese\ttwo\tinstructions\tcreate\tthe\toptpackt/consul-template\tdirectory\tand\tset",
      "content_length": 1664,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 360,
      "content": "the\tworking\tdirectory\tto\toptpackt/consul-template.\tWe\twill\tbe\tusing\tthis directory\tas\tthe\tinstallation\tdirectory\tof\tconsul\ttemplate.\n\nRUN\twget\thttps://releases.hashicorp.com/consul- template/0.16.0/consul-template_0.16.0_linux_amd64.zip\t&&\tunzip\t consul-template_0.16.0_linux_amd64.zip\n\nThis\tinstruction\tdownloads\tConsul\tTemplate\tand\tunpacks\tthe\tdownloaded\tZIP file.\tThe\tcontent\tof\tthe\tZIP\tfile\tis\tjust\tthe\tconsul-template\tbinary.\tAs\tyou\tcan see\twe\thave\tused\tthe\tversion\t0.16.0,\tbut\tfeel\tfree\tto\tuse\tthe\tmost\trecent\tversion found\tin\thttps://releases.hashicorp.com/consul-template\t.\n\nADD\tdefault.ctmpl\toptpackt/consul-template/ ADD\tstartup.sh\toptpackt/consul-template/ RUN\tchmod\t+x\toptpackt/consul-template/startup.sh\n\nThe\tpreceding\tsnippet\tdoes\tthree\tthings:\tadds\tthe\ttemplate\tfile\tdefault.ctmpl to\tthe\tinstallation\tdirectory\tat\toptpackt/consul-template,\tadds\tthe\tstartup script\tto\tthe\tinstallation\tdirectory\tand\tprovides\texecute\tprivileges\tto\tthe\tstartup script.\tWe\twill\tlook\tat\thow\tto\tcreate\tthe\tdefault.ctmpl\tfile\tand\tstartup.sh\tfile later.\n\nRUN\trm\tetcnginx/conf.d/default.conf\n\nThis\tinstruction\tis\trequired\tto\tremove\tthe\tdefault\tconfig\tfile\tthat\tcomes\twith Nginx's\tinstallation.\n\nEXPOSE\t80\n\nWe\tare\texposing\tport\t80\tof\tNginx\tso\tthat\twe\tcan\taccess\tit\tfrom\toutside\t(after mapping\tit).\n\nENTRYPOINT\t[\"optpackt/consul-template/startup.sh\"]\n\nFinally\tthe\tentry\tpoint\twill\tbe\tthe\tstartup.sh\tscript\tthat\twe\twill\tbe\tcreating next.\tThe\tstartup\tscript\twill\tdo\ttwo\tthings:\tstart\tNginx\tand\tstart\tConsul Template.\tCreate\ta\tnew\tshell\tscript\twith\tname\tstartup.sh\tand\tadd\tthe following\tcontents.\n\n#!/bin/bash service\tnginx\tstart\t&&\toptpackt/consul-template/consul-template\t- consul=$CONSUL_URL\t- template=\"default.ctmpl:etcnginx/conf.d/default.conf:service\tnginx",
      "content_length": 1747,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 361,
      "content": "reload\"\n\nThe\tpreceding\tsnippet\tstarts\tthe\tservice\tcalled\tnginx\tand\tstarts\tConsul\tTemplate with\ttwo\targuments.\tThe\tconsul\targument\tindicates\tthe\tlocation\tof\tConsul.\tWe have\tused\tthe\tCONSUL_URL\tenvironment\tvariable\tthat\twas\tpreviously\tdefined\tin the\tDockerfile.\tThe\ttemplate\targument\tis\tdivided\tinto\tthree\tparts\tseparated\tby\ta colon.\tThe\tfirst\tpart\tindicates\tthe\ttemplate\tfile\titself,\tthe\tsecond\tpart\tindicates the\tfile\tthat\tneeds\tto\tbe\treplaced\tafter\trendering\tthe\ttemplate\tand\tthe\tthird\tpart indicates\tthe\taction\tthat\tneeds\tto\tbe\tperformed\tafter\teach\tupdate.\tIn\tour\tcase\twe are\treloading\tthe\tnginx\tservice\tafter\teach\tupdate.\n\nThe\tnext\tfile\twe\thave\tto\tcreate\tis\tthe\ttemplate\tfile.\tGo\tahead\tand\tcreate\ta\tnew file\tcalled\tdefault.ctmpl.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tfile:\n\nupstream\tgeolocation\t{\t \t\t\t\t\t\tleast_conn;\t \t\t\t\t\t\t{{range\tservice\t\"geolocation\"}}server\t{{.Address}}:{{.Port}} \t\t\t\t\t\tmax_fails=3\tfail_timeout=60\tweight=1;\t \t\t\t\t\t\t{{else}}server\t127.0.0.1:65535;\t#\tforce\ta\t502{{end}}\t \t\t\t\t}\n\nserver\t{\t \t\t\t\t\t\tlisten\t80\tdefault_server;\n\ncharset\tutf-8;\n\nlocation\tgeolocation\t{\t \t\t\t\t\t\t\t\tproxy_pass\thttp:/geolocation;\t \t\t\t\t\t\t\t\tproxy_set_header\tX-Forwarded-For\t $proxy_add_x_forwarded_for;\t \t\t\t\t\t\t\t\tproxy_set_header\tHost\t$host;\t \t\t\t\t\t\t\t\tproxy_set_header\tX-Real-IP\t$remote_addr;\t \t\t\t\t\t\t}\t \t\t\t\t}\n\nIf\tyou\tare\tfamiliar\twith\tNginx,\tyou\twould\talready\tknow\twhat's\tgoing\ton\there. All\twe\thave\tdone\tis\tcreated\tan\tupstream\tcalled\tgeolocation,\twhich\twill\tbe replaced\twith\tthe\tlist\tof\tgeolocation\tservers\tthat\tare\tregistered\tin\tConsul.\tThis rendering\tis\twhat\tConsul\tTemplate\tdoes.\tLater\tin\tthe\tserver\tsection,\twe\thave added\ta\tproxy\tpass\tto\t/geolocation\tURL\tpath,\twhich\twill\tbe\tload\tbalanced against\tthe\tlist\tof\tgeolocation\tservers\tlisted\tin\tupstream\tgeolocation.\tThis template\tfile\twill\tbe\tupdated\tevery\ttime\tthere\tis\ta\tchange\tto\tthe\tgeolocation",
      "content_length": 1843,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 362,
      "content": "service\tin\tConsul.\n\nThat's\tit.\tWe\tare\tall\tset\tto\tgo.\tIn\torder\tto\ttest\tour\tsetup,\tlets\tuse\tDocker\tcompose. Go\tahead\tand\tcreate\ta\tnew\tDocker\tcompose\tfile\tcalled\tdocker-compose-nginx- consul.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tYAML\tfile:\n\nversion:\t\"2\" \t\t\t\tservices: \t\t\t\t\t\tconsul: \t\t\t\t\t\t\t\timage:\tconsul:latest \t\t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8500:8500\"\n\ngeolocation-1: \t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8080\" \t\t\t\t\t\t\t\tenvironment: \t\t\t\t\t\t\t\t\t\tGEOLOCATION_SERVICE_PORT:\t\"8080\"\n\ngeolocation-2: \t\t\t\t\t\t\t\timage:\tvikrammurugesan/geolocation:latest \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8081\" \t\t\t\t\t\t\t\tenvironment: \t\t\t\t\t\t\t\t\t\tGEOLOCATION_SERVICE_PORT:\t\"8081\"\n\nnginx-consul-template: \t\t\t\t\t\t\t\tbuild:\t. \t\t\t\t\t\t\t\tlinks: \t\t\t\t\t\t\t\t\t\t-\tconsul \t\t\t\t\t\t\t\tdepends_on: \t\t\t\t\t\t\t\t\t\t-\tconsul \t\t\t\t\t\t\t\tports: \t\t\t\t\t\t\t\t\t\t-\t\"8900:80\"\n\nAs\tyou\tcan\tsee,\twe\thave\tthree\timages\tthat\twe\talready\tknow:\tconsul\tand\t2 geolocation\timages.\tThe\tonly\tnew\timage\tin\tthe\tpreceding\tDocker\tcompose\tis the\tnginx-consul-template\timage.\tThis\timage\twill\tbe\tbuilt\tusing\tthe Dockerfile\tlocated\tin\tthe\tcurrent\tdirectory.\tThis\timage\tis\tlinked\tto\tthe\tconsul image\tso\tthat\tit\tknows\twhere\tConsul\tis\tlocated.\tThe\tdepends_on\tsection\tsays that,\tthis\timage\thas\tto\twait\tfor\tthe\tconsul\timage\tto\tbe\tstarted.\tFinally\tport\t80\tof Nginx\tneeds\tto\tbe\tmapped\tto\t8900\tin\tthe\tDocker\thost.\tWithout\tany\tfurther\tado, go\tahead\tand\tstart\tthe\tcontainers\tusing\tthe\tfollowing\tcommand:",
      "content_length": 1436,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 363,
      "content": "docker-compose\t-f\tdocker-compose-nginx-consul.yml\tup\n\nIt\tusually\ttakes\t2-5\tminutes\tfor\tthe\tgeolocation\tservices\tto\tregister\tto\tConsul depending\ton\tthe\tconfiguration\tof\tyour\tmachine.\tSo\twait\tfor\tthem\tto\tregister\tin Consul.\tYou\tcan\tverify\tif\tthe\tservices\tare\tregistered\tin\tConsul\tby\tlooking\tat Consul's\tweb\tinterface\tat\thttp://192.168.99.100:8500.\tAfter\tall\tyour\tservices are\tregistered,\twe\tare\tready\tto\ttest\tour\tload\tbalancer.\tOpen\tup\ta\tnew\tterminal session\tand\tissue\tthe\tfollowing\tcURL\tcommands:\n\ncurl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}'\t http://192.168.99.100:8900/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\n\n{ \"latitude\":\t41.803488, \"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"timestamp\":\t1468203975 } curl\t-H\t\"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}'\t http://192.168.99.100:8900/geolocation\n\nThis\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor\treadability):\n\n{ \"latitude\":\t9.568012, \"longitude\":\t77.962444, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"timestamp\":\t1468203975 }\n\nTo\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing\tcurl command:\n\ncurl\thttp://192.168.99.100:8900/geolocation\n\nIt\tshould\tgive\tyou\tan\toutput\tthat\tlooks\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):",
      "content_length": 1592,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 364,
      "content": "[ { \"latitude\":\t41.803488, \t\t\t\t\t\t\"longitude\":\t-88.14404, \t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\"timestamp\":\t1468203975 } ]\n\nBut\twait;\twe\tcreated\ttwo\tgeolocations,\tso\twhy\tis\tit\tshowing\tjust\tone?\tLet's\ttry the\tcommand\tone\tmore\ttime.\tThis\ttime,\tit\tshould\tgive\tyou\tan\toutput\tlike\tthis (pretty-printed\tfor\treadability):\n\n[ { \"latitude\":\t9.568012, \t\t\t\t\t\t\"longitude\":\t77.962444, \t\t\t\t\t\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \t\t\t\t\t\t\"timestamp\":\t1468203975 } ]\n\nAgain,\twe\tget\tonly\tone\tgeolocation,\tbut\tthis\ttime\tit\tis\ta\tdifferent\tone.\tThis\tis because\tour\trequest\tis\tbeing\tsent\tto\tone\tgeolocation\tservice\teach\ttime.\tEach instance\thas\tone\tgeolocation\tstored\tin\tmemory.\tAs\tour\tstorage\tmechanism\tuses a\tvery\tsimple\tin-memory\tapproach,\tthey\tare\tnot\tgrouped\ttogether\tin\ta\tsingle repo.\tIn\ta\treal-time\tscenario,\tyou\twill\tbe\tusing\ta\tdatabase,\tand\tall\tinstances\tof this\tmicroservice\twill\tconnect\tto\tthe\tsame\tdatabase.\tAt\tleast\tnow\twe\tknow\tthat our\tnew\tload\tbalancer\tworks\tas\texpected.\n\nNote\n\nNginx\thas\ta\tpaid\tversion\tof\ttheir\tsoftware\tcalled\tNginx\tPlus\twhich\toffers\tmost of\tthe\tfeatures\tthat\tyou\twill\tneed\tin\tany\tHTTP\tserver\tlike\tMonitoring,\tSecurity, Load\tBalancing,\tCaching,\tand\tso\ton.\tIf\tyou\tare\talready\tan\tNginx\tuser\tand\twould like\tto\tcontinue\tusing\tit\talong\twith\tyour\tmicroservices,\tit\tmight\tbe\tworth\ttaking a\tlook\tat\tNginx\tPlus.\tFor\tmore\tinformation\tabout\tload\tbalancing\tusing\tNginx Plus,\tplease\ttake\ta\tlook\tat\thttps://www.nginx.com/products/application-load- balancing\t.\n\nThat's\tit.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe\twe\tnot\tonly learned\thow\tto\tuse\tConsul\tTemplate\tand\tNginx\tbut\talso\timplemented\ta\tload balancer\twithout\thaving\tto\twrite\ttoo\tmuch\tcode.\tThe\treal\tbeauty\tof\tthis",
      "content_length": 1718,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 365,
      "content": "balancer\twithout\thaving\tto\twrite\ttoo\tmuch\tcode.\tThe\treal\tbeauty\tof\tthis approach\tis\tthat,\tit\tconfigures\tNginx\tto\tload\tbalance\tbetween\tany\tnumber\tof geolocation\tinstances\tthat\tare\tcurrently\tregistered\tin\tConsul.",
      "content_length": 210,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 366,
      "content": "Load\tbalancing\tyour\tmicroservice using\tMarathon\tLB\n\nIn\tthis\trecipe,\twe\twill\tlearn\tthe\tconcepts\tof\tMarathon\tLB\tand\thow\tit\tworks behind\tthe\tscreens.\tAt\tthe\ttime\tof\twriting\tthis,\tMarathon\tLB\tworks\tperfectly with\tDC/OS.\tSo\ttrying\tto\tmake\tMarathon\tLB\twork\tin\ta\tnon-DC/OS environment\tmight\tnot\tbe\tthe\tbest\tsolution\tin\tall\tcases.\tWe\twill\tbe\tlearning about\tDC/OS\tin\tChapter\t8\t,\tMore\tClustering\tFrameworks\t-\tDC/OS,\tDocker Swarm,\tand\tYARN.",
      "content_length": 429,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 367,
      "content": "How\tit\tworks...\n\nMarathon\tLB\tis\ta\tPython-based\ttool\tthat\tinternally\tuses\tHAProxy\tto\tload- balance\tapplications\tdeployed\ton\tMarathon.\tHAProxy\tis\tone\tof\tthe\tproven solutions\tfor\tload-balancing\tHTTP-based\tendpoints.\tIt\thas\tbeen\tthere\tin\tthe market\tfor\ta\twhile,\tand\tthere\tare\tseveral\tsuccess\tstories\tabout\tit.\tWhen\tyou\tstart Marathon\tLB,\tyou\tneed\tto\tsupply\tthe\tbase\tURL\tof\tMarathon\tas\ta\tconfiguration so\tthat\twhen\tMarathon\tLB\tstarts,\tit\tknows\twhere\tMarathon\tis\trunning\ton\tyour cluster.\tMarathon\tLB\tbinds\tto\tthe\tservice\tports\tof\tall\tthe\tapplications\tand\troutes any\trequest\tthat\tit\treceives\tto\tthe\tapplication\tinstances.\tIt\tdoes\tthree\tthings:\n\nParses\tthe\tMarathon\tapps\t(using\tMarathon's\tREST\tAPI)\tand\tgets\ttheir\tIP and\tservice\tport Creates\ta\tnew\tHAProxy\tconfig\tand\tdrops\tit\tin\ta\tdedicated\tHAProxy directory Reloads\tHAProxy\t(does\tnot\trestart)\n\nThe\tworking\tof\tMarathon\tLB\tis\tsimple.\tIt\tuses\tHAProxy\tas\tthe\tback-end\tload balancer\tand\tinteracts\twith\tthe\tapplications\tdeployed\ton\tMarathon\tand HAProxy.\tThe\tnext\tquestion\tthat\tyou\tmay\thave\tis\thow\tMarathon\tLB\tknows when\tapplications\tin\tMarathon\tare\tmodified:\tupdated,\tremoved,\tor\tcreated.\n\nMarathon\tLB\thas\ta\tfew\tstrategies\tby\twhich\tit\twill\tget\tnotified\twhen\tan application\tis\tmodified\ton\tMarathon.\tSo\twhenever\tit\treceives\tsuch\tan\tevent,\tit updates\tHAProxy\taccordingly\tand\treloads\tHAProxy.\tNot\tall\tapplications\twill\tbe load-balanced\tby\tMarathon\tLB.\tMarathon\tLB\tlooks\tfor\tapplications\tthat\thave the\tHAPROXY_GROUP\tvariable\tset\tto\ta\tspecific\tvalue.\n\nNote\n\nIf\tyou\twould\tlike\tto\tlearn\tmore\tabout\tMarathon\tLB,\tvisit\ttheir\tGitHub documentation\tat\thttps://github.com/mesosphere/marathon- lb/blob/master/README.md\t.\n\nLike\tI\tmentioned,\tthe\teasiest\tway\tto\ttry\tMarathon\tLB\tis\ton\ta\tDC/OS\tcluster. And\tif\tyou\tare\tso\tdependent\ton\tMesos\tand\tMarathon,\tit\tis\tdefinitely\tworth taking\ta\tlook\tat\tDC/OS.\n\nWith\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\tchapter.\tYou've\tlearned\ta\tlot\tabout\tservice",
      "content_length": 1900,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 368,
      "content": "With\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\tchapter.\tYou've\tlearned\ta\tlot\tabout\tservice discovery\tand\tload-balancing\tyour\tmicroservices\tin\tthis\tchapter",
      "content_length": 145,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 369,
      "content": "Chapter\t6.\tMonitoring\tMicroservices\n\nIn\tthis\tchapter,\twe\twill\tlearn\thow\tto\tsetup\ta\tmonitoring\tsystem\tfor\tour microservice.\tWe\twill\tcover\tthe\tfollowing\trecipes:\n\nConfiguring\tSpring\tBoot\tActuator\tmetrics Understanding\tSpring\tBoot\tActuator\tmetrics Creating\tcustom\tmetrics\tusing\tDropwizard Setting\tup\tGraphite\tusing\tDocker Using\tthe\tGraphite\tinterface Exporting\tDropwizard\tmetrics\tover\tto\tGraphite Exporting\tSpring\tBoot\tActuator\tmetrics\tover\tto\tGraphite Setting\tup\tGrafana\tusing\tDocker Configuring\tGrafana\tto\tuse\tGraphite Configuring\tGrafana\tdashboards\tto\tview\tmetrics",
      "content_length": 564,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 370,
      "content": "Introduction\n\nAs\tyou\tstart\tscaling\tout\tto\tseveral\tmicroservices,\tit\tbecomes\tdifficult\tto\tmonitor them.\tYou\tmight\twant\tto\tknow\twhen\tsome\tpart\tof\tyour\tplatform\tis\tnot\tworking as\texpected.\tAt\tthe\tsame\ttime,\tyou\twant\tto\tbe\tnotified\twhen\tsome\tpart\tof\tyour application\tis\tnot\tperforming\twell.\tSo\tmonitoring\tbecomes\ta\tsignificant\taspect of\tmicroservices.\tAt\tthe\tsame\ttime,\tmonitoring\twill\tnot\tmake\tsense\tif\tyou\tdon't monitor\tthe\tright\tmetrics.\tSo\texposing\tthe\tright\tmetrics\tfor\teach\tmicroservices matter\ta\tlot.\tWhile\tyou\tspend\t60\tpercent\tof\tyour\ttime\twriting\tthe\tactual functionality\tof\tthe\tmicroservice,\tthe\tother\t40\tpercent\tshould\tbe\tspent\ton activities\tsuch\tas\tdeployments,\tCI,\tmonitoring,\tand\tlogging.\tIf\tthis\tsounds strange\tto\tyou,\tyou\twill\tstart\tunderstanding\tit\tas\tsoon\tas\tyou\tstart\twriting\tmore and\tmore\tmicroservices.\n\nThe\tbiggest\tquestion\tis\twhere\tdo\twe\tstore\tthese\tmetrics.\tThat's\twhere\tTime Series\tDatabases\tcome\tinto\tpicture.\tThere\tare\tseveral\ttime\tseries\tdatabases\tin the\tmarket\tat\tthe\tmoment\tlike\tGraphite,\tPrometheus,\tRiak,\tand\tso\ton.\tIn\tthis chapter\twe\twill\tbe\tlooking\tat\thow\tto\tuse\tGraphite\tto\tstore\tour\tmetrics.\tThe\tnext step\tis\tvisualizing\tthese\tmetrics\tin\tform\tof\tuser-friendly\tcharts\tand\tgraphs.\tFor that\tpurpose,\twe\twill\tbe\tusing\tone\tof\tthe\tmost\tpopular\tmonitoring\ttools\tcalled Grafana.",
      "content_length": 1302,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 371,
      "content": "Configuring\tSpring\tBoot\tActuator metrics\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconfigure\tthe\tgeolocation\tproject\tto\texpose some\tpredefined\tmetrics\texposed\tby\tthe\tSpring\tframework\titself.\tThough\tyou might\tnot\tuse\tall\tof\tthem,\tit\tis\talways\tbetter\tto\tknow\tthat\tthey\texist\tso\tthat\tyou can\tfind\tsome\tuse\tfor\tthem\tin\tthe\tfuture.\tIn\tfact,\tmost\tof\tthe\tmetrics\texposed\tby Spring\tare\tmodifiable.\tOn\ttop\tof\tit,\tSpring\tadds\tsecurity\tto\tthem\tso\tthat\tnot everyone\tcan\tview\tyour\tmetrics.\tThese\tare\tsome\tof\tthe\tadvantages\tthat\tyou\tget when\tyou\tuse\tSpring's\tmetrics\tframework.",
      "content_length": 559,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 372,
      "content": "Getting\tready\n\nWe\twill\tgo\tthrough\tthis\trecipe\twith\tthe\thelp\tof\tthe\tgeolocation\tproject.\tWe\twill be\tusing\tthe\tSpring\tBoot\tActuator\tlibrary\tto\texpose\tthe\tmetrics.\tSo\topen\tyour STS\tIDE.\tBefore\twe\tjump\tinto\tthe\tactual\timplementation,\twe\thave\tto\tcomment out\ta\tfew\tlines\tof\tcode.\tIf\tyou\thave\tbeen\tworking\ton\tthe\tSetting\tup\tConsul\tusing Docker\trecipe\tfrom\tChapter\t5\t,\tService\tDiscovery\tand\tLoad\tBalancing Microservices,\tyou\tmight\tstill\thave\tthe\tZookeeper\tor\tConsul-related\tcode\tin your\tcode\tbase.\tAs\twe\tare\tnot\tgoing\tto\tuse\teither\tof\tthem,\tlet's\tmake\tsure\tthey are\tcommented\tout.\tTo\tcomment\tout\tZookeeper,\tall\tyou\thave\tto\tdo\tis\tcomment out\tthe\tline\tin\tGeoLocationApplication.java\tclass\tfile\twhere\twe\tregister\tour service.\tTo\tcomment\tout\tConsul,\tyou\thave\tto\tfirst\tcomment\tout\tthe @EnableDiscoveryClient\tannotation\tfrom\tthe\tGeoLocationApplication.java class\tand\tremove\tthe\tunused\timport.\tThe\tclass\twill\tnow\tlook\tlike\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\torg.springframework.boot.SpringApplication; \t\t\t\timport\torg.springframework.boot.autoconfigure. \t\t\t\t\t\tSpringBootApplication;\n\n@SpringBootApplication \t\t\t\t//\t@EnableDiscoveryClient \t\t\t\tpublic\tclass\tGeoLocationApplication\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\t\t\t\t\tSpringApplication.run(GeoLocationApplication.class,\targs);\n\n//\tcommented\tout\tso\tthat\tthe\tservice\tdoes\tnot\ttry\tto connect \t\t\t\t\t\t\t\tto\tzk \t\t\t\t\t\t\t\t//\tnew\tZookeeper(\"192.168.99.100\",\t2181).register(); \t\t\t\t\t\t} \t\t\t\t}\n\nThe\tnext\tstep\tis\tcommenting\tout\tthe\tspring-cloud-starter-consul-all dependency\tfrom\tthe\tpom.xml\tfile:\n\n<!--\t<dependency> <groupId>org.springframework.cloud</groupId> \t\t\t\t\t\t\t<artifactId>spring-cloud-starter-consul-all</artifactId> \t\t\t\t\t\t\t<version>1.1.2.RELEASE</version> \t\t\t\t\t</dependency>\t-->",
      "content_length": 1741,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 373,
      "content": "</dependency>\t-->\n\nNow\tthat\twe\tknow\tall\tthe\tcode\trelated\tto\tZookeeper\tand\tConsul\tinitialization are\tcommented\tout,\tlet's\twork\ton\tconfiguring\tSpring\tBoot\tActuator.",
      "content_length": 162,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 374,
      "content": "How\tto\tdo\tit...\n\nBefore\twe\tstart,\tlet's\ttake\ta\tminute\tto\ttalk\tabout\tSpring\tBoot\tActuator\tand\thow\tit works.\tSpring\tBoot\tActuator\tis\tjust\ta\tMaven\tdependency\tthat\tyou\tneed\tto\tadd\tto your\tproject.\tOnce\tyou\tadd\tthis\tdependency,\tSpring\tautomatically\tinjects\tthe beans\tthat\tare\tresponsible\tfor\texposing\tthese\tmetrics.\tThere\tare\ttwo\tways\tto consume\tthese\tmetrics:\tHTTP\tor\tJMX.\tThough\tJMX\tis\tconsidered\tto\tbe\tthe standard\tway,\tHTTP\tis\tconsidered\tan\teasy\tsolution,\tas\tREST\tis\talmost everywhere\tthese\tdays.\tFor\tsimplicity,\tin\tthis\trecipe,\twe\twill\tbe\ttesting\tour metrics\tusing\tthe\tHTTP\tendpoints.\tActuator\tnot\tonly\texposes\tmetrics\tbut\talso some\tuseful\tendpoints\tto\tmanage\tour\tapplication.\tWe\twill\tlook\tat\tthem\tin\tthe next\trecipe.\n\n1.\t Without\tany\tdelay,\tlets'\tadd\tthe\tspring-boot-starter-actuator dependency\tto\tour\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t<artifactId>spring-boot-starter-actuator</artifactId> \t\t\t\t</dependency>\n\nNote\n\nWe\thave\tnot\tadded\tthe\tversion\tfor\tthe\tspring-boot-starter-actuator dependency.\tThat\tis\tbecause\tit\twill\tpick\tup\tthe\tversion\tmanaged\tby\tthe spring-boot-starter-parent\tPOM.\tIn\tour\tcase,\tthe\tversion\tof\tspring- boot-starter-\tactuator\tthat\twill\tbe\tresolved\tis\t1.3.6\trelease.\n\n2.\t Now\tthat\tour\tproject\tis\tready\twith\tActuator,\tlet's\ttest\tit.\tStart\tthe GeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tIf\tyou\tpay\tclose\tattention\tto\tthe\tlogs,\tthis\ttime\tyou\twill\tsee that\tthere\tare\tsome\tadditional\trequest\tmappings\tregistered,\tsuch\tas\t/beans, /info,\t/configprops,\t/health,\t/autoconfig,\t/mappings,\t/metrics,\t/env, /trace,\tand\t/dump.\tThese\trequest\tmappings\twere\tadded\tby\tthe\tSpring Actuator\tdependency:",
      "content_length": 1688,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 375,
      "content": "3.\t Let's\ttest\tour\tconfigurations.\tOpen\ta\tnew\tterminal\tsession\tand\tissue\tthe following\tcurl\tcommand:\n\ncurl\thttp://localhost:8080/metrics\n\nThis\tshould\thave\treturned\ta\tlist\tof\tmetrics\tthat\tare\tcurrently\tbeing\texposed by\tyour\tmicroservice\tusing\tSpring\tBoot\tActuator.\n\n4.\t You\tshould\tsee\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\n\n{ \t\t\t\t\t\t\t\t\"mem\":\t233838, \t\t\t\t\t\t\t\t\"mem.free\":\t65596, \t\t\t\t\t\t\t\t\"processors\":\t4, \t\t\t\t\t\t\t\t\"instance.uptime\":\t909667, \t\t\t\t\t\t\t\t\"uptime\":\t924127, \t\t\t\t\t\t\t\t\"systemload.average\":\t1.62548828125, \t\t\t\t\t\t\t\t\"heap.committed\":\t184832, \t\t\t\t\t\t\t\t\"heap.init\":\t131072, \t\t\t\t\t\t\t\t\"heap.used\":\t119235, \t\t\t\t\t\t\t\t\"heap\":\t1864192, \t\t\t\t\t\t\t\t\"nonheap.committed\":\t49984, \t\t\t\t\t\t\t\t\"nonheap.init\":\t2496, \t\t\t\t\t\t\t\t\"nonheap.used\":\t49006, \t\t\t\t\t\t\t\t\"nonheap\":\t0, \t\t\t\t\t\t\t\t\"threads.peak\":\t29, \t\t\t\t\t\t\t\t\"threads.daemon\":\t19, \t\t\t\t\t\t\t\t\"threads.totalStarted\":\t36, \t\t\t\t\t\t\t\t\"threads\":\t21, \t\t\t\t\t\t\t\t\"classes\":\t6154, \t\t\t\t\t\t\t\t\"classes.loaded\":\t6154, \t\t\t\t\t\t\t\t\"classes.unloaded\":\t0, \t\t\t\t\t\t\t\t\"gc.ps_scavenge.count\":\t8, \t\t\t\t\t\t\t\t\"gc.ps_scavenge.time\":\t101, \t\t\t\t\t\t\t\t\"gc.ps_marksweep.count\":\t1, \t\t\t\t\t\t\t\t\"gc.ps_marksweep.time\":\t46, \t\t\t\t\t\t\t\t\"httpsessions.max\":\t-1,",
      "content_length": 1137,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 376,
      "content": "\"httpsessions.max\":\t-1, \t\t\t\t\t\t\t\t\"httpsessions.active\":\t0, \t\t\t\t\t\t\t\t\"gauge.response.metrics\":\t16, \t\t\t\t\t\t\t\t\"gauge.response.star-star\":\t41, \t\t\t\t\t\t\t\t\"counter.status.200.metrics\":\t1, \t\t\t\t\t\t\t\t\"counter.status.404.star-star\":\t1 \t\t\t\t\t\t}\n\nIdeally,\tyou\twill\thave\tmore\tmetrics.\tAs\tyou\tcan\tsee,\tthe\tprevious\tmetrics are\tmore\ton\tthe\tJVM\tlevel.\tYou\twill\talso\tsee\tsome\tmetrics\tthat\tare\tHTTP related\t(such\tas\t404\tcounts\tand\t200\tcounts).\tThese\tmetrics\tare\tstarter\tbased. For\texample,\tif\tyou\thave\ta\tSpring\tData\tstarter\tconfigured\tin\tyour application,\tyou\twill\tsee\tsome\tdatabase-related\tmetrics\tas\twell.\tIf\tyou\tfind it\tdifficult\tto\tread\tthe\tmetrics\tfrom\tthe\tcommand\tline,\tfeel\tfree\tto\tuse\ttools such\tas\tPostman\tor\tother\tbrowser-based\tplugins\tthat\tcan\trender\tJSON\tin\ta pretty-printed\tformat.\n\n5.\t This\tverifies\tthat\twe\thave\tsuccessfully\tconfigured\tSpring\tBoot\tActuator\tin our\tapplication.\tThese\tmetrics\tmay\tbe\tuseful\ton\tthe\tJVM\tlevel,\tbut\tthey\tare not\tgoing\tto\thelp\tus\tmonitor\tour\tapplication-related\tmetrics,\twhich\tis\twhat we\twill\tbe\tlearning\tin\tlater\trecipes\tof\tthis\tchapter.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto configure\tSpring\tBoot\tActuator\tin\tour\tapplication.",
      "content_length": 1183,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 377,
      "content": "Understanding\tSpring\tBoot\tActuator metrics\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tconfigure\tSpring\tBoot\tActuator\tin\tthe geolocation\tapplication.\tWe\talso\tverified\tthe\tconfiguration\tby\taccessing\tthe /metrics\tendpoint.\tIn\tthis\trecipe,\twe\twill\tbe\tlearning\tmore\tabout\tmost\tof\tthe commonly\tused\tmetrics\texposed\tby\tSpring\tBoot\tActuator.",
      "content_length": 333,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 378,
      "content": "Getting\tready\n\nIn\torder\tto\tunderstand\tthe\tvarious\tmetrics\tand\toperations\texposed\tby\tthe\tSpring Boot\tActuator\tlibrary,\twe\twill\tbe\tinvoking\tthem\tone\tby\tone\tusing\tcURL commands.\tAs\twe\twill\tbe\tanalyzing\tthe\tJSON\tresponse\tof\tour\tmetric\tAPIs\ta\tlot, feel\tfree\tto\tuse\ta\ttool\tsuch\tas\tPostman\tor\tanother\tplugin\tfor\tyour\tbrowser\tto pretty-print\tJSON\tdocuments.",
      "content_length": 349,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 379,
      "content": "How\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tgo\tover\tthe\tmost\timportant endpoints\texposed\tby\tSpring\tBoot\tActuator.\n\n1.\t Some\tmetrics\texposed\tby\tActuator\tdepend\ton\tthe\tAPI\tusage,\tso\tlet's\tcreate some\tgeolocations\tand\ttry\tto\tquery\tthem:\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\n\n2.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\n\n3.\t To\tcheck\twhether\tour\tentity\twas\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\tcurl\thttp://localhost:8080/geolocation\n\n4.\t It\tshould\tgive\tyou\tan\toutput\tlike\tthis\t(pretty-printed\tfor\treadability):\t[\t{ \"latitude\":\t41.803488,\t\"longitude\":\t-88.14404,\t\"userId\":\t\"f1196aac- 470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t}\t] 5.\t Now\tlet's\tcreate\tthe\tsecond\tgeolocation:\tcurl\t-H\t\"Content-Type:\n\napplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\n\n6.\t This\tshould\tgive\tyou\tan\toutput\tsimilar\tto\tthe\tfollowing\t(pretty-printed\tfor readability):\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\":\t1468203975\t} 7.\t To\tverify\twhether\tyour\tentities\twere\tstored\tcorrectly,\texecute\tthe\tfollowing curl\tcommand:\tcurl\thttp://localhost:8080/geolocation\n\n8.\t It\tshould\tgive\tyou\tan\toutput\tlike\tthe\tfollowing\t(pretty-printed\tfor readability):\t[\t{\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.14404, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t},\t{\t\"latitude\":\t9.568012,\t\"longitude\":\t77.962444, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"timestamp\": 1468203975\t}\t]\n\n9.\t Now\tlet's\tinvoke\tthe\tmetrics\tAPI\tand\ttry\tto\tunderstand\tfew\tof\tthe\tmetrics: curl\thttp://localhost:8080/metrics\n\n10.\t You\tshould\treceive\ta\tresponse\tsimilar\tto\tthis\t(pretty-printed\tfor readability):\t{\t\"mem\":\t254684,\t\"mem.free\":\t112813,\t\"processors\":\t4,",
      "content_length": 2229,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 380,
      "content": "\"instance.uptime\":\t618061,\t\"uptime\":\t623669,\t\"systemload.average\": 1.8212890625,\t\"heap.committed\":\t205312,\t\"heap.init\":\t131072, \"heap.used\":\t92498,\t\"heap\":\t1864192,\t\"nonheap.committed\":\t51008, \"nonheap.init\":\t2496,\t\"nonheap.used\":\t49372,\t\"nonheap\":\t0,\t\"threads.peak\": 31,\t\"threads.daemon\":\t24,\t\"threads.totalStarted\":\t41,\t\"threads\":\t26, \"classes\":\t6262,\t\"classes.loaded\":\t6262,\t\"classes.unloaded\":\t0, \"gc.ps_scavenge.count\":\t7,\t\"gc.ps_scavenge.time\":\t93, \"gc.ps_marksweep.count\":\t1,\t\"gc.ps_marksweep.time\":\t58, \"httpsessions.max\":\t-1,\t\"httpsessions.active\":\t0, \"gauge.response.geolocation\":\t5,\t\"gauge.response.metrics\":\t4, \"gauge.response.star-star.favicon.ico\":\t3,\t\"counter.status.200.star- star.favicon.ico\":\t3,\t\"counter.status.200.metrics\":\t4, \"counter.status.200.geolocation\":\t4\t}\n\nHere\tis\ta\tquick\tdescription\tof\tsome\tof\tthese\tmetrics:\n\nmem\tand\tmem.free\tindicate\tthe\tamount\tof\tmemory\tused\tand\tavailable\tin KB. uptime\tindicates\tthe\tuptime\tof\tthe\tsystem\twhereas\tinstance.uptime indicates\tthe\tuptime\tof\tthe\tapplication\tcontext.\tThey\tare\tin\tmilliseconds. heap,\theap.used,\theap.init,\tand\theap.committed\tare\tall\tused\tto\tidentify the\tcurrent\theap\tstatus.\tThey\tare\tin\tKB. threads,\tthreads.peak,\tthreads.totalStarted,\tand\tthreads.daemon provide\tthe\tthread\tcounts. classes,\tclasses.loaded,\tand\tclasses.unloaded\tprovide\tthe\tinformation about\tthe\tclassloader\tlike\ttotal\tnumber\tof\tclasses\tavailable,\ttotal\tnumber\tof classes\tloaded,\tand\ttotal\tnumber\tof\tclasses\tunloaded. httpsessions.max\tand\thttpsessions.active\tindicate\tthe\tmaximum number\tof\tsessions\tand\tcurrently\tactive\tsession\tcount,\trespectively. gauge.response.<request_path>\tindicates\tthe\tresponse\ttime\tof\tthe\tlast request\tfor\tthe\tgiven\trequest\tpath. counter.status.<status_code>.<request_path>\tindicates\tthe\tnumber\tof times\ta\tparticular\tstatus\tcode\twas\treturned\tfor\tthe\tgiven\trequest\tpath.\n\nNote\n\nThis\tlist\tprovides\ta\tquick\tdescription\tof\tthe\tmost\tcommonly\tused\tmetrics. However,\tthere\tare\tother\tmetrics\ttoo,\tsuch\tas\tgarbage\tcollection-related",
      "content_length": 1991,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 381,
      "content": "metrics.\tYou\tmight\twant\tto\tuse\tthem\tfor\tdebugging.\tTo\tlearn\tmore\tabout\tthose metrics\tplease\tvisit\thttps://docs.spring.io/spring- boot/docs/current/reference/html/production-ready-metrics.html.\n\nThe\tnext\tuseful\tendpoint\tis\tthe\t/health\tendpoint.\tThis\tendpoint\tprovides\ta quick\tsnapshot\tview\tof\tyour\tapplication\tand\tits\tcomponents'\thealth.\tComponents include\tany\tSpring\tmodule,\tsuch\tas\tConsul,\tEureka,\tMySQL,\tand\tso\ton depending\ton\twhether\tyou\tuse\tthem\tin\tyour\tproject.\tIn\tour\tcase,\twe\tdon't\thave any\tSpring\tmodules,\tso\twe\twill\tjust\tsee\ta\thigh-level\thealth\tcheck\tfor\tour\tapp.\n\n1.\t Let's\ttest\tit\tout:\tcurl\thttp://localhost:8080/health 2.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"status\":\t\"UP\",\t\"diskSpace\":\t{\t\"status\":\t\"UP\",\t\"total\": 498876809216,\t\"free\":\t142243303424,\t\"threshold\":\t10485760\t}\t}\n\nAs\tyou\tcan\tsee,\tit\tprovides\tan\toverall\thealth\tstatus\tsaying\tit\tis\tUP\tand\talso provides\tthe\thealth\tof\tthe\tdisk,\tincluding\tsome\tmetrics.\tThis\tendpoint\tis something\tthat\tyou\twill\tend\tup\tusing\tvery\toften,\teither\tto\tcheck\twhether you\tapp\tis\tup\tand\trunning\tor\tto\tcheck\twhether\tall\tthe\tcomponents\tof\tyour app\tare\tworking\tas\texpected.\n\n3.\t The\tnext\tmost\timportant\tendpoint\tis\tthe\t/env\tendpoint.\tThis\tendpoint provides\tuseful\tinformation\tsuch\tas\tJVM\targuments,\tsystem\tproperties,\tand system\tenvironment\tvariables.\tLet's\ttake\ta\tquick\tlook\tat\tit:\tcurl http://localhost:8080/env\n\n4.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t{ \"profiles\":\t[],\t\"server.ports\":\t{\t\"local.server.port\":\t8080\t}, \"commandLineArgs\":\t{\t\"spring.output.ansi.enabled\":\t\"always\"\t}, \"servletContextInitParams\":\t{\t},\t\"systemProperties\":\t{ \"com.sun.management.jmxremote.authenticate\":\t\"false\", \"java.runtime.name\":\t\"Java(TM)\tSE\tRuntime\tEnvironment\", \"java.vm.version\":\t\"25.40-b25\",\t\"gopherProxySet\":\t\"false\", \"java.vm.vendor\":\t\"Oracle\tCorporation\",\t\"java.vendor.url\": \"http://java.oracle.com/\",\t\"java.rmi.server.randomIDs\":\t\"true\", \"path.separator\":\t\":\",\t\"java.vm.name\":\t\"Java\tHotSpot(TM)\t64-Bit\tServer VM\",\t\"file.encoding.pkg\":\t\"sun.io\",\t\"user.country\":\t\"US\", \"sun.java.launcher\":\t\"SUN_STANDARD\",\t\"sun.os.patch.level\": \"unknown\",\t\"PID\":\t\"10883\",\t\"com.sun.management.jmxremote.port\": \"64324\",\t\"java.vm.specification.name\":\t\"Java\tVirtual\tMachine",
      "content_length": 2261,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 382,
      "content": "Specification\",\t.\t.\t.\t},\t\"systemEnvironment\":\t{\t\"PATH\": \"usrbin:/bin:usrsbin:/sbin\",\t\"APP_ICON_6659\":\t\"../Resources/sts.icns\", \"SHELL\":\t\"binbash\",\t\"JAVA_MAIN_CLASS_10883\": \"com.packt.microservices.geolocation.GeoLocationApplication\", \"JAVA_STARTED_ON_FIRST_THREAD_6659\":\t\"1\",\t.\t.\t}, \"applicationConfig:\t[classpath:/application.properties]\":\t{\t\"server.port\": \"${GEOLOCATION_SERVICE_PORT:8080}\"\t}\t}\n\nThe\tmost\timportant\tpart\tof\tthis\tAPI\tis\tthat\tit\tprovides\tthe\tJVM\targuments and\tsystem\tenvironment\tvariables\twith\ttheir\tvalues.\tThis\tis\tvery\tuseful when\tyou\tpass\targuments\tto\tyour\tapplication\tin\tthe\tform\tof\tJVM arguments\tor\tsystem\tenvironment\tvariables.\tIn\tour\tcase,\twe\tuse\tan environment\tvariable\tcalled\tGEOLOCATION_SERVICE_PORT;\thowever,\twe\tsee that\tit\tis\tnot\tbeing\tsupplied\tto\tthe\tenvironment.\tThis\tis\tthe\treason\tour\tserver port\tis\tdefaulted\tto\t8080.\n\n5.\t The\tnext\tuseful\tendpoint\tis\tthe\t/dump\tendpoint.\tThis\tendpoint\tperforms\ta thread\tdump\tand\tprovides\tthe\toutput\tas\tthe\tresponse\tof\tthe\tAPI\tcall.\tGo ahead\tand\texecute\tthe\tfollowing\tcurl\tcommand\tin\ta\tterminal\tshell:\tcurl http://localhost:8080/dump\t[\t{\t\"threadName\":\t\"http-nio-8080-exec- 10\",\t\"threadId\":\t47,\t\"blockedTime\":\t-1,\t\"blockedCount\":\t0, \"waitedTime\":\t-1,\t\"waitedCount\":\t2,\t\"lockName\": \"java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@3386c54f\", \"lockOwnerId\":\t-1,\t\"lockOwnerName\":\tnull,\t\"inNative\":\tfalse, \"suspended\":\tfalse,\t\"threadState\":\t\"WAITING\",\t\"stackTrace\":\t[\t{ \"methodName\":\t\"park\",\t\"fileName\":\t\"Unsafe.java\",\t\"lineNumber\": -2,\t\"className\":\t\"sun.misc.Unsafe\",\t\"nativeMethod\":\ttrue\t}, This\tresponse\thas\tbeen\ttruncated\tas\tit\twas\ttoo\tlengthy.\tAs\tyou\tcan\tsee,\tthe response\tis\ta\tJSON\trepresentation\tof\tthe\tdump.\tOne\tadvantage\tof\tthe\tJSON representation\tis\tthat\tit\tcan\tbe\tparsed\teasily.\n\n6.\t The\tnext\tuseful\tendpoint\tis\tthe\t/info\tendpoint.\tThis\tendpoint\tprovides\tany information\tthat\tyou\twould\tlike\tto\tdisplay\tabout\tyour\tapplication.\tSome useful\tinformation\tcould\tbe\tthe\tGit\trevision\tID,\tapplication\tartifact\tversion, and\tpublish\tdate\ttime.\n\n7.\t The\tnext\tuseful\tendpoint\tis\tthe\t/trace\tendpoint.\tIt\tideally\tprovides\tthe trace\tlog\tinformation\tof\tthe\tlast\thundred\trequests\tmade\tto\tthe\tservice.\tIn\tthe same\tterminal\tshell,\texecute\tthe\tfollowing\tcurl\tcommand:\tcurl",
      "content_length": 2243,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 383,
      "content": "http://localhost:8080/trace\n\n8.\t You\tshould\treceive\tsomething\tlike\tthis\t(pretty-printed\tfor\treadability):\t[\t{ \"timestamp\":\t1481818606409,\t\"info\":\t{\t\"method\":\t\"GET\",\t\"path\": \"/info\",\t\"headers\":\t{\t\"request\":\t{\t\"host\":\t\"localhost:8080\", \"connection\":\t\"keep-alive\",\t\"upgrade-insecure-requests\":\t\"1\",\t\"user- agent\":\t\"Mozilla/5.0\t(Macintosh;\tIntel\tMac\tOS\tX\t10_11_6) AppleWebKit/537.36\t(KHTML,\tlike\tGecko)\tChrome/54.0.2840.98 Safari/537.36\",\t\"accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\", \"accept-encoding\":\t\"gzip,\tdeflate,\tsdch,\tbr\",\t\"accept-language\":\t\"en- US,en;q=0.8,es;q=0.6\"\t},\t\"response\":\t{\t\"X-Application-Context\": \"application:8080\",\t\"Content-Type\":\t\"application/json;charset=UTF- 8\",\t\"Transfer-Encoding\":\t\"chunked\",\t\"Date\":\t\"Thu,\t15\tDec\t2016 16:16:46\tGMT\",\t\"status\":\t\"200\"\t}\t}\t}\t},... As\tyou\tcan\tsee,\twe\thave\ttruncated\tthe\tresponse\tas\tit\twas\ttoo\tlong.\tThe snippet\tshows\tjust\tone\trequest\tand\tits\tinformation.\tThis\twill\tbe\tparticularly useful\twhen\tyou\tare\tdebugging\tyour\tAPI\tfailures.\n\n9.\t Oftentimes,\tyou\tmight\twant\tto\tmodify\tthese\tmetrics.\tBe\tit\texposing\tyour own\thealth\tstatus\tor\texposing\tsome\tinformation\tmetrics,\tthere\tare\tways\tto do\tso\tusing\tSpring. Note\n\nIf\tyou\twould\tlike\tto\tinvest\tmore\ttime\ton\tthese\ttopics,\tgo\tover\tthe descriptive\tdocumentation\ton\tSpring\tBoot's\tGitHub\tdocumentation\tat https://github.com/spring-projects/spring-boot/blob/master/spring-boot- docs/src/main/asciidoc/production-ready-features.adoc\t.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tThere\tare\tother\tendpoints\tthat\twe\thave not\tdiscussed\tin\tthis\trecipe,\tsuch\tas\t/shutdown,\t/loggers,\t/mappings, /configprops,\t/beans,\tand\t/autoconfig.\tI'll\tleave\tthat\tas\tan\texercise\tfor\tyou to\ttry\tout.\tThe\t/shutdown\tendpoint\tis\tdisabled\tby\tdefault.\tYou\thave\tto\tenable\tit by\tsetting\tthe\tvalue\tof\tendpoints.shutdown.enabled\tto\ttrue\tin\tyour application.properties\tfile.",
      "content_length": 1872,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 384,
      "content": "Creating\tcustom\tmetrics\tusing Dropwizard\n\nSo\tfar\tin\tthis\tchapter,\twe've\tlearned\thow\tto\tuse\tthe\tSpring\tBoot\tActuator metrics.\tBut\twhat\tif\tyour\tapplication\tis\tnot\tSpring\tBoot\tand\tyou\tstill\twant\tto create\tmetrics\tof\tyour\town?\tThat\tis\twhat\tthis\trecipe\twill\thelp\tyou\twith.\tNot every\tmicroservice\tneeds\tto\tbe\tSpring\tBoot\tbased.\tThere\tare\tsome\tmicroservices that\tcould\tbe\twritten\twith\tother\tmicroservice\tframeworks.\tIn\tthose\tcases,\tif\tyou would\tlike\tto\tcreate\tyour\town\tmetrics,\tyou\tcould\tuse\tDropwizard's\tCodahale library.\tCodahale\tis\tone\tof\tthe\tmost\tpopular\tmetrics\tlibraries\tavailable\tfor\tJava- based\tapplications.\tIn\tfact,\tSpring\tBoot\tinternally\tuses\tCodahale\tto\tcreate\tsome of\tits\tmetrics.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tCodahale\tlibrary\tto\tcreate\ta metric\tfor\tthe\tgeolocation\tapplication.",
      "content_length": 792,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 385,
      "content": "Getting\tready\n\nIf\tyou\tare\twondering\twhat\tthe\tassociation\tbetween\tDropwizard\tand\tCodahale\tis, the\tanswer\tis\tthat\tCodahale\tfalls\tunder\tthe\tDropwizard\tumbrella.\tDropwizard\tis an\tecosystem\tof\tlibraries\tthat\tcan\tbe\tused\tto\tbuild\tbetter\tmicroservices.\tSome\tof these\tlibraries\tinclude\tJetty\tfor\tin-memory\tweb\tservers,\tJersey\tfor\tbuilding REST\tAPIs,\tJackson\tfor\tworking\twith\tJSON\tdocuments,\tand\tCodahale\tfor metrics.\tIn\tthis\trecipe,\twe\twill\tbe\tusing\tjust\tthe\tCodahale\tlibrary\tto\texpose\tour metrics.\tThe\tgreat\tthing\tabout\tthis\tlibrary\tis\tthat\tit\thas\tbeen\tdeveloped\tin\tsuch\ta way\tthat\tit\tcan\tbe\tused\tindependently\tas\twell-that\tmeans\tyou\tcan\tuse\tCodahale even\twhen\tyour\tproject\tdoes\tnot\tuse\tthe\tother\tDropwizard\tcomponents.\tLet's create\tour\tfirst\tmetric.\tOpen\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe\tgeolocation project.",
      "content_length": 802,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 386,
      "content": "How\tto\tdo\tit...\n\nBefore\twe\tjump\tin,\tlet's\tdecide\twhich\ttype\tof\tmetric\twe\tare\tgoing\tto\tcreate. There\tare\tseveral\tmetric\ttypes\tthat\tDropwizard\tCodahale\toffers:\n\nGauges Counters Meters Timers Histograms\n\nA\tgauge\tis\ta\ttype\tof\tmetric\tthat\tcan\thold\tany\tvalue.\tIt\tis,\tin\tfact,\tthe\tmost common\tmetric\ttype.\tThe\tnext\ttype\tof\tmetric\tis\tcounter.\tCounters,\tas\tthe\tname indicates,\tare\tused\tto\tmaintain\ta\tcounter\tand\tare\tusually\tincremented\tin\ta sequence.\tAny\trate\tis\tusually\trepresented\tas\ta\tmeter.\tA\thistogram\tis\tused\tto measure\tthe\tdistribution\tof\tvalues.\tThough\ttimers\tsound\tpretty\tstraightforward, they're\tactually\tnot.\tTimers\tare\ta\tcombination\tof\tboth\thistograms\tand\tmeters. Understanding\ttimers\ttakes\tsome\ttime,\tbut\tputting\tthem\tto\tuse\twill\tadd\tgreat value.\tTo\tlearn\tmore\tabout\thistograms\tplease\ttake\ta\tlook\tat http://metrics.dropwizard.io/3.1.0/getting-started\t.\tIn\tthis\trecipe,\tlet's\ttry\tto create\ttwo\ttypes\tof\tmetrics:\tgauge\tand\tcounter:\n\ngeolocationWriteRequestCount:\tThe\tnumber\tof\ttimes\tthe\tPOST\tAPI\twas invoked\t(counter) geolocationLastWriteTime:\tThe\tmost\trecent\ttimestamp\tof\twhen\ta geolocation\twas\tcreated\t(gauge)\n\nLet's\tstart\tby\tcreating\ta\tnew\tcounter\tfor\tthe\tgeolocationWriteRequestCount metric:\n\n1.\t First\tadd\tthe\tMaven\tdependencies\twe\tneed:\t<dependency> <groupId>io.dropwizard.metrics</groupId>\t\t\t\t\t<artifactId>metrics- core</artifactId>\t</dependency>\n\n2.\t Now\tcreate\ta\tbean\tcalled\n\ncom.packt.microservices.geolocation.MetricSystem.java,\twhich\twill be\tresponsible\tfor\tinstantiating\tand\treporting\tour\tmetrics.\tFor\treporting,\twe will\tuse\tour\tbasic\tConsoleReporter\tuntil\twe\tset\tup\tour\tGraphite\tinstance.\n\n3.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservices.geolocation.MetricSystem.java.\tAnnotate",
      "content_length": 1700,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 387,
      "content": "this\tclass\twith\tthe\t@Component\tannotation.\tAlso\tadd\tan\tinit()\tmethod\twith @PostConstruct\tannotation.\tThis\tis\twhere\twe\twill\tbe\tsetting\tup\tour metrics:\tpackage\tcom.packt.microservices.geolocation;\timport javax.annotation.PostConstruct;\timport org.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; @PostConstruct\tpublic\tvoid\tinit()\t{\t}\t}\n\nAs\tyou\tcan\tsee,\twe\thave\tautowired\ta\tbean\tof\ttype\tMetricRegistry\tinstead of\tcreating\tour\town\tMetricRegistry\tinstance.\tSpring\tBoot\tmakes\tthe MetricRegistry\tbean\tavailable.\tSo\tany\tmetric\tcreated\twith\tthis MetricRegistry\tinstance\twill\tbe\texposed\tby\tthe\t/metrics\tendpoint\tas well.\tThis\tis\tthe\treason\twe\tare\tautowiring\tthe\tMetricRegistry\tbean. 4.\t Before\twe\tcreate\tthe\tmetric,\tlet's\tset\tup\ta\tConsoleReporter.\tCodahale\n\nprovides\ta\tset\tof\tmetric\treporters\tresponsible\tfor\tpublishing\tthe\tmetrics\tthat are\tcreated\tto\tanother\tconsumption\tlayer.\tCurrently,\tthere\tis\tsupport\tfor Graphite,\tGanglia,\tSLF4J,\tCSV,\tand\tConsole.\tThe\tConsoleReporter,\tas\tits name\tindicates,\treports\tall\tthe\tmetrics\tto\tstdout.\tIn\tthe\tnext\trecipe,\twe\twill set\tup\tour\town\tGraphite\tinstance\twith\tthe\thelp\tof\tDocker.\tUntil\tthen,\tfor simplicity,\twe\twill\tbe\tusing\tthe\tConsoleReporter.\tAdd\tthe\tfollowing snippet\tto\tthe\tinit()\tmethod:\tConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS);\n\nThere\tare\tthree\tthings\tto\tnote\there.\tThe\tconvertRatesTo()\tmethod\tsays that\tall\tthe\trates\thave\tto\tbe\tconverted\tto\tseconds,\tand\tthe convertDurationsTo()\tmethod\tsays\tthat\tall\tthe\tdurations\tshould\tbe converted\tto\tmilliseconds.\tThe\tstart\tmethod,\thowever,\ttakes\ttwo arguments.\tThese\ttwo\targuments\ttogether\ttell\tCodahale\tto\treport\tmetrics\tto the\tconsole\tevery\t10\tseconds.\n\n5.\t Now\tcreate\ta\tnew\tCounter\tvariable\twith\tthe\tname\n\ngeolocationWriteRequestCount.\tLet's\tdefine\tit\tin\tthe\tinit()\tmethod\tand put\tit\tinto\taction:\tpackage\tcom.packt.microservices.geolocation;\timport",
      "content_length": 2181,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 388,
      "content": "java.util.concurrent.TimeUnit;\timport\tjavax.annotation.PostConstruct; import\torg.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.ConsoleReporter;\timport com.codahale.metrics.Counter;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; private\tCounter\tgeolocationWriteRequestCount;\t@PostConstruct\tpublic void\tinit()\t{\tConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS); geolocationWriteRequestCount\t= metricRegistry.counter(\"geolocationWriteRequestCount\");\t}\tpublic\tCounter geolocationWriteRequestCount()\t{\treturn\tgeolocationWriteRequestCount;\t} }\n\nIt\tis\tas\tsimple\tas\tthat.\tWe\thave\talso\tcreated\ta\tmethod\tto\tget\tthis\tcounter\tso that\tit\tcan\tbe\tused\tfrom\tour\tcontroller.\n\n6.\t Now\tmove\ton\tto\tthe\tGeoLocationController.java\tclass\tand\tincrement\tthe counter\tusing\tthe\tinc()\tmethod\tas\tand\twhen\ta\tnew\tgeolocation\tis\tcreated. Though\tthis\tmight\tnot\tbe\ta\tgood\tpractice,\twe\tare\tgoing\tto\tadd\tit\tto\tthe controller\tfor\tillustration\tpurposes\tonly:\t@Autowired\tprivate\tMetricSystem metricSystem;\t@RequestMapping(method\t=\tRequestMethod.POST, produces\t=\t\"application/json\",\tconsumes\t=\t\"application/json\")\tpublic GeoLocation\tcreate(@RequestBody\tGeoLocation\tgeolocation)\t{ GeoLocation\tnewGeoLocation\t=\tservice.create(geolocation); metricSystem.geolocationWriteRequestCount().inc();\treturn newGeoLocation;\t} As\tyou\tcan\tsee,\twe\thave\tautowired\tthe\tMetricSystem\tbean\tand\tused\tit\tto get\tour\tgeolocationWriteRequestCount\tcounter.\tWe\thave\tthen\tinvoked the\tinc()\tmethod\tto\tincrement\tthe\tcounter.\n\n7.\t That's\tit!\tNow\tlets'\ttest\tit\tout.\tGo\tahead\tand\tstart\tthe\n\nGeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot\tapplication\tfrom your\tSTS\tIDE.\tAfter\tyour\tapplication\thas\tstarted,\tissue\tthe\tfollowing\tcurl",
      "content_length": 1989,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 389,
      "content": "commands\tto\tcreate\ttwo\tnew\tgeolocations:\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\": 1468203975,\t\"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\", \"latitude\":\t9.568012,\t\"longitude\":\t77.962444}' http://localhost:8080/geolocation\n\nThis\tshould\thave\tincremented\tthe\tcounter\tvalue\tto\t2.\n\n8.\t Now\tgo\tback\tto\tyour\tSTS\tIDE,\tand\tlook\tat\tthe\tconsole\tlogs\tof\tthe geolocation\tproject.\tYou\tshould\tsee\tsomething\tlike\tthis\tgetting\tlogged every\t10\tseconds:\tGauges\t-------------------------------------------------- gauge.response.geolocation\tvalue\t=\t32.0\tCounters\t--------------------------- -----------------------\tcounter.status.200.geolocation\tcount\t=\t2 geolocationWriteRequestCount\tcount\t=\t2\n\nWe\tcan\tclearly\tsee\tthat\tthe\tvalue\tof\tgeolocationWriteRequestCount\tis\t2 now.\tAlso\tnote\tthe\tother\ttwo\tmetrics,\tgauge.response.geolocation\tand counter.status.200.geolocation.\tThese\tmetrics\tare\tcreated\tby\tSpring Boot.\tIf\tyou\tremember\tfrom\tthe\tprevious\trecipe,\tthese\tmetrics\twere displayed\ton\tthe\t/metrics\tendpoint.\n\n9.\t Now\tlet's\tquickly\tinvoke\tthe\t/metrics\tendpoint\tto\tcheck\twhether\tour metrics\tare\tpopulated.\tExecute\tthe\tfollowing\tcurl\tcommand\ton\tyour terminal:\tcurl\thttp://localhost:8080/metrics\t{\t.\t. \"counter.status.200.geolocation\":\t2,\t\"gauge.response.geolocation\":\t32, \"geolocationWriteRequestCount\":\t2,\t.\t.\t}\n\nThis\tresponse\thas\tbeen\ttrimmed\tas\tit\twas\tvery\tlong.\tAs\tyou\tcan\tsee,\tamong other\tmetrics,\tthe\tthree\tmetrics\tthat\twe\tsaw\tin\tthe\tconsole\tare\treported. 10.\t Now\tlet's\tcreate\tour\tnext\tmetric,\tgeolocationLastWriteTime.\tThis\tmetric will\tbe\ta\tgauge,\tand\twe\twill\tbe\tstoring\tthe\tepoch\ttime\tas\tthe\tvalue.\tWe\tcan get\tthe\tepoch\ttime\tin\tJava\tusing\tSystem.currentTimeMillis().\tAs\tthis metric\tis\tgoing\tto\tstore\tthe\tlast\twrite\ttimestamp,\tthis\tmetric\tneeds\tto\tbe updated\tonly\twhen\ta\tnew\tgeolocation\tis\tcreated.\tSo\twe\twill\tneed\ta\tholder variable\tin\tour\tMetricSystem\tbean\tthat\tis\tupdated\twith\tthe\ttime\tevery\ttime a\tnew\tgeolocation\tis\tcreated.\tThe\tgauge\tis\ta\tlittle\tdifferent\tfrom\tthe\tcounter for\tthe\tfact\tthat\tit\tgets\tcalculated\tevery\ttime\tit\tgets\treported.\tAfter\tadding",
      "content_length": 2280,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 390,
      "content": "the\tgeolocationLastWriteTime\tgauge,\tthe\tMetricSystem\tbean\twill\tlook like\tthis:\tpackage\tcom.packt.microservices.geolocation;\timport java.util.concurrent.TimeUnit;\timport\tjavax.annotation.PostConstruct; import\torg.springframework.beans.factory.annotation.Autowired;\timport org.springframework.stereotype.Component;\timport com.codahale.metrics.ConsoleReporter;\timport com.codahale.metrics.Counter;\timport\tcom.codahale.metrics.Gauge;\timport com.codahale.metrics.MetricRegistry;\t@Component\tpublic\tclass MetricSystem\t{\t@Autowired\tprivate\tMetricRegistry\tmetricRegistry; private\tCounter\tgeolocationWriteRequestCount;\tprivate\tLong geolocationLastWriteTime;\t@PostConstruct\tpublic\tvoid\tinit()\t{ ConsoleReporter\tconsoleReporter\t= ConsoleReporter.forRegistry(metricRegistry) .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS)\t.build(); consoleReporter.start(10,\tTimeUnit.SECONDS); geolocationWriteRequestCount\t= metricRegistry.counter(\"geolocationWriteRequestCount\"); metricRegistry.register(\"geolocationLastWriteTime\",\tnew\tGauge<Long>() {\t@Override\tpublic\tLong\tgetValue()\t{\treturn\tgeolocationLastWriteTime;\t} });\t}\tpublic\tCounter\tgeolocationWriteRequestCount()\t{\treturn geolocationWriteRequestCount;\t}\tpublic\tvoid markGeolocationLastWriteTime()\t{\tgeolocationLastWriteTime\t= System.currentTimeMillis();\t}\t}\n\nSee\thow\tthe\tgauge\tis\tregistered\twith\tan\tinner\tclass\tthat\thas\ta\tgetter\tmethod called\tgetValue().\tAlso\tsee\thow\twe\thave\tcreated\tthe markGeolocationLastWriteTime()\tmethod\tthat\tupdates\tthis\tvariable\twith the\tcurrent\ttimestamp.\n\n11.\t We\tare\tnow\tready\tto\tincorporate\tthis\tmetric\tinto\tthe\n\nGeoLocationController.java.\tAll\twe\tneed\tto\tdo\tis\tadd\tthis\tline\tof\tcode\tto the\tcreate\tmethod:\tmetricSystem.markGeolocationLastWriteTime();\n\n12.\t That's\tit.\tOur\tgauge\tis\tnow\tready\tto\ttest.\tRestart\tthe\n\nGeolocationApplication.java\tclass\tand\tcreate\ta\tcouple\tof\tgeolocations using\tthe\tcurl\tcommand.\tThis\ttime\taround,\tyou\tshould\tsee\ta\tnew\tgauge with\tthe\tlast\twrite\ttimestamp\tas\tits\tvalue:\t--\tGauges\t---------------------------- -----------------------------------\tgauge.response.geolocation\tvalue\t=\t11.0",
      "content_length": 2100,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 391,
      "content": "geolocationLastWriteTime\tvalue\t=\t1481939509826\t--\tCounters\t---------- ---------------------------------------------------\tcounter.status.200.geolocation count\t=\t2\tgeolocationWriteRequestCount\tcount\t=\t2\n\n13.\t You\tcan\tverify\tthis\tby\tinvoking\tthe\t/metrics\tendpoint\tas\twell.\n\nThat's\tit!\tWe\tnow\thave\tcome\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned how\tto\tcreate\tcustom\tmetrics\tand\texpose\tthem\tvia\tSpring\tBoot's\t/metrics endpoint.\tWe\talso\tlearned\thow\tto\texpose\tthem\tvia\tthe\tConsoleReporter.",
      "content_length": 495,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 392,
      "content": "Setting\tup\tGraphite\tusing\tDocker\n\nIn\tthis\trecipe,\twe\twill\tlearn\thow\tto\tset\tup\tGraphite\tusing\tDocker.\tBefore\tthat, let's\tlearn\ta\tfew\tthings\tabout\tGraphite's\tarchitecture.\tGraphite\tconsists\tof\tthree major\tcomponents:\tWhisper,\tCarbon,\tand\tGraphite-Web.\tWhisper\tis\ta database\tlibrary\tthat\tGraphite\trelies\ton.\tIt\tworks\tlike\ta\tround-robin\tdatabase. Carbon\tis\tthe\tbackend\tdaemon\tthat\tis\tresponsible\tfor\thandling\tclient\trequests. The\tGraphite-Web\tinterface\tis\tused\tto\tcreate\tdashboards\tand\tvisualize\tthe\tdata stored\tin\tGraphite.",
      "content_length": 520,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 393,
      "content": "Getting\tready\n\nAs\tusual,\twe\twill\tbe\tdefining\tour\tGraphite\timage\tin\ta\tdocker-compose\tfile.\tThe reason\twe\tare\tusing\tdocker-compose\tinstead\tof\trunning\tdocker\trun\tis\tthat\twe will\tlater\tbe\tadding\tGrafana\tto\tthis\tdocker-compose\tfile.\tOpen\tup\tyour\tSTS\tIDE and\tnavigate\tto\tthe\tgeolocation\tproject.",
      "content_length": 289,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 394,
      "content": "How\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\tguide\tyou\tthrough\tsetting\tup\ta\tstandalone Graphite\tinstance\tusing\tDocker.\n\n1.\t Create\ta\tnew\tdocker-compose\tYAML\tfile\tcalled\tdocker-compose- graphite.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tYAML\tfile:\n\nversion:\t\"2\"\n\nservices: \t\tgraphite: \t\t\t\timage:\thopsoft/graphite-statsd \t\t\t\tports: \t\t\t\t\t\t-\t\"8100:80\" \t\t\t\t\t\t-\t\"2003:2003\" \t\t\t\t\t\t-\t\"2004:2004\"\n\nAs\tyou\tcan\tsee,\twe\tare\tnot\tusing\tan\tofficial\timage\tfor\tGraphite. Unfortunately,\tthere\tis\tno\tofficial\tversion\tof\tGraphite\tavailable\tat\tthe\ttime of\twriting\tthis.\tSo\twe\thave\tpicked\tthis\timage\tthat\thas\tboth\tGraphite\tand statsd\tconfigured.\tstatsd\tis\ta\tdaemon\tdeveloped\tby\tEtsy\tto\tconsolidate application\tmetrics\tand\tpublish\tthem\tover\tto\ta\tgraphing\tsystem.\n\n2.\t To\tlearn\tmore\tabout\tstatsd,\tvisit\ttheir\tGitHub\tpage\tat\n\nhttps://github.com/etsy/statsd\t.\tIf\tyou\ttake\ta\tlook\tat\tthis\timage's documentation\tat\thttps://hub.docker.com/r/hopsoft/graphite-statsd\t,\tthere are\tseveral\tports\tand\tvolumes\tthat\tcan\tbe\tmapped.\tWe\tare\tnot\tmapping them\tas\twe\twill\tnot\tneed\tthem\tfor\tthis\trecipe.\tBut\tfeel\tfree\tto\tuse\tthem\tif you\tneed\tto.\tPort\t80\tis\tused\tby\tNginx,\twhere\tyour\tweb\tinterface\tand\tREST endpoints\treside.\tPort\t2003\tis\twhere\tthe\tCarbon\treceiver\tis\tlistening.\tPort 2004\tis\twhere\tCarbon\tPickle\treceiver\tis\tlistening.\tWe\tare\tnot\tmapping\tport 80\ton\tthe\tcontainer\tto\tport\t80\ton\tthe\thost\tbecause\tport\t80\tis\ta\tvery\tcommon port\tnumber\tand\tyou\tmight\thave\tother\tapps\trunning\ton\tport\t80.\tSo\twe\tare mapping\tit\tto\tport\t8100\ton\tthe\thost\tmachine.\n\nNote\n\nThere\tare\ttwo\ttypes\tof\tprotocols\tby\twhich\tyou\tcan\tfeed\tmetrics\tto\tCarbon: Plain\ttext\tand\tPickle.\tPlain\ttext\tfollows\tthe\tsimplest\tformat,\twhere\tit\tsends metrics\tin\tthe\tformat\tof\t<path>\t<value>\t<timestamp>,\twhere\tpath",
      "content_length": 1748,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 395,
      "content": "indicates\tthe\tpath\tat\twhich\tthe\tmetric\twill\tbe\tstored\talong\twith\tthe\tmetric name.\tHowever,\tPickle\ton\tthe\tother\thand\tis\tused\tto\tsend\ta\tbatch\tof\tmetrics all\tat\tonce\tto\tCarbon.\tIt\ttakes\tmetrics\tin\tform\tof\ttuples:\t[(path, (timestamp,\tvalue))].\tFor\tmore\tinformation,\tlook\tat\tGraphite's descriptive\tdocumentation\tat http://graphite.readthedocs.io/en/latest/feeding-carbon.html#feeding-in- your-data\t.\n\n3.\t Now\tthat\twe\thave\tour\tdocker-compose\tYAML\tfile,\tlet's\tspin\toff\tour\tfirst Graphite\tinstance.\tOpen\tup\ta\tnew\tterminal\twindow.\tStart\tdocker-machine if\tit\tis\tnot\tstarted\talready,\tand\tset\tup\tDocker\tusing\tthe\tenv\tcommand. Change\tyour\tdirectory\tto\tthe\tgeolocation\tproject\tand\texecute\tthe following\tcommand:\n\ndocker-compose\t-f\tdocker-compose-graphite.yml\tup\n\n4.\t You\tshould\tsee\tsomething\tlike\tthis:\n\nCreating\tgeolocation_graphite_1 Attaching\tto\tgeolocation_graphite_1 graphite_1\t\t|\t***\tRunning\t etcmy_init.d/00_regen_ssh_host_keys.sh... graphite_1\t\t|\t***\tRunning\tetcmy_init.d/01_conf_init.sh... graphite_1\t\t|\t***\tRunning\tetcrc.local... graphite_1\t\t|\t***\tBooting\trunit\tdaemon... graphite_1\t\t|\t***\tRunit\tstarted\tas\tPID\t13\n\n5.\t Now\tthat\tour\tGraphite\tinstance\tis\tup\tand\trunning,\tlet's\tverify\tit\tby accessing\tthe\tweb\tinterface.\tOpen\ta\tnew\tbrowser\tsession\tand\tnavigate\tto this\tURL:\thttp://192.168.99.100:8100.\tYou\tshould\tsee\tthe\tGraphite dashboard\tpage:",
      "content_length": 1337,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 396,
      "content": "6.\t If\tyou\tlog\tin\tto\tthe\tapp\tusing\tthe\tcredentials\troot/root,\tyou\twill\tbe\table\tto manage\tthe\tgraphs\tthat\tyou\thave\tcreated.\tIt\twill\talso\tenable\tcertain\tfeatures on\tthe\twhole\tUI.\tNow\texpand\tthe\tMetrics\tnode\tand\tsee\twhat\tkind\tof metrics\tare\tbeing\texposed:",
      "content_length": 252,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 397,
      "content": "As\tyou\tcan\tsee,\tthere\tare\tsome\tmetrics\tingested\tby\tstatsd.\tUsually,\tmetrics created\tby\tstatsd\tstart\twith\tthe\tkeyword\tstats.\tYou\tcan\tplot\teach\tof\tthese metrics\ton\ta\tgraph\tby\tsimply\tclicking\ton\tthem.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tGraphite\tby\titself\toffers\ttons\tof\tfeatures, and\tits\ttrue\tpower\tcan\tbe\texperienced\tonly\twhen\twe\trun\tit\tin\tclustered\tmode.\tIt is\tstrongly\trecommended\tthat\tyou\tunderstand\tGraphite\tand\tits\tcomponents before\tyou\tstart\tusing\tit\tin\tproduction.\n\nNote\n\nFortunately,\tGraphite's\tdocumentation\tis\tvery\tdescriptive\tand\thas\ta\tlot\tof\tuseful information.\tYou\tcan\tfind\tit\tat\thttp://graphite.readthedocs.io/en/latest/index.html .",
      "content_length": 652,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 398,
      "content": "Using\tthe\tGraphite\tinterface\n\nIn\tthis\trecipe,\tlet's\tfamiliarize\tourselves\twith\tthe\tGraphite\tweb\tinterface.\tThough it\tlooks\tvery\tsimple,\tit\tis\tpacked\twith\ttons\tof\tgraphing\tfeatures.\tWe\twill\tlook\tat some\tof\tthem\tin\tthis\trecipe.\tFor\tgraphing,\twe\twill\tuse\tthe\tmetrics\tthat\tare created\tby\tstatsd.",
      "content_length": 291,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 399,
      "content": "Getting\tready\n\nWe\twill\tbe\tpicking\tsome\tbasic\tmetrics\tfrom\tGraphite\tin\torder\tto\tdemonstrate\tits graphing\tabilities.\tAlso,\tlet\tGraphite\tcollect\tsome\tmetrics\tfrom\tstatsd.\tIt\tis recommended\tthat\tyou\tleave\tthe\tGraphite\tcontainer\tup\tand\trunning\tfor\ta\tfew minutes\tbefore\tyou\ttry\tthis\trecipe.\tAfter,\tsay,\t15\tminutes,\topen\ta\tnew\tbrowser tab\tand\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tat\thttp://192.168.99.100:8100.",
      "content_length": 405,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 400,
      "content": "How\tto\tdo\tit...\n\nThe\tleft-hand\tside\tpane\tof\tthe\tGraphite\tinterface\tis\tusually\tthe\tmetric\tchooser. That's\twhere\tyou\twill\tbe\table\tto\tfind\tall\tthe\tmetrics\tthat\tare\tavailable\tin Graphite.\tThere\tare\tthree\ttabs:\n\nTree Search AutoCompleter\n\nLets\tstart\twith\tthe\tTree\tview\tfirst.\n\nTree\tview\n\nAs\tthe\tname\tindicates,\tyou\tcan\tnavigate\tthrough\tthe\ttree\tnodes\tand\tview\tall\tthe metrics\tavailable\tunder\teach\tpath.\tClicking\ton\ta\tmetric\twill\tplot\tthe\tmetric\ton the\tgraph\ton\tthe\tright-hand\tside\tpane.\tIn\tthe\tfollowing\tscreenshot,\twe\thave picked\tthe\tmetric\tat\tstats.statsd.processing_time:\n\nNow\tlet's\tmove\ton\tto\tthe\tgraph\tmodal.\tThere\tare\tsome\tuseful\tbuttons\tin\tthis modal.\tFirst\toff,\tthere's\tthe\tDate\tRange\tbutton\tthat\tlooks\tlike\ta\tcalendar. Clicking\ton\tthis\tbutton\tgives\tyou\ttwo\tcalendars\twhere\tyou\tcan\tchoose\tthe\tfrom and\tto\tdates\tand\ttimes.\tThis\tway,\tyou\tcan\tfocus\ton\tthe\ttime\twindow\tthat\tyou\tare interested\tin.\tIt\tlooks\tsomething\tlike\tthis:",
      "content_length": 925,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 401,
      "content": "The\tnext\tuseful\tbutton\tin\tthe\tmodal\tis\tthe\tSelect\tRecent\tData\tbutton,\twhich looks\tlike\ta\tclock.\tThis\toption\tlets\tyou\tchoose\tthe\tmost\trecent\ttime\twindow\tin the\tmeasure\tof\tminutes,\thours,\tdays,\tweeks,\tmonths,\tand\tyears.\tIt\tlooks something\tlike\tthis:\n\nThe\tnext\tbutton\tthat\twe\twould\twant\tto\tuse\tmost\tof\tthe\ttime\tis\tthe\tShort\tURL button.\tThis\tbutton\tis\tused\tto\tgenerate\ta\tshort\tURL\tthat\twe\tcan\tuse\tto\trender\tthis graph\tfrom\toutside\tthe\tGraphite\tweb\tinterface.\tIt\tinternally\tuses\tthe\tRender\tAPI,",
      "content_length": 489,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 402,
      "content": "and\tthese\tgraphs\tcan\tbe\tembedded\tin\tany\tweb\tpage.\tSometimes,\tyou\twould want\tto\tmodify\tyour\tgraph's\tappearance,\tlegend,\tand\tstyle.\tFor\tthis\tpurpose,\tyou can\tuse\tthe\tGraph\tOptions\tbutton.\tIt\thas\ttons\tof\toptions\tthat\tyou\tcan\tuse\tto modify\tthe\tway\tyour\tgraph\tlooks:\n\nAnd\tfinally,\twhat\tif\tyou\twant\tto\tembed\tmultiple\tmetrics\ton\tthe\tsame\tgraph? You\thave\tto\tplot\tthem\tall\tin\ta\tsingle\tgraph.\tThat's\twhere\tthe\tGraph\tData\tbutton will\tbe\tuseful.\tIf\tyou\tclick\ton\tthis\tbutton,\tit\twill\topen\tup\ta\tmodal\tfrom\twhere you\tcan\tchoose\tother\tmetrics,\tand\tit\twill\tautomatically\tplot\tthem\tin\tthe underlying\tgraph:\n\nThe\tAuto\tRefresh\tbutton\tis\ta\ttoggle\tbutton\tthat\tyou\tcan\tenable\tto\tautomatically refresh\tthe\tgraph.\tIt\tis\tuseful\tto\tkeep\tthis\toption\tturned\ton,\tbut\tkeep\tin\tmind\tthat",
      "content_length": 754,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 403,
      "content": "it\tmakes\tseveral\trequests\tfrequently,\tand\tit\tmight\tslow\tdown\tyour\tdashboard\tif you\thave\tlot\tof\tgraphs\tthat\thave\tthis\toption\tenabled.\tBy\tdefault,\tif\tthis\toption\tis enabled,\tit\trefreshes\tevery\t60\tseconds.\n\nSearch\n\nNow\tlets\tmove\ton\tto\tthe\tnext\ttab:\tSearch.\tThis\ttab\tmight\t(depending\ton\tthe version)\tbe\tdisabled\tif\tyou\tare\tlogged\tin\tas\troot\tuser.\tSo\tgo\tahead\tand\tlogout.\tAs the\tname\tindicates,\tthe\tSearch\ttab\tis\tused\tto\tsearch\tfor\tany\tmetrics\tunder\tthe given\tpath.\tIf\tyou\tenter\tstats\tin\tthe\tsearch\tbar\tand\thit\tEnter,\tyou\tshould\tsee\tall the\tmatching\tmetric\tnames\tin\tthe\tresults\tsection.\tClicking\ton\ta\tmetric\tfrom\tthe result\tsection\twill\tplot\tthe\tmetric\ton\tthe\tgraph\tin\tthe\tright-side\tpane.\tClicking\ton the\tsame\tmetric\tagain\twill\tremove\tit\tfrom\tthe\tplotted\tgraph.\tTo\tget\tmore\thelp\ton the\tSearch\tfeature,\tjust\tclick\ton\tthe\tHelp\thyperlink.\tThe\tfollowing\tscreenshot shows\tthe\tresults\tfor\tthe\tstats\tkeyword:\n\nAutoCompleter\n\nThe\tAutoCompleter\tmode\tis\tvery\tsimilar\tto\tthe\tSearch\tmode\texcept\tfor\tthe fact\tthat\tthe\tsearch\ttextbox\thas\tautocomplete\tenabled.\tThe\tother\tdifference between\tthese\ttwo\tmodes\tis\tthat\tin\tAutoCompleter\tmode,\tyou\thave\tto\tnavigate to\tthe\tmetric\tin\torder\tto\tplot\tit.\tUse\tTab\tto\tselect\ta\tsuggestion\tin",
      "content_length": 1207,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 404,
      "content": "AutoCompleter\tmode.\tThe\tresults\tpane\tis\tnot\tvery\thelpful\tin\tthis\tmode.\tIt\tis surprising\twhy\tthese\ttwo\tmodes\thave\tbeen\tseparated\tinto\ttwo\tdifferent\ttabs.\tIt would\tmake\ta\tlot\tof\tsense\tto\tmerge\ttheir\tfeatures\tand\tkeep\tthem\ttogether\tin\ta single\ttab.\tThe\tfollowing\tscreenshot\tillustrates\thow\tthe\tAutoCompleter\tmode works:\n\nGraphite\n\nThe\tother\timportant\tpage\tin\tGraphite\tis\tthe\tDashboard\tpage\ton\tthe\ttop\tright. The\tDashboard\tview\tis\tused\tto\tcreate\tmultiple\tgraphs\tand\tcreate\ta\tdashboard. You\tcan\tin\tfact\tsave\tthe\tgraphs\tand\tdashboards\tand\tuse\tthem\tlater.\tAs\twe\thave not\tmapped\tthe\tdocker\tvolume\tthat\thold\tthe\tdashboards,\twe\tmight\tnot\tbe\table\tto recover\tthem\tafter\twe\trecreate\tthe\tcontainer.\tBut\tin\tproduction\tmode,\twhen\tyou are\trunning\tit\telsewhere,\tkeep\tin\tmind\tthat\tthe\tgraphs\tand\tdashboards\tshould\tbe recoverable.\tRefer\tto\tthe\tdocumentation\tof\tthis\tcontainer\tto\tsee\twhich\tvolume holds\twhat\tinformation.\tYou\tcan\tperform\tall\tthe\toperations\tthat\twe\tjust\twent through\ton\tthe\tDashboard\tpage\tas\twell.\tThe\tfollowing\tscreenshot\tshows\thow you\tcan\tcreate\tyour\town\tdashboard:",
      "content_length": 1061,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 405,
      "content": "As\tyou\tcan\tsee,\tthe\ttop\tsection\tis\twhere\tyou\tchoose\tthe\tmetrics,\tand\tthe\tbottom section\tis\twhere\tyou\tcustomize\tyour\tdashboard.\tThere\tare\tseveral\toptions\tthat you\tcan\tperform\ton\tthis\tdashboard.\tI\twill\tleave\tit\tto\tyou\tas\tan\texercise\tto explore\tthe\tDashboard\tview.\tIf\tyou\tare\twondering\twhy\tyou\twould\tneed\tanother tool\tsuch\tas\tGrafana\twhen\tGraphite\talready\thas\tmost\tof\tthe\tgraphing capabilities,\tthe\tanswer\tis-wait\tuntil\tyou\tsee\tthe\tabilities\tof\tGrafana.\tGrafana's only\tfocus\tis\tbuilding\tmonitoring\tsystems.\tWe\twill\tlearn\tmore\tabout\tit\tin\tlater recipes\tof\tthis\tchapter.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\thave\tlearned\thow\tto use\tthe\tGraphite\tweb\tinterface.\tNow\tyou\tknow\thow\tpowerful\tGraphite's\tweb interface\tis.\tIn\tfact,\tGraphite\tlets\tyou\tcreate\tsophisticated\tgraphs,\tsave\tthem,\tand share\tthem.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tbe\texporting\tthe\tmetrics\tthat\twe created\tin\tthe\tgeolocation\tapplication\tover\tto\tGraphite\tand\tplot\tthem\ton\tgraphs using\tGrafana.",
      "content_length": 978,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 406,
      "content": "Exporting\tDropwizard\tmetrics\tover to\tGraphite\n\nIn\tthe\tearly\trecipes\tof\tthis\tchapter,\twe\tlearned\thow\tto\tcreate\tmetrics\tusing Dropwizard's\tCodahale\tlibrary.\tLater,\twe\tlearned\thow\tto\tstart\tGraphite\tusing Docker\tand\tunderstood\tthe\tbasics\tof\tusing\tthe\tGraphite\tinterface.\tIn\tthis\trecipe, we\twill\tbe\texporting\tthe\tmetrics\twe\tcreated\tin\tthe\tgeolocation\tapplication\tover to\tthis\tGraphite\tinstance,\twhich\twill\tthen\tbe\tused\tby\tGrafana\tfor\tgraphing.",
      "content_length": 438,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 407,
      "content": "Getting\tready\n\nAs\twe\twill\tbe\tworking\ton\tthe\tgeolocation\tapplication,\tfollow\tthese\tsteps:\n\n1.\t Open\tthe\tSTS\tIDE. 2.\t Navigate\tto\tthe\tgeolocation\tproject,\tand\tget\tready\tfor\tthe\tnext\tstep. 3.\t Start\tGraphite\tif\tyou\thaven't\tdone\tso.\tYou\tcan\tuse\tthe\tdocker-compose- graphite.yml\tfile\tthat\twe\tcreated\tearlier\tto\tstart\tGraphite.",
      "content_length": 321,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 408,
      "content": "How\tto\tdo\tit...\n\nThe\tgeolocation\tapplication\tcurrently\texposes\ttwo\tmetrics\tusing\tthe\tCodahale MetricRegistry:\tgeolocationWriteRequestCount\tand geolocationLastWriteTime.\tThere\twere\ttwo\tmethods\twe\tused\tto\tview\tthese metrics:\tusing\tSpring's\t/metrics\tendpoint\tand\tusing\tthe\tConsoleReporter.\n\nIn\tthis\trecipe,\twe\twill\tbe\tusing\ta\tdifferent\ttype\tof\treport\tto\treport\tour\tmetrics\tto Graphite.\tCan\tyou\tguess\tthe\tname\tof\tthis\treporter?\tYes,\tyou\tgot\tit\tright.\tIt\tis GraphiteReporter:\n\n1.\t For\tthe\tfirst\tstep,\tlet's\tcomment\tout\tthe\tConsoleReporter\tas\twe\twill\tnot need\tit\tanymore.\tGoing\tforward,\tif\twe\twant\tto\tlook\tat\tour\tmetrics,\twe\tcan always\tuse\tthe\tGraphite\tweb\tinterface\tor\tthe\t/metrics\tendpoint.\tAfter\tyou have\tcommented\tout\tthe\tConsoleReporter,\tgo\tahead\tand\tadd\tthe\tbelow dependency\tto\tyour\tpom.xml\tfile:\t<dependency> <groupId>io.dropwizard.metrics</groupId>\t<artifactId>metrics- graphite</artifactId>\t</dependency>\n\n2.\t Perform\ta\tmaven\tupdate\ton\tthe\tproject\tto\tdownload\tthe\tnew\tdependency. Now\tadd\tthe\tfollowing\tsnippet\tto\tthe\tinit\tmethod\tright\tafter\tthe commented-out\tblock:\tGraphite\tgraphite\t=\tnew\tGraphite(new InetSocketAddress(\"192.168.99.100\",\t2003));\tGraphiteReporter graphiteReporter\t=\tGraphiteReporter.forRegistry(metricRegistry) .prefixedWith(\"com.packt.microservices.geolocation\") .convertRatesTo(TimeUnit.SECONDS) .convertDurationsTo(TimeUnit.MILLISECONDS) .filter(MetricFilter.ALL)\t.build(graphite);\tgraphiteReporter.start(60, TimeUnit.SECONDS);\n\n3.\t There\tare\tsix\tthings\tto\ttalk\tabout\there:\n\nFirstly,\tthe\tport\ton\twhich\twe\tare\tconnecting\tto\tGraphite.\tPort\tnumber 2003\tis\twhere\tthe\tCarbon\tplaintext\tlistener\tis\trunning.\tIf\tyou\twould like\tto\tuse\tthe\tPickle\tprotocol\tmode,\tyou\twill\tbe\tusing\tport\t2004.\n\nNote\n\nTo\tlearn\thow\tto\tuse\tPickle\tmode,\ttake\ta\tlook\tat\tthis\tpage: http://metrics.dropwizard.io/3.1.0/manual/graphite.\n\nThe\tprefixedWith()\tmethod\tsays\tthat\tany\tmetric\tcreated\ton\tthis",
      "content_length": 1885,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 409,
      "content": "MetricRegistry\tshould\tbe\tprefixed\twith\tthe\tlabel com.packt.microservices.geolocation.\tThis\tis\tmainly\tused\tto group\tour\tmetrics\ttogether. We\talready\tknow\twhat\tthe\tconvertRatesTo()\tand convertDurationsTo()\tmethods\tare\tused\tfor. The\tfilter()\tmethod\tis\tused\tto\tfilter\tany\tmetrics\tfrom\tbeing\treported to\tGraphite.\tIn\tour\tcase,\twe\twant\tall\tour\tmetrics\tto\treport\tto\tGraphite, so\twe\thave\tused\tMetricFilter.ALL,\twhich\tinstructs\tCodahale\tto export\tall\tmetrics.\n\nFinally,\tthe\tinteresting\tpart\tis\tour\tpublish\tinterval.\tWe\thave\tset\tthe\tpublish interval\tto\t60\tseconds.\tThe\treason\twe\tmoved\tfrom\t10\tseconds\tto\t60\tis\tthat\twhen you\tare\tbuilding\ta\tproduction-level\tapplication\tand\tyour\tapplication\tis\tscaled, you\twill\tend\tup\tcreating\ttons\tof\tmetrics\tduring\teach\tinterval.\tSetting\tit\tto\ta granularity\tof\t10\tseconds\tmight\tbe\ttoo\tmuch.\tThat\tis\tthe\treason\twe\tare\tgoing with\ta\thigher\tgranularity\tof\t60\tseconds.\tBut\tthis\tis\tcompletely\tleft\tto\tyou\tto choose.\tIt\talso\tdepends\ton\tthe\ttype\tof\tmetric\tyou\tare\treporting.\tIf\tyou\twould\tlike to\tgo\twith\ta\tdifferent\tinterval,\tfeel\tfree\tto\tdo\tso.\n\nNow,\tour\tapplication\tis\tcompletely\tready\tto\tstart\tpublishing\tmetrics\tover\tto Graphite.\tGo\tahead\tand\tstart\tthe\tapplication\tas\ta\tSpring\tBoot\tapplication.\tOnce your\tapplication\thas\tstarted,\tcreate\ttwo\tgeolocations\tusing\tthe\tfollowing\ttwo curl\tcommands\tand\ttry\tto\tget\tthem\tusing\tanother\tcurl\tcommand:\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t41.803488, \"longitude\":\t-88.144040}'\thttp://localhost:8080/geolocation\tcurl\t-H \"Content-Type:\tapplication/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975, \"userId\":\t\"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\tcurl http://localhost:8080/geolocation\n\nAfter\texecuting\tthese\tthree\tCURL\tcommands,\twait\t60\tseconds.\tThe\treason\twe\n\nare\twaiting\t60\tseconds\tis\tbecause\twe\thave\tset\tthe\treporting\tinterval\tto\t60 seconds\tin\tour\tcode.\tSo\tby\tthen,\twe\tcan\texpect\tto\tsee\tsome\tmetrics\ton\tthe Graphite\tweb\tinterface.\n\nOpen\ta\tnew\tbrowser\ttab\tand\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tat\n\nhttp://192.168.99.100:8100.\tYou\tshould\tnow\tsee\ta\tnew\ttree\tgrouping\tfor\tour metrics\tat\tcom.packt.microservices.geolocation.\tThe\tfollowing\tscreenshot shows\thow\tthey\twould\tlook\tlike\tin\tGraphite's\tTree\tview:",
      "content_length": 2343,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 410,
      "content": "Now,\tthere\tare\ttwo\tways\tto\tlook\tat\tyour\tmetrics\tstored\tin\tGraphite.\tThe\tfirst approach\tis\tsomething\twe\tare\talready\tfamiliar\twith:\tthe\tGraphs\tinterface.\tThe Graphs\tinterface\tgives\tyou\ta\tgraph\twith\tall\tthe\tvalues\tplotted\ton\tthe\tgraph.\tBut this\tview\tmight\tnot\tbe\tvery\thelpful\tall\tthe\ttime.\n\nNow\tlet's\tlook\tat\tthe\tnext\tapproach.\tGraphite\thas\ta\tsophisticated\tREST\tAPI.\tIt\n\nhas\ttwo\tAPIs:\tMetrics\tand\tRender.\tThe\tMetrics\tAPI\tis\tused\tto\tsearch\tfor metrics.\tYou\tcan\tuse\tthis\tto\tperhaps\tbuild\ta\tmetrics\tdiscovery\tsystem.\tThe Render\tAPI,\thowever,\tis\twhat\twe\treally\tneed.\tAs\tthe\tname\tindicates,\tit\tis\tused\tto render\tmetric\tvalues\tin\tvarious\tformats,\tsuch\tas\tgraphs,\tCSV,\tJSON,\tPDF,\tand PNG.\n\nNote\n\nTo\tlearn\tmore\tabout\tthe\tREST\tAPIs\tavailable\tin\tGraphite,\tvisit\ttheir documentation\tpage\tat\thttps://graphite-api.readthedocs.io/en/latest/api.html\t.\n\nNow\tlet's\tlook\tat\thow\tto\tuse\tthe\tRender\tAPI\tto\tquery\tour\tmetrics.\tThe\tRender\n\nAPI\trequires\ttwo\tquery\tparameters:\ttarget\tand\tformat.\tThe\ttarget\tparameter indicates\tthe\tpath\tat\twhich\tthe\tmetrics\tvalue\tcan\tbe\tlocated.\tThe\tformat parameter,\thowever,\ttells\twhich\tformat\tyou\twould\tlike\tyour\tmetric\tto\tbe displayed\tin.\tBy\tdefault,\tif\tyou\tdo\tnot\tprovide\tthe\tformat,\tit\trenders\tthe\tdata\tin PNG\tformat.\tBut\tthat's\tnot\twhat\twe\twant;\twe\twant\tto\tsee\tthe\tactual\tdata.\tFor that,\twe\tmight\twant\tto\tuse\tthe\tJSON\tformat.\n\nOpen\ta\tnew\tbrowser\ttab\tand\tpaste\tthis\tURL:\n\nhttp://192.168.99.100:8100/render? target=com.packt.microservices.geolocation.geolocationWriteRequestCount.count&format=json",
      "content_length": 1506,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 411,
      "content": "The\tprevious\tURL\tsays\tthat\twe\tare\trendering\tthe\tmetric\tvalue\tat\n\ncom.packt.microservices.geolocation.geolocationWriteRequestCount.count and\tthe\tformat\tthat\twe\thave\trequested\tis\tJSON.\tSee\thow\twe\thave\tappended .count\tto\tthe\tmetric\tname.\tIf\tyou\twant\tto\tverify,\tlook\tat\thow\tthe\tmetric\tvalue\tis stored\tin\tGraphite\tfrom\tthe\ttree\tview\tof\tthe\tweb\tinterface.\tYou\twill\tsee\tthat\tthe leaf\tnode\tis\tcalled\tcount\tfor\tall\tmetrics\tof\tthe\tcounter\ttype.\tThis\tURL\twould have\tgiven\tyou\tsomething\tlike\tthis:\t[\t{\t\"target\": \"com.packt.microservices.geolocation.geolocationWriteRequestCount.count\", \"datapoints\":\t[\t[\tnull,\t1481917380\t],\t[\tnull,\t1481917440\t],\t.\t.\t[\t2,\t1482003720 ]\t]\t}\t]\n\nYou\twill\tnotice\tthat\tthere\tare\tseveral\tdata\tpoints.\tWe\tare\tparticularly\n\ninterested\tin\tthe\tmost\trecent\tdata\tpoint,\twhich\twill\tbe\tusually\tpopulated\tas\tthe last\tdata\tpoint.\tIf\tyou\tscroll\tall\tthe\tway\tdown\tin\tyour\tbrowser,\tyou\twill\tsee\tthat the\tlast\tdata\tpoint\tis\tpopulated\twith\tthe\tvalue\t2,\tindicating\tthat\twe\thave\treceived two\twrite\trequests\tfor\tthe\tgeolocation\tAPI\tso\tfar.\tThough\tit\tis\tdifficult\tto\twork with\tsuch\ta\thuge\tJSON\tfile,\tit\tis\tvery\tuseful\twhen\tyou\tare\tdebugging.\tIn\tfact, you\tcan\tuse\tthe\tfrom\tand\tuntil\tparameters\tto\tspecify\ta\ttime\trange\tto\tquery\tjust the\tdata\tpoints\tthat\twere\trecorded\tduring\tthat\ttime\trange.\n\nThe\tRender\tAPI\tis\tmuch\tmore\tsophisticated\twith\ta\tlot\tof\tquery\tparameters, such\tas\tbgColor\tand\tareaMode.\tTake\ta\tlook\tat\tGraphite's\tdocumentation\tto\tlearn more\tabout\tthe\tAPI\tbefore\tyou\tstart\tusing\tit.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tlearned\thow\tto\tuse\tGraphite\tto\tstore metrics\tand\talso\tlearned\tabout\tthe\tRender\tAPI\tthat\tGraphite\toffers\tto\tview metrics.",
      "content_length": 1650,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 412,
      "content": "Exporting\tSpring\tBoot\tActuator metrics\tover\tto\tGraphite\n\nIn\tthe\tprevious\trecipe\twe\tlearned\thow\tto\texport\tthe\tmetrics\twe\tcreated\tusing Codahale\tover\tto\tGraphite.\tIn\tthis\trecipe,\twe\twill\tsee\thow\twe\tcan\texpose\tsome metrics\tSpring\tBoot\toffers.\tUnfortunately,\tat\tthis\tmoment,\tthe\tMetricRegistry does\tnot\texpose\tall\tthe\tmetrics\tthat\tSpring\tBoot\toffers.\tOnly\tfew\tof\tthem\tare created\tusing\tCodahale.\tIf\tyou\ttake\ta\tlook\tat\tthe\tmetrics\tthat\tare\tavailable\tin /metrics,\tmost\tof\tthem\tare\tJVM\trelated.\tSo\tin\tthis\trecipe,\twe\twill\tfind\tanother way\tto\texpose\tthe\tJVM\tmetrics\tvia\tCodahale.",
      "content_length": 571,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 413,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tadding\ta\tMaven\tdependency\tand\tsome\tJava\tcode\tto\tthe geolocation\tproject.\tSo\topen\tup\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe\tgeolocation project.\tMake\tsure\tyour\tGraphite\tinstance\tis\tup\tand\trunning.\tIf\tnot,\tstart\tit\tusing the\tdocker-compose-graphite.yml\tfile\twe\tcreated.",
      "content_length": 303,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 414,
      "content": "How\tto\tdo\tit... 1.\t In\tthis\trecipe,\twe\tare\tgoing\tto\texpose\tsome\tJVM\tmetrics\tusing\tCodahale. This\twill\tbe\texported\tto\tGraphite\tautomatically\tas\twe\thave\tconfigured\tthe GraphiteReporter\tto\texpose\tmetrics\tevery\t60\tseconds.\tAdd\tthe\tfollowing Maven\tdependency\tto\tthe\tpom.xml\tfile:\n\n<dependency> \t\t<groupId>io.dropwizard.metrics</groupId> \t\t<artifactId>metrics-jvm</artifactId> \t\t<version>3.1.2</version> </dependency>\n\n2.\t Note\tthat\twe\thave\tadded\ta\tversion\tto\tthis\tdependency.\tThat\tis\tbecause\tthis is\tnot\tthe\tdefault\tin\tthe\tparent\tPOM,\tand\twe\twill\thave\tto\tuse\tour\town version\tin\tthe\tchild\tPOM.\tNow,\tadd\tthe\tfollowing\tsnippet\tas\tthe\tlast\tline\tof the\tinit()\tmethod\tin\tthe\tMetricSystem.java\tbean: metricRegistry.registerAll(new\tMetricSet()\t{ \t\t@Override \t\tpublic\tMap<String,\tMetric>\tgetMetrics()\t{\n\nMap<String,\tMetric>\tmetrics\t=\tnew\tHashMap<>(); \t\t\t\tmetrics.put(\"geolocationMemoryUsage\",\tnew MemoryUsageGaugeSet()); \t\t\t\tmetrics.put(\"geolocationClassLoading\",\tnew ClassLoadingGaugeSet()); \t\t\t\tmetrics.put(\"geolocationGarbageCollector\",\tnew GarbageCollectorMetricSet()); \t\t\t\treturn\tmetrics; \t\t} });\n\nThe\tprevious\tsnippet\tillustrates\thow\tyou\tcan\tregister\tmetric\tsets\tto\tthe MetricRegistry.\tAll\tthe\tthree\tsets-MemoryUsageGaugeSet, ClassLoadingGaugeSet\tand\tGarbageCollectorMetricSet\tcome\twith\tthe metrics-jvm\tdependency.\tThere\tare\talso\tother\tsets\tlike BufferPoolMericSet,\tCachedThreadStatesGaugeSet, ThreadStateGaugeSet\tand\tso\ton.\tYou\tcan\ttry\tthem\tout\tone\tby\tone\tas\tan exercise.\n\n3.\t Now\tlet's\ttest\tit\tout.\tStart\tthe\tapplication\tas\ta\tSpring\tBoot\tapplication,\topen a\tnew\tbrowser\ttab,\tand\tnavigate\tto\thttp://localhost:8080/metrics.\tThis",
      "content_length": 1620,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 415,
      "content": "time,\tyou\tshould\tsee\ta\tbunch\tof\tJVM-related\tmetrics\tthat\tstart\twith\tthe keyword\tgeolocation.\tIf\tyou\tnavigate\tto\tthe\tGraphite\tweb\tinterface\tafter 60\tseconds,\tyou\twill\tsee\tthose\tmetrics\tlisted\tunder\tthe\ttree.\n\nThe\tfollowing\tscreenshot\tillustrates\thow\tit\twill\tlook\tlike\tin\tthe\tTree\tview of\tthe\tGraphite\tweb\tinterface:\n\nAs\tyou\tcan\tsee,\twe\tnow\thave\tthree\tnew\tgroupings:\tgeolocationClassLoading, geolocationGargbageCollector,\tand\tgeolocationMemoryUsage.\tIt\tis recommended\tthat\tyou\ttake\tsome\ttime\tto\texplore\tthese\tthree\tmetric\tgroups\tand the\tkind\tof\tmetrics\tthey\texpose.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tWe\tlearned\thow\tto\tconfigure\tand\texpose JVM\tmetrics\tusing\tCodahale\tover\tto\tGraphite.\tIn\tthe\tnext\tfew\trecipes,\twe\twill learn\thow\tto\tuse\tthese\tmetrics\tto\tcreate\tvaluable\tgraphs\tusing\tGrafana.",
      "content_length": 795,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 416,
      "content": "Setting\tup\tGrafana\tusing\tDocker\n\nSo\tfar\tin\tthis\tchapter,\twe\thave\tlearned\tthe\tbasics\tof\tmonitoring.\tWe\tlaid\tout\tthe foundation\tof\tour\tmonitoring\tsystem:\tour\tmetrics.\tWe\tlearned\thow\tto\tcreate metrics\tusing\tDropwizard's\tCodahale\tlibrary.\tWe\tthen\tspun\toff\ta\tbrand-new Graphite\tinstance.\tLater,\twe\texported\tthe\tmetrics\tthat\twe\tcreated\tover\tto Graphite.\tIn\tthe\trest\tof\tthe\trecipes\tof\tthis\tchapter,\twe\twill\tbe\tlearning\tmore about\ta\ttool\tcalled\tGrafana\tand\thow\tit\tcan\tbe\tused\tin\tmonitoring\tour microservices.",
      "content_length": 500,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 417,
      "content": "Getting\tready\n\nInstead\tof\trunning\tGrafana\ton\tits\town\tusing\tthe\tdocker\trun\tcommand,\twe\twill be\tadding\tit\tto\tthe\tdocker-compose\tYAML\tfile\tthat\tholds\tGraphite.\tThe\treason we\tare\tdoing\tthis\tis\tbecause\tthey\tare\tclosely\trelated\tto\teach\tother\tthough\tthey need\tnot\tbe\tlinked.\tBefore\twe\tjump\tin,\tlet's\ttake\tsome\ttime\tto\tunderstand\twhat Grafana\tis.\tGrafana\tis\tan\topen\tsource\ttool\tfor\tmetrics\tvisualization.\tThe\tGrafana interface\tis\tsophisticated\tenough\tthat\tit\tbe\tused\tto\tcreate\tseveral\ttypes\tof\tgraphs. Very\trecently,\tGrafana\tcame\tup\twith\ttheir\tnotification\tsystem,\twhere\tyou\twill\tbe alerted\twhen\ta\tcertain\tmetric\texceeds\tits\tthreshold.\tThe\tbeauty\tof\tthis\tfeature\tis that\tit\tcan\talert\tyou\tnot\tjust\tby\te-mail\tbut\talso\ton\tSlack,\tPagerDuty,\tand webhooks.\tNow\tlet's\topen\tup\tthe\tSTS\tIDE.",
      "content_length": 773,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 418,
      "content": "How\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tsetup\tyour\tfirst\tGrafana\tinstance using\tDocker.\n\n1.\t Open\tup\tthe\tYAML\tfile\tthat\talready\thas\tGraphite:\tdocker-compose- graphite.yml.\tAdd\tthe\tfollowing\tsnippet\tto\tit:\n\ngrafana: \t\t\t\timage:\tgrafana/grafana \t\t\t\tports: \t\t\t\t\t\t-\t\"3000:3000\"\n\nThat's\tall\tyou\tneed\tto\tstart\tGrafana.\tPort\t3000\tis\twhere\tthe\tGrafana\tweb interface\twill\tbe\trunning.\tWe\thave\tmapped\tthis\tport\tto\tport\t3000\tof\tthe\thost machine.\tAs\tyou\tcan\tsee,\tthere\tare\tno\tlinks\tto\tthe\tGraphite\tcontainer.\tThe only\treason\twe\tare\tkeeping\tthese\ttwo\tcontainers\ttogether\tis\tbecause\tthey are\tboth\tused\tto\tbuild\tour\tmonitoring\tsystem.\n\n2.\t Now\tlets\tstop\tGraphite\tif\tit\tis\talready\trunning.\tOpen\ta\tnew\tterminal session,\tand\tstart\tGrafana\tand\tGraphite\ttogether\tusing\tthe\tfollowing command: docker-compose\t-f\tdocker-compose-graphite.yml\tup\n\n3.\t The\tlog\tmessages\twill\tnot\tbe\tvery\thelpful\tto\tidentify\twhether\tGrafana\thas started\tor\tnot.\tHowever,\tyou\twill\tknow\tthat\tGrafana\thas\tstarted\twhen\tyour log\tmessages\tstop\ttailing.\tYou\twill\tsee\tsomething\tlike\tthis:\n\n4.\t Now\tthat\tyour\tGrafana\tand\tGraphite\tinstances\tare\tup\tand\trunning,\tlet's",
      "content_length": 1133,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 419,
      "content": "open\tthe\tGrafana\tweb\tinterface.\tOpen\ta\tnew\tbrowser\tsession\tand\tenter\tthis URL\tto\topen\tGrafana:\thttp://192.168.99.100:3000.\n\n5.\t You\twill\tbe\ttaken\tto\tthe\tlogin\tpage.\tGrafana\thas\ta\tvery\tgood\tlogin mechanism.\tIt\teven\thas\tintegration\twith\tLDAP:\n\nBy\tdefault,\tthe\tusername\tand\tpassword\tare\tboth\tset\tto\tadmin.\n\n6.\t So\tenter\tthe\tcredentials\ton\tthe\tlogin\tpage\tand\thit\tLog\tin.\tOn\tthe\thome page,\tyou\twill\tsee\tthat\twe\tdo\tnot\thave\tany\tdashboards,\tapps,\tpanels,\tor\tdata sources\tcreated:",
      "content_length": 472,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 420,
      "content": "7.\t The\ttop\tnavigation\tpane\tof\tGrafana\tis\tvery\tuseful.\tIt\thas\tpretty\tmuch\tall\tthe quick\taction\tbuttons\tyou\twill\tneed\twhile\tviewing\tyour\tdashboards:\n\n8.\t The\tfirst\tbutton,\twhich\thas\tthe\tGrafana\ticon,\tis\tthe\tmain\tmenu.\tClicking\ton that\twill\topen\tlinks\tto\tpretty\tmuch\tall\tthe\toptions\tand\tconfigurations.",
      "content_length": 300,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 421,
      "content": "The\tHome\tbutton\tacts\tas\ta\tquick-action\tbar\tto\tnavigate\tto\tall\tthe Dashboards\tyou\thave\tin\tthis\tinstance\tof\tGrafana.\n\n9.\t The\tnext\tuseful\tsection\tin\tthe\ttop\tnavigation\tbar\tis\tthe\tRefresh\tRange section.\tClicking\ton\tthe\tdefault\trefresh\trange,\tLast\t6\thours,\twill\topen\ta section\twhere\tyou\tcan\tconfigure\tthe\ttime\trange\tas\twell\tas\tthe\trefresh interval.\tThis\tis\ta\tvery\tsophisticated\tsection.\n\nThat's\tpretty\tmuch\ta\tvery\thigh-level\toverview\tof\tthe\tGrafana\tinterface.\tThere are\tstill\tlots\tof\tfeatures\tthat\tGrafana\toffers.\tWe\twill\tlook\tat\tthem\tin\tlater\trecipes. With\tthat,\twe've\tcome\tto\tthe\tend\tof\tthis\trecipe.",
      "content_length": 597,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 422,
      "content": "Configuring\tGrafana\tto\tuse\tGraphite\n\nWe\tnow\thave\ta\tworking\tversion\tof\tGraphite\tand\tGrafana\tconfigured\tusing\tthe docker-compose\tYAML\tfile.\tIn\tthis\trecipe,\twe\twill\tbe\tconfiguring\tGrafana\tto use\tthe\tGraphite\tinstance\twe\tare\tusing\tto\texport\tour\tgeolocation\tmetrics\tto. When\twe\thave\tconfigured\tGrafana\tto\tuse\tthe\tGraphite\tinstance,\twe\twill\tsoon\tbe able\tto\tutilize\tthe\tgeolocation\tmetrics\tto\tcreate\tdashboards\ton\tGrafana.",
      "content_length": 415,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 423,
      "content": "Getting\tready\n\nBefore\twe\tjump\tinto\tthe\trecipe,\tlet's\tunderstand\ta\tfew\tconcepts\tand terminologies\tused\tin\tGrafana.\tYou\twill\tneed\tto\tunderstand\tfour\tentities:\n\nData\tsources:\tData\tsources\tare\tentities\tthat\thold\tthe\tdata\trequired\tto\tplot your\tgraphs. Panels:\tPanels\tare\tindividual\tvisualizations\tthat\twill\tconnect\tto\ta\tdata source,\tquery\ta\tcertain\tdata\tset,\tand\tplot\tthem\ton\ta\tgraph,\ttable,\tsingle panel\tstat,\tor\ttext. Rows:\tRows\tare\tgroup\tof\tpanels\tthat\tconstitute\ta\trow\ton\tthe\tdashboard. Dashboards:\tOf\tcourse,\twe\tall\tknow\twhat\ta\tdashboard\tis.\tThe\tdashboard comprises\tseveral\trows\tof\tpanels.",
      "content_length": 589,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 424,
      "content": "How\tto\tdo\tit...\n\nNow\tguess\twhat\twe\tneed\tto\tcreate\tin\torder\tto\tconfigure\tGrafana\tto\tuse\tthe Graphite\tinstance\tthat\twe\thave.\tYes,\tyou\tare\tright;\twe\thave\tto\tcreate\ta\tdata source.\tBefore\tthat,\tmake\tsure\tyou\thave\tboth\tGrafana\tand\tGraphite\trunning.\tIf they're\tnot,\tstart\tthem\tusing\tthe\tdocker-compose\tYAML\tfile:\n\n1.\t Let's\tstart\tby\tclicking\ton\tthe\tmain\tmenu\tbutton\tat\tthe\ttop\tleft\tof\tthe\tGrafana page.\tThen,\tchoose\tData\tSources\tfrom\tthe\tdropdown.\tOn\tthe\tnext\tscreen, click\ton\tthe\tAdd\tdata\tsource\tbutton\tand\tenter\tthe\tfollowing\tvalues\tin\tthe form: Name:\tgraphite Default:\tTrue\t(checked) Type:\tGraphite Url:\thttp://192.168.99.100:8100 Access:\tdirect\n\nMake\tsure\tneither\tthe\tBasic\tAuth\tnor\tthe\tWith\tCredentials\tcheckbox\tis",
      "content_length": 712,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 425,
      "content": "checked:\n\nAfter\tentering\tthe\tprevious\tvalues\tin\tthe\tform,\thit\tthe\tAdd\tbutton.\tRight\tafter\n\nyou\thit\tAdd,\tGrafana\twill\ttry\tto\tping\tGraphite\twith\tthe\tconnection\tparameters that\twe\tprovided\there.\tIf\tyour\tconnection\tis\tsuccessful,\tyou\twill\treceive\ta success\tmessage\ton\tthe\tsame\tscreen:\n\nIf\tfor\tsome\treason\tGrafana\tis\tnot\table\tto\tconnect\tto\tGraphite,\tyou\twill\treceive\tan",
      "content_length": 364,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 426,
      "content": "If\tfor\tsome\treason\tGrafana\tis\tnot\table\tto\tconnect\tto\tGraphite,\tyou\twill\treceive\tan error\tmessage\twith\tdetails.\tMost\tof\tthe\ttimes,\tthe\terror\tcould\teither\tbe\tthat Graphite\tis\tnot\trunning\tor\tyou\thave\tnot\tmapped\tthe\tGraphite\tports,\tor\tthat\tyou are\tbehind\ta\tproxy.\tMake\tsure\tyou've\tset\tup\teverything\tright\tand\ttry\tagain.\n\nNow\tgo\tback\tto\tthe\tData\tSources\tpage,\tand\tyou\tshould\tsee\tthe\tnewly\tcreated\n\nGraphite\tdata\tsource:\n\nHere,\tyou\twill\thave\ttwo\ttypes\tof\tviews:\tthe\tgrid\tview\tand\tthe\tlist\tview.\tIn older\tversions\tof\tGrafana,\tthe\tgrid\tview\tis\tthe\tdefault\tfor\tsome\treason.\tHowever, the\tlist\tview\tis\ta\tbetter\tview\tas\tit\tshows\tthe\tcomplete\tURL.\tThe\tlist\tview\tlooks something\tlike\tthis:\n\nThis\tclarifies\tthat\tour\tdata\tsource\twas\tadded\tsuccessfully;\tin\tother\twords, Grafana\thas\tbeen\tconfigured\tto\tuse\tour\tGraphite\tinstance.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\tsimple\trecipe.",
      "content_length": 860,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 427,
      "content": "Configuring\tGrafana\tdashboards\tto view\tmetrics\n\nSo\tfar,\twe've\tlearned\thow\tto\tuse\tGraphite\tand\tGrafana.\tIn\tthis\trecipe,\twe\twill learn\thow\tto\tcreate\tdashboards\tand\tpanels\tusing\tGrafana.\tIdeally,\tGrafana dashboards\twill\tbe\tdisplayed\ton\ta\tbig\tscreen\tin\ta\tspace\twhere\tdevelopers\t(or concerned\tpeople)\tcan\tsee\tthem\tso\tthat\tany\todd\tbehavior\tin\tthe\tgraphs\twill\tbe clearly\tvisible\tto\tthe\tdevelopers.",
      "content_length": 390,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 428,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tutilizing\ttwo\tmetrics\tfrom\tthe\tgeolocation\tJVM\tand the\ttwo\tmetrics\tthat\twe\tcreated\tusing\tCodahale.\tThese\tfour\tmetrics\twill\tbe plotted\ton\tgraphs\tin\tthe\tdashboard.\n\n1.\t First,\tmake\tsure\tGraphite\tand\tGrafana\tare\tup\tand\trunning.\tIf\tthey're\tnot, start\tthem\tusing\tthe\tdocker-compose\tYAML\tfile.\n\n2.\t Next,\tmake\tsure\tyour\tgeolocation\tapplication\tis\tup\tand\trunning.\tIf\tit's\tnot, start\tit\tfrom\tyour\tSTS\tIDE\tas\ta\tSpring\tBoot\tapplication.",
      "content_length": 468,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 429,
      "content": "How\tto\tdo\tit... 1.\t In\torder\tto\tgenerate\tsome\tmetrics,\texecute\tthe\tfollowing\tcurl\tcommands\tto create\ttwo\tgeolocations:\tcurl\t-H\t\"Content-Type:\tapplication/json\"\t-X POST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\":\t\"f1196aac-470e-11e6- beb8-9e71128cae77\",\t\"latitude\":\t41.803488,\t\"longitude\":\t-88.144040}' http://localhost:8080/geolocation\tcurl\t-H\t\"Content-Type: application/json\"\t-X\tPOST\t-d\t'{\"timestamp\":\t1468203975,\t\"userId\": \"f1196aac-470e-11e6-beb8-9e71128cae77\",\t\"latitude\":\t9.568012, \"longitude\":\t77.962444}'\thttp://localhost:8080/geolocation\tcurl http://localhost:8080/geolocation\n\n2.\t Now,\tin\torder\tto\tgenerate\tsome\tmetrics,\tlet\tthe\tgeolocation\tmicroservice, Graphite,\tand\tGrafana\trun\tfor\ta\tfew\tminutes.\tThe\treason\twe\tare\tdoing\tthis is\tto\tpublish\tsome\tmetrics\tto\tGraphite.\tAfter,\tsay,\t15\tminutes,\tgo\tto\ta\tnew browser\tsession\tand\tnavigate\tto\tthe\tGrafana\tURL\tat http://192.168.99.100:3000.\n\n3.\t In\tGrafana,\tchange\tthe\trefresh\twindow\tfrom\t6\thours\tto\t15\tminutes.\tClick on\tHome\tand\tthen\tselect\tthe\tCreate\tNew\tbutton.\tIn\tthe\tnext\tsection,\tyou will\tsee\tan\tempty\trow\twith\tsome\tpanel\toptions,\tsuch\tas\tGraphs, Singlestat,\tTable,\tText,\tAlert\tList,\tDashboard\tlist,\tand\tPlugin\tlist:\n\nBefore\twe\tadd\tany\tnew\tpanels,\tlet's\tfirst\tname\tour\tdashboard.\tClick\ton\tthe\n\ngear\tbutton\tin\tthe\ttop\tnavigation\tpane\tand\tselect\tSettings.\tIn\tthe\tSettings section,\tenter\tthe\tvalue\tof\tName\tas\tGeolocation\tMicroservice,\tand\tclick\ton the\tSave\tbutton\tin\tthe\ttop\tnavigation\tbar.\n\nNow\tselect\tGraph\tfrom\tthe\tchoice\tof\tpanels.\tIf\tyour\trow\twas\talready created,\thover\tover\tthe\tthree\tdots\ton\tthe\tleft\tside\tof\tthe\trow\tand\tselect\tAdd",
      "content_length": 1588,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 430,
      "content": "Panel\tand\tthen\tchoose\tGraph.\tYou\twill\tsee\tan\tempty\tgraph\twith\tno\tdata.\tIn order\tto\tedit\tthis\tgraph,\tclick\ton\tthe\tgraph\tname\tPanel\tTitle\tand\tselect\tEdit. In\tthe\tEdit\tpane,\tnavigate\tto\tthe\tMetrics\ttab.\tThen,\tselect\tthe\tmetric\tvalue com.packt.microservices.geolocation.geolocationMemoryUsage.heap.used After\tyou\thave\tselected\tthe\tmetric,\tyou\twill\tsee\tthat\tthe\tgraph\tis\tplotted\twith some\tmetrics.\tNow\tlet's\tduplicate\tthis\tmetric\tand\tadd\tanother\tmetric\tto\tthe\tsame graph.\tClick\ton\tthe\thamburger\tmenu\tbutton\tand\tselect\tDuplicate:\n\nThis\ttime,\tuse\tthe\tmetric\n\ncom.packt.microservice.geolocation.geolocationMemoryUsage.heap.commited Once\tyou\thave\tadded\tboth\tthe\tmetrics,\tyou\twill\tsee\tthat\tthere\tare\ttwo\tlines,\tone for\teach\tmetric:\n\nWe\tnow\thave\tto\tchange\tthe\tunit\tof\tour\tLeft\tY\taxis\tto\tbytes.\tGo\tto\tthe\tAxes\ttab\n\nand\tselect\tdata\t(Metric)\t/\tbytes\tas\tthe\tUnit:",
      "content_length": 848,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 431,
      "content": "Before\tyou\tsave\tthis\tpanel,\tlet's\tgive\tit\ta\tnice\theader.\tGo\tto\tthe\tGeneral section\tand\tchange\tthe\tTitle\tto\tJVM\tHeap.\tIn\torder\tto\tsave\tthis\tpanel,\thit\tthe small\tx\tin\tthe\ttop-right\tsection\tof\tthis\tpane:\n\nNow\tlet's\tcreate\tpanels\tfor\tthe\tother\ttwo\tmetrics,\tgeolocationLastWriteTime\n\nand\tgeolocationWriteRequestCount.\tHow\tabout\tcreating\ta\tnew\trow\tfor\tthese two\tpanels?\tClick\ton\tthe\tAdd\tRow\tbutton\tat\tthe\tbottom\tof\tthe\texisting\trow. Now\tadd\ta\tnew\tgraph\tand\tconfigure\tit\twith\tthe\tname geolocationWriteRequestCount\tand\tmetric com.microservices.geolocation.geolocationWriteRequestCount.count. Let's\tadd\ta\tnew\tpanel\tfor\tgeolocationLastWriteTime.\tHover\tover\tthe\tthree\tdots on\tthe\tleft-hand\tside\tof\tthis\tpanel\tand\tchoose\tAdd\tPanel:",
      "content_length": 719,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 432,
      "content": "Configure\tthe\tsecond\tpanel\tin\tthis\trow\twith\tthe\tname\n\ngeolocationLastWriteTime\tand\tmetric\tvalue com.microservices.geolocation.geolocationLastWriteTime.\tMake\tsure\tyou change\tthe\tunit\tfor\tthe\tLeft\tY\taxis\tto\tnone/none.\tAfter\tyou\thave\tconfigured\tboth the\tpanels,\tclose\tthe\tconfiguration\tpane\tby\thitting\tthe\tx\tbutton.\n\nFinally,\tsave\tthe\tdashboard\tby\thitting\tthe\tSave\tbutton\tfrom\tthe\ttop\tnavigation\n\nbar.\tYour\tfinal\tdashboard\twill\tlook\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tI\thave\tadded\tsome\ttitles\tto\tthe\tpanels\tin\tthe\tsecond\trow.\tThat's it!\tWe\tnow\thave\tour\tfirst\tmonitoring\tplatform\tfor\tour\tmicroservice.\tThe previous\tillustration\tmight\tbe\tpretty\tsimple,\tbut\tthe\tcapabilities\tof\tGrafana\tand Graphite\tare\tawesome\tif\twe\tuse\tit\tin\tthe\tright\tway.\tWe\tdid\tnot\tgo\tin\tdetail\tinto",
      "content_length": 767,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 433,
      "content": "Graphite\tare\tawesome\tif\twe\tuse\tit\tin\tthe\tright\tway.\tWe\tdid\tnot\tgo\tin\tdetail\tinto either\tGraphite\tor\tGrafana.\tBut\tI'll\tleave\tthat\tto\tyou\tas\tan\texercise\tas\tour\tgoal was\tprimarily\tto\tdemonstrate\tthe\tabilities\tof\tthese\ttools.\tGrafana\tin\tfact\tgets more\tinteresting\twith\tthe\tuse\tof\talerts.\tI\tstrongly\trecommend\tyou\ttry\tthem before\tyou\tstart\tusing\tit\tin\tyour\tproduction\tenvironment.\tGood\tluck\tmonitoring!",
      "content_length": 397,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 434,
      "content": "Chapter\t7.\tBuilding\tAsynchronous Streaming\tSystems\twith\tKafka\tand Spark\n\nIn\tthis\tchapter,\tyou\twill\tlearn\tthe\tfollowing\trecipes:\n\nSetting\tup\tKafka\tusing\tDocker Creating\tKafka\ttopics\tto\tstream\tdata Writing\ta\tstreaming\tprogram\tusing\tKafka\tStreams Improving\tthe\tperformance\tof\tthe\tKafka\tStreams\tprogram Writing\ta\tstreaming\tprogram\tusing\tApache\tSpark Improving\tthe\tperformance\tof\tthe\tSpark\tjob Aggregating\tlogs\tinto\tKafka\tusing\tLog4J Integrating\tKafka\twith\tlog\tmanagement\tsystems",
      "content_length": 474,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 435,
      "content": "Introduction\n\nStreaming\thas\tbeen\tpicking\tup\ttraction\tlately.\tIt\tis\tone\tway\tof\tprocessing\tyour data.\tIn\tfact,\tthere\tare\ttwo\tmodes\tin\twhich\tyour\tdata\tprocessing\tapplication\tcan operate:\tbatching\tand\tstreaming.\tIn\tbatching,\tyou\twork\ton\tbatches\tof\tdatasets\tat frequent\tintervals.\tHowever,\tin\tstreaming,\tyou\tprocess\tdata\tas\tit\tgets\tstreamed. This\tmode\thas\talways\tbeen\ta\tchallenge.\tAchieving\tthis\ttype\tof\tstreaming behavior\twill\topen\tup\ta\tlot\tof\tdifferent\topportunities.\n\nYou\tcould\tmake\tthings\thappen\tquickly.\tFor\texample,\ta\tbanking\tapplication\tcan send\tyou\trelevant\tcoupons\tbased\ton\tyour\tspending\tactivity.\tOr\ta\tshopping application\tcan\trecommend\tproducts\tbased\ton\tyour\tviewing\tactivity.\tAnd\tall\tthis will\thappen\tright\taway\tinstead\tof\twaiting\tuntil\tthe\tmiddle\tof\tthe\tnight\tfor\ta batch\tjob\tto\trun.\tStreaming\thas\tbecome\ta\tcritical\tpart\tof\tmany\tbusinesses\tthese days.\tThe\tpast\tcouple\tof\tyears\thave\tseen\ta\ttremendous\timprovement\tin streaming\ttechnologies.\tFrameworks\tsuch\tas\tApex,\tStorm,\tSpark,\tFlink,\tKafka Streams,\tand\tSamza,\tto\tname\ta\tfew,\tare\tsome\tpopular\tstreaming\tframeworks being\tused\ta\tlot\tthese\tdays.\tA\tstreaming\tframework\twill\tmake\tsense\tonly\twhen you\thave\ta\tsupporting\tmessaging\tsystem.\tKafka,\tRabbitMQ,\tand\tZero\tMQ,\tto name\ta\tfew,\tare\texamples\tof\tpopular\tmessaging\tsystems.\tIn\tthis\tchapter,\twe\twill focus\tmore\ton\tSpark\tand\tKafka.",
      "content_length": 1332,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 436,
      "content": "Setting\tup\tKafka\tusing\tDocker\n\nIn\torder\tto\tdemonstrate\tstreaming,\twe\tfirst\trequire\ta\tstreaming\tendpoint.\tA streaming\tendpoint\tcould\tbe\ta\tTCP\tsocket,\tmessaging\tdestination,\tand\tso\ton.\tIn this\tchapter,\twe\twill\tuse\tKafka\theavily\tto\tdemonstrate\tits\tstreaming\tabilities.\tIn this\trecipe,\twe\twill\tlearn\thow\tto\tset\tup\tKafka\tusing\tDocker\tCompose.\tBefore\twe jump\tinto\tthe\trecipe\tand\tstart\torchestrating\ta\tKafka\tinstance,\tlet's\tfirst\ttake\tsome time\tto\tunderstand\thow\tKafka\tworks.",
      "content_length": 468,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 437,
      "content": "Kafka\n\nAccording\tto\tKafka's\tdocumentation,\tit\tis\ta\tdistributed\tstreaming\tplatform.\tIt\tis distributed\tbecause\tit\thas\tclustering\tabilities\tand\tis\tfault\ttolerant.\tAchieving\tfault tolerance\tis\tnot\tvery\teasy.\tBut\tKafka's\tarchitecture\tmakes\tit\tfault\ttolerant\tand,\tat the\tsame\ttime,\tsimple\tto\twork\twith\tand\tunderstand.\tSimplicity\tis\tone\tof\tthe reasons\tKafka\tis\tbeing\tadopted\tby\tlot\tof\torganizations.\tAt\tthe\tsame\ttime,\tit\tis very\tpowerful.\tIt\tcan\thandle\ta\thuge\tamount\tof\tdata\tat\tonce.\tKafka\tutilizes Zookeeper\tfor\tmost\tof\tits\tclustering\tmechanism.\tIt\tis\ta\tstreaming\tplatform because\tit\thas\tthe\tability\tto\twork\ton\tstreams\tof\tdatasets\tas\tthey\tcome\tthrough the\tdestinations.\n\nIn\tthe\tsimplest\tterms,\tKafka\tis\ta\tpowerful\tpub-sub\tmessaging\tsystem.\tIf\tyou come\tfrom\ta\tJava\tbackground\tand\thave\texperience\tworking\twith\tJMS\t(Java Message\tService),\tthen\tyou\tmight\thave\talready\tguessed\twhat\tKafka\tcould\tbe.\n\nThere\tare\ttwo\ttypes\tof\tcommunication\tmechanisms\tpossible\tin\tany\tmessaging system:\n\nPoint-to-point Pub-sub\n\nPoint-to-point\tmechanism\n\nPoint-to-point\tis\twhere\ta\tmessage\tproducer\tsends\tmessages\tto\ta\tqueue,\twhich\tis then\tpicked\tup\tby\ta\tmessage\tconsumer.\tThere\tcan\tbe\tany\tnumber\tof\tmessage consumers\tlistening\ton\tthe\tqueue;\thowever,\tonly\tone\tconsumer\tcan\tconsume each\tmessage.\n\nPub-sub\tmechanism\n\nIn\ta\tpub-sub\tmechanism,\tproducers\tpublish\tmessages\tto\ta\ttopic,\twhich\tis\tthen broadcasted\tto\tall\tthe\tconsumers\tsubscribed\tto\tthe\ttopic.\tSo\teach\tconsumer\tin\ta pub-sub\tmechanism\twill\treceive\tone\tcopy\tof\tall\tthe\tmessages.\tKafka\toffers\tboth of\tthese\tmodes\twith\tthe\thelp\tof\ttopics.",
      "content_length": 1555,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 438,
      "content": "Kafka\tterminology\n\nThere\tare\tfive\tterminologies\tyou\thave\tto\tknow\tbefore\tyou\tstart\tworking\twith Kafka:\n\nBrokers Topics Partitions Producers Consumers\n\nBrokers\n\nBrokers\tare\tnothing\tbut\tKafka\tservers\tthat\twill\thost\tyour\ttopics\tand\tlogs\tinside your\ttopics.\n\nTopics\n\nTopics\tare\tdestinations\tthat\tare\tused\tin\tKafka.\tEach\ttopic\tis\tpartitioned\tinto multiple\tordered\tpartitions\tof\tmessages.\n\nPartitions\n\nPartitions\tdifferentiate\tKafka\tfrom\tother\tmessaging\tsystems.\tAnd\tthey\tmake the\tworking\tof\tKafka\tmuch\tmore\tefficient\tand\tfaster.\n\nProducers\tand\tconsumers\n\nProducers\tproduce\tmessages\tin\ttopics\twhereas\tconsumers\tconsume\tmessages from\ttopics.\n\nThe\tfollowing\tdiagram\tprovides\ta\thigh-level\tidea\tof\thow\tKafka\tworks:",
      "content_length": 703,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 439,
      "content": "In\tthe\tpreceding\tdiagram,\tyou\tcan\tsee\tthat\tthere\tare\ttwo\tbrokers\tin\ta\tcluster. There\tis\tone\ttopic\tcalled\tTopic\t1\ton\tboth\tthe\tbrokers\tin\tthe\tcluster.\tThe\ttopic has\ttwo\tpartitions.\tIdeally,\teach\tbroker\twill\ttake\townership\tof\tone\tpartition,\tand the\tother\tbroker\twill\thave\ta\treplica\tof\tthat\tpartition.\tFor\texample,\tif\tBroker\t1 owns\tPartition\t0\tin\tTopic\t1,\tthen\tthere\twill\tbe\ta\treplica\tof\tPartition\t0\tin Broker\t2\tas\twell.\tIn\tother\twords,\tBroker\t1\tis\tthe\tleader\tfor\tPartition\t0\tof Topic\t1.\tI\thope\tyou\tare\table\tto\tgrasp\tthe\tbasics\tof\tKafka.\tWe\twill\tlearn\tsome advanced\tconcepts\tabout\tKafka\tlater\tin\tthis\tchapter,\tbut\tfor\tnow,\tthis\tshould give\tyou\ta\tgood\thead\tstart.",
      "content_length": 658,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 440,
      "content": "Getting\tready\n\nKafka\trequires\tZookeeper\tin\torder\tto\toperate.\tIt\tuses\tZookeeper\tmainly\tfor electing\ta\tcontroller,\tstoring\tconfigurations\tof\ttopics,\tstoring\tmember information\tof\tthe\tcluster,\tand\tso\ton.\tAt\tthe\ttime\tof\twriting\tthis,\tit\tis\tnot\tpossible to\trun\tKafka\twithout\tZookeeper.\tSo,\tobviously,\twe\twill\tneed\ttwo\tcontainers: Kafka\tand\tZookeeper.\tGo\tahead\tand\topen\tup\tyour\tSTS\tIDE\tand\tnavigate\tto\tthe geolocation\tproject.",
      "content_length": 420,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 441,
      "content": "How\tto\tdo\tit...\n\nWe\twill\tuse\tDocker\tCompose\tto\torchestrate\tKafka.\tGo\tahead\tand\tcreate\ta\tnew YML\tfile\tcalled\tdocker-compose-kafka.yml\tdirectly\tunder\tthe\tgeolocation project.\tThen,\tadd\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tDocker\tCompose file:\n\nversion:\t\"2\"\n\nservices:\t \t\tzookeeper:\t \t\t\t\timage:\twurstmeister/zookeeper\t \t\t\t\tports:\t \t\t\t\t\t\t-\t\"2181:2181\"\n\nkafka:\t \t\t\t\timage:\twurstmeister/kafka:0.10.1.0-1\t \t\t\t\tports:\t \t\t\t\t\t\t-\t\"9092:9092\"\t \t\t\t\tenvironment:\t \t\t\t\t\t\tKAFKA_ADVERTISED_HOST_NAME:\t192.168.99.100\t \t\t\t\t\t\tKAFKA_ZOOKEEPER_CONNECT:\tzookeeper:2181\t \t\t\t\tvolumes:\t \t\t\t\t\t\t-\tvarrun/docker.sock:varrun/docker.sock\n\nAs\tyou\tcan\tsee,\twe\thave\tnot\tused\tany\tofficial\timages.\tAt\tthe\ttime\tof\twriting this,\tthere\tis\tno\tofficial\timage\tfor\tKafka.\tHowever,\tthere\tare\tKafka\timages\tlisted under\tthe\tConfluent\torganization\tin\tDocker\tHub.\tConfluent\tis\tthe\tcompany behind\tKafka\tand\tthe\tConfluent\tplatform.\tIt\twas\tbuilt\tby\ta\tfew\tof\tthe\tearly committers\tof\tKafka\tback\tfrom\tLinkedIn.\tThe\tcompany\tis\tprimarily\tfocused\ton providing\tstreaming\tsolutions\tand\tproducts\tto\tbuild\tdata\tpipelines\tand\tplatforms.\n\nPort\t2181\tof\tZookeeper\thas\tbeen\tmapped\tto\tthe\tsame\tport\ton\tthe\thost.\tSimilarly, port\t9092\tof\tKafka\thas\tbeen\tmapped\tto\tthe\tsame\tport\ton\tthe\thost.\tPort\t9092\tis where\tKafka\twill\tbe\tlistening.\n\nThere\tare\ttwo\trequired\tenvironment\tvariables:\tKAFKA_ADVERTISED_HOST_NAME and\tKAFKA_ZOOKEEPER_CONNECT.\tThe\tKAFKA_ADVERTISED_HOST_NAME\tproperty defines\tthe\thostname\tto\twhich\tKafka\twill\tbind\tto.\tThe KAFKA_ZOOKEEPER_CONNECT\tproperty\tis\trequired\tto\tspecify\tthe\tURL\tto Zookeeper.\tAs\tboth\tthe\timages\tare\tin\tthe\tsame\tDocker\tCompose\tYML\tfile,\twe",
      "content_length": 1608,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 442,
      "content": "have\treferenced\tthe\thostname\tof\tZookeeper\tas\tzookeeper\titself,\twhich\thappens to\tbe\tthe\tname\tof\tthe\tZookeeper\tservice.\n\nYou\tmight\tbe\twondering\twhy\twe\thave\texposed\tthe\tDocker\tsocket\tfile\tas\ta volume.\tThe\tDocker\timage\tthat\twe\tare\tusing\tneeds\tto\trun\tsome\tDocker commands\tfrom\tinside\tthe\tcontainer.\tSo\tit\tneeds\tthe\tDocker\tdaemon.\tOnce\tyou get\ta\thold\tof\tthe\tsocket\tfile,\tyou\tcan\trun\tany\toperation\tyou\twant.\tThough\tthis doesn't\tsound\tvery\tsecure,\tit\tis\tstill\tokay\tas\tit\tis\tonly\tour\tlocal\tdevelopment environment.\n\n1.\t Now\tlet's\tspin\toff\tour\tfirst\tKafka\tbroker\tusing\tDocker\tCompose.\tOpen\tup\ta new\tterminal\tsession\tand\trun\tthe\tfollowing\tdocker-compose\tcommand:\n\ndocker-compose\t-f\tdocker-compose-kafka.yml\tup\n\n2.\t You\tshould\tsee\tsomething\tlike\tthis\twhen\tKafka\thas\tstarted:\n\n3.\t Now\tthat\tour\tKafka\tbroker\tis\tup\tand\trunning,\tthe\tnext\tstep\tis\tto\tverify whether\tit\tstarted\tsuccessfully.\tIt\twould\tbe\tgreat\tif\tKafka\thad\ta\tUI\tadmin interface.\tCurrently,\tthere\tare\ta\tfew\tthird-party\tapps\tthat\tcan\tbe\tused\twith Kafka,\tsuch\tas\tKafka\tManager\tand\tKafka\tUI.\tFor\tthis\tchapter,\twe\twill\tnot need\tone.\tSo\tif\tyou\tare\tinterested\tin\thaving\tone,\tfeel\tfree\tto\ttry\tthem\tout and\tsee\twhich\tone\tfits\tyour\tneeds.\tThroughout\tthis\tchapter,\twe\twill\tneed\ta client\tthat\tcan\tbe\tused\tto\tperform\toperations\tsuch\tas\tcreating\ttopics, consuming\tmessages,\tand\tproducing\tmessages.\tWe\twill\tbe\tmaking\tuse\tof",
      "content_length": 1355,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 443,
      "content": "some\tof\tthe\tshell\tscripts\tthat\tcome\twith\tthe\tKafka\tinstallation\tfor\tthat. 4.\t So\tdownload\tversion\t2-11-0.10.1.0\tfrom\tthe\tApache\tKafka\twebsite\tat\n\nhttps://kafka.apache.org/downloads\t.\tThe\tversion\tnumber\tis\tsplit\tinto\ttwo parts.\t2-11\tindicates\tthe\tversion\tof\tScala\tthat\twas\tused\tto\tbuild\tthis\tversion of\tKafka.\t0.10.1.0\tis\tthe\tactual\tversion\tof\tKafka.\n\n5.\t After\tyour\tdownload\tis\tcomplete,\tunpack\tKafka\tto\tany\tdirectory\tin\tyour computer.\tOpen\ta\tnew\tterminal\tsession\tand\tchange\tthe\tdirectory\tto\tthe Kafka\tdirectory.\tNow\texecute\tthe\tfollowing\tcommand\t(Windows\tusers,\tuse the\tbinary\tequivalent\tfor\tWindows): ./bin/kafka-topics.sh\t--list\t--zookeeper\t192.168.99.100:2181\n\n6.\t The\tpreceding\tcommand\tis\tused\tto\tlist\tall\tthe\ttopics\tavailable\tin\tyour broker.\tLook\thow\twe\thave\tpassed\tthe\tZookeeper\tURL\tinstead\tof\tKafka's. That\tis\tbecause\tthe\tbroker\tis\tlocated\tusing\tZookeeper.\tIf\tthe\tcommand returned\tany\terrors,\tthen\tyou\tdidn't\tinstall\tKafka\tcorrectly,\tor\tyou\tdon't have\tthe\tright\tZookeeper\tURL.\tMost\tof\tthe\ttime,\tit\tis\tsomething\tto\tdo\twith the\thostname\tand\tIP\tof\tZookeeper.\tIf\tyour\tinstallation\twas\tsuccessful,\tyou will\tnot\tget\tany\toutput\tfor\tthis\tcommand,\tas\twe\tdo\tnot\thave\tany\ttopic\tin this\tbroker.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\tfew\trecipes,\twe\twill\tput Kafka\tinto\taction.\tGo\tKafka!",
      "content_length": 1299,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 444,
      "content": "Creating\tKafka\ttopics\tto\tstream\tdata\n\nIn\tthe\tprevious\trecipe,\twe\torchestrated\tour\tKafka\tbroker.\tThe\tnext\tstep\tis obviously\tputting\tKafka\tto\taction.\tIn\torder\tto\tdo\tthat,\twe\tneed\tsome\ttopics\tto work\twith.\tIn\tthis\trecipe,\twe\twill\tcreate\tsome\ttopics\tand\twill\talso\tlearn\thow\tto produce\tand\tconsume\tmessages.\tExchanging\tmessages\tcan\tbe\tdone\tin\ttwo\tways: scripts\tand\tJava\tprograms.\tWe\twill\tbe\tlearning\tthe\tJava\tway.",
      "content_length": 408,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 445,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tusing\tthe\tsame\tKafka\ttopics\tscript\tto\tcreate\ttopics:\n\n1.\t Open\ta\tnew\tterminal\tshell\tand\tnavigate\tto\tthe\tdirectory\twhere\tyou\thave Kafka\tinstalled.\n\n2.\t Let's\tcreate\ta\tnew\ttopic\tcalled\tgeolocations.\tWe\twill\tthen\twrite\ta\tbasic standalone\tproducer\tprogram\tthat\twill\tproduce\tgeolocations\tfor\tthis\ttopic. We\twill\tintegrate\ta\tconsumer\twith\tour\tgeolocation\tapplication\tthat\twill consume\tall\tmessages\tproduced\tby\tour\tstandalone\tproducer.\n\n3.\t So\tnow,\tour\tgeolocation\tapplication\twill\thave\ttwo\tmodes\tin\twhich\tyou\tcan store\tgeolocations:\tsynchronous\tHTTP\tmode\tand\tasynchronous\tmode\tusing Kafka.\tIt\tis\tstill\tpossible\tto\tmake\tyour\tHTTP\tAPIs\twork\tasynchronous.\n\n4.\t We\twill\tnot\tbe\tgoing\tin\tdepth\tinto\tthat\ttopic.\tFor\tillustration,\twe\twill consider\tour\tHTTP\tendpoint\tto\tbe\tsynchronous\tand\tour\tKafka\tendpoint\tto be,\tobviously,\tasynchronous.\n\n5.\t Before\twe\tjump\tinto\tthe\tactual\trecipe,\tlet's\tcomment\tout\tsome\tunused\tcode from\tthe\tgeolocation\tapplication.\tFrom\tthe\tprevious\tchapter,\tif\tyou\thave either\tConsoleReporter\tor\tGraphiteReporter\tconfigured,\tcomment\tthem both\tout.",
      "content_length": 1096,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 446,
      "content": "How\tto\tdo\tit...\n\nThe\tnext\tfew\tsteps\tin\tthis\trecipe\twill\thelp\tyou\tcreate\tyour\tfirst\tKafka\tProducer and\tKafka\tConsumer\tprograms.\n\nLet's\tcreate\ta\tnew\ttopic\tcalled\tgeolocations.\tGo\tahead\tand\texecute\tthe following\tcommand\tin\tyour\tterminal\tshell:\n\n./bin/kafka-topics.sh\t--create\t--zookeeper\t192.168.99.100:2181\t-- replication-factor\t1\t--partitions\t2\t--topic\tgeolocations Created\ttopic\t\"geolocations\".\n\nThere\tare\ta\tfew\tthings\tto\ttalk\tabout\there.\tFirst,\tlet's\ttalk\tabout\tthe\treplication- factor\toption.\tThe\treplication\tfactor\tsays\thow\tmany\treplicas\tKafka\tneeds\tto maintain\tfor\teach\tpartition\tin\tthe\ttopic.\tIt\tdepends\ton\tthe\tcluster\tsize\tand configuration.\tIn\tour\tcase,\twe\thave\tset\tit\tto\t1.\tThe\tpartitions\toption,\tas\tthe name\tindicates,\tis\tthe\tnumber\tof\tpartitions\tthis\ttopic\tneeds\tto\thave.\tThe\ttopic argument\tindicates\tthe\tname\tof\tour\ttopic.\tAnd,\tof\tcourse,\twe\tneed\tthe zookeeper\targument\tto\tlocate\tour\tbroker:\n\n1.\t Now\tthat\tour\ttopic\tis\tready,\tlet's\tcreate\ta\tsimple\tKafka\tproducer.\tAdd\tthe following\tMaven\tdependency\tto\tthe\tpom.xml\tfile:\n\n<dependency> \t\t\t\t\t\t\t\t\t\t<groupId>org.apache.kafka</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>kafka-clients</artifactId> \t\t\t\t\t\t\t\t\t\t<version>0.10.1.0</version> \t\t\t\t\t\t\t\t</dependency>\n\n2.\t Create\ta\tnew\tclass\tin\tthe\tgeolocation\trepo\tcalled\n\ncom.packt.microservices.geolocation.GeoLocationProducer.java.\n\n3.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tproducer:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.List; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.producer.KafkaProducer; import\torg.apache.kafka.clients.producer.Producer; import\torg.apache.kafka.clients.producer.ProducerRecord; import\torg.apache.kafka.common.serialization.StringSerializer;",
      "content_length": 1731,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 447,
      "content": "public\tclass\tGeoLocationProducer\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName()); Producer<String,\tString>\tproducer\t=\tnew\tKafkaProducer<>(props);\n\nList<GeoLocation>\tgeolocations\t=\tArrays.asList( \t\t\t\t\t\tnew\tGeoLocation(38.6270,\t90.1994), \t\t\t\t\t\tnew\tGeoLocation(93.9879,\t76.9876),\t//\tinvalid\tlat \t\t\t\t\t\tnew\tGeoLocation(41.8034,\t-88.1440), \t\t\t\t\t\tnew\tGeoLocation(40.9879,\t-200.9876),\t//\tinvalid\tlong \t\t\t\t\t\tnew\tGeoLocation(-93.9879,\t76.9876),\t//\tinvalid\tlat \t\t\t\t\t\tnew\tGeoLocation(9.5680,\t77.9624), \t\t\t\t\t\tnew\tGeoLocation(13.0827,\t80.2707), \t\t\t\t\t\tnew\tGeoLocation(40.9879,\t200.9876),\t//\tinvalid\tlong \t\t\t\t\t\tnew\tGeoLocation(9.9252,\t78.1198));\n\nfor(GeoLocation\tgeolocation\t:\tgeolocations)\t{ \t\t\t\t\t\tSystem.out.println(\"Sending\tgeolocaiton\t[\"\t+ geolocation.toString()\t+\t\"]\"); \t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\tproducer.send(record); \t\t\t\t}\n\nproducer.close(); \t\t} }\n\n4.\t There\tare\tthree\tthings\tto\ttalk\tabout\there:\tproducer,\tgeolocations\tand ProducerRecords.\tIn\torder\tto\tinstantiate\tproducer,\twe\tcreate\ta\tProperties object\twith\tthree\tproperties:\tbootstrap.servers,\tkey.serializer,\tand value.serializer:\n\nThe\tbootstrap.servers\tproperty\tindicates\tthe\tURLs\tto\tthe\tKafka brokers.\tAs\tour\tcluster\tis\ta\tsingle\tbroker\tcluster,\twe\tprovide\tthe\tURL to\tthat\tbroker\tin\tthis\tproperty.\tIf\tyou\thave\tmultiple\tbrokers,\tyou\tcan provide\tcomma-separated\tvalues.",
      "content_length": 1652,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 448,
      "content": "The\tkey.serializer\tproperty\ttakes\tthe\tfully\tqualified\tname\tof\tthe serializer\tthat\twill\tbe\tused\tto\tserialize\tthe\tkey\tof\tthe\tmessage. Likewise,\tthe\tvalue.serializer\tproperty\ttakes\tthe\tfully\tqualified name\tof\tthe\tserializer\tthat\twill\tbe\tused\tto\tserialize\tthe\tvalue\tof\tthe message.\n\n5.\t Later\tin\tthe\tcode,\twe\tcreate\tnine\tgeolocations,\tout\tof\twhich\tfour\tare\tinvalid (invalid\tgeolocations\thave\ta\tcomment\tright\tnext\tto\tthem).\tThen,\tfor\teach geolocation,\twe\tcreate\ta\tProducerRecord.\tThe\tconstructor\tof ProducerRecord\thas\ttwo\targuments:\tthe\ttopic\tname\tand\tthe\tactual message.\tIn\tthis\trecipe,\tthe\ttopic\tname\tis\tgeolocations.\tLet's\tcome\tback\tto the\tactual\tmessage\tlater.\n\n6.\t Also\tlook\tat\thow\tthe\tProducerRecord\tis\tdefined\tas\ta\tgeneric\tof\t<String, String>.\tThe\tfirst\tgeneric\tdefines\tthe\ttype\tof\tthe\tkey,\tand\tthe\tsecond defines\tthe\ttype\tof\tthe\tvalue.\tThe\tkey\tis\tusually\tused\tto\tassign\tpartitions.\tIn this\trecipe,\tthe\tkey\tis\tnot\tsignificantly\timportant,\tso\twe\tare\tgoing\tto\tignore it.\tIf\tyou\twould\tlike\tto\tuse\tit,\tthen\tyou\thave\tto\tuse\tthe\tappropriate overloaded\tconstructor\tfor\tProducerRecord.\tWe\tthen\tinvoke\tthe\tsend() method\ton\tproducer\twith\tthe\tProducerRecord.\tFinally,\tthe\tproducer instance\tis\tclosed\tby\tinvoking\tthe\tclose()\tmethod.\n\n7.\t Now\tlet's\tgo\tback\tto\tthe\tactual\tmessage.\tIt\tis\ta\ttoString()\tof\tthe GeoLocation\tclass.\tBut\twait;\twe\thaven't\tdefined\ta\ttoString()\tmethod\tin GeoLocation.\tLet's\tdo\tit\tnow.\tWe\twill\tbe\tconverting\tthe\tGeoLocation object\tto\tits\tJSON\tequivalent.\n\n8.\t Let's\tuse\tGSON\tto\tdo\tit.\tGSON\tis\ta\tJSON\tlibrary\tfrom\tGoogle\tand\tis\tvery easy\tto\tuse.\tGo\tahead\tand\tadd\tthe\tfollowing\tMaven\tdependency\tto\tthe pom.xml\tfile: <dependency> \t\t\t\t\t\t\t\t\t\t<groupId>com.google.code.gson</groupId> \t\t\t\t\t\t\t\t\t\t<artifactId>gson</artifactId> \t\t\t\t\t\t\t\t</dependency>\n\n9.\t Now\tthat\tour\tdependency\tis\tready,\tadd\tthe\tfollowing\tconstructors\tand toString()\tmethod\tto\tGeoLocation.java:\n\npublic\tGeoLocation()\t{}\n\npublic\tGeoLocation(double\tlatitude,\tdouble\tlongitude)\t{ \t\t\tthis.latitude\t=\tlatitude; \t\t\tthis.longitude\t=\tlongitude; \t\t\tthis.userId\t=\tUUID.randomUUID();",
      "content_length": 2039,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 449,
      "content": "this.userId\t=\tUUID.randomUUID(); \t\t\tthis.timestamp\t=\tSystem.currentTimeMillis(); } @Override public\tString\ttoString()\t{ \t\treturn\tGSON.toJson(this); }\n\n10.\t GSON\tis\tdefined\tas\ta\tconstant\tin\tthe\tsame\tclass:\n\nprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson();\n\n11.\t Now\tall\tour\tgeolocations\twill\tbe\tsent\tto\tthe\tKafka\ttopic\tas\tJSON\tstrings. 12.\t The\tnext\tstep\tin\tthis\trecipe\tis\tto\tbuild\tthe\tKafka\tconsumer\tthat\twill consume\tmessages\tfrom\tthe\tgeolocations\ttopic.\tGo\tahead\tand\tcreate\ta new\tthread\tcalled com.packt.microservices.geolocation.GeoLocationConsumer.java.\n\n13.\t Add\tthe\tfollowing\tsnippet\tto\tthe\tnewly\tcreated\tconsumer\tclass:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.consumer.ConsumerRecord; import\torg.apache.kafka.clients.consumer.ConsumerRecords; import\torg.apache.kafka.clients.consumer.KafkaConsumer; import org.apache.kafka.common.serialization.StringDeserializer;\n\nimport\tcom.google.gson.Gson;\n\npublic\tclass\tGeoLocationConsumer\timplements\tRunnable\t{\n\nprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson(); \t\tprivate\tstatic\tfinal\tGeoLocationRepository\tREPO\t=\tnew GeoLocationRepository();\n\npublic\tvoid\trun()\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"group.id\",\t\"geolocationConsumer\"); \t\t\t\tprops.put(\"key.deserializer\", StringDeserializer.class.getName()); \t\t\t\tprops.put(\"value.deserializer\", StringDeserializer.class.getName());\n\ntry\t(KafkaConsumer<String,\tString>\tconsumer\t=\tnew",
      "content_length": 1539,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 450,
      "content": "try\t(KafkaConsumer<String,\tString>\tconsumer\t=\tnew KafkaConsumer<>(props))\t{ \t\t\t\t\t\tconsumer.subscribe(Arrays.asList(\"geolocations\")); \t\t\t\t\t\twhile\t(true)\t{ \t\t\t\t\t\t\t\tConsumerRecords<String,\tString>\trecords\t= consumer.poll(100); \t\t\t\t\t\t\t\tfor\t(ConsumerRecord<String,\tString>\trecord\t:\trecords)\t{ \t\t\t\t\t\t\t\t\t\tSystem.out.printf(\"offset\t=\t%d,\tkey\t=\t%s,\tvalue\t= %s%n\", \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.offset(), \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.key(), \t\t\t\t\t\t\t\t\t\t\t\t\t\trecord.value());\n\nREPO.addGeoLocation(GSON.fromJson(record.value(), GeoLocation.class)); \t\t\t\t\t\t\t\t} \t\t\t\t\t\t} \t\t\t\t}\tcatch\t(Exception\te)\t{ \t\t\t\t\t\tSystem.err.println(\"Error\twhile\tconsuming\tgeolocations. Details:\t\"\t+\te.getMessage()); \t\t\t\t} \t\t} }\n\n14.\t First,\twe\tcreate\ta\tnew\tKafkaConsumer\twith\tfour\tproperties: bootstrap.servers,\tgroup.id,\tkey.deserializer,\tand value.deserializer:\n\nThe\tbootstrap.servers\tproperty\tis\tthe\tsame\tas\tin\tthe\tproducer.\tWe will\ttalk\tabout\tgroup.id\tlater\tin\tthis\tchapter.\tFor\tnow,\tyou\tcan\tkeep\tin mind\tthat\tit\tis\tused\tto\tgroup\tconsumers. The\tkey.deserializer\tproperty\twill\tbe\tthe\tfully\tqualified\tclass\tname of\tthe\tdeserializer\tthat\twill\tbe\tused\tto\tdeserialize\tthe\tserialized\tkey\tof the\tmessage. Likewise,\tvalue.deserializer\tis\tused\tfor\tthe\tvalue\tdeserialization process.\tAs\tyou\tcan\tsee,\tthe\tconsumer.subscribe()\tmethod\ttakes\tan argument\tof\tstring\tarrays.\tSo\tyou\tcan\tuse\tthe\tsame\tconsumer\tto consume\tmessages\tfrom\tmultiple\ttopics.\tIn\tthis\tcase,\twe\thave subscribed\tto\tthe\tgeolocations\ttopic.\n\n15.\t In\tan\tinfinite\tloop,\twe\tcreate\tthe\tConsumerRecord\tinstances\tfor\teach message\treceived\tfrom\tthe\ttopic.\tThe\tmessages,\talong\twith\ttheir\toffset\tin the\ttopic,\ttheir\tkey,\tand\tvalue,\tare\tprinted\tout.\n\n16.\t Finally,\tthe\tmessage\tvalue\tis\tconverted\tto\tGeoLocation\tusing\tGSON\tand stored\tusing\tthe\tGeoLocationRepository\tclass.\tAs\twe\tare\tusing\tan\tinfinite",
      "content_length": 1784,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 451,
      "content": "loop,\tthis\tcode\twill\trun\tand\tkeep\tlistening\tfor\tany\tnew\tmessages\tin\tthe topic\tand\tstore\tthem\tas\tthey\tcome\tthrough.\n\nNote\n\nIf\tyou\tare\twondering\twhy\twe\tinstantiated\ta\tnew\trepository\tinstead\tof autowiring\tit\tas\ta\tbean,\tthe\treason\tis\tbecause\tSpring\tbeans\tand\tthreads\tdo not\tgo\twell\twith\teach\tother.\tUnfortunately,\tour\tconsumer\tmust\tbe\ta\tthread. So\tthe\tbest\tway\tto\taccomplish\tthis\tis\tto\tinstantiate\tthe\trepository\tas\ta regular\tJava\tobject\tusing\tthe\tnew\tkeyword.\tThe\tside\teffect\tof\tthis\tis\tthat\tthe repository\t(and\thence\tthe\tin-memory\tcollection)\tused\tby\tthe GeoLocationConsumer\tand\tthe\tGeoLocationController\twill\tbe\ttotally different.\tIdeally,\tin\ta\treal-time\tscenario,\twe\twould\tbe\tusing\ta\tdatabase\tto store\tour\tdata.\tSo\tthis\tsituation\twill\tnot\thappen.\tFor\tillustrations,\tin\tthis recipe,\twe\twill\tbe\tverifying\twhether\tour\tgeolocations\twere\tcreated\tby looking\tat\tthe\tdata\tdirectory\tat\toptpackt/geolocation/data.\n\n17.\t In\torder\tto\tstart\tthis\tthread,\tadd\tthe\tfollowing\tsnippet\tto\tthe\tmain\tmethod\tof the\tGeoLocationApplication.java\tclass:\n\nnew\tThread(new\tGeoLocationConsumer()).start();\n\n18.\t That's\tit.\tWe\thave\tour\tproducer\tand\tconsumer\tready.\tLet's\ttest\tthem\tout. Start\tthe\tGeoLocationApplication.java\tclass\tas\ta\tSpring\tBoot application.\tThis\ttime,\talong\twith\tthe\tSpring\tMVC\tlogs,\tyou\tshould\tsee some\tKafka\tconsumer\tlogs\ttoo:\n\n19.\t Now\tthat\tour\tconsumer\tis\tready,\tlet's\texecute\tthe\n\nGeoLocationProducer.java\tclass\tas\ta\tJava\tapplication\tfrom\tyour\tSTS IDE.\tThe\tproducer\twill\tdrop\tall\tthe\tnine\tgeolocations\tinto\tthe geolocations\ttopic.\n\n20.\t Now\tlook\tat\tthe\tconsole\tof\tyour\tgeolocation\tmicroservice:",
      "content_length": 1587,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 452,
      "content": "As\tyou\tcan\tsee,\tthe\tconsumer\treceived\tnine\tmessages\tthat\tthe\tproducer produced.\tThe\toffsets\tstart\tfrom\t17\tinstead\tof\t0\tbecause\tthe\tproducer probably\tproduced\tmore\tmessages\tbefore\tthis\t(I\twas\ttesting\tit\ta\tfew\ttimes before\tthis\texecution).\n\n21.\t Now\tlet's\tverify\twhether\tour\tgeolocations\twere\tcreated\tin\tthe\tdata directory.\tRun\tthe\tfollowing\tls\tcommand\tfrom\ta\tterminal\tshell\tto\tview\tthe contents\tof\tyour\tdata\tdirectory:\n\nls\t-1\toptpackt/geolocation/data user0e7b55ae-ae42-4fba-a0a7-09ea50f018b3_t1482426034840 user2bb53438-2650-485d-ad2c-77bf53367311_t1482426034840 user8c5334e4-8bdb-4351-af8d-20f298082a41_t1482426034840 user92e6069f-6ec8-4339-a020-10fd5fe86502_t1482426034840 usera4b88745-2b55-425f-bad5-d4ebea8c7b27_t1482426034840 userb25977d7-3770-491c-8cfd-578748148ad2_t1482426034840 userc0774179-ee5e-4bf9-92aa-03e800cf076e_t1482426034840 userca40d66f-af00-4240-8ab0-5bfe48aa1df3_t1482426034840 userce5d314a-763f-4010-812f-a07e1945d5f6_t1482426034840\n\n22.\t The\tpreceding\tcommand\tlists\tall\tthe\tfiles\tin\tthe\tgiven\tdirectory.\tIf\tyou\tare curious\tto\tknow\twhether\tthese\tfiles\thave\tthe\tgeolocations,\tuse\tthe\tcat command\tto\tview\tthe\tcontents.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\twrote\ta\tsimple consumer\tand\tproducer\tto\twork\twith\tKafka\ttopics.\tThis\tapplication\tcan\tbe extended\tto\tbuild\ta\tmore\tsophisticated\tand\trobust\tapplication\tfor\tgeolocation entities.\tIn\tthe\tnext\trecipe,\twe\twill\tsee\thow\tto\tuse\tKafka\tStreams\tto\tbuild\tgreat streaming\tapplications.",
      "content_length": 1472,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 453,
      "content": "Writing\ta\tstreaming\tprogram\tusing Kafka\tStreams\n\nIn\tthe\tprevious\trecipe,\twe\twrote\ta\tvery\tbasic\tKafka\tproducer\tand\tconsumer. That\tmight\tnot\tbe\tsufficient\twhen\tyou\twould\tlike\tto\twork\twith\tyour\tdata.\tIn fact,\tthe\tconsumer\twe\twrote\twas\tnot\tsmart\tenough\tto\tfilter\tout\tgeolocations\twith invalid\tlatitudes\tand\tlongitudes.\tThese\tare\tthings\tyou\twould\twant\tto\tdo\twhen you\tbuild\ta\tstreaming\tapplication.\tIn\tthis\trecipe,\twe\twill\tbe\tutilizing\tKafka's Streams\tAPI\tto\tcreate\ta\tKafka\tStreams\tapplication\tthat\twill\tstream\tmessages from\ta\tnew\ttopic\tcalled\tgeolocationStreams,\tfilter\tout\tbad\tgeolocations,\tand forward\tthe\tvalid\tgeolocations\tto\tthe\tgeolocations\ttopic.\tThis\twill\tmake\tsure that\twe\tstore\tonly\tvalid\tgeolocations.\n\nThe\tfollowing\tdiagram\tdepicts\tthe\tflow\tof\tour\tapplication:",
      "content_length": 767,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 454,
      "content": "Getting\tready 1.\t Before\twe\twrite\tour\tKafka\tStreams\tapplication,\tlet's\tdelete\tany\texisting geolocations\tin\tthe\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommand\tin\ta new\tterminal\tshell:\trm\toptpackt/geolocation/data/*\n\n2.\t Now\tthat\tyou\thave\tcleaned\tup\tall\tthe\texisting\tgeolocations,\tmake\tsure\tyou have\tKafka\tup\tand\trunning.\tIf\tit\tisn't\trunning,\tstart\tit\tusing\tDocker Compose.\tIf\tit\tis\ta\tfresh\tinstallation,\tcreate\tthe\tgeolocations\ttopic.\n\n3.\t The\tnext\tstep\tis\tcreating\ta\tnew\ttopic\tfor\tthe\tstreaming\tapplication.\tExecute the\tfollowing\tcommand\tin\tthe\tsame\tterminal\twindow:\t./bin/kafka- topics.sh\t--create\t--topic\tgeolocationStreams\t--replication-factor\t1\t-- partitions\t2\t--zookeeper\t192.168.99.100:2181\tCreated\ttopic \"geolocationStreams\".",
      "content_length": 731,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 455,
      "content": "How\tto\tdo\tit... 1.\t The\tfirst\tstep\tin\tcreating\tthe\tKafka\tStreams\tapplication\tis\twriting\tthe\n\nstreaming\tlogic.\tAdd\tthe\tfollowing\tdependency\tto\tthe\tgeolocation\tproject's pom.xml\tfile:\t<dependency>\t<groupId>org.apache.kafka</groupId> <artifactId>kafka-streams</artifactId>\t<version>0.10.1.0</version> </dependency>\n\n2.\t Create\ta\tnew\tclass\tcalled\n\ncom.packt.microservice.geolocation.GeoLocationStreams.java.\tAdd the\tfollowing\tsnippet\tto\tit:\tpackage com.packt.microservices.geolocation;\timport\tjava.util.HashMap; import\tjava.util.Map;\timport\tjavax.annotation.PostConstruct;\timport org.apache.kafka.common.serialization.Serdes;\timport org.apache.kafka.streams.KafkaStreams;\timport org.apache.kafka.streams.StreamsConfig;\timport org.apache.kafka.streams.kstream.KStreamBuilder;\timport org.apache.kafka.streams.kstream.Predicate;\timport org.springframework.stereotype.Component;\t@Component\tpublic class\tGeoLocationStreams\t{\t@PostConstruct\tpublic\tvoid\tinit()\t{ Map<String,\tObject>\tprops\t=\tnew\tHashMap<>(); props.put(StreamsConfig.APPLICATION_ID_CONFIG,\t\"geolocation- application\"); props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"192.168.99.100:9092\"); props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName()); props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, GeoLocationSerdes.class.getName());\tStreamsConfig\tconfig\t=\tnew StreamsConfig(props);\tKStreamBuilder\tbuilder\t=\tnew KStreamBuilder();\tbuilder.stream(\"geolocationStreams\").filter(new Predicate<Object,\tObject>()\t{\t@Override\tpublic\tboolean\ttest(Object key,\tObject\tvalue)\t{\tGeoLocation\tgeolocation\t=\t(GeoLocation)\tvalue; System.out.println(\"Stream\treceived\t=>\t\"\t+\tvalue);\treturn geolocation.getLatitude()\t>=\t-90\t&&\tgeolocation.getLatitude()\t<\t90\t&& geolocation.getLongitude()\t>=\t-180\t&&\tgeolocation.getLongitude()\t< 180;\t}\t}).to(\"geolocations\");\tKafkaStreams\tstreams\t=\tnew KafkaStreams(builder,\tconfig);\tstreams.start();\t}\t}",
      "content_length": 1902,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 456,
      "content": "As\tyou\tcan\tsee,\twe\tfirst\tbuild\ta\tStreamsConfig\tinstance.\tThe StreamsConfig\tinstance\tprimarily\tidentifies\tthe\tKafka\tbroker\tURLs, SerDes\tfor\tthe\tkey,\tand\tSerDes\tfor\tthe\tvalue.\tIf\tyou\tare\twondering\twhat SerDes\tis,\tit\tis\tshort\tfor\tSerializerDeserializer.\tSee\thow\twe\thave\tused\ta custom\tSerDes\tfor\tthe\tvalue.\tWe\twill\tbe\tcreating\ta\tSerDes\tcalled GeoLocationSerdes\tlater\tin\tthis\trecipe.\tThe\tfunction\tof\tthis\tSerDes\tis\tto serialize\tand\tdeserialize\tthe\tGeoLocation\tobject\tto\tJSON\t(eventually\tbytes) and\tvice\tversa.\tWe\twill\tlook\tat\thow\tto\tdo\tthis\tlater.\n\n3.\t The\tnext\tstep\tis\tcreating\tthe\tKStreamBuilder\tinstance.\tKStreamBuilder defines\twhere\tyour\tstream\tapplication\twill\tstream\tmessages\tfrom,\thow\tto process\tthe\tmessage\twith\tthe\thelp\tof\tseveral\tmethods\t(such\tas\tmap, flatMap,\tfilter,\tand\tto),\tand,\tfinally,\tsend\tthe\tmessages\tover\tto\ta destination\ttopic:\n\nThe\tstream()\tmethod\ttells\twhere\tthe\tmessages\tshould\tbe\tstreamed from.\tIn\tour\texample,\twe\tare\tstreaming\tfrom\tthe\tgeolocationStreams topic. The\tfilter()\tmethod\ttakes\ta\tpredicate\tthat\twill\tfilter\tgeolocations that\thave\tbad\tlatitude\tand\tlongitude. The\tto()\tmethod\ttells\twhere\tthe\tvalid\tgeolocations\twill\tbe\tsent\tto.\n\nIn\tour\tcase,\twe\tare\tsending\tthem\tto\tthe\tgeolocations\ttopic.\tIf\tyou\tremember, the\tGeoLocationConsumer.java\tclass\twill\tconsume\tthese\tvalid\tgeolocations\tand store\tthem\tin\tthe\tdata\tdirectory.\tIf\tyou\twould\tlike\tto\tbypass\tthe GeoLocationConsumer\tclass,\tthat\tis\tfine\ttoo.\tIn\tfact,\tyou\tcan\tuse\tthe\tmap() method\tto\tcall\tGeoLocationService\tdirectly\tas\ta\tpart\tof\tKStreamBuilder. Finally,\twe\tinstantiate\ta\tnew\tKafkaStreams\tinstance\twith\tKStreamsBuilder\tand StreamsConfig.\tWe\thave\tto\tinvoke\tthe\tstart()\tmethod\tto\tstart\tthe\tstreaming process.\n\nNow\tlet's\tsee\thow\tto\tcreate\tour\tGeoLocationSerdes.java\tclass.\tCreate\ta\tnew\n\nclass\tcalled com.packt.microservices.geolocation.GeoLocationSerdes.java\tand\tadd the\tfollowing\tcode\tto\tit:\tpackage\tcom.packt.microservices.geolocation;\timport java.util.Map;\timport\torg.apache.kafka.common.serialization.Deserializer; import\torg.apache.kafka.common.serialization.Serde;\timport org.apache.kafka.common.serialization.Serializer;\timport com.google.gson.Gson;\tpublic\tclass\tGeoLocationSerdes\timplements Serde<GeoLocation>\t{\tprivate\tstatic\tfinal\tGson\tGSON\t=\tnew\tGson();\tpublic GeoLocationSerdes()\t{}\t@Override\tpublic\tvoid\tconfigure(Map<String,\t?>",
      "content_length": 2318,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 457,
      "content": "configs,\tboolean\tisKey)\t{}\t@Override\tpublic\tvoid\tclose()\t{}\t@Override\tpublic Serializer<GeoLocation>\tserializer()\t{\treturn\tnew\tSerializer<GeoLocation>()\t{ @Override\tpublic\tvoid\tconfigure(Map<String,\t?>\tconfigs,\tboolean\tisKey)\t{} @Override\tpublic\tbyte[]\tserialize(String\ttopic,\tGeoLocation\tdata)\t{\treturn data.toString().getBytes();\t}\t@Override\tpublic\tvoid\tclose()\t{}\t};\t}\t@Override public\tDeserializer<GeoLocation>\tdeserializer()\t{\treturn\tnew Deserializer<GeoLocation>()\t{\t@Override\tpublic\tvoid\tconfigure(Map<String,\t? >\tconfigs,\tboolean\tisKey)\t{}\t@Override\tpublic\tGeoLocation\tdeserialize(String topic,\tbyte[]\tdata)\t{\treturn\tGSON.fromJson(new\tString(data), GeoLocation.class);\t}\t@Override\tpublic\tvoid\tclose()\t{}\t};\t}\t}\n\nThe\tGeoLocationSerdes\tmethod\timplements\tthe\tSerde\tinterface:\n\nThe\tconfigure()\tand\tclose()\tmethods\tare\tnot\tvery\tsignificant\tfor\tthis recipe,\tso\tthey\twere\tnot\timplemented\tin\tthe\tpreceding\tsnippet The\tserializer()\tmethod\treturns\ta org.apache.kafka.common.serialization.Serializer<GeoLocation> that\thas\ta\tserialize()\tmethod\tthat\tknows\thow\tto\tconvert\tthe\tGeoLocation object\tto\tbytes Similarly,\tthe\tdeserializer()\tmethod\treturns\ta org.apache.kafka.common.serialization.Deserializer<GeoLocation> that\thas\ta\tdeserialize()\tmethod\tthat\tknows\thow\tto\tconvert\tbytes\tto\tthe GeoLocation\tobjects That's\tit!\tOur\tKafka\tStreams\tapplication\tis\tnow\tready\tto\ttest.\tBefore\twe start\ttesting,\twe\thave\tto\tchange\tthe\tGeoLocationProducer\tclass\tto\tproduce messages\tfor\tthe\tgeolocationStreams\ttopic\tinstead\tof\tgeolocations. So\tlet's\tmake\tthat\tchange.\tWith\tthat\tdone,\trun\tthe\tGeoLocationApplication class\tas\ta\tSpring\tBoot\tapplication.\tThis\ttime\taround,\tyou\tshould\thave\tsee\tmore log\tmessages\twhen\tyou\tapplication\tstarts,\tas\tthe\tStreams\tapplication\thas\tstarted along\twith\tSpring\tMVC\tand\tKafka\tconsumer.\n\nWithout\tfurther\tado,\trun\tGeoLocationProducer\tas\ta\tJava\tapplication.\tThis should\thave\tproduced\tthe\tsame\tnine\tgeolocations\tin\tthe\tgeolocationStreams topic.\n\nNow\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tgeolocation\tmicroservice.\tYou\tshould\n\nsee\tsomething\tlike\tthis:",
      "content_length": 2044,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 458,
      "content": "As\tyou\tcan\tsee,\tonly\tfive\tgeolocations\tthat\thad\tvalid\tlatitude\tand\tlongitude values\twere\tsent\tto\tthe\tgeolocations\ttopic.\tLet's\tverify\tthe\tsame\tby\tlisting\tthe contents\tof\tour\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommand\ton\tyour\tterminal shell:\tls\t-1\toptpackt/geolocation/data\tuser352752e1-f9df-4a2c-8bb5- 00df1b001170_t1482431025183\tuser4ca44a13-f737-4bba-84b8- 1ef39f5ebb60_t1482431025183\tuser97b60125-2ef7-48df-9d31- da755ba54bc4_t1482431025183\tuser9d07e2cc-9902-4710-a311- 19fc09a84f3b_t1482431025183\tusercdfb7821-20c8-474e-9cc7- 65b65316a78a_t1482431025183\n\nPerfect!\tThat\tclarifies\tthat\tour\tKafka\tStreams\tapplication\tworked\tas\texpected.\n\nWith\tthat,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthe\tnext\trecipe,\twe\twill\tlearn how\tto\tprocess\tmore\tgeolocations\tusing\tKafka\tStreams.",
      "content_length": 775,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 459,
      "content": "Improving\tthe\tperformance\tof\tthe Kafka\tStreams\tprogram\n\nKafka\tclaims\tthat\tit\tis\tso\tfast\tthat\teach\tbroker\tcan\thandle\thundreds\tof\tmegabytes of\tdata\tper\tsecond\tfrom\tseveral\tapplications.\tThat\tis\ta\tbold\tstatement.\tIn\tfact, Kafka\thas\tproved\tto\tbe\tmuch\tfaster\tthan\tthis\tin\tseveral\tsuccess\tstories.\tSo\tusing Kafka\tgives\tyou\tthis\tawesome\tperformance\tby\tdefault.\tWhat\tif\tthat\tis\tnot sufficient?\tThe\tanswer\tto\tthis\tquestion\tis\tscaling.\tKafka\tis\tbuilt\tin\tsuch\ta\tway that\tKafka\tconsumers\tor\tKafka\tStreams\tapplications\tcan\tbe\tscaled\tin\tsuch\ta\tway that\tthey\twork\ttogether\tas\ta\tgroup.\tThat's\twhere\tthe\tterm\t\"consumer\tgroup\" kicks\tin.\tA\tconsumer\tgroup\tis\ta\tgroup\tof\tconsumers\tthat\tshare\tthe\tsame\tID. Consumers\tin\ta\tconsumer\tgroup\tsubscribe\tto\tthe\tsame\ttopic(s);\thowever,\teach consumer\tgroup\tgets\tonly\tone\tcopy\tof\teach\tmessage\tproduced\tin\ta\ttopic.\tThis\tis how\tKafka\tachieves\tpoint-to-point\tbehavior\tusing\ttopics.\tInternally,\teach consumer\tin\tthe\tconsumer\tgroup\twill\tbe\tconsuming\tmessages\tfrom\tone dedicated\tpartition.\tThis\twill\tcontribute\tto\ta\tparallel\tprocessing\tbehavior.\n\nNote\n\nLet's\tconsider\ta\tsituation\twhere\tthere\tis\ta\ttopic\twith\ttwo\tpartitions\tand\tone consumer\tcalled\tconsumer-01.\tNow,\tconsumer-01\twill\tbe\tresponsible\tfor consuming\tmessages\tfrom\tpartition-00\tand\tpartition-01.\tThis\tis\treally\tnot going\tto\tgive\tus\tthe\tperformance\twe\texpect.\tSo\twe\thave\tto\tspin\toff\tanother consumer\twith\tthe\tsame\tgroup\tID\tso\tthat\twe\tcan\tconsume\tmessages\tfrom\tboth partitions\tin\tparallel.\tNow\tif\twe\tspin\toff\tconsumer\t-02,\tconsumer-01\twill consume\tmessages\tfrom\tpartition-00,\tand\tconsumer-02\twill\tconsume messages\tfrom\tpartition-01\t(or\tvice\tversa).\tNow\tlet's\tsay\tyou\tspin\toff\tanother consumer\tcalled\tconsumer-03.\tThis\ttime,\tit\tis\treally\tnot\tgoing\tto\timprove\tyour performance\tany\tfurther\tbecause\tat\tleast\tone\tconsumer\tis\tgoing\tto\tbe\tidle\tall\tthe time.\tConsumers\tdo\tnot\tshare\ttopic\tpartitions.\tKeep\tthis\tin\tmind\twhen\tyou\tbuild your\tapplications\tusing\tKafka.",
      "content_length": 1924,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 460,
      "content": "Getting\tready 1.\t Before\twe\tjump\tinto\tthe\trecipe,\tlet's\tdelete\tany\texisting\tgeolocations\tin\tthe data\tdirectory.\tExecute\tthe\tfollowing\tcommand\tin\ta\tnew\tterminal\tshell:\n\nrm\toptpackt/geolocation/data/*\n\n2.\t Now\tthat\tyou\thave\tcleaned\tup\tall\tthe\texisting\tgeolocations,\tmake\tsure\tyou have\tKafka\tup\tand\trunning.\tIf\tit\tis\tnot\trunning,\tstart\tit\tusing\tDocker Compose.\tIf\tit\tis\ta\tfresh\tinstallation,\tcreate\tthe\tgeolocations\tand geolocationStreams\ttopics.",
      "content_length": 443,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 461,
      "content": "How\tto\tdo\tit... 1.\t In\tthis\trecipe,\twe\twill\tbe\tspinning\toff\ttwo\tinstances\tof\tthe\tgeolocation application\tand\twill\tbe\tmonitoring\tthe\tlogs\tto\tsee\thow\tthe\tmessages\tare distributed.\tGo\tahead\tand\tstart\ttwo\tinstances\tof\tthe GeoLocationApplication,\tone\trunning\ton\tport\t8080\tand\tthe\tother\trunning on\tport\t8081.\tMake\tsure\tthere\tare\tno\terrors\tin\tyour\tconsole.\n\n2.\t Now\trun\tthe\tGeoLocationProducer\tclass\tas\ta\tJava\tapplication.\tThis\tshould have\tdropped\tthe\tnine\tgeolocations\tinto\tthe\tgeolocationStreams\ttopic.\n\n3.\t Let's\tsee\twhat\tthe\tconsole\tlooks\tlike\tfor\tboth\tthe\tinstances:\n\nThe\tpreceding\tscreenshot\tshows\tthe\tconsole\tlogs\tfrom\tthe\tfirst\tinstance\tof geolocation.\tAs\tyou\tcan\tsee,\tthe\tGeoLocationStreams\tapplication received\tfive\tmessages\tout\tof\tnine.\tAnd\tthe\tGeoLocationConsumer application\treceived\tthree\tout\tof\tthe\tfive\tmessages.\n\n4.\t Now\tlet's\ttake\ta\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tsecond\tinstance\tof\tthe geolocation\tmicroservice:\n\nAs\tyou\tcan\tsee,\tfour\tout\tof\tnine\tmessages\twere\treceived\tby\tthe GeoLocationStreams\tapplication.\tAnd\tthe\tGeoLocationConsumer application\treceived\ttwo\tout\tof\tthe\tfive\tmessages.\tThis\tdemonstrates\tthat the\tKafkaStreams\tand\tKafkaConsumer\tinstances\tscale\tas\tthe\tapplication scales-which\tis\tobviously\tgreat\tnews.\tBut\tthe\treal\tquestion\tis\thow?\tAlso, we\tdid\tnot\tcreate\tany\tconsumer\tgroups\tin\tthis\trecipe.\tIn\tfact,\twe\tactually created\ta\tconsumer\tgroup\tearlier.\n\n5.\t Now,\tgo\tback\tto\tyour\tconsumer\tclass,\tand\tyou\twill\tnotice\tthat\twe\tpassed\ta parameter\tcalled\tgroup.id\twith\tthe\tvalue\tgeolocationConsumer.",
      "content_length": 1516,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 462,
      "content": "Consumers\twith\tthe\tsame\tgroup.id\tproperty\twill\tbe\tin\tthe\tsame\tconsumer group.\tThat\tis\tthe\treason\tour\tGeoLocationConsumer\tapplication\twas scalable.\tSimilarly,\tthe\tStreamsConfig.APPLICATION_ID_CONFIG\tproperty in\tthe\tGeoLocationStreams\tclass\tdefines\tthe\tconsumer\tgroup\tID\tvalue.\tThe value\tof\tthis\tproperty\thas\tbeen\tset\tto\tgeolocation-application.\tSo\tany Kafka\tStreams\tapplication\tthat\thas\tthe\tconsumer\tgroup\tvalue\tset\tto geolocation-application\twill\tbe\tpart\tof\tthe\tsame\tconsumer\tgroup.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tto\tscale our\tKafka\tStreams\tapplication.\tKafka\tStreams\thas\ta\tlot\tmany\tmethods\tto\tbuild\ta complete\tdata\tpipeline,\tsuch\tas\tmap,\tflatMap,\tmapValues,\tflatMapValues,\tand filter.\tIt\tis\tstrongly\trecommended\tthat\tyou\tread\tthe\tdocumentation\tbefore\tyou start\tusing\tKafka\tStreams.\tIn\tfact,\tthere\tis\ta\tslightly\tdifferent\tapproach\tthat\tyou can\tuse\tin\tKafka\tStreams\tto\tbuild\tdata\tprocessors.\tTake\ta\tlook\tat TopologyBuilder\tand\tAbstractProcessor\tto\ttry\tthat\tapproach.\tI'll\tleave\tthat\tas an\texercise\tfor\tyou.",
      "content_length": 1048,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 463,
      "content": "Writing\ta\tstreaming\tprogram\tusing Apache\tSpark\n\nYou\tmight\tbe\twondering\twhat\tApache\tSpark\thas\tto\tdo\twith\tmicroservices.\tThe answer\tis\tpretty\tsimple:\tstreaming\tand\tdata\tprocessing.\tNot\tall\tmicroservices will\trequire\tstreaming,\tbut\tmost\tof\tthem\tthese\tdays\tdo.\n\nThere\tare\ttwo\tways\tyou\tcan\tfeed\tdata\tto\ta\tmicroservice:\tvia\tREST\tor\tmessage brokers.\tWith\tRESTful\tAPIs,\tyou\tcan\tachieve\tthe\tperformance\tyou\texpect.\tBut it\thas\tits\town\tlimitations,\twhich\tis\tthe\treason\tcompanies\tmove\ttowards\tmessage brokers\tsuch\tas\tKafka,\tRabbitMQ,\tand\tZeroMQ.\tUsing\tframeworks\tsuch\tas Kafka,\tyou\tcan\tachieve\ttremendous\tperformance\tand\tlive\tresults.\tIn\tfact,\ttoday's streaming\tis\tall\tabout\tlive\tresults.\tBefore\twe\tjump\tinto\tthe\trecipe,\tlet's\ttake\ta minute\tto\tunderstand\tSpark\tand\tsome\tof\tits\tconcepts.\n\nApache\tSpark\tis\ta\tfast\tdata-processing\tframework.\tIt\thas\tfour\tmajor\tmodules: Spark\tStreaming,\tSpark\tSQL,\tSpark\tMLlib,\tand\tSpark\tGraphx.\tSpark\tStreaming is\tused\tto\tstream\tdata\tfrom\tmessaging\tendpoints\tsuch\tas\tTCP\tSocket\tand\tKafka. Spark\tSQL\tis\tused\tto\texecute\tefficient\tqueries\ton\thuge\tstructured\tdatasets.\tSpark MLlib\tis\tSpark's\tmachine\tlearning\tlibrary.\tAt\tthe\ttime\tof\twriting\tthis,\tSpark MLlib\thas\tmatured\tso\tmuch\tthat\tit\tcan\tbe\tused\tfor\tany\tproduction-level\tuse case.\tSpark\tGraphx\tis\tSpark's\tgraph-processing\tAPI.\tIn\tthis\trecipe,\twe\twill\tbe streaming\tgeolocation\toff\tof\ta\tKafka\ttopic,\tfiltering\tbad\tgeolocations,\tand sending\tthe\tvalid\tgeolocations\tto\tanother\tKafka\ttopic.\tAt\tthe\tcore\tof\tApache Spark\tlies\tthe\tRDD\tAPI.\tRDD\tstands\tfor\tResilient\tDistributed\tDataset.\tIt\tis resilient\tbecause\twhen\tSpark\tjobs\tare\texecuted\tin\ta\tcluster,\teven\tif\ta\tnode\tgoes down\twhile\tprocessing\tan\tRDD,\tthe\tRDD\twill\tbe\thanded\tover\tto\tanother\tactive node\tin\tthe\tcluster.\tIt\tis\tdistributed\tbecause\tRDDs\tare\tdistributed\tacross\tnodes\tin the\tcluster.\tSpark's\tconfigurations\tlet\tyou\tallocate\tresources\tsuch\tas\tCPU\tand memory\tfor\tevery\tSpark\tjob.\tThis\tmakes\tSpark\twork\tvery\twell\twith\tclustering framework\tsuch\tas\tMesos\tand\tYARN.",
      "content_length": 1978,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 464,
      "content": "Getting\tready\n\nWriting\ta\tSpark\tjob\tis\tas\tsimple\tas\twriting\ta\tJava\tprogram.\tWith\tthe\tcurrent availability\tof\tdocumentation\ton\tthe\tInternet,\tit\tjust\ttakes\ta\tfew\tminutes\tto\twrite a\tSpark\tjob.\tThe\treal\ttricky\tpart\tis\tdeploying\tthe\tSpark\tjobs.\tThat's\twhere clustering\tframeworks\tsuch\tas\tMesos\tand\tYARN\tcome\tinto\tthe\tpicture.\tBut developing\ta\tSpark\tjob\tshouldn't\treally\trequire\ta\thuge\tcluster.\tThat's\tthe\treason Spark\tcame\tup\twith\ta\tSpark\tstandalone\tmode.\tThe\tstandalone\tmode\truns\tthe Spark\tjob\tin\tmemory.\tIn\tthis\trecipe,\twe\twill\tbe\texecuting\tour\tSpark\tjob\tin\tSpark standalone\tmode.\tWe\twill\tperform\tthe\tsame\tlogic\tthat\twe\tdid\tusing\tKafka Streams,\tonly\tthis\ttime\tusing\tApache\tSpark.\tThe\tfollowing\tdiagram\tshows\tthe flow\tof\tour\tcode:\n\nBefore\twe\tjump\tin,\tlet's\tclean\tup\tthe\tdata\tdirectory\tthat\twas\tpopulated\tby previous\trecipes:\n\n1.\t Execute\tthe\tfollowing\tcommand\tfrom\ta\tterminal\tshell:\n\nrm\toptpackt/geolocation/data/*",
      "content_length": 909,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 465,
      "content": "2.\t The\tnext\tstep\tis\tcreating\tthe\tgeolocationJob\ttopic.\tExecute\tthe\tfollowing script\tfrom\tKafka's\troot\tdirectory:\n\n./bin/kafka-topics.sh\t--create\t--topic\tgeolocationJob\t-- replication-factor\t1\t--partitions\t2\t--zookeeper\t 192.168.99.100:2181",
      "content_length": 240,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 466,
      "content": "How\tto\tdo\tit... 1.\t We\twill\tneed\tsome\tMaven\tdependencies\tto\twrite\ta\tSpark\tStreaming\n\nprogram.\tAdd\tthe\tfollowing\tthree\tdependencies\tto\tthe\tpom.xml\tfile\tof\tthe geolocation\tproject:\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-core_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-streaming_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n<dependency> \t\t<groupId>org.apache.spark</groupId> \t\t<artifactId>spark-streaming-kafka-0-10_2.11</artifactId> \t\t<version>2.0.2</version> </dependency>\n\n2.\t Let's\tright\taway\tcreate\tthe\tSpark\tjob.\tCreate\ta\tnew\tjava\tclass\tcalled com.packt.microservices.geolocation.GeoLocationJob.java\twith\tan empty\tmain\tmethod:\n\npackage\tcom.packt.microservices.geolocation;\n\npublic\tclass\tGeoLocationJob\t{\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows\tException\t{\n\n} }\n\n3.\t Writing\tthis\tSpark\tjob\tcan\tbe\tbroken\tdown\tinto\tmultiple\tlogical\tparts:\n\n1.\tCreating\ta\tstreaming\tcontext.\n\n2.\tCreating\ta\tdirect\tstream\ton\tthe\tgeolocationJob\ttopic.\n\n3.\tConverting\tstring\tvalues\tto\tGeoLocation\tobjects.\n\n4.\tFiltering\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude.",
      "content_length": 1191,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 467,
      "content": "4.\tFiltering\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude.\n\n5.\tSending\tvalid\tgeolocations\tto\tthe\tgeolocations\ttopic.\n\n6.\tStarting\tthe\tcontext\tand\tawait\ttermination.\n\n4.\t Let's\tmove\ton\tto\tthe\tfirst\tstep,\twhere\twe\twill\tcreate\tthe\tstreaming\tcontext. Add\tthe\tfollowing\tsnippet\tto\tthe\tmain\tmethod:\n\nSparkConf\tconf\t=\tnew SparkConf().setAppName(\"geolocationJob\").setMaster(\"local[1]\"); JavaStreamingContext\tcontext\t=\tnew\tJavaStreamingContext(conf, new\tDuration(2000));\n\nAs\tyou\tcan\tsee,\tthe\tapp\tname\tis\tset\tto\tgeolocationJob\tand\tthe\tmaster\tis\tset to\tlocal[1].\tThis\tsays\tthat\twe\twill\tbe\tusing\tstandalone\tmode\tand\tour Spark\tjob\twill\tuse\t1\tthread.\tThe\tJavaStreamingContext\tconstructor instance\ttakes\ttwo\targuments:\tSparkConf\tand\tDuration.\tDuration\tis\tused to\tsay\thow\tfrequently\tthe\tmicro-batches\tshould\tbe\tcreated\tand\tprocessed.\n\n5.\t The\tnext\tstep\tin\tcreating\tour\tSpark\tjob\tis\tcreating\ta\tdirect\tstream\ton\tthe geolocationJob\ttopic.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tmain()\tmethod:\n\nMap<String,\tObject>\tkafkaParams\t=\tnew\tHashMap<>(); kafkaParams.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); kafkaParams.put(\"key.deserializer\",\tStringDeserializer.class); kafkaParams.put(\"value.deserializer\", StringDeserializer.class); kafkaParams.put(\"group.id\",\t\"geolocationJob\"); kafkaParams.put(\"auto.offset.reset\",\t\"latest\"); kafkaParams.put(\"enable.auto.commit\",\tfalse);\n\nCollection<String>\ttopics\t=\tArrays.asList(\"geolocationJob\");\n\nfinal\tJavaInputDStream<ConsumerRecord<String,\tString>>\tdstream =\tKafkaUtils.createDirectStream \t\t\t\t(context, \t\t\t\tLocationStrategies.PreferConsistent(), \t\t\t\t\t\tConsumerStrategies.<String,\tString>Subscribe(topics, kafkaParams));\n\nYou\tshould\tbe\tfamiliar\twith\tmost\tof\tthe\tKafka\tparameters.\tTo\tlearn more\tabout\tthe\tproperties,\trefer\tto\tthe\tKafka\tdocumentation\tat https://kafka.apache.org/documentation/#newconsumerconfigs\t. We\tthen\tcreate\ta\tcollection\tof\ttopics.\tHere,\twe\thave\tused\tthe\ttopic",
      "content_length": 1902,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 468,
      "content": "name\tgeolocationJob,\tfrom\twhich\twe\twill\tbe\tstreaming\tour\tmessages off\tof.\tFinally,\twe\tcreate\ta\tdirect\tstream\t(DStream)\tfrom\tthe\tcontext, topics,\tand\tKafka\tparameters.\tThe\tLocationStrategy\tidentifies\thow our\tpartitions\twill\tbe\tdistributed\tacross\texecutors.\tConsumerStrategy helps\tSpark\tobtain\tthe\tright\tconsumers.\tThe\tsubscribe\tconsumer strategy\tis\tused\tfor\tspecific\ttopic\tnames,\tlike\tin\tour\tcase.\tThe preceding\tsnippet\twill\tcreate\ta\tdirect\tstream\tthat\twill\tstream\tmessages from\tthe\tgeolocationJob\ttopic.\n\n6.\t Let's\tmove\ton\tto\tthe\tnext\tstep:\tconverting\tstring\tvalues\tto\tthe\tGeoLocation objects\tin\tConsumerRecord.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tmain() method:\n\ndstream.map(new\tFunction<ConsumerRecord<String,String>, GeoLocation>()\t{\t//\tmap\tto\tGeoLocation \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -5289370913799710097L;\n\n@Override \t\tpublic\tGeoLocation\tcall(ConsumerRecord<String,\tString> record)\tthrows\tException\t{ \t\t\t\treturn\tnew\tGson().fromJson(record.value(), GeoLocation.class); \t\t\t\t\t\t} })\n\nThis\tsnippet\tconverts\tthe\tstring\tvalues\tfrom\tConsumerRecord\tto\tthe GeoLocation\tobjects\tusing\tGSON.\tAs\tyou\tcan\tsee,\twe\thave\tused\tan anonymous\tinner\tclass\tof org.apache.spark.api.java.function.Function.\n\n7.\t Let's\tmove\ton\tto\tthe\tnext\tstep,\twhere\twe\twill\tbe\tfiltering\tgeolocations\twith invalid\tlatitude\tand\tlongitude\tvalues.\tAppend\tthe\tfollowing\tsnippet\tto\tthe previous\tline: .filter(new\tFunction<GeoLocation,\tBoolean>()\t{\t//\tfilter\tout invalid\tgeolocations \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= 6980980875802694946L;\n\n@Override \t\tpublic\tBoolean\tcall(GeoLocation\tgeolocation)\tthrows\tException { \t\t\t\tSystem.out.println(\"Spark\tJob\treceived\t=>\t\"\t+\tgeolocation); \t\t\t\treturn\tgeolocation.getLatitude()\t>=\t-90",
      "content_length": 1708,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 469,
      "content": "return\tgeolocation.getLatitude()\t>=\t-90 \t\t\t\t\t\t\t\t&&\tgeolocation.getLatitude()\t<\t90 \t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t>=\t-180 \t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t<\t180; \t\t} })\n\nThat\tpreceding\tsnippet\tmakes\tuse\tof\tFunction\tthat\twill\tact\tas\ta\tpredicate\tto filter\tout\tgeolocations\twith\tinvalid\tlatitude\tand\tlongitude\tvalues.\n\n8.\t The\tnext\tstep\tinvolves\twriting\tour\tvalid\tgeolocations\tto\tthe\tgeolocations Kafka\ttopic.\tAppend\tthe\tfollowing\tsnippet\tto\tthe\tprevious\tline\tof\tcode:\n\n.foreachRDD(new\tVoidFunction<JavaRDD<GeoLocation>>()\t{ //iterate\tover\tRDD \t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -4161320579495422870L;\n\n@Override \t\tpublic\tvoid\tcall(JavaRDD<GeoLocation>\trdd)\tthrows\tException\t{ \t\t\t\trdd.foreach(new\tVoidFunction<GeoLocation>()\t{\t\t//\tsend valid\tgeolocations\tto\tanother\ttopic \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -3282778715126743482L;\n\n@Override \t\t\t\t\t\tpublic\tvoid\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\t\t\tgetProducer().send(record); \t\t\t\t\t\t} \t\t\t\t}); \t\t} });\n\nWe\tare\tusing\tthe\tforeachRDD()\tmethod\tto\titerate\tover\tthe\tRDDs.\tThen,\twe grab\tthe\tgeolocations\tfrom\teach\tRDD\tusing\tthe\tforeach()\tmethod.\tIn\tboth these\tcases,\twe\thave\tcreated\tanonymous\tinner\tclasses\tfor org.apache.spark.api.java.function.VoidFunction.\tFinally,\twe\tcreate a\tProducerRecord\tand\tsend\tit\tto\tthe\tgeolocaitons\ttopic\tusing KafkaProducer.\tWe\twill\tsee\thow\tthe\tgetProducer()\tmethod\tis implemented\tlater.",
      "content_length": 1547,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 470,
      "content": "Note\n\nIf\tyou\tare\twondering\twhether\tSpark\tsupports\tan\toperation\twhere\tit\tcan drop\tmessages\tonto\ta\tKafka\ttopic,\tthen\tthe\tanswer\tis\tno.\tCurrently,\tSpark does\tnot\thave\tthat\tsupport\tout\tof\tthe\tbox.\tBut\tthere\tare\tthird-party\tlibraries that\tcan\tdrop\tmessages\tonto\ta\tKafka\ttopic\twithout\tyou\thaving\tto\tcreate your\town\tKafka\tproducer.\n\n9.\t The\tfinal\tstep\tis\tstarting\tthe\tcontext\tand\tawaiting\ttermination.\tIn\tthis\tstep, we\twill\tcall\tthe\tstart()and\tawaitTermination()\tmethods\tof\tthe JavaStreamingContext\tinstance\tso\tthat\twe\tcan\tindefinitely\tlisten\tfor\tany new\tmessages\ton\tthe\tgeolocationJob\ttopic:\n\ncontext.start(); context.awaitTermination();\n\n10.\t The\tKafkaProducer\twas\tearlier\tobtained\tusing\tthe\tgetProducer()\tmethod. Let's\tsee\thow\tthis\tmethod\tlooks.\tAdd\tthe\tfollowing\tsnippet\tto\tthe GeoLocationJob.java\tclass:\n\npublic\tstatic\tProducer<String,\tString>\tproducer;\n\npublic\tstatic\tProducer<String,\tString>\tgetProducer()\t{ if(producer\t==\tnull)\t{ \t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName());\n\nproducer\t=\tnew\tKafkaProducer<>(props); \t\t} \t\treturn\tproducer; }\n\n11.\t That\twas\tthe\tlast\tstep.\tThe\tfinal\tGeoLocationJob\tclass\twill\tlook\tsomething like\tthis:\n\npackage\tcom.packt.microservices.geolocation;\n\nimport\tjava.util.Arrays; import\tjava.util.Collection; import\tjava.util.HashMap; import\tjava.util.Map;",
      "content_length": 1472,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 471,
      "content": "import\tjava.util.Map; import\tjava.util.Properties;\n\nimport\torg.apache.kafka.clients.consumer.ConsumerRecord; import\torg.apache.kafka.clients.producer.KafkaProducer; import\torg.apache.kafka.clients.producer.Producer; import\torg.apache.kafka.clients.producer.ProducerRecord; import org.apache.kafka.common.serialization.StringDeserializer; import\torg.apache.kafka.common.serialization.StringSerializer; import\torg.apache.spark.SparkConf; import\torg.apache.spark.api.java.JavaRDD; import\torg.apache.spark.api.java.function.Function; import\torg.apache.spark.api.java.function.VoidFunction; import\torg.apache.spark.streaming.Duration; import\torg.apache.spark.streaming.api.java.JavaInputDStream; import org.apache.spark.streaming.api.java.JavaStreamingContext; import\torg.apache.spark.streaming.kafka010.ConsumerStrategies; import\torg.apache.spark.streaming.kafka010.KafkaUtils; import\torg.apache.spark.streaming.kafka010.LocationStrategies;\n\nimport\tcom.google.gson.Gson;\n\npublic\tclass\tGeoLocationJob\t{\n\npublic\tstatic\tProducer<String,\tString>\tproducer;\n\npublic\tstatic\tvoid\tmain(String[]\targs)\tthrows\tException\t{ \t\t\t\tSparkConf\tconf\t=\tnew SparkConf().setAppName(\"geolocationJob\").setMaster(\"local[1]\"); \t\t\t\tJavaStreamingContext\tcontext\t=\tnew JavaStreamingContext(conf,\tnew\tDuration(2000));\n\nMap<String,\tObject>\tkafkaParams\t=\tnew\tHashMap<>(); \t\t\t\tkafkaParams.put(\"bootstrap.servers\", \"192.168.99.100:9092\"); \t\t\t\tkafkaParams.put(\"key.deserializer\", StringDeserializer.class); \t\t\t\tkafkaParams.put(\"value.deserializer\", StringDeserializer.class); \t\t\t\tkafkaParams.put(\"group.id\",\t\"geolocationJob\"); \t\t\t\tkafkaParams.put(\"auto.offset.reset\",\t\"latest\"); \t\t\t\tkafkaParams.put(\"enable.auto.commit\",\tfalse);\n\nCollection<String>\ttopics\t= Arrays.asList(\"geolocationJob\");",
      "content_length": 1750,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 472,
      "content": "final\tJavaInputDStream<ConsumerRecord<String,\tString>> dstream\t=\tKafkaUtils.createDirectStream \t\t\t\t\t\t\t\t\t(context, \t\t\t\t\t\t\t\tLocationStrategies.PreferConsistent(), \t\t\t\t\t\t\t\tConsumerStrategies.<String,\tString>Subscribe(topics, kafkaParams));\n\ndstream.map(new\tFunction<ConsumerRecord<String,String>, GeoLocation>()\t{\t//\tmap\tto\tGeoLocation \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -5289370913799710097L;\n\n@Override \t\t\t\t\t\tpublic\tGeoLocation\tcall(ConsumerRecord<String,\tString> record)\tthrows\tException\t{ \t\t\t\t\t\t\t\treturn\tnew\tGson().fromJson(record.value(), GeoLocation.class); \t\t\t\t\t\t} \t\t\t\t}).filter(new\tFunction<GeoLocation,\tBoolean>()\t{\t//\tfilter out\tinvalid\tgeolocations \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= 6980980875802694946L;\n\n@Override \t\t\t\t\t\tpublic\tBoolean\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\tSystem.out.println(\"Spark\tJob\treceived\t=>\t\"\t+ geolocation); \t\t\t\t\t\t\t\treturn\tgeolocation.getLatitude()\t>=\t-90 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLatitude()\t<\t90 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t>=\t-180 \t\t\t\t\t\t\t\t\t\t\t\t&&\tgeolocation.getLongitude()\t<\t180; \t\t\t\t\t\t} \t\t\t\t}).foreachRDD(new\tVoidFunction<JavaRDD<GeoLocation>>()\t{ //iterate\tover\tRDD \t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -4161320579495422870L;\n\n@Override \t\t\t\t\t\tpublic\tvoid\tcall(JavaRDD<GeoLocation>\trdd)\tthrows Exception\t{ \t\t\t\t\t\t\t\trdd.foreach(new\tVoidFunction<GeoLocation>()\t{\t\t//\tsend valid\tgeolocations\tto\tanother\ttopic \t\t\t\t\t\t\t\t\t\tprivate\tstatic\tfinal\tlong\tserialVersionUID\t= -3282778715126743482L;\n\n@Override",
      "content_length": 1516,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 473,
      "content": "@Override \t\t\t\t\t\t\t\t\t\tpublic\tvoid\tcall(GeoLocation\tgeolocation)\tthrows Exception\t{ \t\t\t\t\t\t\t\t\t\t\t\tProducerRecord<String,\tString>\trecord\t=\tnew ProducerRecord<>( \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"geolocations\", \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tgeolocation.toString()); \t\t\t\t\t\t\t\t\t\t\t\tgetProducer().send(record); \t\t\t\t\t\t\t\t\t\t} \t\t\t\t\t\t\t\t}); \t\t\t\t\t\t} \t\t\t\t});\n\ncontext.start(); \t\t\t\tcontext.awaitTermination(); \t\t}\n\npublic\tstatic\tProducer<String,\tString>\tgetProducer()\t{ \t\t\t\tif(producer\t==\tnull)\t{ \t\t\t\t\t\tProperties\tprops\t=\tnew\tProperties(); \t\t\t\t\t\tprops.put(\"bootstrap.servers\",\t\"192.168.99.100:9092\"); \t\t\t\t\t\tprops.put(\"key.serializer\", StringSerializer.class.getName()); \t\t\t\t\t\tprops.put(\"value.serializer\", StringSerializer.class.getName());\n\nproducer\t=\tnew\tKafkaProducer<>(props); \t\t\t\t} \t\t\t\treturn\tproducer; \t\t} }\n\n12.\t Without\tfurther\tado,\tlet's\ttest\tthis\tout.\tStart\tthe\tgeolocation\tmicroservice\ton port\t8080.\tThis\twill\tstart\tthe\tGeoLocationStreams\tas\twell\tas\tthe GeoLocationConsumer.\tNow\trun\tthe\tGeoLocationJob\tclass\tas\ta\tJava application.\tAfter\tboth\tthe\tgeolocation\tmicroservice\tand\tthe\tSpark\tjob\thave started\tsuccessfully,\tdrop\tsome\tmessages\ton\tthe\tgeolocationJob\ttopic.\tWe will\tbe\tutilizing\tthe\tGeoLocationProducer\tclass\tto\tdo\tthis.\tModify\tthe GeoLocationProducer\tclass\tto\tuse\tthe\tgeolocationJob\ttopic,\tand\texecute it\tas\ta\tJava\tapplication.\tThis\tshould\thave\tcreated\tnine\tgeolocations\ton\tthe geolocationJob\ttopic.\n\n13.\t Let's\ttake\ta\tlook\tat\tthe\tconsole\tlogs\tof\tthe\tSpark\tjob\tfirst:",
      "content_length": 1433,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 474,
      "content": "As\tyou\tcan\tsee,\tour\tSpark\tjob\treceived\tall\tthe\tmessages.\tThe\tpreceding screenshot\tdoes\tnot\tshow\tthem\tall,\tthough.\n\n14.\t Now\tlet's\ttake\ta\tlook\tat\tthe\tlog\tmessages\tof\tthe\tgeolocation\tmicroservice:\n\nAs\tyou\tcan\tsee,\tGeoLocationConsumer\treceived\tall\tthe\tgeolocations\twith valid\tlatitude\tand\tlongitude.\n\n15.\t Let's\tquickly\tverify\tthe\tdata\tdirectory.\tExecute\tthe\tfollowing\tcommands\tto list\tthe\tcontents\tof\tthe\tdata\tdirectory:\n\nls\t-1\toptpackt/geolocation/data user2288ea0c-e3e7-453c-a31c-935210195df3_t1482514513790 user3669998e-b114-4714-813d-f8adf9cf4a12_t1482514513790 user45cd0dc9-df2e-4ec9-8f40-4cdd88f7e493_t1482514513790 user6beedc41-284a-4a6a-9e9c-5434768936a0_t1482514513790 usercaabf873-73b6-446d-a02d-c42ecce35d1b_t1482514513790\n\nAwesome!\tWe\thave\tcreated\tour\tfirst\tSpark\tjob.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis",
      "content_length": 812,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 475,
      "content": "Awesome!\tWe\thave\tcreated\tour\tfirst\tSpark\tjob.\tThat\tbrings\tus\tto\tthe\tend\tof\tthis recipe.\tSpark\thas\tso\tmuch\tto\toffer\tthat\tit\tcan\tbe\tapplied\tin\ta\tlot\tof\tuse\tcases. What\twe\tlearned\tin\tthis\trecipe\twas\tjust\tthe\tbeginning\tof\tSpark.\tIt\tis\tstrongly recommended\tthat\tyour\tlearn\tSpark\tbefore\tyou\ttry\tit\tout.\tIn\tfact,\tSpark's\tofficial documentation\tis\tvery\tdescriptive\tand\tuseful.",
      "content_length": 368,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 476,
      "content": "Improving\tthe\tperformance\tof\tthe Spark\tjob\n\nIn\tthe\tprevious\trecipe,\twe\twrote\ta\tsimple\tSpark\tjob\tthat\tfilters\tout\tinvalid geolocations\tand\tpushes\tthe\tvalid\tgeolocations\tinto\ta\tKafka\ttopic.\tIn\tthis\trecipe, we\twill\tsee\thow\twe\tcan\timprove\tthe\tperformance\tof\tour\tSpark\tjob.",
      "content_length": 268,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 477,
      "content": "How\tto\tdo\tit...\n\nThere\tare\tseveral\tways\tin\twhich\tyou\tcan\timprove\tthe\tperformance\tof\tyour\tSpark job.\tThere\tare\ta\tlot\tmany\tconfigurations\tthat\tSpark\tprovides\tthat\tcan\tbe\ttweaked to\tachieve\tdesired\tperformance.\tFor\texample,\tbased\ton\tthe\tamount\tof\tdata\tthat your\ttopic\treceives,\tyou\tcould\tchange\tthe\tbatch\tduration\tof\tyour\tstream.\tAlso, deploying\tyour\tSpark\tjob\ton\ta\tMesos\tor\tYARN\tcluster\topens\tup\ta\tlot\tof opportunities\tfor\tperformance\timprovement.\tIn\tfact,\trunning\tyour\tSpark\tjob\tin local\tstandalone\tmode\twill\tnot\thelp\tyou\tassess\tthe\tperformance\tof\tyour\tSpark job.\tThe\treal\ttest\tfor\ta\tSpark\tjob\tis\twhen\tit\tis\texecuted\ton\ta\tcluster.\tEach\tSpark job\trequires\ta\tcertain\tamount\tof\tresources\tfor\texecution,\tbe\tit\tCPU\tor\tmemory.\n\nEarlier\tin\tthe\tbook,\twe\ttalked\tabout\tfine-grained\tand\tcoarse-grained\tmodes\tand how\tSpark\tutilizes\tthe\tresources\tin\tboth\tthese\tmodes.\tLikewise,\tthere\tare\tseveral other\tconfigurations\tthat\tcan\tbe\ttweaked\tto\tachieve\tthe\tdesired\tperformance.\n\nNow\tthat\twe\tare\ttalking\tabout\tdeployments,\tlet's\ttalk\tabout\twhether\tor\tnot\tthe Spark\tjob\tshould\tcoexist\talongside\tthe\tmicroservice.\tSpark\tjobs\tare\tbest executed\twithout\tother\tdependencies.\tSo\tit\tis\talways\tbetter\tto\trun\tthe\tSpark\tjob as\ta\tseparate\tdeployment.\tWhile\tthe\tGeoLocationJob\tclass\tcould\trun\ton\tMesos or\tYARN\tas\tits\town\ttask,\tthe\tgeolocation\tmicroservice\twill\trun\tas\ta\tDocker container\tin\tMarathon\tor\tYARN.\tSo\twe\thave\ttwo\tcomponents\tnow:\tAPI\tand Spark\tjob.\tThe\tSpark\tjob\tsends\tdata\tto\tthe\tAPI\tvia\ta\tKafka\ttopic.\tNow\tdo\tyou see\tthe\tvalue\tof\tKafka?\tMaking\tyour\tSpark\tjob\tsend\tdata\tvia\tthe\tAPI\twill\tslow down\tyour\tSpark\tjob.\tThat\tis\tthe\treason\twe\tchose\tto\tconsume\tmessages\tvia Kafka\ttopics\tin\tour\tgeolocation\tmicroservice.\n\nMost\tof\tthe\ttime,\tyou\tcan\tlook\tat\thow\tyour\tjob\tis\tperforming\tusing\tthe\tSpark web\tconsole\tat\thttp://localhost:4040.\tYou\tshould\tsee\tsomething\tlike\tthis:",
      "content_length": 1839,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 478,
      "content": "As\tyou\tcan\tsee,\tthe\tSpark\tJobs\tpage\tshows\ta\thigh-level\tmetric\tfor\teach operation\tin\tour\tSpark\tjob.\tIn\tthe\tpreceding\tscreenshot,\tit\tshows\tmetrics\tfor\tthe foreach\toperations\tin\tour\tSpark\tjob.\tClicking\ton\teach\tforeach\tjob\twill\tshow more\tdetails\tabout\tit,\tsuch\tas\tEvent\tTimeline\tand\tDAG\tvisualization.\tNow\tlet's take\ta\tquick\tlook\tat\tthe\tStreaming\ttab:",
      "content_length": 347,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 479,
      "content": "The\tStreaming\ttab\tprovides\tbetter\tinsights\tinto\tthe\tstreaming\tframework.\tThe current\tversion\tof\tSpark\tprovides\tmetrics\tsuch\tas\tInput\tRate,\tScheduling Delay,\tProcessing\tTime,\tand\tTotal\tDelay.\tThough\tthere\tis\tnot\tmuch\tdata\tto make\tsense\tout\tof\tthese\tcharts\tand\thistograms\tin\tour\tuse\tcase,\twhen\tyou\tare dealing\twith\thuge\tdatasets,\tthese\tmonitoring\ttools\twill\tbe\tvery\tuseful.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tAs\talready\tmentioned,\tApache\tSpark\tis\ta huge\tlibrary\tand\tit\ttakes\ttime\tto\tmaster\tit.\tI\tstrongly\trecommend\tthat\tyou\tread about\tit\tfrom\ttheir\tdocumentation\tbefore\tusing\tit.",
      "content_length": 585,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 480,
      "content": "Aggregating\tlogs\tinto\tKafka\tusing Log4J\n\nLog\tmanagement\tis\ta\tcritical\tpart\tof\tany\tmicroservice\tdeployment.\tWhen\tit comes\tto\tdebugging\tyour\tapplication,\tthe\ttwo\tthings\tthat\tmatter\ta\tlot\tare\tlogs and\tmetrics.\tWe've\talready\tlearned\thow\tto\tuse\tmetrics\tto\tmonitor\tour application,\tand\tin\tthis\trecipe,\twe\twill\tlearn\thow\tto\tconsolidate\tour\tlogs.\tLogs can\tbe\tstored\tin\tplenty\tof\tstores.\tIn\tthis\trecipe,\twe\twill\tlook\tat\thow\tto\tstore\tour logs\tin\ta\tKafka\ttopic.\tOnce\twe\tget\tour\tlog\tmessages\tin\ta\tKafka\ttopic,\twe\tcan use\tLog\tManagement\ttools\tto\tmake\tsome\tsense\tout\tof\tit.",
      "content_length": 559,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 481,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\tconfiguring\tthe\tgeolocation\tmicroservice\tto\tsend\tlog messages\tover\tto\ta\tKafka\ttopic\tcalled\tgeolocationLogs.\n\nLet's\tget\tready\tby\tcreating\tthe\ttopic\tin\tKafka.\tIf\tyou\tdon't\thave\tKafka\tup\tand running,\trun\tit\tusing\tDocker\tCompose.\n\nOpen\ta\tnew\tterminal\tshell\tand\tnavigate\tto\tthe\thome\tdirectory\tof\tKafka.\tExecute the\tfollowing\tcommand:\n\n./bin/kafka-topics.sh\t--create\t--topic\tgeolocationLogs\t-- replication-factor\t1\t--partitions\t1\t--zookeeper\t192.168.99.100:2181",
      "content_length": 497,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 482,
      "content": "How\tto\tdo\tit...\n\nThe\teasiest\tway\tto\tsend\tour\tlog\tmessages\tto\tKafka\tis\tusing\ta\tlog\tappender.\tA log\tappender\tis\ta\tutility\tin\tany\tlogging\tframework\tthat\tknows\thow\tto\tsend messages\tto\ta\tspecific\tdestination.\tSimilarly,\ta\tKafka\tappender\tknows\thow\tto send\tlog\tmessages\tto\ta\tKafka\ttopic.\tTo\tmake\tit\tsimpler,\tlet's\ttry\tto\tuse\tthe underlying\tlogging\tframework\tof\tSpring\tBoot.\tBy\tdefault,\tSpring\tBoot\tuses logback.\tAt\tthe\ttime\tof\twriting\tthis,\tit\tis\tnot\tvery\teasy\tto\tconfigure\tlogback\twith a\tKafka\tappender.\tBut\tLog4J2\tcomes\twith\ta\tKafka\tappender\tout\tof\tthe\tbox. Let's\tsee\thow\tto\tuse\tKafka\tappender\twith\tLog4J2\tin\tour\tSpring\tBoot\tapp.\tIf\tyou are\tnot\tusing\ta\tSpring\tBoot\tapp,\tthen\tit\tis\treal\tsimple.\tAll\tyou\thave\tto\tdo\tis\tadd the\tlog4j2\tdependency\tand\tstart\tconfiguring\tthe\tKafka\tappender.\tHowever,\tin this\trecipe,\twe\twill\tbe\tlearning\thow\tto\tdo\tit\ton\ta\tSpring\tBoot\tapp\tas\tit\tis\ta\tlittle tricky.\n\n1.\t The\tfirst\tthing\twe\tneed\tto\tdo\tis\tconfigure\tour\tapp\tto\tuse\tLog4J2\tinstead\tof Logback.\tAdd\tthe\tfollowing\ttwo\tdependencies\tto\tthe\tpom.xml\tfile\tof\tthe geolocation\tproject: <dependency> \t\t<groupId>org.springframework.boot</groupId> \t\t<artifactId>spring-boot-starter</artifactId> \t\t<exclusions> \t\t\t\t<exclusion> \t\t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t\t<artifactId>spring-boot-starter-logging</artifactId> \t\t\t\t</exclusion> \t\t</exclusions> </dependency>\n\n<dependency> \t\t\t\t\t<groupId>org.springframework.boot</groupId> \t\t\t\t\t<artifactId>spring-boot-starter-log4j2</artifactId> </dependency>\n\nAs\tyou\tcan\tsee,\twe\thave\texcluded\tthe\tbasic\tspring-boot-starter- logging\tdependency\tand\tadded\tthe\tspring-boot-starter-log4j2 dependency.\tThis\twill\tintroduce\tlog4j2\tinto\tthe\tproject.\n\n2.\t The\tSpark\tdependencies\tusually\thave\tslf4j-log4j12\tbindings.\tIn\torder\tto use\tlog4j2\twe\tneed\tto\tremove\tthe\tslf4j-log4j12\tbindings.\tGo\tahead\tand exclude\tthis\tartifact\tfrom\tkafka-streams,\tspark-core_2.11\tand\tspark-",
      "content_length": 1881,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 483,
      "content": "streaming-kafka-0-10_2.11:\n\n<dependency> \t\t\t<groupId>org.apache.kafka</groupId> \t\t\t<artifactId>kafka-streams</artifactId> \t\t\t<version>0.10.1.0</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n<dependency> \t\t\t<groupId>org.apache.spark</groupId> \t\t\t<artifactId>spark-core_2.11</artifactId> \t\t\t<version>2.0.2</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n<dependency> \t\t\t<groupId>org.apache.spark</groupId> \t\t\t<artifactId>spark-streaming-kafka-0-10_2.11</artifactId> \t\t\t<version>2.0.2</version> \t\t\t<exclusions> \t\t\t\t\t\t\t\t\t<exclusion> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<groupId>org.slf4j</groupId> \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<artifactId>slf4j-log4j12</artifactId> \t\t\t\t\t\t\t\t\t</exclusion> \t\t\t</exclusions> </dependency>\n\n3.\t Now\tlet's\tadd\tthe\tlog4j2.xml\tconfig\tfile\tto\tthe\tsrc/main/resources directory.\tAdd\tthe\tfollowing\tsnippet\tto\tthe\tlog4j2.xml\tfile:\n\n<?xml\tversion=\"1.0\"\tencoding=\"UTF-8\"?>\t <Configuration\tstatus=\"INFO\">\t \t\t<Appenders>\t \t\t\t\t<Console\tname=\"Console\"\ttarget=\"SYSTEM_OUT\">\t \t\t\t\t\t\t<PatternLayout\tpattern=\"%d{HH:mm:ss.SSS}\t[%t]\t%-5level",
      "content_length": 1313,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 484,
      "content": "%logger{36}\t-\t%msg%n\"\t>\t \t\t\t\t<Console>\t \t\t\t\t<Kafka\tname=\"Kafka\"\ttopic=\"geolocationLogs\">\t \t\t\t\t\t\t<PatternLayout\tpattern=\"%date\t%message\"\t>\t \t\t\t\t\t\t<Property\t name=\"bootstrap.servers\">192.168.99.100:9092<Property>\t \t\t\t\t</Kafka>\t \t\t</Appenders>\n\n<Loggers>\t \t\t\t\t<Root\tlevel=\"INFO\">\t \t\t\t\t\t\t<AppenderRef\tref=\"Console\"\t/>\t \t\t\t\t\t\t<AppenderRef\tref=\"Kafka\"\t>\t \t\t\t\t<Root>\t \t\t\t\t<Logger\tname=\"org.apache.kafka\"\tlevel=\"ERROR\"\t>\t<!--\tavoid\t recursive\tlogging\t-->\t \t\t\t\t<Loggers>\t </Configuration>\n\n4.\t The\tconfiguration\tis\tpretty\tstraightforward.\tAll\twe\thave\tto\tdo\tis\tadd\tthe Kafka\tappender\tand\tdefine\tthe\tbootstrap.servers\tproperty\twith\tthe\tKafka broker\tURL.\tThe\tlogger\tfor\tthe\torg.apache.kafka\tpackage\tis\tset\tto\tERROR to\tmake\tsure\twe\tavoid\trecursive\tlogging.\n\nThat's\tit!\tWe\thave\tconfigured\ta\tKafka\tappender\tfor\tLog4J2\tto\tsend\tour\tlog messages\tto\tthe\tgeolocationLogs\tKafka\ttopic.\tWe\tare\tnow\tready\tto\ttest\tthis out.\tIn\torder\tto\tdo\tso,\twe\tneed\ta\tKafka\tconsumer\tthat\tcan\tconsume\tmessages from\tthe\tgeolocationLogs\ttopic.\tLet's\tutilize\tthe\tcommand-line\tconsole consumer\tto\tperform\tthis\ttask.\tOpen\tup\ta\tnew\tterminal\twindow\tand\tnavigate\tto the\thome\tfolder\tof\tyour\tKafka\tinstallation.\tExecute\tthe\tfollowing\tcommand:\n\n./bin/kafka-console-consumer.sh\t--topic\tgeolocationLogs\t--zookeeper\t 192.168.99.100:2181\n\nNow\tthat\tour\tconsumer\tis\tready,\tlet's\tstart\tthe\tgeolocation\tmicroservice\tas\ta Spring\tBoot\tapplication\tand\tkeep\tan\teye\ton\tthe\tconsumer\tlogs:",
      "content_length": 1422,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 485,
      "content": "As\tyou\tcan\tsee,\tall\tour\tlog\tmessages\tare\tnow\tdirected\tto\tthe\tgeolocationLogs topic\tin\taddition\tto\tthe\tconsole.\tNow,\tit\tis\tup\tto\tus\tto\tuse\tthese\tlog\tmessages\tin the\ttool\tof\tour\tchoice.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tGood\tluck\tlogging\twith\tKafka!",
      "content_length": 256,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 486,
      "content": "Integrating\tKafka\twith\tlog management\tsystems\n\nIn\tthe\tprevious\trecipe,\twe\tlearned\thow\tto\tconsolidate\tlog\tmessages\tfrom microservices\tinto\ta\tKafka\ttopic\tusing\tLog4J2\tand\tKafka.\tIn\tthis\trecipe,\twe\twill look\tat\tvarious\toptions\tthat\twe\thave\tto\tvisualize\tour\tlogs.\tThere\tare\tseveral\tlog- management\tsystems\tavailable\tin\tthe\tmarket\tat\tthe\tmoment.\tWe\twill\ttalk\tabout few\tof\tthem\tin\tthis\trecipe.",
      "content_length": 387,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 487,
      "content": "How\tit\tworks...\n\nThere\tare\tseveral\tlog-management\ttools,\tsuch\tas\tSplunk,\tGraylog2,\tand\tLoggly. Most\tof\tthem\tnowadays\tcome\twith\ta\tKafka\tlistener.\tHowever,\tat\tthe\ttime\tof writing\tthis,\tSplunk\tdoes\tnot\thave\tan\tofficial\tKafka\tconsumer.\tThere\tare\tseveral third-partly\tplugins\tthat\tyou\tcan\tinstall\twith\tSplunk\tto\tconsume\tmessages\tfrom Kafka\ttopics.Graylog2\tis\tanother\tpopular\tlog-management\ttool\tthat\thas\tpicked up\ttraction\tlately\tmostly\tbecause\tit\tis\topen\tsource.\tIt\tcomes\tpacked\twith\ttons\tof features.\tThough\tthe\tinterface\tis\tnot\tvery\tsophisticated,\tit\tgets\tthe\tjob\tdone\twell. Graylog\tcame\twith\ttheir\town\tlog\tformat\tcalled\tGraylog\tExtended\tLog\tFormat (GELF)\tto\taddress\tthe\tpain\tpoints\tin\tregular\tlog\tformats.\tGraylog\thas\tofficial support\tto\tconsume\tmessages\tfrom\ta\tKafka\ttopic.\tFor\tmore\tinformation\ton\thow to\tconfigure\tGraylog\twith\tKafka,\tlook\tat\ttheir\tdocumentation\tpage\tat http://docs.graylog.org\t.\n\nThe\tother\tway\tof\timplementing\tyour\town\tlog-management\tsystem\tis\tusing\tthe ELK\tstack.\tELK\tstands\tfor\tElasticsearch,\tLog\tStash,\tand\tKibana.\tYou\tcan write\tyour\town\tmicroservice\tto\tbridge\tmessages\tfrom\tthe\tKafka\ttopic\tover\tto Log\tStash.\tThere\tare\tseveral\ttutorials\tout\tthere\tto\tset\tup\tthe\tELK\tstack.\tWe\twill not\tbe\tcovering\tthem\tas\tit\tis\tout\tof\tscope\tfor\tthis\tbook.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\tchapter,\twe\tlearned\thow\tto\tuse Kafka\tin\ta\tmicroservice\tecosystem.\tLater,\twe\tlooked\tat\thow\tApache\tSpark\tcan be\tused\tso\tstream\tmessages\tfrom\tKafka.\tFinally,\twe\thad\ta\tlook\tat\tlog management.\tGood\tluck\tstreaming!",
      "content_length": 1519,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 488,
      "content": "Chapter\t8.\tMore\tClustering Frameworks\t-\tDC/OS,\tDocker Swarm,\tand\tYARN\n\nIn\tthis\tchapter,\twe\twill\tlook\tat\tthe\tfollowing\trecipes:\n\nDeploying\tinfrastructure\twith\tDC/OS Deploying\tcontainers\twith\tDocker\tSwarm Deploying\tcontainers\ton\tYARN",
      "content_length": 231,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 489,
      "content": "Introduction\n\nIn\tthe\tprevious\tchapters\tof\tthis\tbook,\twe\tlearned\thow\tto\tuse\tframeworks\tsuch\tas Mesos\tand\tKubernetes\tto\tperform\tdeployments.\tThere\tare\tmany\tsuch frameworks\tlike\tHashicorp\tNomad,\tLightbend\tLagom,\tMesosphere\tDC/OS, Docker\tSwarm,\tand\tYARN\tthat\tcan\tbe\tutilized\tto\tdeploy\tand\tmanage microservices.\tIn\tthis\tchapter,\tyou\twill\tbe\tintroduced\tto\tthree\tof\tthese frameworks.\tThe\tgoal\tof\tthis\tchapter\tis\tto\tgive\tyou\ta\theads-up\tof\tthese frameworks\tand\ttheir\tcapabilities.\tI\twill\talso\thelp\tyou\tby\tlisting\tdown\tsome tools\tthat\twill\tbe\thandy\twhen\tdeploying\tyour\tmicroservices\ton\tthese frameworks.\tOf\tcourse,\tthere\tare\tother\tsimilar\tframeworks\tin\tthe\tmarket\tthat help\twith\tmanaging\tmicroservices.\tPlease\tfeel\tfree\tto\tchoose\ta\tframework\tthat fits\tyour\tneeds\tand\tgo\tfrom\tthere.",
      "content_length": 771,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 490,
      "content": "Deploying\tinfrastructure\twith\tDC/OS\n\nDC/OS\tstands\tfor\tDatacenter\tOperating\tSystem.\tDC/OS\tis\tbuilt\tand maintained\tby\tMesosphere.\tMesosphere\toffers\tan\topen\tsource\tversion\tof DC/OS,\tas\twell\tas\tan\tenterprise\tversion.\tYou\tcan\tthink\tof\tDC/OS\tas\tan enterprise-ready\tversion\tof\tMesos\twith\tsophisticated\tfeatures\tand\ta\tcollection\tof installable\ttools\tand\tframeworks.\tOne\tof\tthe\ttrickiest\tparts\tof\tmanaging\tyour own\tMesos\tcluster\tis\torchestrating\tthe\tframeworks.\tDC/OS\thas\tmade\tthis\ttask much\teasier\twith\tits\tcommand-line\tinterface.\tYou\tcould\tpotentially\tinstall\tthe DC/OS\tCLI\ton\tyour\tlocal\tcomputer\tand\tmanage\tany\tremote\tDC/OS\tcluster. Using\tthe\tCLI,\tyou\tcan\tinstall\tMarathon,\tsubmit\tDocker\tcontainers,\tand\tso\ton. In\tthis\trecipe,\twe\twill\tbe\tgoing\tover\tthe\tDC/OS\tinterface\tto\tunderstand\tits features\tand\tcapabilities.",
      "content_length": 807,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 491,
      "content": "Getting\tready\n\nIn\tthis\trecipe,\twe\twill\tbe\torchestrating\ta\tDC/OS\tcluster\ton\tAWS\tand\tthen\twe will\tgo\tover\tthe\tbasics\tof\tDC/OS.\tThere\tare\tseveral\tways\tyou\tcan\torchestrate\ta DC/OS\tcluster:\tusing\tVagrant,\tusing\tAWS,\tand\tso\ton.\tUsing\tVagrant,\tyou\tcan spin\toff\ta\tminimal\tcluster\tthat\tyou\tcan\tuse\tfor\tlocal\tdevelopment\ttesting.\tIn\tthis recipe,\twe\thave\torchestrated\ta\treal\tDC/OS\tcluster\ton\tAWS.\tThe\tinstructions\ton the\tDC/OS\twebsite\tfor\torchestrating\tDC/OS\ton\tAWS\tis\tvery\teasy\tbecause\tit uses\tAWS\tCloudFormation.\tAWS\tCloudFormation\tis\tnothing\tbut\tInfrastructure as\tCode.\tYou\twill\tbe\tdescribing\tyour\tinfrastructure\tusing\tCloudFormation templates,\twhich\tcan\tlater\tbe\tused\tfor\torchestration\ton\tAWS.\tYou\tcan\tlearn more\tabout\tCloudFormation\tat http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/GettingStarted.html .\tFortunately,\tMesosphere\twas\tkind\tenough\tto\tcreate\tthese\tCloudFormation scripts\tfor\tus.\tSo\tspinning\toff\ta\tDC/OS\tcluster\tusing\tCloudFormation\tjust\ttakes a\tbutton\tclick\tand\twill\tbe\tdone\tin\tminutes.\tFor\tmore\tinformation,\ttake\ta\tlook\tat https://dcos.io\t.",
      "content_length": 1063,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 492,
      "content": "How\tto\tdo\tit...\n\nIf\tyou\tfollow\tthe\tinstallation\tinstructions\ton\tthe\tDC/OS\twebsite\tfor\tinstalling DC/OS\ton\tAWS,\tyou\twill\tbe\table\tto\tland\ton\tthe\tDC/OS\tweb\tinterface.\tIn\tthis recipe,\twe\thave\torchestrated\tthe\tsingle\tmaster\tand\tfive\tslave\tcluster.\tIf\tyou would\tlike\tto\tpick\ta\tdifferent\tconfiguration,\tplease\tfeel\tfree\tto\tdo\tso.\tOnce\tthe orchestration\tis\tdone,\tyou\tshould\tsee\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tit\tprovides\thigh-level\tresource\tallocation\tand\tusage\tdetails\tof the\tcluster.\tThe\tcluster\tin\tthe\tscreenshot\tsays\tthat,\tout\tof\t24\tCPUs\tonly\ttwo\tof them\tare\tused.\tThe\ttwo\tof\tthem\tare\tused\tby\tthe\tMarathon\tpackage\tthat\twas installed\ton\tthis\tcluster.\tBy\tdefault,\tthe\tcluster\twill\tnot\thave\tany\tpackages\tor services\trunning.\tYou\tcan\tinstall\tthem\tfrom\tthe\tuniverse\tof\tpackages\tavailable for\tinstallation.\tThey\tcan\talso\tbe\tinstalled\tfrom\tthe\tDC/OS\tcommand-line interface.\tOur\tcluster\thas\t82\tGB\tof\tmemory,\tout\tof\twhich\t2\tGB\tis\tbeing allocated\tto\tMarathon.\tSimilarly,\tour\ttotal\tdisk\tspace\tof\t208\tGB\tremains\tunused. The\tdashboard\tpage\tprovides\tmore\tmetrics,\tsuch\tas\tnode\tcount\tand\ttask\tcount. As\tI've\talready\tmentioned,\tthis\tcluster\thas\tone\tmaster\tand\tfive\tslaves,\tso\tyou should\tsee\tthat\tthere\tare\tsix\tnodes\tin\ttotal.\tIf\tyou\tnavigate\tto\tthe\tNodes\ttab,\tthen you\twill\tsee\tthe\tlist\tof\tall\tnodes\tand\ttheir\tresource\tutilization.\tThere\tare\ttwo views\tthat\tyou\tcan\tutilize\tin\tthe\tNodes\ttab:\tGrid\tand\tList.\tThe\tList\tview\tis\ta traditional\tlist-based\tview.\tHowever,\tthe\tGrid\tview\tis\tinteresting\tbecause\tit displays\tthe\tnodes\tin\tthe\tform\tof\tcircles\twith\tthe\tCPU\tutilization\tpercent\tin them.\tThe\tmost\tamazing\tpart\tabout\tthese\twidgets\tis\tthat\tthey\tget\tupdated\treal- time.\tAlso,\tthe\tcircles\tare\tcolor-coded\tbased\ton\tthe\tservice\tthat\tutilizes\tthe",
      "content_length": 1725,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 493,
      "content": "resources\ton\tthat\tnode:\n\nThe\tpreceding\tfigure\tillustrates\tthe\tgrid\tview\tof\tthe\tnodes.\tYou\tcan\tsee\tthat\tthe last\tnode\tuses\t50\tpercent\tof\tits\tCPU,\twhich\tis\tbeing\tutilized\tby\tMarathon.\tThe List\tview\tlooks\tsomething\tlike\tthis:\n\nAs\tyou\tcan\tsee,\tin\tthe\tList\tview,\tyou\tcan\tsee\tthe\tactual\tIPs\tof\tthe\tslave\tnodes and\ttheir\thealth\tstatus,\ttask\tcount,\tCPU\tutilization,\tmemory\tutilization,\tand\tdisk space\tutilization.\n\nTASKS\tare\tnothing\tbut\tMesos\ttasks.\tDC/OS\tis\tbacked\tby\ta\tMesos\tcluster.\tSo any\ttask\tthat\tis\tbeing\tsubmitted\tto\tthis\tDC/OS\tcluster\tis\tactually\tsubmitted\tto\tthe backing\tMesos\tcluster.\tThe\tservices\tand\tpackages\tthat\tcan\tbe\tinstalled\ton DC/OS\tcan\tbe\tviewed\tfrom\tthe\tUniverse\ttab.\tThe\tUniverse\tis\ta\tpackage manager\tfor\tDC/OS,\twhere\tyou\tcan\tfind\tall\tthe\tpackages\tand\tservices\tthat\tyou can\tinstall\ton\tDC/OS.\tKafka,\tCassandra,\tMarathon,\tand\tArangoDB\tare\ta\tfew\tof",
      "content_length": 860,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 494,
      "content": "the\tpackages\tthat\tyou\tcan\tinstall\ton\tDC/OS:\n\nAll\tit\ttakes\tto\tinstall\ta\tpackage\tis\tto\thit\tthe\tInstall\tPackage\tbutton,\tor\tif\tyou would\tlike\tto\tuse\tthe\tDC/OS\tCLI,\tthen\tit\tjust\ttakes\tone\tcommand\tto\tinstall packages.\tThe\tnewer\tversion\tof\tDC/OS\thas\tthe\tability\tto\tspin\toff\ttasks\tfrom\tthe UI.\tPreviously,\tin\torder\tto\tspin\toff\ttasks,\tyou\thad\tto\tuse\ta\tCLI\tcommand.\tThe true\tpower\tof\tDC/OS\tis\tthe\tability\tto\tview\ta\tcluster\tof\tsix\tnodes\tas\tone\tsingle machine\tand\tbeing\table\tto\tutilize\tresources\tin\ta\tvery\tgranular\tmanner.\n\nNow\tlet's\tcome\tto\tthe\treal\tusage\tof\tDC/OS\tin\tour\tcontext:\tmicroservices.\tWe know\tthat\tmicroservices\tby\tthemselves\tcannot\twork\talone;\tthey\tneed\tto\twork together\twith\tother\ttools\tsuch\tas\tSpark,\tKafka,\tConsul,\tand\tZookeeper.\tOne good\treason\tfor\tusing\tDC/OS\tis\tbeing\table\tto\tmanage\tthem\tall\tunder\tone\troof: Marathon,\tload\tbalancer,\tdatabases,\tmiddleware,\tand\tso\ton.\tThere\tare\tseveral packages\tin\tthe\tDC/OS\tUniverse\tthat\tcan\thelp\tus,\tincluding\tdatabases, middleware,\tand\teven\tmicroservice-management\ttools\tsuch\tas\tVAMP.\tIf\tyou would\tlike\tto\tgo\twith\tDC/OS,\ttake\tsome\ttime\tto\tgo\tover\tthe\tlist\tof\tpackages\tand services\tthat\tare\tavailable\tin\tthe\tUniverse.\tThat\tway,\tyou\twill\tknow\twhether your\tarchitecture\tcan\tbe\tmanaged\twith\tDC/OS\tor\tnot.\tOne\tscenario\twhere\tyou might\tnot\tbe\table\tto\tget\tthe\tmost\tout\tof\tDC/OS\tis\twhen\tyou\tare\ton\tthe\tHadoop Ecosystem.\tAt\tthe\ttime\tof\twriting\tthis,\tDC/OS\thas\tminimal\tsupport\tfor\tusing Hadoop.\tDC/OS\thas\ta\tframework\tfor\tHDFS.\tBut\tif\tyou\tare\talready\ton\tthe Hadoop\tPlatform\tand\tuse\tlot\tof\tits\tcomponents,\tyou\tmight\tnot\tbe\table\tto\tmigrate them\tall\tover\tto\tDC/OS.",
      "content_length": 1592,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 495,
      "content": "them\tall\tover\tto\tDC/OS.\n\nBy\tnow,\tyou\twill\teither\tbe\tvery\texcited\tto\tlearn\tmore\tabout\tDC/OS\tor\tyou\twill have\tmore\tquestions\tabout\tDC/OS.\tEither\tways,\tit\tis\tstrongly\trecommended\tthat you\tgo\tover\tDC/OS\tand\tits\tdocumentation\tbefore\tusing\tit\tin\tproduction.\tWith that\tsaid,\twe\tcome\tto\tthe\tend\tof\tthis\trecipe.\tSo\tfar\tin\tthis\trecipe,\twe've\tseen\tthat DC/OS\tis\ta\tsophisticated\tcluster-management\tplatform\tthat\tnot\tonly\thelps\tus with\tmicroservice\tdeployments\tbut\talso\tmanages\tour\twhole\tinfrastructure.\tIn\tthe next\trecipe,\tyou\twill\tlearn\tmore\tabout\tDocker's\tclustering\tframework,\tcalled Docker\tSwarm.",
      "content_length": 588,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 496,
      "content": "Deploying\tcontainers\twith\tDocker Swarm\n\nDocker\tSwarm\tis\tDocker's\tsolution\tto\tclustering\tmultiple\tDocker\tengines\tinto one\tcluster.\tIf\tyour\torganization\tis\theavily\treliant\ton\tDocker\tand\tDocker containers,\tit\tmight\tbe\tworth\tlooking\tat\tDocker\tSwarm.\tWhen\tyou\thave\tseveral Docker\tinstallations\tthat\tyou\tmaintain\ton\tseparate\tDocker\thosts,\tthen\tthese Docker\thosts\twill\tbe\tgrouped\ttogether\tas\ta\tcluster\tusing\tDocker\tSwarm.\tDocker Swarm\tbrings\tin\ta\twhole\tlot\tof\tfeatures\tthat\twill\thelp\tmanage\tyour\tapps\ton\ta Swarm\tcluster.\tAnother\tgreat\tadvantage\tof\tusing\tDocker\tSwarm\tis\tthat\tsince\tit uses\tthe\tDocker\tAPI,\tworking\twith\ta\tSwarm\tcluster\tis\tno\tdifferent\tthan\tworking with\ta\tDocker\tdaemon.\tSo\ttools\tsuch\tas\tShipyard\tstill\tcontinue\tto\twork\twith Docker\tSwarm.\tWe\twill\tlook\tat\tShipyard\tlater\tin\tthis\trecipe.",
      "content_length": 792,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 497,
      "content": "Getting\tready\n\nAt\tthis\tmoment,\tthe\teasiest\tway\tto\torchestrate\ta\tDocker\tSwarm\tcluster\tlocally\tis by\tusing\tdocker-machine\tinstances.\tBefore\tyou\tstart\tthe\tDocker\tSwarm\tcluster, let's\tfamiliarize\tourselves\twith\tsome\tconcepts\tof\tDocker\tSwarm.\n\nDocker\tSwarm\tcomprises\ttwo\ttypes\tof\tnodes:\tmanager\tand\tagent.\tA\tmanager\tis responsible\tfor\tscheduling\tcontainers\tand\tmanaging\tthe\tcluster.\tAn\tagent\tis\tthe node\twhere\tthe\tcontainers\tare\trun.\tThere\tcan\tbe\tseveral\tmanagers\tand\tagents, depending\ton\tthe\ttype\tof\tarchitecture\tyou\trequire.\tIn\tour\trecipe,\twe\twill\tcreate\ta Docker\tSwarm\tcluster\twith\tone\tmanager\tand\tone\tagent.\tSo\tstart\ttwo\tterminal sessions:\tone\tfor\tthe\tmanager\tand\tthe\tother\tfor\tthe\tagent.",
      "content_length": 687,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 498,
      "content": "How\tto\tdo\tit... 1.\t The\tfirst\tstep\ttoward\tcreating\tthe\tSwarm\tcluster\tis\tcreating\tdocker-\n\nmachine\tinstances\tfor\tthe\tnodes\tthemselves.\tLet's\tcreate\tour\tmanager\tfirst. In\tthe\tterminal\tsession\tdedicated\tfor\tthe\tmanager,\tissue\tthe\tfollowing command:\tdocker-machine\tcreate\t--driver\tvirtualbox\tmanager\t&&\teval $(docker-machine\tenv\tmanager)\n\nThis\tcommand\tstarts\tthe\tnew\tVM\tand\tsets\tthe\tenvironment\tvariables.\tAlso stop\tany\tdocker-machine\tinstances\tthat\tare\tnot\tbeing\tused,\tin\torder\tto\tfree up\tsome\tresources.\n\n2.\t Once\tyour\tterminal\tsession\tis\tready,\tgo\tahead\tand\tSSH\tinto\tthe\tVM\tusing the\tfollowing\tcommand:\tdocker-machine\tssh\tmanager\n\nYou\tshould\tnow\tbe\tlogged\tin\tto\tthe\tVM\tas\tthe\tdocker\tuser.\tHereafter,\twe will\tbe\tusing\tsome\tdocker\tswarm\tcommands.\n\n3.\t First,\twe\tneed\tto\tinitiate\ta\tnew\tcluster.\tFor\tthat\twe\twill\tneed\tthe\tIP\tof\tthis Docker\tmachine\tinstance.\tUse\tthe\tdocker-machine\tip\tmanager\tcommand to\tfind\tthe\tIP\tof\tthis\tinstance.\tIn\tmy\tcase\tthe\tIP\twas\t192.168.99.100.\tNow go\tahead\tand\tissue\tthe\tfollowing\tcommand\ton\tthe\tsame\tterminal: docker@manager:~$\tdocker\tswarm\tinit\t--advertise-addr 192.168.99.100\tSwarm\tinitialized:\tcurrent\tnode (93h99zo91q7o8cvc0s3pvlwvu)\tis\tnow\ta\tmanager\tTo\tadd\ta\tworker\tto this\tswarm,\trun\tthe\tfollowing\tcommand:\tdocker\tswarm\tjoin\t\\\t--token SWMTKN-1- 1xd50ogywv31v4dmcg70tu15xqt7opsqds3qhe0zu8dp856krl- arslqq0p4qhd85uj2qze4ei5q\t\\\t192.168.99.100:2377\tTo\tadd\ta\tmanager to\tthis\tswarm,\trun\tdocker\tswarm\tjoin-token\tmanager\tand\tfollow\tthe instructions.\n\n4.\t We\thave\tsuccessfully\tset\tup\tour\tmanager\tand\tinitiated\ta\tnew\tSwarm cluster.\tThe\tresult\tof\tthe\tprevious\tcommand\tactually\tgave\tus\tthe\tcommand that\twe\tneed\tto\texecute\tfrom\tthe\tagent\tnode\tto\tjoin\tthis\tcluster.\tBefore\twe move\ton,\tlet's\tquickly\tverify\twhether\tour\tmanager\twas\tcreated\tcorrectly\tby listing\tall\tthe\tnodes\tparticipating\tin\tthis\tcluster:\tdocker@manager:~$ docker\tnode\tls\tID\tHOSTNAME\tSTATUS\tAVAILABILITY MANAGER\tSTATUS\t93h99zo91q7o8cvc0s3pvlwvu\t*\tmanager\tReady Active\tLeader",
      "content_length": 1954,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 499,
      "content": "5.\t There\tis\tjust\tone\tnode\tin\tour\tcluster\tthat\tacts\tas\tthe\tLeader.\tThe\tnext\tstep\tis to\tadd\ta\tnew\tagent\tnode\tto\tthis\tcluster.\tNow\tmove\ton\tto\tthe\tnext\tterminal window\tthat\twas\tdedicated\tfor\tour\tagent.\tWe\tare\tgoing\tto\tcall\tthis\tnode worker.\tGo\tahead\tand\tcreate\tthis\tnew\tVM\tfirst:\tdocker-machine\tcreate\t-- driver\tvirtualbox\tworker\t&&\teval\t$(docker-machine\tenv\tworker) This\tcommand\tstarts\tthe\tnew\tVM\tand\tsets\tthe\tenvironment\tvariables. 6.\t Once\tyour\tterminal\tsession\tis\tready,\tgo\tahead\tand\tSSH\tinto\tthe\tVM\tusing\n\nthe\tfollowing\tcommand:\tdocker-machine\tssh\tworker\n\n7.\t Let's\tissue\tthe\tdocker\tswarm\tjoin\tcommand\tthat\twe\treceived\tas\toutput when\twe\tinitiated\tthe\tcluster\ton\tthe\tmanager:\tdocker@worker:~$\tdocker swarm\tjoin\t\\\t>\t--token\tSWMTKN-1- 1xd50ogywv31v4dmcg70tu15xqt7opsqds3qhe0zu8dp856krl- arslqq0p4qhd85uj2qze4ei5q\t\\\t>\t192.168.99.100:2377\tThis\tnode\tjoined\ta swarm\tas\ta\tworker.\n\n8.\t We\thave\tsuccessfully\tset\tup\tour\tagent.\tNow\tgo\tback\tto\tthe\tmanager terminal\tsession\tand\texecute\tdocker\tnode\tls\tto\tverify\twhether\tthere\tare two\tnodes\tin\tthe\tcluster\tnow.\tYou\tshould\treceive\tsomething\tlike\tthis:\tID HOSTNAME\tSTATUS\tAVAILABILITY\tMANAGER\tSTATUS 3i78zp35bxmioy3dvdfmui3gv\tworker\tReady\tActive 93h99zo91q7o8cvc0s3pvlwvu\t*\tmanager\tReady\tActive\tLeader\n\nThat's\tit!\tYou\thave\tsuccessfully\torchestrated\ta\tminimal\tdocker\tswarm cluster.\n\n9.\t Our\tnext\tstep\twould\tbe\tspinning\toff\tour\tgeolocation\tservice\ton\tthis\tcluster. Without\tany\tfurther\tdelay,\texecute\tthe\tfollowing\tcommand\tto\tstart\tthe geolocation\tservice\ton\tthe\tcluster:\tdocker\tservice\tcreate\t--replicas\t2\t-- name\tgeolocation\tvikrammurugesan/geolocation\n\nThis\tcommand\tsays\tthat\twe\twould\tlike\tto\tstart\ttwo\tcontainers\tfor\tthe\timage vikrammurugesan/geolocation\twith\tthe\tservice\tname\tgeolocation. 10.\t To\tlist\tdown\tall\tthe\tservices\trunning\tin\tthe\tcluster,\texecute\tthe\tfollowing\n\ndocker\tservice\tcommand:\tdocker\tservice\tps\tgeolocation\tID\tNAME IMAGE\tNODE\tDESIRED\tSTATE\tCURRENT\tSTATE\tERROR 46zzwpszqfqvmmmqz0tx8rgo3\tgeolocation.1 vikrammurugesan/geolocation\tmanager\tRunning\tPreparing\tabout\ta minute\tago\t9ppgezl20vme1p6fi4ko7mui1\tgeolocation.2 vikrammurugesan/geolocation\tworker\tRunning\tPreparing\tabout\ta",
      "content_length": 2127,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 500,
      "content": "minute\tago\n\n11.\t If\tyou\twould\tlike\tto\tknow\tmore\tabout\tyour\tservice,\tyou\tcould\tuse\tthe inspect\tcommand\tto\tdo\tso:\tdocker\tservice\tinspect\t--pretty\tgeolocation ID:\t68jy7i3vwe88c2a797jri6anv\tName:\tgeolocation\tMode:\tReplicated Replicas:\t2\tPlacement:\tUpdateConfig:\tParallelism:\t1\tOn\tfailure:pause ContainerSpec:\tImage:\tvikrammurugesan/geolocation\tResources:\n\nThis\tconsole\toutput\thas\tbeen\ttruncated\tas\tit\tis\tlengthy.\tIf\tyou\twould\tlike\tto view\tthe\toutput\tin\tJSON\tformat,\tjust\tomit\tthe\t--pretty\targument\tfrom\tthe inspect\tcommand.\n\n12.\t Now\twait\tfor\tthe\tcontainers\tto\tstart\tup.\tBefore\tthe\tcontainers\ttry\tto\tstart\tup, Docker\twill\tpull\tthe\timage\tfrom\tDocker\tHub\tfirst.\tSo\tfor\tthe\tfirst\ttime,\tit might\ttake\ta\tfew\tminutes\tdepending\ton\tthe\tsize\tof\tyour\timage.\tGreat!\tNow the\tnext\tthing\tthat\tyou\tmight\twant\tto\tdo\tis\tscale\tyour\tmicroservice. Fortunately,\tDocker\tSwarm\tcomes\twith\ta\tcommand\tto\tscale\tour\tservices. Let's\ttry\tto\tscale\tdown\tour\tgeolocation\tservice\tto\ta\tfactor\tof\t1. docker\tservice\tscale\tgeolocation=1 geolocation\tscaled\tto\t1\n\n13.\t Easy,\tisn't\tit?\tNow\tlet's\tsay\tyou\twould\tlike\tto\tdelete\tthis\tservice;\tyou\twould use\tthe\tdocker\tservice\trm\tcommand:\tdocker\tservice\trm\tgeolocation\n\nThese\tare\tsome\tof\tthe\tbasic\toperations\tyou\twould\twant\tto\tdo\twith\tyour\tSwarm cluster.\tOf\tcourse,\tthere\tare\ttons\tof\tother\tthings\tyou\tcould\tdo\twith\tDocker Swarm.\tBut\tthat\tis\ta\tlittle\tout\tof\tscope\tfor\tour\tbook,\tso\twe\twon't\tgo\tany\tdeeper. However,\tone\tof\tthe\tmost\tcommon\tthings\tthat\tyou\twould\twant\tto\tdo\tis\tbeing able\tto\tmanage\ta\tSwarm\tcluster\twith\tease.\tCommand-line\tmanagement\twill\tget a\tlittle\ttrickier\tif\tyour\tcluster\tis\thuge.\tThat's\twhere\ttools\tsuch\tas\tShipyard, Rancher,\tand\tcAdvisor\tcome\tinto\tpicture.\tShipyard\tis\ta\ttool\tused\tfor\tmanaging Docker\tcontainers\tand\timages.\tIt\talso\thas\tthe\tability\tto\twork\twith\tprivate registries.\tSimilarly,\tRancher\tis\ta\tsophisticated\ttool\tfor\tmanaging\tcontainers. cAdvisor\tis\ta\tlittle\tdifferent\tas\tit\tis\ta\tmonitoring\ttool\tfor\tcontainers.\tYou\tmight also\twant\tto\tlook\tat\tDocker's\tremote\tAPI,\tif\tyou\twould\tlike\tto\tautomate deployments\tto\tDocker\tSwarm:\thttps://docs.docker.com/engine/api/.\n\nThat\tbrings\tus\tto\tthe\tend\tof\tthis\trecipe.\tIn\tthis\trecipe,\twe\tlearned\thow\tDocker Swarm\tcould\tbe\tused\tto\tdeploy\tour\tmicroservices.\tOf\tcourse,\tthis\tis\tjust\tan introduction.\tIf\tyou\tare\tinterested\tin\tinvesting\tmore\ttime\tin\tDocker\tSwarm,\tread",
      "content_length": 2325,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 501,
      "content": "introduction.\tIf\tyou\tare\tinterested\tin\tinvesting\tmore\ttime\tin\tDocker\tSwarm,\tread their\tdocumentation;\tit\tusually\thas\teverything\tyou\twould\tneed.",
      "content_length": 143,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 502,
      "content": "Deploying\tcontainers\ton\tYARN\n\nIn\tthis\trecipe,\tyou\twill\tlearn\thow\tYARN\tcan\tbe\tused\tas\ta\tcluster\tto\tdeploy applications.\tThe\tframework\tused\tto\tdeploy\tapplications\tto\tYARN\tis\tcalled Apache\tSlider.\tAt\tthe\ttime\tof\twriting\tthis,\tApache\tSlider\tis\tstill\tin\tApache's Incubator\tstatus.\tIn\torder\tto\tlearn\tApache\tSlider,\tyou\twill\tneed\ta\tYARN\tcluster. For\tthose\tof\tyou\twho\tare\tnot\tfamiliar\twith\tYARN,\tit\tstands\tfor\tYet\tAnother Resource\tNavigator,\tand\tit\tis\tthe\tcluster\ton\twhich\tmost\tof\tyour\tHadoop ecosystem\toperates.\tThe\tgoal\tof\tthe\tSlider\tproject\tis\tto\tprovide\tthe\tability\tto\trun applications\ton\tthe\tYARN\tcluster,\tscale\tthem,\tand\tmonitor\tthem.\tIn\tthis\trecipe,\tI will\tonly\tbe\table\tgive\tyou\tan\toverview\tof\tSlider\tas\tit\tis\tstill\tnascent.",
      "content_length": 723,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 503,
      "content": "Getting\tready\n\nThe\tfirst\tthing\tthat\tyou\tneed\tis\ta\tYARN\tcluster.\tThere\tare\tseveral\tways\tto orchestrate\ta\tYARN\tcluster.\tYou\tcould\torchestrate\tyour\town\tvanilla\tHadoop cluster,\tor\tyou\tcould\tuse\tplatforms\tsuch\tas\tHortonworks\tor\tCloudera\tto\tmake\tit much\tmore\teasier.\tUsing\tplatforms\tsuch\tas\tHortonworks\tor\tCloudera\tcomes with\tits\town\tadvantages.\tRead\tthrough\ttheir\tdocumentation\tand\tpick\twhat\tis right\tfor\tyou.",
      "content_length": 404,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 504,
      "content": "How\tit\tworks...\n\nThere\tare\tthree\tmain\tcomponents\tin\ta\tYARN\tcluster:\tResource\tManager,\tNode Manager\tand\tApplication\tMaster.\tThe\tResource\tManager\tis\tthe\tcore component\tof\tthe\tcluster\tand\tis\tresponsible\tfor\tany\tresource\tallocation\tto applications.\tThe\tResource\tManager\tperforms\tthis\twith\tthe\thelp\tof\ta Scheduler\tthat\tallocates\tresources\tto\tapplications\tbased\ton\tthe\toffer\tand priority.\tResources\tare\tnothing\tbut\tCPU,\tmemory\tand\tdisk\tspace.\tThe\tNode Manager\tis\tavailable\ton\teach\tnode\tof\tthe\tcluster\tand\tis\tresponsible\tfor\tspinning of\ttasks,\tmonitoring\tresource\tusage\tand\tso\ton.\tLastly,\tthe\tApplication\tMaster\tis a\tframework\tspecific\tcomponent\tthat\tis\tresponsible\tfor\trunning\tthe\ttasks\ton\tthe nodes.\tThe\tfollowing\tdiagram\tshows\tthe\tcomponents\tof\ta\tYARN\tcluster:\n\nSlider\tis\ta\tcommand-line\ttool.\tAt\tthe\tcore\tof\tSlider\tlies\tthe\tYARN\tApplication Master\t(AM),\tthe\tSlider\tAM,\tand\ta\tclient\tthat\tcommunicates\tbetween\tYARN and\tSlider\tAM\tusing\tAPIs.\tThe\tclient\tis\tthe\tcommand\tline\tinterface\tthat\tcan\tbe used\tto\ttalk\tto\tSlider.\tTo\tlearn\tmore\tabout\tthe\tworking\tof\tSlider\tAM,\tplease\ttake a\tlook\tat\thttps://slider.incubator.apache.org/design/architecture.html#am- architecture\t.\tThe\tSlider\tdeployment\trequests\tindicate\tthe\tresources\trequired\tfor the\tapplication\tas\twell\tas\tthe\tdetails\tof\tthe\tapplication.\tThe\tdeployment\trequests",
      "content_length": 1309,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 505,
      "content": "are\tusually\tin\tthe\tform\tof\tJSON\tthat\tlooks\tvery\tsimilar\tto\tMarathon's\tJSON request.\tThere\tare\ttwo\tJSON\tdocuments\tthat\tyou\tneed\tto\tprovide\tin\torder\tto deploy\tapplications\tusing\tSlider:\tresources.json\tand\tappConfig.json.\n\nThe\tresources.json\tfile\tis\tused\tto\ttell\tSlider\thow\tmuch\tresources\t(memory\tand CPU)\tshould\tbe\tallocated\tfor\tthat\tparticular\tapplication.\tSome\tresource\tconfig options\tare\tyarn.memory,\tyarn.vcores,\tyarn.container.failure.threshold, yarn.component.instances,\tand\tyarn.role.priority.\n\nWhile\tmost\tof\tthese\tproperties\tare\tself-explanatory,\tyarn.role.priority\tmight deserve\tan\texplanation.\tIt\tis\tmainly\tused\twhen\tyou\thave\tmultiple\tcomponents. Components\twith\tthe\thighest\tpriority\t(1)\twill\tbe\torchestrated\tfirst.\n\nThe\tyarn.container.failure.threshold\toption\tindicates\tthe\tnumber\tof\ttimes a\tcomponent\tmay\tfail\twithin\tthe\tgiven\ttime\twindow.\tThe\tfailure\ttime\twindow\tis usually\tindicated\tusing\tthree properties:yarn.container.failure.window.days, yarn.container.failure.window.hours,\tand yarn.container.failure.minutes.\n\nThe\tnext\tJSON\tfile\tthat\tyou\twill\tneed\tis\tappConfig.json.\tWhile resources.json\twas\tmore\tof\ta\tconfig\tfile\tto\tSlider\t(or\tYARN), appConfig.json\tis\tmostly\tfor\tthe\tapplication.\tTwo\tof\tthe\tmost\timportant properties\tare\tapplication.def\tand\tjava_home.\tIn\taddition\tto\tthis,\tyou\tcould add\tyour\town\tproperties\tas\twell,\tsuch\tas\tJVM\tsize.\tThe\tapplication.def property\tindicates\tthe\tlocation\tof\tthe\tapplication\tpackage\titself\ton\tHDFS. Usually,\tthe\tapplication\tis\tpackaged\tas\ta\tZIP\tfile.\n\nSlider\tis\tcurrently\tCLI\tdriven.\tThough\tSlider\tneeds\tmore\tfeatures\tto\tbecome more\tsophisticated\tlike\tother\tschedulers,\tit\tis\tcurrently\tthe\tonly\tavailable solution\tfor\tYARN.\tIf\tyou\tare\tusing\tYARN\talready,\tit\tis\tworth\tchecking\tout.\n\nTo\tlearn\tmore\tabout\tSlider,\tvisit\ttheir\tGetting\tStarted\tpage: http://slider.incubator.apache.org/docs/getting_started.html\t.\tAt\tthe\ttime\tof writing\tthis,\tthe\tlink\tstill\tlives\tin\tApache's\tincubator\tdomain.\tIf\tthis\tlink\tis broken,\tfeel\tfree\tto\tvisit\tSlider's\twebsite\tand\tnavigate\tto\ttheir\tGetting\tStarted page.",
      "content_length": 2039,
      "extraction_method": "Unstructured"
    },
    {
      "page_number": 506,
      "content": "With\tthat\tsaid,\twe\tcome\tto\tthe\tend\tof\tthe\trecipe,\tthe\tchapter,\tand\tthe\tbook.\tIn this\tbook,\tI\thave\tintroduced\tyou\tto\ta\tlot\tof\ttechnologies,\ttools,\tand\tframeworks. While\tit\ttakes\tmore\tthan\ta\tbook\tto\tmake\tyou\tan\texpert\ton\teach\tof\tthem,\tmy\tgoal was\tto\tgive\tyou\ta\thead\tstart\tand\tshow\tyou\thow\tto\tproceed\tand\tsolve\tthe\tmost common\tchallenges.\tThroughout\tthe\tbook,\twe\thave\tlearned\trecipes\tto\taddress most\tof\tthe\tchallenges\tthat\tyou\twill\tface\twhen\tyou\tmove\ttoward\ta\tmicroservice- based\tarchitecture,\tincluding\tdevelopment,\tcontainerization,\tdeployments, service\tdiscovery,\tload\tbalancing,\tmonitoring,\tlogging,\tand\tstreaming.\tOf course,\tthere\twill\tbe\tmore\tchallenges\tas\tyou\tstart\tscaling\tout\tto\thundreds\tand hundreds\tof\tmicroservices\tin\tyour\torganization.\tBut\tthere\tare\talways\ttools\tand frameworks\tout\tthere\tto\tsolve\tthem.\tI\thope\tthis\tbook\twill\thelp\tyou\tout\ton\tyour microservice\tjourney.\tHappy\tmicroservicing!",
      "content_length": 899,
      "extraction_method": "Unstructured"
    }
  ]
}